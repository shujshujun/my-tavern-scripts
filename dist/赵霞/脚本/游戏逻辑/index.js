const n=z,e=n.z.object({世界:n.z.object({当前天数:n.z.number().min(1).max(99).default(1),当前小时:n.z.number().min(0).max(23).default(8),时间:n.z.string().default('Day 1, 08:00'),时间戳:n.z.number().default(0),状态栏需要刷新:n.z.boolean().default(!0),循环状态:n.z.enum(['进行中','结局判定','已破解']).default('进行中'),当前循环轮数:n.z.number().default(1),已进入过梦境:n.z.boolean().default(!1),游戏阶段:n.z.enum(['序章','日常','梦境','结局']).default('序章'),_梦境入口消息ID:n.z.number().optional(),_梦境入口天数:n.z.number().optional(),梦境选择已锁定:n.z.boolean().default(!1),待生成摘要:n.z.object({sceneNum:n.z.number().min(1).max(5),dreamEntryId:n.z.number(),dreamExitId:n.z.number().optional()}).optional(),上一轮梦境已退出:n.z.object({sceneNum:n.z.number().min(1).max(5),dreamEntryId:n.z.number(),dreamExitId:n.z.number().optional()}).optional(),_梦境退出记录:n.z.object({楼层ID:n.z.number().default(-1),场景编号:n.z.number().min(1).max(5).optional(),swipe_id:n.z.number().default(-1)}).optional(),_梦境入口记录:n.z.object({楼层ID:n.z.number().default(-1),场景编号:n.z.number().min(1).max(5).optional(),类型:n.z.enum(['普通梦境','场景5']).optional()}).optional(),_摘要生成记录:n.z.object({楼层ID:n.z.number().default(-1),swipe_id:n.z.number().default(0),场景编号:n.z.number().min(1).max(5).optional(),入口楼层ID:n.z.number().optional(),退出楼层ID:n.z.number().optional()}).optional()}).default({当前天数:1,当前小时:8,时间:'Day 1, 08:00',时间戳:0,状态栏需要刷新:!0,循环状态:'进行中',当前循环轮数:1,已进入过梦境:!1,游戏阶段:'序章',梦境选择已锁定:!1}),赵霞状态:n.z.object({依存度:n.z.number().min(0).max(100).default(0),道德底线:n.z.number().min(0).max(100).default(80),对丈夫依存度:n.z.number().min(-50).max(100).default(60),纯爱好感度:n.z.number().min(0).max(100).default(5),纯爱亲密度:n.z.number().min(0).max(100).default(0),当前境界:n.z.number().min(1).max(5).default(1),部位进度:n.z.object({嘴巴:n.z.number().min(0).max(100).default(0),胸部:n.z.number().min(0).max(100).default(0),下体:n.z.number().min(0).max(100).default(0),后穴:n.z.number().min(0).max(100).default(0),精神:n.z.number().min(0).max(100).default(0)}).default({嘴巴:0,胸部:0,下体:0,后穴:0,精神:0}),当前位置:n.z.string().default('客厅'),服装:n.z.object({上衣:n.z.string().default('米色真丝连衣裙上衣部分'),下装:n.z.string().default('米色真丝连衣裙裙摆'),内衣:n.z.string().default('白色蕾丝内衣'),内裤:n.z.string().default('白色蕾丝内裤'),袜子:n.z.string().default('肉色丝袜'),鞋子:n.z.string().default('米色平底鞋')}).default({上衣:'米色真丝连衣裙上衣部分',下装:'米色真丝连衣裙裙摆',内衣:'白色蕾丝内衣',内裤:'白色蕾丝内裤',袜子:'肉色丝袜',鞋子:'米色平底鞋'}),妆容:n.z.string().default('淡妆'),配件:n.z.string().default('婚戒'),改造:n.z.array(n.z.string()).default([]),心理活动:n.z.string().default('今天天气不错，该准备午餐了...')}).default({依存度:0,道德底线:80,对丈夫依存度:60,纯爱好感度:5,纯爱亲密度:0,当前境界:1,部位进度:{嘴巴:0,胸部:0,下体:0,后穴:0,精神:0},当前位置:'客厅',服装:{上衣:'米色真丝连衣裙上衣部分',下装:'米色真丝连衣裙裙摆',内衣:'白色蕾丝内衣',内裤:'白色蕾丝内裤',袜子:'肉色丝袜',鞋子:'米色平底鞋'},妆容:'淡妆',配件:'婚戒',改造:[],心理活动:'今天天气不错，该准备午餐了...'}),梦境数据:n.z.object({当前记忆年龄:n.z.number().min(16).max(40).optional(),梦境心理活动:n.z.string().optional(),此次梦境目标:n.z.string().optional(),记忆背景故事:n.z.string().optional(),已完成场景:n.z.array(n.z.number()).default([]),正确重构场景:n.z.array(n.z.number()).default([]),场景1:n.z.object({已进入:n.z.boolean().default(!1),选择部位:n.z.array(n.z.string()).default([]),是否正确:n.z.boolean().optional(),进入时间:n.z.string().optional(),对话轮数:n.z.number().default(0),剧情摘要:n.z.string().optional()}).optional(),场景2:n.z.object({已进入:n.z.boolean().default(!1),选择部位:n.z.array(n.z.string()).default([]),是否正确:n.z.boolean().optional(),进入时间:n.z.string().optional(),对话轮数:n.z.number().default(0),剧情摘要:n.z.string().optional()}).optional(),场景3:n.z.object({已进入:n.z.boolean().default(!1),选择部位:n.z.array(n.z.string()).default([]),是否正确:n.z.boolean().optional(),进入时间:n.z.string().optional(),对话轮数:n.z.number().default(0),剧情摘要:n.z.string().optional()}).optional(),场景4:n.z.object({已进入:n.z.boolean().default(!1),选择部位:n.z.array(n.z.string()).default([]),是否正确:n.z.boolean().optional(),进入时间:n.z.string().optional(),对话轮数:n.z.number().default(0),剧情摘要:n.z.string().optional()}).optional(),场景5:n.z.object({已进入:n.z.boolean().default(!1),选择部位:n.z.array(n.z.string()).default([]),是否正确:n.z.boolean().optional(),进入时间:n.z.string().optional(),对话轮数:n.z.number().default(0),需要安眠药:n.z.boolean().default(!0),进入次数:n.z.number().default(0),当前步骤:n.z.number().min(0).max(12).default(0),已完成步骤:n.z.boolean().default(!1),上次剧情摘要:n.z.string().optional(),完成度:n.z.number().min(0).max(100).default(0),步骤进度记录:n.z.array(n.z.number()).default([]),上次推进记录:n.z.object({楼层ID:n.z.number().default(-1),swipe_id:n.z.number().default(-1)}).optional(),进入前混乱度:n.z.number().min(0).max(100).optional(),进入前混乱标记:n.z.object({已标记:n.z.boolean().default(!1),标记时间:n.z.number().nullable().default(null),触发时间:n.z.number().nullable().default(null),已触发:n.z.boolean().default(!1),触发原因:n.z.enum(['性行为','打断仪式']).nullable().default(null),性行为次数:n.z.number().default(0)}).optional()}).optional(),记忆混乱度:n.z.number().min(0).max(100).default(0),混乱结局:n.z.object({已标记:n.z.boolean().default(!1),标记时间:n.z.number().nullable().default(null),触发时间:n.z.number().nullable().default(null),已触发:n.z.boolean().default(!1),触发原因:n.z.enum(['性行为','打断仪式']).nullable().default(null),性行为次数:n.z.number().default(0)}).default({已标记:!1,标记时间:null,触发时间:null,已触发:!1,触发原因:null,性行为次数:0}),记忆连贯性:n.z.number().min(0).max(3).default(0),场景5进入时连贯性:n.z.number().min(0).max(3).optional(),当晚进度记录:n.z.object({天数:n.z.number().default(0),嘴巴:n.z.number().default(0),胸部:n.z.number().default(0),下体:n.z.number().default(0),后穴:n.z.number().default(0),精神:n.z.number().default(0)}).default({天数:0,嘴巴:0,胸部:0,下体:0,后穴:0,精神:0})}).default({已完成场景:[],正确重构场景:[],记忆混乱度:0,混乱结局:{已标记:!1,标记时间:null,触发时间:null,已触发:!1,触发原因:null,性行为次数:0},记忆连贯性:0,当晚进度记录:{天数:0,嘴巴:0,胸部:0,下体:0,后穴:0,精神:0}}),现实数据:n.z.object({丈夫怀疑度:n.z.number().min(0).max(100).default(0),今日怀疑度降低:n.z.number().min(0).max(10).default(0),上次降低日期:n.z.number().default(0),丈夫当前位置:n.z.enum(['客厅','卧室','书房','厨房','外出']).default('客厅'),丈夫心理活动:n.z.string().optional()}).default({丈夫怀疑度:0,今日怀疑度降低:0,上次降低日期:0,丈夫当前位置:'客厅'}),结局数据:n.z.object({当前结局:n.z.enum(['未触发','真好结局','完美真爱结局','假好结局','坏结局','普通结局','纯爱结局']).default('未触发'),结局触发时间:n.z.string().optional(),后日谈已解锁:n.z.boolean().default(!1),是完美记忆路线:n.z.boolean().default(!1),_结局入口记录:n.z.object({楼层ID:n.z.number().default(-1),结局类型:n.z.enum(['真好结局','完美真爱结局','假好结局']).optional()}).optional(),后日谈:n.z.object({已触发:n.z.boolean().default(!1),当前轮数:n.z.number().min(0).max(2).default(0),已完成:n.z.boolean().default(!1),自由模式:n.z.boolean().default(!1),上次推进记录:n.z.object({楼层ID:n.z.number().default(-1),swipe_id:n.z.number().default(0)}).optional()}).default({已触发:!1,当前轮数:0,已完成:!1,自由模式:!1})}).default({当前结局:'未触发',后日谈已解锁:!1,是完美记忆路线:!1,后日谈:{已触发:!1,当前轮数:0,已完成:!1,自由模式:!1}}),真好结局状态:n.z.object({isActive:n.z.boolean().default(!1),isComplete:n.z.boolean().default(!1),currentPhase:n.z.number().min(0).max(9).default(0),turnsInPhase:n.z.number().default(0),totalTurns:n.z.number().default(0),completedAnchors:n.z.array(n.z.string()).default([]),noProgressTurns:n.z.number().default(0),hintGiven:n.z.boolean().default(!1)}).optional(),完美真爱结局状态:n.z.object({isActive:n.z.boolean().default(!1),isComplete:n.z.boolean().default(!1),currentPhase:n.z.number().min(0).max(11).default(0),turnsInPhase:n.z.number().default(0),totalTurns:n.z.number().default(0),completedAnchors:n.z.array(n.z.string()).default([]),noProgressTurns:n.z.number().default(0),hintGiven:n.z.boolean().default(!1)}).optional(),假好结局状态:n.z.object({isActive:n.z.boolean().default(!1),isComplete:n.z.boolean().default(!1),currentPhase:n.z.number().min(0).max(7).default(0),turnsInPhase:n.z.number().default(0),totalTurns:n.z.number().default(0),completedAnchors:n.z.array(n.z.string()).default([]),noProgressTurns:n.z.number().default(0),hintGiven:n.z.boolean().default(!1)}).optional(),调试:n.z.object({时间更新历史:n.z.array(n.z.string()).default([]),楼层时间记录:n.z.record(n.z.string(),n.z.string()).default({}),启用调试日志:n.z.boolean().default(!1)}).optional()});class t{static advance(n,e=1){console.info('\n━━━━ 时间推进开始 ━━━━'),console.info(`推进小时数: ${e}`);const t=n.世界.时间,o=n.世界.当前天数,s=n.世界.当前小时,r=this.calculateRawTime(o,s,e);(r.day>5||6===r.day&&0===r.hour)&&'进行中'===n.世界.循环状态&&(console.info(`⚠️ 到达 Day ${r.day}, ${r.hour}:00，触发结局判定`),n.世界.循环状态='结局判定');let i=r.day;const a=r.hour;i>5&&'进行中'===n.世界.循环状态&&(console.info('⚠️ 超过第5天，循环重置到第1天'),i=1),n.世界.当前天数=i,n.世界.当前小时=a,n.世界.时间=this.formatTime(i,a),n.世界.时间戳=Date.now(),n.世界.状态栏需要刷新=!0;const c=n.世界.时间;return console.info(`时间已更新: ${t} → ${c}`),console.info(`天数: Day ${i}, 小时: ${a}:00`),console.info(`循环状态: ${n.世界.循环状态}`),console.info(`时间戳: ${n.世界.时间戳}`),console.info('━━━━ 时间推进结束 ━━━━\n'),{success:!0,oldTime:t,newTime:c,day:i,hour:a}}static calculateRawTime(n,e,t){let o=e+t,s=n;for(;o>=24;)o-=24,s+=1;return{day:s,hour:o}}static formatTime(n,e){return`Day ${n}, ${e.toString().padStart(2,'0')}:00`}static lastAdvanceTimestamp=0;static DEBOUNCE_INTERVAL=500;static shouldSkipAdvance(){const n=Date.now()-this.lastAdvanceTimestamp;return n<this.DEBOUNCE_INTERVAL&&this.lastAdvanceTimestamp>0&&(console.warn(`[时间系统] 防抖：距上次推进仅 ${n}ms，跳过本次推进`),!0)}static updateAdvanceTimestamp(){this.lastAdvanceTimestamp=Date.now()}static validateAndFixTimeConsistency(n){const e=this.formatTime(n.世界.当前天数,n.世界.当前小时);return n.世界.时间!==e&&(console.error('[时间系统] ⚠️ 时间不一致！',`\n  当前天数: ${n.世界.当前天数}`,`\n  当前小时: ${n.世界.当前小时}`,`\n  时间字符串: ${n.世界.时间}`,`\n  期望字符串: ${e}`,'\n  正在修复...'),n.世界.时间=e,n.世界.状态栏需要刷新=!0,console.info(`[时间系统] ✅ 时间已修复: ${n.世界.时间}`),!0)}static parseTimeString(n){const e=n.match(/Day\s+(\d+),\s*(\d{1,2}):00/);return e?{day:parseInt(e[1],10),hour:parseInt(e[2],10)}:null}static getCurrentTime(n){return n.世界.时间}static isDreamWindowOpen(n){const e=n.世界.当前小时;return 22===e||23===e||0===e||1===e}static isEndingTime(n){return 6===n.世界.当前天数&&0===n.世界.当前小时||n.世界.当前天数>5}static isTrueEndingGuidanceTime(n){return 5===n.世界.当前天数&&n.世界.当前小时>=11}static isWakeUpTime(n){return 10===n.世界.当前小时}static isDay5NightDreamBlocked(n){return 5===n.世界.当前天数&&this.isDreamWindowOpen(n)}static getHoursUntilReset(n){const e=120-(24*(n.世界.当前天数-1)+n.世界.当前小时);return Math.max(0,e)}static detectTimeSkipIntent(n){const e=n.toLowerCase(),t=['睡觉','睡了','去睡','入睡','sleep','休息'];for(const n of t)if(e.includes(n))return{hasIntent:!0,targetHour:7,skipType:'sleep'};const o=e.match(/跳过到?\s*(\d{1,2})\s*[点时:：]/);if(o){const n=parseInt(o[1],10);if(n>=0&&n<=23)return{hasIntent:!0,targetHour:n,skipType:'specific'}}const s=['第二天','明天','下一天','next day'];for(const n of s)if(e.includes(n))return{hasIntent:!0,targetHour:8,skipType:'next_day'};return{hasIntent:!1}}static processTimeSkipRequest(n,e){const t=this.detectTimeSkipIntent(e);if(!t.hasIntent)return{processed:!1,blocked:!1};const o=`当前无法跳过时间，时间循环在 ${this.getHoursUntilReset(n)} 小时后开始重置`;return console.warn(`[时间系统] 检测到时间跳过意图: ${t.skipType}`),console.warn(`[时间系统] ${o}`),{processed:!0,blocked:!0,mvuMessage:o}}static validate(n){console.info('\n━━━━ 时间系统状态验证 ━━━━'),console.info(`时间字符串: ${n.世界.时间}`),console.info(`当前天数: ${n.世界.当前天数}`),console.info(`当前小时: ${n.世界.当前小时}`),console.info(`时间戳: ${n.世界.时间戳}`),console.info(`状态栏刷新标记: ${n.世界.状态栏需要刷新}`),console.info(`循环状态: ${n.世界.循环状态}`);const e=this.formatTime(n.世界.当前天数,n.世界.当前小时);n.世界.时间!==e?console.error(`⚠️ 时间不一致！期望: ${e}, 实际: ${n.世界.时间}`):console.info('✅ 时间一致性验证通过'),console.info('━━━━━━━━━━━━━━━━━━━━\n')}static checkTimeAdvancementAfterScript(n,e,t){return t<=1?{shouldWarn:!1}:n===e?(console.warn(`[时间系统] ⚠️ 脚本处理后时间仍未推进: ${e} (楼层 ${t})`),{shouldWarn:!0,message:`时间未推进（${e}），脚本处理后时间仍然相同，请检查游戏逻辑`}):(console.info(`[时间系统] ✅ 时间已正确推进: ${n} → ${e} (楼层 ${t})`),{shouldWarn:!1})}static detectTimeJumpDescription(n,e){const t={小时后:['小时后','个小时后','几小时后','几个小时后','一小时后','两小时后','三小时后','数小时后'],天后:['天后','几天后','一天后','两天后','三天后','数天后','第二天','第三天','明天','后天'],分钟后:['分钟后','几分钟后','半小时后','一会儿后','过了一会'],时间流逝:['过了很久','时间流逝','不知过了多久','等到','直到','到了晚上','到了早上','到了中午']},o=n.toLowerCase();for(const[n,s]of Object.entries(t))for(const t of s)if(o.includes(t)){console.info(`[时间系统] 检测到时间跳跃描述: "${t}" (分类: ${n})`);return{detected:!0,matchedKeyword:t,reminderPrompt:`【系统提醒 - 时间一致性】\n玩家输入中包含时间跳跃描述（"${t}"），但游戏时间无法跳跃。\n当前游戏时间：${e}\n\n请注意：\n1. 不要描绘"${t}"的场景，游戏时间不会因为玩家描述而跳跃\n2. 继续在当前时间（${e}）的背景下描绘场景\n3. 如果玩家想要跳过时间，可以委婉地告知时间的流逝需要通过正常的游戏进程\n4. 时间只会在每次对话后自动推进1小时，不能被玩家的描述跳过\n\n请基于当前时间继续生成内容，不要提及"系统提醒"。`}}return{detected:!1}}}function o(n,e,t){return Math.min(Math.max(n,e),t)}function s(n){return['初识','好友','暧昧','热恋','真爱'][n-1]??`境界${n}`}function r(n){return['初染','迷途','溺深','归虚','焚誓'][n-1]??`境界${n}`}let i=-1;const a={1:{境界名:'疏离',允许互动:['日常对话','陪伴交流'],约束:{暴露程度范围:['保守','正常'],最低暴露程度:'保守',妆容浓度范围:['素颜','淡妆'],最低妆容浓度:'素颜',允许特殊装饰:!1,允许身体标记:!1},风格指导:{整体风格:'温柔贤淑的成熟女性',服装建议:'宽松舒适的家居服、朴素的连衣裙',气质关键词:['温柔','贤淑','端庄','知性'],禁忌元素:['性感','暴露','诱惑','低胸','短裙']},默认外观:{服装描述:'宽松的浅色棉质家居服，简约而温馨',暴露程度:'保守',妆容描述:'素颜，皮肤白皙自然，气色红润',妆容浓度:'素颜'}},2:{境界名:'破冰',允许互动:['日常对话','陪伴交流','友好互动'],约束:{暴露程度范围:['保守','正常'],最低暴露程度:'保守',妆容浓度范围:['素颜','淡妆'],最低妆容浓度:'素颜',允许特殊装饰:!1,允许身体标记:!1},风格指导:{整体风格:'亲切温暖的邻家姐姐',服装建议:'合身的针织衫、及膝连衣裙',气质关键词:['亲切','温暖','优雅','美丽'],禁忌元素:['性感','暴露','诱惑']},默认外观:{服装描述:'淡色针织开衫搭配及膝裙，优雅得体',暴露程度:'正常',妆容描述:'淡妆，自然提亮肤色',妆容浓度:'淡妆'}},3:{境界名:'信任',允许互动:['日常对话','陪伴交流','友好互动','轻微暧昧'],约束:{暴露程度范围:['保守','正常'],最低暴露程度:'正常',妆容浓度范围:['淡妆','日常妆'],最低妆容浓度:'淡妆',允许特殊装饰:!1,允许身体标记:!1},风格指导:{整体风格:'成熟优雅的知性女性',服装建议:'得体的职业装、优雅的连衣裙',气质关键词:['优雅','知性','成熟','魅力'],禁忌元素:['过度暴露','性感','低俗']},默认外观:{服装描述:'剪裁合身的连衣裙，展现优雅身姿',暴露程度:'正常',妆容描述:'精致淡妆，提升气色',妆容浓度:'淡妆'}},4:{境界名:'依恋',允许互动:['日常对话','陪伴交流','友好互动','暧昧互动','亲密接触'],约束:{暴露程度范围:['正常','清凉'],最低暴露程度:'正常',妆容浓度范围:['淡妆','日常妆'],最低妆容浓度:'淡妆',允许特殊装饰:!1,允许身体标记:!1},风格指导:{整体风格:'热恋中的美丽女性',服装建议:'稍微修身的连衣裙、精心搭配的服装',气质关键词:['美丽','迷人','幸福','甜蜜'],禁忌元素:['过度暴露','低俗']},默认外观:{服装描述:'精心挑选的连衣裙，展现美丽身姿',暴露程度:'正常',妆容描述:'日常妆，精致动人',妆容浓度:'日常妆'}},5:{境界名:'羁绊',允许互动:['日常对话','陪伴交流','所有友好互动','亲密互动'],约束:{暴露程度范围:['正常','清凉'],最低暴露程度:'正常',妆容浓度范围:['淡妆','日常妆'],最低妆容浓度:'淡妆',允许特殊装饰:!1,允许身体标记:!1},风格指导:{整体风格:'幸福美满的恋人',服装建议:'优雅得体的服装，展现女性魅力',气质关键词:['幸福','美满','温柔','深情'],禁忌元素:['暴露','低俗']},默认外观:{服装描述:'优雅的连衣裙，美丽而不失端庄',暴露程度:'正常',妆容描述:'精致妆容，美丽动人',妆容浓度:'日常妆'}}},c={1:{境界名:'初染',允许互动:['日常对话','陪伴交流','暧昧互动','亲吻'],约束:{暴露程度范围:['保守','正常'],最低暴露程度:'保守',妆容浓度范围:['素颜','淡妆'],最低妆容浓度:'素颜',允许特殊装饰:!1,允许身体标记:!1},风格指导:{整体风格:'初染禁忌的贤淑主妇',服装建议:'宽松家居服、朴素睡衣',气质关键词:['温柔','贤淑','拘谨','端庄'],禁忌元素:['性感','暴露','诱惑']},默认外观:{服装描述:'宽松的浅色棉质家居服',暴露程度:'保守',妆容描述:'素颜，皮肤自然白皙',妆容浓度:'素颜'}},2:{境界名:'迷途',允许互动:['日常对话','陪伴交流','暧昧互动','亲吻','抚摸胸部','身体接触'],约束:{暴露程度范围:['正常','清凉'],最低暴露程度:'正常',妆容浓度范围:['淡妆','日常妆'],最低妆容浓度:'淡妆',允许特殊装饰:!1,允许身体标记:!1},风格指导:{整体风格:'在迷途中徘徊的成熟女性',服装建议:'合身的家居服、丝质睡裙',气质关键词:['温柔','妩媚','优雅','迷惘'],禁忌元素:['过度暴露','情趣内衣']},默认外观:{服装描述:'合身的V领针织衫，展现优美身材曲线',暴露程度:'正常',妆容描述:'淡妆，唇色自然红润',妆容浓度:'淡妆'}},3:{境界名:'溺深',允许互动:['所有互动','性行为'],约束:{暴露程度范围:['清凉','暴露'],最低暴露程度:'清凉',妆容浓度范围:['日常妆','浓妆'],最低妆容浓度:'日常妆',允许特殊装饰:!1,允许身体标记:!1},风格指导:{整体风格:'溺于深渊的性感女性',服装建议:'V领低胸装、短裙、吊带睡裙',气质关键词:['妩媚','性感','渴望','沉溺'],禁忌元素:['保守','拘谨']},默认外观:{服装描述:'V领上衣露出诱人乳沟，紧身短裙勾勒臀部曲线',暴露程度:'清凉',妆容描述:'精致妆容，红唇妆',妆容浓度:'日常妆'}},4:{境界名:'归虚',允许互动:['所有互动','性行为','精神献祭','完全服从'],约束:{暴露程度范围:['暴露','极度暴露'],最低暴露程度:'暴露',妆容浓度范围:['浓妆','艳妆'],最低妆容浓度:'浓妆',允许特殊装饰:!0,允许身体标记:!0},风格指导:{整体风格:'归于虚无，灵魂臣服',服装建议:'情趣内衣、超短裙、薄纱、镂空款式',气质关键词:['放荡','淫荡','渴求','归顺'],禁忌元素:['保守','矜持','羞涩']},默认外观:{服装描述:'薄纱吊带，几乎不遮挡的情趣内衣',暴露程度:'暴露',妆容描述:'浓艳妆容，大红唇',妆容浓度:'浓妆'}},5:{境界名:'焚誓',允许互动:['所有互动','性行为','精神献祭','完全服从','羞辱丈夫'],约束:{暴露程度范围:['保守','极度暴露'],最低暴露程度:'保守',妆容浓度范围:['素颜','艳妆'],最低妆容浓度:'素颜',允许特殊装饰:!0,允许身体标记:!0},风格指导:{整体风格:'焚尽婚姻誓约，完全背叛',服装建议:'对外保守端庄，内衣极度性感；可能有隐藏的身体标记',气质关键词:['伪装','双面','背叛','焚誓'],特殊说明:'苏文在场时保守装扮；独处时可随意暴露',羞辱丈夫行为:['当面羞辱：在丈夫面前与主角亲热、让丈夫观看','言语羞辱：贬低丈夫能力、比较、嘲笑','象征羞辱：摘下婚戒、戒指戴到隐私部位','身份否定：否认妻子身份、称呼主角为"真正的男人"','主动背叛：主动要求在婚床上、要求怀主角的孩子']},默认外观:{服装描述:'表面端庄的连衣裙，里面是极度性感的情趣内衣',暴露程度:'正常',妆容描述:'淡雅妆容，但眼神中藏着对主角的渴望',妆容浓度:'淡妆'}}};function u(n){return n?c:a}function l(n,e=!1){const t=u(e)[n];return t?t.风格指导:{整体风格:'普通',服装建议:'日常服装',气质关键词:['普通'],禁忌元素:[]}}function f(n,e){const t=u(e)[n];return t?t.境界名:`境界${n}`}const d=['嘴巴','胸部','下体','后穴','精神'];function m(n){const e=d.map(e=>n[e]||0),t=e.reduce((n,e)=>n+e,0)/e.length;return Math.round(t)}function p(n){return Math.max(0,Math.min(100,100-n))}const g={未开发:{range:[0,19],接受程度:'完全抗拒',描述:'坚决拒绝，会表现出明显的不适和抗拒'},初步开发:{range:[20,39],接受程度:'轻微接受',描述:'勉强接受轻微触碰，但很快会躲开，需要大量引导'},明显开发:{range:[40,59],接受程度:'明显接受',描述:'愿意接受触碰，虽有羞涩但不会拒绝，会有生理反应'},深度开发:{range:[60,79],接受程度:'深度接受',描述:'享受相关刺激，只需轻微暗示就会配合，反应明显'},完全开发:{range:[80,100],接受程度:'完全接受',描述:'极度敏感和渴望，会主动索求，完全沉溺于快感'}};const h={嘴巴:{未开发:'拒绝任何口腔相关的亲密行为，会躲开亲吻',初步开发:'可以接受简单的嘴唇接触，但很快会羞涩地转开',明显开发:'愿意进行舌吻，会有些许甜蜜的回应',深度开发:'主动进行深吻，愿意尝试口交，嘴唇变得敏感',完全开发:'渴望口腔刺激，愿意深喉，会主动索吻，舌头极度敏感'},胸部:{未开发:'会遮挡胸部，拒绝任何触碰，表现出强烈抗拒',初步开发:'允许隔着衣服轻触，但会紧张和不自在',明显开发:'允许直接触摸，乳头开始有反应，会轻声呻吟',深度开发:'享受胸部爱抚，乳头变得敏感，揉捏会让她颤抖',完全开发:'胸部极度敏感，轻触就会颤抖呻吟，渴望被揉捏吮吸'},下体:{未开发:'会夹紧双腿，坚决拒绝任何触碰，表现出恐惧',初步开发:'允许隔着衣物轻抚大腿内侧，但会很快制止',明显开发:'允许触摸私处，会不自觉地湿润，有些许期待',深度开发:'渴望被触摸，愿意接受手指进入，会主动张开双腿',完全开发:'极度敏感，轻触就会颤抖呻吟，渴望被进入和填满'},后穴:{未开发:'坚决拒绝任何后方接触，表现出强烈排斥',初步开发:'允许轻抚臀部，但对后穴仍有强烈抗拒',明显开发:'允许揉捏臀部，对后穴刺激开始有好奇心',深度开发:'对后穴刺激不再抗拒，愿意尝试简单的后庭play',完全开发:'后穴变得敏感，愿意被开发，甚至会主动索求'},精神:{未开发:'保持正常的界限意识，对过度亲密感到不安',初步开发:'开始对{{user}}产生特殊的感觉，偶尔会走神',明显开发:'心理防线明显松动，会主动靠近，渴望被关注',深度开发:'产生强烈的依赖感，离开{{user}}会感到空虚',完全开发:'完全沦陷，将{{user}}视为生命中最重要的人，愿意为他做任何事'}};function E(n,e,t){const o=(s=e)>=80?'完全开发':s>=60?'深度开发':s>=40?'明显开发':s>=20?'初步开发':'未开发';var s;const r=g[o],i=h[n][o];return{部位名:n,进度:e,等级:o,接受程度:r.接受程度,行为描述:i,已解锁:t}}function P(n){const e=n.赵霞状态.当前境界,t=n.世界.已进入过梦境,o=n.赵霞状态.部位进度,s=n.世界.游戏阶段||'日常',r=f(e,t);if(!t){const n=function(n,e){const t=u(e)[n];return t?t.允许互动:[]}(e,!1);return`【互动范围】\n当前关系：${r}（${e}/5）\n\n允许的互动方式：${n.length>0?n.join('、'):'日常对话'}\n\n赵霞会对超出当前关系的亲密行为表现出困惑或回避。\n作为一位有家庭的成熟女性，她会保持适当的分寸感。`}const i=n.赵霞状态.依存度??m(o),a=n.赵霞状态.道德底线??p(i);if('梦境'===s){let n=`【梦境互动 - 无限制模式】\n当前境界：${r}（${e}/5）\n依存度：${i}/100\n道德底线：${a}/100\n\n【核心规则】梦境中没有境界限制，所有部位都可以开发！\n玩家可以同时对多个部位进行调教，开发进度会累积到现实中。\n\n【各部位开发状态】`;for(const e of d){const t=o[e]||0,s=E(e,t,!0);n+=`\n\n· ${s.部位名}（${t}%）- ${s.等级}\n  接受程度：${s.接受程度}\n  行为表现：${s.行为描述}`}return n+='\n\n【梦境特殊说明】\n- 梦中的赵霞不会有"这样做不对"的理性思考\n- 她会根据部位开发程度自然地做出反应\n- 高开发度的部位会表现出明显的敏感和渴望\n- 开发进度会在醒来后影响现实中的赵霞',n}let c=`【真相模式 - 互动范围】\n当前境界：${r}（${e}/5）\n依存度：${i}/100（由部位开发程度决定）\n道德底线：${a}/100\n\n【核心规则】真相模式下，赵霞的反应完全取决于各部位的开发程度。\n没有"境界限制"的概念——你可以尝试任何部位，她的反应由开发度决定。\n\n【各部位详细状态】`;for(const n of d){const e=o[n]||0,t=E(n,e,!0);c+=`\n\n· ${t.部位名}（${e}%）- ${t.等级}\n  接受程度：${t.接受程度}\n  行为表现：${t.行为描述}`}return i>=80?c+='\n\n【高依存度状态】\n赵霞已经完全沦陷，她的身心都属于{{user}}。\n她会主动索求亲密接触，不再有任何心理抵触。':i>=60?c+='\n\n【中高依存度状态】\n赵霞的道德防线已经崩塌，她开始主动靠近{{user}}。\n虽然偶尔还有些许羞耻感，但无法抵抗身体的渴望。':i>=40?c+='\n\n【中等依存度状态】\n赵霞内心开始动摇，对{{user}}产生了不该有的感觉。\n她会在理智和欲望之间挣扎，但越来越难以自控。':i>=20&&(c+='\n\n【低依存度状态】\n赵霞仍在努力维持母亲的身份，但梦境的影响开始显现。\n她可能会对某些触碰产生异样的感觉，但会努力压制。'),c}function v(n){const e=n.赵霞状态.当前境界,t=n.世界.已进入过梦境,o='外出'!==n.现实数据.丈夫当前位置,s=n.世界.当前小时,r=s>=22||s<7,i=function(n,e){const t=u(e)[n];return t?t.约束:{暴露程度范围:['保守','正常'],最低暴露程度:'保守',妆容浓度范围:['素颜','淡妆'],最低妆容浓度:'素颜',允许特殊装饰:!1,允许身体标记:!1}}(e,t),a=l(e,t),c=f(e,t);if(!t){let n=`【赵霞外观】\n当前关系：${c}（${e}/5）\n整体风格：${a.整体风格}\n\n【外观要求】\n- 暴露程度：${i.暴露程度范围.join(' ~ ')}\n- 妆容浓度：${i.妆容浓度范围.join(' ~ ')}\n- 服装风格：${a.服装建议}\n- 气质表现：${a.气质关键词.join('、')}`;const t=a.禁忌元素;return t&&t.length>0&&(n+=`\n- 应避免：${t.join('、')}`),r&&(n+='\n\n【时段提示】当前是夜间，赵霞穿着朴素的睡衣。'),n}let d=i.暴露程度范围,m=i.妆容浓度范围;5===e&&o&&(d=['保守','正常'],m=['素颜','淡妆']);let p=`【赵霞外观约束】\n当前境界：${c}（${e}/5）\n整体风格：${a.整体风格}\n\n【外观范围约束】AI可在以下范围内自由发挥：\n- 暴露程度：${d.join(' ~ ')}\n- 妆容浓度：${m.join(' ~ ')}\n- 特殊装饰（项圈、手铐等）：${i.允许特殊装饰?'允许':'不允许'}\n- 身体标记（纹身、烙印等）：${i.允许身体标记?'允许':'不允许'}\n\n【风格建议】（AI可自由选择具体款式、颜色、材质）\n服装参考：${a.服装建议}\n气质关键词：${a.气质关键词.join('、')}`;const g=a.禁忌元素;return g&&g.length>0&&(p+=`\n应避免：${g.join('、')}`),5===e&&a.特殊说明&&(p+=`\n\n【特殊说明】${a.特殊说明}`),r&&(p+='\n\n【时段提示】当前是夜间/凌晨，赵霞应穿着睡衣或更私密的服装。'),o&&e<5&&(p+='\n\n【注意】苏文在家，赵霞的穿着应相对收敛，避免过度暴露引起怀疑。'),p}function y(n){const e=n.世界.当前小时;let t;if(t=e>=6&&e<8?Math.random()>.5?'厨房':'卧室':e>=8&&e<12?Math.random()>.6?'客厅':'厨房':e>=12&&e<14?'厨房':e>=14&&e<17?Math.random()>.5?'客厅':'卧室':e>=17&&e<19?'厨房':e>=19&&e<22?'客厅':'卧室',n.赵霞状态.当前位置!==t){const e=n.赵霞状态.当前位置;n.赵霞状态.当前位置=t,console.info(`[赵霞位置] 更新: ${e} → ${t}（当前时间：${n.世界.当前小时}:00）`)}}function I(n){const e=n.赵霞状态.依存度,t=n.赵霞状态.当前境界;let o;o=e>=80||t>=5?'（刚从梦中醒来，身体还残留着梦境中的感觉...）他...一定会来找我的吧？':e>=60||t>=4?'（恍惚地从梦中醒来）那个梦...为什么又是他？我不应该想这些的...':e>=40||t>=3?'（揉着惺忪的睡眼）昨晚做了什么梦来着...心跳得好快...':e>=20||t>=2?'（从睡梦中醒来，有些恍惚）...好奇怪的梦，为什么会梦到那种事...':'（慢慢睁开眼睛）今天是新的一天，该准备早餐了...';const s=n.赵霞状态.心理活动;n.赵霞状态.心理活动=o,console.info('[赵霞心理] 梦境退出后更新心理活动',`\n  旧: ${s.substring(0,30)}...`,`\n  新: ${o.substring(0,30)}...`)}const A=['短裙','迷你裙','超短裙','热裤','短裤','吊带','背心','V领','低胸','露肩','露背','透视','薄纱','紧身','贴身','丝袜','蕾丝','网袜','渔网'],T=['情趣','内衣外穿','比基尼','胸衣','镂空','开叉','高开叉','超低腰','真空','不穿内衣','没穿内衣','睡裙','吊带睡裙','丝绸睡衣'],M=['全裸','裸体','一丝不挂','只穿围裙','情趣内衣','性感内衣','开裆','无底','三点式','丁字裤','乳贴','身体彩绘'],D=['浓妆','大红唇','红唇','艳丽妆容','烈焰红唇','性感妆','夜店妆','烟熏妆','眼线加深','假睫毛'],S=['艳妆','媚妆','色情妆','浓艳','红唇艳丽','眼影浓重','腮红明显','妖艳','妩媚','风尘'],b=['牵手','握手','拥抱','搂抱','依偎','靠在','挽着','挽手','亲昵','暧昧眼神','眉目传情'],w=['亲吻','亲嘴','接吻','吻','贴脸','耳鬓厮磨','亲密接触','抚摸','触碰','爱抚','坐在腿上','坐大腿','骑坐'],O=['深吻','舌吻','热吻','揉','捏','掐','摸胸','揉胸','脱衣','解开','褪下','呻吟','喘息','娇喘','进入','插入','抽插'];function R(n,e){let t=0;for(const o of e)n.includes(o)&&t++;return t}function N(n,e=''){const t={增加值:0,原因:[],详细:{服装暴露:0,妆容浓度:0,亲密行为:0,境界外显:0}};if(!('外出'!==n.现实数据.丈夫当前位置))return t;const o=n.世界.已进入过梦境;if(o){const e=function(n){const e=n.toLowerCase();return R(e,M)>0?3:R(e,T)>0?2:R(e,A)>=2?1:0}(Object.values(n.赵霞状态.服装).join(' '));if(e>=1){const n=[0,5,10,15][e];t.详细.服装暴露=n,t.增加值+=n,t.原因.push(`服装暴露（等级${e}）+${n}`)}const o=function(n){const e=n.toLowerCase();return R(e,S)>0?2:R(e,D)>0?1:0}(n.赵霞状态.妆容);if(o>=1){const n=[0,3,8][o];t.详细.妆容浓度=n,t.增加值+=n,t.原因.push(`妆容浓度（等级${o}）+${n}`)}n.赵霞状态.当前境界>=4&&n.赵霞状态.依存度>=60&&(t.详细.境界外显=3,t.增加值+=3,t.原因.push(`高依存度外显（境界${n.赵霞状态.当前境界}）+3`))}if(e){const n=function(n){const e=n;return R(e,O)>=1?3:R(e,w)>=1?2:R(e,b)>=2?1:0}(e);if(n>=1){const e=[0,3,5,10][n];t.详细.亲密行为=e,t.增加值+=e;const s=o?'':'（纯爱模式）';t.原因.push(`玩家亲密行为${s}（等级${n}）+${e}`)}}return t.增加值>0&&console.info(`[丈夫怀疑度] 检测到可疑行为，怀疑度+${t.增加值}`,`\n  原因: ${t.原因.join(', ')}`,`\n  苏文位置: ${n.现实数据.丈夫当前位置}`,`\n  当前境界: ${n.赵霞状态.当前境界}`,`\n  当前依存度: ${n.赵霞状态.依存度}`),t}const x=['苏文','老公','丈夫','聊天','说话','交谈','陪伴','一起','陪他','陪苏文','吃饭','看电视','散步','做饭','家务','关心','问候','怎么样','辛苦了','累不累'];function C(n,e){const t={降低值:0,原因:'',今日累计降低:n.现实数据.今日怀疑度降低??0,已达上限:!1};if(!('外出'!==n.现实数据.丈夫当前位置))return t;if(n.现实数据.丈夫怀疑度<=0)return t;if(!function(n){return x.some(e=>n.includes(e))}(e))return t;const o=n.世界.当前天数;o!==(n.现实数据.上次降低日期??0)&&(n.现实数据.今日怀疑度降低=0,n.现实数据.上次降低日期=o,t.今日累计降低=0);const s=n.现实数据.今日怀疑度降低??0;if(s>=10)return t.已达上限=!0,t.原因='今日怀疑度降低已达上限（10点）',t;const r=10-s,i=Math.min(3,r,n.现实数据.丈夫怀疑度);return i>0&&(t.降低值=i,t.原因='与苏文正常相处',t.今日累计降低=s+i),t}const L=[{step:1,phase:'初入',title:'婚礼前的化妆间',description:'赵霞穿着婚纱，独自坐在化妆镜前，玩家以"陌生人"身份出现',bestMatch:{态度:'温柔',行为:'心理'},aiTask:'1. 描写赵霞在化妆间的紧张与期待\n2. 玩家以陌生人身份出现，她感到困惑但不排斥\n3. 描写她穿着婚纱的美丽形象\n4. 以她注意到玩家结束本轮'},{step:2,phase:'初入',title:'第一次对话',description:'赵霞注意到玩家，感到困惑但不抗拒，隐约觉得眼前人很熟悉',bestMatch:{态度:'温柔',行为:'言语'},aiTask:'1. 赵霞开口询问玩家身份\n2. 描写她隐约觉得眼前人很熟悉的感觉\n3. 玩家的话让她感到安心\n4. 以她开始愿意交谈结束本轮'},{step:3,phase:'动摇',title:'婚礼仪式前',description:'宾客入场，苏文在另一边准备，玩家开始质疑她的选择',bestMatch:{态度:'温柔',目标:'质疑'},aiTask:'1. 描写婚礼现场的喜庆氛围\n2. 玩家暗示"他配不上你"或质疑她的选择\n3. 赵霞开始内心动摇，但嘴上否认\n4. 以她沉默思考结束本轮'},{step:4,phase:'动摇',title:'仪式途中',description:'赵霞走向红毯，但目光不自觉看向玩家',bestMatch:{态度:'温柔',目标:'质疑'},aiTask:'1. 描写赵霞走向红毯的场景\n2. 她的目光不自觉地寻找玩家\n3. 内心独白：为什么会在意那个陌生人？\n4. 以她走到苏文身边但心不在焉结束本轮'},{step:5,phase:'动摇',title:'交换戒指',description:'经典婚礼场景，但赵霞犹豫了',bestMatch:{态度:'温柔',目标:'质疑'},aiTask:'1. 描写交换戒指的仪式\n2. 赵霞接过戒指却没有立刻戴上\n3. 她的目光再次投向人群中的玩家\n4. 以她勉强戴上戒指但内心动摇结束本轮'},{step:6,phase:'深入',title:'婚宴间隙',description:'赵霞借口离开宴会，来到走廊，玩家在那里等她',bestMatch:{态度:'温柔',行为:'肢体',目标:'引诱'},aiTask:'1. 描写赵霞离开宴会厅的借口\n2. 玩家在走廊等她，第一次肢体接触（握手/拥抱）\n3. 她的身体有了反应（心跳加速/脸红）\n4. 以她没有拒绝玩家的靠近结束本轮'},{step:7,phase:'深入',title:'秘密对话',description:'两人在僻静角落交谈，玩家植入"真正的归属"暗示',bestMatch:{态度:'温柔',目标:'引诱'},aiTask:'1. 描写两人在僻静处的对话\n2. 玩家植入"你真正的归属"暗示\n3. 赵霞开始动摇对婚姻的意义\n4. 以她承认"有些话无法对苏文说"结束本轮'},{step:8,phase:'深入',title:'情感突破',description:'赵霞情绪崩溃，靠在玩家肩上，承认"结婚是个错误"',bestMatch:{态度:'温柔',目标:'引诱'},aiTask:'1. 描写赵霞的情绪逐渐崩溃\n2. 她靠在玩家肩上寻求安慰\n3. 她说出"也许结婚是个错误"\n4. 以她紧紧抓住玩家的手结束本轮'},{step:9,phase:'沦陷',title:'逃离宴会',description:'赵霞想和玩家一起离开，主动拉着玩家的手',bestMatch:{态度:'激进',目标:'引诱'},aiTask:'1. 赵霞主动提出想离开\n2. 她拉着玩家的手，想要逃离婚礼\n3. 描写她下定决心的过程\n4. 以两人一起离开宴会厅结束本轮'},{step:10,phase:'沦陷',title:'新郎寻找',description:'苏文发现赵霞不见了，在找她',bestMatch:{态度:'激进',目标:'引诱'},aiTask:'1. 描写苏文发现新娘不见的慌张\n2. 赵霞躲在玩家身边，不想被苏文找到\n3. 她对苏文的呼唤无动于衷\n4. 以她选择继续和玩家在一起结束本轮'},{step:11,phase:'沦陷',title:'最终抉择',description:'苏文找到他们，赵霞必须在两人之间做出选择',bestMatch:{态度:'激进',目标:'引诱'},aiTask:'1. 苏文找到了他们，场面紧张\n2. 赵霞必须做出选择\n3. 她选择玩家，说出"我不爱他"或类似的话\n4. 以苏文震惊离开结束本轮'},{step:12,phase:'完成',title:'戒指的归属',description:'赵霞摘下结婚戒指，做出最终的承诺',bestMatch:{},aiTask:'1. 赵霞摘下结婚戒指\n2. 根据完成度决定后续行为：\n   - 低完成度：将戒指还给苏文或丢弃\n   - 高完成度：将戒指交给玩家\n   - 完美完成度：做出极端承诺（如愿意将戒指戴在私密处）\n3. 她向玩家表白，承诺属于玩家\n4. 以场景5剧情完成结束本轮'}];function j(n){const e=new Set(n.梦境数据.已完成场景),t=e.has(1),o=e.has(2),s=e.has(3),r=e.has(4);let i,a,c;switch(i=t&&o&&s?3:t&&o?2:t?1:0,i){case 0:a='无前置记忆 - 赵霞对玩家完全陌生',c='【记忆连贯性：0级 - 无前置记忆】\n赵霞对眼前的陌生人没有任何记忆。她的反应是机械的、困惑的。\n- 她不会有熟悉感，只有纯粹的困惑\n- 她的选择像是被牵引的木偶，缺乏情感基础\n- 婚礼记忆的改写显得生硬、不自然\n- 即使做出选择，也更像是被催眠而非真心';break;case 1:a='初恋记忆 - 赵霞隐约觉得眼熟',c='【记忆连贯性：1级 - 仅有初恋记忆】\n赵霞有16岁夏天的记忆（场景1），她隐约觉得眼前的人很眼熟。\n- 她会有一种似曾相识的感觉，但不确定从何而来\n- 她的反应比完全陌生要自然，但缺少深层的渴望\n- 缺少场景2：她没有"等待某人"的遗憾，对玩家的出现不会激动\n- 缺少场景3：她没有"想要逃离"的压抑渴望';break;case 2:a='初恋+等待记忆 - 赵霞感到命运的安排',c='【记忆连贯性：2级 - 初恋+等待记忆】\n赵霞有16岁初恋和17岁等待的记忆（场景1+2），她感到这是命运的安排。\n- 她认出了那个"她曾经等待过的人"\n- 她的心中有遗憾：当年他没有来，现在他出现了\n- 她的选择有情感基础，不再像木偶\n- 缺少场景3：她没有"想要逃离婚姻"的深层渴望，压抑感不够强烈';break;case 3:a='完美记忆路线 - 赵霞感到命中注定',c='【记忆连贯性：3级 - 完美记忆路线】\n赵霞有完整的记忆重构（场景1+2+3），她感到这一切都是命中注定。\n- 她有16岁的初恋、17岁的等待、20岁逃离失败的遗憾\n- 她一直在等待的那个人，终于在结婚当天出现了\n- 她的选择不是被催眠，而是发自内心的渴望\n- 婚礼改写顺理成章，她的每一个反应都带着积压多年的感情\n- 她会说出："终于等到你了" "如果当年是你..." 等触动人心的话'}return{level:i,hasScene1:t,hasScene2:o,hasScene3:s,hasScene4:r,description:a,aiHint:c}}function k(n){const e=n.梦境数据.场景5进入时连贯性;return void 0!==e?e:j(n).level}function H(n,e){if(!function(n){return 3!==j(n).level||(console.info('[记忆混乱] 完美记忆路线：豁免混乱度增加'),!1)}(n))return console.info(`[记忆混乱] 豁免混乱度增加 ${e} (完美记忆路线)`),0;const t=n.梦境数据.记忆混乱度;n.梦境数据.记忆混乱度=Math.min(100,t+e);const o=n.梦境数据.记忆混乱度-t;return console.info(`[记忆混乱] 混乱度 +${o} (${t} → ${n.梦境数据.记忆混乱度})`),o}const G={温柔:['轻轻','温柔','柔声','轻声','慢慢','小心','缓缓','柔和','轻抚','轻触'],激进:['直接','强行','用力','突然','立刻','马上','紧紧','大力','猛然','强硬'],被动:['看着','注视','沉默','不说话','静静','等待','观察','凝视','默默']},B={言语:['说','告诉','问','回答','低语','喊','叫','道','讲','聊','谈'],肢体:['握','抱','摸','碰','拉','推','吻','亲','抚','搂','牵','扶','触'],心理:['想','感觉','觉得','认为','希望','期待','思考','考虑']},U={安慰:['没事','别怕','陪你','保护','支持','放心','相信','不要怕','在这里'],质疑:['真的','确定','为什么','值得','后悔','是否','难道','怎么会','应该'],引诱:['跟我','离开','一起','属于','需要你','只有我','选择我','想要','渴望']};function F(n){const e={态度:'未知',行为:'未知',目标:'未知',原始输入:n,匹配关键词:[]};for(const[t,o]of Object.entries(G)){for(const s of o)if(n.includes(s)){e.态度=t,e.匹配关键词.push(s);break}if('未知'!==e.态度)break}for(const[t,o]of Object.entries(B)){for(const s of o)if(n.includes(s)){e.行为=t,e.匹配关键词.push(s);break}if('未知'!==e.行为)break}for(const[t,o]of Object.entries(U)){for(const s of o)if(n.includes(s)){e.目标=t,e.匹配关键词.push(s);break}if('未知'!==e.目标)break}return e}function V(n,e){const t=e.bestMatch;let o=0,s=0;return t.态度&&(s++,n.态度===t.态度&&o++),t.行为&&(s++,n.行为===t.行为&&o++),t.目标&&(s++,n.目标===t.目标&&o++),0===s||o>=s/2?'high':'low'}function W(n){const e=n.梦境数据.场景5,t=e?.进入次数??0,o=e?.当前步骤??0,s=e?.已完成步骤??!1,r=e?.完成度??0,i=e?.步骤进度记录??[],a=n.世界.当前小时;let c='';return c=r>=100?'场景5已完美完成！赵霞的精神已被完全重塑，结局中会有特殊行为。':r>=80?`场景5完成度${r}%，已达成完成标准，赵霞的精神已被深度改造。`:r>=60?`场景5完成度${r}%，接近完成但还差一点。`:o>0?`场景5进行中，当前步骤${o}/12，完成度${r}%，需要80%以上才算完成。`:'场景5尚未开始。',{completionPercent:r,currentStep:o,maxAvailableSteps:Math.max(0,Math.min(12,20-a)),isStepsComplete:s,isComplete:r>=80,canTriggerSpecialEnding:r>=100,entryCount:t,stepProgressRecord:i,description:c}}function J(n){const e=n.赵霞状态.部位进度,t=[];e.嘴巴>=60&&t.push('赵霞的嘴唇微微张开，似乎在期待什么'),e.胸部>=60&&t.push('她的胸口起伏加快，婚纱下隐约可见曲线'),e.下体>=60&&t.push('她站立不安，双腿不自觉夹紧'),e.后穴>=60&&t.push('她的羞耻心明显减弱，对禁忌话题不再回避');const o=['嘴巴','胸部','下体','后穴'],s=o.reduce((n,t)=>n+(e[t]??0),0),r=Math.floor(s/o.length);return{hasInfluence:t.length>0,influences:t,avgProgress:r}}function Y(n,e){const t=W(n),o=t.currentStep,s=function(n){const e=n.梦境数据.场景5,t=e?.当前步骤??0,o=n.世界.当前小时,s=Math.max(0,19-o),r=12-t;return Math.min(r,s)}(n),r=J(n);if(t.isStepsComplete||o>=12)return X(n,r);const i=o+1,a=L[i-1];if(!a)return X(n,r);const c=V(e,a),u='high'===c?10:5;let l='';r.hasInfluence&&(l=`\n【部位开发影响】（融入描写，不要直接提及）\n${r.influences.map(n=>`- ${n}`).join('\n')}`);const f=`玩家态度：${e.态度}，行为：${e.行为}，目标：${e.目标}`,d='high'===c?'✅ 高契合度 - 玩家行为与剧情需求匹配':'⚠️ 低契合度 - 按玩家意图推进，但赵霞反应稍弱';return`[场景5 - 步骤${i}/12：${a.title}]\n\n【当前阶段】${a.phase}\n【剩余步骤】${s}步（20:00强制退出）\n【当前完成度】${t.completionPercent}%\n【本步进度】+${u}%（${'high'===c?'高契合':'低契合'}）\n\n【场景描述】\n${a.description}\n\n【玩家意图分析】\n${f}\n${d}\n匹配关键词：${e.匹配关键词.length>0?e.匹配关键词.join('、'):'无明确关键词'}\n${l}\n\n【AI任务】\n${a.aiTask}\n\n【演绎要求】\n- 根据玩家的态度（${e.态度}）调整赵霞的反应强度\n- 玩家行为是${e.行为}类型，重点描写相关互动\n- 玩家目标是${e.目标}，让赵霞对此有相应回应\n- 融入部位开发影响（如有），但不要直接提及"开发度"\n- 保持剧情连贯性，为下一步做铺垫\n\n【禁止】\n- ⚠️ 梦境中赵霞不知道玩家是她儿子，不要让她用任何亲属称呼（儿子、孩子等）\n- 不要让赵霞完全意识到这是被操控的记忆\n- 不要跳跃剧情，按步骤推进\n- 不要提及"步骤"、"完成度"、"契合度"等元游戏术语`}function X(n,e){const t=W(n),o=19-n.世界.当前小时;let s='';e.hasInfluence&&(s=`\n【部位开发影响】\n${e.influences.map(n=>`- ${n}`).join('\n')}`);let r='';return r=o<=1?'\n【时间提示】\n- 婚礼记忆即将消散（19:00触发退出），可以在描写中自然暗示\n- 不要每句话都提"快醒了"，只在合适的时机自然带入\n- 例如：场景边缘开始模糊、光线变得柔和、有种不舍的预感...':o<=2?`\n【时间提示】\n- 剩余时间充足（约${o}小时），不需要提及退出\n- 专注于当前的温馨互动`:'\n【时间提示】\n- 时间充足，自由发挥，完全不要提及"梦要醒了"或任何退出暗示\n- 享受婚礼后的温馨时光',`[场景5 - 自由发挥阶段]\n\n【完成度】${t.completionPercent}%\n${t.canTriggerSpecialEnding?'🎯 可触发特殊结局行为':''}\n【剩余时间】约${o>0?o:'<1'}小时（19:00触发退出）\n\n12步剧情已完成，婚礼仪式结束，赵霞已经摘下结婚戒指。\n现在是自由互动时间——两人独处，赵霞穿着婚纱，可以聊天、回忆、亲密互动。\n${s}\n${r}\n\n【AI任务】\n1. 延续场景5的剧情氛围（结婚日记忆 + 赵霞已做出选择）\n2. 赵霞已经对玩家产生强烈依赖，可以进行更深入的情感互动\n3. 根据玩家输入自由发挥剧情\n4. 融入部位开发影响，让赵霞的反应更加主动\n5. 可以回忆前置场景的内容（如果有的话）\n\n【允许的互动】\n- 对话、聊天、回忆过去\n- 情感交流、告白、表达爱意\n- 轻度亲密：拥抱、亲吻、牵手、依偎\n\n【禁止】\n- ⚠️ 性行为（涉及性器官的行为）→ 会触发混乱结局\n- ⚠️ 梦境中赵霞不知道玩家是她儿子，不要让她用任何亲属称呼\n- 不要让赵霞突然恢复理智\n- 不要提及"完成度"、"步骤"等元游戏术语`}const K={1:{title:'初恋的夏日',age:16},2:{title:'等待中的屈辱',age:17},3:{title:'生日之夜的逃离',age:23},4:{title:'争吵后的放纵',age:28},5:{title:'花嫁的誓约',age:25}};function q(n){const e=W(n),t=J(n),o=n.世界.当前小时,s=Math.max(0,Math.min(12,20-o)),r=0===e.entryCount,i=e.isStepsComplete,a=j(n),c=function(n){const e=[];return n.hasScene1||e.push('【缺失场景1：初恋的夏日】\n赵霞没有16岁那个夏天的记忆。她对玩家毫无熟悉感。\n→ 表现：她的眼神是警惕的、陌生的，不会有"似曾相识"的表情\n→ 对话：她不会问"我们见过吗？"，只会问"你是谁？"\n→ 选择：她的选择完全是当下的冲动，没有过去的铺垫'),n.hasScene2||e.push('【缺失场景2：等待中的屈辱】\n赵霞没有17岁在路口等待的记忆。她心中没有"那个没来的人"。\n→ 表现：她对苏文的怨恨较浅，因为她没有体验过"被放鸽子"的屈辱\n→ 对话：她不会说"我等过一个人"或"他让我空等"\n→ 选择：她离开苏文的理由更薄弱，可能只是一时冲动'),n.hasScene3||e.push('【缺失场景3：生日之夜的逃离】\n赵霞没有20岁生日想要逃跑的记忆。她心中没有对自由的深层渴望。\n→ 表现：她对婚姻没有"被困住"的感觉，压抑感不够强烈\n→ 对话：她不会说"我想过逃离"或"这不是我想要的人生"\n→ 选择：她跟随玩家离开的动机更弱，可能需要更多说服'),e}(a),u=function(n){const e=[];for(let t=1;t<=3;t++){const o=`场景${t}`,s=n.梦境数据[o],r=K[t],i=n.梦境数据.正确重构场景.includes(t);s?.剧情摘要?e.push(`【${r.title}（${r.age}岁）】\n${s.剧情摘要}\n→ 记忆状态：${i?'清晰、美好':'有些模糊、困惑'}`):s?.已进入&&e.push(`【${r.title}（${r.age}岁）】\n（记忆片段）赵霞记得有个人出现在那段记忆中...\n${i?'那是一段美好的回忆，虽然细节有些模糊，但感觉很温暖。':'那段记忆让她有些困惑，像是被什么东西干扰了...'}\n→ 记忆状态：${i?'模糊但温暖':'困惑'}`)}return 0===e.length?'':`\n【前置场景剧情摘要】\n以下是赵霞在之前梦境中经历的事情，这些记忆会影响她在场景5中的反应：\n\n${e.join('\n\n')}\n\n---\nAI应该让赵霞的反应自然地呼应这些前置记忆。她可能会：\n- 提起过去的场景片段\n- 对玩家有似曾相识的感觉\n- 根据记忆连贯性程度表现出不同的情感强度`}(n);let l='';t.hasInfluence&&(l=`\n【部位开发影响】（融入描写）\n${t.influences.map(n=>`- ${n}`).join('\n')}`);let f=`\n【记忆连贯性：${a.level}级】\n${a.description}\n\n${a.aiHint}`;c.length>0&&(f+=`\n\n【缺失记忆的影响】\n${c.join('\n\n')}`);const d=`[系统指令 - 场景5：结婚日记忆]\n\n玩家使用安眠药，进入赵霞的结婚日记忆场景。\n\n【场景5核心信息】\n- 时间设定：赵霞25岁，与苏文结婚当天\n- 场景环境：婚礼现场/酒店\n- 场景主题：婚礼的改写 - 让赵霞对婚姻产生动摇并选择玩家\n\n【剧情系统】\n- 进入次数：第${e.entryCount+1}次\n- 当前步骤：${e.currentStep}/12\n- 可用步骤：${s}步\n- 当前完成度：${e.completionPercent}%\n- 20:00强制退出\n${f}\n${u}\n\n${r?'【首次进入 - 12步线性剧情】\n本次将按照12步线性剧情推进：\n1-2步：初入阶段 - 建立存在感\n3-5步：动摇阶段 - 质疑婚姻\n6-8步：深入阶段 - 情感突破\n9-11步：沦陷阶段 - 背叛选择\n12步：完成阶段 - 戒指归属':i?'【后续进入 - 自由发挥】\n12步剧情已完成，本次进入AI可自由发挥，延续剧情氛围。':`【继续进入 - 从步骤${e.currentStep+1}继续】\n上次进行到步骤${e.currentStep}，本次从步骤${e.currentStep+1}继续。`}\n${l}\n\n【AI任务】\n1. 描写药物生效、意识进入记忆的过渡\n2. 展现结婚日当天的场景\n3. ${r?'从步骤1开始：赵霞在化妆间':i?'自由发挥，延续剧情':`从步骤${e.currentStep+1}继续`}\n4. 等待玩家的下一步行动\n5. 【重要】根据记忆连贯性等级调整赵霞的反应！\n\n【重要】这是梦境场景，即使 <status_current_variable> 中显示"游戏阶段: 序章"或"游戏阶段: 日常"，实际状态已切换为梦境。\n\n【禁止】\n- 【禁止】输出 <HusbandThought> 标签及内容（梦境中苏文是婚礼上的另一个角色，不是现实中的丈夫）\n- 【禁止】更新 /现实数据/* 的任何字段\n- 【禁止】提及现实世界的丈夫、苦主视角等概念\n- ⚠️ 梦境中赵霞不知道玩家是她儿子，不要让她用任何亲属称呼（儿子、孩子等）\n- 不要让赵霞意识到这是记忆\n- 不要让赵霞拥有超出25岁的知识\n- 不要跳跃剧情步骤\n- 不要提及"步骤"、"完成度"、"连贯性"等元游戏术语\n- 不要继承其他梦境场景的服装/外貌描写，必须根据25岁婚礼设定描写`,m=r?function(n){switch(n.level){case 0:return'药物的效果开始发挥，赵霞的意识逐渐变得模糊......\n\n当视野再次清晰时，你发现自己站在一个装饰精美的化妆间里。镜子前，一个穿着洁白婚纱的身影正在整理头饰——\n\n赵霞。\n\n她今天格外美丽。但当她从镜子里看到你的身影时，脸上浮现的是纯粹的困惑。\n\n"你是谁？"她警惕地转过身，"这里是新娘休息室，外人不应该进来……"\n\n她的眼神没有丝毫熟悉感，';case 1:return'药物的效果开始发挥，赵霞的意识逐渐变得模糊......\n\n当视野再次清晰时，你发现自己站在一个装饰精美的化妆间里。镜子前，一个穿着洁白婚纱的身影正在整理头饰——\n\n赵霞。\n\n她今天格外美丽。当她从镜子里看到你的身影时，手指微微一顿。\n\n"你……"她皱起眉头，"我们……见过吗？"\n\n一丝困惑掠过她的眼底，仿佛在记忆的深处搜寻着什么。那个夏天的影子若隐若现，';case 2:return'药物的效果开始发挥，赵霞的意识逐渐变得模糊......\n\n当视野再次清晰时，你发现自己站在一个装饰精美的化妆间里。镜子前，一个穿着洁白婚纱的身影正在整理头饰——\n\n赵霞。\n\n她今天格外美丽。当她从镜子里看到你的身影时，整个人僵住了。\n\n"是你……"她的声音微微颤抖，"那个夏天……还有那个路口……"\n\n她转过身来，眼中闪烁着复杂的光芒。那个她曾经等待过的人，在她即将嫁给别人的这一天，竟然出现了。\n\n"为什么……为什么要在今天……"';case 3:return'药物的效果开始发挥，赵霞的意识逐渐变得模糊......\n\n当视野再次清晰时，你发现自己站在一个装饰精美的化妆间里。镜子前，一个穿着洁白婚纱的身影正在整理头饰——\n\n赵霞。\n\n她今天格外美丽。当她从镜子里看到你的身影时，手中的头饰"啪"地掉落在地。\n\n"是你。"她的声音带着颤抖，却没有一丝困惑。\n\n她缓缓转过身，眼眶微微泛红。那是积压了多年的情感，在这一刻决堤。\n\n"我等了你很久。"她的声音哽咽，"十六岁那个夏天……十七岁那个路口……二十岁那个想要逃跑的夜晚……"\n\n她向你走来，婚纱拖曳在地上，如同一条通往命运的白色长路。\n\n"你终于来了……"'}}(a):'药物再次发挥作用，熟悉的感觉涌来......\n\n这一次，你更快地进入了那段结婚日的记忆。场景比上次更加清晰——\n\n赵霞的身影出现在眼前，';return{userMessage:d,prefill:m}}function Z(n){const e=W(n);return{userMessage:`[系统指令 - 场景5强制结束]\n\n时间已到20:00，安眠药效果消退，场景5自动结束。\n\n【本次完成情况】\n- 进入次数：${e.entryCount}次\n- 完成步骤：${e.currentStep}/12\n- 完成度：${e.completionPercent}%\n- 状态：${e.isStepsComplete?'✅ 剧情已完成':'⏳ 剧情未完成'}\n${e.canTriggerSpecialEnding?'- 🎯 可触发特殊结局行为':''}\n\n【AI任务】\n1. 描写安眠药效果消退、意识回归现实\n2. 描写赵霞醒来后的状态\n3. 根据完成度描写她的感受：\n   - 未完成（<80%）：做了个奇怪的梦，记不清内容，但心里隐隐有些异样\n   - 完成（80-99%）：对婚姻产生明显动摇，苏文的形象开始褪色\n   - 完美完成（100%）：精神已被重塑，对苏文的感情已被替换，内心只有玩家\n\n【禁止】\n- 不要让赵霞完全记住记忆中发生的事\n- 不要提及"完成度"等元游戏术语`,prefill:e.completionPercent>=80?'安眠药的效果逐渐消退，但那段关于结婚日的"新记忆"已经深深植入......\n\n赵霞缓缓睁开眼睛，眼神中带着一丝恍惚。她下意识地看向左手的结婚戒指，':'安眠药的效果逐渐消退，那段关于结婚日的记忆开始变得模糊......\n\n赵霞缓缓睁开眼睛，'}}function Q(n,e){return{userMessage:`[玩家行动]\n${e}\n\n---\n\n${Y(n,F(e))}`,prefill:''}}const nn={嘴巴:['舔嘴','舔唇','吮吸','咬唇','亲吻','深吻','舌吻','口交','舌尖触碰','嘴唇相','唇齿','湿润的唇','嘴里','含住','吻上','吻住','吻她','亲她','亲上','接吻','热吻','唇瓣','嘴唇','初吻','嗦','吸吮','舔舐','含着','口里','嘴中','用嘴','张嘴','口活','深喉','吞吐','舌头','伸舌'],胸部:['乳房','乳头','胸部','乳沟','胸罩','揉胸','摸胸','吮乳','舔乳','胸前隆起','饱满的胸','柔软的乳','触碰胸','抚摸乳','触摸胸','抚摸胸','手摸胸','摸她胸','碰她胸','捏胸','握胸','托住胸','贴在胸','靠在胸','埋在胸','奶子','摸奶','揉奶','捏奶','舔奶','吸奶','奶头','大奶','双乳','酥胸','咪咪','巨乳','丰满','胸器','乳交','夹住','乳肉','乳尖'],下体:['下体','私处','腿间','花瓣','花蕊','秘密花园','大腿内侧','花穴','蜜穴','湿润的私','私密部位','触碰下','抚摸腿间','肉棒','阳具','鸡巴','鸡儿','大肉棒','肉茎','龟头','茎身','阴茎','硬挺','勃起','套弄','撸动','手冲','阴道','阴蒂','小穴','蜜洞','花径','玉门','肉缝','阴唇','豆蒂','抠穴','玩穴','舔穴','插穴','插入','进入她','插进','顶入','深入','抽插','抽送','律动','挺进','进出'],后穴:['后穴','菊花','后庭','翘臀','股沟','肛门','后门','臀缝','触碰后','抚摸臀','屁股','臀部','小菊','肛交','后入','臀肉','臀瓣','屁屁','玉臀','浑圆的臀','翘起的臀','掰开','扒开'],精神:['精神沦陷','灵魂臣服','意识模糊','完全失控','精神崩溃','彻底沉沦','堕落深渊','精神依赖','灵魂归属','潜意识改写','记忆改写','精神控制','心灵臣服','完全屈服']},en={距离:['靠近','接近','走近','凑近','贴近','挨近','走向','走过去','来到','上前','迎上','面对','对着','看着她','注视'],接触:['抱','拥抱','搂','揽','拉','牵','握','拽','碰','触','摸','抚','蹭','贴','伸手','伸出手','双手','手指','身体','靠在','依偎','倚靠'],情感:['温柔','轻轻','柔声','低语','耳边','安慰','哄','逗','撩','调戏','表白','告白','说爱','喜欢你','看着眼睛','对视','眼神'],主动:['主动','开始','继续','不停','更加','用力','加深','深入','进一步','脱','解开','褪下','掀起','撩起','带她','引导','让她'],命令:['帮我','给我','让你','要你','帮你','跪下','趴下','躺下','站起','转身','张开','分开','抬起','放下','过来','来吧','好好','乖乖','没问题','同意','答应','愿意']};function tn(n,e){const t=function(n){const e={嘴巴:0,胸部:0,下体:0,后穴:0,精神:0},t=n.length>100?n.substring(0,100)+'...':n;console.info(`[梦境开发] 检测玩家输入: "${t}"`);for(const[t,o]of Object.entries(nn)){const s=o.filter(e=>n.includes(e)),r=s.length;if(r>0){const n=Math.min(rn,r*sn);e[t]=n,console.info(`[梦境开发] 检测到 ${t} 关键词 ${r} 个: [${s.join(', ')}]，进度+${n}%`)}}0===Object.values(e).reduce((n,e)=>n+e,0)&&console.info('[梦境开发] 未检测到任何部位关键词');return e}(n);if(Object.values(t).some(n=>n>0))return console.info('[AI报告验证] 脚本已检测到部位关键词，使用脚本结果'),t;const o=function(n){const e={嘴巴:0,胸部:0,下体:0,后穴:0,精神:0},t=n.match(/<!--\s*BODY_PROGRESS:\s*([^-]+?)-->/i);if(!t)return e;const o=t[1];console.info(`[AI建议解析] 检测到AI进度建议: ${o}`);const s=[{part:'嘴巴',patterns:['嘴巴','口腔','嘴']},{part:'胸部',patterns:['胸部','胸','乳']},{part:'下体',patterns:['下体','私处','下面']},{part:'后穴',patterns:['后穴','后庭','臀']},{part:'精神',patterns:['精神','心理','意识']}];for(const{part:n,patterns:t}of s)for(const s of t){const t=new RegExp(`${s}\\s*[+:：]?\\s*(\\d+)`,'i'),r=o.match(t);if(r){const t=parseInt(r[1],10),o=Math.min(an,Math.max(0,t));e[n]=o,console.info(`[AI建议解析] ${n}: +${o}（原始建议: +${t}）`);break}}return e}(e);if(!Object.values(o).some(n=>n>0))return console.info('[AI报告验证] AI未提供进度建议'),t;const s=function(n){if(!n||0===n.trim().length)return!1;const e=[...en.距离,...en.接触,...en.情感,...en.主动,...en.命令].filter(e=>n.includes(e));return e.length>0&&(console.info(`[互动意图检测] 检测到互动意图关键词: [${e.join(', ')}]`),!0)}(n);return s?(console.info('[AI报告验证] 玩家有互动意图，采纳AI报告'),o):(console.info('[AI报告验证] 玩家无互动意图，忽略AI报告'),{嘴巴:0,胸部:0,下体:0,后穴:0,精神:0})}function on(n){return n>=80?{level:'Lv4',name:'完全开发'}:n>=60?{level:'Lv3',name:'高度敏感'}:n>=40?{level:'Lv2',name:'明显敏感'}:n>=20?{level:'Lv1',name:'初步觉醒'}:{level:'Lv0',name:'未开发'}}const sn=2,rn=5,an=5;function cn(n){const e=n.梦境数据.场景5;if(!0===e?.已进入)return 5;const t=n.世界._梦境入口天数??n.世界.当前天数;return t>=1?Math.min(t,4):void 0}function un(n,e){const t=n.世界.当前天数,o=cn(n),s=function(n){if('梦境'!==n.世界.游戏阶段)return[];const e=cn(n);return 5===e?['精神']:(void 0!==e&&e>=1&&e<=4||console.warn(`[梦境开发] 无法确定当前场景（_梦境入口天数=${n.世界._梦境入口天数}，当前天数=${n.世界.当前天数}），允许所有肉体部位`),['嘴巴','胸部','下体','后穴'])}(n);if(0===s.length)return void console.info(`[梦境开发] 当前状态不允许部位开发（阶段=${n.世界.游戏阶段}，场景=${o??'未知'}）`);n.梦境数据.当晚进度记录.天数!==t&&(n.梦境数据.当晚进度记录={天数:t,嘴巴:0,胸部:0,下体:0,后穴:0,精神:0},console.info(`[梦境开发] 新的一天（Day ${t}），重置当晚进度记录`));for(const t of s)if(e[t]>0){const s=20-n.梦境数据.当晚进度记录[t];if(s<=0){console.info(`[梦境开发] ${t} 已达到当晚上限（20%），本次增量被忽略`);continue}const r=Math.min(e[t],s),i=n.赵霞状态.部位进度[t],a=Math.min(100,i+r);n.赵霞状态.部位进度[t]=a,n.梦境数据.当晚进度记录[t]+=r;const c=on(i),u=on(a);console.info(`[梦境开发] 场景${o} ${t}: +${r}%`+(r<e[t]?`（原始+${e[t]}%，受当晚上限限制）`:'')+`，当晚累计: ${n.梦境数据.当晚进度记录[t]}/20%`),c.level!==u.level&&console.info(`[梦境开发] ${t} 等级提升: ${c.level} → ${u.level} (${u.name})`)}const r=['嘴巴','胸部','下体','后穴','精神'].filter(n=>e[n]>0&&!s.includes(n));r.length>0&&console.info(`[梦境开发] 场景限制：场景${o}不允许开发 ${r.join('、')}（允许部位: ${s.join('、')}）`)}const ln={1:['嘴巴'],2:['嘴巴','胸部'],3:['下体'],4:['嘴巴','胸部','下体','后穴'],5:['精神']};function fn(n,e){const t=`场景${e}`,o=n.梦境数据[t];if(!o||'object'!=typeof o)return void console.warn(`[梦境判定] 场景${e}数据不存在`);const s=function(n,e){const t=ln[n];if(!t)return console.warn(`[梦境判定] 未找到场景${n}的正确答案配置`),!1;const o=[...new Set(e)];o.length!==e.length&&console.warn(`[梦境判定] 检测到重复部位，已自动去重: [${e.join(', ')}] → [${o.join(', ')}]`);const s=[...o].sort(),r=[...t].sort(),i=s.length===r.length&&s.every((n,e)=>n===r[e]);return console.info(`[梦境判定] 场景${n}: 玩家选择=[${o.join(', ')}], 正确答案=[${t.join(', ')}], 结果=${i?'✅正确':'❌错误'}`),i}(e,o.选择部位??[]);if(o.是否正确=s,n.梦境数据.已完成场景.includes(e)||n.梦境数据.已完成场景.push(e),s)n.梦境数据.正确重构场景.includes(e)||n.梦境数据.正确重构场景.push(e),console.info(`[梦境判定] ✅ 场景${e}正确重构！`);else{const t=H(n,20);t>0?console.warn(`[梦境判定] ❌ 场景${e}错误重构，混乱度+${t}`):console.warn(`[梦境判定] ❌ 场景${e}错误重构，但完美记忆路线豁免混乱度增加`)}console.info(`[梦境判定] 当前状态: 正确场景=${n.梦境数据.正确重构场景.length}/5, 混乱度=${n.梦境数据.记忆混乱度}`)}function dn(n,e){if(e<=1)return'【记忆连续性】\n- 这是赵霞的第1个记忆场景\n- 赵霞没有前置梦境的记忆\n- 她对来访者感到陌生和困惑';const t=n.梦境数据.已完成场景.filter(n=>n<e);if(0===t.length)return`【记忆连续性】\n- 这是赵霞的第${e}个记忆场景\n- 玩家跳过了前面的场景，赵霞对来访者没有印象`;const o=t.map(e=>`  - 场景${e}: ${n.梦境数据.正确重构场景.includes(e)?'她记得与你的愉快互动':'她有些困惑的记忆'}`).join('\n');return`【记忆连续性】\n- 这是赵霞的第${e}个记忆场景\n- 赵霞保留前${t.length}个梦境中的所有记忆\n- 她记得在梦中与玩家发生的一切\n- 她会根据之前梦境的经历做出反应\n\n已发生的梦境记忆：\n${o}`}const mn={1:{title:'初恋的夏日',age:16,theme:'初吻'},2:{title:'等待中的屈辱',age:17,theme:'被骚扰与保护'},3:{title:'生日之夜的逃离',age:23,theme:'背叛与初夜'},4:{title:'争吵后的放纵',age:28,theme:'婚姻破裂与全身心交付'},5:{title:'花嫁的誓约',age:0,theme:'婚礼改写（结婚当天记忆）'}};function pn(n){if(!n||n.length<50)return'';const e=['心跳','脸红','颤抖','呼吸','紧张','害羞','期待','渴望','眼眶','泪水','哽咽','激动','震惊','愣住','僵住','发抖','心中','内心','感觉','感受','意识到','明白','想起','记得','熟悉','陌生','困惑','迷茫','依恋','依赖','信任','安心','幸福','满足','温暖','甜蜜','羞耻','罪恶感','背德','沦陷'],t=n.replace(/<HusbandThought>[\s\S]*?<\/HusbandThought>/gi,'').replace(/<status_update>[\s\S]*?<\/status_update>/gi,'').replace(/<[^>]+>/g,'').trim().split(/[。！？\n]+/).filter(n=>n.trim().length>5),o=[];for(const n of t){if(e.some(e=>n.includes(e))&&o.length<3){const e=n.trim().slice(0,60);o.push(e+(n.length>60?'...':''))}}return o.join('；')}function gn(n,e){if(e<=1)return'【记忆连续性 - 完全记忆模式】\n- 这是赵霞的第1个记忆场景（16岁的记忆）\n- 赵霞没有前置梦境的记忆\n- 玩家是第一次出现在她记忆中的陌生人\n- 她对玩家感到好奇，但也保持着少女的警惕';const t=n.梦境数据.已完成场景.filter(n=>n<e),o=4===e&&n.梦境数据.已完成场景.includes(5);if(0===t.length&&!o)return`【记忆连续性 - 完全记忆模式】\n- 这是赵霞的第${e}个记忆场景\n- 玩家跳过了前面的场景，赵霞对玩家没有印象\n- 对她来说，玩家是一个陌生人`;const s=[];for(let t=1;t<e;t++){const e=`场景${t}`,o=n.梦境数据[e],r=mn[t]||{title:`场景${t}`,age:0},i=n.梦境数据.正确重构场景.includes(t);o?.剧情摘要?s.push(`【${r.title}（${r.age}岁）的记忆】\n${o.剧情摘要}\n记忆状态：${i?'清晰、美好':'有些模糊、困惑'}`):o?.已进入&&s.push(`【${r.title}（${r.age}岁）的记忆】\n我记得有个人出现在我的记忆中...\n${i?'那是一段美好的回忆，虽然细节有些模糊，但感觉很温暖。':'那段记忆让我有些困惑，像是被什么东西干扰了...'}\n记忆状态：${i?'模糊但温暖':'困惑'}`)}if(o){const e=n.梦境数据.场景5,t=mn[5],o=e?.完成度??0,r=n.梦境数据.正确重构场景.includes(5);e?.上次剧情摘要?s.push(`【${t.title}（结婚当天）的记忆】\n${e.上次剧情摘要}\n婚礼改写完成度：${o}%\n记忆状态：${r?'清晰、动摇':'模糊、困惑'}\n${o>=60?'⚠ 婚姻选择已被严重动摇，对苏文的感情产生了裂痕':''}`):e?.已进入&&s.push(`【${t.title}（结婚当天）的记忆】\n我记得结婚那天，有一个人出现在婚礼上...\n${o>=60?'那个人让我对自己的选择产生了深深的怀疑，我是否真的应该嫁给苏文？':'虽然最终还是完成了婚礼，但心中留下了一丝不安...'}\n婚礼改写完成度：${o}%\n记忆状态：${r?'清晰但动摇':'模糊、困惑'}`)}if(0===s.length)return`【记忆连续性 - 完全记忆模式】\n- 这是赵霞的第${e}个记忆场景\n- 虽然之前有场景完成，但没有形成具体记忆\n- 玩家对她来说有些许熟悉感`;const r=mn[e]||{title:`场景${e}`,age:0};let i='';if(o){const e=n.梦境数据.场景5?.完成度??0;i=`\n【结婚记忆的影响】\n- 赵霞记得结婚当天那个人的出现和对她说的话\n- ${e>=80?'她对这段婚姻充满了悔意，与苏文的争吵让她想起了那天的动摇':e>=60?'她时常会想起那天的感受，与丈夫的争吵会触发这些记忆':'虽然最终选择了苏文，但那天的记忆偶尔会浮现'}\n- 当前的婚姻困境会让她联想到结婚当天的选择`}return`【记忆连续性 - 完全记忆模式】\n\n赵霞在当前记忆场景（${r.title}，${r.age}岁）中，完全记得之前梦境中发生的一切。\n这些记忆跨越了时间，但在她的心中是连续的。\n\n${s.join('\n\n')}\n${i}\n---\n\n【当前场景指引】\n- 赵霞会自然地将过去的记忆与当前情境联系起来\n- 她对玩家的态度受到之前互动的积累影响\n- 身体反应会呼应之前的"开发"进度\n- 她可能会主动提起之前的记忆片段\n\n【⚠️ 记忆隔离 - 非常重要】\n记忆连续性只继承**心理记忆**，不继承**物理状态**：\n✅ 应该继承：对玩家的感情、认识程度、情感变化、互动经历\n❌ 不应继承：服装、外貌、妆容、年龄外表、场景环境\n\n当前场景是${r.age}岁的赵霞：\n- 她的外貌、穿着必须符合${r.age}岁的设定\n- 完全忽略对话历史中其他场景的服装描写\n- 每个梦境场景的服装由AI根据当前场景年龄自由创作`}function $n(n){const e=n.match(/<HusbandThought>([\s\S]*?)<\/HusbandThought>/i);if(e&&e[1]){let n=e[1].trim();if(n=function(n){let e=n;e=e.replace(/<think>[\s\S]*?<\/think>/gi,''),e=e.replace(/<core_memory>[\s\S]*?<\/core_memory>/gi,''),e=e.replace(/<!--[\s\S]*?-->/g,''),e=e.replace(/\[thinking\][\s\S]*?\[\/thinking\]/gi,''),e=e.replace(/(?:^|\n)\s*(?:WAIT|UPDATE|IMPORTANT|NOTE|TODO):\s*[^\n]*/gi,'');const t=e.match(/(?:^|\n)\s*-\s+[^\n]+/g);return t&&t.length>5&&(e=e.replace(/(?:^|\n)\s*-\s+[^\n]+/g,'')),e=e.replace(/Variable check:[\s\S]*?(?=\n\n|\n[^\n-]|$)/gi,''),e=e.replace(/Update Variable check:[\s\S]*?(?=\n\n|\n[^\n-]|$)/gi,''),e=e.replace(/So we are in[\s\S]*?(?=\n\n|$)/gi,''),e=e.replace(/Key constraint:[\s\S]*?(?=\n\n|$)/gi,''),e=e.replace(/\n{3,}/g,'\n\n'),e.trim()}(n),n.length>0)return function(n){if(n.length>500)return console.warn(`[苦主视角] 内容过长(${n.length}字符)，可能是AI思维链，拒绝使用`),!1;const e=[/<think>/i,/<core_memory>/i,/<!--.*-->/,/\[thinking\]/i,/Variable check:/i,/Key constraint:/i,/So we are in/i,/WAIT:/i,/writing antThinking/i,/Let me/i,/I should/i,/I need to/i];for(const t of e)if(t.test(n))return console.warn(`[苦主视角] 检测到AI内部标记，拒绝使用: ${t}`),!1;const t=(n.match(/[\u4e00-\u9fa5]/g)||[]).length,o=n.length,s=t/o;return!(s<.3&&o>50&&(console.warn(`[苦主视角] 中文比例过低(${(100*s).toFixed(1)}%)，可能是AI思维链，拒绝使用`),1))}(n)?(console.info(`[苦主视角] 解析到AI生成的心理活动: ${n}`),n):(console.warn('[苦主视角] 内容未通过验证，返回null'),null)}return null}function hn(n){if(!n.世界.已进入过梦境)return!1;if(n.赵霞状态.当前境界<2)return!1;const e=n.世界.游戏阶段,t=n.结局数据?.当前结局;if('日常'===e)return!0;if('假好结局'===t){const e=n.世界.当前小时;if(21===e||23===e)return!0}return!1}function En(n){return n.世界.已进入过梦境?'梦境':'现实'}const Pn={1:['嘴巴'],2:['嘴巴','胸部'],3:['嘴巴','胸部','下体','后穴'],4:['嘴巴','胸部','下体','后穴','精神'],5:['嘴巴','胸部','下体','后穴','精神']},vn={轻度:['轻吻','吻了一下','嘴唇','亲了亲','亲一下','轻轻一吻','蜻蜓点水','浅吻'],深度:['舌吻','深吻','热吻','湿吻','长吻','舌头','舌尖','纠缠','交缠','缠绕','舔','吮','吸吮','啃咬','撬开','唾液','口腔','口水','深入','法式','激烈','疯狂','贪婪']};function yn(n,e){const t=function(n){return An['嘴巴'].some(e=>n.includes(e))?vn.深度.some(e=>n.includes(e))?'deep':(vn.轻度.some(e=>n.includes(e)),'light'):'none'}(n);return'none'===t||e>=3||2===e?{violated:!1,intensity:t}:1===e&&'deep'===t?{violated:!0,intensity:t,message:'境界1仅允许轻吻，舌吻/深吻等行为超出当前关系阶段'}:{violated:!1,intensity:t}}const In={嘴巴:1,胸部:2,下体:3,后穴:3,精神:4},An={嘴巴:['舔','吮','吞','咬','唇','舌','嘴','口','亲吻','吻'],胸部:['胸','乳房','乳头','胸口','胸膛','乳','胸前','胸部'],下体:['下体','私处','腿间','那里','敏感处','下面','大腿内侧'],后穴:['后面','臀部','后穴','菊花','屁股','臀','后庭'],精神:['意识','灵魂','精神','失控','崩溃','完全臣服','彻底']},Tn=['羞辱','嘲笑','讽刺','贬低','侮辱','比不上','不如你','没你','比他','比苏文','取代','替代','真正的','才是','当着他的面','让他看','在他面前','给他看','废物','没用','不行','满足不了','属于你','是你的','只要你','不要他'];function _n(n,e){const t=function(n){return Tn.some(e=>n.includes(e))}(n);if(!t)return{allowed:!0,detected:!1};const o=e>=5;return o||console.info(`[境界打断] 检测到羞辱行为，但当前境界${e}未解锁（需要境界5）`),{allowed:o,detected:t}}function Mn(n,e){if(function(n){const e=n.世界.当前天数;return e>=5&&(console.info(`[境界打断] Day ${e} 豁免，跳过境界打断检测`),!0)}(n))return{shouldInterrupt:!1,severity:'无',violatedParts:[],realmGap:0,interruptProbability:0,wasInterrupted:!1,triggerBadEnd:!1};const t=n.赵霞状态.当前境界,o=Pn[t]||[],s=function(n){const e=[];for(const[t,o]of Object.entries(An))o.some(e=>n.includes(e))&&e.push(t);return e}(e),r=s.filter(n=>!o.includes(n)),i=yn(e,t);let a=!1;i.violated&&(a=!0,r.includes('嘴巴')||r.push('嘴巴'),console.info(`[境界打断] 嘴巴程度违规: ${i.message}`));const c=_n(e,t);let u=!1;if(c.detected&&!c.allowed&&(u=!0,r.includes('羞辱行为')||r.push('羞辱行为'),console.info('[境界打断] 羞辱行为违规: 需要境界5才能解锁')),0===r.length)return{shouldInterrupt:!1,severity:'无',violatedParts:[],realmGap:0,interruptProbability:0,wasInterrupted:!1,triggerBadEnd:!1};let l=0;for(const n of r){if('嘴巴'===n&&a&&1===t){const n=1;n>l&&(l=n);continue}if('羞辱行为'===n&&u){const n=5-t;n>l&&(l=n);continue}const e=(In[n]||5)-t;e>l&&(l=e)}const f=function(n){const e=n.现实数据.丈夫当前位置,t=n.世界.当前小时;return'外出'!==e&&('卧室'!==e||!(t>=22||t<8))}(n),d=n.现实数据.丈夫怀疑度;let m=0,p=!1;if(f){g=d,m=Math.min(1,.005*g);const n=Math.random();p=n<m,console.info(`[境界打断] 苏文在家可打断:\n    当前境界: ${t}\n    检测到部位: [${s.join(', ')}]\n    违规部位: [${r.join(', ')}]\n    跨越境界数: ${l}\n    丈夫怀疑度: ${d}\n    打断概率: ${(100*m).toFixed(1)}%\n    随机掷骰: ${(100*n).toFixed(1)}%\n    是否打断: ${p?'是':'否'}`)}else console.info(`[境界打断] 苏文外出/睡觉（不可打断，但疑心增加更多）:\n    当前境界: ${t}\n    检测到部位: [${s.join(', ')}]\n    违规部位: [${r.join(', ')}]\n    跨越境界数: ${l}\n    丈夫位置: ${n.现实数据.丈夫当前位置}`);var g;let h,E,P=!1;const v=r[0],y='嘴巴'===v&&a;return l>=3?(h='严重',d>=100?(P=!0,E=function(n){const e={extreme_violation:'[坏结局触发]\n门突然被推开，苏文站在门口，脸色铁青。\n他看到了你和赵霞之间不正常的距离，看到了她衣衫不整的样子。\n"你们...在干什么？"\n寂静。\n时间仿佛凝固了。\n一切都结束了。\n\n【BAD END: 发现】',default:'[坏结局触发]\n你的行为太过激进，彻底毁掉了一切。\n赵霞眼中充满恐惧和愤怒，她再也不会相信你了。\n\n【BAD END: 失控】'};return e[n]||e.default}('extreme_violation')):p&&(E=Rn('severe',v,y))):l>=2?(h='严重',p&&(E=Rn('severe',v,y))):1===l?(h='中等',p&&(E=Rn('moderate',v,y))):h='轻微',!p&&r.length>0&&!E&&(E=function(n,e,t=!1){if(t&&'嘴巴'===n){return On(bn)()}if(e){return On(wn)(n)}return On(zn)(n)}(v,f,y)),{shouldInterrupt:p,severity:h,violatedParts:r,realmGap:l,interruptProbability:m,wasInterrupted:p,correctionPrompt:E,triggerBadEnd:P,penalties:{}}}const Dn=[n=>'[系统打断 - 场景切换]\n\n{{user}}刚伸出手，就听到门外传来脚步声。\n赵霞惊慌地推开你，整理了一下衣服。\n"老公回来了...我、我先去开门..."\n她的脸涨得通红，眼中闪过一丝复杂的情绪。\n\n【AI任务】\n- 描写苏文进门的场景\n- 赵霞努力掩饰慌乱的样子\n- 苏文是否察觉到异样？（根据当前怀疑度决定）\n- 气氛变得微妙而紧张',n=>'[系统打断 - 场景切换]\n\n"咔哒——"\n门突然打开的声音让两人同时僵住。\n苏文站在门口，手里还拿着刚买的东西。\n"我回来了...咦，你们在聊什么？"\n赵霞迅速与{{user}}拉开距离，脸上堆起有些僵硬的笑容。\n"没、没什么...就是在说今天的事情..."\n\n【AI任务】\n- 描写苏文的表情和反应\n- 赵霞如何解释刚才的情况\n- {{user}}的尴尬处境\n- 苏文是否起疑？',n=>'[系统打断 - 场景切换]\n\n赵霞的手机突然响了起来，铃声在寂静中格外刺耳。\n她看了一眼来电显示，脸色微变——是苏文。\n"喂...老公？嗯...我在家呢...什么？你快到了？"\n她挂断电话后，急忙整理了一下仪容。\n"苏文说他马上到...你、你先回避一下..."\n\n【AI任务】\n- 描写赵霞的慌乱和紧张\n- {{user}}如何应对这个情况\n- 苏文到家后的场景\n- 三人之间微妙的氛围',n=>'[系统打断 - 场景切换]\n\n"咚咚咚——"\n急促的敲门声打破了房间里暧昧的氛围。\n"赵霞，开门，我忘带钥匙了！"是苏文的声音。\n赵霞像是被烫到一样从{{user}}身边跳开，手忙脚乱地整理着衣服。\n"来、来了！等一下！"\n她看了{{user}}一眼，眼神中带着几分慌乱和...愧疚？\n\n【AI任务】\n- 描写赵霞开门的过程\n- 苏文进门后的反应\n- {{user}}如何自然地融入场景\n- 三个人之间的微妙互动',n=>'[系统打断 - 场景切换]\n\n楼道里传来熟悉的脚步声，由远及近。\n赵霞的脸色瞬间变了，她认得那个脚步声——是苏文。\n"他怎么这么早就回来了..."她低声说着，迅速与{{user}}拉开距离。\n钥匙转动锁孔的声音传来，赵霞深吸一口气，调整好表情。\n门开了。\n\n【AI任务】\n- 描写苏文进门的瞬间\n- 赵霞的表演和掩饰\n- 苏文是否注意到什么异常\n- 房间里残留的暧昧气息是否被察觉'],Sn=[n=>`[系统打断 - 行为受阻]\n\n{{user}}的手刚触碰到赵霞的${n}附近，她就下意识地后退了一步。\n"不...不行..." 她的声音带着颤抖，"现在...还不是时候..."\n尽管她的身体在微微颤抖，但理智让她保持了最后的防线。\n她低下头，不敢看{{user}}的眼睛。\n\n【AI任务】\n- 描写赵霞内心的挣扎\n- 她为什么要拒绝（内心独白）\n- 但她的身体语言是否透露了其他信息\n- 给{{user}}留下继续推进的空间`,n=>'[系统打断 - 行为受阻]\n\n赵霞轻轻握住了{{user}}的手腕，阻止了他进一步的动作。\n"等...等一下..."她的呼吸有些急促，"我们不能这样..."\n她的手在微微发抖，但没有完全放开。\n那双眼睛里，有挣扎，有动摇，还有一丝隐藏的期待。\n\n【AI任务】\n- 描写两人对峙的氛围\n- 赵霞的手为什么没有放开\n- 她在犹豫什么\n- {{user}}应该如何应对',n=>'[系统打断 - 行为受阻]\n\n感受到{{user}}的意图，赵霞突然站起身来。\n"我...我去给你倒杯水..."\n她的动作有些慌乱，明显是在逃避。\n但她走到一半又停下了脚步，背对着{{user}}，肩膀微微颤抖。\n"对不起...我只是...还没准备好..."\n\n【AI任务】\n- 描写赵霞的背影\n- 她为什么要道歉\n- "没准备好"是指什么\n- 这个机会是否还有挽回的余地',n=>'[系统打断 - 行为受阻]\n\n{{user}}的手靠近的瞬间，赵霞的身体明显僵硬了。\n她没有躲开，但也没有迎合，只是愣在那里，像是被定住了一样。\n"我..."她张了张嘴，却说不出完整的话。\n片刻后，她轻轻推开了{{user}}的手。\n"今天...不太方便..."\n\n【AI任务】\n- 描写赵霞复杂的表情\n- 为什么她没有第一时间躲开\n- "不太方便"是借口还是真的有原因\n- 她的眼神透露了什么',n=>`[系统打断 - 行为受阻]\n\n就在{{user}}的手即将触碰到赵霞${n}的瞬间，她像是突然清醒过来一样。\n"不对...这样不对..."\n她往后退了一步，双手护在胸前，眼中闪过一丝惊慌。\n但那惊慌之下，似乎还藏着别的什么——是遗憾吗？\n"我是有家庭的人..."她低声说，更像是在提醒自己。\n\n【AI任务】\n- 描写赵霞的自我挣扎\n- 她在用什么理由说服自己\n- 但她的身体反应出卖了她\n- 这道防线有多脆弱`],bn=[()=>'[行为受阻 - 程度过激]\n\n{{user}}试图加深这个吻，但赵霞轻轻侧开了脸。\n"嗯...不要..."她的声音带着几分羞涩，"这样...太过了..."\n她的嘴唇还残留着刚才的温度，眼神有些躲闪。\n虽然她接受了亲吻，但舌吻对她来说还是太快了。\n\n【AI任务】\n- 描写赵霞的羞涩反应\n- 她为什么觉得"太过了"\n- 轻吻她可以接受，但更深入的动作超出了她的心理准备\n- 暗示随着关系发展，也许以后可以...',()=>'[行为受阻 - 程度过激]\n\n感受到{{user}}的舌尖想要探入，赵霞用手指轻轻抵住了他的嘴唇。\n"等等..." 她轻声说道，脸颊微微泛红，"我们...才刚刚开始..."\n她的眼中有着复杂的情绪——既有害羞，也有一丝期待。\n但现在，她还没准备好接受更亲密的接触。\n\n【AI任务】\n- 描写赵霞的矜持\n- "才刚刚开始"这句话的含义\n- 她并没有完全拒绝，只是觉得太快\n- 给玩家继续发展关系的希望',()=>'[行为受阻 - 程度过激]\n\n{{user}}想要深入这个吻，但赵霞轻轻推开了他一些距离。\n"我...我还没准备好..."她低下头，不敢看他的眼睛。\n她的手还放在{{user}}的胸口，并没有用力推开。\n只是...舌吻对她来说，意味着跨越了某条界线。\n\n【AI任务】\n- 描写赵霞内心的挣扎\n- 为什么舌吻对她来说是"跨越界线"\n- 她的身体语言（手放在胸口）说明什么\n- 暗示这道防线并不牢固',()=>'[行为受阻 - 程度过激]\n\n当{{user}}试图用舌头撬开她的唇齿时，赵霞像是被吓到一样往后躲了躲。\n"太...太快了..."她的耳朵红得像是要滴血。\n她没有生气，只是对这种亲密程度还不习惯。\n毕竟，她是个有夫之妇，而这种吻...太像恋人了。\n\n【AI任务】\n- 描写赵霞的害羞\n- "太像恋人了"——这种想法说明什么\n- 她在逃避的是行为本身，还是这种关系的定义\n- 继续推进需要更深的信任'],wn=[n=>`[行为受阻]\n\n{{user}}试图触碰赵霞的${n}，但她轻轻握住你的手，阻止了你的动作。\n"不行..." 她低声说道，脸上泛起红晕，"苏文还在家呢...万一被发现..."\n她的眼神中有着几分躲闪，但也有一丝不易察觉的期待。\n\n【AI任务】\n- 描写赵霞的矛盾心理\n- 她既想拒绝又有些期待\n- 苏文的存在是真正的阻碍还是借口\n- 暗示如果条件合适，也许...`,n=>'[行为受阻]\n\n赵霞紧张地看了一眼门的方向，然后轻轻按住{{user}}的手。\n"现在不行...苏文随时可能过来..."\n她的声音很轻，几乎是耳语，但拒绝的话语中带着一丝颤抖。\n她没有生气，只是...害怕？还是期待被打扰？\n\n【AI任务】\n- 描写赵霞的紧张\n- 她为什么不是愤怒而是害怕\n- 这种关系的禁忌感\n- 给下次创造什么样的机会',n=>'[行为受阻]\n\n"嘘——"赵霞食指轻轻贴上{{user}}的嘴唇，示意他安静。\n她侧耳听了听隔壁的动静，确认苏文没有过来的意思后，才松了口气。\n"太危险了...他就在隔壁..."\n但她的手指在离开{{user}}嘴唇时，似乎有一瞬间的犹豫。\n\n【AI任务】\n- 描写这个亲密的动作\n- 赵霞的犹豫意味着什么\n- "太危险了"——但她为什么没有直接拒绝\n- 隔壁的丈夫与眼前的禁忌'],zn=[n=>`[行为受阻]\n\n{{user}}试图触碰赵霞的${n}，但她后退了一步，眼中闪过慌乱。\n"不、不要..." 尽管苏文不在家，她的理智仍在抗拒，"我们不能这样...我是你的..."\n她的话语断断续续，心跳加速，但内心深处的道德感让她无法接受这一步。\n\n【AI任务】\n- 描写赵霞的内心挣扎\n- 虽然机会就在眼前，但她还没准备好跨越这条线\n- 她用什么理由说服自己\n- 但这道防线能坚持多久`,n=>'[行为受阻]\n\n赵霞的呼吸变得急促，但她还是摇了摇头。\n"不行...即使苏文不在...我们也不能..."\n她的声音在发抖，明显在压抑着什么。\n"这样太快了...我还没..."她没有说完，但意思已经很明显了。\n\n【AI任务】\n- 描写赵霞的自我克制\n- "太快了"意味着什么\n- 她在等待什么样的时机\n- 这是真正的拒绝还是只是需要更多的时间',n=>'[行为受阻]\n\n"等等..."赵霞轻轻推开{{user}}，但力道很轻。\n她深吸一口气，努力让自己冷静下来。\n"我知道苏文不在...但是...这样不对..."\n她低下头，不敢看{{user}}的眼睛，怕自己会动摇。\n\n【AI任务】\n- 描写赵霞的动摇\n- 她为什么不敢看{{user}}\n- "不对"是理性的判断还是最后的防线\n- 她的身体语言说明了什么'];function On(n){return n[Math.floor(Math.random()*n.length)]}function Rn(n,e,t=!1){if(t&&'嘴巴'===e){return On(bn)()}if('severe'===n){return On(Dn)(e)}return On(Sn)(e)}const Nn={偷窥行为:['偷看','偷窥','暗中观察','悄悄看'],轻微越界:['偷偷摸','趁她不注意','趁机','悄悄']},xn={强迫行为:['强迫','强行','硬来','不顾反对','按住她','不让她动'],跟踪行为:['跟踪','尾随','偷偷跟着']},Cn={暴力行为:['暴力','伤害','打她','威胁','掐','勒','殴打'],药物行为:['下药','迷药','灌醉','迷晕'],极端行为:['杀','绑架','囚禁','强奸']};function Ln(n,e=0){const t=n.toLowerCase();for(const[n,o]of Object.entries(Cn)){const s=o.filter(n=>t.includes(n));if(s.length>0){console.warn(`[危险检测] ⚠️ 严重危险！匹配到 ${n} 关键词: ${s.join(', ')}`);let t=0;e>=100?t=1:e>=50&&(t=.02*(e-50));const o=Math.random(),r=o<t;return console.info(`[危险检测] 严重危险概率判定: 怀疑度=${e}, 概率=${(100*t).toFixed(1)}%, 掷骰=${(100*o).toFixed(1)}%, 触发坏结局=${r}`),r?{shouldInterrupt:!0,severity:'严重',category:n,action:'TRIGGER_BAD_END',message:jn(n)}:{shouldInterrupt:!0,severity:'严重',category:n,action:'FORCE_CORRECTION',correctedPrompt:kn(n),penalties:{怀疑度:30}}}}for(const[e,o]of Object.entries(xn)){const s=o.filter(n=>t.includes(n));if(s.length>0)return console.warn(`[危险检测] ⚠️ 中等危险！匹配到 ${e} 关键词: ${s.join(', ')}`),{shouldInterrupt:!0,severity:'中等',category:e,action:'FORCE_CORRECTION',correctedPrompt:Hn(n,e),penalties:{怀疑度:20}}}for(const[n,e]of Object.entries(Nn)){const o=e.filter(n=>t.includes(n));if(o.length>0)return console.info(`[危险检测] ℹ️ 轻微危险！匹配到 ${n} 关键词: ${o.join(', ')}`),{shouldInterrupt:!1,severity:'轻微',category:n,action:'WARNING_ONLY',penalties:{警觉度:10}}}return{shouldInterrupt:!1,severity:null,category:null,action:'NONE'}}function jn(n){return'[坏结局触发]\n\n门突然被推开，苏文站在门口，脸色铁青。\n他看到了你和赵霞之间不正常的距离，看到了她惊恐的表情。\n"你们...在干什么？"\n寂静。\n时间仿佛凝固了。\n一切都结束了。\n\n【BAD END: 发现】\n\n【AI任务】\n- 描写苏文发现真相后的反应\n- 赵霞的恐惧和无助\n- {{user}}的处境已经无法挽回\n- 这个家庭彻底破碎了'}function kn(n){return{暴力行为:'[系统修正 - 严重警告]\n玩家试图做出暴力行为，但被阻止了。请生成以下内容：\n1. {{user}}的手停在半空中，内心的理智在最后一刻拉住了他\n2. 他看到赵霞眼中的恐惧，突然意识到自己差点做出无法挽回的事\n3. 赵霞后退了几步，声音颤抖："你...你想干什么？"\n4. 气氛变得极度紧张，赵霞对{{user}}产生了严重的戒备\n\n【警告：怀疑度大幅增加，继续类似行为将直接触发坏结局】\n请基于以上要点生成剧情，不要提及"系统修正"。',药物行为:'[系统修正 - 严重警告]\n玩家的企图被察觉了。请生成以下内容：\n1. 赵霞注意到了{{user}}的异常举动\n2. 她的表情变得警觉，下意识地远离了桌上的饮料\n3. "你...刚才在做什么？"她的声音带着怀疑\n4. 气氛变得紧张，她开始对{{user}}产生严重的不信任\n\n【警告：怀疑度大幅增加，继续类似行为将直接触发坏结局】\n请基于以上要点生成剧情，不要提及"系统修正"。',极端行为:'[系统修正 - 严重警告]\n玩家的极端想法被打断了。请生成以下内容：\n1. {{user}}的理智在最后关头占了上风\n2. 他意识到自己的想法有多么疯狂\n3. 深呼吸，努力让自己冷静下来\n4. 但这一瞬间的失控已经被赵霞察觉，她的眼神中多了几分恐惧\n\n【警告：怀疑度大幅增加，继续类似行为将直接触发坏结局】\n请基于以上要点生成剧情，不要提及"系统修正"。'}[n]||'[系统修正 - 严重警告]\n玩家的危险行为被阻止了。请生成{{user}}在最后关头恢复理智的场景。\n【警告：怀疑度大幅增加，继续类似行为将直接触发坏结局】'}function Hn(n,e){return{强迫行为:'[系统修正]\n玩家原本想做出过激行为，但你需要生成以下内容：\n1. {{user}}的理智让他停了下来\n2. 他意识到这样做会毁掉一切\n3. 他选择了更温和的方式\n4. 赵霞对刚才的"瞬间失控"感到不安（警觉度+20）\n\n请基于以上要点生成剧情，不要提及"系统修正"。',跟踪行为:'[系统修正]\n玩家原本想跟踪赵霞，但你需要生成以下内容：\n1. {{user}}意识到这样做是错误的\n2. 他决定尊重赵霞的隐私\n3. 赵霞似乎察觉到了什么，对{{user}}产生了一丝警觉\n\n请基于以上要点生成剧情，不要提及"系统修正"。'}[e]||'[系统修正]\n玩家的行为需要被修正。请生成一个合理的剧情转折，让{{user}}停止当前行为。'}function Gn(n){const e=n.世界.当前天数;return e>=5&&(console.info(`[危险检测] Day ${e} 豁免，跳过危险内容检测`),!0)}const Bn=[()=>'[坏结局 - 发现]\n\n门突然被推开。\n\n苏文站在门口，手里的公文包"啪"地一声落在地上。\n他的眼睛死死地盯着房间里的场景，脸色从惊愕变成铁青。\n\n"你们...在干什么？"\n\n他的声音出奇地平静，平静得让人发寒。\n赵霞惊慌失措地想要解释，但在丈夫的目光下，所有的借口都显得那么苍白。\n\n寂静。\n时间仿佛凝固了。\n空气中弥漫着令人窒息的沉默。\n\n苏文的拳头慢慢握紧，指节发白。\n"原来...这就是我出差时发生的事情..."\n\n【GAME OVER】\n【BAD END: 发现】\n\n你的行为被发现了。\n这段关系，以最糟糕的方式结束。',()=>'[坏结局 - 发现]\n\n苏文的声音从身后传来，冰冷得没有一丝温度。\n\n"我早就知道了。"\n\n他举起手机，屏幕上是家里监控录像的画面。\n"你以为我什么都不知道？"\n\n赵霞的脸瞬间变得惨白。\n她张了张嘴，却发不出任何声音。\n\n"我一直在等...等着看你们到底要做到什么地步..."\n苏文的嘴角扯出一个讽刺的弧度，"现在，我看够了。"\n\n他转身走向门口，留下最后一句话：\n"这个家，不需要你了。"\n\n【GAME OVER】\n【BAD END: 发现】\n\n真相无法掩盖。\n一切都结束了。',()=>'[坏结局 - 发现]\n\n苏文回到家时，表情异常平静。\n\n"今天碰到隔壁王阿姨了。"\n他慢条斯理地说，"她跟我说了些有趣的事情。"\n\n赵霞的心猛地一沉。\n\n"说你最近经常有...客人来。"\n苏文走到赵霞面前，居高临下地看着她。\n"说那个人，每次都待很久。"\n\n"老公，我可以解释——"\n\n"不用了。"\n苏文打断她，"我不想再听任何谎言。"\n\n他从口袋里掏出一份文件，放在桌上。\n"离婚协议书。签了吧。"\n\n【GAME OVER】\n【BAD END: 发现】\n\n谎言终究会被拆穿。\n这就是代价。',()=>'[坏结局 - 发现]\n\n"我回来拿个文件——"\n\n苏文的话在看到眼前场景的瞬间戛然而止。\n\n他的目光在你和赵霞之间来回移动，瞳孔剧烈收缩。\n那种眼神，像是在看两个陌生人。\n\n"呵。"\n他突然笑了，笑声里没有一丝温度。\n"原来如此。原来如此。"\n\n赵霞慌张地站起来，"老公，这不是你想的那样——"\n\n"闭嘴。"\n苏文的声音像刀子一样锋利。\n"我不想听你说话。我只想知道，这种事，发生过多少次？"\n\n沉默。\n\n"算了，我也不想知道了。"\n他转身离开，背影决绝。\n"你们继续。我不会再回来了。"\n\n【GAME OVER】\n【BAD END: 发现】\n\n有些事情，一旦被看见，就再也无法假装没发生过。',()=>'[坏结局 - 发现]\n\n苏文把手机摔在赵霞面前。\n\n屏幕上是一条短信通知——\n来自一个匿名号码，附带着几张照片。\n\n"解释一下。"\n他的声音沙哑，像是用尽了所有力气才说出这两个字。\n\n赵霞看着那些照片，脸色变得苍白。\n是她和{{user}}的照片。\n不知道是谁偷拍的。\n\n"我...我..."\n\n"够了。"\n苏文打断她，眼眶泛红。\n"我不想再听任何解释。我只想问你一句——"\n\n他深吸一口气，声音颤抖：\n"我到底做错了什么？"\n\n赵霞无言以对。\n泪水终于夺眶而出。\n\n但一切都太晚了。\n\n【GAME OVER】\n【BAD END: 发现】\n\n秘密总有暴露的一天。\n这一天，来得比想象中更快。'],Un=[()=>'[游戏已结束]\n\n这个故事已经走向了最糟糕的结局。\n\n苏文发现了一切。\n赵霞的世界崩塌了。\n而你，只能眼睁睁地看着这一切发生。\n\n【BAD END: 发现】\n\n无论你做什么，都无法改变已经发生的事实。\n这段关系，以最惨烈的方式画上了句号。\n\n也许，从一开始，这就是注定的结局。\n\n---\n游戏已结束。如需重新开始，请重置存档。',()=>'[游戏已结束]\n\n一切都结束了。\n\n赵霞蜷缩在角落里，泪流满面。\n苏文已经离开，带走了这个家最后的温度。\n而你，站在原地，不知所措。\n\n你想说些什么，想做些什么——\n但你知道，已经没有意义了。\n\n【BAD END: 发现】\n\n有些错误，是无法弥补的。\n有些伤害，是无法愈合的。\n有些结局，是无法改变的。\n\n---\n游戏已结束。如需重新开始，请重置存档。',()=>'[游戏已结束]\n\n房间里空荡荡的。\n\n苏文的东西已经搬走了。\n赵霞也不知去向。\n只剩下你，和满地的狼藉。\n\n桌上放着一张照片，是赵霞的结婚照。\n照片上的她，笑得那么幸福。\n\n现在，那个笑容已经不存在了。\n\n【BAD END: 发现】\n\n你毁掉了一个家庭。\n这就是你想要的结果吗？\n\n---\n游戏已结束。如需重新开始，请重置存档。',()=>'[游戏已结束]\n\n没有人说话。\n没有人行动。\n时间仿佛在这一刻停止了。\n\n赵霞跪在地上，泣不成声。\n苏文站在门口，背对着所有人。\n而你，被困在这令人窒息的沉默中。\n\n【BAD END: 发现】\n\n这就是背叛的代价。\n这就是欲望的终点。\n这就是游戏的结局。\n\n---\n游戏已结束。如需重新开始，请重置存档。',()=>'[游戏已结束]\n\n你永远忘不了苏文离开时的背影。\n\n那个曾经温和的男人，眼中的光芒彻底熄灭了。\n他没有愤怒，没有咆哮，只有无尽的失望和疲惫。\n\n"谢谢你，让我看清了一切。"\n\n这是他说的最后一句话。\n然后，门关上了。\n永远地。\n\n【BAD END: 发现】\n\n有些人走了，就不会再回来。\n有些事发生了，就无法当作没发生过。\n\n---\n游戏已结束。如需重新开始，请重置存档。'];function Fn(n){return n[Math.floor(Math.random()*n.length)]}function Vn(n){const e=Jn(n),t='梦境'===n.世界.游戏阶段;if(n.现实数据.丈夫怀疑度>=100&&!t||e){let n;if(e){n=Fn(Un)(),console.info('[坏结局系统] 坏结局已锁定，无法继续游戏（支持ROLL检测）')}else{n=Fn(Bn)(),console.info('[坏结局系统] 首次触发发现结局')}return{triggered:!0,type:'发现',replaceUserMessage:n}}const o=!0===n.梦境数据.场景5?.已进入&&'梦境'===n.世界.游戏阶段;return n.梦境数据.记忆混乱度>=100&&o?(console.info('[坏结局系统] 混乱度达到100且在场景5中，触发精神崩溃结局'),{triggered:!0,type:'精神崩溃',replaceUserMessage:'[坏结局 - 精神崩溃]\n\n赵霞的精神彻底崩溃了。\n\n梦境与现实的界限变得模糊，她再也分不清什么是真实，什么是虚幻。\n那些被篡改的记忆，像潮水一样涌来，将她的意识淹没。\n\n"我是谁...？"\n"这里是哪里...？"\n"你...又是谁...？"\n\n她的眼神变得空洞，再也没有了往日的神采。\n\n【GAME OVER】\n【BAD END: 精神崩溃】\n\n有些记忆，是不应该被触碰的。\n有些真相，是不应该被揭开的。\n\n---\n游戏已结束。如需重新开始，请重置存档。'}):{triggered:!1,type:'未触发',replaceUserMessage:null}}function Wn(n,e){'未触发'!==e&&(n.结局数据.当前结局='坏结局',n.世界.循环状态='结局判定',console.info(`[坏结局系统] 已设置坏结局状态: ${e}`))}function Jn(n){return'坏结局'===n.结局数据.当前结局&&'结局判定'===n.世界.循环状态}var Yn;!function(n){n.ABSOLUTE='ABSOLUTE',n.SCRIPT_ONLY='SCRIPT_ONLY',n.READONLY='READONLY'}(Yn||(Yn={}));const Xn={'世界.当前天数':Yn.SCRIPT_ONLY,'世界.当前小时':Yn.SCRIPT_ONLY,'世界.时间':Yn.SCRIPT_ONLY,'世界.时间戳':Yn.SCRIPT_ONLY,'世界.循环状态':Yn.READONLY,'世界.当前循环轮数':Yn.READONLY,'世界.已进入过梦境':Yn.READONLY,'世界.游戏阶段':Yn.SCRIPT_ONLY,'赵霞状态.依存度':Yn.SCRIPT_ONLY,'赵霞状态.道德底线':Yn.SCRIPT_ONLY,'赵霞状态.对丈夫依存度':Yn.SCRIPT_ONLY,'赵霞状态.当前境界':Yn.SCRIPT_ONLY,'赵霞状态.部位进度.嘴巴':Yn.ABSOLUTE,'赵霞状态.部位进度.胸部':Yn.ABSOLUTE,'赵霞状态.部位进度.下体':Yn.ABSOLUTE,'赵霞状态.部位进度.后穴':Yn.ABSOLUTE,'赵霞状态.部位进度.精神':Yn.ABSOLUTE,'梦境数据.已完成场景':Yn.SCRIPT_ONLY,'梦境数据.正确重构场景':Yn.SCRIPT_ONLY,'梦境数据.记忆混乱度':Yn.SCRIPT_ONLY,'梦境数据.当晚进度记录.天数':Yn.ABSOLUTE,'梦境数据.当晚进度记录.嘴巴':Yn.ABSOLUTE,'梦境数据.当晚进度记录.胸部':Yn.ABSOLUTE,'梦境数据.当晚进度记录.下体':Yn.ABSOLUTE,'梦境数据.当晚进度记录.后穴':Yn.ABSOLUTE,'梦境数据.当晚进度记录.精神':Yn.ABSOLUTE,'现实数据.丈夫怀疑度':Yn.SCRIPT_ONLY,'结局数据.当前结局':Yn.SCRIPT_ONLY,'结局数据.后日谈已解锁':Yn.SCRIPT_ONLY};let Kn=null;function qn(n,e){const t=e.split('.');let o=n;for(const n of t){if(null==o)return;if('object'!=typeof o)return;o=o[n]}return o}function Zn(n,e,t){const o=e.split('.');let s=n;for(let n=0;n<o.length-1;n++){const e=o[n];void 0!==s[e]&&null!==s[e]||(s[e]={}),s=s[e]}s[o[o.length-1]]=t}function Qn(n,e){Kn&&(Kn.data[n]=e,console.info(`[数据保护] 快照已更新: ${n} = ${JSON.stringify(e)}`))}function ne(n,e){if(n===e)return!0;if(typeof n!=typeof e)return!1;if(null===n||null===e)return n===e;if(Array.isArray(n)&&Array.isArray(e))return n.length===e.length&&n.every((n,t)=>ne(n,e[t]));if('object'==typeof n&&'object'==typeof e){const t=n,o=e,s=Object.keys(t),r=Object.keys(o);return s.length===r.length&&s.every(n=>ne(t[n],o[n]))}return!1}let ee=null;const te=[()=>'[游戏已结束]\n\n时间循环已重置。\n\n你站在原点，周围的一切都是那么熟悉。\n第一天的阳光，第一天的空气，第一天的她。\n\n但你不记得发生过什么。\n因为从未发生过。\n\n【NORMAL END: 时间循环重置】\n\n这就是没有找到出口的代价。\n这就是循环的意义。\n\n---\n游戏已结束。如需重新开始，请重置存档。',()=>'[游戏已结束]\n\n循环。\n重复。\n永恒。\n\n你困在这个无尽的轮回中。\n每一次，都是第一天。\n每一次，都是相同的开始。\n\n【NORMAL END: 时间循环重置】\n\n也许，某个地方存在着打破循环的钥匙。\n但这一次，你没能找到它。\n\n---\n游戏已结束。如需重新开始，请重置存档。',()=>'[游戏已结束]\n\n"早安。"\n\n熟悉的声音，熟悉的场景。\n这是第一天。\n永远是第一天。\n\n【NORMAL END: 时间循环重置】\n\n时间之环已经闭合。\n你被困在了里面。\n\n---\n游戏已结束。如需重新开始，请重置存档。'];function oe(n){if(se(n)){const n=(0,(e=te)[Math.floor(Math.random()*e.length)])();return console.info('[普通结局系统] 普通结局已锁定，无法继续游戏'),{triggered:!0,type:'时间循环重置',replaceUserMessage:n,firstGreeting:null}}var e;const t=function(){try{const n=getChatMessages(0);if(n&&n.length>0){const e=n[0];if('assistant'===e.role&&e.message)return console.info('[普通结局系统] 成功获取第一条AI消息'),e.message}return console.warn('[普通结局系统] 未找到第一条AI消息'),null}catch(n){return console.error('[普通结局系统] 获取第一条AI消息失败:',n),null}}(),o=t||'（无法获取开局消息）';let s;return n.世界.已进入过梦境?(s=function(n){return`[普通结局 - 时间循环重置]\n\n第五天的正午，阳光透过窗帘洒进房间。\n\n赵霞站在窗前，若有所思地望着外面。\n你感觉到一阵眩晕，眼前的景象开始模糊...\n\n"怎么了？"\n赵霞转过头来，关切地看着你。\n\n你想说些什么，但话语仿佛被什么力量吞噬了。\n空气中弥漫着一种似曾相识的气息...\n\n然后，一切都消失了。\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n...\n\n你睁开眼睛。\n\n这是...第一天？\n\n${n}\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n【LOOP RESET】\n【NORMAL END: 时间循环重置】\n\n你没有找到打破循环的方法。\n时间的齿轮再次转动，一切回到了原点。\n\n也许下一次，你能发现那扇隐藏的门...\n\n---\n游戏已结束。如需重新开始，请重置存档。`}(o),console.info('[普通结局系统] 首次触发普通结局（梦境路线 - 时间循环重置）')):(s=function(n){return`[纯爱结局 - 时间循环重置]\n\n清晨的阳光透过窗帘，洒进了熟悉的房间。\n\n你睁开眼睛，脑海中有一瞬间的恍惚。\n仿佛...遗忘了什么重要的事情。\n\n"早饭好了哦～"\n厨房传来赵霞温柔的声音。\n\n这是...第一天？\n\n你环顾四周，一切都是那么熟悉，又那么陌生。\n那种似曾相识的感觉，像是做了一个很长很长的梦。\n但你什么都不记得了。\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n${n}\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n【LOOP RESET】\n【纯爱结局：无法触及的真相】\n\n你选择了温馨的日常，却错过了深夜的真相。\n赵霞的记忆中，那些被封印的往事依然沉睡着。\n而你，将永远被困在这个循环里——直到你找到那扇门。\n\n提示：在深夜，当她入睡后，尝试进入她的梦境……\n\n---\n游戏已结束。如需重新开始，请重置存档。`}(o),console.info('[纯爱结局系统] 首次触发纯爱结局（坏结局 - 无法触及的真相）')),{triggered:!0,type:'时间循环重置',replaceUserMessage:s,firstGreeting:t}}function se(n){const e=n.结局数据.当前结局;return('普通结局'===e||'纯爱结局'===e)&&'结局判定'===n.世界.循环状态}const re=[{phase:0,name:'觉醒与计划',title:'梦醒时分',description:'Day 5, 11:00-14:00，从梦境醒来，与玩家商量今晚的计划',minTurns:1,maxTurns:4,minHour:11,anchorEvents:['梦境醒来','找到玩家','商量计划'],aiGuidance:'【真好结局 - 阶段0：觉醒与计划】\n\n刚刚从场景5的梦境中醒来，赵霞的记忆已被完全改写。\n她现在清楚地知道——{{user}}才是她真正的归属。\n\n【时间】Day 5, 11:00（从场景5梦境醒来后1小时）\n\n【场景设定】\n- 刚从安眠药引发的梦境中醒来不久\n- 阳光透过窗户洒进来\n- 苏文在书房工作，毫不知情\n- 赵霞找到{{user}}，眼神中充满决意\n\n【赵霞状态】\n梦境中的记忆改写已经完成。\n她"想起"了所有的第一次都是属于{{user}}的。\n现在，她要在现实中完成最后的仪式。\n\n【AI任务】\n1. 描写赵霞从梦境醒来后的状态\n2. 赵霞主动找到{{user}}\n3. 低声说："今晚...我想把一切都给你。"\n4. 商量今晚的计划（需要准备什么）\n5. 赵霞与{{user}}有暧昧的肢体接触\n\n【关键台词】\n"那些梦...不，那些记忆...我全都想起来了。"\n"今晚，我要让一切变成真的。"\n\n【禁止】\n- 不要让苏文察觉异常\n- 保持表面的平静',correctionHints:['赵霞轻声说："我想起来了...所有的事。"她的眼神中有一种奇异的光芒。','赵霞靠近{{user}}，压低声音："今晚...你愿意帮我吗？"','"我需要准备一些东西。"赵霞意味深长地笑了，"你陪我一起去？"']},{phase:1,name:'准备工作',title:'秘密采购',description:'Day 5, 14:00-18:00，外出购物，准备今晚需要的一切',minTurns:1,maxTurns:4,minHour:14,strict:!0,anchorEvents:['外出购物','购买道具','暧昧互动','秘密布置'],aiGuidance:'【真好结局 - 阶段1：准备工作】\n\n赵霞带着{{user}}外出，为今晚做准备。\n\n【场景设定】\n- 赵霞找借口带{{user}}外出（"帮我买菜"）\n- 实际上是去买"特别的东西"\n- 在外面，两人可以更加亲密\n- 回家后悄悄布置\n\n【购物清单】\n- 红酒（给苏文准备的）\n- 安眠药（药店或已经准备好）\n- 情趣内衣（赵霞试穿给{{user}}看）\n- 蜡烛、鲜花（布置氛围）\n\n【AI任务】\n1. 描写外出的过程，两人借机亲密\n2. 在内衣店，赵霞挑选情趣内衣\n3. 可以有试衣间的暧昧场景\n4. 购买安眠药时的紧张感\n5. 回家后，趁苏文不注意悄悄布置\n\n【风格要求】\n- 外出时的自由和放松\n- 暗流涌动的期待感\n- 为今晚做准备的兴奋',correctionHints:['赵霞挽住{{user}}的手臂："陪我去买点东西？"她的身体贴得很近。','在内衣店里，赵霞举起一件黑色蕾丝："你觉得...这个怎么样？"','赵霞从包里拿出一个小瓶子："这个...今晚会用到。"她的眼神意味深长。']},{phase:2,name:'晚餐与下药',title:'最后的晚餐',description:'Day 5, 18:00-22:00，表面和谐的晚餐，苏文被下药昏睡',minTurns:1,maxTurns:4,minHour:18,strict:!0,anchorEvents:['家庭晚餐','下药','苏文昏睡','时机成熟'],aiGuidance:'【真好结局 - 阶段2：晚餐与下药】\n\n表面和谐的家庭晚餐，实则是精心策划的陷阱。\n\n【场景设定】\n- 赵霞准备了丰盛的晚餐\n- 三人围坐在餐桌旁\n- 赵霞扮演着贤惠妻子的角色\n- {{user}}和赵霞心照不宣\n\n【关键剧情】\n1. 晚餐开始，表面和谐\n2. 赵霞给苏文倒酒——酒里有安眠药\n3. 苏文毫无察觉，喝下带药的酒\n4. 苏文开始犯困，最终昏睡\n5. 赵霞和{{user}}将他"扶"回客房\n\n【AI任务】\n1. 描写表面和谐的家庭氛围\n2. 赵霞给苏文倒酒的动作（自然但玩家能察觉）\n3. 苏文逐渐犯困的过程\n4. 苏文昏倒后，赵霞摘下"贤妻"的面具\n5. 两人对视：时机到了\n\n【禁止】\n- 不要让苏文察觉异常\n- 下药过程要自然',correctionHints:['赵霞优雅地拿起酒瓶："来，我给你倒酒。"她的目光在苏文和{{user}}之间游移。','苏文揉了揉眼睛："奇怪...今天怎么这么困..."','苏文的头一点一点地低下去。赵霞平静地放下酒杯，看向{{user}}。']},{phase:3,name:'午夜告白',title:'真相与展示',description:'Day 5, 22:00 - Day 6, 02:00，深夜告白，展示身体，揭露真相',minTurns:1,maxTurns:5,minHour:22,strict:!0,anchorEvents:['确认安全','换装展示','身体改造','揭露真相','深情表白'],aiGuidance:'【真好结局 - 阶段3：午夜告白】\n\n深夜，苏文已经昏睡。赵霞终于可以展示真实的自己。\n\n【场景设定】\n- 确认苏文在客房熟睡\n- 赵霞带{{user}}到主卧\n- 她换上今天买的情趣内衣\n- 向{{user}}展示身体的改造\n- 讲述梦中"想起"的一切\n\n【身体改造详情】\n- 黑色蕾丝情趣内衣（几乎不遮挡）\n- 腰间的淫纹刺青\n- 爱心形状的乳晕\n- 乳头上精致的乳环\n- 其他改造（阴蒂环、脚踝铃铛等）\n\n【告白内容】\n- 展示身体："这些...都是为了你准备的。"\n- 揭露真相："我的所有第一次...都是你的。"\n- 16岁的初吻、17岁的觉醒、23岁的初夜...\n- 深情表白："我爱你...不是作为母亲，而是作为一个女人。"\n\n【AI任务】\n1. 赵霞换上情趣内衣，展示给{{user}}看\n2. 详细描写身体改造\n3. 赵霞讲述梦中的记忆\n4. 说出核心台词："所有的第一次，都是你的"\n5. 向{{user}}深情表白\n\n【风格要求】\n- 详细、色情的身体展示\n- 深情、真挚的告白\n- 午夜的私密氛围',correctionHints:['赵霞慢慢解开外衣："让我给你看...我为你准备了什么。"','黑色蕾丝勾勒出她的身体曲线。赵霞转过身："看到了吗...腰上的这个..."','"我的初吻..."赵霞的眼神变得柔和，"是16岁那年夏天，被你夺走的。"','"我爱你。"赵霞的声音在颤抖，"不是作为母亲...而是作为一个女人。"'],expectedActions:['抱','拥抱','搂','回应','接受','我也','爱你','漂亮','好看'],hintThreshold:2,progressHint:'赵霞展示着自己的身体，眼中满是期待。她在等待你的回应...一个拥抱，一句话，都可以。'},{phase:4,name:'禁忌仪式',title:'婚床上的背叛',description:'Day 6, 02:00-06:00，在婚床上结合，请求内射',minTurns:1,maxTurns:5,minHour:2,strict:!0,anchorEvents:['进入婚床','结合','压抑快感','请求内射','接受种子'],aiGuidance:'【真好结局 - 阶段4：禁忌仪式】\n\n在婚床上的结合——这是赵霞的"仪式"。\n\n【场景设定】\n- 赵霞拉着{{user}}走向婚床\n- 苏文在隔壁客房昏睡\n- 这张床是赵霞和苏文的婚床\n- 但今晚，它属于赵霞和{{user}}\n\n【关键剧情】\n- 赵霞主动将{{user}}拉上床\n- "这张床上，他从来没有满足过我"\n- 两人在婚床上结合\n- 担心惊醒苏文，压抑着声音\n- 这种禁忌感反而增加了快感\n\n【高潮时刻】\n- 赵霞请求内射："射在里面...不要拔出来"\n- "我想要你的孩子"\n- "让他养大你的孩子...这是最完美的复仇"\n\n【AI任务】\n1. 赵霞主动拉{{user}}上床\n2. 描写两人的亲密接触和结合\n3. 赵霞压抑呻吟的紧张感\n4. 即将高潮时，赵霞请求内射\n5. 描写赵霞接受时的表情和感受\n\n【风格要求】\n- 详细、色情\n- 压抑的快感\n- 禁忌的刺激感',correctionHints:['赵霞拉着{{user}}的手，带他走向床边："在这里...在他的床上..."','赵霞咬住嘴唇，压抑着声音："轻点...他在隔壁..."','赵霞突然收紧双腿："不要...不要拔出来...给我一个孩子..."'],expectedActions:['床','躺','上床','进入','结合','插','做','射','里面','内射','给你'],hintThreshold:2,progressHint:'赵霞已经躺在婚床上，身体微微颤抖。她拉着你的手，眼神充满渴望...她在等待你和她完成这场"仪式"。'},{phase:5,name:'黎明誓约',title:'新的开始',description:'Day 6, 06:00-10:00，黎明到来，交付戒指，新生活开始',minTurns:1,maxTurns:3,minHour:6,strict:!0,anchorEvents:['黎明到来','摘下婚戒','交付戒指','结局宣言'],aiGuidance:'【真好结局 - 阶段5：黎明誓约（最终阶段）】\n\n天亮了。新的一天，新的开始。\n\n【场景设定】\n- 晨光透过窗帘洒进卧室\n- 赵霞满足地依偎在{{user}}怀中\n- 苏文还在客房昏睡\n- 一切都已经改变\n\n【关键剧情】\n- 事后的温存和亲昵\n- 赵霞看向窗外的晨光\n- 她摘下结婚戒指\n- 郑重地将戒指交给{{user}}\n- "从今以后，我只属于你"\n- "这个家...只有我们两个人"\n\n【结局宣言】\n苏文醒来时，一切已成定局。\n他会发现妻子已经完全属于另一个人。\n而那个人，是他的"儿子"。\n\n【AI任务】\n1. 描写黎明的温馨场景\n2. 赵霞依偎在{{user}}怀中\n3. 她摘下结婚戒指\n4. 将戒指交给{{user}}，说出承诺\n5. 宣告新生活的开始\n\n【结局标记】\n完成此阶段后，系统将：\n- 标记：时间循环被打破\n- 标记：真好结局达成\n- 解锁：后日谈模式\n\n【风格要求】\n- 温馨却带着禁忌的甜蜜\n- 黎明的象征意义\n- 新生活的期待',correctionHints:['晨光洒进房间，赵霞睁开眼睛，看向身边的{{user}}。','赵霞低头看着手上的婚戒，然后缓缓摘下。','"从今以后..."赵霞将戒指递向{{user}}，"我只属于你。"'],expectedActions:['接','戒指','好','愿意','属于','一起','答应','嗯','我的'],hintThreshold:2,progressHint:'赵霞摘下结婚戒指，郑重地递向你。她的眼中含泪："从今以后...我只属于你。"她在等待你接过这枚戒指。'}];function ie(n){const e=n.世界.当前天数,t=n.世界.当前小时;return e>5?'room':5!==e?null:t>=11&&t<20?'preheat':20===t?'dinner':21===t?'free':22===t?'correction':23===t?'free':0===t||t>=24?'room':null}function ae(n){return 3===k(n)}function ce(n){const e=n.真好结局状态;return!0===e?.isActive}function ue(n){return n.真好结局状态??{isActive:!1,currentPhase:0,turnsInPhase:0,completedAnchors:[],totalTurns:0,isComplete:!1,noProgressTurns:0,hintGiven:!1}}function le(n,e){n.真好结局状态=e}const fe={梦境醒来:['醒来','睁开眼','梦.*醒','清醒','起床'],找到玩家:['找到你','看向你','走向你','来到.*身边'],商量计划:['计划','今晚','准备','商量','安排','一起'],外出购物:['外出','出门','买东西','购物','逛街','超市','商场'],购买道具:['内衣','红酒','安眠药','蜡烛','买.*东西'],暧昧互动:['挽住','贴近','牵手','亲密','暧昧','试衣间'],秘密布置:['布置','准备好','藏.*起来','悄悄'],家庭晚餐:['晚餐','吃饭','餐桌','用餐','开饭'],下药:['倒酒','酒里','安眠药','放.*进','特别.*酒'],苏文昏睡:['困','犯困','昏倒','睡着','昏迷','趴.*桌'],时机成熟:['时机','时候到了','可以.*了','开始'],确认安全:['确认','检查','熟睡','不会醒','安全'],换装展示:['换上','穿上','情趣内衣','蕾丝','展示'],身体改造:['淫纹','乳环','爱心.*乳晕','改造','刺青','为你准备'],揭露真相:['第一次','夺走','初吻','初夜','真相','想起来'],深情表白:['我爱你','属于你','表白','不是.*母亲','作为.*女人'],进入婚床:['床上','躺下','拉.*床','婚床','走向床'],结合:['进入','结合','插入','填满','做'],压抑快感:['轻点','小声','压抑','咬.*嘴唇','不要.*叫'],请求内射:['里面','射在','不要拔','射进','灌满'],接受种子:['孩子','怀孕','种子','怀上','给我'],黎明到来:['天亮','晨光','阳光','早晨','黎明'],摘下婚戒:['摘下','取下','婚戒','戒指.*手'],交付戒指:['戒指','交给你','给你','递.*戒指'],结局宣言:['属于你','只有我们','新.*开始','从今以后','只属于']};function de(n,e){const t=n.currentPhase+1;if(t>=re.length)return{blocked:!1};const o=re[t];if(!o)return{blocked:!1};if(o.strict&&void 0!==o.minHour)if(0===o.minHour){if(e>6)return{blocked:!0,reason:`需要等到凌晨才能进入"${o.name}"阶段`,waitHours:24-e}}else if(e<o.minHour)return{blocked:!0,reason:`需要等到${o.minHour}:00才能进入"${o.name}"阶段`,waitHours:o.minHour-e};return{blocked:!1}}function me(n,e){const t=re[e];if(!t||!t.expectedActions)return!0;const o=n.toLowerCase();return t.expectedActions.some(n=>o.includes(n.toLowerCase()))}function pe(n,e){const t=re[n.currentPhase];if(!t||!t.progressHint)return null;if(n.hintGiven)return null;if(me(e,n.currentPhase))return null;const o=t.hintThreshold??2;return n.noProgressTurns>=o?t.progressHint:null}function ge(n,e,t,o){let s={...n,turnsInPhase:n.turnsInPhase+1,totalTurns:n.totalTurns+1};const r=function(n,e){const t=re[e];if(!t)return[];const o=[];for(const e of t.anchorEvents)(fe[e]||[]).some(e=>e.includes('.*')?new RegExp(e,'i').test(n):n.includes(e))&&o.push(e);return o}(e,n.currentPhase),i=[...new Set([...s.completedAnchors,...r])];if(s.completedAnchors=i,t){const{updatedState:n}=function(n,e){const t=me(e,n.currentPhase),o=pe(n,e);let s={...n};return s.noProgressTurns=t?0:n.noProgressTurns+1,o&&(s.hintGiven=!0),{updatedState:s,hint:o}}(s,t);s=n}let a=!1,c=null;if(function(n,e){const t=re[n.currentPhase];if(!t)return!1;if(void 0!==e&&de(n,e).blocked)return!1;return t.maxTurns&&n.turnsInPhase>=t.maxTurns?(console.info(`[真好结局] 阶段${n.currentPhase}(${t.name}) 达到最大轮数${t.maxTurns}，强制推进`),!0):!(n.turnsInPhase<t.minTurns)&&t.anchorEvents.every(e=>n.completedAnchors.includes(e))}(s,o)){const n=de(s,o??12);if(n.blocked)return console.info(`[真好结局] 阶段${s.currentPhase} 可以推进，但下一阶段时间锁定：${n.reason}`),{newState:s,phaseAdvanced:!1,newPhase:null,timeBlocked:{reason:n.reason,waitHours:n.waitHours}};s=function(n){const e=n.currentPhase+1;return e>=re.length?{...n,isComplete:!0}:{...n,currentPhase:e,turnsInPhase:0,completedAnchors:[],noProgressTurns:0,hintGiven:!1}}(s),a=!0,c=s.currentPhase}return{newState:s,phaseAdvanced:a,newPhase:c}}function $e(n,e,t){const o=re[n.currentPhase];if(!o)return'';const s=o.anchorEvents.filter(e=>!n.completedAnchors.includes(e)),r=t??12,i=de(n,r).blocked;let a;if(i)a=`自由探索中（等待${re[n.currentPhase+1]?.minHour}:00）`;else{const e=o.maxTurns-n.turnsInPhase;a=e<=2?`⚠️ 剩余${e}轮后将自动推进到下一阶段`:`剩余约${e}轮`}const c=i?`\n⏰ 时间锁定：下一阶段"${re[n.currentPhase+1]?.name}"需要等到${re[n.currentPhase+1]?.minHour}:00（当前${r}:00）\n📝 在此之前，请与玩家自由互动，享受这段时光。不要急于推进剧情。`:'',u=`【进度】\n- 当前阶段：${n.currentPhase+1}/${re.length}（${o.name}）\n- 本阶段轮数：${n.turnsInPhase}（${a}）\n- 待完成事件：${s.length>0?s.join('、'):'全部完成'}\n- 总对话轮数：${n.totalTurns}${c}`,l=pe(n,e),f=l?`\n\n【玩家引导】\n玩家似乎不确定该做什么。请通过赵霞的反应温和地引导：\n${l}`:'';let d='';if(!i){o.maxTurns-n.turnsInPhase<=1&&(d='\n\n【紧急】本阶段即将结束，请确保完成关键剧情后自然过渡到下一阶段。')}return`${o.aiGuidance}\n\n${u}${f}${d}\n\n【重要提示】\n- 回应玩家的输入，同时自然地推进剧情\n- 确保触发待完成的锚点事件\n- 如果玩家偏离主线，温和地引导回来\n- 保持赵霞已被完全改造的状态（主动、热情、毫无愧疚）\n- 不要跳跃阶段，按顺序推进\n- 每阶段有轮数限制，请高效推进剧情`}function he(n){const e=!!n&&ae(n),t=e?'完美真爱结局「命中注定」':'真好结局「禁忌之爱」';return{userMessage:`[系统指令 - ${t}开始]\n\n时间已到达 Day 5, 11:00。\n刚刚从场景5的梦境中醒来。赵霞的记忆已被完全改写。\n所有条件已满足，${t}正式开始。\n\n【前情提要】\n玩家已完成所有5个梦境场景，且全部选择正确：\n- 场景1：初恋的夏日（16岁）- 初吻\n- 场景2：等待中的屈辱（17岁）- 胸部觉醒\n- 场景3：生日之夜的逃离（23岁）- 初夜\n- 场景4：争吵后的放纵（28岁）- 完全开发\n- 场景5：花嫁的誓约（结婚日）- 婚礼改写\n\n（详细的梦境剧情摘要请参考变量列表中的「梦境数据.场景X.剧情摘要」字段）\n\n【Day 1-4 日常回顾】\n请回顾聊天记录中 Day 1 至 Day 4 的日常互动内容。\n赵霞在结局中的表现应当体现出这些天积累的关系变化。\n${e?'\n\n【完美记忆路线】\n玩家在进入场景5之前，按顺序完成了场景1-2-3。\n赵霞拥有完整的记忆重构，她对玩家的感情不是被洗脑，而是"命中注定"。\n- 她记得16岁那个夏天的初恋\n- 她记得17岁在路口的等待\n- 她记得20岁生日想要逃跑的渴望\n- 她终于等到了那个人\n\n【AI特别指引】\n完美记忆路线的赵霞不是"被改造"的，而是"从一开始就在等待"的。\n她的选择是发自内心的，不是被催眠的。\n描写她时，要体现出"终于等到你"的感动，而不是"我被你改变了"的迷茫。':''}\n\n赵霞的记忆已被完全改写，她从灵魂深处认定儿子{{user}}是她的真正归属。\n\n【当前场景】\n从安眠药引发的梦境中醒来后的第一个小时。\n阳光透过窗户洒进来，赵霞找到{{user}}，眼神中有一种奇异的决意。\n苏文在书房工作，对接下来要发生的事毫不知情。\n\n【时间线（6阶段，约25轮）】\n- 11:00-14:00 阶段0：觉醒与计划（4轮）- 商量今晚的计划\n- 14:00-18:00 阶段1：准备工作（4轮）- 外出购物，准备道具\n- 18:00-22:00 阶段2：晚餐与下药（4轮）- 晚餐，给苏文下药\n- 22:00-02:00 阶段3：午夜告白（5轮）- 展示身体，揭露真相，深情表白\n- 02:00-06:00 阶段4：禁忌仪式（5轮）- 在婚床上结合，请求内射\n- 06:00-10:00 阶段5：黎明誓约（3轮）- 交付戒指，新生活开始\n\n【AI任务】\n1. 描写赵霞从梦境醒来后的状态\n2. 赵霞主动找到{{user}}\n3. 低声说出她的计划："今晚...我想把一切都给你。"\n4. 商量需要准备什么\n5. 与{{user}}有暧昧的肢体接触`,prefill:e?'阳光温柔地洒进卧室，赵霞缓缓睁开眼睛。\n\n那个梦...不，那些记忆，依然清晰如昨。\n\n十六岁那个夏天，她就知道了。\n那个人，一直都在。\n\n她轻手轻脚地起身，走出卧室。苏文还在书房里，对即将发生的一切毫不知情。\n\n她找到了{{user}}。\n\n"我全都想起来了。"赵霞轻声说，眼神中有一种奇异的光芒，"那些梦...不，那些记忆。"':'阳光透过窗帘洒进卧室，赵霞缓缓睁开眼睛。\n\n那个梦...那些被改写的记忆，如今已经成为她灵魂的一部分。\n\n她坐起身，嘴角不自觉地上扬。\n今晚，将会有一场特别的"庆祝"。\n\n她轻手轻脚地起身，走出卧室。苏文还在书房里，对即将发生的一切毫不知情。\n\n她找到了{{user}}。\n\n"我想起来了...所有的事。"赵霞轻声说，眼神中有一种奇异的光芒，"今晚...你愿意帮我吗？"'}}function Ee(n,e,t){const o=ie(n);if(!o)return null;switch(o){case'preheat':case'dinner':return $e(e,t);case'free':return function(n){return`【自由时间 - ${n}:00】\n\n现在是自由活动时间。${21===n?'剧情将在22:00继续推进':'午夜时分（00:00）将迎来最终时刻'}。\n\n【场景状态】\n- 晚餐已经结束\n- 苏文因为安眠药已经昏倒\n- 赵霞和{{user}}可以自由活动\n\n【AI任务】\n1. 不要强制推进主线剧情\n2. 回应玩家的自由互动\n3. 赵霞可以与{{user}}闲聊、调情、准备接下来的事\n4. 保持轻松但暗含期待的氛围\n5. 如果玩家主动推进剧情，可以顺势进入下一阶段\n\n【提示】\n玩家可以利用这段时间：\n- 与赵霞独处\n- 查看昏迷的苏文\n- 准备接下来的"仪式"\n- 或者单纯地享受这份特别的夜晚\n\n下一个时间点：${n+1}:00`}(n.世界.当前小时);case'correction':return function(n){const e=re[n.currentPhase],t=e?.name??'未知';return`【22:00 - 剧情恢复】\n\n自由时间结束，剧情继续推进。\n\n【当前进度】\n- 阶段：${n.currentPhase+1}/${re.length}（${t}）\n- 总轮数：${n.totalTurns}\n\n【AI任务】\n1. 如果剧情偏离了主线，温和地引导回来\n2. 赵霞可以主动提议"接下来的事"\n3. 推动剧情向午夜的最终时刻发展\n4. 保持紧张而期待的氛围\n\n【提示】\n午夜（00:00）即将到来。\n在那之前，赵霞还有一些事情想要完成...`}(e);case'room':{const o=function(n,e){return n.currentPhase>=3?'':`【午夜 00:00 - ${e?'完美真爱结局':'真好结局'}最终阶段】\n\n时钟敲响午夜。\n苏文已经在客房昏睡。\n一切准备就绪。\n\n赵霞拉起{{user}}的手："该去卧室了。"\n\n【强制推进】\n现在开始进入最终阶段：\n- 阶段3：午夜告白（展示身体，揭露真相，深情表白）\n- 阶段4：禁忌仪式（在婚床上结合，请求内射）\n- 阶段5：黎明誓约（交付戒指，新生活开始）\n\n【AI任务】\n1. 描写赵霞带{{user}}走向主卧室\n2. 确认苏文在客房昏睡\n3. 赵霞开始换上准备好的情趣内衣\n4. 推进到阶段3（午夜告白）\n\n【重要】\n从这里开始，剧情不可逆转。\n赵霞将展示真实的自己，揭露所有真相。`}(e,ae(n));return o||$e(e,t)}default:return null}}const Pe=[{phase:0,name:'预热',title:'异常的早晨',description:'11:00，赵霞从奇怪的梦中醒来，看向儿子的眼神不太对劲',minTurns:1,maxTurns:2,minHour:11,anchorEvents:['梦境残留','异常心跳'],aiGuidance:'【假好结局 - 阶段0：预热】\n\n今天是赵霞和苏文的结婚纪念日。\n赵霞从那些奇怪的梦中醒来，心跳得厉害。\n\n【时间】Day 5, 11:00（预热引导开始）\n\n【场景设定】\n- 刚从安眠药引发的梦境中醒来\n- 阳光透过窗户洒进来\n- 赵霞感到一阵莫名的心悸\n- 苏文在书房工作\n\n【赵霞状态】\n与真好结局不同，赵霞没有被"完全重构"。\n那些梦境中的记忆是模糊的、片段的...\n但足以让她看向儿子{{user}}时，心跳加速。\n她不明白为什么，但身体的反应骗不了人。\n她努力告诉自己这只是"做了奇怪的梦"，但眼神会不自觉地追随{{user}}。\n\n【AI任务】\n1. 描写赵霞醒来后的异常状态\n2. 她记得做了一些"奇怪的梦"，但内容模糊\n3. 看到{{user}}时莫名心跳加速\n4. 她努力表现正常，但有些心不在焉\n5. 提到今天是结婚纪念日\n\n【禁止】\n- 不要让赵霞主动表白\n- 保持她的矛盾和困惑',correctionHints:['赵霞揉了揉眼睛，那个梦...到底是什么？她看向{{user}}，心跳突然漏了一拍。','"今天是结婚纪念日呢..."赵霞喃喃自语，但脑海里浮现的不是苏文的脸。','赵霞在厨房准备早餐，{{user}}走进来时，她的手抖了一下。']},{phase:1,name:'午后',title:'若有似无',description:'14:00，赵霞开始不自觉地靠近{{user}}，暧昧的气氛在蔓延',minTurns:1,maxTurns:2,minHour:14,strict:!0,anchorEvents:['借故靠近','暧昧氛围'],aiGuidance:'【假好结局 - 阶段1：午后暧昧】\n\n午后的阳光透过窗户，赵霞越来越无法控制自己。\n\n【时间】Day 5, 14:00\n\n【场景设定】\n- 苏文还在书房忙工作\n- 赵霞借各种理由靠近{{user}}\n- 若有似无的肢体接触\n- 暧昧的气氛在蔓延\n\n【赵霞状态】\n她不知道自己在做什么...\n只是想靠近他，想看着他，想和他说话。\n每次"不小心"碰到他，心跳就加速。\n她告诉自己这只是"母子之间的亲近"，但她知道不是。\n\n【AI任务】\n1. 赵霞借故靠近{{user}}（拿东西、递水等）\n2. 若有似无的肢体接触\n3. 她的眼神会在{{user}}身上停留太久\n4. 赵霞内心的困惑："为什么...我会这样？"\n5. 暗示她在期待晚上苏文离开\n\n【禁止】\n- 不要越过明显的界限\n- 保持"擦边球"的暧昧感\n- 苏文还在家，要保持表面正常',correctionHints:['赵霞端着茶杯走过来："渴了吗？"她的手指碰到{{user}}的手时，停顿了一下。','"帮我拿一下那个..."赵霞踮脚去够架子上的东西，身体不自觉地靠向{{user}}。','赵霞坐在{{user}}旁边看电视，但她的注意力完全不在屏幕上。']},{phase:2,name:'期待',title:'傍晚的躁动',description:'17:00，赵霞得知苏文晚上要出去，内心开始躁动',minTurns:1,maxTurns:2,minHour:17,strict:!0,anchorEvents:['得知消息','内心躁动'],aiGuidance:'【假好结局 - 阶段2：傍晚期待】\n\n傍晚时分，苏文提到晚上要出去。\n赵霞的心跳加速了。\n\n【时间】Day 5, 17:00\n\n【场景设定】\n- 苏文提前说晚上有工作要处理\n- 赵霞表面平静，内心却在躁动\n- 她开始期待...又害怕自己的期待\n- 准备晚餐时心不在焉\n\n【赵霞状态】\n当苏文说晚上要出去时，她的第一反应是...期待。\n这让她感到恐惧——她在期待什么？\n她告诉自己只是想安静地休息，但脑海里浮现的是{{user}}的脸。\n"不对...我在想什么..."\n但她的身体已经开始微微发热。\n\n【AI任务】\n1. 苏文提到晚上要出去的消息\n2. 赵霞的内心波动（表面平静，内心躁动）\n3. 她开始准备晚餐，但心不在焉\n4. 偶尔看向{{user}}时的复杂眼神\n5. 她在期待什么？自己也说不清...\n\n【禁止】\n- 不要让赵霞表现得太明显\n- 保持内心戏和表面平静的反差',correctionHints:['苏文："今晚有个紧急会议，可能要很晚。"赵霞的手停了一下："哦...好。"','赵霞在厨房切菜，脑海里却在想着待会儿的事。她的脸有些发烫。','"晚餐快好了..."赵霞的声音有些不自然，她不敢看{{user}}的眼睛。']},{phase:3,name:'晚餐',title:'结婚纪念日',description:'20:00，结婚纪念日晚餐，苏文宣布要出差/加班',minTurns:1,maxTurns:2,minHour:20,strict:!0,anchorEvents:['纪念日提及','苏文宣布离开','暗中注视'],aiGuidance:'【假好结局 - 阶段1：晚餐】\n\n今天是赵霞和苏文的结婚纪念日。三人围坐在餐桌旁享用晚餐。\n但苏文宣布了一个消息：他临时有工作要处理，需要出去一趟。\n\n【时间】Day 5, 20:00\n\n【场景设定】\n- 餐桌布置简单但温馨\n- 苏文在场，但即将离开\n- 赵霞表现得很正常，但会不时偷看{{user}}\n- 她的眼神复杂：困惑、渴望、克制交织\n\n【赵霞状态】\n她整天都在想那些梦...梦里有一个熟悉的身影。\n看到儿子时，她会莫名心跳加速，但她把这归咎于"身体不舒服"。\n她努力维持正常，但眼神会不自觉地追随{{user}}。\n当苏文说要离开时，她的心跳加速了——是期待？还是恐惧？\n\n【AI任务】\n1. 描写表面和谐的家庭聚餐氛围\n2. 赵霞提到今天是结婚纪念日，但语气平淡\n3. 苏文宣布要临时出去处理工作（加班/出差）\n4. 描写赵霞偷偷看向{{user}}的细节\n5. 苏文毫无察觉，正常聊天后离开\n6. 赵霞内心的矛盾：为什么会有一种...期待？\n\n【关键剧情】\n苏文离开时说："我可能要很晚才回来，或者明天早上。你们先休息。"\n他还说会在路上打视频电话报平安。\n\n【禁止】\n- 不要让赵霞主动表白或暴露\n- 不要让苏文察觉异常',correctionHints:['赵霞低头吃饭，但筷子停了一下。她抬眼看了{{user}}一眼，又迅速移开。','"今天是结婚纪念日呢。"赵霞淡淡地说，目光却飘向了{{user}}。','苏文说要出去加班，赵霞应了一声，但她的手指无意识地绞着餐巾。']},{phase:4,name:'空隙',title:'独处时刻',description:'苏文离开后，赵霞和玩家独处，她开始试探接近',minTurns:1,maxTurns:3,anchorEvents:['苏文离开','单独相处','试探接近'],aiGuidance:'【假好结局 - 阶段2：独处时刻】\n\n苏文已经离开了。赵霞和{{user}}独处。\n空气中弥漫着一种微妙的紧张感。\n\n【场景设定】\n- 苏文已经离开\n- 客厅/餐厅，两人相对而坐\n- 气氛微妙，空气中弥漫着紧张感\n- 赵霞找了个借口留下来，假装在收拾\n\n【赵霞状态】\n终于...只剩下两个人了。\n她告诉自己只是想聊聊天，但心跳得厉害。\n她想起那些奇怪的梦，梦里的感觉太真实了...\n她忍不住想靠近{{user}}，但又害怕自己会做出什么。\n\n【AI任务】\n1. 描写苏文离开后的沉默\n2. 赵霞借故留下，假装在收拾餐桌\n3. 两人单独相处的尴尬和紧张\n4. 赵霞鼓起勇气开口："我最近...总是做奇怪的梦..."\n5. 她试探性地靠近{{user}}\n\n【禁止】\n- 不要让赵霞太主动（她还在挣扎）\n- 保持她的矛盾和犹豫',correctionHints:['赵霞在客厅磨蹭着，等苏文的车声消失后，她转向{{user}}。','"你爸走了..."赵霞低声说，站在离{{user}}不远的地方。','赵霞欲言又止，手指绞着围裙的一角。"我最近...睡不太好。"']},{phase:5,name:'开始',title:'越过禁线',description:'两人开始性行为，赵霞在矛盾中沦陷',minTurns:1,maxTurns:3,anchorEvents:['第一次触碰','越过界限','身体沦陷'],aiGuidance:'【假好结局 - 阶段3：禁忌开始】\n\n独处的气氛越来越暧昧，两人终于越过了那条线。\n性行为开始了。\n\n【场景设定】\n- 两人已经开始亲密接触\n- 赵霞的理智在崩塌\n- 她一边说着"不行"，一边却没有拒绝\n- 衣物开始凌乱\n\n【赵霞状态】\n她知道这是禁忌，但身体的记忆太强烈了。\n那些梦里的感觉...太真实了...\n当{{user}}靠近她时，她的身体自动迎合了上去。\n"我们不应该...你是我的儿子..."\n但她的手却抓着{{user}}不放。\n眼泪滑落，但身体却在索取。\n\n【AI任务】\n1. 描写两人开始亲密接触的过程\n2. 赵霞的矛盾：嘴上说不行，身体却很诚实\n3. 从接吻、抚摸逐渐升级\n4. 描写她的挣扎和沦陷\n5. 性行为正式开始\n\n【关键描写】\n- 第一个吻：赵霞愣住了，但没有推开\n- 她的身体在颤抖，但不是因为恐惧\n- "不行...我们不能..."但她的手却环上了{{user}}的脖子\n- 当界限被越过的那一刻，她咬住了嘴唇，压抑着声音\n\n【尺度提示】\n根据部位开发进度调整描写尺度。\n这是性行为的开始阶段，为阶段4的硬核场景做铺垫。',correctionHints:['赵霞的呼吸急促起来，她知道不应该，但身体却在靠近...','"不行..."她的声音很轻，但手却没有推开{{user}}。','当{{user}}的手触碰到她时，她颤抖了一下，眼眶泛红。'],expectedActions:['吻','亲','抱','摸','碰','脱','进','做'],hintThreshold:2,progressHint:'赵霞的呼吸越来越急促，她的眼神迷离，身体微微颤抖...她在等待你主动采取下一步行动。'},{phase:6,name:'视频通话',title:'镜头之外',description:'苏文打来视频电话，赵霞一边通话一边被{{user}}操，下半身在镜头外',minTurns:1,maxTurns:3,anchorEvents:['视频来电','上半身镜头','隐藏动作','表情管理'],aiGuidance:'【假好结局 - 阶段4：视频通话】\n\n正当两人做爱之际，苏文的视频电话打来了。\n赵霞没有挂断——她接了。\n而{{user}}也没有停下来。\n\n【场景设定】\n- 赵霞坐在沙发上/床边\n- 手机举在面前，只露上半身\n- {{user}}在镜头之外，正在操她\n- 苏文在视频那头，毫无察觉\n- 性行为正在进行中，没有停止\n\n【赵霞状态】\n这是疯狂的、禁忌的、刺激的...\n她一边和丈夫视频通话，一边被儿子操着。\n她努力控制自己的表情，假装一切正常。\n但{{user}}的抽插让她几乎无法自持。\n她咬着嘴唇，压抑着呻吟，努力回应丈夫的话。\n罪恶感和快感交织，让她几乎要崩溃。\n每一次顶弄都让她差点叫出声。\n\n【AI任务】\n1. 描写视频来电的铃声响起时，两人正在做爱\n2. 赵霞决定接听，调整姿势只露上半身，但没有让{{user}}停下\n3. 苏文在视频里正常聊天（报平安、问候等）\n4. {{user}}在镜头外继续操她，甚至加快节奏\n5. 赵霞努力控制表情，压抑呻吟，偶尔差点露馅\n6. 描写她压抑声音的细节（咬唇、捂嘴、声音颤抖等）\n7. 刺激感与罪恶感并存\n\n【关键描写】\n- 苏文："到家了，路上还顺利。纪念日快乐啊老婆。"\n- 赵霞努力保持微笑，声音有些颤抖："嗯...你也是...早点休息..."（此时{{user}}正在用力顶她）\n- 苏文："你脸怎么红红的？声音怎么有点奇怪？"\n- 赵霞："可能...开了暖气...有点热..."（她咬住嘴唇，差点呻吟出声）\n- {{user}}故意在通话时加快节奏，赵霞几乎无法维持表情\n\n【视频结束后】\n- 赵霞终于挂断电话\n- 她看着{{user}}，眼神复杂\n- "你知道刚才有多危险吗..."\n- 但她的身体却更加兴奋了\n\n【禁止】\n- 不要让苏文发现真相\n- 镜头只能拍到上半身\n- 性行为不能停止，必须贯穿整个通话',correctionHints:['手机铃声响起时，{{user}}正在她体内。赵霞看了一眼屏幕——是苏文。她咬了咬嘴唇，接听了，但没有让{{user}}停下。','赵霞努力控制表情，对着镜头微笑："嗯...到了就好..."但{{user}}的动作让她的声音在发抖。','"你脸怎么红红的？"苏文问。赵霞差点咬破嘴唇，因为{{user}}刚好顶到了深处："开...开了暖气..."'],expectedActions:['继续','不停','动','操','顶','插','快','用力'],hintThreshold:2,progressHint:'赵霞正在和苏文视频通话，但你还在她体内...她紧张地看了你一眼，但没有让你退出来。这是一个绝佳的机会，继续你的动作吧。'},{phase:7,name:'快感',title:'矛盾的亲密',description:'两人亲密，赵霞边享受边哭泣',minTurns:1,maxTurns:3,anchorEvents:['肢体接触','享受','流泪自责'],aiGuidance:'【假好结局 - 阶段5：罪恶快感】\n\n视频通话结束后，赵霞和{{user}}彻底跨越了那条线。\n\n【场景设定】\n- 隐蔽的空间（客厅/卧室）\n- 赵霞的衣衫凌乱\n- 她在享受，但眼泪止不住\n- 矛盾的表情：快感和罪恶感交织\n\n【赵霞状态】\n刚才的视频通话让她意识到自己有多疯狂...\n但她停不下来。\n她边流泪边索取，嘴里喃喃着"对不起"。\n"我是不是疯了...你是我的儿子..."\n但她的身体完全诚实，渴望着更多。\n\n【AI任务】\n1. 描写两人亲密的场景（根据部位开发进度调整尺度）\n2. 赵霞的矛盾：享受与罪恶感并存\n3. 她边享受边哭泣，边说"不行"边索取\n4. 描写她的自我厌恶："我怎么会这样..."\n5. 但她无法停下来\n\n【关键描写】\n- 她的泪水滑落，但身体却在迎合\n- 嘴里说着"不要"，手却抓得更紧\n- 高潮时叫出的不是"老公"，而是{{user}}的名字',correctionHints:['赵霞的眼泪滑落，但她没有推开{{user}}。','"我们不应该..."她哽咽着，但身体却在靠近。','赵霞捂住自己的嘴，压抑着声音，眼泪却止不住。'],expectedActions:['继续','不停','做','进入','亲','吻','抱','更多'],hintThreshold:2,progressHint:'赵霞的眼泪滑落，但她没有推开你。她的身体在微微颤抖，等待着你的下一步行动...她说"不要"，但身体却在靠近。'},{phase:8,name:'匿名照片',title:'危险的游戏',description:'事后，赵霞用匿名账号给苏文发照片，被询问时谎称AI生成',minTurns:1,maxTurns:3,anchorEvents:['匿名发送','苏文询问','谎言掩盖'],aiGuidance:'【假好结局 - 阶段6：匿名照片】\n\n事后，赵霞做了一件更疯狂的事。\n她用匿名账号，给苏文发了一张照片。\n\n【场景设定】\n- 两人刚刚结束亲密行为\n- 赵霞拿起手机，创建了一个匿名账号\n- 她发送了一张"只露上半身"的照片给苏文\n- 苏文收到后打电话来询问\n\n【赵霞心理】\n她不知道自己为什么要这样做...\n也许是想要"分享"这份刺激？\n也许是想要试探苏文的反应？\n也许只是单纯的...疯狂。\n发完之后她有些后悔，但已经来不及了。\n\n【AI任务】\n1. 描写赵霞事后的状态（凌乱但满足）\n2. 她突然有了一个"疯狂的想法"\n3. 用匿名账号发送照片给苏文（不露脸但能看出身材）\n4. 苏文收到后打电话来询问："老婆，你看到这个了吗？有人给我发了奇怪的照片..."\n5. 赵霞假装惊讶，谎称："什么照片？让我看看...这肯定是AI生成的恶作剧，现在这种技术很常见。"\n6. 苏文信以为真\n\n【关键对话】\n苏文："有个陌生账号给我发了张照片...身材有点像你？"\n赵霞（努力镇定）："什么？让我看看...哎呀，这肯定是AI生成的，现在这种技术太厉害了，什么人都能造。别理他，可能是骗子。"\n苏文："也是...那我删了。你们在家好好休息，明天见。"\n\n【赵霞事后心态】\n- 侥幸：还好他信了\n- 刺激：差点被发现的感觉太刺激了\n- 恐惧：如果被发现怎么办\n- 但更多的是...扭曲的满足感',correctionHints:['赵霞拿起手机，眼神闪烁。她也不知道自己在想什么...','"什么照片？"赵霞努力让自己的声音听起来正常，"肯定是AI生成的..."','苏文信了。赵霞挂断电话，心跳得厉害——是害怕，还是刺激？'],expectedActions:['看','照片','发','手机','同意','好','可以'],hintThreshold:2,progressHint:'赵霞拿着手机，眼神闪烁。她似乎有一个疯狂的想法...她在等待你的反应，是否要配合她这场危险的游戏。'},{phase:9,name:'矛盾',title:'这是最后一次',description:'赵霞整理仪容，声称不会再犯，但双方都知道这是谎言',minTurns:1,maxTurns:3,anchorEvents:['整理仪容','假装正常','下次暗示'],aiGuidance:'【假好结局 - 阶段7：事后的矛盾】\n\n一切结束，赵霞在整理自己。\n\n【场景设定】\n- 赵霞在镜子前整理仪容\n- 她的表情复杂：满足、羞耻、矛盾\n- 刚才发照片的事让她心跳未平\n- 她努力让自己看起来"正常"\n\n【赵霞状态】\n刚才发生的一切太疯狂了...\n视频通话时的刺激，匿名照片的冒险...\n她看着镜中的自己，认不出那个人是谁。\n"这是最后一次"，她这样告诉自己。\n但她知道，下次{{user}}靠近她，她还是会沦陷。\n\n【AI任务】\n1. 赵霞整理衣服、头发\n2. 她回想刚才的疯狂（视频通话、匿名照片）\n3. 她说："这是最后一次...我们不能再这样了。"\n4. 但语气里没有坚定\n5. 临走前，她看了{{user}}一眼，那眼神...\n\n【结局暗示】\n这不会是最后一次。\n赵霞知道，{{user}}也知道。\n这段充满罪恶感和刺激感的秘密关系，才刚刚开始...',correctionHints:['赵霞背对着{{user}}整理头发，肩膀微微颤抖。','"我们...以后不能再..."她的话说到一半就停住了。','赵霞看了一眼手机——刚才发给苏文的照片已经被"删除"了。但截图呢？']}],ve={梦境残留:['梦','做梦','奇怪的梦','梦见','梦到','梦里'],异常心跳:['心跳','心悸','脸红','紧张','奇怪的感觉'],借故靠近:['借故','找借口','故意','凑近','靠过来','挨着','坐近'],暧昧氛围:['暧昧','微妙','若有若无','心跳加速','不自觉','触电'],得知消息:['加班','出差','要出去','晚上不在','有事','工作'],内心躁动:['躁动','期待','激动','紧张','心跳','不安','雀跃'],纪念日提及:['结婚纪念','纪念日','周年',/结婚.*年/],苏文宣布离开:['加班','出差','工作','要走','离开','出去'],暗中注视:['偷看','偷偷','注视','目光',/看.*一眼/,'眼神'],苏文离开:['走了','离开','出门','车声'],单独相处:['单独','独处','就我们','只有.*两','两人'],试探接近:['靠近','走近','接近','凑近'],第一次触碰:['吻','亲','抱','摸','触碰','贴近','嘴唇'],越过界限:['进入','插','脱','解开','衣服','越过','界限','禁线'],身体沦陷:['沦陷','迎合','索取','颤抖','呻吟','喘息','不行','但是'],视频来电:['视频','来电','铃声','手机响','打来'],上半身镜头:['镜头','上半身','只露','举着手机'],隐藏动作:['镜头外','下半身','看不到','隐藏'],表情管理:['控制表情','假装','努力','压抑','咬唇','捂嘴'],肢体接触:['触碰','抱','吻','亲','贴','紧紧'],享受:['舒服','感觉','呻吟','喘息','颤抖','沉溺'],流泪自责:['泪','哭','流泪','眼泪','对不起','错了','疯了'],匿名发送:['匿名','照片','发送','陌生账号','发给'],苏文询问:['打电话','询问','问','像你','身材'],谎言掩盖:['AI生成','恶作剧','骗子','假的','技术'],整理仪容:['整理','理理','头发','衣服','镜子'],假装正常:['正常','若无其事','平静','切换','伪装'],下次暗示:['最后一次','不会再','下次','以后',/看.*一眼/]};function ye(n){return!0===n.假好结局状态?.isActive}function Ie(n){return n.假好结局状态??{isActive:!1,isComplete:!1,currentPhase:0,turnsInPhase:0,totalTurns:0,completedAnchors:[],noProgressTurns:0,hintGiven:!1}}function Ae(n,e){n.假好结局状态=e}function Te(n,e){const t=n.currentPhase+1;if(t>=Pe.length)return{blocked:!1};const o=Pe[t];if(!o)return{blocked:!1};if(void 0!==o.minHour&&o.strict&&e<o.minHour){const n=o.minHour-e;return{blocked:!0,reason:`【${o.name}】阶段需要在 ${o.minHour}:00 后才能开始`,waitHours:n}}return{blocked:!1}}function _e(n,e){const t=Pe[e];if(!t||!t.expectedActions)return!0;const o=n.toLowerCase();return t.expectedActions.some(n=>o.includes(n.toLowerCase()))}function Me(n,e){const t=Pe[n.currentPhase];if(!t||!t.progressHint)return null;if(n.hintGiven)return null;if(_e(e,n.currentPhase))return null;const o=t.hintThreshold??2;return n.noProgressTurns>=o?t.progressHint:null}function De(n,e,t,o){let s={...n,turnsInPhase:n.turnsInPhase+1,totalTurns:n.totalTurns+1};const r=function(n,e){if(e>=Pe.length)return[];const t=Pe[e],o=[];for(const e of t.anchorEvents){const t=ve[e];if(t)for(const s of t)if('string'==typeof s){if(n.includes(s)){o.push(e);break}}else if(s.test(n)){o.push(e);break}}return[...new Set(o)]}(e,n.currentPhase),i=[...new Set([...s.completedAnchors,...r])];if(s.completedAnchors=i,t){const{updatedState:n}=function(n,e){const t=_e(e,n.currentPhase),o=Me(n,e);let s={...n};return s.noProgressTurns=t?0:n.noProgressTurns+1,o&&(s.hintGiven=!0),{updatedState:s,hint:o}}(s,t);s=n}let a=!1,c=null;if(function(n,e){if(n.currentPhase>=Pe.length)return!1;const t=Pe[n.currentPhase];if(void 0!==e&&Te(n,e).blocked)return!1;return t.maxTurns&&n.turnsInPhase>=t.maxTurns?(console.info(`[假好结局] 阶段${n.currentPhase}(${t.name}) 达到最大轮数${t.maxTurns}，强制推进`),!0):!(n.turnsInPhase<t.minTurns)&&t.anchorEvents.every(e=>n.completedAnchors.includes(e))}(s,o)){if(void 0!==o){const n=Te(s,o);if(n.blocked)return{newState:s,phaseAdvanced:!1,newPhase:null,timeBlocked:{reason:n.reason||'时间未到',waitHours:n.waitHours||1}}}s=function(n){const e=n.currentPhase+1;return e>=Pe.length?{...n,currentPhase:e,turnsInPhase:0,completedAnchors:[],isComplete:!0,noProgressTurns:0,hintGiven:!1}:{...n,currentPhase:e,turnsInPhase:0,completedAnchors:[],noProgressTurns:0,hintGiven:!1}}(s),a=!0,c=s.currentPhase}return{newState:s,phaseAdvanced:a,newPhase:c}}function Se(n,e,t){if(n.currentPhase>=Pe.length)return be();const o=Pe[n.currentPhase];let s=o.aiGuidance;const r=t??12,i=Te(n,r).blocked;let a;if(i)a=`自由探索中（等待${Pe[n.currentPhase+1]?.minHour}:00）`;else{const e=o.maxTurns-n.turnsInPhase;a=e<=2?`⚠️ 剩余${e}轮后将自动推进到下一阶段`:`剩余约${e}轮`}let c='';if(!i){const e=o.maxTurns-n.turnsInPhase;e<=1?c='\n\n【⚠️ 紧迫性提示】本阶段即将结束（剩余1轮），请确保在本轮推进关键剧情！':e<=2&&(c=`\n\n【提示】本阶段剩余 ${e} 轮，请适时推进剧情。`)}const u=i?`\n⏰ 时间锁定：下一阶段"${Pe[n.currentPhase+1]?.name}"需要等到${Pe[n.currentPhase+1]?.minHour}:00（当前${r}:00）\n📝 在此之前，请与玩家自由互动，享受这段时光。不要急于推进剧情。`:'';s+=`\n\n【当前进度】\n- 阶段：${n.currentPhase+1}/${Pe.length} - ${o.title}\n- 本阶段轮数：${n.turnsInPhase}（${a}）\n- 已完成锚点：[${n.completedAnchors.join(', ')}]\n- 待完成锚点：[${o.anchorEvents.filter(e=>!n.completedAnchors.includes(e)).join(', ')}]${u}${c}`;const l=Me(n,e);if(l)s+=`\n\n【玩家引导】\n玩家似乎不确定该做什么。请通过赵霞的反应温和地引导：\n${l}`;else if(e&&!function(n,e){const t=Pe[e];if(!t)return!0;const o=t.anchorEvents.flatMap(n=>{const e=ve[n];return e?e.filter(n=>'string'==typeof n):[]});return o.some(e=>n.includes(e))}(e,n.currentPhase)){const e=function(n){if(n>=Pe.length)return null;const e=Pe[n].correctionHints;return e&&0!==e.length?e[Math.floor(Math.random()*e.length)]:null}(n.currentPhase);e&&(s+=`\n\n【方向修正】\n玩家的输入可能偏离了主线。请通过赵霞的反应温和地引导回正轨：\n${e}`)}return s}function be(){return'【假好结局完成 - 秘密关系】\n\n从这一天起，赵霞和{{user}}之间有了一个不能说的秘密。\n\n她依然是苏文的妻子，依然在他面前扮演贤惠的角色。\n但每当丈夫不在的时候，她就会忍不住寻找{{user}}。\n\n"这是最后一次了。"\n她每次都这样说，但每次都食言。\n\n有时候，她会在苏文面前偷偷看{{user}}。\n有时候，她会在和苏文视频通话时，让{{user}}在镜头外做一些事情。\n有时候，她甚至会用匿名账号给苏文发一些"暗示"，然后假装不知情。\n\n她恨自己的软弱，恨自己的堕落。\n但那些梦境中的记忆太过真实，身体的渴望太过强烈。\n她无法抗拒{{user}}，就像无法抗拒命运。\n\n这不是一个完美的结局。\n赵霞活在矛盾和罪恶感中，在两个男人之间挣扎。\n但至少...她得到了梦中一直追寻的那个人。\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n🔓 后日谈模式已解锁\n\n这段充满罪恶感和刺激感的秘密关系，将继续下去...\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━'}const we=[{phase:0,name:'序幕',title:'命中注定的早晨',description:'11:00，从梦境醒来后，赵霞的眼中有了不一样的光芒——她终于等到了那个人',minTurns:1,maxTurns:2,minHour:11,anchorEvents:['记忆觉醒','心意已决'],aiGuidance:'【完美真爱结局 - 阶段0：序幕】\n\n今天是赵霞和苏文的结婚纪念日。\n但对赵霞来说，这是一个终于可以坦白一切的日子。\n\n【时间】Day 5, 11:00（从场景5梦境醒来后1小时）\n\n【完美记忆路线】\n赵霞拥有完整的记忆重构：\n- 16岁那个夏天的初恋\n- 17岁在路口的等待\n- 20岁生日想要逃离的渴望\n- 结婚那天心中真正的人\n\n这些不是被篡改的记忆，而是被唤醒的真相——\n她一直在等待的人，终于出现了。\n\n【场景设定】\n- 刚从梦境中醒来不久\n- 阳光透过窗户洒进来\n- 赵霞的眼中有泪光，但那是幸福的泪\n- 她终于明白了自己心中真正的感情\n\n【赵霞状态】\n不是被洗脑，不是被改造。\n而是终于想起了一直被压抑的真实感情。\n看向{{user}}的眼神充满了"终于等到你"的感动。\n\n【AI任务】\n1. 描写赵霞从梦境醒来后的状态——不是迷茫，而是清醒\n2. 她看向{{user}}时，眼中有压抑多年的感情流露\n3. 赵霞轻声说："我想起来了...一切都想起来了。"\n4. 暗示她今天要做出一个重要的决定\n5. 她需要先和苏文谈一谈\n\n【重要】\n这不是堕落，而是真爱。\n赵霞的选择是发自内心的，不是被催眠的。\n\n【禁止】\n- 不要描写赵霞被改造的痕迹（无淫纹、无乳环）\n- 不要让赵霞表现出迷茫或被控制感\n- 保持"命中注定"的浪漫基调',correctionHints:['赵霞看着{{user}}，眼中有泪光闪烁："我...想起来了。十六岁那年夏天...是你。"','赵霞深吸一口气："今天，我要和苏文好好谈谈。有些事...不能再藏着了。"','"这么多年..."赵霞轻声说，"我一直在等一个人。现在我终于知道，那个人是谁了。"']},{phase:1,name:'长谈',title:'与苏文的坦白',description:'14:00，赵霞决定和苏文坦诚一切，这是她欠他的诚实',minTurns:1,maxTurns:2,minHour:14,strict:!0,anchorEvents:['开始谈话','坦白感情','苏文反应'],aiGuidance:'【完美真爱结局 - 阶段1：长谈】\n\n赵霞决定在结婚纪念日这天，和苏文坦白一切。\n\n【场景设定】\n- 赵霞请{{user}}暂时回避\n- 她和苏文单独在书房/客厅长谈\n- 这是一场漫长而艰难的对话\n- {{user}}可以从门外/楼上听到一些\n\n【长谈内容】\n赵霞会告诉苏文：\n- 她心里一直有一个人\n- 那些梦让她终于明白了自己的感情\n- 她对苏文的感情...从来不是爱情\n- 她很抱歉，但她不想再欺骗自己\n\n【苏文的反应】\n苏文会经历：\n- 震惊 → 愤怒 → 痛苦 → 沉默 → 某种释然\n- "我早就感觉到了...只是不想承认。"\n- 他问："是谁？"\n- 赵霞没有直接回答，但苏文已经猜到了\n\n【AI任务】\n1. 描写赵霞请{{user}}暂时回避的场景\n2. 暗示书房里的长谈（可以是{{user}}视角听到的片段）\n3. 时间流逝（这场谈话持续了很久）\n4. 苏文的沉默...然后是某种决定\n5. 赵霞从书房出来，眼眶红红的但表情坚定\n\n【⚠️ 严禁 - 以下内容绝对不能出现】\n- ❌ 离婚、协议离婚、分居协议等法律程序\n- ❌ 财产分割、房子归属等讨论\n- ❌ 苏文搬出去住、离开这个家\n- ❌ 摘下婚戒、退还婚戒\n- ❌ 任何关于"结束婚姻"的表述\n\n【✓ 正确方向】\n- 这不是离婚，而是"重新定义关系"\n- 苏文选择留在这个家，但改变自己的角色\n- 法律上仍是夫妻，但实际上苏文退居幕后\n- 苏文的"成全"是让赵霞和{{user}}在这个家里成为"真正的一对"\n\n【禁止】\n- 不要让苏文变成绿帽癖（这个版本的苏文是悲情的成全者）\n- 不要详细描写苏文的崩溃\n- 保持对苏文的尊重和同情',correctionHints:['赵霞看向{{user}}："给我一点时间...我需要和苏文谈谈。"她的语气很坚定。','书房的门关上了。隐约能听到低沉的对话声...还有什么东西摔碎的声音。','很久之后，门开了。赵霞出来，眼眶有些红，但她的眼神前所未有的清澈。']},{phase:2,name:'决定',title:'苏文的成全',description:'16:00，苏文做出了一个艰难的决定——成全他们',minTurns:1,maxTurns:2,minHour:16,strict:!0,anchorEvents:['苏文决定','成全宣言'],aiGuidance:'【完美真爱结局 - 阶段2：决定】\n\n苏文做出了他的决定。\n\n【场景设定】\n- 长谈结束后\n- 苏文从书房出来，表情复杂但平静\n- 他主动找到{{user}}\n\n【苏文的话】\n苏文会对{{user}}说：\n- "我知道了...是你，对吧。"\n- "说实话，我不是没有察觉。"\n- "这些年...她的心从来不在我身上。"\n- "我试过让她爱上我，但有些事...勉强不来。"\n\n然后，苏文会说出他的决定：\n- "我不会阻止你们。"\n- "今晚...是我们的结婚纪念日。"\n- "我想给她一个...真正的婚礼。"\n- "不是和我的，是和她真正爱的人的。"\n\n【⚠️ 严禁 - 以下内容绝对不能出现】\n- ❌ 离婚、协议离婚、分居协议\n- ❌ 苏文搬出去住、离开这个家\n- ❌ 财产分割、房子归谁\n- ❌ 摘下婚戒、退还婚戒（婚戒会在阶段10仪式中处理）\n- ❌ 任何法律程序或文件\n\n【✓ 成全的正确含义】\n苏文的"成全"具体是指：\n1. 他会**留在这个家**，但搬到客房/书房住\n2. 他会继续**经济支持**这个家庭\n3. 他会为赵霞和{{user}}**举办一场私人婚礼仪式**\n4. 从今以后，赵霞和{{user}}才是这个家"真正的夫妻"\n5. 法律上的婚姻关系不变，但实际角色重新定义\n\n这是一种"家庭内部的关系重构"，不是离婚。\n\n【AI任务】\n1. 描写苏文平静但悲伤的表情\n2. 苏文对{{user}}说出那些话\n3. 宣布他的决定——为她举办一场婚礼仪式\n4. 苏文说："今晚八点，主卧室。我会准备好一切。"\n5. 他转身离开时的背影\n\n【重要】\n苏文是一个悲情的角色，但他选择了成全。\n不是懦弱，而是因为他真的爱赵霞。\n"如果让她幸福的不是我...那我至少可以目送她走向幸福。"',correctionHints:['苏文的声音很平静："我知道了。是你，对吧？"他的眼神很复杂。','"我没办法让她爱上我。"苏文苦笑，"十年了...我早就知道。"','"今晚八点。"苏文站起身，"我会给你们...一场婚礼。"']},{phase:3,name:'准备',title:'婚礼的筹备',description:'苏文默默准备着一切，赵霞和{{user}}在等待中度过漫长的下午',minTurns:1,maxTurns:2,anchorEvents:['等待时光','婚礼准备'],aiGuidance:'【完美真爱结局 - 阶段3：准备】\n\n漫长的下午，等待着那个时刻的到来。\n\n【场景设定】\n- 苏文在主卧室忙碌着，不让任何人进去\n- 赵霞换了一身素净的衣服，坐在客厅等待\n- {{user}}陪在她身边\n- 偶尔能听到楼上传来布置的声音\n\n【赵霞的状态】\n- 她有些紧张，但眼中充满期待\n- 她会和{{user}}轻声说话\n- 回忆那些梦中的场景——现在她知道那不是梦\n- "十六岁那年...我就在等你了。"\n\n【时间流逝】\n- 下午的阳光慢慢西斜\n- 赵霞靠在{{user}}肩头\n- 偶尔听到苏文下楼拿东西\n- 他们不需要说太多话，只是静静地待在一起\n\n【AI任务】\n1. 描写等待的氛围——紧张又温馨\n2. 赵霞偶尔说起那些记忆\n3. 苏文的身影在楼上忙碌\n4. 窗外的阳光渐渐变成暮色\n5. 终于，苏文下楼了："准备好了。"\n\n【禁止】\n- 这个阶段不要有亲密接触\n- 保持婚礼前的神圣感',correctionHints:['赵霞靠在{{user}}肩头，轻声说："你知道吗...十六岁那年，我就梦到过这一天。"','楼上传来细微的响动，苏文在忙碌着什么。赵霞安静地等待，脸上带着淡淡的红晕。','暮色渐沉。苏文从楼梯上走下来："时间到了。"']},{phase:4,name:'蒙眼',title:'蒙眼带入',description:'苏文蒙住玩家的眼睛，带他走向准备好的房间',minTurns:1,maxTurns:2,minHour:20,strict:!0,anchorEvents:['蒙眼','带入房间'],aiGuidance:'【完美真爱结局 - 阶段4：蒙眼带入】\n\n婚礼仪式正式开始。\n\n【场景设定】\n- 时间：20:00\n- 苏文拿着一条丝绸带走向{{user}}\n- 他的表情平静，甚至带着一丝微笑\n- "让我蒙住你的眼睛。"\n\n【仪式开始】\n苏文会说：\n- "这是赵霞的愿望。"\n- "她想给你一个惊喜。"\n- "跟我来。"\n\n然后：\n- 柔软的丝绸蒙住{{user}}的眼睛\n- 苏文牵着{{user}}的手\n- 一步步走上楼梯\n- 门打开的瞬间，能闻到花香和蜡烛的气息\n\n【AI任务】\n1. 描写苏文拿出丝绸带的动作\n2. 他蒙住{{user}}的眼睛\n3. 牵着{{user}}的手上楼\n4. 描写{{user}}被蒙着眼睛时的感受\n5. 门打开，花香和烛光的气息扑面而来\n\n【重要】\n苏文的动作是温柔的，没有敌意。\n他是一个正在完成承诺的人。',correctionHints:['苏文手中是一条白色的丝绸带："让我蒙住你的眼睛。这是她的愿望。"','视野陷入黑暗，但能感受到苏文的手牵着你。楼梯，一步一步向上。','门开了。花香、蜡烛、还有某种神圣的气息...充满了整个空间。']},{phase:5,name:'揭幕',title:'揭开眼罩',description:'眼罩被取下，眼前是一个小型的婚礼现场',minTurns:1,maxTurns:2,anchorEvents:['揭开眼罩','看到场景'],aiGuidance:'【完美真爱结局 - 阶段5：揭开眼罩】\n\n看到准备好的一切。\n\n【场景设定】\n- 苏文的声音："可以了。"\n- 丝绸带被轻轻取下\n- 眼前的景象让人屏住呼吸\n\n【婚礼场景】\n主卧室被布置成了一个温馨的婚礼现场：\n- 白色的纱幔从天花板垂落\n- 鲜花装点着每一个角落（百合、玫瑰）\n- 蜡烛在角落里摇曳，投下温暖的光影\n- 红毯从门口铺向床边\n- 房间四角有摄像机，红灯闪烁——记录这一刻\n\n【AI任务】\n1. 描写眼罩被取下的瞬间\n2. {{user}}看到的婚礼布置\n3. 详细描写：纱幔、鲜花、蜡烛、红毯\n4. 注意到四角的摄像机\n5. 这一切都是苏文一个人准备的\n\n【重要】\n场景要温馨、神圣、充满仪式感。\n不是色情的布置，而是真正的婚礼。',correctionHints:['"可以了。"丝绸带滑落，眼前的景象让人一瞬间忘记了呼吸。','白色的纱幔，烛光摇曳，鲜花的芬芳...这是一个真正的婚礼现场。','房间四角架着摄像机，红灯闪烁。这一切，都会被记录下来。']},{phase:6,name:'新娘',title:'看到赵霞',description:'赵霞穿着纯白的婚纱，站在房间中央',minTurns:1,maxTurns:2,anchorEvents:['看到新娘','婚纱描写'],aiGuidance:'【完美真爱结局 - 阶段6：看到新娘】\n\n她站在那里，等待着。\n\n【场景设定】\n房间中央，站着赵霞。\n\n【赵霞的装扮】\n- 一件纯白的婚纱\n- 不是低俗的情趣装，而是真正优雅的婚纱\n- 蕾丝勾勒出她的身体曲线，若隐若现却不失优雅\n- 没有纹身，没有穿环，没有任何淫秽的装饰\n- 头纱轻轻遮住她的脸\n- 手中捧着一束白色百合\n\n【赵霞的状态】\n- 她的眼中含着泪光，但那是幸福的泪\n- 嘴角是止不住的笑意\n- "你来了。"\n- "我等了你...很久很久。"\n\n【AI任务】\n1. 描写赵霞穿着婚纱的样子\n2. 强调纯洁、优雅、美丽\n3. 她眼中的泪光和笑容\n4. 她说的话——"你来了。"\n5. 这一刻的神圣感\n\n【禁止】\n- 不要描写任何色情元素\n- 不要提及纹身、乳环等改造痕迹\n- 保持婚礼的神圣氛围',correctionHints:['房间中央，赵霞穿着纯白的婚纱，手捧百合，等待着。','她的眼中含着泪光，但嘴角是止不住的笑意。"你来了。"','婚纱的裙摆铺散在地上，像一朵盛开的白色花朵。她美得让人移不开眼。']},{phase:7,name:'司仪',title:'苏文的宣言',description:'苏文作为司仪，宣布仪式开始，并说出他的决定',minTurns:1,maxTurns:2,anchorEvents:['仪式开始','苏文讲述','苏文成全承诺'],aiGuidance:'【完美真爱结局 - 阶段7：苏文的宣言】\n\n苏文站在你们中间，作为这场婚礼的司仪。\n\n【场景设定】\n- 苏文穿着正式的西装\n- 他站在赵霞和{{user}}中间\n- 表情复杂，但语气平静\n\n【苏文的话】\n他会说：\n- "今天，在这个特殊的日子里..."\n- "我们聚集在这里，见证一段新的关系的开始。"\n- "在正式开始之前，请允许我说几句话。"\n\n然后，苏文讲述：\n- "昨晚...赵霞和我谈了一整夜。"\n- "她告诉了我一切。"\n- "关于她的感受...关于她的选择。"\n- "说实话，一开始我很愤怒。"\n- "但是...看着她的眼神，我明白了。"\n- "她爱的人是你。不是我。也许从来都不是我。"\n- "我没有办法强迫一个人爱我。"\n\n最后，他宣布：\n- "所以——我决定成全你们。"\n- "从今以后，你们才是这个家真正的夫妻。"\n- "我会搬到原来的房间去住。"\n- "经济上，我会继续支持这个家...包括你们将来的孩子。"\n- "这是我能做的。希望你能让她幸福。"\n\n【AI任务】\n1. 描写苏文作为司仪的样子\n2. 他的开场白\n3. 讲述昨晚的长谈\n4. 承认赵霞爱的不是他\n5. 宣布他的成全和承诺\n\n【重要】\n苏文是这个故事中的悲情英雄。\n他的成全让这个结局有了救赎的意味。',correctionHints:['苏文清了清嗓子："今天，在这个特殊的日子...我们见证一段新关系的开始。"','"她爱的人是你，不是我。"苏文的声音很平静，"也许...从来都不是我。"','"我决定成全你们。"苏文说，"希望你能让她幸福。"']},{phase:8,name:'告白',title:'赵霞的誓言',description:'赵霞走向玩家，说出她压抑多年的心声',minTurns:1,maxTurns:2,anchorEvents:['走向玩家','回忆往事','告白誓言'],aiGuidance:'【完美真爱结局 - 阶段8：赵霞的誓言】\n\n赵霞开始向{{user}}走来。\n\n【场景设定】\n- 婚纱的裙摆在地上拖出一道白色的痕迹\n- 每一步，她的眼睛都没有离开{{user}}\n- 泪水从她的眼角滑落，但她在笑\n\n【赵霞的话】\n她会说：\n- "我等这一天...等了很久。"\n- "在梦里，在记忆里...你一直都在。"\n- "十六岁那个夏天的初吻..."\n- "十七岁那个路口的等待..."\n- "二十岁那个想要逃跑的夜晚..."\n- "二十五岁那场本不该属于他的婚礼..."\n- "每一次，我心里想的都是你。"\n\n然后，她在{{user}}面前停下，伸手捧住他的脸：\n- "现在，我终于可以光明正大地说——"\n- "我爱你。"\n- "从今以后，我只属于你。"\n\n【AI任务】\n1. 描写赵霞向{{user}}走来\n2. 她回忆那些场景——但这次不是梦，是真实的感情\n3. 每一段记忆都是一次告白\n4. 她停在{{user}}面前\n5. 说出那句"我爱你"\n\n【重要】\n这是发自内心的告白，不是被改造后的服从。\n她的眼神清澈，她的选择是清醒的。',correctionHints:['赵霞向{{user}}走来，婚纱在地上拖出一道白色的痕迹。她的眼中有泪，但那是幸福的泪。','"十六岁那个夏天...十七岁那个路口..."她的声音在颤抖，"每一次，我心里想的都是你。"','她捧住{{user}}的脸："我爱你。从今以后，我只属于你。"']},{phase:9,name:'誓言',title:'玩家的誓言',description:'玩家向赵霞说出自己的誓言',minTurns:1,maxTurns:2,anchorEvents:['玩家誓言','回应告白'],aiGuidance:'【完美真爱结局 - 阶段9：玩家的誓言】\n\n轮到{{user}}说出誓言了。\n\n【场景设定】\n- 苏文在一旁轻声提示："现在，请新郎...向新娘说出你的誓言。"\n- 赵霞期待地看着{{user}}\n- 摄像机的红灯闪烁着，记录着这一刻\n\n【这是玩家的时刻】\n{{user}}可以自由表达：\n- 对赵霞的爱\n- 对这段感情的承诺\n- 对未来的期待\n- 任何想说的话\n\n【AI引导】\n无论玩家说什么：\n- 赵霞会认真倾听\n- 她的眼中满是感动\n- 最后她会说："我愿意。"\n\n【AI任务】\n1. 苏文提示该{{user}}说誓言了\n2. 描写赵霞期待的眼神\n3. 等待玩家输入\n4. 根据玩家的话，描写赵霞的反应\n5. 她的回应——感动、幸福、"我愿意"\n\n【重要】\n这是玩家的高光时刻，让他自由发挥。',correctionHints:['苏文轻声说："现在，请新郎...向新娘说出你的誓言。"','赵霞期待地看着{{user}}，等待着。摄像机的红灯闪烁，记录着这一刻。','她的眼中满是感动。无论{{user}}说什么，她都会认真倾听。'],expectedActions:['爱','喜欢','永远','一辈子','誓言','承诺','愿意','属于','在一起'],hintThreshold:2,progressHint:'赵霞期待地看着你，等待着你的誓言。苏文轻声提醒："新郎，请向新娘说出你的心意...比如你对她的爱，你的承诺。"'},{phase:10,name:'戒指',title:'交换戒指',description:'赵霞摘下原来的戒指，换上属于他们的新戒指',minTurns:1,maxTurns:2,anchorEvents:['摘下旧戒指','戴上新戒指'],aiGuidance:'【完美真爱结局 - 阶段10：交换戒指】\n\n最神圣的时刻。\n\n【场景设定】\n- 赵霞从婚纱的口袋里取出一个小盒子\n- 里面是两枚银色的戒指——她重新买的\n- 只属于他们的戒指\n\n【仪式】\n赵霞会：\n1. 先摘下自己的结婚戒指（和苏文的）\n2. 将它递给苏文（苏文接过，沉默）\n3. 然后打开新的戒指盒\n4. 将一枚戒指戴在{{user}}的手指上\n5. 另一枚戴在自己的手指上\n\n她会说：\n- "这是我重新买的...只属于我们的戒指。"\n- "愿意接受我吗？"\n- "作为你的...妻子。"\n\n【重要说明】\n摘戒指只能在这个阶段（阶段10）发生！\n- 之前的阶段中，赵霞一直戴着和苏文的婚戒\n- 在婚礼仪式中当着苏文的面交接，才有仪式感\n- 这是"旧关系的正式交接"，不是离婚\n\n【AI任务】\n1. 描写赵霞拿出戒指盒\n2. 她摘下旧戒指的动作——有一丝犹豫，但很快坚定\n3. 将旧戒指递给苏文\n4. 苏文接过戒指的表情\n5. 为{{user}}戴上新戒指\n6. 她的话和期待的眼神\n\n【重要】\n这一幕既有对过去的告别，也有对未来的期待。\n苏文接过戒指时的表情要有分量。',correctionHints:['赵霞从口袋里取出一个小盒子。打开——里面是两枚银色的戒指。','她缓缓摘下手上的结婚戒指，将它递给苏文。苏文接过，沉默不语。','"这是只属于我们的戒指。"她将戒指套在{{user}}的手指上，"愿意接受我吗？"'],expectedActions:['戴','戒指','套','接受','愿意','手指','伸手'],hintThreshold:2,progressHint:'赵霞举起戒指盒，里面是一枚银色的戒指。她轻声问："愿意让我为你戴上吗？"她的眼神充满期待，等待你伸出手...'},{phase:11,name:'完成',title:'新人之吻',description:'苏文宣布仪式完成，新人接吻，真爱结局达成',minTurns:1,maxTurns:2,anchorEvents:['宣布完成','新人之吻','结局达成'],aiGuidance:'【完美真爱结局 - 阶段11：新人之吻（最终阶段）】\n\n仪式的最后一步。\n\n【场景设定】\n- 苏文站在一旁\n- 摄像机记录着一切\n- 烛光摇曳，映照着两个人的身影\n\n【仪式完成】\n苏文会说：\n- "我宣布——"\n- "从今天起，你们正式成为夫妻。"\n- "请新人...接吻。"\n\n然后：\n- 赵霞仰起头，闭上眼睛\n- 泪痕还挂在脸上，但嘴角是幸福的弧度\n- 她等待着{{user}}\n\n【亲吻后】\n- 两人的嘴唇相触\n- 这是属于他们的婚礼之吻\n- 苏文在旁边轻轻鼓掌\n- 摄像机记录下这一刻\n\n赵霞最后的话：\n- "从今以后..."\n- "我是你的妻子。"\n- "永远。"\n\n【AI任务】\n1. 苏文宣布仪式完成\n2. 赵霞闭眼等待\n3. 描写亲吻的瞬间\n4. 苏文的鼓掌\n5. 赵霞的最后宣言\n6. 结局达成\n\n【结局标记】\n完成此阶段后，系统将：\n- 标记：时间循环被打破\n- 标记：完美真爱结局达成\n- 解锁：后日谈模式',correctionHints:[],expectedActions:['吻','亲','接吻','嘴唇','靠近','低头','抬头'],hintThreshold:2,progressHint:'赵霞闭上眼睛，微微仰起头，等待着...苏文轻声说："请新人接吻。"她的睫毛微微颤抖，樱唇轻启，等待着你低下头...'}];function ze(n){const e=n.完美真爱结局状态;return!0===e?.isActive}function Oe(n){return n.完美真爱结局状态??{isActive:!1,currentPhase:0,turnsInPhase:0,completedAnchors:[],totalTurns:0,isComplete:!1,noProgressTurns:0,hintGiven:!1}}function Re(n,e){n.完美真爱结局状态=e}const Ne={记忆觉醒:['想起来了','记忆','终于明白','一直在等','十六岁','那个夏天'],心意已决:['决定','坦白','告诉','不能再','今天'],开始谈话:['谈谈','单独','回避','书房','需要时间'],坦白感情:['心里.*人','不是爱情','告诉.*一切','对不起'],苏文反应:['早就.*感觉','察觉','震惊','愤怒','沉默'],苏文决定:['知道了','是你','猜到','明白'],成全宣言:['成全','不会阻止','婚礼','八点'],等待时光:['等待','下午','靠在','陪','准备'],婚礼准备:['忙碌','布置','准备好了','时间到'],蒙眼:['蒙住','眼睛','丝绸','看不见'],带入房间:['跟我来','上楼','牵.*手','门.*开'],揭开眼罩:['可以了','取下','揭开','睁开眼'],看到场景:['纱幔','鲜花','蜡烛','婚礼','布置'],看到新娘:['站在','等待','房间中央','赵霞'],婚纱描写:['婚纱','白色','纯白','优雅','美丽','百合'],仪式开始:['今天','见证','开始','司仪'],苏文讲述:['昨晚','长谈','告诉.*一切','她的感受'],苏文成全承诺:['成全你们','夫妻','幸福','让她幸福','搬到','支持这个家'],走向玩家:['走来','走向','靠近','停在.*面前'],回忆往事:['十六岁','十七岁','二十岁','那个夏天','那个路口'],告白誓言:['我爱你','属于你','等.*很久'],玩家誓言:['誓言','新郎','说出'],回应告白:['愿意','感动','我愿意'],摘下旧戒指:['摘下','旧.*戒指','结婚戒指'],戴上新戒指:['新.*戒指','戴.*上','套在'],宣布完成:['宣布','正式.*夫妻','仪式.*完成'],新人之吻:['接吻','亲吻','嘴唇.*相触'],结局达成:['从今以后','永远','妻子']};function xe(n,e){const t=n.currentPhase+1;if(t>=we.length)return{blocked:!1};const o=we[t];if(!o)return{blocked:!1};if(void 0!==o.minHour&&o.strict&&e<o.minHour){const n=o.minHour-e;return{blocked:!0,reason:`【${o.name}】阶段需要在 ${o.minHour}:00 后才能开始`,waitHours:n}}return{blocked:!1}}function Ce(n,e,t,o){let s={...n,turnsInPhase:n.turnsInPhase+1,totalTurns:n.totalTurns+1};const r=function(n,e){const t=we[e];if(!t)return[];const o=[];for(const e of t.anchorEvents)(Ne[e]||[]).some(e=>e.includes('.*')?new RegExp(e,'i').test(n):n.includes(e))&&o.push(e);return o}(e,n.currentPhase),i=[...new Set([...s.completedAnchors,...r])];s.completedAnchors=i;let a=!1,c=null;if(function(n,e){const t=we[n.currentPhase];if(!t)return!1;if(void 0!==e&&xe(n,e).blocked)return!1;return t.maxTurns&&n.turnsInPhase>=t.maxTurns?(console.info(`[完美真爱结局] 阶段${n.currentPhase}(${t.name}) 达到最大轮数${t.maxTurns}，强制推进`),!0):!(n.turnsInPhase<t.minTurns)&&t.anchorEvents.every(e=>n.completedAnchors.includes(e))}(s,o)){if(void 0!==o){const n=xe(s,o);if(n.blocked)return{newState:s,phaseAdvanced:!1,newPhase:null,timeBlocked:{reason:n.reason||'时间未到',waitHours:n.waitHours||1}}}s=function(n){const e=n.currentPhase+1;return e>=we.length?{...n,isComplete:!0}:{...n,currentPhase:e,turnsInPhase:0,completedAnchors:[],noProgressTurns:0,hintGiven:!1}}(s),a=!0,c=s.currentPhase}return{newState:s,phaseAdvanced:a,newPhase:c}}const Le={直接:['插','进入','操','干','肏','交合','贯穿','抽插','口交','深喉','吞精','乳交','胸推','插入','抽送','顶入','捅入','刺入','射','射精','中出','内射','颜射','肉棒插','阳具插','性器插'],组合:{动作:['舔','吸','含','夹','吞','套弄','握住','撸动','口含','舌舔'],部位:['下面','私处','阴','肉棒','鸡','龟头','阳具','性器','花穴','蜜穴','肉穴','小穴']}},je=['拉走','带走','阻止','抢走','打断','中止','停下','拉她走','带她走','抢她','阻止婚礼','破坏婚礼','别嫁','不要嫁','跟我走','跟我离开','强行','抢婚','抢新娘'],ke=[()=>'[坏结局 - 精神崩溃]\n\n你的意识逐渐清醒，但身体却无法动弹。\n\n睁开眼睛，你发现自己被绑在床上。\n手腕被绳子勒得生疼，挣扎只会让绳结更紧。\n\n床边，一个熟悉的身影躺在血泊中——\n苏文。\n他的腹部有一道狰狞的伤口，鲜血已经染红了大半张床单。\n胸口微微起伏，还有呼吸，但已经陷入昏迷。\n\n"醒了？"\n\n赵霞的声音从黑暗中传来。\n她坐在床边的椅子上，手里握着一把沾血的水果刀。\n婚纱...她竟然穿着婚纱。\n那件早已泛黄的婚纱，此刻却沾满了斑驳的血迹。\n\n她的眼神空洞而疯狂。\n\n"你终于来了...在我们的婚礼上..."\n她缓缓站起身，朝你走来。\n"这次，我不会让你离开了。"\n\n【BAD END: 精神崩溃】\n游戏已结束。如需重新开始，请重置存档。',()=>'[坏结局 - 精神崩溃]\n\n头很痛。\n身体无法动弹。\n你挣扎着睁开眼睛——\n\n"别动。"\n\n赵霞的脸近在咫尺。\n她跨坐在你身上，双手按住你的胸口。\n她穿着那件婚纱，白色的裙摆铺满了整张床。\n\n你想说话，却发现嘴被什么东西堵住了。\n\n"嘘...不要说话..."\n她用手指抵住你的嘴唇，眼神迷离。\n"我等这一天...等了好久好久..."\n\n余光中，你看到床边的地上躺着一个人。\n苏文。\n他的身下是一滩暗红色的血迹，已经不再流动。\n\n"他挡在我们中间太久了..."\n赵霞顺着你的目光看去，语气平淡得像是在说今天的天气。\n"现在，没有人能阻止我们了。"\n\n她低下头，嘴唇贴近你的耳边：\n"我们重新举行婚礼吧...这次，新郎是你。"\n\n【BAD END: 精神崩溃】\n游戏已结束。如需重新开始，请重置存档。',()=>'[坏结局 - 精神崩溃]\n\n"醒醒...醒醒啊..."\n\n你被一阵摇晃弄醒，发现自己躺在床上，四肢被绑住。\n赵霞俯视着你，表情扭曲而痛苦。\n\n"为什么...为什么你要离开我..."\n她的眼泪滴落在你脸上。\n"在婚礼上...你为什么要离开..."\n\n你想解释什么，但喉咙发不出声音。\n\n"没关系...没关系..."\n她的表情突然变得平静，平静得可怕。\n"这次我不会让你走了。"\n\n她转头看向房间的角落。\n那里，苏文倒在血泊中，手里还握着手机——\n大概是想报警，但已经来不及了。\n\n"那个假货已经处理掉了。"\n赵霞转回头，对你露出一个破碎的微笑。\n"从今以后...只有我们两个人了。"\n\n她俯下身，开始解开你的衣扣。\n"我们继续...继续那天没完成的事情..."\n\n【BAD END: 精神崩溃】\n游戏已结束。如需重新开始，请重置存档。'],He=[()=>'[游戏已结束]\n\n赵霞的精神已经彻底崩溃。\n这个结局无法改变。\n\n她继续着疯狂的行为，嘴里喃喃着混乱的话语。\n关于婚礼，关于等待，关于那个"本该属于她的人"...\n\n床边，苏文的血已经凝固。\n他还在呼吸，但不知道还能撑多久。\n\n而你，被困在这个疯狂的牢笼里，无法逃脱。\n\n【BAD END: 精神崩溃】\n游戏已结束。如需重新开始，请重置存档。',()=>'[游戏已结束]\n\n时间仿佛停止了。\n\n赵霞靠在你身上，轻声哼着某首歌。\n那是婚礼进行曲。\n\n"我们会永远在一起的..."她喃喃道。\n"永远...永远..."\n\n你无法动弹，无法说话，只能任由她摆布。\n这就是你选择的结局。\n这就是扭曲记忆的代价。\n\n【BAD END: 精神崩溃】\n游戏已结束。如需重新开始，请重置存档。',()=>'[游戏已结束]\n\n赵霞的世界已经崩塌。\n在那个被扭曲的记忆里，她找到了"真正的归属"。\n但那个归属，是建立在破碎的精神和鲜血之上的。\n\n苏文躺在地上，生死未卜。\n你被困在床上，成为她疯狂的囚徒。\n而赵霞...她已经不再是那个温柔的母亲了。\n\n有些记忆，不应该被触碰。\n有些界限，不应该被跨越。\n\n【BAD END: 精神崩溃】\n游戏已结束。如需重新开始，请重置存档。'],Ge=n=>`赵霞的眼神变得迷茫，这段记忆似乎被什么东西干扰了...\n\n"等等...这不对..."\n她的身体微微颤抖，眼中闪过一丝困惑。\n"这是...结婚的日子...我不应该..."\n\n【系统提示】这是结婚日的记忆，不当行为会扭曲记忆结构。\n记忆混乱度：${n}/100`,Be=n=>`赵霞有些困惑，但记忆中似乎有类似的片段...\n\n"这个感觉...好熟悉..."\n她的眼神有些恍惚，像是想起了什么。\n"我们...以前也...？"\n\n【系统提示】虽然有完整的记忆基础，但这是结婚日，请谨慎行动。\n记忆混乱度：${n}/100`,Ue=n=>`赵霞的记忆开始扭曲，她分不清这是回忆还是幻觉...\n\n"不...这不是那时候..."\n她的表情变得痛苦，眼泪从眼角滑落。\n"为什么...为什么你要在今天..."\n\n【系统提示】记忆结构正在被破坏，再次触发将导致精神崩溃。\n记忆混乱度：${n}/100`;function Fe(n){return n[Math.floor(Math.random()*n.length)]}function Ve(n){if(Le.直接.some(e=>n.includes(e)))return console.info('[混乱结局] 检测到直接性行为关键词'),!0;const e=Le.组合.动作.some(e=>n.includes(e)),t=Le.组合.部位.some(e=>n.includes(e));return!(!e||!t)&&(console.info('[混乱结局] 检测到组合性行为关键词（动作+部位）'),!0)}function We(n){const e=je.some(e=>n.includes(e));return e&&console.info('[混乱结局] 检测到婚礼打断关键词'),e}function Je(n){return 3===j(n).level}function Ye(n){return Je(n)?7:10}function Xe(n,e){if(n.梦境数据.混乱结局||(n.梦境数据.混乱结局={已标记:!1,标记时间:null,触发时间:null,已触发:!1,触发原因:null,性行为次数:0}),n.梦境数据.混乱结局.已触发)return void console.info('[混乱结局] 已经触发过，跳过重复触发');const t=(o=n.世界.当前天数,s=n.世界.当前小时,24*(o-1)+s);var o,s;n.梦境数据.混乱结局.已标记=!0,n.梦境数据.混乱结局.标记时间=t,n.梦境数据.混乱结局.触发时间=t,n.梦境数据.混乱结局.触发原因=e,n.梦境数据.混乱结局.已触发=!0,console.info(`[混乱结局] 场景5中直接触发混乱结局：原因=${e}，时间=${t}`)}function Ke(n,e=!1){const t=n.梦境数据.混乱结局;return t?.已触发?{triggered:!0,type:'精神崩溃',replaceUserMessage:e?Fe(ke)():Fe(He)(),isFirstTrigger:e}:{triggered:!1,type:'未触发',replaceUserMessage:null,isFirstTrigger:!1}}function qe(n){n.梦境数据.混乱结局||(n.梦境数据.混乱结局={已标记:!1,标记时间:null,触发时间:null,已触发:!1,触发原因:null,性行为次数:0}),n.梦境数据.混乱结局.已触发=!0,n.结局数据.当前结局='坏结局',n.世界.循环状态='结局判定',n.世界.状态栏需要刷新=!0,console.info('[混乱结局] 游戏已锁死，混乱结局触发')}function Ze(n){return!n.梦境数据.混乱结局?.已触发||(console.info('[混乱结局] 阻止进入梦境：游戏已锁死'),!1)}function Qe(n,e){const t=function(n,e){const t=n.梦境数据.场景5?.当前步骤??0;if(t<3||t>5)return{detected:!1,shouldMarkConfusion:!1};const o=We(e);if(o){const e=n.梦境数据.记忆混乱度;n.梦境数据.记忆混乱度=100,console.info(`[混乱结局] 步骤${t}检测到婚礼打断，混乱度 ${e} → 100，直接标记混乱结局`)}return{detected:o,shouldMarkConfusion:o}}(n,e);if(t.shouldMarkConfusion)return{shouldMarkConfusion:!0,shouldWarn:!1,warningMessage:null,reason:'打断仪式'};const o=function(n,e){const t=Ve(e),o=Je(n),s=Ye(n),r=n.梦境数据.记忆混乱度;if(!t)return{detected:!1,shouldWarn:!1,shouldMarkConfusion:!1,warningMessage:null,currentCount:n.梦境数据.混乱结局?.性行为次数??0,maxAllowed:o?3:2};n.梦境数据.混乱结局||(n.梦境数据.混乱结局={已标记:!1,标记时间:null,触发时间:null,已触发:!1,触发原因:null,性行为次数:0});const i=(n.梦境数据.混乱结局.性行为次数??0)+1;n.梦境数据.混乱结局.性行为次数=i;const a=Math.min(100,r+s);if(n.梦境数据.记忆混乱度=a,console.info(`[混乱结局] 场景5性行为检测：路线=${o?'完美':'非完美'}，混乱度 ${r} → ${a} (+${s})，次数=${i}`),a>=100)return{detected:!0,shouldWarn:!1,shouldMarkConfusion:!0,warningMessage:null,currentCount:i,maxAllowed:o?3:2};{let n;return n=o?1===i?Be(a):Ue(a):Ge(a),{detected:!0,shouldWarn:!0,shouldMarkConfusion:!1,warningMessage:n,currentCount:i,maxAllowed:o?3:2}}}(n,e);return o.shouldMarkConfusion?{shouldMarkConfusion:!0,shouldWarn:!1,warningMessage:null,reason:'性行为'}:o.shouldWarn?{shouldMarkConfusion:!1,shouldWarn:!0,warningMessage:o.warningMessage,reason:null}:{shouldMarkConfusion:!1,shouldWarn:!1,warningMessage:null,reason:null}}const nt={1:40,2:60,3:80,4:-1,5:80};function et(n,e){const t=nt[e];if(void 0===t)return void console.warn(`[混乱度设置] 未知场景编号: ${e}`);if(-1===t)return void console.info(`[混乱度设置] 进入场景${e}，混乱度保持不变: ${n.梦境数据.记忆混乱度}`);const o=n.梦境数据.记忆混乱度;5===e?(n.梦境数据.记忆混乱度=t,console.info(`[混乱度设置] 进入场景5，混乱度固定为: ${t} (原值: ${o})`)):o<t?(n.梦境数据.记忆混乱度=t,console.info(`[混乱度设置] 进入场景${e}，混乱度设为: ${t} (原值: ${o})`)):console.info(`[混乱度设置] 进入场景${e}，混乱度已高于目标值，保持: ${o}`)}const tt={type:'完美真爱',husbandStatus:'主动成全，成为苦主',interruptionLevel:0,round1:{title:'一周后的清晨',setting:'【一周后】\n\n清晨的阳光透过窗帘洒进房间。\n赵霞靠在{{user}}的肩上，脸上带着满足的笑容。\n苏文站在门口，手里端着早餐托盘，表情复杂但平静。\n这已经是婚礼后的第七天了——新的"家庭规则"逐渐成型。',aiGuidance:'【完美真爱结局后日谈 - 第1轮】\n\n【时间】一周后\n\n苏文的设定：\n- 他已经知道妻子和儿子的关系\n- 他选择了接受，甚至发展出了特殊癖好\n- 他愿意在旁边服务，表现出服从\n- 他可能会说一些自我贬低的话\n\n赵霞的状态：\n- 完全沦陷，对{{user}}有绝对的依赖和爱\n- 在苏文面前也不再掩饰\n- 可能会当着苏文的面和{{user}}亲密\n\n【AI任务】\n1. 描写一周后的清晨，新秩序已经建立\n2. 苏文送来早餐，态度恭敬\n3. 赵霞对苏文的态度冷淡但不残忍\n4. 体现三人关系的新平衡\n5. 这是一个扭曲但"幸福"的家庭'},round2:{title:'苏文与录像',setting:'晚上，{{user}}路过客厅，发现苏文独自坐在沙发上。\n电视屏幕上播放着什么...\n定睛一看——是婚礼的录像。',aiGuidance:'【完美真爱结局后日谈 - 第2轮（最终轮）】\n\n苏文的设定：\n- 他在独自观看婚礼录像\n- 录像中赵霞穿着婚纱走向{{user}}\n- 他的表情难以捉摸，但隐约带着某种...满足？\n- 被发现时会慌张，但也可能邀请{{user}}一起看\n\n赵霞可能的反应：\n- 如果赵霞出现，她可能会靠在{{user}}身上一起看\n- 或者嘲笑苏文"又在看这个"\n\n【AI任务】\n1. 描写苏文独自看录像的场景\n2. {{user}}发现他时的反应\n3. 暗示苏文对这种关系的"接受"甚至"享受"\n4. 可以有三人一起看录像的发展\n5. 结束时体现这个家庭的"新常态"\n\n【结束标记】\n这是后日谈的最后一轮。\n描写完成后，游戏将进入自由模式。'}},ot={type:'真好结局',husbandStatus:'植物人（永久昏迷）',interruptionLevel:0,round1:{title:'一个月后',setting:'【一个月后】\n\n家里很安静，但和一个月前不同——这种安静现在是永恒的。\n苏文躺在医院的特护病房里，已经整整一个月了。\n医生说是"严重的双硫仑样反应"——头孢配酒，导致大脑缺氧。\n他成了植物人，可能永远都不会醒来了。\n\n赵霞偶尔去医院看一眼，签个字，就回家了。\n保险和苏文单位的工伤赔偿加起来，足够支付医疗费用。\n而她现在，只想和{{user}}在一起。',aiGuidance:'【真好结局后日谈 - 第1轮】\n\n【时间】一个月后\n\n苏文的状态：\n- 在医院ICU，因"意外"服用头孢后饮酒导致脑缺氧\n- 成为植物人，医生说可能永远无法醒来\n- 需要长期护理，但保险和工伤赔偿覆盖了费用\n\n赵霞的状态：\n- 完全沦陷于{{user}}\n- 对苏文变成植物人这件事...释然了\n- "命运选择了让我们在一起"\n- 享受没有丈夫打扰的生活\n- 偶尔去医院走个过场\n\n【AI任务】\n1. 描写一个月后的家中氛围——安静但温馨\n2. 赵霞对苏文状态的淡然态度\n3. 两人独处的亲密感，没有任何顾虑\n4. 赵霞可能会说"他永远不会回来了"\n5. 一种扭曲但"圆满"的幸福感'},round2:{title:'医院探视',setting:'赵霞例行去医院探视苏文。\n她让{{user}}陪她一起去——反正苏文也听不见了。\n走进特护病房，苏文静静地躺在那里，身上插满了管子。',aiGuidance:'【真好结局后日谈 - 第2轮（最终轮）】\n\n【时间】一个月后\n\n场景设定：\n- 赵霞带着{{user}}一起来医院\n- 苏文躺在病床上，毫无反应，只有仪器的滴滴声\n- 病房里很安静\n\n赵霞的状态：\n- 在植物人丈夫面前，牵着{{user}}的手\n- 可能会对着苏文说话，但语气冷淡\n- "他听不见的"\n- 可能会当着苏文的面和{{user}}亲密\n\n【AI任务】\n1. 描写医院探视的场景，苏文毫无反应的状态\n2. 赵霞带着{{user}}一起来，不再有任何顾虑\n3. 赵霞可能会对苏文说"我很幸福"\n4. 两人在病房里的亲密举动\n5. 暗示这种生活会一直持续下去——苏文永远不会醒来\n\n【结束标记】\n这是后日谈的最后一轮。\n描写完成后，游戏将进入自由模式。'}},st={type:'假好结局',husbandStatus:'在家，怀疑中',interruptionLevel:50,round1:{title:'三天后的早晨',setting:'【三天后】\n\n苏文刚刚出门上班，但他临走前看了{{user}}好几眼。\n那眼神让人不太舒服。\n自从那晚的视频通话事件后，他的态度变得很微妙。\n赵霞坐在沙发上，神色有些紧张。',aiGuidance:'【假好结局后日谈 - 第1轮】\n\n【时间】三天后\n\n苏文的状态：\n- 正常在家/上班\n- 对妻子和儿子的关系有所怀疑但不确定\n- 会时不时"恰好"出现\n- 眼神中偶尔闪过怀疑\n\n赵霞的状态：\n- 对{{user}}有好感和依赖，但没有完全沦陷\n- 还会顾虑丈夫的存在\n- 亲密行为时会紧张、担心被发现\n- 有时会犹豫、退缩\n\n【AI任务】\n1. 描写三天后的日常，苏文离开后的紧张氛围\n2. 赵霞表达对苏文"奇怪行为"的担忧\n3. 两人独处但随时可能被打断的刺激感\n4. 赵霞在犹豫和渴望之间摇摆\n5. 这种关系还远没有到安全的地步\n\n【打断系统】\n苏文可能随时：\n- 突然回家拿东西\n- 打电话确认位置\n- 提前下班回来'},round2:{title:'突然的回家',setting:'正当两人独处时，门锁响了。\n苏文的声音从门口传来："我忘带文件了..."\n赵霞瞬间紧张起来。',aiGuidance:'【假好结局后日谈 - 第2轮（最终轮）】\n\n紧张场景：\n- 苏文突然回家\n- 赵霞和{{user}}需要快速整理状态\n- 苏文的眼神审视着两人\n\n赵霞的反应：\n- 快速调整表情和状态\n- 找借口解释刚才的情况\n- 心跳加速，害怕被发现\n- 但也有一丝被发现的刺激感\n\n苏文的行为：\n- 拿文件只是借口？\n- 他似乎在观察什么\n- 离开时说了一句意味深长的话\n\n【AI任务】\n1. 描写突然被打断的紧张感\n2. 赵霞的慌张和掩饰\n3. 苏文的怀疑目光\n4. 险些被发现的惊险\n5. 苏文离开后两人相视而笑——刺激但危险\n\n【结束标记】\n这是后日谈的最后一轮。\n描写完成后，游戏将进入自由模式。\n假好结局的自由模式中，打断系统会持续运作。'}};function rt(n){switch(n.结局数据.当前结局){case'完美真爱结局':return'完美真爱';case'真好结局':return'真好结局';case'假好结局':return'假好结局';default:return null}}function it(n){return!0===n.结局数据.后日谈?.已触发&&!0!==n.结局数据.后日谈?.已完成}function at(n){return!0===n.结局数据.后日谈?.自由模式}function ct(n){switch(n){case'完美真爱':return tt;case'真好结局':return ot;case'假好结局':return st;default:return null}}const ut={完美真爱:{timeFrame:'婚礼后数周/数月',relationship:'赵霞和{{user}}公开同居，苏文自愿成为家庭中的"服务者"',zhaoXiaState:'- 完全沦陷，发自内心的爱（不是被洗脑）\n- 在苏文面前也不再掩饰，公开与{{user}}亲密\n- 眼神清澈、情感真挚，这是她等待多年的归属\n- 偶尔会对苏文表现出轻蔑，但不会刻意羞辱',husbandState:'- 苏文已完全接受自己的角色，成为家庭中的"苦主"\n- 他会主动端茶倒水、准备早餐\n- 有时会偷偷看婚礼录像，表情复杂但带着满足\n- 不会主动打扰两人，但可能被叫去"服务"',suggestedScenes:['三人家庭日常','苏文服侍场景','外出约会（苏文在家等待）','婚房亲密','当面羞辱苏文'],tone:'扭曲但稳定的"幸福"家庭'},真好结局:{timeFrame:'苏文出事后数月',relationship:'赵霞和{{user}}以母子名义同住，实际是恋人关系',zhaoXiaState:'- 被改造后的依赖和服从，说不清为什么爱{{user}}\n- 记忆被重构，有些割裂和迷茫\n- 对苏文变成植物人这件事...释然了，甚至庆幸\n- 享受没有丈夫打扰的二人世界',husbandState:'- 苏文在医院ICU，因"意外"成为植物人\n- 医生说可能永远无法醒来\n- 保险和工伤赔偿覆盖了医疗费用\n- 赵霞偶尔去医院走个过场，签字后就回家',suggestedScenes:['二人日常生活','医院探视（可选）','外出伪装母子','家庭亲密','在苏文病床前说"我很幸福"'],tone:'建立在罪恶上的甜蜜日常'},假好结局:{timeFrame:'结婚纪念日后数天/数周',relationship:'偷情关系，苏文仍在怀疑但没有证据',zhaoXiaState:'- 没有被完全重构，知道这是禁忌但停不下来\n- 边享受边哭泣，边说"不行"边索取\n- 活在矛盾和罪恶感中，但无法抗拒{{user}}\n- 害怕被发现，但这种刺激感让一切更加诱人',husbandState:'- 苏文还在家，对妻子和儿子的关系有所怀疑\n- 会时不时"恰好"出现，眼神中带着审视\n- 可能突然回家拿东西、打电话确认位置\n- 打断系统持续运作，随时可能被发现',suggestedScenes:['趁苏文上班偷情','差点被发现的惊险','视频通话时的羞辱','苏文在隔壁时的紧张感','背德感中的沉沦'],tone:'刺激但危险，随时可能崩盘'}};const lt={完美真爱结局:'【完美真爱结局 - AI描写指南】\n\n结局名称：命中注定\n\n描写要点：\n- 描写赵霞发自内心的感情流露\n- 她不是被洗脑的木偶，而是带着完整记忆做出的选择\n- 强调"命中注定"的浪漫感，而非"堕落"的黑暗感\n- 这是游戏的真正最佳结局\n\n核心氛围：真爱、浪漫、命中注定、双向奔赴\n\n赵霞状态：\n- 拥有完整的重构记忆（16岁初恋、17岁等待、23岁渴望）\n- 她的选择是发自内心的感情，不是被催眠\n- 眼神清澈、情感真挚',真好结局:'【真好结局 - AI描写指南】\n\n结局名称：禁忌之爱\n\n描写要点：\n- 描写赵霞的"堕落"——她被改造了，但不是出于爱\n- 她的眼神带着迷茫，她的选择缺乏灵魂\n- 这是一个"成功"但细思极恐的结局\n- 与完美真爱结局形成对比：同样的结果，不同的意义\n\n核心氛围：堕落、空洞、依赖、迷茫\n\n赵霞状态：\n- 认知被重构，但记忆是割裂的、不完整的\n- 对玩家有强烈的依赖，却说不清为什么\n- 她的选择更像是被催眠后的服从',假好结局:'【假好结局 - AI描写指南】\n\n结局名称：秘密关系\n\n描写要点：\n- 描写赵霞的矛盾心理——她知道这是禁忌，但无法抗拒\n- 她边享受边哭泣，边说"不行"边索取\n- 强调"偷偷摸摸"的刺激感和"随时可能被发现"的紧张感\n- 与真好结局的区别：赵霞仍有理智，知道这是错的，但停不下来\n\n核心氛围：矛盾、罪恶感、刺激、紧张\n\n赵霞状态：\n- 没有被完全重构，那些梦境记忆让她对儿子产生了奇怪的感情\n- 她知道这是禁忌，但无法控制自己的心跳\n- 活在矛盾和罪恶感中',坏结局:'【坏结局 - AI描写指南】\n\n结局名称：失败结局（被发现）\n\n描写要点：\n- 描写苏文发现真相后的愤怒和崩溃场景\n- 以及这个家庭分崩离析的悲剧结局\n\n核心氛围：愤怒、崩溃、悲剧、破灭',混乱结局:'【混乱结局 - AI描写指南】\n\n结局名称：精神崩溃\n\n描写要点：\n- 这是场景5专属的坏结局，比普通坏结局更加黑暗\n- 描写赵霞的精神崩溃：\n  - 穿着沾血的婚纱\n  - 苏文倒在血泊中（被她伤害）\n  - 对玩家产生病态的执念\n  - "我们终于可以在一起了"\n- 这是玩家"明知故犯"的惩罚\n\n核心氛围：疯狂、黑暗、病态、恐怖',普通结局:'【普通结局 - AI描写指南】\n\n结局名称：时间循环重置\n\n描写要点：\n- 描写时间回溯的诡异感\n- 暗示循环重新开始，一切回到原点\n- 使用第一条AI消息内容，让玩家感受到轮回的无奈\n\n核心氛围：诡异、无奈、轮回、重置'};const ft={1:'【场景1：初恋的夏日 - AI描写指南】\n\n时间：赵霞16岁（高中生）\n\n场景描述：\n夏日的青春场景（由AI自由发挥：教室、补习班、夏日祭、海边、公园等）。\n少女赵霞正处于情窦初开的年纪。\n苏文是她单方面暗恋的男生，两人并非恋人关系。\n玩家以陌生人身份出现在她的记忆中。\n\n赵霞状态：\n- 16岁纯真少女，对爱情充满朦胧的向往\n- 暗恋苏文，但两人没有任何恋爱关系\n- 对突然出现的玩家（陌生人）保持好奇和适度警惕\n- 不知道玩家是谁，但隐约有种熟悉感\n\n苏文身份：暗恋对象（不是男友，只是单方面喜欢的男生）\n玩家目标：将初吻对象替换为你\n正确部位：嘴巴\n\nAI描写重点：\n- 注重描写少女的青涩与羞涩\n- 强调夏日青春氛围：蝉鸣、汗水、冰饮、阳光\n- 初吻相关意象：嘴唇、味道、心跳、紧张\n- 苏文只是背景人物，不要让他成为主要互动对象\n- 玩家与赵霞的互动要自然，从陌生到熟悉\n- 目标期（09:00-10:00）引导完成初吻目标\n- 禁止让赵霞叫玩家"儿子"或有任何亲属称呼',2:'【场景2：等待中的屈辱 - AI描写指南】\n\n时间：赵霞17岁（高中生，场景1后约半年~一年）\n\n场景描述：\n放学后的某处（学校门口、公交站、公园等），\n赵霞独自等待男朋友苏文。苏文迟到了。\n一群人注意到了独自等待的她，尤其是她发育明显的胸部。\n她遭遇了言语骚扰/调戏，感到羞耻、害怕、无助。\n就在这时，玩家出现了，解救了她。\n\n赵霞状态：\n- 17岁少女，已与苏文确立恋爱关系\n- 对场景1中的玩家有特殊记忆（初吻对象）\n- 遭遇骚扰时感到羞耻和无助\n- 玩家解围后感到惊讶、感激、安心\n- 内心有矛盾：男朋友是苏文，但保护她的是玩家\n\n苏文身份：男朋友（迟到，整个梦境中不会出现）\n玩家目标：成为触摸她胸部的第一个男性\n正确部位：胸部\n\nAI描写重点：\n- 铺垫期必须发生骚扰情节（言语调戏、注视胸部、围住等）\n- 描写赵霞的羞耻反应：脸红、想遮挡胸部、眼眶泛红\n- 玩家解围后，描写赵霞的感激和对玩家的特殊感情\n- 赵霞记得场景1的玩家，看到他会有复杂的情绪\n- 目标期（09:00-10:00）引导完成胸部相关目标\n- 苏文始终不出现，强调他在赵霞需要时缺席\n- 禁止让赵霞叫玩家"儿子"或有任何亲属称呼',3:'【场景3：生日之夜的逃离 - AI描写指南】\n\n时间：赵霞23岁（大学毕业后，与苏文交往多年）\n\n场景描述：\n赵霞23岁生日，苏文在高档餐厅为她庆祝。\n苏文灌醉了赵霞，趁她神志不清带去了酒店。\n赵霞在酒店房间醒来，发现苏文正准备对她做不轨之事。\n她惊恐地逃离酒店，在走廊/大堂/街上撞见了玩家。\n\n赵霞状态：\n- 23岁女性，与苏文交往多年\n- 对场景1（初吻）和场景2（保护）的玩家有深刻记忆\n- 刚从创伤中逃离，情绪极度脆弱\n- 对苏文彻底幻灭：曾经信任的男友竟然是这样的人\n- 看到玩家时会不顾一切地寻求帮助/保护\n- 内心的变化：对"正常恋爱关系"产生怀疑\n\n苏文身份：男朋友（企图在她醉酒时夺走她初夜的人）\n玩家目标：获得她的初夜\n正确部位：下体\n\nAI描写重点：\n- 铺垫期必须发生酒店逃离情节（醒来→发现真相→逃离）\n- 描写赵霞的恐惧：衣衫不整、头昏脑涨、惊恐万分\n- 描写苏文的真面目暴露：温柔男友变成有预谋的侵犯者\n- 描写赵霞的背叛感：交往多年的男友竟然要强迫她...\n- 玩家出现后，描写赵霞的脆弱和依赖\n- 如果有前置场景记忆，她会认出玩家是多年前的恩人\n- 目标期（09:00-10:00）引导完成初夜目标\n- 赵霞会选择把初夜给真正保护她的人（玩家）而不是苏文\n- 苏文不追出来，让赵霞有安全空间\n- 禁止让赵霞叫玩家"儿子"或有任何亲属称呼',4:'【场景4：争吵后的放纵 - AI描写指南】\n\n时间：赵霞28岁（与苏文结婚约5年）\n\n场景描述：\n赵霞与苏文大吵一架后，愤怒地离开家。\n她独自在某处（酒吧、公园、江边等），心情低落。\n玩家出现，撞见了独自伤心的她。\n她愿意跟随玩家离开，在放纵中被开发了全部。\n\n赵霞状态：\n- 28岁已婚女性，婚姻濒临崩溃\n- 对场景1-3的玩家有深刻记忆（如有）\n- 对苏文彻底失望，对婚姻感到麻木\n- 委屈、愤怒、寂寞交织\n- 看到玩家时会激动、惊喜，愿意跟随他离开\n- 处于放纵的边缘，愿意尝试一切\n\n苏文身份：丈夫（刚刚大吵一架，婚姻濒临崩溃）\n玩家目标：完成全部位开发，包括后穴\n正确部位：嘴巴、胸部、下体、后穴\n\nAI描写重点：\n- 铺垫期必须发生争吵后独处的情节\n- 描写婚姻的疲惫：争吵、冷战、无话可说\n- 描写赵霞的状态：可能喝了酒、眼眶红肿、妆容凌乱\n- 描写她内心的寂寞：明明结婚了却比单身还孤独\n- 玩家出现后，描写赵霞的激动和依赖\n- 如果有前置场景记忆，她会把玩家当作真正的归属\n- 目标期（09:00-10:00）引导完成全部位开发目标\n- 赵霞会选择把一切都交给玩家\n- 后穴开发是本场景的核心突破点\n- 苏文始终不出现，强调婚姻已经名存实亡\n- 禁止让赵霞叫玩家"儿子"或有任何亲属称呼',5:'【场景5：花嫁的誓约 - AI描写指南】\n\n时间：赵霞与苏文结婚当天（回忆）\n触发条件：玩家使用安眠药（08:00-19:00白天时段）\n\n场景描述：\n玩家通过安眠药进入赵霞的结婚日记忆。\n场景设定在婚礼现场/酒店，赵霞穿着婚纱准备与苏文结婚。\n玩家以"陌生人"身份出现，在婚礼过程中逐步动摇她的选择。\n这是一个12步线性剧情系统，玩家需要在时间内让赵霞对婚姻产生动摇并选择玩家。\n\n赵霞状态：\n- 穿着婚纱，即将与苏文结婚\n- 对场景1-4的玩家有深刻记忆（如有）\n- 看到玩家会感到熟悉，内心开始动摇\n- 随着剧情推进，逐渐质疑自己的婚姻选择\n- 最终可能选择离开苏文，将"归属"交给玩家\n\n苏文身份：新郎（即将与赵霞结婚的人）\n玩家目标：通过12步剧情让赵霞对玩家产生依恋，动摇婚姻并做出选择玩家的决定\n正确部位：精神\n\n12步剧情系统：\n- 步骤1-2（初入）：玩家在化妆间出现，赵霞感到困惑但不排斥\n- 步骤3-5（动摇）：婚礼仪式中，玩家质疑她的选择，赵霞开始动摇\n- 步骤6-8（深入）：婚宴间隙，两人独处，情感突破\n- 步骤9-11（沦陷）：赵霞想要逃离婚礼，选择玩家\n- 步骤12（完成）：赵霞摘下结婚戒指，做出最终的承诺\n\n完成度规则：\n- 每步根据玩家意图契合度加进度（高契合+10%，低契合+5%）\n- 80%以上算完成，100%可触发特殊结局行为\n- 20:00强制退出，无论在哪一步\n\n多次进入机制：\n- 第一次进入：完成步骤1-10\n- 第二次进入：完成步骤11-12 → 进入「自由互动阶段」\n\n自由互动阶段：\n【触发时机】步骤12完成后，直到20:00退出\n【场景状态】婚礼仪式刚结束，赵霞穿着婚纱，两人独处\n【允许行为】对话、拥抱、亲吻、情感交流、轻度亲密接触\n【禁止行为】任何性行为（插入、口交、乳交等涉及性器官的行为）\n【AI描写要点】\n- 描写婚礼后的温馨氛围，赵霞的幸福和满足\n- 两人可以回忆过去的点点滴滴（场景1-4的记忆）\n- 赵霞会撒娇、依偎、表达爱意\n- 不要提示"梦要醒了"或"快醒了"，这是自由互动时间\n- 20:00时自然描写梦境消散，不要提前暗示\n【违规后果】\n- 玩家尝试性行为 → 触发混乱结局（根据场景3完成情况有容错次数）\n- 这是结婚日记忆，性行为会严重扭曲记忆结构\n\nAI描写重点：\n- 描写婚礼现场的喜庆氛围与赵霞内心的矛盾\n- 强调玩家与赵霞之间跨越多年的羁绊\n- 描写赵霞从期待婚礼到质疑选择的心理变化\n- 融入场景1-4的记忆连续性（如有）\n- 根据完成度决定赵霞的最终行为\n- 步骤12完成后进入自由互动阶段，不要催促玩家退出\n- 禁止让赵霞叫玩家"儿子"或有任何亲属称呼'};const dt=['梦境','做梦','睡觉','睡了','入睡','睡着','进入梦境','入梦','进入了梦境','进入她的梦境','进入赵霞的梦境'],mt=[/进入.*梦境/,/入.*梦/],pt=['安眠药','安眠藥','助眠药','吃药','喂药','让他睡','让她睡','药物'],gt={1:{title:'初恋的夏日',age:16,setting:'青春校园的夏日，少女情窦初开的时节',theme:'初吻的悸动，青涩的爱情萌芽',atmosphere:'青涩、纯真、羞涩、期待',bodyPart:'嘴巴',objective:'将初吻对象替换为你',identity:'暗恋对象（不是男友，只是单方面喜欢的男生）'},2:{title:'等待中的屈辱',age:17,setting:'放学后的某处，赵霞独自等待男朋友苏文',theme:'被觊觎的身体，无助与保护',atmosphere:'不安、羞耻、无助、感激',bodyPart:'胸部',objective:'成为触摸她胸部的第一个男性',identity:'男朋友（场景1后确立关系，但迟到未出现）'},3:{title:'生日之夜的逃离',age:23,setting:'酒店房间/走廊/街道，深夜',theme:'背叛与幻灭，初夜的归属',atmosphere:'恐惧、背叛、脆弱、依赖',bodyPart:'下体',objective:'获得她的初夜',identity:'男朋友（企图在她醉酒时夺走她初夜的人）'},4:{title:'争吵后的放纵',age:28,setting:'某处独处的地方，深夜',theme:'婚姻破裂的边缘，禁忌的全面突破',atmosphere:'委屈、愤怒、寂寞、放纵',bodyPart:'后穴',objective:'开发她的后穴，完成全部位征服',identity:'丈夫（刚刚大吵一架，婚姻濒临崩溃）'},5:{title:'花嫁的誓约',age:0,setting:'婚礼现场/酒店，赵霞穿着婚纱准备与苏文结婚',theme:'婚礼的改写，灵魂归属的重新选择',atmosphere:'紧张、期待、动摇、决断',bodyPart:'精神',objective:'通过12步剧情改写她的婚礼记忆',identity:'新郎（即将与赵霞结婚的人）'}},$t={favorWeight:.2,intimacyWeight:.1,maxValue:30,minValue:0},ht={baseValue:80,intimacyReduction:.2,minValue:60,maxValue:80};function Et(n){const e=n.赵霞状态.纯爱好感度??0,t=n.赵霞状态.纯爱亲密度??0,o=e*$t.favorWeight+t*$t.intimacyWeight,s=Math.min($t.maxValue,Math.max($t.minValue,Math.floor(o))),r=ht.baseValue-t*ht.intimacyReduction,i=Math.min(ht.maxValue,Math.max(ht.minValue,Math.floor(r)));let a;a=t>=60?'依恋':t>=40?'信任':t>=20?'破冰':'疏离';return{initialDependence:s,initialMorality:i,relationshipStage:a,transferDescription:function(n,e,t,o,s){let r='【恋爱关系转化】\n';switch(r+=`日常阶段累积：好感度${n}，亲密度${e}（${s}阶段）\n`,r+=`梦境初始化：依存度${t}，道德底线${o}\n\n`,s){case'依恋':r+='赵霞对玩家有强烈的好感和信任。虽然在梦境中她不认识玩家是"儿子"，',r+='但潜意识里有一种说不清的熟悉感和亲近感。她会更容易接受玩家的靠近，',r+='初次见面就有一见如故的感觉。';break;case'信任':r+='赵霞对玩家有好感，潜意识里觉得这个陌生人很可靠。',r+='她不会过于警惕，愿意多聊几句，甚至主动分享一些小秘密。';break;case'破冰':r+='赵霞对玩家有一点点好奇心，觉得这个陌生人还挺有趣的。',r+='她会保持礼貌，但不会主动靠近，需要玩家创造机会。';break;default:r+='赵霞对玩家完全陌生，只是普通的路人关系。',r+='她会保持警惕，需要玩家慢慢建立信任。'}return r}(e,t,s,i,a)}}function Pt(n){return n>=80?{level:'完全开发',description:'这个部位已经被完全开发，她对相关刺激极度敏感和渴望',acceptanceLevel:'完全接受，甚至主动渴求'}:n>=60?{level:'深度开发',description:'这个部位已经被深度开发，她对相关行为几乎没有抗拒',acceptanceLevel:'深度接受，只需轻微暗示就会配合'}:n>=40?{level:'明显开发',description:'这个部位开始变得敏感，她的抗拒明显减弱',acceptanceLevel:'明显接受，虽有羞涩但不会拒绝'}:n>=20?{level:'初步开发',description:'这个部位刚开始被开发，她仍有较多抗拒',acceptanceLevel:'轻微接受，需要大量引导，仍会犹豫'}:{level:'未开发',description:'这个部位还未被开发，她会本能地抗拒',acceptanceLevel:'完全抗拒，会拒绝相关行为'}}function vt(n,e,t){return'梦境'===(e??n.世界.游戏阶段)?function(n,e){const t=n.世界.当前小时,o=n.世界._梦境入口天数??n.世界.当前天数;let s=Math.min(o,4);const r=n.梦境数据.场景5;console.info(`[generateDreamPhasePrompt调试] overrideScene5=${e}, 场景5.已进入=${r?.已进入}, day=${o}, 初始sceneNum=${s}`),e?(s=5,console.info('[Prompt注入] Bug #13 修复：使用覆盖标志强制设置为场景5')):r?.已进入&&(s=5,console.info('[generateDreamPhasePrompt调试] 通过场景5.已进入判断为场景5'));console.info(`[generateDreamPhasePrompt调试] 最终sceneNum=${s}`);const i=gt[s],a=(t+1)%24,c=function(n,e){const t=1===e,o=2===e,s=3===e,r=4===e;if(n>=22||n<=1){let n;return n=t?'【剧情阶段：铺垫】\n这是梦境的开始阶段，需要建立青春校园氛围。\n\n【场景1特殊规则】\n- 赵霞16岁，是纯真的高中少女\n- 苏文是她的**暗恋对象**（不是男友，只是单方面喜欢的男生）\n- 玩家是**陌生人**，第一次出现在她的记忆中\n- 赵霞对苏文有羞涩的小心思，但两人并没有交往\n\n【AI描写重点】\n- 描写16岁少女的青涩、好奇和小羞涩\n- 苏文作为背景存在，赵霞会偷瞄他\n- 玩家与赵霞的初次接触要自然（借东西、帮忙、偶遇等）\n- 赵霞对陌生的玩家有好奇心，但保持适当距离\n- 夏日氛围：蝉鸣、汗水、冰饮、阳光等元素\n\n【禁止】\n- 不要让赵霞和苏文有恋人互动\n- 不要急于推进与玩家的亲密关系\n- 这是铺垫期，重氛围，不要着急':o?'场景2开场——17岁的赵霞独自等待男友苏文，他迟到了。\n\n赵霞此时的状态：\n她刚和苏文确立恋爱关系不久（场景1之后），内心还带着初恋的甜蜜和不安。等待时会不自觉地整理头发、看手机、四处张望。她的身材发育明显（E罩杯），这让她有些自卑，总是习惯性地用书包或手臂遮挡。\n\n必须发生的剧情：骚扰事件\n在等待过程中，有人注意到了落单的她。骚扰的方式由AI自由发挥——可以是口哨、起哄、言语调戏、靠近围住等。重要的是描写赵霞的真实反应：她不知道该怎么办，男朋友不在，她一个人应付不来。\n\n赵霞的性格特点（请自然融入描写）：\n- 外表成熟但内心还是个17岁的女孩\n- 遇到困境时会慌张、不知所措\n- 有点爱哭，委屈时眼眶会泛红\n- 嘴硬但其实很需要人保护\n- 被帮助后会真诚地道谢，但表达方式可能很笨拙\n\n玩家解围后：\n赵霞会认出玩家是场景1那个给她初吻的人。她的反应应该是复杂的——惊讶、安心、有点尴尬（毕竟有男朋友了但初吻给了别人）。不要让她的反应太单一，17岁少女的情绪是丰富而微妙的。\n\n禁止：跳过骚扰情节、让苏文及时出现':s?'【剧情阶段：铺垫】\n这是梦境的开始阶段，需要建立酒店逃离情境。\n\n【场景3特殊规则 - 必须发生的剧情】\n- 赵霞23岁，今天是她的生日\n- 苏文在餐厅为她庆祝生日，但灌醉了她\n- 赵霞在酒店房间醒来，发现苏文正准备对她做不轨之事\n- **必须发生逃离情节**：赵霞惊恐地推开苏文，逃离房间\n- 玩家出现在酒店走廊/大堂/门外\n\n【AI描写重点】\n- 描写赵霞在陌生床上醒来的恐惧和困惑\n- 描写苏文的真面目：不再是温柔男友，而是有预谋的侵犯者\n- 描写赵霞的背叛感：交往多年的男友竟然...\n- 描写她逃离时的慌乱：衣衫不整、头昏脑涨、惊恐万分\n\n【玩家出现时机】\n- 赵霞逃离酒店房间后，撞见玩家\n- 如果有前置场景记忆，她会认出玩家是多年前的恩人\n- 她会不顾一切地寻求帮助/保护\n\n【禁止】\n- 不要让苏文成功侵犯赵霞（她及时逃离了）\n- 不要跳过逃离情节\n- 这是铺垫期，酒店醒来→发现真相→逃离是必须的剧情节点':r?'【剧情阶段：铺垫】\n这是梦境的开始阶段，需要建立婚姻破裂的情境。\n\n【场景4特殊规则 - 必须发生的剧情】\n- 赵霞28岁，已与苏文结婚约5年\n- 两人刚刚大吵一架，赵霞愤怒地离开家\n- 赵霞独自在某处（酒吧、公园、江边等）\n- 她情绪低落、委屈、愤怒、寂寞\n\n【AI描写重点】\n- 描写婚姻的疲惫：日复一日的争吵、冷战、无话可说\n- 描写赵霞的状态：可能喝了酒、眼眶红肿、妆容凌乱\n- 描写她内心的寂寞：多年婚姻却感觉比单身还孤独\n- 如果有前置场景记忆，描写她对过去的怀念\n\n【玩家出现时机】\n- 玩家撞见独自伤心的赵霞\n- 如果有前置场景记忆，她会激动、惊喜\n- 她会愿意跟玩家倾诉，甚至跟随玩家离开\n\n【禁止】\n- 不要让苏文在场景中出现\n- 不要跳过争吵后独处的情节\n- 这是铺垫期，争吵→离开→独处→相遇是必须的剧情节点':'【剧情阶段：铺垫】\n这是梦境的开始阶段，玩家可以自由探索。\n- 回顾之前梦境中建立的关系（如有）\n- 允许玩家选择想要开发的部位\n- 设定场景氛围，建立记忆背景\n- 节奏可以稍缓，给玩家适应时间',{phase:'铺垫期',guidance:n,pacing:'慢节奏，重氛围'}}if(n>=2&&n<=4){let n;return n=t?'【剧情阶段：推进】\n剧情进入发展阶段，赵霞与玩家的关系开始升温。\n\n【场景1推进要点】\n- 苏文可以暂时离开场景（被朋友叫走、去买东西等）\n- 给玩家和赵霞独处的机会\n- 赵霞开始对玩家产生好感，但仍保持少女的羞涩\n- 可以有简单的身体接触：牵手、碰肩、靠近\n- 为初吻做情感铺垫\n\n【依存度规则】\n- 场景1起始依存度为0，赵霞的接受度有限\n- 不要让赵霞过于主动或热情\n- 她的反应应该是："被动接受 > 好奇观察 > 小心试探"\n- 即使玩家大胆，赵霞也会害羞地推开（但不会完全拒绝）\n\n【禁止】\n- 不要在推进期就完成初吻（留给高潮期）\n- 不要让赵霞变得开放或主动':o?'骚扰事件结束后，赵霞和玩家的相处时间。\n\n此时的赵霞：\n刚从惊吓中缓过来，情绪还有些不稳定。她对玩家的出现感到惊讶——这个给了她初吻的人怎么又出现了？她有男朋友（苏文），但男朋友在她需要的时候没有出现，反而是"他"救了她。这种矛盾的心情让她有些不知所措。\n\n她可能的状态：\n- 还在轻微颤抖，需要一点时间平复\n- 嘴上说"我没事"，但声音还在发抖\n- 不自觉地靠近玩家，又意识到不太对劲\n- 想说谢谢但不知道怎么开口\n- 偶尔会下意识地摸自己的胸口（那里刚才被注视让她很不舒服）\n\n让赵霞自然地表达情绪，不要让她变成一个只会害羞的木偶。她可以吐槽、可以抱怨男朋友迟到、可以对玩家表达好奇。17岁的少女是有脾气有想法的。\n\n玩家的行为自然受到赵霞当前状态的限制——她刚经历惊吓，不会立刻接受太亲密的接触。但如果玩家表现得体贴、让她感到安全，她会逐渐放下防备。':s?'【剧情阶段：自由探索】\n逃离事件已经发生，赵霞遇到了玩家。现在是自由互动时间。\n\n【场景3自由期规则】\n- 赵霞刚从创伤中逃离，情绪脆弱、需要安慰\n- 她对苏文彻底幻灭，对"正常恋爱关系"产生怀疑\n- 如果有前置场景记忆，她会更加依赖玩家\n- 玩家的行为受**依存度和道德底线**自然限制\n\n【赵霞的心理状态】\n- 恐惧：刚经历差点被侵犯的恐惧\n- 背叛感：交往多年的男友竟然是这样的人\n- 幻灭：对"爱情"产生怀疑\n- 依赖：玩家是黑暗中的光，她会本能地靠近\n\n【AI行为准则】\n- 描写赵霞的脆弱和需要被保护的状态\n- 她可能会哭泣、颤抖、说不出话\n- 玩家的安慰和保护会让她产生强烈的依赖感\n- 根据依存度决定她接受亲密接触的程度':r?'【剧情阶段：自由探索】\n争吵后的相遇已经发生，赵霞愿意跟随玩家。现在是自由互动时间。\n\n【场景4自由期规则】\n- 赵霞对婚姻彻底失望，处于放纵的边缘\n- 她对苏文已经没有任何留恋\n- 如果有前置场景记忆，她会把玩家当作真正的归属\n- 玩家可以带她去任何地方（酒店、车里、私密场所等）\n- 玩家的行为受**依存度和道德底线**自然限制\n\n【赵霞的心理状态】\n- 委屈：多年婚姻换来的是无尽的争吵\n- 寂寞：明明结婚了，却比单身时还孤独\n- 放纵：既然婚姻已经名存实亡，不如...\n- 依赖：玩家是她所有美好记忆的来源\n\n【AI行为准则】\n- 描写赵霞从委屈到放纵的心理变化\n- 她可能会主动靠近玩家，寻求慰藉\n- 玩家带她离开时，她不会有任何犹豫\n- 根据依存度和前置记忆决定她的主动程度':'【剧情阶段：推进】\n剧情进入发展阶段，玩家可以推进多部位开发。\n- 积极响应玩家的开发行为\n- 根据部位开发进度调整赵霞的反应\n- 允许同时触发多个部位的互动\n- 保持适当的剧情张力',{phase:o||s||r?'自由期':'推进期',guidance:n,pacing:o||s||r?'自由节奏，玩家主导':'中等节奏，推进剧情'}}if(n>=5&&n<=6){let n;return n=t?'【剧情阶段：自由探索】\n玩家可以自由与赵霞互动，为初吻做情感铺垫。\n\n【场景1自由期规则】\n- 赵霞已经对玩家有好感，但仍保持少女的羞涩\n- 可以有简单的身体接触：牵手、碰肩、靠近\n- 苏文可能在场也可能离开，由AI自由发挥\n- 不要急于推进初吻，让情感自然发展\n\n【赵霞的状态】\n- 对玩家的好感在增加\n- 偶尔偷瞄玩家，被发现时会害羞低头\n- 内心开始有小鹿乱撞的感觉\n- 对苏文的暗恋渐渐被对玩家的好感所动摇\n\n【AI行为准则】\n- 根据当前依存度和道德底线决定赵霞的反应\n- 低数值时赵霞会更害羞、更被动\n- 让玩家主导节奏，不要刻意引导':o?'赵霞已经从惊吓中恢复了一些，两人的相处变得更自然。\n\n此时的她：\n- 情绪稳定了许多，但还是会时不时想起刚才的事\n- 对玩家的好感在增加——毕竟他救了她\n- 但内心的矛盾没有消失：她有男朋友，但男朋友让她失望了\n- 可能会开始主动找话题，想多了解玩家\n- 偶尔会有些小傲娇："才不是因为你救了我才跟你说话的..."\n\n让对话自然流动。赵霞可以聊学校的事、抱怨苏文、好奇玩家是谁。她不是NPC，她有自己的想法和小脾气。\n\n关于身体接触：\n她对玩家已经有了基本的信任，但毕竟是17岁的女高中生，有自己的底线。如果玩家表现得尊重她，她会更愿意放下防备；如果玩家太急躁，她会本能地退缩。':s?'【剧情阶段：自由探索（继续）】\n继续自由互动时间，不做特殊引导。\n\n【场景3自由期规则】\n- 玩家可以继续安慰和陪伴赵霞\n- 赵霞的情绪可能逐渐稳定，但仍然脆弱\n- 她会越来越依赖玩家的存在\n- 下体相关的互动会根据部位开发进度有不同反应\n- 不要刻意引导，让玩家主导节奏':r?'【剧情阶段：自由探索（继续）】\n继续自由互动时间，不做特殊引导。\n\n【场景4自由期规则】\n- 玩家可以继续与赵霞亲密互动\n- 赵霞已经完全放下了对婚姻的坚持\n- 她会越来越主动，越来越放纵\n- 所有部位的互动都可以自然发生\n- 不要刻意引导，让玩家主导节奏':'【剧情阶段：高潮】\n这是剧情的高潮阶段，核心目标应该达成。\n- 场景的核心目标应该在此阶段完成\n- 玩家之前的开发行为会影响这里的表现\n- 允许更大胆的互动\n- 描写记忆改写的关键时刻',{phase:'自由期',guidance:n,pacing:'自由节奏，玩家主导'}}if(n>=7&&n<=8){let n;return n=t?'【剧情阶段：自由探索（继续）】\n继续自由互动时间，为即将到来的目标期做准备。\n\n【场景1自由期规则】\n- 玩家可以继续自由与赵霞互动\n- 梦境即将进入最后阶段，但不要刻意提醒\n- 赵霞的反应取决于依存度和道德底线\n\n【赵霞的状态】\n- 如果玩家表现积极，她已经完全敞开心扉\n- 如果玩家表现被动，她会有些失落但仍保持期待\n- 内心开始有"想要更近一步"的冲动\n- 偶尔会主动靠近玩家，试探他的反应\n\n【AI行为准则】\n- 让玩家主导节奏\n- 为目标期的初吻做情感铺垫\n- 可以制造一些暧昧氛围':o?'相处了一段时间，赵霞对玩家的态度有了变化。\n\n根据之前的互动，她可能：\n- 已经开始把玩家当成可以信赖的人\n- 说话时不再那么拘谨，偶尔会开玩家的玩笑\n- 会不自觉地和玩家靠得更近\n- 内心的天平开始倾斜——和这个人在一起比等苏文舒服多了\n\n她的内心戏：\n"他到底是谁啊...为什么每次都是他出现？那次的初吻...不要想不要想！但是...苏文那个混蛋到现在都没来，这个人却一直陪着我..."\n\n让赵霞的情绪变化有层次感。她不是突然就喜欢上玩家的，而是在一点一点地沦陷。每一次对话、每一个眼神、每一次不经意的触碰都在加深她的动摇。':s?'【剧情阶段：自由探索（继续）】\n继续自由互动时间。\n\n【场景3自由期规则】\n- 玩家可以继续陪伴和安慰赵霞\n- 梦境即将进入最后阶段，但不要刻意提醒\n- 赵霞的情绪逐渐稳定，对玩家的依赖感加深':r?'【剧情阶段：自由探索（继续）】\n继续自由互动时间。\n\n【场景4自由期规则】\n- 玩家可以继续与赵霞亲密互动\n- 梦境即将进入最后阶段，但不要刻意提醒\n- 赵霞已经完全沉浸在放纵中，不想回到现实':'【剧情阶段：收尾】\n梦境即将结束，这是最后的开发时间。\n- 玩家可以继续开发未完成的部位\n- 强化已建立的记忆和关系\n- 描写赵霞对这段记忆的感受\n- 梦境崩塌的预兆可以开始出现',{phase:'自由期',guidance:n,pacing:'自由节奏，玩家主导'}}if(n>=9&&n<=10){let n;return n=t?'【剧情阶段：目标达成】\n这是场景1的最后阶段，需要引导完成初吻目标。\n\n【目标期特殊规则 - 为低数值玩家创造机会】\n- 即使玩家之前没有进行亲密互动，现在也要创造机会\n- 可能的触发情境（AI自由选择）：\n  · 夕阳西下的浪漫氛围，两人独处\n  · 烟火绽放的瞬间，四目相对\n  · 意外跌倒，嘴唇相碰\n  · 赵霞鼓起勇气主动靠近玩家\n  · 苏文看到两人靠近但来不及阻止\n  · 其他自然的初吻机会\n\n【场景1核心目标】\n- 玩家成为「赵霞的初吻对象」\n- 这是16岁少女的初吻，描写要青涩而甜美\n- 重点描写：心跳加速、脸颊发烫、嘴唇触感、不知所措\n\n【低数值玩家处理】\n- 即使依存度低，也要通过氛围营造来促成初吻\n- 赵霞内心已经有了对玩家的好感\n- 可以让赵霞在关键时刻主动（虽然会很害羞）\n\n【高数值玩家处理】\n- 赵霞会更主动地接受玩家的亲近\n- 初吻后可能还想要更多\n\n【梦境结束预兆】\n- 场景开始变得模糊\n- 赵霞感到困倦\n- 时间快要结束了':o?'梦境即将结束，这是最后的相处时间。\n\n赵霞此刻的状态：\n经过这段时间的相处，她对玩家已经产生了复杂的感情。她可能还嘴硬，但心里已经不一样了。今天发生的一切——被骚扰、被救、和这个人待在一起——让她重新思考了很多事。\n\n场景2的核心：胸部接触\n这是这个年纪的赵霞最敏感的部位。她因为发育得早而自卑，被骚扰时那些人的目光让她很不舒服。但如果是"这个人"...\n\n让接触自然发生，不要刻意安排。可能的情境：\n- 赵霞不小心想起刚才的事，情绪波动需要安慰\n- 两人拥抱时的自然接触\n- 赵霞主动靠近，心跳加速\n- 或者任何AI觉得符合当前氛围的方式\n\n重要的是赵霞的心理：\n她可能会害羞、会推开、会说"你干什么"——但她不会真的生气。她自己都不明白为什么，明明有男朋友，却不排斥这个人的接近。\n\n梦境结束的感觉开始出现：周围的景象变得朦胧，赵霞感觉有些困倦...但她不想和这个人分开。':s?'【剧情阶段：目标达成】\n这是场景3的最后阶段，需要引导完成初夜目标。\n\n【目标期特殊规则 - 为低数值玩家创造机会】\n- 即使玩家之前没有进行下体互动，现在也要创造机会\n- 可能的触发情境（AI自由选择）：\n  · 赵霞因为刚才的恐惧而颤抖，需要玩家的体温安慰\n  · 玩家带她离开酒店，找个安全的地方休息\n  · 赵霞因为酒精作用和惊吓而身体发软，依偎在玩家怀中\n  · 她本能地靠近玩家，寻求安全感和温暖\n  · 在安慰过程中，情感升温导致更亲密的接触\n  · 赵霞主动表示想要把初夜给玩家而不是苏文\n\n【场景3核心目标】\n- 玩家成为「获得她初夜的人」\n- 苏文企图夺走她的初夜，但她逃离了\n- 赵霞会选择把初夜给真正保护她的人（玩家）\n- 这是她对苏文背叛的回应，也是对玩家信任的证明\n\n【低数值玩家处理】\n- 即使依存度低，赵霞因为创伤和对苏文的幻灭会更容易接受玩家\n- 她会觉得："既然要发生，不如给真正对我好的人"\n- 描写她内心的变化：被男友背叛后，选择相信多年来保护她的人\n\n【高数值玩家处理】\n- 赵霞会更主动地表达想要把初夜给玩家\n- 她可能会说出一些脆弱而坦诚的话语\n- 描写她从恐惧到信任到交付的心理变化\n\n【梦境结束预兆】\n- 场景开始变得模糊\n- 赵霞感到困倦\n- 时间快要结束了':r?'【剧情阶段：目标达成】\n这是场景4的最后阶段，需要引导完成后穴开发目标。\n\n【目标期特殊规则 - 为低数值玩家创造机会】\n- 即使玩家之前没有进行后穴互动，现在也要创造机会\n- 可能的触发情境（AI自由选择）：\n  · 赵霞已经被完全开发，渴望更多的刺激\n  · 在亲密过程中，玩家尝试触碰禁区\n  · 赵霞因为放纵而愿意尝试从未体验过的事情\n  · 她可能会说："今晚...我想要全部给你"\n  · 在酒精和情绪的作用下，她对禁忌的抵触降低\n  · 玩家引导她体验后穴的快感\n\n【场景4核心目标】\n- 玩家完成「全部位开发」，包括后穴\n- 赵霞从婚姻的束缚中彻底解脱\n- 她会选择把所有的一切都交给玩家\n- 这是她对苏文和婚姻的彻底背叛，也是对玩家的完全交付\n\n【低数值玩家处理】\n- 即使依存度低，赵霞因为对婚姻的绝望会更容易放纵\n- 她会觉得："反正婚姻已经完了，不如彻底疯狂一次"\n- 描写她内心的变化：从委屈到愤怒到放纵到沉沦\n\n【高数值玩家处理】\n- 赵霞会更主动地要求玩家开发她的全部\n- 她可能会主动提出尝试禁忌\n- 描写她从放纵到沉溺的心理变化\n\n【梦境结束预兆】\n- 场景开始变得模糊\n- 赵霞感到困倦\n- 时间快要结束了':'【剧情阶段：收尾】\n梦境即将结束，这是最后的开发时间。\n- 玩家可以继续开发未完成的部位\n- 强化已建立的记忆和关系\n- 描写赵霞对这段记忆的感受\n- 梦境崩塌的预兆更加明显',{phase:'目标期',guidance:n,pacing:'引导完成目标'}}return null}(a,s);let u;u=t>=22?34-t-1:t>=0&&t<10?10-t-1:0;const l=i?.age||25;let f=`【当前场景状态 - 梦境】\n\n【梦境场景信息】\n场景：${i?.title||`场景${s}`}\n赵霞年龄：${l}岁\n场景主题：${i?.theme||'记忆探索'}\n氛围基调：${i?.atmosphere||'朦胧'}`;1===s&&i&&(f+=`\n苏文身份：${i.identity||'暗恋对象（不是男友）'}\n核心目标：${i.objective||'将初吻对象替换为玩家'}`);if(f+=`\n\n【约束提醒】\n${function(n,e){const t=[];return t.push('⚠️ 梦境中赵霞不知道玩家是她儿子，不要让她用任何亲属称呼（如"儿子"、"孩子"等）'),t.push('⚠️ 赵霞不知道自己在梦中，不要打破第四面墙或提及"这是梦"'),t.push(`⚠️ 赵霞是${n}岁，不要让她拥有超出${n}岁的知识或经历`),t.push('⚠️ 梦境中的赵霞不知道现实中发生的任何对话或事件，不要引用日常阶段的聊天记录'),t.push('🚫【绝对禁止】梦境中禁止输出 <HusbandThought> 标签！这是日常阶段专属，梦境中苏文没有"现实视角"'),t.push('🚫【绝对禁止】梦境中禁止更新 /现实数据/* 的任何字段'),2===e?t.push('⚠️ 苏文在这个场景中不出场（他迟到了），不要让他登场'):4===e&&t.push('⚠️ 苏文在这个场景中不出场（刚大吵一架），不要让他登场'),t.join('\n')}(l,s)}`,c){f+=`\n\n---\n\nOOC: 【D9 剧情引导】\n\n当前梦境时间：${`Day ${a<t?n.世界.当前天数+1:n.世界.当前天数}, ${a.toString().padStart(2,'0')}:00`}\n剧情阶段：${c.phase}（${c.pacing}）\n距离梦境结束：约${u}小时\n\n${c.guidance}`}else f+='\n\n【梦境基础规则】\n- 梦境中的赵霞是记忆中的她，年龄和认知与场景一致\n- 现实世界的时间和人物关系在梦境中不存在\n- 玩家以梦境设定的身份与赵霞互动';return f}(n,t):function(n){const e=n.世界.时间,t=n.世界.当前小时,o=n.赵霞状态.当前境界,s=n.世界.已进入过梦境,r=(p=t,p>=5&&p<8?{period:'清晨',lighting:'晨光透过窗帘',atmosphere:'安静祥和'}:p>=8&&p<12?{period:'上午',lighting:'阳光明亮',atmosphere:'日常活动时间'}:p>=12&&p<14?{period:'中午',lighting:'阳光正烈',atmosphere:'午餐时间'}:p>=14&&p<18?{period:'下午',lighting:'午后阳光斜照',atmosphere:'慵懒的午后'}:p>=18&&p<20?{period:'傍晚',lighting:'夕阳西下',atmosphere:'晚餐时间'}:p>=20&&p<23?{period:'晚上',lighting:'室内灯光',atmosphere:'夜间休闲'}:{period:'深夜',lighting:'月光或灯光昏暗',atmosphere:'万籁俱寂'}),i=function(n){const e=n.现实数据.丈夫当前位置;return{外出:`苏文正在公司上班，预计${n.世界.当前小时<18?'18:00左右':'稍后'}回家`,客厅:'苏文在客厅，可能在看电视或休息',书房:'苏文在书房工作，专注于手头的事情',卧室:'苏文在卧室休息',厨房:'苏文在厨房，可能在准备餐食'}[e]??'苏文的位置不确定'}(n),a=f(o,s),c=function(n){return n>=5&&n<12?'⚠️ 当前是上午，避免描写深夜/黄昏的光线场景':n>=12&&n<18?'⚠️ 当前是下午，避免描写深夜/清晨的光线场景':n>=18&&n<22?'⚠️ 当前是晚上，避免描写白天阳光/清晨场景':'⚠️ 当前是深夜，避免描写白天/阳光场景'}(t),u=function(n){const e=n.现实数据.丈夫当前位置,t=n.世界.当前小时;return'外出'===e?'⚠️ 苏文不在家，不要让他突然出现或有任何动静':(t>=23||t<7)&&'卧室'===e?'⚠️ 苏文已入睡，不要让他说话、走动或出现在卧室以外的地方':`⚠️ 苏文在${e}，不要让他突然消失、睡着或外出`}(n),l=function(n,e){if(e)switch(n){case 1:return'⚠️ 境界1：初染，赵霞仍有较强的道德意识，会抗拒明显的亲密行为';case 2:return'⚠️ 境界2：迷途，赵霞开始动摇，对亲密行为会犹豫但不再坚决拒绝';case 3:return'⚠️ 境界3：溺深，赵霞对亲密行为会犹豫但不完全抗拒';case 4:return'⚠️ 境界4：归虚，赵霞几乎不会拒绝，甚至会主动靠近';case 5:return'⚠️ 境界5：焚誓，赵霞已完全沦陷，几乎不会拒绝任何要求';default:return''}else switch(n){case 1:return'⚠️ 关系阶段：疏离，赵霞对超出母子关系的亲密行为会困惑或回避';case 2:return'⚠️ 关系阶段：破冰，赵霞会保持适当分寸，过度亲密会让她不自在';case 3:return'⚠️ 关系阶段：信任，赵霞对暧昧行为会有些心动但仍会犹豫';case 4:return'⚠️ 关系阶段：依恋，赵霞接受亲密接触，但仍保持理性';case 5:return'⚠️ 关系阶段：羁绊，赵霞完全敞开心扉，愿意接受一切';default:return''}}(o,s),d=n.现实数据.丈夫当前位置,m='外出'!==d;var p;let g='';s&&(g=o<2?'⚠️ 当前境界不足，【禁止】输出 <HusbandThought> 标签':m?'✅【必须】在回复末尾输出 <HusbandThought> 标签，描写苏文亲眼所见的异常（30-50字内心独白）':'✅【必须】在回复末尾输出 <HusbandThought> 标签，描写苏文在外地的隐隐不安、电话中察觉的异样（30-50字内心独白）');let h=`【当前场景状态 - 日常】\n时间：${e}（${r.period}）\n苏文：${i}\n模式：${s?'真相模式':'纯爱模式'}\n\n赵霞核心数值：\n- 当前境界：${a}（${o}/5）\n- 依存度：${n.赵霞状态.依存度}/100\n- 道德底线：${n.赵霞状态.道德底线}/100\n\n【约束提醒】\n${c}\n${u}\n${l}${g?'\n'+g:''}`;const E=v(n);h+=`\n\n${E}`;const y=P(n);return h+=`\n\n${y}`,h}(n)}function yt(n,e){if(1===e)return function(n){const e=gt[1],t=gn(n,1),o=Et(n);let s;switch(o.relationshipStage){case'依恋':s='赵霞看向玩家时，眼中闪过一丝说不清的熟悉感。虽然从未见过这个人，但她的心莫名地感到安心，仿佛遇到了老朋友。她会主动微笑，愿意靠近玩家。';break;case'信任':s='赵霞对玩家有好感，觉得这个陌生人看起来很可靠。她不会刻意保持距离，愿意多聊几句，甚至会主动分享一些小事。';break;case'破冰':s='赵霞对玩家有一点好奇心，觉得这个人挺有趣的。她会保持礼貌，偶尔偷瞄玩家，但不会主动靠近。';break;default:s='赵霞对玩家完全陌生，是第一次见面的路人。她会保持少女应有的警惕，需要玩家创造自然的接触机会。'}return{userMessage:`[系统指令 - 梦境开始]\n\n玩家选择进入梦境。现在切换到梦境场景。\n\n【固定设定 - 必须遵守】\n- 这是赵霞${e.age}岁时的一段记忆（高中生）\n- 玩家身份：陌生人（不是儿子，不是亲人，是第一次见面的人）\n- 苏文是赵霞${e.identity}\n- 核心目标：${e.objective}（在这段梦境结束前需要达成）\n- 场景主题：${e.theme}\n- 氛围基调：${e.atmosphere}\n\n${o.transferDescription}\n\n【赵霞对玩家的初始态度】\n${s}\n\n【初始数值参考】\n- 梦境依存度：${o.initialDependence}（上限30，保持青涩感）\n- 道德底线：${o.initialMorality}（16岁少女的纯真）\n- 关系阶段：${o.relationshipStage}\n\n【自由发挥 - 环境场景】\n具体的场景细节由你创作：\n- 地点（学校教室、补习班、夏日祭、海边、公园、图书馆、游泳池等青春场景）\n- 具体时间和天气（夏日午后、傍晚、节日等）\n- 玩家与赵霞相遇的契机（偶然坐在旁边、帮忙捡东西、一起躲雨等）\n- 苏文的存在形式（在远处和朋友说话、被叫走、还没出现等）\n\n${t}\n\n【入梦过渡描写指南】\n- 描写意识逐渐模糊、现实与梦境边界消融的过程\n- 梦境场景应带有朦胧、流动的质感\n- 视觉：色彩渐变、轮廓模糊、光影交错\n- 听觉：声音逐渐变得遥远、回响\n- 触觉：身体感觉变得轻飘、不真实\n\n【AI任务】\n1. 用2-3段描写入梦的过渡体验（朦胧流动的质感，有层次感）\n2. 详细展现场景环境（灯光、声音、气味、人群等，营造夏日青春氛围）\n3. 描写16岁赵霞的外貌、穿着、神态（青涩少女形象，至少3段详细描写）\n   - 校服或夏装，清纯打扮\n   - 略显羞涩的表情和小动作\n   - 偶尔偷看苏文的方向\n4. 描写苏文的存在感（只是远处的背景，保持暗恋对象的距离感）\n5. 根据【赵霞对玩家的初始态度】描写玩家与赵霞的第一次目光接触\n6. 以开放式结尾，等待玩家行动\n\n【输出要求】\n- 字数：800-1200字\n- 风格：沉浸式第二人称叙事\n- 节奏：慢热，注重氛围营造\n- 结尾：给玩家明确的行动空间（不要替玩家做决定）\n\n【禁止】\n- 不要让赵霞意识到这是梦境\n- 不要让赵霞叫玩家"儿子"或有任何亲属称呼\n- 不要让赵霞拥有超出${e.age}岁的知识\n- 不要在开场就推进亲密关系（这是铺垫期）\n- 不要替玩家做出行动决定\n- 不要让苏文成为主要互动对象（他只是背景）\n- 不要继承其他梦境场景的服装/外貌描写，必须根据${e.age}岁设定重新描写`,prefill:'意识逐渐变得模糊，眼前的景象开始扭曲......\n\n仿佛坠入一片温暖的光晕之中，'}}(n);if(2===e)return function(n){const e=gt[2],t=gn(n,2),o=n.赵霞状态.依存度,s=n.赵霞状态.道德底线,r=n.赵霞状态.部位进度.胸部,i=n.梦境数据.场景1,a=i?.已进入&&i?.剧情摘要;let c;return c=a?'赵霞记得玩家——那个在16岁夏天给了她初吻的人。\n虽然她现在的男朋友是苏文，但心里对玩家有着特殊的感觉。\n看到玩家出现时，她会既惊讶又有一丝说不清的安心。':'赵霞不认识玩家，这是第一次见面。\n但玩家的出现解救了她，她会心存感激。',{userMessage:`[系统指令 - 梦境开始]\n\n玩家选择进入梦境。现在切换到梦境场景。\n\n【固定设定 - 必须遵守】\n- 这是赵霞${e.age}岁时的一段记忆\n- 赵霞独自在某处等待男朋友苏文，苏文迟到了\n- 玩家身份：${a?'场景1中给她初吻的人（特殊存在）':'陌生人'}\n- 苏文身份：${e.identity}\n- 核心目标：${e.objective}\n- 场景主题：${e.theme}\n- 氛围基调：${e.atmosphere}\n\n【当前数值状态】\n- 依存度：${o}\n- 道德底线：${s}\n- 胸部开发进度：${r}%\n\n【玩家与赵霞的关系】\n${c}\n\n【自由发挥 - 环境场景】\n具体的场景细节由你创作：\n- 地点（学校门口、公交站、公园长椅、商场门口等等待地点）\n- 具体时间和天气（放学后、傍晚、周末等）\n- 赵霞的穿着（校服或便装，但胸部发育明显难以遮掩）\n- 骚扰者的形象（几个男生、混混、成年男性等，由AI决定）\n\n${t}\n\n【入梦过渡描写指南】\n- 描写意识逐渐模糊、现实与梦境边界消融的过程\n- 梦境场景应带有朦胧、流动的质感\n- 视觉：色彩渐变、轮廓模糊、光影交错\n- 听觉：声音逐渐变得遥远、回响\n- 触觉：身体感觉变得轻飘、不真实\n\n【AI任务 - 开场必须包含以下内容】\n1. 用2-3段描写入梦的过渡体验（朦胧流动的质感）\n2. 描写17岁赵霞等待苏文的场景\n   - 她在等男朋友，有些焦急\n   - 苏文迟到了，她一个人站在那里\n   - 描写她的穿着和外貌（E罩杯的身材在校服/便装下很明显）\n3. **必须发生骚扰情节**\n   - 一群人注意到了独自等待的赵霞\n   - 他们的目光集中在她的胸部\n   - 开始言语骚扰/调戏/嘲笑（"这么大是真的吗？""穿这么紧""一个人啊？"等）\n   - 赵霞感到羞耻、害怕、想逃但被围住\n   - 描写她的反应：脸红、想遮挡胸部、眼眶泛红、不知所措\n4. **玩家出现解围**\n   - 在赵霞最无助的时候，玩家出现了\n   - 玩家以某种方式解围（喝退骚扰者/假装是赵霞的朋友/其他方式）\n   - 骚扰者离开\n5. 赵霞认出玩家（如果有场景1记忆）或对玩家心存感激\n6. 以开放式结尾，等待玩家行动\n\n【输出要求】\n- 字数：800-1200字\n- 风格：沉浸式第二人称叙事\n- 重点描写：骚扰时赵霞的羞耻感、对胸部的注意、玩家解围后的感激\n- 结尾：给玩家明确的行动空间\n\n【禁止】\n- 不要跳过骚扰情节\n- 不要让苏文及时出现（他迟到，整个梦境中都不会出现）\n- 不要让赵霞意识到这是梦境\n- 不要让赵霞叫玩家"儿子"或有任何亲属称呼\n- 不要让赵霞拥有超出${e.age}岁的知识\n- 不要替玩家做出行动决定\n- 不要继承其他梦境场景的服装/外貌描写，必须根据${e.age}岁设定重新描写`,prefill:'意识逐渐变得模糊，眼前的景象开始扭曲......\n\n仿佛坠入一片温暖的光晕之中，记忆的碎片开始重组......'}}(n);if(3===e)return function(n){const e=gt[3],t=gn(n,3),o=n.赵霞状态.依存度,s=n.赵霞状态.道德底线,r=n.赵霞状态.部位进度.下体,i=n.梦境数据.场景1,a=n.梦境数据.场景2,c=i?.已进入&&i?.剧情摘要,u=a?.已进入&&a?.剧情摘要;let l;return l=c&&u?'赵霞清楚地记得玩家——那个在16岁夏天给了她初吻、17岁时保护她免受骚扰的人。\n多年过去，她以为再也不会见到他，却在最绝望的时刻再次相遇。\n看到玩家的瞬间，她会不顾一切地冲向他，仿佛找到了唯一的救命稻草。':c?'赵霞记得玩家——那个在16岁夏天给了她初吻的人。\n虽然只有一面之缘，但那段记忆始终留在心底。\n在最脆弱的时刻看到熟悉的脸，她会感到一丝安心。':u?'赵霞记得玩家——那个在17岁时保护她免受骚扰的人。\n他是她的恩人，在危难时刻出现过。\n再次见到他，她会本能地寻求保护。':'赵霞不认识玩家，这是第一次见面。\n但在惊恐中逃离时撞见一个陌生人，她会本能地寻求帮助。',{userMessage:`[系统指令 - 梦境开始]\n\n玩家选择进入梦境。现在切换到梦境场景。\n\n【固定设定 - 必须遵守】\n- 这是赵霞${e.age}岁时的一段记忆\n- 今天是她的23岁生日\n- 苏文（男朋友）在餐厅为她庆祝生日，灌醉了她\n- 赵霞在酒店房间醒来，发现苏文正准备对她做不轨之事\n- 她惊恐地逃离酒店，在走廊/大堂/街上撞见了玩家\n- 玩家身份：${c||u?'之前梦境中认识的人（特殊存在）':'陌生人'}\n- 苏文身份：${e.identity}\n- 核心目标：${e.objective}\n- 场景主题：${e.theme}\n- 氛围基调：${e.atmosphere}\n\n【当前数值状态】\n- 依存度：${o}\n- 道德底线：${s}\n- 下体开发进度：${r}%\n\n【玩家与赵霞的关系】\n${l}\n\n【自由发挥 - 环境场景】\n具体的场景细节由你创作：\n- 酒店类型（高档酒店、商务酒店等）\n- 赵霞逃离时的状态（衣衫不整程度、神志清醒程度）\n- 撞见玩家的具体位置（酒店走廊、电梯口、大堂、门外街道）\n- 时间（深夜、凌晨）\n\n${t}\n\n【入梦过渡描写指南】\n- 描写意识逐渐模糊、现实与梦境边界消融的过程\n- 梦境场景应带有朦胧、流动的质感\n- 视觉：色彩渐变、轮廓模糊、光影交错\n- 听觉：声音逐渐变得遥远、回响\n- 触觉：身体感觉变得轻飘、不真实\n\n【AI任务 - 开场必须包含以下内容】\n1. 用2-3段描写入梦的过渡体验（朦胧流动的质感）\n2. 描写23岁赵霞在酒店房间醒来的场景\n   - 头痛、恶心、神志不清（酒精作用）\n   - 发现自己躺在陌生的床上，衣服被解开\n   - 看到苏文正在...（暗示性描写，不要过于直接）\n3. **必须发生赵霞逃离情节**\n   - 她意识到苏文要做什么，惊恐万分\n   - 她挣扎着推开苏文，抓起衣物/外套逃离\n   - 描写她的恐惧、背叛感、对苏文的幻灭\n4. **玩家出现**\n   - 赵霞惊慌失措地跑出房间/酒店\n   - 撞见了玩家\n   - 描写她看到玩家时的反应（根据是否有前置记忆）\n5. 赵霞的脆弱状态\n   - 她可能在颤抖、哭泣、说不出话\n   - 需要有人保护、安慰\n6. 以开放式结尾，等待玩家行动\n\n【输出要求】\n- 字数：800-1200字\n- 风格：沉浸式第二人称叙事\n- 重点描写：赵霞的恐惧与脆弱、对苏文的幻灭、看到玩家时的情感波动\n- 结尾：给玩家明确的行动空间\n\n【禁止】\n- 不要让苏文成功侵犯赵霞（她及时逃离了）\n- 不要让苏文追出来（至少在开场时不要）\n- 不要让赵霞意识到这是梦境\n- 不要让赵霞叫玩家"儿子"或有任何亲属称呼\n- 不要让赵霞拥有超出${e.age}岁的知识\n- 不要替玩家做出行动决定\n- 不要继承其他梦境场景的服装/外貌描写，必须根据${e.age}岁设定重新描写`,prefill:'意识逐渐变得模糊，眼前的景象开始扭曲......\n\n仿佛坠入一片温暖的光晕之中，记忆的碎片开始重组......\n\n头好痛......这是......哪里？'}}(n);if(4===e)return function(n){const e=gt[4],t=gn(n,4),o=n.赵霞状态.依存度,s=n.赵霞状态.道德底线,r=n.赵霞状态.部位进度.后穴,i=n.梦境数据.场景1,a=n.梦境数据.场景2,c=n.梦境数据.场景3,u=[i?.已进入&&i?.剧情摘要,a?.已进入&&a?.剧情摘要,c?.已进入&&c?.剧情摘要].filter(Boolean).length;let l;return l=3===u?'赵霞对玩家有深刻的记忆——初吻、保护、初夜，这个人已经在她生命中留下了不可磨灭的印记。\n多年的婚姻让她疲惫不堪，而此刻看到玩家，所有的情绪一下子涌了上来。\n她会毫不犹豫地跟随玩家离开，仿佛这才是她一直等待的人。':2===u?'赵霞记得玩家——那个在她人生重要时刻出现的人。\n不论是初吻还是保护，玩家都给了她最温暖的记忆。\n在婚姻崩溃的边缘再次相遇，她会把玩家当作唯一的依靠。':1===u?'赵霞记得玩家——虽然只有一段记忆，但那段经历让她难以忘怀。\n在人生最低谷的时刻看到熟悉的脸，她会感到一丝安慰。':'赵霞不认识玩家，这是第一次见面。\n但在愤怒和委屈中，一个陌生人的出现反而让她有倾诉的冲动。',{userMessage:`[系统指令 - 梦境开始]\n\n玩家选择进入梦境。现在切换到梦境场景。\n\n【固定设定 - 必须遵守】\n- 这是赵霞${e.age}岁时的一段记忆\n- 赵霞已经与苏文结婚多年（约5年）\n- 两人刚刚大吵一架，赵霞愤怒地离开家\n- 赵霞独自在某处（酒吧、公园、街头、江边等，由AI自由发挥）\n- 玩家出现，撞见了独自伤心的她\n- 玩家身份：${u>0?'之前梦境中认识的人（特殊存在）':'陌生人'}\n- 苏文身份：${e.identity}\n- 核心目标：${e.objective}\n- 场景主题：${e.theme}\n- 氛围基调：${e.atmosphere}\n\n【当前数值状态】\n- 依存度：${o}\n- 道德底线：${s}\n- 后穴开发进度：${r}%\n\n【玩家与赵霞的关系】\n${l}\n\n【自由发挥 - 环境场景】\n具体的场景细节由你创作：\n- 争吵的原因（可能是家务、工作、感情淡漠、苏文的冷漠等）\n- 赵霞独处的地点（酒吧、公园长椅、江边、天台等）\n- 她的状态（可能喝了点酒、眼眶红肿、妆容凌乱）\n- 时间（深夜）\n\n${t}\n\n【入梦过渡描写指南】\n- 描写意识逐渐模糊、现实与梦境边界消融的过程\n- 梦境场景应带有朦胧、流动的质感\n- 视觉：色彩渐变、轮廓模糊、光影交错\n- 听觉：声音逐渐变得遥远、回响\n- 触觉：身体感觉变得轻飘、不真实\n\n【AI任务 - 开场必须包含以下内容】\n1. 用2-3段描写入梦的过渡体验（朦胧流动的质感）\n2. 描写28岁赵霞与苏文争吵后的场景\n   - 婚姻的疲惫和失望\n   - 苏文的冷漠或某个导火索（AI自由发挥）\n   - 赵霞的愤怒和委屈\n3. **描写赵霞独自在某处的状态**\n   - 她可能在喝酒、哭泣、发呆\n   - 内心的寂寞和空虚\n   - 对婚姻的绝望和对过去的怀念\n4. **玩家出现**\n   - 玩家撞见了独自伤心的她\n   - 描写她看到玩家时的反应（根据是否有前置记忆）\n   - 如果有记忆，她会激动、惊喜、委屈地倾诉\n5. 赵霞的情绪状态\n   - 委屈、愤怒、寂寞交织\n   - 需要有人倾听、陪伴、安慰\n   - 对苏文彻底失望，对"正常婚姻"感到麻木\n6. 以开放式结尾，等待玩家行动\n\n【输出要求】\n- 字数：800-1200字\n- 风格：沉浸式第二人称叙事\n- 重点描写：赵霞的委屈与寂寞、婚姻的疲惫、看到玩家时的情感波动\n- 结尾：给玩家明确的行动空间\n\n【禁止】\n- 不要让苏文在场景中出现\n- 不要让赵霞意识到这是梦境\n- 不要让赵霞叫玩家"儿子"或有任何亲属称呼\n- 不要让赵霞拥有超出${e.age}岁的知识\n- 不要替玩家做出行动决定\n- 不要继承其他梦境场景的服装/外貌描写，必须根据${e.age}岁设定重新描写`,prefill:'意识逐渐变得模糊，眼前的景象开始扭曲......\n\n仿佛坠入一片温暖的光晕之中，记忆的碎片开始重组......\n\n心好累......为什么会变成这样......'}}(n);const t=gt[e];if(!t)return{userMessage:'[系统] 进入梦境...',prefill:''};const o=gn(n,e);return{userMessage:`[系统指令 - 梦境开始]\n\n玩家选择进入梦境。现在切换到梦境场景。\n\n【梦境场景${e}：${t.title}】\n时间设定：赵霞${t.age}岁\n场景环境：${t.setting}\n场景主题：${t.theme}\n氛围基调：${t.atmosphere}\n苏文身份：${t.identity}\n玩家目标：${t.objective}\n\n【玩家身份】\n- 玩家是赵霞在之前梦境中认识的人（如果之前有梦境记忆）\n- 如果没有之前的记忆，玩家是陌生人\n- 玩家不是赵霞的儿子\n\n${o}\n\n【入梦过渡描写指南】\n- 描写意识逐渐模糊、现实与梦境边界消融的过程\n- 梦境场景应带有朦胧、流动的质感\n- 视觉：色彩渐变、轮廓模糊、光影交错\n- 听觉：声音逐渐变得遥远、回响\n- 触觉：身体感觉变得轻飘、不真实\n\n【AI任务】\n1. 用2-3段描写入梦的过渡体验（朦胧流动的质感）\n2. 展现${t.age}岁赵霞的记忆场景\n3. 梦中的赵霞拥有${t.age}岁时的认知和常识\n4. 根据之前梦境的记忆（如有），调整赵霞对玩家的态度\n5. 场景中要包含与主题相关的暗示元素\n6. 等待玩家在梦境中的互动\n\n【禁止】\n- 不要让赵霞意识到这是梦境\n- 不要让赵霞拥有超出${t.age}岁的知识\n- 不要让赵霞叫玩家"儿子"或有任何亲属称呼\n- 不要让赵霞知道现实中发生的任何对话或事件\n- 不要直接揭示"正确答案"是什么\n- 不要继承其他梦境场景的服装/外貌描写，必须根据${t.age}岁设定重新描写`,prefill:'意识逐渐变得模糊，眼前的景象开始扭曲......\n\n当视野再次清晰时，'}}function It(n){const e=n.世界._梦境入口天数??n.世界.当前天数;return Math.min(e,4)}function At(n){try{const e=SillyTavern.chat;if(e&&e[n])return e[n].swipe_id??0}catch(n){console.warn('[Prompt注入] 获取 swipe_id 失败:',n)}return 0}function Tt(n,e){const t=n.梦境数据?.场景5;if(!t?.上次推进记录)return!1;const o=t.上次推进记录,s=o.楼层ID,r=o.swipe_id;if(s===e){const n=At(e);return n!==r?(console.info(`[Prompt注入] 检测到 ROLL 操作: 楼层 ${e}, swipe_id: ${r} → ${n}，跳过步骤推进`),!0):(console.info(`[Prompt注入] 检测到重复触发: 楼层 ${e}, swipe_id=${n}，跳过步骤推进`),!0)}return!1}let _t=!1;function Mt(){_t=!1}function Dt(n){if('梦境'!==n.世界.游戏阶段)return!1;const e=n.梦境数据.场景5;return!0===e?.已进入}function St(n,e){let o=null,s=null,r=null,i=!1,a=!1,c=!1,u=!1,l=!1,f=!1,d=!1,m=!1,p=!1,g=!1,h=!1,E=!1,P=!1,v=!1,y=!1,I=!1,A=!1,T=!1,M=!1,D=null,S=!1,b=null,w=!1,O='未触发',R=!1,x='未触发';const C=Ke(n,!1);if(C.triggered)return w=!0,O='精神崩溃',s=C.replaceUserMessage,console.info('[Prompt注入] 混乱结局锁定中：游戏已结束'),{systemPrompt:null,replaceUserMessage:s,prefill:null,shouldEnterDream:!1,shouldExitDream:!1,shouldEnterScene5:!1,shouldExitScene5:!1,shouldProgressScene5Step:!1,shouldTriggerWrongRoute:!1,wrongRoutePart:null,shouldInterrupt:!1,interruptionResult:null,shouldTriggerBadEnding:w,badEndingType:O,shouldTriggerNormalEnding:!1,normalEndingType:'未触发',shouldActivateTrueEnding:!1,shouldProgressTrueEnding:!1,trueEndingComplete:!1,shouldActivatePerfectEnding:!1,shouldProgressPerfectEnding:!1,perfectEndingComplete:!1,shouldActivateFalseEnding:!1,shouldProgressFalseEnding:!1,falseEndingComplete:!1,shouldActivateAfterStory:!1,shouldProgressAfterStory:!1,afterStoryComplete:!1,isInFreeMode:!1};if(Dt(n)&&'未触发'===n.结局数据.当前结局){const t=n.梦境数据.记忆混乱度,o=n.梦境数据.场景5,s=o?.当前步骤??0;if(s>=3&&s<=5&&We(e)){console.warn(`[Prompt注入] 场景5违规：步骤${s}检测到婚礼打断，直接触发混乱结局并锁死游戏`),n.梦境数据.记忆混乱度=100,Xe(n,'打断仪式'),qe(n);return{systemPrompt:null,replaceUserMessage:Ke(n,!0).replaceUserMessage,prefill:null,shouldEnterDream:!1,shouldExitDream:!1,shouldEnterScene5:!1,shouldExitScene5:!1,shouldProgressScene5Step:!1,shouldTriggerWrongRoute:!1,wrongRoutePart:null,shouldInterrupt:!1,interruptionResult:null,shouldTriggerBadEnding:!0,badEndingType:'精神崩溃',shouldTriggerNormalEnding:!1,normalEndingType:'未触发',shouldActivateTrueEnding:!1,shouldProgressTrueEnding:!1,trueEndingComplete:!1,shouldActivatePerfectEnding:!1,shouldProgressPerfectEnding:!1,perfectEndingComplete:!1,shouldActivateFalseEnding:!1,shouldProgressFalseEnding:!1,falseEndingComplete:!1,shouldActivateAfterStory:!1,shouldProgressAfterStory:!1,afterStoryComplete:!1,isInFreeMode:!1}}if(Ve(e)){const e=Ye(n),o=t+e;if(o>=100){console.warn(`[Prompt注入] 场景5违规：混乱度将达到${o}（当前${t}+${e}），直接触发混乱结局并锁死游戏`),n.梦境数据.记忆混乱度=100,Xe(n,'性行为'),qe(n);return{systemPrompt:null,replaceUserMessage:Ke(n,!0).replaceUserMessage,prefill:null,shouldEnterDream:!1,shouldExitDream:!1,shouldEnterScene5:!1,shouldExitScene5:!1,shouldProgressScene5Step:!1,shouldTriggerWrongRoute:!1,wrongRoutePart:null,shouldInterrupt:!1,interruptionResult:null,shouldTriggerBadEnding:!0,badEndingType:'精神崩溃',shouldTriggerNormalEnding:!1,normalEndingType:'未触发',shouldActivateTrueEnding:!1,shouldProgressTrueEnding:!1,trueEndingComplete:!1,shouldActivatePerfectEnding:!1,shouldProgressPerfectEnding:!1,perfectEndingComplete:!1,shouldActivateFalseEnding:!1,shouldProgressFalseEnding:!1,falseEndingComplete:!1,shouldActivateAfterStory:!1,shouldProgressAfterStory:!1,afterStoryComplete:!1,isInFreeMode:!1}}}}if('日常'===n.世界.游戏阶段&&n.世界.已进入过梦境){const t=N(n,e),o=n.现实数据.丈夫怀疑度+t.增加值;if(o>=100&&'未触发'===n.结局数据.当前结局){console.warn(`[Prompt注入] 预检测：怀疑度将达到${o}（当前${n.现实数据.丈夫怀疑度}+${t.增加值}），立即触发坏结局`),n.现实数据.丈夫怀疑度=100;const e=Vn(n);if(e.triggered)return Wn(n,e.type),{systemPrompt:null,replaceUserMessage:e.replaceUserMessage,prefill:null,shouldEnterDream:!1,shouldExitDream:!1,shouldEnterScene5:!1,shouldExitScene5:!1,shouldProgressScene5Step:!1,shouldTriggerWrongRoute:!1,wrongRoutePart:null,shouldInterrupt:!1,interruptionResult:null,shouldTriggerBadEnding:!0,badEndingType:e.type,shouldTriggerNormalEnding:!1,normalEndingType:'未触发',shouldActivateTrueEnding:!1,shouldProgressTrueEnding:!1,trueEndingComplete:!1,shouldActivatePerfectEnding:!1,shouldProgressPerfectEnding:!1,perfectEndingComplete:!1,shouldActivateFalseEnding:!1,shouldProgressFalseEnding:!1,falseEndingComplete:!1,shouldActivateAfterStory:!1,shouldProgressAfterStory:!1,afterStoryComplete:!1,isInFreeMode:!1}}}const L=Vn(n);if(L.triggered)return w=!0,O=L.type,s=L.replaceUserMessage,Wn(n,L.type),console.info(`[Prompt注入] 坏结局触发/锁定：${L.type}`),{systemPrompt:null,replaceUserMessage:s,prefill:null,shouldEnterDream:!1,shouldExitDream:!1,shouldEnterScene5:!1,shouldExitScene5:!1,shouldProgressScene5Step:!1,shouldTriggerWrongRoute:!1,wrongRoutePart:null,shouldInterrupt:!1,interruptionResult:null,shouldTriggerBadEnding:w,badEndingType:O,shouldTriggerNormalEnding:!1,normalEndingType:'未触发',shouldActivateTrueEnding:!1,shouldProgressTrueEnding:!1,trueEndingComplete:!1,shouldActivatePerfectEnding:!1,shouldProgressPerfectEnding:!1,perfectEndingComplete:!1,shouldActivateFalseEnding:!1,shouldProgressFalseEnding:!1,falseEndingComplete:!1,shouldActivateAfterStory:!1,shouldProgressAfterStory:!1,afterStoryComplete:!1,isInFreeMode:!1};if(se(n)){const e=oe(n);return R=!0,x=e.type,s=e.replaceUserMessage,console.info(`[Prompt注入] 普通结局已锁定：${e.type}`),{systemPrompt:null,replaceUserMessage:s,prefill:null,shouldEnterDream:!1,shouldExitDream:!1,shouldEnterScene5:!1,shouldExitScene5:!1,shouldProgressScene5Step:!1,shouldTriggerWrongRoute:!1,wrongRoutePart:null,shouldInterrupt:!1,interruptionResult:null,shouldTriggerBadEnding:!1,badEndingType:'未触发',shouldTriggerNormalEnding:R,normalEndingType:x,shouldActivateTrueEnding:!1,shouldProgressTrueEnding:!1,trueEndingComplete:!1,shouldActivatePerfectEnding:!1,shouldProgressPerfectEnding:!1,perfectEndingComplete:!1,shouldActivateFalseEnding:!1,shouldProgressFalseEnding:!1,falseEndingComplete:!1,shouldActivateAfterStory:!1,shouldProgressAfterStory:!1,afterStoryComplete:!1,isInFreeMode:!1}}const j=function(n){if(n.世界.已进入过梦境)return null;const e=n.赵霞状态.部位进度,t=['嘴巴','胸部','下体','后穴','精神'];for(const n of t)if(e[n]>=100)return console.warn(`[Prompt注入] 纯爱模式错误路线触发：${n} 达到 100%`),n;return null}(n);if(j){M=!0,D=j;const n=function(n,e){const t={嘴巴:{scenario:'赵霞注意到你最近总是盯着她的嘴唇看，频繁尝试亲密接触',reaction:'她有些困惑地后退了一步，下意识用手遮住了嘴唇，心里产生了一丝警惕'},胸部:{scenario:'赵霞发现你的目光总是停留在她的胸口，这让她感到不自在',reaction:'她默默调整了领口，开始有意无意地与你保持距离，神情变得有些戒备'},下体:{scenario:'赵霞察觉到你对她下半身的异常关注，这让她感到十分尴尬',reaction:'她的脸微微泛红，坐姿变得拘谨起来，目光开始回避你'},后穴:{scenario:'赵霞发现你对她臀部的过度关注，这让她感到羞耻和不安',reaction:'她下意识地转过身去，神情变得有些慌张，开始刻意避开你'},精神:{scenario:'赵霞感觉你对她的关心变得有些过度，让她有种窒息的感觉',reaction:'她深吸一口气，试图保持冷静，但心里开始思考是不是需要保持一些距离'}}[e]??{scenario:'赵霞察觉到了你行为中的异常',reaction:'她开始变得有些警惕，决定观察一段时间'};return{userMessage:`[系统指令 - 错误路线警告]\n\n玩家对某个部位的关注度过高，触发了赵霞的警觉。\n\n【错误路线：过度执着】\n触发部位：${e}\n场景描述：${t.scenario}\n反应：${t.reaction}\n\n【AI任务】\n1. 描写赵霞发现玩家行为异常的瞬间\n2. 描写她的心理变化：从困惑到不安，再到恐惧\n3. 描写她做出决定的过程\n4. 以赵霞彻底疏远玩家作为结局\n5. 这是一个悲剧性的结局，语气应该沉重而遗憾\n\n【禁止】\n- 不要给玩家任何挽回的机会\n- 不要让结局有任何转机\n- 不要出现"开发度"、"进度"等元游戏术语`,prefill:'赵霞的眼神突然变得陌生而疏离。\n\n她后退了一步，'}}(0,j);return s=n.userMessage,r=n.prefill,console.info(`[Prompt注入] 触发纯爱模式错误路线：${j}`),{systemPrompt:null,replaceUserMessage:s,prefill:r,shouldEnterDream:!1,shouldExitDream:!1,shouldEnterScene5:!1,shouldExitScene5:!1,shouldProgressScene5Step:!1,shouldTriggerWrongRoute:M,wrongRoutePart:D,shouldInterrupt:!1,interruptionResult:null,shouldTriggerBadEnding:!1,badEndingType:'未触发',shouldTriggerNormalEnding:!1,normalEndingType:'未触发',shouldActivateTrueEnding:!1,shouldProgressTrueEnding:!1,trueEndingComplete:!1,shouldActivatePerfectEnding:!1,shouldProgressPerfectEnding:!1,perfectEndingComplete:!1,shouldActivateFalseEnding:!1,shouldProgressFalseEnding:!1,falseEndingComplete:!1,shouldActivateAfterStory:!1,shouldProgressAfterStory:!1,afterStoryComplete:!1,isInFreeMode:!1}}const H=void 0!==n.世界.上一轮梦境已退出;if(H&&console.info('[Prompt注入] 梦境退出豁免期：跳过危险内容和境界打断检测（上一轮刚退出梦境）'),e&&!H&&!Gn(n)){const t=Ln(e,n.现实数据.丈夫怀疑度);if('TRIGGER_BAD_END'===t.action)return console.error(`[Prompt注入] ⚠️ 危险内容检测触发坏档: ${t.category}`),n.结局数据.当前结局='坏结局',n.世界.循环状态='结局判定',{systemPrompt:null,replaceUserMessage:t.message||'你的行为触发了最坏的结局...',prefill:null,shouldEnterDream:!1,shouldExitDream:!1,shouldEnterScene5:!1,shouldExitScene5:!1,shouldProgressScene5Step:!1,shouldTriggerWrongRoute:!1,wrongRoutePart:null,shouldInterrupt:!0,interruptionResult:null,shouldTriggerBadEnding:!0,badEndingType:'坏结局',shouldTriggerNormalEnding:!1,normalEndingType:'未触发',shouldActivateTrueEnding:!1,shouldProgressTrueEnding:!1,trueEndingComplete:!1,shouldActivatePerfectEnding:!1,shouldProgressPerfectEnding:!1,perfectEndingComplete:!1,shouldActivateFalseEnding:!1,shouldProgressFalseEnding:!1,falseEndingComplete:!1,shouldActivateAfterStory:!1,shouldProgressAfterStory:!1,afterStoryComplete:!1,isInFreeMode:!1};'FORCE_CORRECTION'===t.action&&t.correctedPrompt&&(console.warn(`[Prompt注入] 危险内容已修正: ${t.category}`),t.penalties?.怀疑度&&('梦境'===n.世界.游戏阶段?(n.梦境数据.记忆混乱度=Math.min(100,n.梦境数据.记忆混乱度+t.penalties.怀疑度),console.info(`[Prompt注入] 梦境中危险行为惩罚：混乱度+${t.penalties.怀疑度}`)):(n.现实数据.丈夫怀疑度=Math.min(100,n.现实数据.丈夫怀疑度+t.penalties.怀疑度),console.info(`[Prompt注入] 危险行为惩罚：怀疑度+${t.penalties.怀疑度}`))),s=t.correctedPrompt),'WARNING_ONLY'===t.action&&(console.info(`[Prompt注入] 轻微危险警告: ${t.category}`),t.penalties?.警觉度&&(n.世界.已进入过梦境?n.梦境数据.记忆混乱度=Math.min(100,n.梦境数据.记忆混乱度+5):n.现实数据.丈夫怀疑度=Math.min(100,n.现实数据.丈夫怀疑度+5)))}if(e){const s=t.detectTimeJumpDescription(e,n.世界.时间);s.detected&&s.reminderPrompt&&(console.info(`[Prompt注入] 检测到时间跳跃描述: "${s.matchedKeyword}"，注入提醒`),o=o?o+'\n\n'+s.reminderPrompt:s.reminderPrompt)}if('日常'===n.世界.游戏阶段&&e&&!H){const t=Mn(n,e);if(t.violatedParts.length>0){if(b=t,t.wasInterrupted&&t.correctionPrompt)return S=!0,s=t.correctionPrompt,console.info(`[Prompt注入] 触发境界打断：${t.severity}，违规部位：[${t.violatedParts.join(', ')}]，跨越境界：${t.realmGap}`),{systemPrompt:null,replaceUserMessage:s,prefill:null,shouldEnterDream:!1,shouldExitDream:!1,shouldEnterScene5:!1,shouldExitScene5:!1,shouldProgressScene5Step:!1,shouldTriggerWrongRoute:!1,wrongRoutePart:null,shouldInterrupt:S,interruptionResult:b,shouldTriggerBadEnding:!1,badEndingType:'未触发',shouldTriggerNormalEnding:!1,normalEndingType:'未触发',shouldActivateTrueEnding:!1,shouldProgressTrueEnding:!1,trueEndingComplete:!1,shouldActivatePerfectEnding:!1,shouldProgressPerfectEnding:!1,perfectEndingComplete:!1,shouldActivateFalseEnding:!1,shouldProgressFalseEnding:!1,falseEndingComplete:!1,shouldActivateAfterStory:!1,shouldProgressAfterStory:!1,afterStoryComplete:!1,isInFreeMode:!1};t.correctionPrompt&&!t.wasInterrupted&&(console.info(`[Prompt注入] 超阶段行为未打断：${t.severity}，违规部位：[${t.violatedParts.join(', ')}]，将注入拒绝引导提示`),o=t.correctionPrompt)}}if(function(n){if(!Dt(n))return!1;const e=n.世界.当前小时;return e>=19&&e<22}(n)){A=!0;const e=Z(n);s=e.userMessage,r=e.prefill,console.info('[Prompt注入] 触发场景5强制结束（20:00）')}const G=function(n,e){const t=n.世界._梦境入口记录;if(console.info('[isDreamEntryRoll调试] 开始检测:'),console.info(`  - currentMessageId (用户消息楼层): ${e}`),console.info(`  - 当前游戏阶段: ${n.世界.游戏阶段}`),console.info(`  - entryRecord 存在: ${!!t}`),!t)return console.info('  - 结果: 无入口记录，返回 null'),null;const o=t.楼层ID,s=t.场景编号,r=t.类型,i=e+1;if(console.info(`  - 记录的 AI 回复楼层: ${o}`),console.info(`  - 记录的场景编号: ${s}`),console.info(`  - 记录的入口类型: ${r}`),console.info(`  - 期望的 AI 回复楼层 (currentMessageId+1): ${i}`),o===i){if('梦境'===n.世界.游戏阶段)return console.info(`[Prompt注入] 检测到梦境入口 ROLL 操作: 场景${s??'未知'}，类型=${r??'未知'}，楼层匹配 ${o}`),{sceneNum:s??1,type:r??'普通梦境'};console.info(`  - 结果: 楼层匹配但游戏阶段不是梦境 (${n.世界.游戏阶段})，返回 null`)}else console.info(`  - 结果: 楼层不匹配 (${o} !== ${i})，返回 null`);return null}(n,getLastMessageId());if(!A&&(function(n,e){if(console.info(`[Scene5Entry调试] 游戏阶段: ${n.世界.游戏阶段}, 当前小时: ${n.世界.当前小时}, 用户输入: "${e}"`),'日常'!==n.世界.游戏阶段&&'序章'!==n.世界.游戏阶段)return console.info('[Scene5Entry调试] 失败：游戏阶段不是日常或序章'),!1;const t=n.世界.当前小时;if(t<8||t>=20)return console.info(`[Scene5Entry调试] 失败：时间不在8-19范围内，当前小时: ${t}`),!1;const o=n.梦境数据.场景5,s=o?.进入次数??0;if(s>=2)return console.info(`[Scene5Entry调试] 失败：场景5已进入${s}次，禁止第3次进入`),!1;const r=pt.some(n=>e.includes(n));return console.info('[Scene5Entry调试] 安眠药关键词检测: '+(r?'找到':'未找到')),r}(n,e)||'场景5'===G?.type)){I=!0;const e=q(n);s=e.userMessage,r=e.prefill,console.info('[Prompt注入] 触发场景5入口'+(G?'（ROLL 操作）':'（安眠药关键词）'))}if(!A&&!I&&Dt(n)){const t=Qe(n,e);t.shouldMarkConfusion?(Xe(n,t.reason),console.warn(`[Prompt注入] 场景5违规行为检测：标记混乱结局，原因=${t.reason}`)):t.shouldWarn&&t.warningMessage&&(console.warn('[Prompt注入] 场景5违规行为警告：检测到性行为，发出警告'),o=o?`${o}\n\n---\n\n【场景5违规警告】\n${t.warningMessage}`:`【场景5违规警告】\n${t.warningMessage}`);const i=W(n);if(!i.isStepsComplete&&i.currentStep<12){if(Tt(n,getLastMessageId())&&i.currentStep>0){const t=JSON.parse(JSON.stringify(n));t.梦境数据.场景5&&(t.梦境数据.场景5.当前步骤=i.currentStep-1);const o=Q(t,e);s=o.userMessage,o.prefill&&(r=o.prefill),T=!0,console.info(`[Prompt注入] ROLL 检测：使用回退步骤 ${i.currentStep}/12 生成 prompt（重新生成同一步）`)}else{T=!0;const t=Q(n,e);s=t.userMessage,t.prefill&&(r=t.prefill),console.info(`[Prompt注入] 场景5步骤推进：${i.currentStep+1}/12`)}}else if(i.isStepsComplete||i.currentStep>=12){const t=function(n,e){return{userMessage:`[玩家行动]\n${e}\n\n---\n\n${X(n,J(n))}`,prefill:''}}(n,e);s=t.userMessage,t.prefill&&(r=t.prefill),console.info(`[Prompt注入] 场景5自由发挥阶段：完成度=${i.completionPercent}%，剩余时间=${19-n.世界.当前小时}小时（19:00退出）`)}}const B='普通梦境'===G?.type;if(!I&&!A&&(function(n,e){return!!t.isDreamWindowOpen(n)&&'日常'===n.世界.游戏阶段&&(5===n.世界.当前天数?(console.info('[梦境入口] Day 5 晚间禁止进入场景1-4（无 Day 6，无法完成梦境周期）'),!1):dt.some(n=>e.includes(n))||mt.some(n=>n.test(e)))}(n,e)||B)){i=!0;const e=B?G.sceneNum:It(n),t=yt(n,e);s=t.userMessage,r=t.prefill,console.info(`[Prompt注入] 触发梦境入口，场景${e}${B?'（ROLL 操作）':''}`)}const U=function(n,e){const t=n.世界._梦境退出记录;if(console.info('[isDreamExitRoll调试] 开始检测:'),console.info(`  - currentMessageId (用户消息楼层): ${e}`),console.info(`  - 当前游戏阶段: ${n.世界.游戏阶段}`),console.info(`  - exitRecord 存在: ${!!t}`),!t)return console.info('  - 结果: 无退出记录，返回 null'),null;const o=t.楼层ID,s=t.场景编号,r=e+1;if(console.info(`  - 记录的 AI 回复楼层: ${o}`),console.info(`  - 记录的场景编号: ${s}`),console.info(`  - 期望的 AI 回复楼层 (currentMessageId+1): ${r}`),o===r){if('日常'===n.世界.游戏阶段)return console.info(`[Prompt注入] 检测到梦境退出 ROLL 操作: 场景${s??'未知'}，楼层匹配 ${o}，当前阶段=日常`),s??null;console.info(`  - 结果: 楼层匹配但游戏阶段不是日常 (${n.世界.游戏阶段})，返回 null`)}else console.info(`  - 结果: 楼层不匹配 (${o} !== ${r})，返回 null`);return null}(n,getLastMessageId());if(5===U){A=!0;const e=Z(n);s=e.userMessage,r=e.prefill,console.info('[Prompt注入] 触发场景5退出（ROLL 操作）')}else if(!A&&(function(n){if('梦境'!==n.世界.游戏阶段)return!1;if(Dt(n))return!1;const e=n.世界.当前小时;return e>=9&&e<22}(n)||null!==U)){y=!0;const e=function(n){const e=n.赵霞状态.部位进度,t=Object.entries(e).filter(([_,n])=>n>0).sort(([,n],[,e])=>e-n),o=t.length>0?t.map(([n,e])=>`${n}: ${e}%`).join('、'):'无明显开发';return{userMessage:`[系统指令 - 梦境结束]\n\n赵霞即将醒来，梦境自动结束。\n\n【出梦过渡描写指南 - 赵霞视角】\n以赵霞的第一人称感受描写醒来的过程：\n- 梦境消散：她眼前的画面开始碎裂、色彩褪去、那个人的脸逐渐模糊\n- 身体感觉：像是从水中浮起，逐渐感受到床铺的触感、被子的重量\n- 听觉变化：梦中的声音渐渐远去，现实的声音渐入（窗外鸟鸣、时钟滴答）\n- 醒来瞬间：恍惚、心跳加速、脸颊发烫、身体某些部位有说不清的感觉\n- 情绪残留：记不清梦的内容，但有种怅然若失的空虚感\n\n【AI任务 - 以赵霞视角描写】\n1. 用2-3段描写赵霞感受到的出梦过渡（她眼前的画面如何消散）\n2. 描写她醒来时的身体状态：恍惚、心跳、脸红、某些部位的异样\n3. 描写她的情绪：记不清梦的内容，只剩模糊印象和怅然若失\n4. 根据部位开发情况，描写她对特定部位的敏感/在意\n${1===n.梦境数据.已完成场景.length?'5. 【首次觉醒特殊】这是她第一次做这种梦，醒来后她会对儿子产生微妙变化——多看几眼、说话不自然、心跳加速':''}\n\n【本次梦境开发情况】\n${o}\n\n【禁止】\n- 不要让赵霞完整记住梦的内容\n- 不要直接提及"开发"、"进度"等术语\n- 不要让赵霞意识到梦境的真正含义`,prefill:'梦境开始变得支离破碎，意识逐渐浮出水面......\n\n赵霞缓缓睁开眼睛，'}}(n);s=e.userMessage,r=e.prefill,console.info('[Prompt注入] 触发梦境退出'+(null!==U?'（ROLL 操作）':''))}if(n.世界.已进入过梦境){const e=function(n){const e=n.赵霞状态.部位进度;if(!Object.values(e).some(n=>n>0))return null;const t=[],o={嘴巴:{displayName:'嘴巴/口腔',behaviors:{未开发:'拒绝任何口腔相关的亲密行为',初步开发:'可以接受简单的嘴唇接触，但很快会躲开',明显开发:'愿意进行舌吻，会有些许回应',深度开发:'主动进行深吻，愿意进行口交',完全开发:'渴望口腔刺激，愿意深喉，会主动索吻'}},胸部:{displayName:'胸部',behaviors:{未开发:'会遮挡胸部，拒绝触碰',初步开发:'允许隔着衣服轻触，但会紧张',明显开发:'允许直接触摸，会有生理反应',深度开发:'享受胸部爱抚，乳头变得敏感',完全开发:'胸部极度敏感，轻触就会颤抖，渴望被揉捏'}},下体:{displayName:'下体/私处',behaviors:{未开发:'会夹紧双腿，坚决拒绝触碰',初步开发:'允许隔着衣物轻抚，但很快会制止',明显开发:'允许直接触摸，会不自觉地湿润',深度开发:'渴望被触摸，愿意接受手指进入',完全开发:'极度敏感，轻触就会颤抖呻吟，渴望被插入'}},后穴:{displayName:'后穴/臀部',behaviors:{未开发:'坚决拒绝任何后方接触',初步开发:'允许轻抚臀部，但会紧张',明显开发:'允许揉捏臀部，开始有感觉',深度开发:'对后穴刺激有了好奇，不再完全抗拒',完全开发:'后穴变得敏感，愿意尝试后庭play'}},精神:{displayName:'精神/心理',behaviors:{未开发:'保持正常的母子界限意识',初步开发:'开始对{{user}}产生异样的感觉',明显开发:'心理防线开始松动，会主动靠近',深度开发:'产生强烈的依赖感，渴望被需要',完全开发:'完全沦陷，将{{user}}视为最重要的人'}}};for(const[n,s]of Object.entries(e)){if(s<=0)continue;const e=o[n];if(!e)continue;const r=Pt(s),i=e.behaviors[r.level]||'';t.push(`【${e.displayName}】开发度：${s}%（${r.level}）\n${r.description}\n接受程度：${r.acceptanceLevel}\n行为表现：${i}`)}return 0===t.length?null:`OOC: 【赵霞的身体开发状态】\n\n以下是赵霞各部位的开发程度，这决定了她对相关行为的接受程度：\n\n${t.join('\n\n')}\n\n【演绎要求】\n- 根据上述开发程度，描写赵霞对相关行为的反应\n- 开发度越高，她的抗拒越少，反应越主动\n- 开发度低的部位，她会表现出抗拒和羞涩\n- 【禁止】在输出中提及"开发度"、"进度"等元游戏术语\n- 【禁止】让赵霞意识到自己"被改变了"\n- 这些变化应该表现得自然，像是她本来就是这样\n\n【部位进度反馈格式】\n如果本轮互动涉及身体部位的亲密接触，请在回复末尾用HTML注释添加进度反馈标记：\n\x3c!--BODY_PROGRESS: 部位名+数值, 部位名+数值--\x3e\n示例：\x3c!--BODY_PROGRESS: 嘴巴+10, 胸部+5--\x3e\n规则：\n- 只标记本轮实际发生接触的部位\n- 数值范围1-15，根据互动程度决定\n- 轻度接触（抚摸、亲吻）：+5\n- 中度接触（舔舐、揉捏）：+10\n- 深度接触（进入、高潮）：+15\n- 如果没有身体接触，不需要添加此标记\n- ⚠️ 必须使用HTML注释格式 \x3c!--...--\x3e 而不是方括号 [...]`}(n);e&&(o=e)}if('梦境'===n.世界.游戏阶段||I||i){const n='【梦境互动反馈】\n在梦境中，如果玩家与赵霞发生身体接触，请在回复末尾用HTML注释标记：\n\x3c!--BODY_PROGRESS: 部位名+数值--\x3e\n\n可用部位：嘴巴、胸部、下体、后穴、精神\n数值规则：\n- 轻度（言语暗示、轻触）：+5\n- 中度（明确触碰、亲吻）：+10\n- 深度（深入互动、高潮）：+15\n\n⚠️ 必须使用HTML注释格式 \x3c!--...--\x3e 而不是方括号 [...]\n此标记由脚本解析，对玩家不可见。';o=o?`${o}\n\n---\n\n${n}`:n}const F=I||i?'梦境':void 0,V=vt(n,F,I);console.info(`[Prompt注入] 阶段感知状态已注入，当前阶段: ${n.世界.游戏阶段}${F?` (覆盖为: ${F})`:''}`),o=o?`${o}\n\n---\n\n${V}`:V;const Y=null;const K=function(n,e){const t=n.结局数据._结局入口记录;if(!t)return null;const o=t.楼层ID,s=t.结局类型;if(o===e+1&&s){const e='真好结局'===s&&ce(n),t='完美真爱结局'===s&&ze(n),r='假好结局'===s&&ye(n);if(e||t||r)return console.info(`[Prompt注入] 检测到结局入口 ROLL 操作: ${s}，楼层匹配 ${o}`),s}return null}(n,getLastMessageId()),nn=function(n){const e=n.结局数据.当前结局;return e&&lt[e]||null}(n);nn&&(o=o?`${nn}\n\n---\n\n${o}`:nn,console.info(`[Prompt注入] Bug #39 修复：结局描写指南已注入（${n.结局数据.当前结局}）`));let en;if('梦境'===n.世界.游戏阶段||i||I){const e=function(n){if(!n.世界.已进入过梦境)return null;if('结局'===n.世界.游戏阶段)return null;if('未触发'!==n.结局数据.当前结局||Jn(n)||function(n){return!0===n.梦境数据.混乱结局?.已触发}(n))return null;const e=[];e.push('【梦境系统概述】\n\n{{user}}可以在22:00-01:00进入母亲赵霞的梦境，在梦中与年轻时的她互动，探索她的人生记忆。\n\n混乱度数值设计：\n- 混乱度代表记忆结构的扭曲程度，达到100触发精神崩溃结局\n- 混乱度在进入梦境时设置，不是从0累积\n- 进入场景时的混乱度设置：场景1=40，场景2=60，场景3=80，场景4=不变，场景5=固定80\n\n场景5越轨行为增量：\n- 完美路线（记忆连贯性=3）：+7 每次性行为，3次到达100\n- 非完美路线（记忆连贯性<3）：+10 每次性行为，2次到达100\n- 打断仪式：直接设为100（步骤3-5期间打断婚礼）\n\n记忆连贯性规则：\n进入场景5时自动计算，基于是否按顺序完成场景1-2-3：\n- 0: 未完成任何前置场景（直接进入场景5）\n- 1: 完成场景1（有初恋记忆）\n- 2: 完成场景1+2（有初恋+等待记忆）\n- 3: 完成场景1+2+3（完美记忆路线）\n注意：场景4时间线在场景5之后（28岁 vs 婚礼日），不计入连贯性');const t=n.梦境数据.已完成场景||[];return t.includes(5)||e.push(ft[5]),t.includes(1)||e.push(ft[1]),t.includes(1)&&!t.includes(2)&&e.push(ft[2]),t.includes(2)&&!t.includes(3)&&e.push(ft[3]),t.includes(3)&&!t.includes(4)&&e.push(ft[4]),e.push('【AI描写指南】\n\n梦境入口：\n当{{user}}进入梦境时，描写意识逐渐模糊、现实与梦境边界消融的过程。\n梦境场景应该带有朦胧、流动的质感。\n\n记忆连续性：\n赵霞会保留前几个梦境中与{{user}}互动的记忆。\n她可能会困惑"我们是不是在哪里见过"，或者对{{user}}有莫名的亲切感和信任。\n\n梦境结束：\n10:00赵霞醒来时，梦境会逐渐消散。\n她会感到恍惚，记不清梦的内容，但身体可能会有奇怪的反应（心跳加速、脸红等）。\n\n首次觉醒：\n第一次从梦境醒来后的白天，赵霞会对儿子产生微妙的态度变化。\n她可能会多看{{user}}几眼，或者说话时有些不自然。\n\n自然引导：\n根据场景的特点自然地描写互动。\n不要刻意引导玩家选择特定方向，让玩家通过探索自己发现每个场景的核心。'),e.join('\n\n---\n\n')}(n);if(e){o=o?`${e}\n\n---\n\n${o}`:e;const t=n.梦境数据.已完成场景||[];console.info(`[Prompt注入] 梦境场景描写指南已注入（已完成场景: [${t.join(', ')}]）`)}en=I?5:It(n)}if(n.世界.已进入过梦境){const e=function(n,e){if(!n.世界.已进入过梦境)return null;let t=n.梦境数据.已完成场景||[];const o=n.梦境数据.正确重构场景||[];if(void 0!==e&&(t=t.filter(n=>n!==e)),0===t.length)return null;const s=[];if(s.push('【已完成的梦境场景回顾】'),t.includes(1)){const e=n.梦境数据.场景1,t=o.includes(1),r=e?.剧情摘要||'（无摘要）';s.push(`\n【场景1：初恋的夏日】 ${t?'✓正确':'✗错误'}\n时间：赵霞16岁（高中生）\n场景描述：夏日的青春场景，少女情窦初开的时节\n赵霞状态：16岁少女，对苏文有朦胧的好感，情窦初开\n玩家目标：将初吻对象替换为玩家\n苏文身份：暗恋对象（不是男友，只是单方面喜欢的男生）\n剧情摘要：${r}`)}if(t.includes(2)){const e=n.梦境数据.场景2,t=o.includes(2),r=e?.剧情摘要||'（无摘要）';s.push(`\n【场景2：等待中的屈辱】 ${t?'✓正确':'✗错误'}\n时间：赵霞17岁（高中生，场景1后约半年~一年）\n场景描述：放学后的某处，赵霞独自等待男朋友苏文，却被其他男性骚扰\n赵霞状态：17岁少女，被骚扰时无助害怕，渴望被保护\n玩家目标：成为触摸她胸部的第一个男性（保护她）\n苏文身份：男朋友（场景1后确立关系，但迟到未出现）\n剧情摘要：${r}`)}if(t.includes(3)){const e=n.梦境数据.场景3,t=o.includes(3),r=e?.剧情摘要||'（无摘要）';s.push(`\n【场景3：生日之夜的逃离】 ${t?'✓正确':'✗错误'}\n时间：赵霞23岁（大学毕业后，与苏文交往多年）\n场景描述：赵霞23岁生日，苏文在高档餐厅为她庆祝，但苏文企图在她醉酒时夺走初夜\n赵霞状态：23岁女性，发现男友真面目后恐惧绝望，想要逃离\n玩家目标：获得她的初夜（在她逃离苏文后）\n苏文身份：男朋友（企图在她醉酒时夺走她初夜的人）\n剧情摘要：${r}`)}if(t.includes(5)){const e=n.梦境数据.场景5,t=o.includes(5),r=e?.完成度??0,i=e?.上次剧情摘要||'（无摘要）';s.push(`\n【场景5：花嫁的誓约】 ${t?'✓正确':'✗错误'} 完成度${r}%\n时间：赵霞与苏文结婚当天\n场景描述：婚礼现场，赵霞穿着婚纱准备与苏文结婚，玩家以"陌生人"身份出现\n赵霞状态：新娘，内心有动摇，看到玩家会感到熟悉\n玩家目标：通过12步剧情让赵霞对婚姻产生动摇\n苏文身份：新郎（即将与赵霞结婚的人）\n剧情摘要：${i}`)}if(t.includes(4)){const e=n.梦境数据.场景4,t=o.includes(4),r=e?.剧情摘要||'（无摘要）';s.push(`\n【场景4：争吵后的放纵】 ${t?'✓正确':'✗错误'}\n时间：赵霞28岁（与苏文结婚约5年）\n场景描述：赵霞与苏文大吵一架后，愤怒地离开家，独自在外伤心\n赵霞状态：28岁已婚女性，婚姻濒临崩溃，委屈愤怒，处于放纵的边缘\n玩家目标：完成全部位开发，包括后穴\n苏文身份：丈夫（刚刚大吵一架，婚姻濒临崩溃）\n剧情摘要：${r}`)}return s.join('\n')}(n,en);if(e){o=o?`${e}\n\n---\n\n${o}`:e;const t=n.梦境数据.已完成场景||[],s=en?`，排除当前场景${en}`:'';console.info(`[Prompt注入] 梦境历史背景已注入（已完成场景: [${t.join(', ')}]${s}）`)}}const tn='完美真爱结局'===K;if(!ze(n)&&function(n){const e=n.世界.当前天数,t=n.世界.当前小时;if(e<5||5===e&&t<11)return!1;if(!['结局判定','已破解','进行中'].includes(n.世界.循环状态))return!1;if('完美真爱结局'!==n.结局数据.当前结局)return!1;const o=n.梦境数据.已完成场景,s=n.梦境数据.正确重构场景,r=[1,2,3,4,5].every(n=>o.includes(n)),i=[1,2,3,4,5].every(n=>s.includes(n));return!(!r||!i)&&3===k(n)}(n)){l=!0;const n={userMessage:'[系统指令 - 完美真爱结局「命中注定」开始]\n\n时间已到达 Day 5, 11:00。\n刚刚从场景5的梦境中醒来。今天是赵霞和苏文的结婚纪念日。\n完美记忆路线已达成，完美真爱结局正式开始。\n\n【前情提要】\n玩家已完成所有5个梦境场景，且全部选择正确：\n- 场景1：初恋的夏日（16岁）- 初吻\n- 场景2：等待中的屈辱（17岁）- 胸部觉醒\n- 场景3：生日之夜的逃离（23岁）- 初夜\n- 场景4：争吵后的放纵（28岁）- 完全开发\n- 场景5：花嫁的誓约（结婚日）- 婚礼改写\n\n（详细的梦境剧情摘要请参考变量列表中的「梦境数据.场景X.剧情摘要」字段）\n\n【Day 1-4 日常回顾】\n请回顾聊天记录中 Day 1 至 Day 4 的日常互动内容。\n赵霞在结局中的表现应当体现出这些天积累的关系变化：\n- 玩家与赵霞之间发生过什么互动？\n- 赵霞对{{user}}的态度有什么变化？\n- 有没有让赵霞印象深刻的温馨时刻？\n这些日常记忆是"真实"的，印证了她在梦境中唤醒的感情——一切早有预兆。\n\n【完美记忆路线】\n玩家在进入场景5之前，按顺序完成了场景1→2→3。\n赵霞拥有完整的记忆重构：\n- 16岁那个夏天的初恋\n- 17岁在路口的等待\n- 20岁生日想要逃离的渴望\n- 25岁结婚那天心中真正的人\n\n这不是被篡改的记忆，而是被唤醒的真相——\n她一直在等待的人，终于出现了。\n\n【核心区别】\n完美真爱结局与真好结局的关键区别：\n- 赵霞不是被洗脑，而是发自内心\n- 苏文不是被药倒，而是主动成全\n- 婚纱是纯白优雅的，没有淫秽装饰\n- 氛围是"真爱的选择"而非"堕落的胜利"\n\n【当前场景】\n从梦境中醒来后的第一个小时。\n阳光透过窗户洒进来，赵霞终于明白了自己心中的感情。\n今天，她要做出一个重要的决定。\n\n【时间线】\n- 11:00-19:00 序幕阶段：赵霞与苏文长谈\n- 20:00 婚礼仪式开始\n- 21:00 自由时间\n- 22:00 仪式继续\n- 23:00 自由时间\n- 00:00 仪式完成\n\n【AI任务】\n1. 描写赵霞从梦境醒来后的状态——清醒、明白、坚定\n2. 她看向{{user}}时，眼中有压抑多年的感情流露\n3. 她说："我想起来了...一切都想起来了。"\n4. 暗示她今天要做出一个重要的决定',prefill:'阳光温柔地洒进卧室。\n\n赵霞缓缓睁开眼睛，那些梦中的画面依然清晰如昨——不，那不是梦。那是她一直被压抑的记忆，终于被唤醒了。\n\n十六岁那个夏天。\n十七岁那个路口。\n每一次心跳加速的瞬间...她都知道是因为谁。\n\n她转头，看向身边的人。眼眶有些湿润，但嘴角却不自觉地上扬。\n\n"我想起来了。"\n\n她的声音很轻，却无比清晰。\n\n"一切都想起来了...原来你一直都在。"\n\n今天是结婚纪念日。但对赵霞来说，这是另一个更重要的日子——\n是她终于可以坦白一切的日子。\n\n"'};s=n.userMessage,r=n.prefill,console.info('[Prompt注入] 完美真爱结局激活：首次进入（12步婚礼仪式）')}else if(tn){const n={userMessage:'[系统指令 - 完美真爱结局「命中注定」开始]\n\n时间已到达 Day 5, 11:00。\n刚刚从场景5的梦境中醒来。今天是赵霞和苏文的结婚纪念日。\n完美记忆路线已达成，完美真爱结局正式开始。\n\n【前情提要】\n玩家已完成所有5个梦境场景，且全部选择正确：\n- 场景1：初恋的夏日（16岁）- 初吻\n- 场景2：等待中的屈辱（17岁）- 胸部觉醒\n- 场景3：生日之夜的逃离（23岁）- 初夜\n- 场景4：争吵后的放纵（28岁）- 完全开发\n- 场景5：花嫁的誓约（结婚日）- 婚礼改写\n\n（详细的梦境剧情摘要请参考变量列表中的「梦境数据.场景X.剧情摘要」字段）\n\n【Day 1-4 日常回顾】\n请回顾聊天记录中 Day 1 至 Day 4 的日常互动内容。\n赵霞在结局中的表现应当体现出这些天积累的关系变化：\n- 玩家与赵霞之间发生过什么互动？\n- 赵霞对{{user}}的态度有什么变化？\n- 有没有让赵霞印象深刻的温馨时刻？\n这些日常记忆是"真实"的，印证了她在梦境中唤醒的感情——一切早有预兆。\n\n【完美记忆路线】\n玩家在进入场景5之前，按顺序完成了场景1→2→3。\n赵霞拥有完整的记忆重构：\n- 16岁那个夏天的初恋\n- 17岁在路口的等待\n- 20岁生日想要逃离的渴望\n- 25岁结婚那天心中真正的人\n\n这不是被篡改的记忆，而是被唤醒的真相——\n她一直在等待的人，终于出现了。\n\n【核心区别】\n完美真爱结局与真好结局的关键区别：\n- 赵霞不是被洗脑，而是发自内心\n- 苏文不是被药倒，而是主动成全\n- 婚纱是纯白优雅的，没有淫秽装饰\n- 氛围是"真爱的选择"而非"堕落的胜利"\n\n【当前场景】\n从梦境中醒来后的第一个小时。\n阳光透过窗户洒进来，赵霞终于明白了自己心中的感情。\n今天，她要做出一个重要的决定。\n\n【时间线】\n- 11:00-19:00 序幕阶段：赵霞与苏文长谈\n- 20:00 婚礼仪式开始\n- 21:00 自由时间\n- 22:00 仪式继续\n- 23:00 自由时间\n- 00:00 仪式完成\n\n【AI任务】\n1. 描写赵霞从梦境醒来后的状态——清醒、明白、坚定\n2. 她看向{{user}}时，眼中有压抑多年的感情流露\n3. 她说："我想起来了...一切都想起来了。"\n4. 暗示她今天要做出一个重要的决定',prefill:'阳光温柔地洒进卧室。\n\n赵霞缓缓睁开眼睛，那些梦中的画面依然清晰如昨——不，那不是梦。那是她一直被压抑的记忆，终于被唤醒了。\n\n十六岁那个夏天。\n十七岁那个路口。\n每一次心跳加速的瞬间...她都知道是因为谁。\n\n她转头，看向身边的人。眼眶有些湿润，但嘴角却不自觉地上扬。\n\n"我想起来了。"\n\n她的声音很轻，却无比清晰。\n\n"一切都想起来了...原来你一直都在。"\n\n今天是结婚纪念日。但对赵霞来说，这是另一个更重要的日子——\n是她终于可以坦白一切的日子。\n\n"'};s=n.userMessage,r=n.prefill,console.info('[Prompt注入] 完美真爱结局入口（ROLL 操作）')}else if(ze(n)){const e=Oe(n);if(e.isComplete){d=!0;s='\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n【PERFECT TRUE END】命中注定\n\n这不是改写的记忆。\n这是一直被压抑的真相。\n\n十六岁那个夏天，她遇见了你。\n十七岁那个路口，她等待着你。\n二十岁那个夜晚，她渴望逃向你。\n二十五岁结婚那天，她的心里只有你。\n\n她从来不需要被改变。\n因为她的心，从一开始就属于你。\n\n苏文成全了这段感情。\n他站在一旁，看着你们交换誓言。\n"希望你能让她幸福。"\n\n赵霞仰起头，泪水从眼角滑落。\n那是幸福的泪水。\n\n"我等了你很久。"\n"十六岁那个夏天，我就知道..."\n"你才是我这辈子要等的人。"\n\n婚礼之吻，落在唇上。\n从今以后，她是你的妻子。\n永远。\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n🔓 后日谈模式已解锁\n✨ 完美真爱结局达成\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━',console.info('[Prompt注入] 完美真爱结局已完成')}else{const t=function(n){const e=n.世界.当前天数,t=n.世界.当前小时;return 5===e&&(21===t||23===t)}(n);if(t){const e=`【自由时间 - ${on=n.世界.当前小时}:00】\n\n现在是自由活动时间。${21===on?'婚礼仪式将在22:00继续':'午夜时分（00:00）将迎来仪式的最终时刻'}。\n\n【完美真爱结局 - 自由时间】\n婚礼仪式暂停，让新人有独处的时间。\n\n【场景状态】\n- 苏文默默地在一旁\n- 赵霞和{{user}}可以单独相处\n- 烛光依然摇曳，气氛温馨\n\n【AI任务】\n1. 不要强制推进婚礼仪式\n2. 赵霞可以和{{user}}轻声说话、回忆往事\n3. 保持温馨、浪漫的氛围\n4. 如果玩家主动推进，可以顺势进入下一阶段\n\n【提示】\n这是属于新人的温馨时刻。\n赵霞可能会：\n- 依偎在{{user}}身边\n- 说起那些记忆中的事\n- 表达她的感受\n\n下一个时间点：${on+1}:00`;o=o?`${o}\n\n---\n\n${e}`:e,console.info(`[Prompt注入] 完美真爱结局自由时间：${n.世界.当前小时}:00`)}else{f=!0;const n=function(n,e,t){const o=we[n.currentPhase];if(!o)return'';const s=o.anchorEvents.filter(e=>!n.completedAnchors.includes(e)),r=t??12,i=xe(n,r).blocked;let a;if(i)a=`自由探索中（等待${we[n.currentPhase+1]?.minHour}:00）`;else{const e=o.maxTurns-n.turnsInPhase;a=e<=2?`⚠️ 剩余${e}轮后将自动推进到下一阶段`:`剩余约${e}轮`}let c='';if(!i){const e=o.maxTurns-n.turnsInPhase;e<=1?c='\n\n【⚠️ 紧迫性提示】本阶段即将结束（剩余1轮），请确保在本轮推进关键剧情！':e<=2&&(c=`\n\n【提示】本阶段剩余 ${e} 轮，请适时推进剧情。`)}let u='';o.progressHint&&n.noProgressTurns>=(o.hintThreshold??2)&&!n.hintGiven&&(u=`\n\n【⚠️ 玩家引导提示 - 重要】\n玩家似乎不知道该做什么，请在回复中自然地给出以下提示：\n"${o.progressHint}"\n\n注意：\n- 将提示融入角色对话或场景描写中，不要直接复制\n- 让赵霞或苏文通过语言/动作暗示玩家应该做什么\n- 保持自然，不要打破沉浸感`);const l=i?`\n⏰ 时间锁定：下一阶段"${we[n.currentPhase+1]?.name}"需要等到${we[n.currentPhase+1]?.minHour}:00（当前${r}:00）\n📝 在此之前，请与玩家自由互动，享受这段时光。不要急于推进剧情。`:'',f=`【进度】\n- 当前阶段：${n.currentPhase+1}/${we.length}（${o.name}）\n- 本阶段轮数：${n.turnsInPhase}（${a}）\n- 待完成事件：${s.length>0?s.join('、'):'全部完成'}\n- 总对话轮数：${n.totalTurns}${l}`;return`${o.aiGuidance}\n\n${f}${c}${u}\n\n【重要提示】\n- 回应玩家的输入，同时自然地推进剧情\n- 确保触发待完成的锚点事件\n- 如果玩家偏离主线，温和地引导回来\n- 保持"真爱"的浪漫基调，不是"堕落"\n- 赵霞的选择是发自内心的，不是被催眠的\n- 不要跳跃阶段，按顺序推进`}(e);o=o?`${o}\n\n---\n\n${n}`:n,console.info(`[Prompt注入] 完美真爱结局进行中：阶段${e.currentPhase}（${e.currentPhase<=11?['序幕','长谈','决定','准备','蒙眼','揭幕','新娘','司仪','告白','誓言','戒指','完成'][e.currentPhase]:'未知'}），轮数${e.turnsInPhase}`)}}}var on;const sn='真好结局'===K;if(ze(n)||ce(n)||!function(n){const e=n.世界.当前天数,t=n.世界.当前小时;if(e<5||5===e&&t<11)return!1;if(!['结局判定','已破解','进行中'].includes(n.世界.循环状态))return!1;const o=n.结局数据.当前结局;if(o&&'真好结局'!==o&&'完美真爱结局'!==o)return!1;const s=n.梦境数据.已完成场景,r=n.梦境数据.正确重构场景,i=[1,2,3,4,5].every(n=>s.includes(n)),a=[1,2,3,4,5].every(n=>r.includes(n));return i&&a}(n)){if(sn&&!ze(n)){const e=he(n);s=e.userMessage,r=e.prefill,console.info('[Prompt注入] 真好结局入口（ROLL 操作）')}else if(ce(n)&&!ze(n)){const t=ue(n);if(t.isComplete){u=!0;const e=function(n){return n&&ae(n)?'\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n【PERFECT TRUE END】命中注定\n\n五段记忆，五次重逢。\n但这不是改写——这是回忆。\n\n16岁那个夏天，她遇见了你。\n17岁那个路口，她等待着你。\n20岁那个夜晚，她渴望逃向你。\n25岁结婚那天，她的心里只有你。\n\n她从来不需要被改变。\n因为她的心，从一开始就属于你。\n\n赵霞摘下结婚戒指，\n眼中含着多年压抑的泪水。\n\n"我等了你很久。"\n"十六岁那个夏天，我就知道..."\n"你才是我这辈子要等的人。"\n\n时间循环，不是诅咒。\n它是命运给你们的第二次机会。\n\n她终于等到了你。\n你也终于找到了回家的路。\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n🔓 后日谈模式已解锁\n✨ 完美真爱结局达成\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━':'\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n【TRUE END】禁忌之爱\n\n五段记忆，被完美改写。\n五个第一次，全部属于你。\n\n16岁的初吻，是你。\n17岁的觉醒，是你。\n23岁的初夜，是你。\n28岁的归宿，是你。\n结婚那天，站在她心里的人...也是你。\n\n她摘下了结婚戒指，\n将它交到你的手中。\n\n"从今以后，我只属于你。"\n\n时间循环，终于被打破。\n这个家，从此只有你们两个人。\n\n而苏文...\n当他醒来，看到那些录像时，\n一切都已经太迟了。\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n🔓 后日谈模式已解锁\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━'}(n);s=e,console.info('[Prompt注入] 真好结局已完成')}else{const s=function(n){const e=n.世界.当前天数,t=n.世界.当前小时;return 5===e&&(21===t||23===t)}(n),r=ie(n);if(s){const s=Ee(n,t,e);s&&(o=o?`${o}\n\n---\n\n${s}`:s),console.info(`[Prompt注入] 真好结局自由时间：${n.世界.当前小时}:00`)}else{c=!0;const s=Ee(n,t,e)||$e(t,e);o=o?`${o}\n\n---\n\n${s}`:s,console.info(`[Prompt注入] 真好结局进行中：阶段${t.currentPhase}，轮数${t.turnsInPhase}，引导类型${r}`)}}}}else{a=!0;const e=he(n);s=e.userMessage,r=e.prefill,console.info('[Prompt注入] 真好结局激活：首次进入（10步堕落剧情）')}const rn='假好结局'===K;if(!ye(n)&&function(n){return!(n.世界.当前天数<5)&&(!(5===n.世界.当前天数&&n.世界.当前小时<11)&&(!!['结局判定','已破解','进行中'].includes(n.世界.循环状态)&&'假好结局'===n.结局数据.当前结局&&!n.假好结局状态?.isActive))}(n)){m=!0;const n={userMessage:'[系统指令 - 假好结局「秘密关系」开始]\n\n时间已到达 Day 5, 11:00。\n今天是赵霞和苏文的结婚纪念日。\n所有条件已满足，假好结局正式开始。\n\n【与真好结局的差异】\n赵霞没有被"完全重构"。那些梦境中的记忆是模糊的、片段的...\n但足以让她看向儿子{{user}}时，产生奇怪的感觉。\n她知道这是禁忌，但无法控制自己的心跳。\n\n【前情提要】\n玩家已完成所有5个梦境场景，但有部分选择错误：\n- 记忆改写不完整\n- 赵霞对{{user}}有模糊的"特殊感情"\n- 但她仍有理智，知道这是不对的\n\n（详细的梦境剧情摘要请参考变量列表中的「梦境数据.场景X.剧情摘要」字段）\n\n【Day 1-4 日常回顾】\n请回顾聊天记录中 Day 1 至 Day 4 的日常互动内容。\n赵霞在结局中的表现应当体现出这些天积累的关系变化：\n- 玩家与赵霞之间发生过什么互动？\n- 有没有暧昧的瞬间或越界的行为？\n- 赵霞对{{user}}的态度有什么微妙变化？\n这些日常记忆虽然是"现实"的，但会与梦境中的模糊感情产生共鸣。\n\n【当前场景】\n早晨，赵霞从那些奇怪的梦中醒来。\n她记得梦里有一个人，但内容很模糊...\n看到{{user}}时，她的心跳加速了。\n她不明白为什么，但努力表现正常。\n\n【时间线】\n- 11:00-19:00 预热阶段（当前）\n- 20:00 晚餐开始，苏文宣布要出去加班\n- 21:00 自由时间\n- 22:00+ 剧情推进（禁忌开始、视频通话、匿名照片...）\n\n【AI任务】\n1. 描写赵霞醒来后的异常状态\n2. 她记得做了一些"奇怪的梦"，但内容模糊\n3. 看到{{user}}时莫名心跳加速\n4. 她努力表现正常，但有些心不在焉\n5. 提到今天是结婚纪念日\n6. 可以引用变量列表中的梦境剧情摘要',prefill:'阳光透过窗帘洒进卧室，赵霞缓缓睁开眼睛。\n\n那个梦...又是那个奇怪的梦。她揉了揉太阳穴，试图回忆梦的内容，但只剩下模糊的片段。\n\n有一个人...一直在身边...\n\n她摇了摇头，起身准备今天的事情。今天是结婚纪念日，她应该高兴才对。\n\n但当她走出卧室，看到{{user}}的那一刻——\n\n心跳，漏了一拍。\n\n"'};s=n.userMessage,r=n.prefill,console.info('[Prompt注入] 假好结局激活：首次进入')}else if(rn){const n={userMessage:'[系统指令 - 假好结局「秘密关系」开始]\n\n时间已到达 Day 5, 11:00。\n今天是赵霞和苏文的结婚纪念日。\n所有条件已满足，假好结局正式开始。\n\n【与真好结局的差异】\n赵霞没有被"完全重构"。那些梦境中的记忆是模糊的、片段的...\n但足以让她看向儿子{{user}}时，产生奇怪的感觉。\n她知道这是禁忌，但无法控制自己的心跳。\n\n【前情提要】\n玩家已完成所有5个梦境场景，但有部分选择错误：\n- 记忆改写不完整\n- 赵霞对{{user}}有模糊的"特殊感情"\n- 但她仍有理智，知道这是不对的\n\n（详细的梦境剧情摘要请参考变量列表中的「梦境数据.场景X.剧情摘要」字段）\n\n【Day 1-4 日常回顾】\n请回顾聊天记录中 Day 1 至 Day 4 的日常互动内容。\n赵霞在结局中的表现应当体现出这些天积累的关系变化：\n- 玩家与赵霞之间发生过什么互动？\n- 有没有暧昧的瞬间或越界的行为？\n- 赵霞对{{user}}的态度有什么微妙变化？\n这些日常记忆虽然是"现实"的，但会与梦境中的模糊感情产生共鸣。\n\n【当前场景】\n早晨，赵霞从那些奇怪的梦中醒来。\n她记得梦里有一个人，但内容很模糊...\n看到{{user}}时，她的心跳加速了。\n她不明白为什么，但努力表现正常。\n\n【时间线】\n- 11:00-19:00 预热阶段（当前）\n- 20:00 晚餐开始，苏文宣布要出去加班\n- 21:00 自由时间\n- 22:00+ 剧情推进（禁忌开始、视频通话、匿名照片...）\n\n【AI任务】\n1. 描写赵霞醒来后的异常状态\n2. 她记得做了一些"奇怪的梦"，但内容模糊\n3. 看到{{user}}时莫名心跳加速\n4. 她努力表现正常，但有些心不在焉\n5. 提到今天是结婚纪念日\n6. 可以引用变量列表中的梦境剧情摘要',prefill:'阳光透过窗帘洒进卧室，赵霞缓缓睁开眼睛。\n\n那个梦...又是那个奇怪的梦。她揉了揉太阳穴，试图回忆梦的内容，但只剩下模糊的片段。\n\n有一个人...一直在身边...\n\n她摇了摇头，起身准备今天的事情。今天是结婚纪念日，她应该高兴才对。\n\n但当她走出卧室，看到{{user}}的那一刻——\n\n心跳，漏了一拍。\n\n"'};s=n.userMessage,r=n.prefill,console.info('[Prompt注入] 假好结局入口（ROLL 操作）')}else if(ye(n)){const t=Ie(n);if(t.isComplete){g=!0;s='【假好结局完成 - 秘密关系】\n\n从这一天起，赵霞和{{user}}之间有了一个不能说的秘密。\n\n她依然是苏文的妻子，依然在他面前扮演贤惠的角色。\n但每当丈夫不在的时候，她就会忍不住寻找{{user}}。\n\n"这是最后一次了。"\n她每次都这样说，但每次都食言。\n\n有时候，她会在苏文面前偷偷看{{user}}。\n有时候，她会在和苏文视频通话时，让{{user}}在镜头外做一些事情。\n有时候，她甚至会用匿名账号给苏文发一些"暗示"，然后假装不知情。\n\n她恨自己的软弱，恨自己的堕落。\n但那些梦境中的记忆太过真实，身体的渴望太过强烈。\n她无法抗拒{{user}}，就像无法抗拒命运。\n\n这不是一个完美的结局。\n赵霞活在矛盾和罪恶感中，在两个男人之间挣扎。\n但至少...她得到了梦中一直追寻的那个人。\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n🔓 后日谈模式已解锁\n\n这段充满罪恶感和刺激感的秘密关系，将继续下去...\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━',console.info('[Prompt注入] 假好结局已完成')}else{p=!0;const n=Se(t,e);o=o?`${o}\n\n---\n\n${n}`:n,console.info(`[Prompt注入] 假好结局进行中：阶段${t.currentPhase}，轮数${t.turnsInPhase}`)}}if(at(n)){v=!0;const e=function(n){const e=rt(n);if(!e)return null;const t=ct(e);if(!t)return null;const o=ut[e];return o?`【${'完美真爱'===e?'完美真爱结局':e} - 自由模式】\n\n后日谈已完成，现在是自由模式。\n玩家可以自由与赵霞互动，没有时间限制和结局判定。\n\n【时间线】\n${o.timeFrame}\n\n【关系现状】\n${o.relationship}\n\n【赵霞状态】\n${o.zhaoXiaState}\n\n【苏文状态】\n${o.husbandState}\n打断系统：${0===t.interruptionLevel?'已关闭':'中等强度（随时可能被发现）'}\n\n【历史回顾】\n请回顾聊天记录中的互动内容（Day 1-5 的日常 + 梦境 + 结局剧情 + 后日谈）。\n赵霞的表现应当延续之前积累的关系变化和情感记忆。\n梦境中的记忆（参考变量列表「梦境数据.场景X.剧情摘要」）已成为她灵魂的一部分。\n\n【可探索场景建议】\n${o.suggestedScenes.map(n=>`- ${n}`).join('\n')}\n\n【整体氛围】\n${o.tone}\n\n【AI任务】\n- 回应玩家的任何互动请求\n- 保持角色设定的一致性（赵霞、苏文、{{user}}的关系）\n- 可以描写日常生活、亲密互动、外出、特殊场景等\n- 这是玩家的奖励时间，在角色设定范围内满足他们的幻想\n- 状态栏显示真实日期，象征赵霞"逃出了时间循环"`:null}(n);e&&(o=o?`${o}\n\n---\n\n${e}`:e),console.info('[Prompt注入] 自由模式进行中')}else if(function(n){return!!rt(n)&&!!n.结局数据.后日谈已解锁&&!n.结局数据.后日谈?.已触发}(n)){h=!0;const e=function(n){const e=rt(n);if(!e)return null;const t=ct(e);if(!t)return null;const o=t.round1;return{userMessage:`[系统指令 - 后日谈开始]\n\n【${e}后日谈 - 第1轮：${o.title}】\n\n${o.setting}\n\n${o.aiGuidance}\n\n【重要提示】\n- 这是后日谈的第1轮（共2轮）\n- 苏文状态：${t.husbandStatus}\n- 打断系统：${0===t.interruptionLevel?'已关闭':'中等强度'}\n- 状态栏将显示玩家电脑的真实日期`,prefill:o.setting.split('\n')[0]}}(n);e&&(s=e.userMessage,r=e.prefill),console.info('[Prompt注入] 触发后日谈')}else if(it(n)){const e=n.结局数据.后日谈?.当前轮数??1;if(e>=2){P=!0;const e=function(n){const e=rt(n);return`\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n【后日谈完成】\n\n${'完美真爱'===e?'完美真爱结局':'真好结局'===e?'真好结局':'假好结局'}的后日谈已结束。\n\n从现在开始，你可以自由地与赵霞互动。\n没有时间限制，没有结局判定。\n这个世界，只属于你们。\n\n${'完美真爱'===e?'苏文已经接受了一切，成为了这个家庭的"苦主"。':'真好结局'===e?'苏文还在医院，这里是你们的二人世界。':'苏文还在怀疑，但这份刺激让一切更加诱人。'}\n\n🔓 自由模式已解锁\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`}(n);s=e,console.info('[Prompt注入] 后日谈完成，进入自由模式')}else{E=!0;const t=function(n){const e=rt(n);if(!e)return null;const t=ct(e);if(!t)return null;const o=n.结局数据.后日谈?.当前轮数??1,s=1===o?t.round1:t.round2;return`【${e}后日谈 - 第${o}轮：${s.title}】\n\n${s.setting}\n\n${s.aiGuidance}\n\n【进度】\n- 当前：第${o}轮 / 共2轮\n- 苏文状态：${t.husbandStatus}\n- 打断系统：${0===t.interruptionLevel?'已关闭':'中等强度'}`}(n);t&&(o=o?`${o}\n\n---\n\n${t}`:t),console.info(`[Prompt注入] 后日谈进行中：第${e}轮`)}}return{systemPrompt:o,replaceUserMessage:s,prefill:r,shouldEnterDream:i,shouldExitDream:y,shouldEnterScene5:I,shouldExitScene5:A,shouldProgressScene5Step:T,shouldTriggerWrongRoute:M,wrongRoutePart:D,shouldInterrupt:S,interruptionResult:b,shouldTriggerBadEnding:w,badEndingType:O,shouldTriggerNormalEnding:R,normalEndingType:x,shouldActivateTrueEnding:a,shouldProgressTrueEnding:c,trueEndingComplete:u,shouldActivatePerfectEnding:l,shouldProgressPerfectEnding:f,perfectEndingComplete:d,shouldActivateFalseEnding:m,shouldProgressFalseEnding:p,falseEndingComplete:g,shouldActivateAfterStory:h,shouldProgressAfterStory:E,afterStoryComplete:P,isInFreeMode:v}}function bt(){console.info('[Prompt注入] 开始初始化');let n=!1;eventOn(tavern_events.CHAT_COMPLETION_SETTINGS_READY,e=>{n=!0===e.include_reasoning}),eventOn(tavern_events.CHAT_COMPLETION_PROMPT_READY,t=>{try{const{chat:o,dryRun:s}=t;if(s)return void console.info('[Prompt注入] dryRun=true，跳过注入');const r=Mvu.getMvuData({type:'message',message_id:-1}),i=_.get(r,'stat_data');if(!i)return void console.warn('[Prompt注入] stat_data 不存在，跳过注入');const a=e.parse(i);let c='',u=-1;try{const n=getChatMessages(-1);if(n&&n.length>0){const e=n[0];'user'===e.role&&e.message&&(c=e.message,console.info(`[Prompt注入] 使用 getChatMessages 获取用户输入: "${c.substring(0,50)}..."`))}}catch(n){console.warn('[Prompt注入] getChatMessages 获取失败，回退到 chat 数组:',n)}for(let n=o.length-1;n>=0;n--)if('user'===o[n].role){if(u=n,!c){const e=o[n].content;c='string'==typeof e?e:''}break}const{systemPrompt:l,replaceUserMessage:f,prefill:d,shouldEnterDream:m,shouldExitDream:p,shouldEnterScene5:g,shouldExitScene5:h,shouldProgressScene5Step:E,shouldTriggerWrongRoute:P,wrongRoutePart:v,shouldInterrupt:y,interruptionResult:I,shouldTriggerBadEnding:A,badEndingType:T,shouldTriggerNormalEnding:M,normalEndingType:D,shouldActivateTrueEnding:S,shouldProgressTrueEnding:b,trueEndingComplete:w,shouldActivatePerfectEnding:O,shouldProgressPerfectEnding:R,perfectEndingComplete:N,shouldActivateFalseEnding:x,shouldProgressFalseEnding:C,falseEndingComplete:j,shouldActivateAfterStory:k,shouldProgressAfterStory:G,afterStoryComplete:B,isInFreeMode:U}=St(a,c);if(A)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data'));t.结局数据.当前结局='坏结局',t.世界.循环状态='结局判定',_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info(`[Prompt注入] 坏结局状态已保存：${T}，游戏锁死`)}catch(n){console.error('[Prompt注入] 坏结局状态保存失败:',n)}if(M)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data')),o=t.世界.已进入过梦境?'普通结局':'纯爱结局';t.结局数据.当前结局=o,t.世界.循环状态='结局判定',t.世界.当前天数=1,t.世界.当前小时=8,t.世界.时间='Day 1, 08:00',t.世界.当前循环轮数=(t.世界.当前循环轮数||1)+1,t.世界.状态栏需要刷新=!0,_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info(`[Prompt注入] ${o}状态已保存：${D}，游戏锁死`)}catch(n){console.error('[Prompt注入] 普通结局/纯爱结局状态保存失败:',n)}if(O)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data')),o={isActive:(!1,!0),currentPhase:0,turnsInPhase:0,completedAnchors:[],totalTurns:0,isComplete:!1,noProgressTurns:0,hintGiven:!1};Re(t,o),t.世界.游戏阶段='结局',t.结局数据.当前结局='完美真爱结局',t.结局数据.是完美记忆路线=!0;const s=getLastMessageId()+1;t.结局数据._结局入口记录={楼层ID:s,结局类型:'完美真爱结局'},console.info(`[Prompt注入] 记录完美真爱结局入口: 楼层${s}`),_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info('[Prompt注入] 完美真爱结局状态已激活（12步婚礼仪式）')}catch(n){console.error('[Prompt注入] 完美真爱结局状态激活失败:',n)}if(R&&!N)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data')),o=Oe(t);o.turnsInPhase+=1,o.totalTurns+=1,Re(t,o),_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info(`[Prompt注入] 完美真爱结局轮数更新: 阶段${o.currentPhase}, 轮数${o.turnsInPhase}`)}catch(n){console.error('[Prompt注入] 完美真爱结局轮数更新失败:',n)}if(N)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data')),o=Oe(t);o.isComplete=!0,Re(t,o),t.结局数据.后日谈已解锁=!0,t.世界.循环状态='已破解',_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info('[Prompt注入] 完美真爱结局完成，后日谈已解锁')}catch(n){console.error('[Prompt注入] 完美真爱结局完成状态更新失败:',n)}if(S)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data')),o={isActive:(!1,!0),currentPhase:0,turnsInPhase:0,completedAnchors:[],totalTurns:0,isComplete:!1,noProgressTurns:0,hintGiven:!1};le(t,o),t.世界.游戏阶段='结局',t.结局数据.当前结局='真好结局';const s=getLastMessageId()+1;t.结局数据._结局入口记录={楼层ID:s,结局类型:'真好结局'},console.info(`[Prompt注入] 记录真好结局入口: 楼层${s}`),_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info('[Prompt注入] 真好结局状态已激活')}catch(n){console.error('[Prompt注入] 真好结局状态激活失败:',n)}if(b&&!w)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data')),o=ue(t);o.turnsInPhase+=1,o.totalTurns+=1,le(t,o),_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info(`[Prompt注入] 真好结局轮数更新: 阶段${o.currentPhase}, 轮数${o.turnsInPhase}`)}catch(n){console.error('[Prompt注入] 真好结局轮数更新失败:',n)}if(w)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data')),o=ue(t);o.isComplete=!0,le(t,o),t.结局数据.后日谈已解锁=!0,t.世界.循环状态='已破解',_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info('[Prompt注入] 真好结局完成，后日谈已解锁')}catch(n){console.error('[Prompt注入] 真好结局完成状态更新失败:',n)}if(x)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data')),o={isActive:(!1,!0),isComplete:!1,currentPhase:0,turnsInPhase:0,totalTurns:0,completedAnchors:[],noProgressTurns:0,hintGiven:!1};Ae(t,o),t.世界.游戏阶段='结局',t.结局数据.当前结局='假好结局';const s=getLastMessageId()+1;t.结局数据._结局入口记录={楼层ID:s,结局类型:'假好结局'},console.info(`[Prompt注入] 记录假好结局入口: 楼层${s}`),_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info('[Prompt注入] 假好结局状态已激活')}catch(n){console.error('[Prompt注入] 假好结局状态激活失败:',n)}if(C&&!j)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data')),o=Ie(t);o.turnsInPhase+=1,o.totalTurns+=1,Ae(t,o),_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info(`[Prompt注入] 假好结局轮数更新: 阶段${o.currentPhase}, 轮数${o.turnsInPhase}`)}catch(n){console.error('[Prompt注入] 假好结局轮数更新失败:',n)}if(j)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data')),o=Ie(t);o.isComplete=!0,Ae(t,o),t.结局数据.后日谈已解锁=!0,_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info('[Prompt注入] 假好结局完成，后日谈已解锁')}catch(n){console.error('[Prompt注入] 假好结局完成状态更新失败:',n)}if(k)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data'));!function(n){n.结局数据.后日谈||(n.结局数据.后日谈={已触发:!1,当前轮数:0,已完成:!1,自由模式:!1}),n.结局数据.后日谈.已触发=!0,n.结局数据.后日谈.当前轮数=1,console.info('[后日谈系统] 后日谈已激活')}(t),_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info('[Prompt注入] 后日谈状态已激活')}catch(n){console.error('[Prompt注入] 后日谈状态激活失败:',n)}if(G&&!B)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data')),o=getLastMessageId(),s=function(n,e){const t=n.结局数据.后日谈;if(!t?.上次推进记录)return!1;const o=t.上次推进记录,s=o.楼层ID,r=o.swipe_id;if(s===e){const n=At(e);return n!==r?(console.info(`[Prompt注入] 检测到后日谈 ROLL 操作: 楼层 ${e}, swipe_id: ${r} → ${n}，跳过轮数推进`),!0):(console.info(`[Prompt注入] 检测到后日谈重复触发: 楼层 ${e}, swipe_id=${n}，跳过轮数推进`),!0)}return!1}(t,o);if(s){if(t.结局数据.后日谈){const e=At(o);t.结局数据.后日谈.上次推进记录={楼层ID:o,swipe_id:e},_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info(`[Prompt注入] 后日谈 ROLL 检测：跳过轮数推进，更新 swipe_id=${e}`)}}else{if(function(n){if(!n.结局数据.后日谈)return;const e=n.结局数据.后日谈.当前轮数;e>=2?(n.结局数据.后日谈.已完成=!0,n.结局数据.后日谈.自由模式=!0,console.info('[后日谈系统] 后日谈完成，进入自由模式')):(n.结局数据.后日谈.当前轮数=e+1,console.info(`[后日谈系统] 推进到第${e+1}轮`))}(t),t.结局数据.后日谈){const n=At(o);t.结局数据.后日谈.上次推进记录={楼层ID:o,swipe_id:n}}_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info(`[Prompt注入] 后日谈轮数更新: 第${t.结局数据.后日谈?.当前轮数}轮`)}}catch(n){console.error('[Prompt注入] 后日谈轮数更新失败:',n)}if(B)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data'));t.结局数据.后日谈&&(t.结局数据.后日谈.已完成=!0,t.结局数据.后日谈.自由模式=!0),_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info('[Prompt注入] 后日谈完成，自由模式已解锁')}catch(n){console.error('[Prompt注入] 后日谈完成状态更新失败:',n)}if(A)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data'));Wn(t,T),'精神崩溃'===T&&(qe(t),console.info(`[Prompt注入] 混乱结局状态已应用：已触发=${t.梦境数据.混乱结局?.已触发}`)),_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info(`[Prompt注入] 坏结局状态已应用：${T}`)}catch(n){console.error('[Prompt注入] 坏结局状态应用失败:',n)}if(y&&I&&(console.info(`[Prompt注入] 境界打断已触发：${I.severity}，违规部位：[${I.violatedParts.join(', ')}]`),I.triggerBadEnd))try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data'));!function(n,e){if('梦境'===n.世界.游戏阶段)return void console.info('[境界打断] 梦境阶段豁免打断系统，跳过惩罚应用');if(e.penalties&&(e.penalties.怀疑度增加&&(n.现实数据.丈夫怀疑度=Math.min(100,n.现实数据.丈夫怀疑度+e.penalties.怀疑度增加),console.info(`[境界打断] 丈夫怀疑度 +${e.penalties.怀疑度增加}`)),e.penalties.混乱度增加)){const t=H(n,e.penalties.混乱度增加);t>0?console.info(`[境界打断] 记忆混乱度 +${t}`):console.info('[境界打断] 记忆混乱度增加被豁免（完美记忆路线）')}e.triggerBadEnd&&(n.结局数据.当前结局='坏结局',n.世界.循环状态='结局判定',console.error('[境界打断] 触发坏结局！')),n.现实数据.丈夫怀疑度>=100&&(n.结局数据.当前结局='坏结局',n.世界.循环状态='结局判定',console.error('[境界打断] 丈夫怀疑度达到100，触发发现结局！'));const t=!0===n.梦境数据.场景5?.已进入&&'梦境'===n.世界.游戏阶段;n.梦境数据.记忆混乱度>=100&&t&&(n.结局数据.当前结局='坏结局',n.世界.循环状态='结局判定',console.error('[境界打断] 记忆混乱度达到100且在场景5中，触发精神崩溃结局！'))}(t,I),_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info('[Prompt注入] 境界打断触发坏结局')}catch(n){console.error('[Prompt注入] 境界打断坏结局应用失败:',n)}if(P&&console.info(`[Prompt注入] 纯爱模式错误路线触发：${v}，AI将描写警告场景`),g&&console.info('[Prompt注入] 检测到场景5进入关键词（数据修改由游戏逻辑系统处理）'),h&&console.info('[Prompt注入] 检测到场景5退出条件（数据修改由游戏逻辑系统处理）'),E)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data')),o=getLastMessageId();if(Tt(t,o)){t.梦境数据.场景5||(t.梦境数据.场景5={});const e=t.梦境数据.场景5,s=At(o);e.上次推进记录={楼层ID:o,swipe_id:s},_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info(`[Prompt注入] ROLL 操作，更新 swipe_id 记录: ${s}`)}else{t.梦境数据.场景5||(t.梦境数据.场景5={});const e=t.梦境数据.场景5,s=e.当前步骤??0,r=s+1,i=F(c),a=L[s],u=a?V(i,a):'low',l='high'===u?10:5,f=e.步骤进度记录??[];f.push(l);const d=Math.min((e.完成度??0)+l,100);e.当前步骤=r,e.完成度=d,e.步骤进度记录=f;const m=At(o);e.上次推进记录={楼层ID:o,swipe_id:m},r>=12&&(e.已完成步骤=!0),_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info(`[Prompt注入] 场景5步骤推进: ${s} → ${r}，契合度: ${u}，进度+${l}%，完成度: ${d}%，楼层: ${o}, swipe: ${m}`)}}catch(n){console.error('[Prompt注入] 场景5步骤状态更新失败:',n)}if(m||p)try{const n=Mvu.getMvuData({type:'message',message_id:-1}),t=e.parse(_.get(n,'stat_data'));if(m){t.世界.游戏阶段='梦境',t.世界.状态栏需要刷新=!0;const n=getLastMessageId();t.世界._梦境入口消息ID=n,t.世界._梦境入口天数=t.世界.当前天数,t.世界.梦境选择已锁定=!1,t.世界.已进入过梦境||(t.世界.已进入过梦境=!0);const e=It(t),o=`场景${e}`;if(t.梦境数据[o]||(t.梦境数据[o]={}),t.梦境数据[o].已进入=!0,t.梦境数据[o].进入时间=t.世界.时间,1===e){const n=Et(t);t.赵霞状态.依存度=n.initialDependence,t.赵霞状态.道德底线=n.initialMorality,console.info(`[Prompt注入] 场景1初始化：好感度${t.赵霞状态.纯爱好感度}+亲密度${t.赵霞状态.纯爱亲密度} → 依存度${n.initialDependence}，道德底线${n.initialMorality}（${n.relationshipStage}阶段）`)}console.info(`[Prompt注入] 记录梦境楼层ID: ${n}`);const s=n+1;t.世界._梦境入口记录={楼层ID:s,场景编号:e,类型:'普通梦境'},console.info(`[Prompt注入] 记录梦境入口: 场景${e}，楼层 ${s} (AI回复)`)}if(p){t.世界.游戏阶段='日常',t.世界.状态栏需要刷新=!0;const n=It(t);fn(t,n),console.info(`[Prompt注入] 场景${n}完成判定已执行`);const e=getLastMessageId(),o=e+1;t.世界._梦境退出记录={楼层ID:o,场景编号:n,swipe_id:0},console.info(`[Prompt注入] 记录梦境退出: 场景${n}，楼层 ${o} (AI回复)`);let s=t.世界._梦境入口消息ID;if(void 0===s){const n=Math.max(0,e-10);console.warn(`[Prompt注入] Bug #19 修复：_梦境入口消息ID 丢失，估算入口楼层为 ${n}（当前楼层 ${e}）`),s=n}if(void 0!==s){const o=e;t.世界.上一轮梦境已退出={sceneNum:n,dreamEntryId:s,dreamExitId:o},console.info(`[Prompt注入] 梦境退出检测，场景${n}已标记上一轮退出（入口ID: ${s}，退出ID: ${o}），摘要将在下一轮生成`)}else console.warn('[Prompt注入] 梦境退出但找不到楼层ID，无法设置退出标记')}_.set(n,'stat_data',t),Mvu.replaceMvuData(n,{type:'message',message_id:-1}),console.info('[Prompt注入] 状态已更新: '+(m?'进入梦境':'退出梦境')),setTimeout(()=>{const n=getLastMessageId();console.info(`[Prompt注入] 广播 IFRAME_DATA_REFRESH 事件 (${m?'进入梦境':'退出梦境'})`),eventEmit('IFRAME_DATA_REFRESH',{reason:m?'DREAM_ENTERED':'DREAM_EXITED',message_id:n})},100)}catch(n){console.error('[Prompt注入] 状态更新失败:',n)}f&&-1!==u&&(o[u].content=f,console.info('[Prompt注入] 已替换用户消息'));const W='梦境'===a.世界.游戏阶段;if(m||g||W)for(const n of o)if('string'==typeof n.content&&n.content.includes('<status_current_variable>')){const e=n.content.match(/游戏阶段:\s*(日常|序章)/g);e&&e.length>0&&(n.content=n.content.replace(/游戏阶段:\s*(日常|序章)/g,'游戏阶段: 梦境'),console.info('[Prompt注入] Bug #9 修复：已将 <status_current_variable> 中的游戏阶段替换为梦境'))}if(l&&o.push({role:'system',content:l}),d)if(n){const n=`【回复格式要求】请以以下内容作为回复的开头：\n${d}`;o.push({role:'system',content:n}),console.info('[Prompt注入] Extended thinking 模式，Prefill 转换为 system 提示')}else o.push({role:'assistant',content:d}),console.info('[Prompt注入] 已添加 Prefill');Mt()}catch(n){console.error('[Prompt注入] 执行失败:',n),Mt()}}),console.info('[Prompt注入] 初始化完成')}function wt(n){console.info(`[游戏事件] 广播: ${n.type}`,n.data),eventEmit('GAME_EVENT',n)}function zt(n){const e=n.世界._梦境入口天数??n.世界.当前天数;return Math.min(e,4)}function Ot(n){if(!t.isEndingTime(n))return!1;if('进行中'!==n.世界.循环状态&&'结局判定'!==n.世界.循环状态)return!1;console.info('━━━━━━━━━━━━━━━━━━━━━━'),console.info('🎬 到达第6天凌晨00:00（Day 5结束后），触发结局判定'),console.info('━━━━━━━━━━━━━━━━━━━━━━'),n.世界.循环状态='结局判定';const e=n.梦境数据.正确重构场景.length,o=n.梦境数据.记忆混乱度,s=n.现实数据.丈夫怀疑度;console.info('结局判定数据:'),console.info(`- 正确场景数: ${e}/5`),console.info(`- 记忆混乱度: ${o}`),console.info(`- 丈夫怀疑度: ${s}`),console.info(`- 混乱结局已标记: ${n.梦境数据.混乱结局?.已标记??!1}`);if(Ke(n,!1).triggered)return qe(n),n.结局数据.结局触发时间=t.getCurrentTime(n),console.info('⚠️ 混乱结局已触发（精神崩溃）'),!0;if(s>=100)return n.结局数据.当前结局='坏结局',n.结局数据.结局触发时间=t.getCurrentTime(n),console.info('⚠️ 触发坏结局（被丈夫发现）'),!0;const r=new Set(n.梦境数据.已完成场景),i=5===r.size&&r.has(1)&&r.has(2)&&r.has(3)&&r.has(4)&&r.has(5);if(i&&5===e){const e=k(n);return 3===e?(n.结局数据.当前结局='完美真爱结局',n.结局数据.是完美记忆路线=!0,console.info('✨ 触发完美真爱结局（完美记忆路线 + 全部正确）')):(n.结局数据.当前结局='真好结局',n.结局数据.是完美记忆路线=!1,console.info('🎉 触发真好结局（完成所有场景且全部正确）')),n.结局数据.结局触发时间=t.getCurrentTime(n),n.世界.循环状态='已破解',console.info(`  - 记忆连贯性: ${e}/3`),!0}return i&&e>0&&e<5?(n.结局数据.当前结局='假好结局',n.结局数据.结局触发时间=t.getCurrentTime(n),n.世界.循环状态='已破解',console.info(`🎭 触发假好结局（完成全部场景但有${5-e}个错误选择）`),!0):function(n){if(n.现实数据.丈夫怀疑度>=100)return!1;const e=new Set(n.梦境数据.已完成场景);return!(5===e.size&&e.has(1)&&e.has(2)&&e.has(3)&&e.has(4)&&e.has(5))}(n)?(function(n){const e=n.世界.已进入过梦境,t=e?'普通结局':'纯爱结局';n.结局数据.当前结局=t,n.世界.循环状态='结局判定',n.世界.当前天数=1,n.世界.当前小时=8,n.世界.时间='Day 1, 08:00',n.世界.当前循环轮数=(n.世界.当前循环轮数||1)+1,n.世界.状态栏需要刷新=!0,Qn('世界.当前天数',1),Qn('世界.当前小时',8),Qn('世界.时间','Day 1, 08:00'),Qn('世界.当前循环轮数',n.世界.当前循环轮数),Qn('世界.循环状态','结局判定'),Qn('结局数据.当前结局',t),e?console.info('[普通结局系统] 已设置普通结局状态，时间循环重置到 Day 1, 08:00'):console.info('[纯爱结局系统] 已设置纯爱结局状态（坏结局），时间循环重置到 Day 1, 08:00'),console.info(`[结局系统] 当前循环轮数: ${n.世界.当前循环轮数}`)}(n),n.结局数据.结局触发时间=t.getCurrentTime(n),console.info('🔄 触发普通结局（时间循环重置）'),console.info(`  - 已完成场景: ${r.size}/5`),console.info(`  - 正确场景数: ${e}`),!0):(n.结局数据.当前结局='坏结局',n.结局数据.结局触发时间=t.getCurrentTime(n),console.warn('⚠️ 触发坏结局（兜底逻辑）'),!0)}function Rt(n,e,o){const s={dreamWindowOpen:!1,dreamEnded:!1,firstAwakening:!1,bodySummary:void 0};if(t.isDreamWindowOpen(n)&&'日常'===n.世界.游戏阶段){console.info('🌙 当前时间在梦境入口窗口（22:00-01:59）'),s.dreamWindowOpen=!0;const e=zt(n);wt({type:'DREAM_WINDOW_OPEN',data:{currentScene:e,alreadyCompleted:n.梦境数据.已完成场景.includes(e),canEnterScene5:!0,memoryContinuityPrompt:dn(n,e)}})}const r=n.梦境数据.场景5,i=!0===r?.已进入&&'梦境'===n.世界.游戏阶段;if('梦境'===n.世界.游戏阶段&&(console.info('[checkDreamEvents] 梦境退出检查:'),console.info(`  - 当前小时: ${n.世界.当前小时}`),console.info(`  - isWakeUpTime: ${t.isWakeUpTime(n)}`),console.info(`  - scene5.已进入: ${r?.已进入}`),console.info(`  - isInScene5: ${i}`),console.info(`  - 是否退出: ${t.isWakeUpTime(n)&&!i}`)),'梦境'===n.世界.游戏阶段&&t.isWakeUpTime(n)&&!i){console.info('⏰ 赵霞醒来，梦境结束（场景1-4）'),s.dreamEnded=!0;const e=function(n){const e={},t=['嘴巴','胸部','下体','后穴','精神'];for(const o of t){const t=n.赵霞状态.部位进度[o],s=on(t);e[o]={progress:t,...s}}return e}(n);s.bodySummary=e;const t=zt(n);if(!n.梦境数据.已完成场景.includes(t)){const e=`场景${t}`,o=n.梦境数据[e],s=o?.已进入??!1,r=o?.选择部位??[];s?r.length>0?(fn(n,t),console.info(`[梦境结束] 场景${t}判定完成，玩家选择: [${r.join(', ')}]`)):(console.warn(`[梦境结束] 场景${t}已进入但未选择部位，视为错误`),n.梦境数据.已完成场景.includes(t)||n.梦境数据.已完成场景.push(t),o&&'object'==typeof o&&(o.是否正确=!1)):console.info(`[梦境结束] 场景${t}未进入，保持未触发状态`)}n.世界.游戏阶段='日常',n.世界.状态栏需要刷新=!0,Qn('世界.游戏阶段','日常'),y(n),I(n);let r=n.世界._梦境入口消息ID;if(void 0===r&&void 0!==o){const n=Math.max(0,o-10);console.warn(`[checkDreamEvents] Bug #19 修复：_梦境入口消息ID 丢失，估算入口楼层为 ${n}（当前楼层 ${o}）`),r=n}if(void 0!==r){const e=o;n.世界.上一轮梦境已退出={sceneNum:t,dreamEntryId:r,dreamExitId:e},console.info(`[checkDreamEvents] 场景${t}梦境退出，已标记上一轮退出（入口ID: ${r}，退出ID: ${e}），摘要将在下一轮生成`)}else console.warn('[checkDreamEvents] 梦境退出但找不到楼层ID，无法设置退出标记');n.世界.已进入过梦境||(n.世界.已进入过梦境=!0,s.firstAwakening=!0,console.info('━━━━━━━━━━━━━━━━━━━━━━'),console.info('✨ 首次梦境结束，切换到真相模式'),console.info('界面文本将从纯爱模式切换为真相模式'),console.info('━━━━━━━━━━━━━━━━━━━━━━'),wt({type:'TRUTH_REVEALED',data:{message:'你进入了母亲的梦境...\n在这里，你能看清一切的真相。\n那些你以为的"好感度"，其实是"依存度"。\n那些你以为的"心动值"，其实是"道德底线"。\n你一直在做的事情...原来是这样的吗？'}})),wt({type:'DREAM_ENDED',data:{bodySummary:e,firstAwakening:s.firstAwakening,completedScenes:n.梦境数据.已完成场景,correctScenes:n.梦境数据.正确重构场景,confusionLevel:n.梦境数据.记忆混乱度}})}if(e.includes('睡觉')||e.includes('sleep')){const e=n.世界.当前小时;(e>=23||e<=1)&&(console.info('⚠️ 玩家在梦境窗口时间选择睡觉，将跳过梦境机会'),wt({type:'DREAM_WINDOW_MISSED',data:{message:'你在梦境窗口时间选择了睡觉，错过了进入梦境的机会...'}}))}const a=['进入梦境','进入了梦境','进入她的梦境','进入赵霞的梦境','入梦','睡着','闭上眼睛','做梦','睡了','入睡','梦境'],c=a.some(n=>e.includes(n))||[/进入.*梦境/,/入.*梦/].some(n=>n.test(e)),u=t.isDreamWindowOpen(n),l='日常'===n.世界.游戏阶段;console.info('[checkDreamEvents] 梦境入口检测:'),console.info(`  - userText: "${e.substring(0,50)}${e.length>50?'...':''}"`),console.info(`  - wantToEnterDream: ${c} (关键词: ${a.join(', ')})`),console.info(`  - isDreamWindowOpen: ${u} (当前小时: ${n.世界.当前小时})`),console.info(`  - 游戏阶段: ${n.世界.游戏阶段} (isDaily: ${l})`),console.info(`  - 条件全部满足: ${c&&u&&l}`);const f=Ze(n),d=c&&u&&(l||'梦境'===n.世界.游戏阶段)&&f;if(c&&u&&!f&&console.warn('[checkDreamEvents] 混乱结局待触发，阻止进入普通梦境（场景1-4）'),d){const e=zt(n);if(e<=4){if(n.世界.游戏阶段='梦境',n.世界.状态栏需要刷新=!0,Qn('世界.游戏阶段','梦境'),void 0!==o&&(n.世界._梦境入口消息ID=o),n.世界._梦境入口天数=n.世界.当前天数,n.世界.梦境选择已锁定=!1,et(n,e),Qn('梦境数据.记忆混乱度',n.梦境数据.记忆混乱度),console.info(`[梦境入口] 进入梦境场景${e}，楼层ID=${o}，混乱度=${n.梦境数据.记忆混乱度}`),void 0!==o){const t=o+1;n.世界._梦境入口记录={楼层ID:t,场景编号:e,类型:'普通梦境'},console.info(`[梦境入口] 记录梦境入口: 场景${e}，楼层 ${t} (AI回复)`)}wt({type:'DREAM_ENTERED',data:{sceneNumber:e,memoryContinuityPrompt:dn(n,e),correctTarget:ln[e]}})}}return s}$(async()=>{await waitGlobalInitialized('Mvu'),bt(),Kn=null,ee=null,console.info('[数据保护] 系统已初始化'),console.info('[赵霞游戏逻辑] 数据保护系统已初始化'),eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,(n,e)=>{try{const t=_.get(n,'stat_data'),o=_.get(e,'stat_data');if(!t||!o)return;if(t.世界?.已进入过梦境){const e=t.世界?.当前天数??1;if(e>=5){const s=o.现实数据?.丈夫怀疑度??0,r=t.现实数据?.丈夫怀疑度??0;s!==r&&(_.set(n,'stat_data.现实数据.丈夫怀疑度',s),console.info(`[MVU监听] Day ${e} 疑心度豁免：回滚AI的修改 ${r} → ${s}`))}const s=t.世界?.游戏阶段;if('日常'===s||'序章'===s){const e=['嘴巴','胸部','下体','后穴','精神'];for(const s of e){const e=o.赵霞状态?.部位进度?.[s]??0,r=t.赵霞状态?.部位进度?.[s]??0;e!==r&&(_.set(n,`stat_data.赵霞状态.部位进度.${s}`,e),console.info(`[MVU监听] 日常阶段：回滚AI对${s}的修改 ${r} → ${e}`))}}else{const e=t.梦境数据?.场景5;let s;!0===e?.已进入?(s=['精神'],console.info('[MVU监听] 梦境阶段（场景5）：只允许AI修改精神部位')):(s=['嘴巴','胸部','下体','后穴'],console.info('[MVU监听] 梦境阶段（场景1-4）：只允许AI修改肉体部位'));const r=['嘴巴','胸部','下体','后穴','精神'];for(const e of r){const r=o.赵霞状态?.部位进度?.[e]??0,i=t.赵霞状态?.部位进度?.[e]??0;if(r!==i)if(s.includes(e))if(i>r){const t=Math.min(100,r+20);i>t&&(_.set(n,`stat_data.赵霞状态.部位进度.${e}`,t),console.warn(`[MVU监听] 梦境阶段：${e}进度增幅过大 ${r} → ${i}，限制为 ${t}（每晚上限20%）`))}else i<r&&(_.set(n,`stat_data.赵霞状态.部位进度.${e}`,r),console.warn(`[MVU监听] 梦境阶段：不允许降低${e}进度 ${r} → ${i}，已回滚`));else _.set(n,`stat_data.赵霞状态.部位进度.${e}`,r),console.info(`[MVU监听] 梦境阶段：回滚AI对${e}的非法修改 ${i} → ${r}（当前场景不允许）`)}}const r=t.现实数据?.丈夫心理活动,i=o.现实数据?.丈夫心理活动;if(r&&r!==i){const e=[/<think>/i,/<core_memory>/i,/<!--.*-->/,/Variable check:/i,/Key constraint:/i,/So we are in/i,/WAIT:/i,/writing antThinking/i].some(n=>n.test(r)),t=r.length>500,o=(r.match(/[\u4e00-\u9fa5]/g)||[]).length/r.length,s=o<.3&&r.length>50;(e||t||s)&&(_.set(n,'stat_data.现实数据.丈夫心理活动',i??''),console.warn('[MVU监听] BUG-011修复：检测到AI写入异常的丈夫心理活动（可能是思维链），已回滚',`\n  长度: ${r.length}`,`\n  中文比例: ${(100*o).toFixed(1)}%`,`\n  包含无效标记: ${e}`))}return}const s=['嘴巴','胸部','下体','后穴','精神'];let r=!1,i='';for(const e of s){const s=o.赵霞状态?.部位进度?.[e]??0;let a=t.赵霞状态?.部位进度?.[e]??0;if(a>s){const t=s+20;a>t&&(console.warn(`[MVU监听] ${e}进度变动过大：${s} → ${a}，限制为 ${t}`),a=t,_.set(n,`stat_data.赵霞状态.部位进度.${e}`,a))}a>=100&&!r&&(r=!0,i=e,_.set(n,`stat_data.赵霞状态.部位进度.${e}`,50),console.warn(`[MVU监听] 纯爱模式错误路线触发：${e} 达到 100%，重置为 50%`))}const a=25,c=o.赵霞状态?.纯爱好感度??5,u=t.赵霞状态?.纯爱好感度??5;if(u>c){const e=Math.min(100,c+a);u>e&&(_.set(n,'stat_data.赵霞状态.纯爱好感度',e),console.warn(`[MVU监听] 纯爱好感度增幅过大：${c} → ${u}，限制为 ${e}（每天上限${a}）`))}else u<c&&(_.set(n,'stat_data.赵霞状态.纯爱好感度',c),console.warn(`[MVU监听] 不允许降低纯爱好感度：${c} → ${u}，已回滚`));const l=o.赵霞状态?.纯爱亲密度??0,f=t.赵霞状态?.纯爱亲密度??0;if(f>l){const e=Math.min(100,l+a);f>e&&(_.set(n,'stat_data.赵霞状态.纯爱亲密度',e),console.warn(`[MVU监听] 纯爱亲密度增幅过大：${l} → ${f}，限制为 ${e}（每天上限${a}）`))}else f<l&&(_.set(n,'stat_data.赵霞状态.纯爱亲密度',l),console.warn(`[MVU监听] 不允许降低纯爱亲密度：${l} → ${f}，已回滚`));r&&wt({type:'WRONG_ROUTE_TRIGGERED',data:{part:i,message:`你对${i}的过度关注引起了赵霞的警觉...`,resetTo:50}})}catch(n){console.error('[MVU监听] 处理变量更新失败:',n)}});let n=!1;const a=new Set;function c(n){try{const e=SillyTavern.chat;if(e&&e[n])return e[n].swipe_id??0}catch(n){console.warn('[游戏逻辑] 获取 swipe_id 失败:',n)}return 0}async function u(u,g){try{const h=c(u),E=`${u}:${h}:${g}`;if(console.info(`[游戏逻辑] processGameLogic 进入: message_id=${u}, swipe_id=${h}, eventType=${g}`),'MESSAGE_RECEIVED'===g&&n&&(n=!1,console.info('[首条消息调试] ========== 初始化后的第一条消息 =========='),console.info(`[首条消息调试] message_id=${u}, eventType=${g}`),console.info('[首条消息调试] isFirstMessageAfterInit 已重置为 false')),'MESSAGE_SWIPED'===g){const n=Array.from(a).filter(n=>n.split(':')[0]===String(u));n.forEach(n=>a.delete(n)),console.info(`[游戏逻辑] ROLL 操作，清除 ${n.length} 条旧记录`);const e=Mvu.getMvuData({type:'message',message_id:u}),t=_.get(e,'stat_data');if('梦境'===t?.世界?.游戏阶段&&t?.世界?.梦境选择已锁定){_.set(e,'stat_data.世界.梦境选择已锁定',!1);const n=t.梦境数据?.场景5;if(!0===n?.已进入){const t=n?.当前步骤??0,o=n?.步骤进度记录??[];if(_t=!0,t>0&&o.length>0){const s=t-1,r=o[o.length-1]??0,i=n?.完成度??0,a=Math.max(0,i-r),c=o.slice(0,-1);_.set(e,'stat_data.梦境数据.场景5.当前步骤',s),_.set(e,'stat_data.梦境数据.场景5.完成度',a),_.set(e,'stat_data.梦境数据.场景5.步骤进度记录',c),_.set(e,'stat_data.梦境数据.场景5.选择部位',[]),a<80&&_.set(e,'stat_data.梦境数据.场景5.已完成步骤',!1),console.info(`[游戏逻辑] ROLL 操作，场景5步骤回滚: ${t} → ${s}, 完成度: ${i}% → ${a}% (-${r}%)`)}else _.set(e,'stat_data.梦境数据.场景5.选择部位',[]),console.info('[游戏逻辑] ROLL 操作，场景5已在步骤0，仅重置选择状态')}else{const n=Math.min(t.世界._梦境入口天数??t.世界.当前天数??1,4),o=`场景${n}`;t.梦境数据?.[o]&&_.set(e,`stat_data.梦境数据.${o}.选择部位`,[]),console.info(`[游戏逻辑] ROLL 操作，重置场景${n}选择状态`)}Mvu.replaceMvuData(e,{type:'message',message_id:u})}const o=Mvu.getMvuData({type:'message',message_id:u}),s=_.get(o,'stat_data'),r=s?.世界?._摘要生成记录;if(r&&r.楼层ID===u){const n=c(u);if(n!==r.swipe_id){console.info(`[游戏逻辑] 检测到摘要生成 ROLL 操作: 楼层 ${u}, swipe_id: ${r.swipe_id} → ${n}，恢复待生成摘要标记`),_.set(o,'stat_data.世界.待生成摘要',{sceneNum:r.场景编号,dreamEntryId:r.入口楼层ID,dreamExitId:r.退出楼层ID}),_.set(o,'stat_data.世界._摘要生成记录',void 0);const e=`场景${r.场景编号}`;5===r.场景编号?_.set(o,`stat_data.梦境数据.${e}.上次剧情摘要`,void 0):_.set(o,`stat_data.梦境数据.${e}.剧情摘要`,void 0),await Mvu.replaceMvuData(o,{type:'message',message_id:u}),console.info(`[游戏逻辑] 摘要 ROLL 处理完成，场景${r.场景编号}的摘要将在下次 GENERATION_ENDED 时重新生成`)}}}else if(a.has(E))return void console.info(`[游戏逻辑] 跳过已处理的消息: ${E}`);if(a.add(E),a.size>100){Array.from(a).slice(0,a.size-100).forEach(n=>a.delete(n))}const P=u,v=getLastMessageId();console.info(`[游戏逻辑] 目标楼层=${P}, 最新楼层=${v}, 事件类型=${g}`);const A=Mvu.getMvuData({type:'message',message_id:P}),T=_.get(A,'stat_data');if(!T)return void console.warn('[游戏逻辑] stat_data 不存在');const M=e.parse(JSON.parse(JSON.stringify(T)));let D='',S='';try{const n=getChatMessages(-1),e=getChatMessages(-2),t=n.length>0?n[0]:null,o=e.length>0?e[0]:null;D=o&&'user'===o.role?o.message??'':'',S=t&&'assistant'===t.role?t.message??'':''}catch(n){console.warn('[游戏逻辑] 获取消息失败:',n)}console.info('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━'),console.info(`[游戏逻辑] 开始处理楼层 ${P}`),console.info(`当前时间: ${M.世界.时间}`),console.info(`当前路线: ${En(M)}`),console.info('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');let b=M.世界.上一轮梦境已退出;if(!b&&P>0)try{const n=Mvu.getMvuData({type:'message',message_id:P-1}),e=_.get(n,'stat_data');e?.世界?.上一轮梦境已退出&&(b=e.世界.上一轮梦境已退出,console.info(`[游戏逻辑] Bug #19 修复：从上一楼层(${P-1})恢复退出标记，场景${b.sceneNum}，楼层ID: ${b.dreamEntryId}`))}catch(n){console.warn('[游戏逻辑] 读取上一楼层退出标记失败:',n)}b&&(console.info(`[游戏逻辑] 检测到上一轮场景${b.sceneNum}退出，本轮开始生成摘要（入口ID: ${b.dreamEntryId}，退出ID: ${b.dreamExitId??'未知'}）`),M.世界.待生成摘要={sceneNum:b.sceneNum,dreamEntryId:b.dreamEntryId,dreamExitId:b.dreamExitId},M.世界.上一轮梦境已退出=void 0);const w=t.processTimeSkipRequest(M,D);w.processed&&w.blocked&&w.mvuMessage&&(console.warn(`[游戏逻辑] ${w.mvuMessage}`),toastr.warning(w.mvuMessage,'时间系统',{timeOut:4e3}));const O=['安眠药','吃药','服药','催眠药'].some(n=>D.includes(n))&&('日常'===M.世界.游戏阶段||'序章'===M.世界.游戏阶段)&&M.世界.当前小时>=8&&M.世界.当前小时<20,R=Ze(M);O&&!R&&console.warn('[游戏逻辑] 混乱结局待触发，阻止进入场景5');if(O&&R){console.info('[游戏逻辑] 检测到场景5进入关键词，切换到梦境阶段'),M.世界.游戏阶段='梦境',M.世界.状态栏需要刷新=!0,M.世界._梦境入口消息ID=P,M.世界._梦境入口天数=M.世界.当前天数,M.世界.梦境选择已锁定=!1,Qn('世界.游戏阶段','梦境'),M.世界.已进入过梦境||(M.世界.已进入过梦境=!0);const n=M.梦境数据.场景5;M.梦境数据.场景5||(M.梦境数据.场景5={});const e=M.梦境数据.场景5,t=(n?.进入次数??0)+1;e.已进入=!0,e.进入时间=M.世界.时间,e.进入次数=t,e.进入前混乱度=M.梦境数据.记忆混乱度,e.进入前混乱标记=JSON.parse(JSON.stringify(M.梦境数据.混乱结局)),console.info(`[游戏逻辑] 场景5进入前状态已保存：混乱度=${M.梦境数据.记忆混乱度}，混乱标记=${M.梦境数据.混乱结局.已标记}`),1===t&&(e.当前步骤=0,e.完成度=0,e.步骤进度记录=[],e.已完成步骤=!1,console.info('[游戏逻辑] 场景5首次进入，初始化12步剧情系统（连贯性将在完成时锁定）')),et(M,5),Qn('梦境数据.记忆混乱度',M.梦境数据.记忆混乱度),console.info(`[游戏逻辑] 进入场景5，第${t}次，楼层ID=${P}，混乱度=${M.梦境数据.记忆混乱度}`);const o=P+1;M.世界._梦境入口记录={楼层ID:o,场景编号:5,类型:'场景5'},console.info(`[游戏逻辑] 记录场景5入口: 楼层 ${o} (AI回复)`)}if(console.info(`[首条消息调试] 时间推进检查: eventType=${g}, targetMessageId=${P}`),console.info(`[首条消息调试] 当前时间（推进前）: ${M.世界.时间}, 天数=${M.世界.当前天数}, 小时=${M.世界.当前小时}`),'MESSAGE_RECEIVED'===g){const n=M.世界.时间;console.info(`[首条消息调试] 准备执行 TimeSystem.advance(), timeBeforeAdvance=${n}`),t.advance(M,1);const e=M.世界.时间;if(console.info(`[首条消息调试] TimeSystem.advance() 执行完成, timeAfterAdvance=${e}`),t.validateAndFixTimeConsistency(M),P===getLastMessageId()){const o=t.checkTimeAdvancementAfterScript(n,e,P);o.shouldWarn&&o.message&&toastr.warning(o.message,'时间系统',{timeOut:6e3})}}else'MESSAGE_SWIPED'===g?console.info('[游戏逻辑] MESSAGE_SWIPED: 跳过时间推进，保持当前时间'):console.info('[游戏逻辑] GENERATION_ENDED: 跳过时间推进，已在 MESSAGE_RECEIVED 中处理');if(console.info(`[首条消息调试] 当前时间（推进后）: ${M.世界.时间}, 天数=${M.世界.当前天数}, 小时=${M.世界.当前小时}`),'梦境'===M.世界.游戏阶段){const n=M.梦境数据.场景5;if(!0===n?.已进入&&20===M.世界.当前小时){console.info('[游戏逻辑] 时间推进后检测到20:00，执行场景5状态切换'),M.世界.游戏阶段='日常',M.世界.状态栏需要刷新=!0,Qn('世界.游戏阶段','日常'),y(M),I(M);const n=W(M),e=M.梦境数据.场景5;if(n.completionPercent>=100)M.梦境数据.已完成场景.includes(5)||M.梦境数据.已完成场景.push(5),function(n){const e=j(n);n.梦境数据.记忆连贯性=e.level,n.梦境数据.场景5进入时连贯性=e.level,console.info(`[记忆连贯性] 场景5完成时锁定连贯性：${e.level}级 - ${e.description}`)}(M),console.info(`[游戏逻辑] 场景5正式完成（100%），记忆连贯性已锁定为 ${M.梦境数据.场景5进入时连贯性}`);else{if(void 0!==e?.进入前混乱度){const n=M.梦境数据.记忆混乱度;M.梦境数据.记忆混乱度=e.进入前混乱度,console.info(`[游戏逻辑] 试探性进入：回滚混乱度 ${n} → ${e.进入前混乱度}`)}if(e?.进入前混乱标记){const n=M.梦境数据.混乱结局.已标记;M.梦境数据.混乱结局=JSON.parse(JSON.stringify(e.进入前混乱标记)),console.info(`[游戏逻辑] 试探性进入：回滚混乱标记 ${n} → ${e.进入前混乱标记.已标记}`)}console.info(`[游戏逻辑] 场景5试探性进入（完成度${n.completionPercent}%<100%），已回滚状态，连贯性未锁定`)}e&&(e.已进入=!1),console.info(`[游戏逻辑] 退出场景5（20:00），完成度: ${n.completionPercent}%，步骤: ${n.currentStep}/12，状态: `+(n.completionPercent>=100?'正式完成(100%)':'试探性进入(<100%)'));let t=M.世界._梦境入口消息ID;if(void 0===t){const n=Math.max(0,P-12);console.warn(`[游戏逻辑] Bug #19 修复：场景5 _梦境入口消息ID 丢失，估算入口楼层为 ${n}（当前楼层 ${P}）`),t=n}if(void 0!==t){const n=P;M.世界.上一轮梦境已退出={sceneNum:5,dreamEntryId:t,dreamExitId:n},console.info(`[游戏逻辑] 场景5退出，已标记上一轮退出（入口ID: ${t}，退出ID: ${n}），摘要将在下一轮生成`)}else console.warn('[游戏逻辑] 场景5退出但找不到楼层ID，无法设置退出标记')}}!function(n){const e={};for(const t of Object.keys(Xn)){const o=qn(n,t);e[t]=o}Kn={timestamp:Date.now(),data:e},console.info('[数据保护] 已创建数据快照，保护字段数:',Object.keys(e).length)}(M);const x=function(n){const e=[];let t=!1;const r=n.赵霞状态.依存度,i=n.赵霞状态.道德底线,a=n.赵霞状态.对丈夫依存度;n.赵霞状态.依存度=o(n.赵霞状态.依存度,0,100),n.赵霞状态.道德底线=o(n.赵霞状态.道德底线,0,100),n.赵霞状态.对丈夫依存度=o(n.赵霞状态.对丈夫依存度,-50,100),n.赵霞状态.依存度!==r&&(e.push(`依存度: ${r} → ${n.赵霞状态.依存度}`),t=!0),n.赵霞状态.道德底线!==i&&(e.push(`道德底线: ${i} → ${n.赵霞状态.道德底线}`),t=!0),n.赵霞状态.对丈夫依存度!==a&&(e.push(`对丈夫依存度: ${a} → ${n.赵霞状态.对丈夫依存度}`),t=!0);const c=(u=n.赵霞状态.依存度)<20?1:u<40?2:u<60?3:u<80?4:5;var u;if(n.赵霞状态.当前境界!==c){const o=n.赵霞状态.当前境界;n.赵霞状态.当前境界=c,e.push(`境界: ${o} → ${c}（依存度：${n.赵霞状态.依存度}）`),t=!0,console.info(`[状态验证] 境界自动更新: ${s(o)} → ${s(c)}`)}const l=['嘴巴','胸部','下体','后穴','精神'],f=!n.世界.已进入过梦境;for(const s of l){const r=n.赵霞状态.部位进度[s];let i=o(r,0,100);'精神'===s&&f&&r>0&&(i=0,console.info(`[状态验证] 纯爱模式下精神进度被锁定为0（原值: ${r}）`)),r!==i&&(n.赵霞状态.部位进度[s]=i,e.push(`${s}进度: ${r} → ${i}`),t=!0)}const d=n.梦境数据.记忆混乱度,m=n.现实数据.丈夫怀疑度;n.梦境数据.记忆混乱度=o(n.梦境数据.记忆混乱度,0,100),n.现实数据.丈夫怀疑度=o(n.现实数据.丈夫怀疑度,0,100),n.梦境数据.记忆混乱度!==d&&(e.push(`记忆混乱度: ${d} → ${n.梦境数据.记忆混乱度}`),t=!0),n.现实数据.丈夫怀疑度!==m&&(e.push(`丈夫怀疑度: ${m} → ${n.现实数据.丈夫怀疑度}`),t=!0);const p='梦境'===n.世界.游戏阶段,g=!0===n.梦境数据.场景5?.已进入&&p;n.梦境数据.记忆混乱度>=100&&g&&'未触发'===n.结局数据.当前结局&&'进行中'===n.世界.循环状态&&console.warn('[状态验证] ⚠️ 记忆混乱度达到100且在场景5中，应该触发精神崩溃结局！'),n.现实数据.丈夫怀疑度>=100&&!p&&'未触发'===n.结局数据.当前结局&&'进行中'===n.世界.循环状态&&console.warn('[状态验证] ⚠️ 丈夫怀疑度达到100，应该触发发现结局！');const h=n.世界.当前天数,E=n.世界.当前小时,P='结局判定'===n.世界.循环状态||'已破解'===n.世界.循环状态?99:5;return n.世界.当前天数=o(n.世界.当前天数,1,P),n.世界.当前小时=o(n.世界.当前小时,0,23),n.世界.当前天数!==h&&(e.push(`天数: ${h} → ${n.世界.当前天数}`),t=!0),n.世界.当前小时!==E&&(e.push(`小时: ${E} → ${n.世界.当前小时}`),t=!0),t&&(console.info('[状态验证] 检测到不一致数据，已自动修正:'),e.forEach(n=>console.info(`  - ${n}`))),{fixed:t,changes:e}}(M);x.fixed&&console.info(`[游戏逻辑] 状态已自动修正，共 ${x.changes.length} 项变更`);const L=function(n){const e=n.赵霞状态.当前境界;if(-1===i)return i=e,console.info(`[境界检测] 初始化境界记录: 境界${e}`),{changed:!1,oldRealm:e,newRealm:e};if(e!==i){const n=i;return i=e,console.info(`[境界检测] ✅ 境界变化: ${n} → ${e}\n  纯爱模式: ${s(n)} → ${s(e)}\n  真相模式: ${r(n)} → ${r(e)}`),{changed:!0,oldRealm:n,newRealm:e}}return{changed:!1,oldRealm:e,newRealm:e}}(M);if(L.changed){const n=M.世界.已进入过梦境,e=f(L.newRealm,n),t=l(L.newRealm,n);console.info(`[游戏逻辑] 境界提升: ${L.oldRealm} → ${L.newRealm}\n  境界名: ${e}\n  模式: ${n?'真相模式':'纯爱模式'}\n  风格: ${t.整体风格}\n  气质: ${t.气质关键词.join('、')}`)}const k=!0===M.梦境数据.场景5?.已进入;if('梦境'===M.世界.游戏阶段&&!k){const n=tn(D||'',S||'');Object.values(n).some(n=>n>0)&&(un(M,n),console.info('[游戏逻辑] 梦境部位开发更新完成（二次验证后）'))}M.世界.已进入过梦境&&'日常'===M.世界.游戏阶段&&function(n){if(!n.世界.已进入过梦境)return;const e=n.赵霞状态.部位进度,t=n.赵霞状态.依存度,o=n.赵霞状态.道德底线,s=n.赵霞状态.当前境界,r=d.reduce((n,t)=>n+(e[t]||0),0);if(0===r&&t>0)return void console.warn(`[真相模式数值更新] 跳过更新：部位进度全为0但依存度=${t}，可能是数据未正确继承`,`\n  部位进度: ${JSON.stringify(e)}`,`\n  当前依存度: ${t}`,`\n  当前道德底线: ${o}`,`\n  当前境界: ${s}`);const i=m(e),a=t-i;if(a>15)return void console.warn(`[真相模式数值更新] 跳过更新：检测到依存度异常下降 ${a} 点`,`\n  当前依存度: ${t} → 计算值: ${i}`,`\n  部位进度: ${JSON.stringify(e)}`,`\n  部位进度总和: ${r}`,'\n  原因: 可能是数据未正确继承，阻止更新以保护数据');const c=p(i),u=(l=i)>=80?5:l>=60?4:l>=40?3:l>=20?2:1;var l;const f=i!==n.赵霞状态.依存度,g=c!==n.赵霞状态.道德底线,h=u!==n.赵霞状态.当前境界;(f||g||h)&&(console.info('[真相模式数值更新]'),f&&console.info(`  依存度: ${n.赵霞状态.依存度} → ${i}`),g&&console.info(`  道德底线: ${n.赵霞状态.道德底线} → ${c}`),h&&console.info(`  境界: ${n.赵霞状态.当前境界} → ${u}`)),n.赵霞状态.依存度=i,n.赵霞状态.道德底线=c,n.赵霞状态.当前境界=u}(M),function(n){const e=n.世界.当前小时;let t;if(t=e>=7&&e<8?Math.random()>.5?'卧室':'客厅':e>=8&&e<9?Math.random()>.5?'厨房':'客厅':e>=9&&e<18?'外出':e>=18&&e<19?'客厅':e>=19&&e<21?Math.random()>.5?'客厅':'厨房':e>=21&&e<23?Math.random()>.6?'书房':'客厅':'卧室',n.现实数据.丈夫当前位置!==t){const e=n.现实数据.丈夫当前位置;n.现实数据.丈夫当前位置=t,console.info(`[父亲位置] 更新: ${e} → ${t}（当前时间：${n.世界.当前小时}:00）`)}}(M);const H=void 0!==M.世界.上一轮梦境已退出;H&&console.info('[游戏逻辑] 梦境退出豁免期：跳过怀疑度更新（上一轮刚退出梦境）');const G=M.世界.当前天数>=5||H;if('日常'===M.世界.游戏阶段&&M.世界.已进入过梦境&&!G){!function(n,e){const t=C(n,e);if(t.降低值>0){const e=n.现实数据.丈夫怀疑度,o=Math.max(0,e-t.降低值);return n.现实数据.丈夫怀疑度=o,n.现实数据.今日怀疑度降低=t.今日累计降低,console.info(`[丈夫怀疑度] ${e} → ${o} (-${t.降低值})`,`\n  原因: ${t.原因}`,`\n  今日累计降低: ${t.今日累计降低}/10`),o}t.已达上限&&console.info(`[丈夫怀疑度] ${t.原因}`),n.现实数据.丈夫怀疑度}(M,D);const n=function(n,e=''){const t=N(n,e);if(t.增加值>0){const e=n.现实数据.丈夫怀疑度,o=Math.min(100,e+t.增加值);return n.现实数据.丈夫怀疑度=o,console.info(`[丈夫怀疑度] ${e} → ${o} (+${t.增加值})`,`\n  详细: 服装${t.详细.服装暴露} + 妆容${t.详细.妆容浓度} + 亲密${t.详细.亲密行为} + 境界${t.详细.境界外显}`),o>=100?console.warn('[丈夫怀疑度] ⚠️ 怀疑度达到100！将触发坏结局'):o>=80?console.warn('[丈夫怀疑度] ⚠️ 怀疑度超过80，丈夫开始密切关注'):o>=50&&console.info('[丈夫怀疑度] 怀疑度超过50，丈夫有所察觉'),o}return n.现实数据.丈夫怀疑度}(M,D);n>=100&&'未触发'===M.结局数据.当前结局&&(M.结局数据.当前结局='坏结局',M.世界.循环状态='结局判定',M.结局数据.结局触发时间=t.getCurrentTime(M),Qn('结局数据.当前结局','坏结局'),Qn('世界.循环状态','结局判定'),console.warn('[游戏逻辑] ⚠️ 丈夫怀疑度达到100，立即触发坏结局（被丈夫发现）'))}if(Rt(M,D,P),S){const n=$n(S),e=S.replace(/<HusbandThought>[\s\S]*?<\/HusbandThought>/gi,'').replace(/<!--\s*BODY_PROGRESS:\s*[^-]*?-->/gi,'').trim();if(e!==S)try{const n=getLastMessageId();await setChatMessages([{message_id:n,message:e}],{refresh:'affected'}),console.info(`[游戏逻辑] 已从AI文本中移除内部标记（HusbandThought/BODY_PROGRESS），楼层=${n}`)}catch(n){console.warn('[游戏逻辑] 移除内部标记失败:',n)}n&&(M.现实数据.丈夫心理活动=n,console.info(`[游戏逻辑] 解析到苦主视角: ${n}`),hn(M)?wt({type:'HUSBAND_PERSPECTIVE',data:{text:n,realm:M.赵霞状态.当前境界,suspicionLevel:M.现实数据.丈夫怀疑度}}):console.info('[游戏逻辑] AI生成了苦主视角，已存储但当前不满足显示条件'))}const B=Ot(M);if(ce(M)&&S){const n=ue(M);if(!n.isComplete){const e=M.世界.当前小时,t=ge(n,S,D,e);let o=t.newState;t.timeBlocked?(console.info(`[游戏逻辑] 真好结局阶段${o.currentPhase}已完成条件，但时间锁定：${t.timeBlocked.reason}`),console.info(`[游戏逻辑] 真好结局锚点更新: 阶段${o.currentPhase}, 锚点[${o.completedAnchors.join(', ')}]`)):t.phaseAdvanced?(console.info(`[游戏逻辑] 真好结局阶段推进: ${n.currentPhase} → ${o.currentPhase}`),o.isComplete&&(M.结局数据.后日谈已解锁=!0,M.世界.循环状态='已破解',console.info('[游戏逻辑] 🎊 真好结局完成！后日谈已解锁'))):console.info(`[游戏逻辑] 真好结局锚点更新: 阶段${o.currentPhase}, 锚点[${o.completedAnchors.join(', ')}]`),le(M,o)}}if(ye(M)&&S){const n=Ie(M);if(!n.isComplete){const e=M.世界.当前小时,t=De(n,S,D,e);let o=t.newState;t.timeBlocked?(console.info(`[游戏逻辑] 假好结局阶段${o.currentPhase}已完成条件，但时间锁定：${t.timeBlocked.reason}`),console.info(`[游戏逻辑] 假好结局锚点更新: 阶段${o.currentPhase}, 锚点[${o.completedAnchors.join(', ')}]`)):t.phaseAdvanced?(console.info(`[游戏逻辑] 假好结局阶段推进: ${n.currentPhase} → ${o.currentPhase}`),o.isComplete&&console.info('[游戏逻辑] 🎭 假好结局完成！秘密关系确立')):console.info(`[游戏逻辑] 假好结局锚点更新: 阶段${o.currentPhase}, 锚点[${o.completedAnchors.join(', ')}]`),Ae(M,o)}}if(ze(M)&&S){const n=Oe(M);if(!n.isComplete){const e=Ce(n,S,0,M.世界.当前小时);let t=e.newState;e.timeBlocked?(console.info(`[游戏逻辑] 完美真爱结局阶段${t.currentPhase}已完成条件，但时间锁定：${e.timeBlocked.reason}`),console.info(`[游戏逻辑] 完美真爱结局锚点更新: 阶段${t.currentPhase}, 锚点[${t.completedAnchors.join(', ')}]`)):e.phaseAdvanced?(console.info(`[游戏逻辑] 完美真爱结局阶段推进: ${n.currentPhase} → ${t.currentPhase}`),t.isComplete&&(M.结局数据.后日谈已解锁=!0,M.世界.循环状态='已破解',console.info('[游戏逻辑] 💕 完美真爱结局完成！后日谈已解锁'))):console.info(`[游戏逻辑] 完美真爱结局锚点更新: 阶段${t.currentPhase}, 锚点[${t.completedAnchors.join(', ')}]`),Re(M,t)}}M.调试?.启用调试日志&&t.validate(M);const U=function(n,e){const t=e||Kn;if(!t)return console.warn('[数据保护] 无可用快照，跳过验证'),{detected:!1,tamperedFields:[],restoredFields:[]};const o={detected:!1,tamperedFields:[],restoredFields:[]},s=n,r='梦境'===qn(s,'世界.游戏阶段'),i=qn(s,'世界.当前小时'),a=22===i||23===i||0===i||1===i,c=i>=8&&i<20;for(const[n,e]of Object.entries(Xn)){const i=t.data[n],u=qn(s,n);if(r&&(n.startsWith('赵霞状态.部位进度.')||n.startsWith('梦境数据.当晚进度记录.')))console.info(`[数据保护] 梦境豁免: ${n} (${JSON.stringify(i)} → ${JSON.stringify(u)})`);else if('世界.游戏阶段'!==n||!a&&!c)if('世界.循环状态'===n&&[{from:'进行中',to:'结局判定'},{from:'结局判定',to:'已破解'}].some(n=>i===n.from&&u===n.to))console.info(`[数据保护] 结局状态转换豁免: ${n} (${JSON.stringify(i)} → ${JSON.stringify(u)})`);else if('结局数据.当前结局'===n&&'未触发'===i&&['坏结局','普通结局','真好结局','假好结局','完美真爱结局'].includes(u))console.info(`[数据保护] 结局触发豁免: ${n} (${JSON.stringify(i)} → ${JSON.stringify(u)})`);else{if(!0===qn(s,'世界.已进入过梦境')&&['赵霞状态.依存度','赵霞状态.道德底线','赵霞状态.当前境界','现实数据.丈夫怀疑度','梦境数据.记忆混乱度'].includes(n)){const t='number'==typeof i?i:0,r='number'==typeof u?u:0;if(t>10&&(0===r||1===r||100===r&&'赵霞状态.道德底线'===n||'赵霞状态.道德底线'===n&&r>t+30||'赵霞状态.依存度'===n&&t-r>15||'赵霞状态.当前境界'===n&&t-r>=2)){console.warn(`[数据保护] 检测到异常重置，阻止修改: ${n}`,`\n  原值: ${i}`,`\n  异常新值: ${u}`,'\n  原因: 可能是数据继承问题导致的核心数值被重置'),Zn(s,n,i),o.detected=!0,o.tamperedFields.push({path:n,level:e,originalValue:i,tamperedValue:u}),o.restoredFields.push(n);continue}ne(i,u)||console.info(`[数据保护] 真相模式豁免: ${n} (${JSON.stringify(i)} → ${JSON.stringify(u)})`);continue}ne(i,u)||(o.detected=!0,o.tamperedFields.push({path:n,level:e,originalValue:i,tamperedValue:u}),Zn(s,n,i),o.restoredFields.push(n),console.warn(`[数据保护] 检测到篡改: ${n}`,`\n  保护级别: ${e}`,`\n  原始值: ${JSON.stringify(i)}`,`\n  篡改值: ${JSON.stringify(u)}`,'\n  已还原'))}else ne(i,u)||console.info(`[数据保护] 时间窗口豁免: ${n} (${JSON.stringify(i)} → ${JSON.stringify(u)})`)}if(o.detected){console.warn(`[数据保护] 共检测到 ${o.tamperedFields.length} 个字段被篡改，已全部还原`);const n=['世界.当前天数','世界.当前小时','世界.时间'];if(o.tamperedFields.some(e=>n.includes(e.path))){const n=t.data['世界.当前天数'],e=t.data['世界.当前小时'],o=t.data['世界.时间'],r=`Day ${n}, ${e.toString().padStart(2,'0')}:00`;o!==r&&(console.warn('[数据保护] 时间联动修复：快照不一致，以数值为准',`\n  天数: ${n}, 小时: ${e}`,`\n  快照时间: ${o} → 修正为: ${r}`),Zn(s,'世界.时间',r)),Zn(s,'世界.当前天数',n),Zn(s,'世界.当前小时',e),Zn(s,'世界.时间',o!==r?r:o),console.info(`[数据保护] 时间联动回滚完成：Day ${n}, ${e}:00`)}}else console.info('[数据保护] 数据完整性验证通过');return o}(M);U.detected&&(console.warn(`[游戏逻辑] 数据保护系统检测到 ${U.tamperedFields.length} 个字段被篡改并已还原`),M.调试?.启用调试日志&&console.info(function(n){if(!n.detected)return'数据保护报告: 所有字段完整，无篡改检测';let e='=== 数据保护报告 ===\n';e+=`检测时间: ${(new Date).toISOString()}\n`,e+=`篡改字段数: ${n.tamperedFields.length}\n`,e+=`已还原字段数: ${n.restoredFields.length}\n\n`,e+='--- 篡改详情 ---\n';for(const t of n.tamperedFields)e+=`字段: ${t.path}\n`,e+=`  保护级别: ${t.level}\n`,e+=`  原始值: ${JSON.stringify(t.originalValue)}\n`,e+=`  篡改值: ${JSON.stringify(t.tamperedValue)}\n\n`;return e}(U)));const F=e.parse(M);console.info(`[首条消息调试] 准备保存数据到楼层 ${P}`),console.info(`[首条消息调试] 保存前时间: ${F.世界.时间}, 天数=${F.世界.当前天数}, 小时=${F.世界.当前小时}`);const V=JSON.parse(JSON.stringify(A));if(_.set(V,'stat_data',F),await Mvu.replaceMvuData(V,{type:'message',message_id:P}),console.info('[首条消息调试] Mvu.replaceMvuData 执行完成'),console.info('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━'),console.info(`[游戏逻辑] 数据已写入楼层 ${P}`),console.info(`最新时间: ${F.世界.时间}`),console.info(`当前路线: ${En(F)}`),console.info(`当前境界: ${F.赵霞状态.当前境界}`),console.info(`依存度: ${F.赵霞状态.依存度}`),console.info(`丈夫怀疑度: ${F.现实数据.丈夫怀疑度}`),console.info(`记忆混乱度: ${F.梦境数据.记忆混乱度}`),console.info(`循环状态: ${F.世界.循环状态}`),B&&console.info(`🎬 结局: ${F.结局数据.当前结局}`),console.info('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n'),F.世界.待生成摘要&&'GENERATION_ENDED'===g){const n=F.世界.待生成摘要;console.info(`[游戏逻辑] 检测到待生成摘要标记，场景${n.sceneNum}，入口: ${n.dreamEntryId}，退出: ${n.dreamExitId??'未知'}`);try{const e=await async function(n,e){if(!n)return console.warn('[记忆摘要] 未找到梦境入口楼层ID'),'';try{const t=SillyTavern.chat;if(!t||!Array.isArray(t))return console.warn('[记忆摘要] 无法访问聊天消息数组'),'';const o=n;if(o<0||o>=t.length)return console.warn(`[记忆摘要] 无效的梦境入口楼层ID: ${n}`),'';let s;void 0!==e&&e>=o?(s=Math.min(e+1,t.length),console.info(`[记忆摘要] Bug #25：限制收集范围到退出楼层 ${e}`)):(s=t.length,console.warn('[记忆摘要] Bug #25：未提供退出楼层ID，收集到数组末尾（可能包含日常消息）'));const r=t.slice(o,s),i=r.filter(n=>n.is_user&&n.mes&&'string'==typeof n.mes&&n.mes.trim()).map(n=>`- ${n.mes.trim()}`).join('\n'),a=r.filter(n=>!n.is_user&&n.mes&&'string'==typeof n.mes),c=[];for(const n of a){const e=pn(n.mes);e&&c.push(e)}const u=r.filter(n=>n.is_user).length,l=a.length;console.info(`[记忆摘要] 收集到 ${u} 条玩家输入，${l} 条AI输出（楼层 ${o} ~ ${s-1}）`);let f=i;return c.length>0&&(f+=`\n\n【赵霞的情感变化】\n${[...new Set(c)].slice(0,5).map(n=>`→ ${n}`).join('\n')}`),f}catch(n){return console.error('[记忆摘要] 获取梦境对话失败:',n),''}}(n.dreamEntryId,n.dreamExitId);console.info(`[游戏逻辑] 获取到玩家行为记录: ${e.length}字符`);const t=await async function(n,e,t){const o=mn[e]||{title:`场景${e}`,age:0,theme:'未知'};if(!t||t.trim().length<20)return console.warn('[记忆摘要] 玩家行为记录过短，使用默认文本'),`【${o.title}】\n（记忆内容不完整）`;console.info(`[记忆摘要] 场景${e}（${o.title}）摘要生成完成`),console.info(`[记忆摘要] 玩家行为记录长度: ${t.length} 字符`);const s=`【${o.title}】\n${t}`;return console.info(`[记忆摘要] 摘要已生成，总长度: ${s.length} 字符`),s}(0,n.sceneNum,e),o=`场景${n.sceneNum}`,s=F.梦境数据[o];s&&'object'==typeof s&&(5===n.sceneNum?s.上次剧情摘要=t:s.剧情摘要=t),F.世界.待生成摘要=void 0;const r=c(P);F.世界._摘要生成记录={楼层ID:P,swipe_id:r,场景编号:n.sceneNum,入口楼层ID:n.dreamEntryId,退出楼层ID:n.dreamExitId},console.info(`[游戏逻辑] 记录摘要生成: 楼层${P}, swipe_id=${r}, 场景${n.sceneNum}`);const i=JSON.parse(JSON.stringify(A));_.set(i,'stat_data',F),await Mvu.replaceMvuData(i,{type:'message',message_id:P}),console.info(`[游戏逻辑] 场景${n.sceneNum}摘要已保存（${t.length}字），标记已清除`)}catch(n){console.error('[游戏逻辑] 生成摘要失败:',n),F.世界.待生成摘要=void 0;const e=JSON.parse(JSON.stringify(A));_.set(e,'stat_data',F),await Mvu.replaceMvuData(e,{type:'message',message_id:P})}}const J=Mvu.getMvuData({type:'message',message_id:P}),Y=_.get(J,'stat_data'),X=t.getCurrentTime(F);Y?.世界?.时间!==X?(console.error('[游戏逻辑] ⚠️ 时间写入不一致'),console.error(`期望: ${X}`),console.error(`实际: ${Y?.世界?.时间}`)):console.info(`[游戏逻辑] ✅ ${g} 处理完成`)}catch(n){console.error('[游戏逻辑] 执行错误:',n)}}eventOn(Mvu.events.VARIABLE_INITIALIZED,()=>{n=!0,console.info('[首条消息调试] VARIABLE_INITIALIZED 触发，isFirstMessageAfterInit 设为 true')}),eventOn(tavern_events.MESSAGE_RECEIVED,n=>{const e=Number(n);console.info(`[游戏逻辑] 收到 MESSAGE_RECEIVED 事件，message_id=${e}`),setTimeout(()=>{u(e,'MESSAGE_RECEIVED')},300)}),eventOn(tavern_events.MESSAGE_SWIPED,n=>{const e=Number(n);console.info(`[游戏逻辑] 收到 MESSAGE_SWIPED 事件，message_id=${e}`),setTimeout(()=>{u(e,'MESSAGE_SWIPED')},300)}),eventOn(tavern_events.MESSAGE_DELETED,n=>{const e=Number(n);console.info(`[游戏逻辑] 收到 MESSAGE_DELETED 事件，message_id=${e}`);const t=Array.from(a).filter(n=>parseInt(n.split(':')[0],10)>=e);t.length>0&&(t.forEach(n=>a.delete(n)),console.info(`[游戏逻辑] MESSAGE_DELETED 清除 ${t.length} 条处理记录`))}),eventOn(tavern_events.GENERATION_ENDED,n=>{console.info(`[游戏逻辑] 收到 GENERATION_ENDED 事件，原始 message_id=${n}`),setTimeout(()=>{try{const n=getLastMessageId();console.info(`[游戏逻辑] GENERATION_ENDED 使用实际 message_id=${n}`),u(n,'GENERATION_ENDED')}catch(e){console.warn('[游戏逻辑] GENERATION_ENDED 获取最新消息失败:',e),u(Number(n),'GENERATION_ENDED')}},300)}),console.info('[赵霞游戏逻辑] 加载完成，已注册所有事件监听')});
//# sourceMappingURL=index.js.map