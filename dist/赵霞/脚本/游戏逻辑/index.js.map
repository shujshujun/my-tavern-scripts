{"version":3,"file":"index.js","mappings":"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ACA,KACA,KACA,OACA,OACA,OACA,MACA,MAEA,MACA,MACA,MACA,MACA,MACA,KACA,KACA,MACA,MACA,MACA,MAEA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KAEA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MAEF,GAAI,CAEF,KACA,KACA,KACA,KACA,KACA,OACA,OACA,KACA,KACA,OACA,OACA,MACA,OAEA,KACA,KACA,KACA,KACA,MACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KAEA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KAEA,KACA,MACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MAEF,GAAI,CAEF,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,MAEA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,OACA,KACA,MAEF,GAAI,CACF,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,QACA,OACA,OACA,OACA,SAwBEC,GAA8B,CAElC,GAAI,CACF,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,KACA,KACA,KACA,KACA,KACA,MACA,MAIF,GAAI,CACF,IACA,KACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,KACA,MACA,KACA,KACA,KACA,KACA,KACA,MAIF,GAAI,CACF,KACA,KACA,KACA,KACA,KACA,KACA,IACA,IACA,IACA,KACA,KACA,KACA,KACA,MACA,OACA,KACA,MAIF,GAAI,CACF,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,IACA,KACA,KACA,KACA,KACA,KACA,KACA,MAIF,GAAI,CACF,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,KACA,KACA,OA8CG,SAASC,GAA2BvL,EAAmBwL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","sources":["src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src//schema.ts","src://tavern_helper_template/src////timeSystem.ts","src://tavern_helper_template/src////stateValidation.ts","src://tavern_helper_template/src////appearanceSystem.ts","src://tavern_helper_template/src////scene5System.ts","src://tavern_helper_template/src////dreamKeywordDetection.ts","src://tavern_helper_template/src////dualTrackSystem.ts","src://tavern_helper_template/src////boundaryInterruption.ts","src://tavern_helper_template/src////dangerousContentDetection.ts","src://tavern_helper_template/src////badEndingSystem.ts","src://tavern_helper_template/src////dataProtection.ts","src://tavern_helper_template/src////normalEndingSystem.ts","src://tavern_helper_template/src////trueEndingSystem.ts","src://tavern_helper_template/src////falseEndingSystem.ts","src://tavern_helper_template/src////perfectTrueEndingSystem.ts","src://tavern_helper_template/src////confusionEndingSystem.ts","src://tavern_helper_template/src////afterStorySystem.ts","src://tavern_helper_template/src////promptInjection.ts","src://tavern_helper_template/src////index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = z;","import { z } from 'zod';\n\n/**\n *  - \n *\n * \n * 1. BUG\n * 2. /\n * 3. 5\n */\n\nexport const Schema = z.object({\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // --- BUG ---\n      // Bug #18 5\n      // stateValidation.ts \"\"1-5\n      : z.number().min(1).max(99).default(1), // 1-5>5\n      : z.number().min(0).max(23).default(8), // 0-23\n      : z.string().default('Day 1, 08:00'), // \"Day 1, 08:00\"\n      : z.number().default(0), // Date.now()\n      : z.boolean().default(true), // \n\n      // ---  ---\n      : z.enum(['', '', '']).default(''),\n      : z.number().default(1), // \n\n      // ---  ---\n      : z.boolean().default(false), // false=, true=\n\n      // ---  ---\n      : z.enum(['', '', '', '']).default(''),\n\n      // --- UI---\n      // AI\n      _ID: z.number().optional(), // ID\n      _: z.number().optional(), // \n      : z.boolean().default(false), // \n\n      // ---  ---\n      : z\n        .object({\n          sceneNum: z.number().min(1).max(5), // \n          dreamEntryId: z.number(), // ID\n          dreamExitId: z.number().optional(), // Bug #25 ID\n        })\n        .optional(), // undefined \n\n      // ---  ---\n      : z\n        .object({\n          sceneNum: z.number().min(1).max(5), // \n          dreamEntryId: z.number(), // ID\n          dreamExitId: z.number().optional(), // Bug #25 ID\n        })\n        .optional(), // undefined \n\n      // --- ROLL Bug #21  ROLL  ---\n      // ID CHAT_COMPLETION_PROMPT_READY  ROLL\n      _: z\n        .object({\n          ID: z.number().default(-1), //  AI ID\n          : z.number().min(1).max(5).optional(), // 1-4  5\n          swipe_id: z.number().default(-1), // \n        })\n        .optional(),\n\n      // --- ROLL  ROLL  ---\n      // ID CHAT_COMPLETION_PROMPT_READY  ROLL\n      _: z\n        .object({\n          ID: z.number().default(-1), //  AI ID\n          : z.number().min(1).max(5).optional(), // 1-4  5\n          : z.enum(['', '5']).optional(), // \n        })\n        .optional(),\n\n      // --- ROLL  ROLL  ---\n      // IDswipe_id ROLL \n      //  ROLL \"\"\n      _: z\n        .object({\n          ID: z.number().default(-1), // ID\n          swipe_id: z.number().default(0), //  swipe_id\n          : z.number().min(1).max(5).optional(), // \n          ID: z.number().optional(), // ID\n          ID: z.number().optional(), // ID\n        })\n        .optional(),\n    })\n    .default({\n      : 1,\n      : 8,\n      : 'Day 1, 08:00',\n      : 0,\n      : true,\n      : '',\n      : 1,\n      : false,\n      : '',\n      : false,\n    }),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // ---  ---\n      : z.number().min(0).max(100).default(0), // \n      : z.number().min(0).max(100).default(80), // \n      : z.number().min(-50).max(100).default(60), // \n\n      // ---  ---\n      : z.number().min(0).max(100).default(5), // AI\n      : z.number().min(0).max(100).default(0), // \n      // (0-19)  (20-39)  (40-59)  (60-79)  (80+)\n\n      // ---  ---\n      //  =   /20 = \n      : z.number().min(1).max(5).default(1), // 1-5\n      // 1 :  0-19\n      // 2 :  20-39\n      // 3 :  40-59\n      // 4 :  60-79\n      // 5 :  80+\n\n      // ---  ---\n      : z\n        .object({\n          : z.number().min(0).max(100).default(0),\n          : z.number().min(0).max(100).default(0),\n          : z.number().min(0).max(100).default(0),\n          : z.number().min(0).max(100).default(0),\n          : z.number().min(0).max(100).default(0),\n        })\n        .default({\n          : 0,\n          : 0,\n          : 0,\n          : 0,\n          : 0,\n        }),\n\n      // --- AI ---\n      : z.string().default(''),\n      : z\n        .object({\n          : z.string().default(''),\n          : z.string().default(''),\n          : z.string().default(''),\n          : z.string().default(''),\n          : z.string().default(''),\n          : z.string().default(''),\n        })\n        .default({\n          : '',\n          : '',\n          : '',\n          : '',\n          : '',\n          : '',\n        }),\n      // --- AI ---\n      : z.string().default(''), // ///+//\n      : z.string().default(''), // \n      : z.array(z.string()).default([]), // \n\n      : z.string().default('...'),\n    })\n    .default({\n      : 0,\n      : 80,\n      : 60,\n      : 5,\n      : 0,\n      : 1,\n      : {\n        : 0,\n        : 0,\n        : 0,\n        : 0,\n        : 0,\n      },\n      : '',\n      : {\n        : '',\n        : '',\n        : '',\n        : '',\n        : '',\n        : '',\n      },\n      : '',\n      : '',\n      : [],\n      : '...',\n    }),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // ---  ---\n      : z.number().min(16).max(40).optional(), // 116\n      : z.string().optional(), // \n      : z.string().optional(), // \n      : z.string().optional(), // \n\n      // ---  ---\n      : z.array(z.number()).default([]), // [1, 2, 3, 4, 5]\n      : z.array(z.number()).default([]), // \n\n      // ---  ---\n      1: z\n        .object({\n          : z.boolean().default(false),\n          : z.array(z.string()).default([]), // \n          : z.boolean().optional(),\n          : z.string().optional(), // \"Day 1, 23:00\"\n          : z.number().default(0),\n          : z.string().optional(), // AI\n        })\n        .optional(),\n\n      2: z\n        .object({\n          : z.boolean().default(false),\n          : z.array(z.string()).default([]),\n          : z.boolean().optional(),\n          : z.string().optional(),\n          : z.number().default(0),\n          : z.string().optional(), // AI\n        })\n        .optional(),\n\n      3: z\n        .object({\n          : z.boolean().default(false),\n          : z.array(z.string()).default([]),\n          : z.boolean().optional(),\n          : z.string().optional(),\n          : z.number().default(0),\n          : z.string().optional(), // AI\n        })\n        .optional(),\n\n      4: z\n        .object({\n          : z.boolean().default(false),\n          : z.array(z.string()).default([]),\n          : z.boolean().optional(),\n          : z.string().optional(),\n          : z.number().default(0),\n          : z.string().optional(), // AI\n        })\n        .optional(),\n\n      5: z\n        .object({\n          : z.boolean().default(false),\n          : z.array(z.string()).default([]),\n          : z.boolean().optional(),\n          : z.string().optional(),\n          : z.number().default(0),\n          : z.boolean().default(true), // 5\n\n          // --- 512 ---\n          : z.number().default(0), // 5\n          : z.number().min(0).max(12).default(0), // 0=1-12=\n          : z.boolean().default(false), // 12\n          : z.string().optional(), // AI\n          // ---  ---\n          // \n          // - +10%+5%\n          // - 12 = 120%100%\n          // - 40%100%\n          : z.number().min(0).max(100).default(0), // 100%\n          : z.array(z.number()).default([]), //  [10, 5, 10, ...]\n\n          // --- ROLL Bug #11  ---\n          //  swipe_id CHAT_COMPLETION_PROMPT_READY  ROLL\n          : z\n            .object({\n              ID: z.number().default(-1), // ID\n              swipe_id: z.number().default(-1), //  swipe_id\n            })\n            .optional(),\n\n          // --- Bug #13  ---\n          // 5<100%\n          // \"\"5\n          : z.number().min(0).max(100).optional(), // 5\n          : z\n            .object({\n              : z.boolean().default(false),\n              : z.number().nullable().default(null),\n              : z.number().nullable().default(null),\n              : z.boolean().default(false),\n              : z.enum(['', '']).nullable().default(null),\n              : z.number().default(0),\n            })\n            .optional(), // 5\n        })\n        .optional(),\n\n      // ---  ---\n      // 0\n      // - 1: 40\n      // - 2: 60\n      // - 3: 80\n      // - 4: \n      // - 5: 80\n      // 5+7+10=100\n      : z.number().min(0).max(100).default(0), // 100\n\n      // --- 5 ---\n      // 5\"\"/\n      : z\n        .object({\n          : z.boolean().default(false), // \n          : z.number().nullable().default(null), // . * 24 + .\n          : z.number().nullable().default(null), //  + 1\n          : z.boolean().default(false), // \n          : z.enum(['', '']).nullable().default(null), // \n          : z.number().default(0), // 5\n        })\n        .default({\n          : false,\n          : null,\n          : null,\n          : false,\n          : null,\n          : 0,\n        }),\n\n      // ---  ---\n      // 51-2-3\n      // 0: 5\n      // 1: 1\n      // 2: 1+2+\n      // 3: 1+2+3\n      // 4527 vs 25\n      : z.number().min(0).max(3).default(0),\n      // 5\n      5: z.number().min(0).max(3).optional(),\n\n      // --- 20% ---\n      : z\n        .object({\n          : z.number().default(0), // \n          : z.number().default(0),\n          : z.number().default(0),\n          : z.number().default(0),\n          : z.number().default(0),\n          : z.number().default(0),\n        })\n        .default({ : 0, : 0, : 0, : 0, : 0, : 0 }),\n    })\n    .default({\n      : [],\n      : [],\n      : 0,\n      : {\n        : false,\n        : null,\n        : null,\n        : false,\n        : null,\n        : 0,\n      },\n      : 0,\n      : { : 0, : 0, : 0, : 0, : 0, : 0 },\n    }),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // ---  ---\n      : z.number().min(0).max(100).default(0), // 100\n\n      // --- Bug #005  ---\n      // /10\n      : z.number().min(0).max(10).default(0), // \n      : z.number().default(0), // \n\n      // ---  ---\n      : z.enum(['', '', '', '', '']).default(''),\n\n      // --- AI ---\n      : z.string().optional(), // 50\n    })\n    .default({\n      : 0,\n      : 0,\n      : 0,\n      : '',\n    }),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // 2026-01-18 \n      // - \n      // - 5+\"\"\n      // -  + =3\n      // - 5\n      // - >=100\n      // - >=100confusionEndingSystem\n      // - \n      // - +\n      : z\n        .enum(['', '', '', '', '', '', ''])\n        .default(''),\n      : z.string().optional(), // \n      : z.boolean().default(false),\n      // \n      : z.boolean().default(false), // =3\n\n      // --- ROLL  ROLL  ---\n      // ID CHAT_COMPLETION_PROMPT_READY  ROLL\n      _: z\n        .object({\n          ID: z.number().default(-1), //  AI ID\n          : z.enum(['', '', '']).optional(),\n        })\n        .optional(),\n\n      // --- 2026-01-17  ---\n      // \"\"\n      : z\n        .object({\n          : z.boolean().default(false), // \n          : z.number().min(0).max(2).default(0), // 0-2\n          : z.boolean().default(false), // \n          : z.boolean().default(false), // \n          // --- ROLL Bug #22  ---\n          // IDswipe_id ROLL \n          : z\n            .object({\n              ID: z.number().default(-1), // ID\n              swipe_id: z.number().default(0), //  swipe_id\n            })\n            .optional(),\n        })\n        .default({\n          : false,\n          : 0,\n          : false,\n          : false,\n        }),\n    })\n    .default({\n      : '',\n      : false,\n      : false,\n      : {\n        : false,\n        : 0,\n        : false,\n        : false,\n      },\n    }),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // ---  ---\n      isActive: z.boolean().default(false), // \n      isComplete: z.boolean().default(false), // \n\n      // ---  ---\n      currentPhase: z.number().min(0).max(9).default(0), //  (0-9)\n      turnsInPhase: z.number().default(0), // \n      totalTurns: z.number().default(0), // \n\n      // ---  ---\n      completedAnchors: z.array(z.string()).default([]), // \n\n      // --- Bug #15  ---\n      noProgressTurns: z.number().default(0), // \n      hintGiven: z.boolean().default(false), // \n    })\n    .optional(),\n\n  // ============================================\n  // 12\n  // ============================================\n  : z\n    .object({\n      // ---  ---\n      isActive: z.boolean().default(false), // \n      isComplete: z.boolean().default(false), // \n\n      // ---  ---\n      currentPhase: z.number().min(0).max(11).default(0), //  (0-11)\n      turnsInPhase: z.number().default(0), // \n      totalTurns: z.number().default(0), // \n\n      // ---  ---\n      completedAnchors: z.array(z.string()).default([]), // \n\n      // --- Bug #15  ---\n      noProgressTurns: z.number().default(0), // \n      hintGiven: z.boolean().default(false), // \n    })\n    .optional(),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // ---  ---\n      isActive: z.boolean().default(false), // \n      isComplete: z.boolean().default(false), // \n\n      // ---  ---\n      currentPhase: z.number().min(0).max(7).default(0), //  (0-7)\n      turnsInPhase: z.number().default(0), // \n      totalTurns: z.number().default(0), // \n\n      // ---  ---\n      completedAnchors: z.array(z.string()).default([]), // \n\n      // --- Bug #15  ---\n      noProgressTurns: z.number().default(0), // \n      hintGiven: z.boolean().default(false), // \n    })\n    .optional(),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      : z.array(z.string()).default([]), // 10\n      : z.record(z.string(), z.string()).default({}), // {ID: }\n      : z.boolean().default(false),\n    })\n    .optional(),\n});\n\nexport type Schema = z.output<typeof Schema>;\n","import type { Schema as SchemaType } from '../../schema';\n\n/**\n *  - BUG\n *\n * TIME_LOOP_DESIGN.md\n * 1.  -  TimeSystem.advance()\n * 2.  -  data..\n * 3.  - \n * 4.  - \n * 5.  - \n */\n\ninterface TimeUpdateResult {\n  success: boolean;\n  oldTime: string;\n  newTime: string;\n  day: number;\n  hour: number;\n}\n\nexport class TimeSystem {\n  /**\n   * \n   * @param data \n   * @param hours 1\n   * @returns \n   */\n  static advance(data: SchemaType, hours: number = 1): TimeUpdateResult {\n    console.info(`\\n  `);\n    console.info(`: ${hours}`);\n\n    const oldTime = data..;\n    const oldDay = data..;\n    const oldHour = data..;\n\n    // Bug #18 \n    // \n    const rawTime = this.calculateRawTime(oldDay, oldHour, hours);\n\n    // 600:00Day 523:59\n    // 2026-01-17 20:0000:00\n    // Day 511:00Day 600:00\n    // Bug #18 Day 5\n    // Day 1-5  60\n    if (rawTime.day > 5 || (rawTime.day === 6 && rawTime.hour === 0)) {\n      if (data.. === '') {\n        console.info(`  Day ${rawTime.day}, ${rawTime.hour}:00`);\n        data.. = '';\n      }\n    }\n\n    // \n    // - \"\"Day > 5  Day 1\n    // - \"\"/\"\"\n    let finalDay = rawTime.day;\n    const finalHour = rawTime.hour;\n\n    if (finalDay > 5 && data.. === '') {\n      console.info(` 51`);\n      finalDay = 1;\n    }\n\n    // \n    data.. = finalDay;\n    data.. = finalHour;\n    data.. = this.formatTime(finalDay, finalHour);\n    data.. = Date.now();\n    data.. = true; // \n\n    const newTime = data..;\n\n    console.info(`: ${oldTime}  ${newTime}`);\n    console.info(`: Day ${finalDay}, : ${finalHour}:00`);\n    console.info(`: ${data..}`);\n    console.info(`: ${data..}`);\n    console.info(`  \\n`);\n\n    return {\n      success: true,\n      oldTime,\n      newTime,\n      day: finalDay,\n      hour: finalHour,\n    };\n  }\n\n  /**\n   * \n   * @param currentDay \n   * @param currentHour \n   * @param hours \n   * @returns \n   */\n  private static calculateRawTime(\n    currentDay: number,\n    currentHour: number,\n    hours: number,\n  ): { day: number; hour: number } {\n    let totalHours = currentHour + hours;\n    let day = currentDay;\n\n    // \n    while (totalHours >= 24) {\n      totalHours -= 24;\n      day += 1;\n    }\n\n    return { day, hour: totalHours };\n  }\n\n  /**\n   * \n   * @param day  (1-5)\n   * @param hour  (0-23)\n   * @returns  \"Day 1, 08:00\"\n   */\n  static formatTime(day: number, hour: number): string {\n    const hourStr = hour.toString().padStart(2, '0');\n    return `Day ${day}, ${hourStr}:00`;\n  }\n\n  /**\n   * \n   */\n  private static lastAdvanceTimestamp: number = 0;\n\n  /**\n   * - \n   */\n  private static readonly DEBOUNCE_INTERVAL = 500;\n\n  /**\n   * \n   * BUG-007/008/009 \n   * @returns \n   */\n  static shouldSkipAdvance(): boolean {\n    const now = Date.now();\n    const elapsed = now - this.lastAdvanceTimestamp;\n\n    if (elapsed < this.DEBOUNCE_INTERVAL && this.lastAdvanceTimestamp > 0) {\n      console.warn(`[]  ${elapsed}ms`);\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * \n   */\n  static updateAdvanceTimestamp(): void {\n    this.lastAdvanceTimestamp = Date.now();\n  }\n\n  /**\n   * \n   * BUG-007/008/009   \n   * @param data \n   * @returns \n   */\n  static validateAndFixTimeConsistency(data: SchemaType): boolean {\n    const expectedTime = this.formatTime(data.., data..);\n\n    if (data.. !== expectedTime) {\n      console.error(\n        `[]  `,\n        `\\n  : ${data..}`,\n        `\\n  : ${data..}`,\n        `\\n  : ${data..}`,\n        `\\n  : ${expectedTime}`,\n        `\\n  ...`,\n      );\n\n      //     \n      data.. = expectedTime;\n      data.. = true;\n\n      console.info(`[]  : ${data..}`);\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * \n   * @param timeStr  \"Day 1, 08:00\"\n   * @returns  null\n   */\n  static parseTimeString(timeStr: string): { day: number; hour: number } | null {\n    const match = timeStr.match(/Day\\s+(\\d+),\\s*(\\d{1,2}):00/);\n    if (match) {\n      return {\n        day: parseInt(match[1], 10),\n        hour: parseInt(match[2], 10),\n      };\n    }\n    return null;\n  }\n\n  /**\n   * \n   * @param data \n   * @returns \n   */\n  static getCurrentTime(data: SchemaType): string {\n    return data..;\n  }\n\n  /**\n   * 22:00-01:00\n   * @param data \n   * @returns \n   */\n  static isDreamWindowOpen(data: SchemaType): boolean {\n    const hour = data..;\n    // 22:00-23:59  00:00-01:59\n    return hour === 22 || hour === 23 || hour === 0 || hour === 1;\n  }\n\n  /**\n   * 600:00Day 523:59\n   * 2026-01-17 20:0000:00\n   * Day 1-5 Day 60\n   * @param data \n   * @returns \n   */\n  static isEndingTime(data: SchemaType): boolean {\n    // 600:005day >= 6\n    return (data.. === 6 && data.. === 0) || data.. > 5;\n  }\n\n  /**\n   * Day 5, 11:00+\n   * 2026-01-17 11:00\n   * @param data \n   * @returns \n   */\n  static isTrueEndingGuidanceTime(data: SchemaType): boolean {\n    return data.. === 5 && data.. >= 11;\n  }\n\n  /**\n   * 10:00\n   * @param data \n   * @returns \n   */\n  static isWakeUpTime(data: SchemaType): boolean {\n    return data.. === 10;\n  }\n\n  /**\n   *  Day 5 1-4\n   * 2026-01-17 \n   *\n   * 5Day 5 22:00  Day 6 10:00\n   *        Day 6\n   *\n   * @param data \n   * @returns  Day 5 \n   */\n  static isDay5NightDreamBlocked(data: SchemaType): boolean {\n    return data.. === 5 && this.isDreamWindowOpen(data);\n  }\n\n  /**\n   * \n   * : Day 5, 00:00 Day 6  120 \n   * 2026-01-17 20:0011600:00120\n   * @param data \n   * @returns \n   */\n  static getHoursUntilReset(data: SchemaType): number {\n    const currentDay = data..;\n    const currentHour = data..;\n\n    // Day 1, 00:00\n    const currentTotalHours = (currentDay - 1) * 24 + currentHour;\n\n    //  Day 5, 24:00 = (5-1)*24 + 24 = 120 \n    //  Day 6, 00:00\n    const resetTotalHours = 5 * 24; // 120\n\n    // \n    const remaining = resetTotalHours - currentTotalHours;\n\n    return Math.max(0, remaining);\n  }\n\n  /**\n   * \n   * @param userInput \n   * @returns \n   */\n  static detectTimeSkipIntent(userInput: string): {\n    hasIntent: boolean;\n    targetHour?: number;\n    skipType?: 'sleep' | 'specific' | 'next_day';\n  } {\n    const normalizedInput = userInput.toLowerCase();\n\n    // \n    const sleepKeywords = ['', '', '', '', 'sleep', ''];\n    for (const keyword of sleepKeywords) {\n      if (normalizedInput.includes(keyword)) {\n        return { hasIntent: true, targetHour: 7, skipType: 'sleep' };\n      }\n    }\n\n    // \n    const timeSkipPattern = /?\\s*(\\d{1,2})\\s*[:]/;\n    const match = normalizedInput.match(timeSkipPattern);\n    if (match) {\n      const targetHour = parseInt(match[1], 10);\n      if (targetHour >= 0 && targetHour <= 23) {\n        return { hasIntent: true, targetHour, skipType: 'specific' };\n      }\n    }\n\n    // \n    const nextDayKeywords = ['', '', '', 'next day'];\n    for (const keyword of nextDayKeywords) {\n      if (normalizedInput.includes(keyword)) {\n        return { hasIntent: true, targetHour: 8, skipType: 'next_day' };\n      }\n    }\n\n    return { hasIntent: false };\n  }\n\n  /**\n   * \n   * MVU\n   * @param data \n   * @param userInput \n   * @returns \n   */\n  static processTimeSkipRequest(\n    data: SchemaType,\n    userInput: string,\n  ): {\n    processed: boolean;\n    blocked: boolean;\n    mvuMessage?: string;\n  } {\n    const intent = this.detectTimeSkipIntent(userInput);\n\n    if (!intent.hasIntent) {\n      return { processed: false, blocked: false };\n    }\n\n    // \n    const hoursRemaining = this.getHoursUntilReset(data);\n\n    // MVU\n    const mvuMessage = ` ${hoursRemaining} `;\n\n    console.warn(`[] : ${intent.skipType}`);\n    console.warn(`[] ${mvuMessage}`);\n\n    return {\n      processed: true,\n      blocked: true,\n      mvuMessage,\n    };\n  }\n\n  /**\n   * \n   * @param data \n   */\n  static validate(data: SchemaType): void {\n    console.info('\\n  ');\n    console.info(`: ${data..}`);\n    console.info(`: ${data..}`);\n    console.info(`: ${data..}`);\n    console.info(`: ${data..}`);\n    console.info(`: ${data..}`);\n    console.info(`: ${data..}`);\n\n    // \n    const expectedTime = this.formatTime(data.., data..);\n    if (data.. !== expectedTime) {\n      console.error(` : ${expectedTime}, : ${data..}`);\n    } else {\n      console.info(` `);\n    }\n\n    console.info('\\n');\n  }\n\n  /**\n   * \n   *\n   * \n   * -  TimeSystem.advance() \n   * - \n   * - \n   * - \n   *\n   * @param beforeTime \n   * @param afterTime \n   * @param messageId ID\n   * @returns \n   */\n  static checkTimeAdvancementAfterScript(\n    beforeTime: string,\n    afterTime: string,\n    messageId: number,\n  ): {\n    shouldWarn: boolean;\n    message?: string;\n  } {\n    // \n    if (messageId <= 1) {\n      return { shouldWarn: false };\n    }\n\n    // \n    if (beforeTime === afterTime) {\n      console.warn(`[]  : ${afterTime} ( ${messageId})`);\n      return {\n        shouldWarn: true,\n        message: `${afterTime}`,\n      };\n    }\n\n    // \n    console.info(`[]  : ${beforeTime}  ${afterTime} ( ${messageId})`);\n    return { shouldWarn: false };\n  }\n\n  /**\n   * \n   * BUG-006\"\"\"\"AI\n   *\n   * \n   * - \n   * - AI\n   * - AI\n   *\n   * @param userInput \n   * @param currentTime \"Day X, HH:00\"\n   * @returns \n   */\n  static detectTimeJumpDescription(\n    userInput: string,\n    currentTime: string,\n  ): {\n    detected: boolean;\n    matchedKeyword?: string;\n    reminderPrompt?: string;\n  } {\n    // \n    const TIME_JUMP_KEYWORDS = {\n      // \n      : ['', '', '', '', '', '', '', ''],\n      // \n      : ['', '', '', '', '', '', '', '', '', ''],\n      // \n      : ['', '', '', '', ''],\n      // \n      : ['', '', '', '', '', '', '', ''],\n    };\n\n    const normalizedInput = userInput.toLowerCase();\n\n    // \n    for (const [category, keywords] of Object.entries(TIME_JUMP_KEYWORDS)) {\n      for (const keyword of keywords) {\n        if (normalizedInput.includes(keyword)) {\n          console.info(`[] : \"${keyword}\" (: ${category})`);\n\n          // Prompt\n          const reminderPrompt = ` - \n\"${keyword}\"\n${currentTime}\n\n\n1. \"${keyword}\"\n2. ${currentTime}\n3. \n4. 1\n\n\"\"`;\n\n          return {\n            detected: true,\n            matchedKeyword: keyword,\n            reminderPrompt,\n          };\n        }\n      }\n    }\n\n    return { detected: false };\n  }\n}\n","/**\n *  - \n *\n * \n * - 0-100\n * - \n * - \n * - \n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n/**\n * \n */\nfunction clamp(value: number, min: number, max: number): number {\n  return Math.min(Math.max(value, min), max);\n}\n\n/**\n * \n */\nexport function calculateRealm(: number): number {\n  if ( < 20) return 1;\n  if ( < 40) return 2;\n  if ( < 60) return 3;\n  if ( < 80) return 4;\n  return 5;\n}\n\n/**\n * \n */\nexport function getRealmNamePure(realm: number): string {\n  const names = ['', '', '', '', ''];\n  return names[realm - 1] ?? `${realm}`;\n}\n\n/**\n * \n */\nexport function getRealmNameTruth(realm: number): string {\n  const names = ['', '', '', '', ''];\n  return names[realm - 1] ?? `${realm}`;\n}\n\n/**\n * \n */\nexport function validateAndFixState(data: SchemaType): {\n  fixed: boolean;\n  changes: string[];\n} {\n  const changes: string[] = [];\n  let fixed = false;\n\n  // ============================================\n  // 1. \n  // ============================================\n\n  const  = data..;\n  const  = data..;\n  const  = data..;\n\n  data.. = clamp(data.., 0, 100);\n  data.. = clamp(data.., 0, 100);\n  data.. = clamp(data.., -50, 100);\n\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n\n  // ============================================\n  // 2. \n  // ============================================\n\n  const  = calculateRealm(data..);\n  if (data.. !== ) {\n    const  = data..;\n    data.. = ;\n    changes.push(`: ${}  ${}${data..}`);\n    fixed = true;\n\n    console.info(`[] : ${getRealmNamePure()}  ${getRealmNamePure()}`);\n  }\n\n  // ============================================\n  // 3.  + \n  // ============================================\n\n  const : Array<'' | '' | '' | '' | ''> = ['', '', '', '', ''];\n\n  // \n  const  = !data..;\n\n  for (const  of ) {\n    const  = data..[];\n    let  = clamp(, 0, 100);\n\n    // \n    // 50\n    if ( === '' &&  &&  > 0) {\n       = 0;\n      console.info(`[] 0: ${}`);\n    }\n    //  updateBodyPartProgress \n    // 5\n\n    if ( !== ) {\n      data..[] = ;\n      changes.push(`${}: ${}  ${}`);\n      fixed = true;\n    }\n  }\n\n  // ============================================\n  // 4. \n  // ============================================\n\n  const  = data..;\n  const  = data..;\n\n  data.. = clamp(data.., 0, 100);\n  data.. = clamp(data.., 0, 100);\n\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n\n  // ============================================\n  // 5. \n  // ============================================\n\n  // 100\n  // \n  const  = data.. === '';\n\n  // Bug #001 51-4\n  const isInScene5 = data..5?. === true && ;\n  if (data.. >= 100 && isInScene5) {\n    if (data.. === '' && data.. === '') {\n      console.warn('[]  1005');\n      // \n    }\n  }\n\n  if (data.. >= 100 && !) {\n    if (data.. === '' && data.. === '') {\n      console.warn('[]  100');\n      // \n    }\n  }\n\n  // ============================================\n  // 6. \n  // ============================================\n\n  const  = data..;\n  const  = data..;\n\n  // Bug #18 /5\n  // \"\"1-5\n  const isEndingPhase = data.. === '' || data.. === '';\n  const maxDay = isEndingPhase ? 99 : 5; // \n  data.. = clamp(data.., 1, maxDay);\n  data.. = clamp(data.., 0, 23);\n\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n\n  // \n  if (fixed) {\n    console.info('[] :');\n    changes.forEach(change => console.info(`  - ${change}`));\n  }\n\n  return { fixed, changes };\n}\n\n/**\n * \n * @returns \n */\nlet lastRealm = -1;\n\nexport function checkRealmChange(data: SchemaType): {\n  changed: boolean;\n  oldRealm: number;\n  newRealm: number;\n} {\n  const currentRealm = data..;\n\n  // \n  if (lastRealm === -1) {\n    lastRealm = currentRealm;\n    console.info(`[] : ${currentRealm}`);\n    return { changed: false, oldRealm: currentRealm, newRealm: currentRealm };\n  }\n\n  // \n  if (currentRealm !== lastRealm) {\n    const oldRealm = lastRealm;\n    lastRealm = currentRealm;\n\n    console.info(\n      `[]  : ${oldRealm}  ${currentRealm}\\n` +\n        `  : ${getRealmNamePure(oldRealm)}  ${getRealmNamePure(currentRealm)}\\n` +\n        `  : ${getRealmNameTruth(oldRealm)}  ${getRealmNameTruth(currentRealm)}`,\n    );\n\n    return { changed: true, oldRealm, newRealm: currentRealm };\n  }\n\n  return { changed: false, oldRealm: currentRealm, newRealm: currentRealm };\n}\n\n/**\n * \n */\nexport function resetRealmTracking(): void {\n  lastRealm = -1;\n  console.info('[] ');\n}\n","/**\n *  - \n *\n * \n * - \n * - NTR\n *\n * \n * - 5~\n * - \n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport const EXPOSURE_LEVELS = ['', '', '', '', ''] as const;\nexport type ExposureLevel = (typeof EXPOSURE_LEVELS)[number];\n\n/**\n * \n */\nexport const MAKEUP_LEVELS = ['', '', '', '', ''] as const;\nexport type MakeupLevel = (typeof MAKEUP_LEVELS)[number];\n\n/**\n * \n */\nexport const TIDINESS_LEVELS = ['', '', '', '', ''] as const;\nexport type TidinessLevel = (typeof TIDINESS_LEVELS)[number];\n\n// ============================================\n// \n// ============================================\n\n/**\n * 5\n * \n */\nexport const PURE_LOVE_APPEARANCE_CONFIG = {\n  1: {\n    : '',\n    : ['', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', '', '', '', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  2: {\n    : '',\n    : ['', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', '', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  3: {\n    : '',\n    : ['', '', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', '', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  4: {\n    : '',\n    : ['', '', '', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  5: {\n    : '',\n    : ['', '', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n};\n\n// ============================================\n// NTR\n// ============================================\n\n/**\n * \n * \n */\nexport const TRUTH_APPEARANCE_CONFIG = {\n  1: {\n    : '',\n    : ['', '', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', '', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  2: {\n    : '',\n    : ['', '', '', '', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', ''],\n    },\n    : {\n      : 'V',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  3: {\n    : '',\n    : ['', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : 'V',\n      : ['', '', '', ''],\n      : ['', ''],\n    },\n    : {\n      : 'V',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  4: {\n    : '',\n    : ['', '', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : true,\n      : true,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', '', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  5: {\n    : '',\n    : ['', '', '', '', ''],\n    : {\n      // 5\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : true,\n      : true,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : '',\n      : [\n        '',\n        '',\n        '',\n        '\"\"',\n        '',\n      ],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n};\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport function getExposureIndex(level: ExposureLevel): number {\n  return EXPOSURE_LEVELS.indexOf(level);\n}\n\n/**\n * \n */\nexport function getMakeupIndex(level: MakeupLevel): number {\n  return MAKEUP_LEVELS.indexOf(level);\n}\n\n/**\n * \n */\nfunction getAppearanceConfig(: boolean) {\n  return  ? TRUTH_APPEARANCE_CONFIG : PURE_LOVE_APPEARANCE_CONFIG;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport function getRealmConstraints(realm: number, : boolean) {\n  const config = getAppearanceConfig();\n  const realmConfig = config[realm as keyof typeof config];\n\n  if (!realmConfig) {\n    return {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    };\n  }\n  return realmConfig.;\n}\n\n/**\n * AI\n */\nexport function getStyleGuidance(realm: number, : boolean = false) {\n  const config = getAppearanceConfig();\n  const realmConfig = config[realm as keyof typeof config];\n\n  if (!realmConfig) {\n    return {\n      : '',\n      : '',\n      : [''],\n      : [] as string[],\n    };\n  }\n  return realmConfig.;\n}\n\n/**\n * AI\n */\nexport function getDefaultAppearance(realm: number, : boolean) {\n  const config = getAppearanceConfig();\n  const realmConfig = config[realm as keyof typeof config];\n\n  if (!realmConfig) {\n    return {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    };\n  }\n  return realmConfig.;\n}\n\n/**\n * \n */\nexport function getRealmTitle(realm: number, : boolean): string {\n  const config = getAppearanceConfig();\n  const realmConfig = config[realm as keyof typeof config];\n  if (!realmConfig) return `${realm}`;\n  return realmConfig.;\n}\n\n/**\n * \n */\nexport function getAllowedInteractions(realm: number, : boolean): string[] {\n  const config = getAppearanceConfig();\n  const realmConfig = config[realm as keyof typeof config];\n  if (!realmConfig) return [];\n  return realmConfig. as unknown as string[];\n}\n\n// ============================================\n// +\n// ============================================\n\n/**\n * \n *  TIME_LOOP_DESIGN.md\n * - 1\n * - 2\n * - 3 + \n * - 4 +  +  + \n * - 5 + \n */\nexport const REALM_BODY_PART_UNLOCK: Record<number, string[]> = {\n  1: [], // \n  2: [''],\n  3: ['', ''],\n  4: ['', '', '', ''],\n  5: ['', '', '', '', ''],\n};\n\n/**\n * \n */\nexport const ALL_BODY_PARTS = ['', '', '', '', ''] as const;\nexport type BodyPartName = (typeof ALL_BODY_PARTS)[number];\n\n// ============================================\n// \n// ============================================\n\n/**\n *  = \n *\n * \n * - \"\"\n * - \n * - \"\"\n *\n * @param  0-100\n * @returns 0-100\n */\nexport function calculateDependencyFromBodyProgress(: Record<BodyPartName, number>): number {\n  const values = ALL_BODY_PARTS.map(part => [part] || 0);\n  const average = values.reduce((sum, v) => sum + v, 0) / values.length;\n  return Math.round(average);\n}\n\n/**\n * \n *\n * \n * - \n * - 100\n * - 0\n *\n * @param  0-100\n * @returns 0-100\n */\nexport function calculateMoralBaselineFromDependency(: number): number {\n  //  = 100 - \n  // 0  100\n  // 100  0\n  return Math.max(0, Math.min(100, 100 - ));\n}\n\n/**\n * \n *\n * \n *\n * @param  0-100\n * @returns 1-5\n */\nexport function calculateRealmFromDependency(: number): number {\n  if ( >= 80) return 5;\n  if ( >= 60) return 4;\n  if ( >= 40) return 3;\n  if ( >= 20) return 2;\n  return 1;\n}\n\n/**\n * \n *\n * \n * -  = \n * -  = 100 - \n * -  = /20\n *\n * @param data \n */\nexport function updateTruthModeValues(data: {\n  : {\n    : number;\n    : number;\n    : number;\n    : Record<BodyPartName, number>;\n  };\n  : {\n    : boolean;\n  };\n}): void {\n  // \n  if (!data..) {\n    return;\n  }\n\n  const  = data..;\n\n  // Bug #14.2  + Bug #23 \n  // \n  // \n  const  = data..;\n  const  = data..;\n  const  = data..;\n  const  = ALL_BODY_PARTS.reduce((sum, part) => sum + ([part] || 0), 0);\n\n  // 10>0\n  if ( === 0 &&  > 0) {\n    console.warn(\n      `[] 0=${}`,\n      `\\n  : ${JSON.stringify()}`,\n      `\\n  : ${}`,\n      `\\n  : ${}`,\n      `\\n  : ${}`,\n    );\n    return; // \n  }\n\n  // \n  const  = calculateDependencyFromBodyProgress();\n\n  // 2Bug #23 \n  // 15\n  // \n  const  =  - ;\n  if ( > 15) {\n    console.warn(\n      `[]  ${} `,\n      `\\n  : ${}  : ${}`,\n      `\\n  : ${JSON.stringify()}`,\n      `\\n  : ${}`,\n      `\\n  : `,\n    );\n    return; // \n  }\n\n  // 100 - \n  const  = calculateMoralBaselineFromDependency();\n\n  // \n  const  = calculateRealmFromDependency();\n\n  // \n  const  =  !== data..;\n  const  =  !== data..;\n  const  =  !== data..;\n\n  if ( ||  || ) {\n    console.info('[]');\n    if () {\n      console.info(`  : ${data..}  ${}`);\n    }\n    if () {\n      console.info(`  : ${data..}  ${}`);\n    }\n    if () {\n      console.info(`  : ${data..}  ${}`);\n    }\n  }\n\n  // \n  data.. = ;\n  data.. = ;\n  data.. = ;\n}\n\n/**\n * \n * \n */\nexport const BODY_PART_DEVELOPMENT_LEVELS = {\n  : {\n    range: [0, 19] as [number, number],\n    : '',\n    : '',\n  },\n  : {\n    range: [20, 39] as [number, number],\n    : '',\n    : '',\n  },\n  : {\n    range: [40, 59] as [number, number],\n    : '',\n    : '',\n  },\n  : {\n    range: [60, 79] as [number, number],\n    : '',\n    : '',\n  },\n  : {\n    range: [80, 100] as [number, number],\n    : '',\n    : '',\n  },\n} as const;\n\n/**\n * \n */\nexport function getDevelopmentLevelFromProgress(progress: number): keyof typeof BODY_PART_DEVELOPMENT_LEVELS {\n  if (progress >= 80) return '';\n  if (progress >= 60) return '';\n  if (progress >= 40) return '';\n  if (progress >= 20) return '';\n  return '';\n}\n\n/**\n * \n */\nexport const BODY_PART_BEHAVIOR_MAP: Record<BodyPartName, Record<string, string>> = {\n  : {\n    : '',\n    : '',\n    : '',\n    : '',\n    : '',\n  },\n  : {\n    : '',\n    : '',\n    : '',\n    : '',\n    : '',\n  },\n  : {\n    : '',\n    : '',\n    : '',\n    : '',\n    : '',\n  },\n  : {\n    : '',\n    : '',\n    : '',\n    : 'play',\n    : '',\n  },\n  : {\n    : '',\n    : '{{user}}',\n    : '',\n    : '{{user}}',\n    : '{{user}}',\n  },\n};\n\n/**\n * \n */\nexport function getBodyPartStatus(\n  : BodyPartName,\n  : number,\n  : boolean,\n): {\n  : string;\n  : number;\n  : string;\n  : string;\n  : string;\n  : boolean;\n} {\n  const  = getDevelopmentLevelFromProgress();\n  const  = BODY_PART_DEVELOPMENT_LEVELS[];\n  const  = BODY_PART_BEHAVIOR_MAP[][];\n\n  return {\n    : ,\n    ,\n    ,\n    : .,\n    ,\n    ,\n  };\n}\n\n/**\n * Prompt\n * AI\n *\n *  - \n * - \n * - \n *\n * @param data \n * @returns \n */\nexport function generateDetailedInteractionPrompt(data: {\n  : {\n    : number;\n    : Record<BodyPartName, number>;\n    ?: number;\n    ?: number;\n  };\n  : {\n    : boolean;\n    ?: string;\n  };\n}): string {\n  const  = data..;\n  const  = data..;\n  const  = data..;\n  const  = data.. || '';\n\n  // \n  const  = getRealmTitle(, );\n\n  // ============================================\n  // \n  // ============================================\n  if (!) {\n    // \n    const  = REALM_BODY_PART_UNLOCK[] || [];\n    const  = getAllowedInteractions(, false);\n\n    return `\n${}${}/5\n\n${.length > 0 ? .join('') : ''}\n\n\n`;\n  }\n\n  // ============================================\n  // \n  // ============================================\n\n  const  = data.. ?? calculateDependencyFromBodyProgress();\n  const  = data.. ?? calculateMoralBaselineFromDependency();\n\n  //  vs \n  if ( === '') {\n    // \n    let prompt = ` - \n${}${}/5\n${}/100\n${}/100\n\n\n\n\n`;\n\n    for (const  of ALL_BODY_PARTS) {\n      const  = [] || 0;\n      const  = getBodyPartStatus(, , true);\n\n      prompt += `\\n\\n ${.}${}%- ${.}\n  ${.}\n  ${.}`;\n    }\n\n    prompt += `\\n\\n\n- \"\"\n- \n- \n- `;\n\n    return prompt;\n  }\n\n  // \n  let prompt = ` - \n${}${}/5\n${}/100\n${}/100\n\n\n\"\"\n\n`;\n\n  for (const  of ALL_BODY_PARTS) {\n    const  = [] || 0;\n    const  = getBodyPartStatus(, , true);\n\n    prompt += `\\n\\n ${.}${}%- ${.}\n  ${.}\n  ${.}`;\n  }\n\n  // \n  if ( >= 80) {\n    prompt += `\\n\\n\n{{user}}\n`;\n  } else if ( >= 60) {\n    prompt += `\\n\\n\n{{user}}\n`;\n  } else if ( >= 40) {\n    prompt += `\\n\\n\n{{user}}\n`;\n  } else if ( >= 20) {\n    prompt += `\\n\\n\n\n`;\n  }\n\n  return prompt;\n}\n\n// ============================================\n// APIpromptInjection.ts\n// ============================================\n\n/**\n * API\n */\nexport function getCurrentClothing(\n  realm: number,\n  _: '' | '' | '',\n  : boolean = false,\n): string {\n  const defaultAppearance = getDefaultAppearance(realm, );\n  return defaultAppearance.;\n}\n\n/**\n * API\n */\nexport function getCurrentMakeup(\n  realm: number,\n  _: '' | '' | '',\n  : boolean = false,\n): string {\n  const defaultAppearance = getDefaultAppearance(realm, );\n  return defaultAppearance.;\n}\n\n// ============================================\n// Prompt\n// ============================================\n\n/**\n * PromptAI\n * \n *   \n */\nexport function generateAppearanceConstraintPrompt(data: SchemaType): string {\n  const realm = data..;\n  const  = data..;\n  const  = data.. !== '';\n  const  = data..;\n  const  =  >= 22 ||  < 7;\n\n  const constraints = getRealmConstraints(realm, );\n  const guidance = getStyleGuidance(realm, );\n  const title = getRealmTitle(realm, );\n\n  // \n  if (!) {\n    let prompt = `\n${title}${realm}/5\n${guidance.}\n\n\n- ${constraints..join(' ~ ')}\n- ${constraints..join(' ~ ')}\n- ${guidance.}\n- ${guidance..join('')}`;\n\n    const  = (guidance as Record<string, unknown>). as string[] | undefined;\n    if ( && .length > 0) {\n      prompt += `\\n- ${.join('')}`;\n    }\n\n    if () {\n      prompt += `\\n\\n`;\n    }\n\n    return prompt;\n  }\n\n  // \n  let  = constraints.;\n  let  = constraints.;\n\n  // 5\n  if (realm === 5 && ) {\n     = ['', ''] as ExposureLevel[];\n     = ['', ''] as MakeupLevel[];\n  }\n\n  let prompt = `\n${title}${realm}/5\n${guidance.}\n\nAI\n- ${.join(' ~ ')}\n- ${.join(' ~ ')}\n- ${constraints. ? '' : ''}\n- ${constraints. ? '' : ''}\n\nAI\n${guidance.}\n${guidance..join('')}`;\n\n  const  = (guidance as Record<string, unknown>). as string[] | undefined;\n  if ( && .length > 0) {\n    prompt += `\\n${.join('')}`;\n  }\n\n  // 5\n  if (realm === 5 && (guidance as Record<string, unknown>).) {\n    prompt += `\\n\\n${(guidance as Record<string, unknown>).}`;\n  }\n\n  // \n  if () {\n    prompt += `\\n\\n/`;\n  }\n\n  // \n  if ( && realm < 5) {\n    prompt += `\\n\\n`;\n  }\n\n  return prompt;\n}\n\n/**\n * \n */\nexport function isActionAllowed(\n  : string,\n  : number,\n  : boolean = false,\n): {\n  allowed: boolean;\n  reason?: string;\n} {\n  const config = getAppearanceConfig();\n  const realmConfig = config[ as keyof typeof config];\n\n  if (!realmConfig) {\n    return { allowed: false, reason: '' };\n  }\n\n  // 5\n  if ( &&  === 5) {\n    return { allowed: true };\n  }\n\n  // 4\n  const  = realmConfig. as readonly string[];\n  if ( &&  === 4 && (.includes('') || .includes(''))) {\n    return { allowed: true };\n  }\n\n  // \n  const  = realmConfig..some(\n     =>\n       ===  ||\n       === '' ||\n      (.includes(.substring(0, 2)) && .length > 2),\n  );\n\n  if () {\n    return { allowed: true };\n  }\n\n  return {\n    allowed: false,\n    reason: `${ ? '' : ''}${realmConfig.}`,\n  };\n}\n\n/**\n * \n */\nexport function updateHusbandLocation(data: SchemaType): void {\n  const  = data..;\n\n  let : SchemaType[''][''];\n\n  // \n  if ( >= 7 &&  < 8) {\n     = Math.random() > 0.5 ? '' : '';\n  } else if ( >= 8 &&  < 9) {\n     = Math.random() > 0.5 ? '' : '';\n  } else if ( >= 9 &&  < 18) {\n     = '';\n  } else if ( >= 18 &&  < 19) {\n     = '';\n  } else if ( >= 19 &&  < 21) {\n     = Math.random() > 0.5 ? '' : '';\n  } else if ( >= 21 &&  < 23) {\n     = Math.random() > 0.6 ? '' : '';\n  } else {\n     = '';\n  }\n\n  if (data.. !== ) {\n    const  = data..;\n    data.. = ;\n    console.info(`[] : ${}  ${}${data..}:00`);\n  }\n}\n\n//  boundaryInterruption.ts\n//  =   0.5%60  30%\n//  boundaryInterruption.ts  calculateInterruptionProbability  checkBoundaryViolation\n\n/**\n * AI\n */\nexport function generateAppearanceDescription(data: SchemaType): string {\n  return generateAppearanceConstraintPrompt(data);\n}\n\n/**\n * Bug #28 \n *\n * \n * \n */\nexport function updateZhaoxiaLocation(data: SchemaType): void {\n  const  = data..;\n\n  let : string;\n\n  // \n  if ( >= 6 &&  < 8) {\n    // \n     = Math.random() > 0.5 ? '' : '';\n  } else if ( >= 8 &&  < 12) {\n    // \n     = Math.random() > 0.6 ? '' : '';\n  } else if ( >= 12 &&  < 14) {\n    // \n     = '';\n  } else if ( >= 14 &&  < 17) {\n    // \n     = Math.random() > 0.5 ? '' : '';\n  } else if ( >= 17 &&  < 19) {\n    // \n     = '';\n  } else if ( >= 19 &&  < 22) {\n    // \n     = '';\n  } else {\n    // /\n     = '';\n  }\n\n  if (data.. !== ) {\n    const  = data..;\n    data.. = ;\n    console.info(`[] : ${}  ${}${data..}:00`);\n  }\n}\n\n/**\n * Bug #28 \n *\n * \n */\nexport function updateZhaoxiaThoughtAfterDream(data: SchemaType): void {\n  const  = data..;\n  const  = data..;\n\n  // \n  let : string;\n\n  if ( >= 80 ||  >= 5) {\n    // \n     = '......';\n  } else if ( >= 60 ||  >= 4) {\n    // \n     = '......';\n  } else if ( >= 40 ||  >= 3) {\n    // \n     = '......';\n  } else if ( >= 20 ||  >= 2) {\n    // \n     = '......';\n  } else {\n    // \n     = '...';\n  }\n\n  const  = data..;\n  data.. = ;\n  console.info(\n    `[] `,\n    `\\n  : ${.substring(0, 30)}...`,\n    `\\n  : ${.substring(0, 30)}...`,\n  );\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * AI\n */\nconst EXPOSURE_CLOTHING_KEYWORDS = {\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    'V',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n};\n\n/**\n * \n */\nconst HEAVY_MAKEUP_KEYWORDS = {\n  : ['', '', '', '', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', '', '', '', ''],\n};\n\n/**\n * \n * \n */\nconst INTIMATE_BEHAVIOR_KEYWORDS = {\n  : ['', '', '', '', '', '', '', '', '', '', ''],\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n};\n\n/**\n * 4+\n */\nconst REALM_MANIFESTATION_KEYWORDS = [\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n];\n\n/**\n * \n */\nfunction countKeywordsInText(text: string, keywords: string[]): number {\n  let count = 0;\n  for (const keyword of keywords) {\n    if (text.includes(keyword)) {\n      count++;\n    }\n  }\n  return count;\n}\n\n/**\n * \n * @returns 0=, 1=, 2=, 3=\n */\nfunction detectClothingExposure(: string): number {\n  const text = .toLowerCase();\n\n  // \n  if (countKeywordsInText(text, EXPOSURE_CLOTHING_KEYWORDS.) > 0) {\n    return 3;\n  }\n\n  // \n  if (countKeywordsInText(text, EXPOSURE_CLOTHING_KEYWORDS.) > 0) {\n    return 2;\n  }\n\n  // \n  if (countKeywordsInText(text, EXPOSURE_CLOTHING_KEYWORDS.) >= 2) {\n    return 1;\n  }\n\n  return 0;\n}\n\n/**\n * \n * @returns 0=, 1=, 2=\n */\nfunction detectMakeupIntensity(: string): number {\n  const text = .toLowerCase();\n\n  // \n  if (countKeywordsInText(text, HEAVY_MAKEUP_KEYWORDS.) > 0) {\n    return 2;\n  }\n\n  // \n  if (countKeywordsInText(text, HEAVY_MAKEUP_KEYWORDS.) > 0) {\n    return 1;\n  }\n\n  return 0;\n}\n\n/**\n * \n * @returns 0=, 1=, 2=, 3=\n */\nfunction detectIntimacyLevel(: string): number {\n  const text = ;\n\n  // \n  if (countKeywordsInText(text, INTIMATE_BEHAVIOR_KEYWORDS.) >= 1) {\n    return 3;\n  }\n\n  // \n  if (countKeywordsInText(text, INTIMATE_BEHAVIOR_KEYWORDS.) >= 1) {\n    return 2;\n  }\n\n  // \n  if (countKeywordsInText(text, INTIMATE_BEHAVIOR_KEYWORDS.) >= 2) {\n    return 1;\n  }\n\n  return 0;\n}\n\n/**\n * \n */\nfunction detectRealmManifestation(: string): boolean {\n  return countKeywordsInText(, REALM_MANIFESTATION_KEYWORDS) >= 2;\n}\n\n/**\n * \n */\nexport interface SuspicionIncreaseResult {\n  : number;\n  : string[];\n  : {\n    : number;\n    : number;\n    : number;\n    : number;\n  };\n}\n\n/**\n * \n *\n * \n * 1. \n * 2. +5, +10, +15\n * 3. +3, +8\n * 4. +5, +10, +20AI\n * 5. 460+3AI\n *\n * Bug #14 \n * - userInputTextAI\n * - AI\n * - AI\n *\n * @param data \n * @param userInputText \n * @returns \n */\nexport function calculateSuspicionIncrease(data: SchemaType, userInputText: string = ''): SuspicionIncreaseResult {\n  const result: SuspicionIncreaseResult = {\n    : 0,\n    : [],\n    : {\n      : 0,\n      : 0,\n      : 0,\n      : 0,\n    },\n  };\n\n  // \n  const  = data.. !== '';\n  if (!) {\n    return result;\n  }\n\n  // \n  const  = data..;\n\n  // \n  if () {\n    // 1. AI\n    const  = Object.values(data..).join(' ');\n    const  = detectClothingExposure();\n    if ( >= 1) {\n      const  = [0, 5, 10, 15][];\n      result.. = ;\n      result. += ;\n      result..push(`${}+${}`);\n    }\n\n    // 2. AI\n    const  = detectMakeupIntensity(data..);\n    if ( >= 1) {\n      const  = [0, 3, 8][];\n      result.. = ;\n      result. += ;\n      result..push(`${}+${}`);\n    }\n\n    // 4. Bug #14 AI\n    // \n    // 4+60+\n    if (data.. >= 4 && data.. >= 60) {\n      result.. = 3;\n      result. += 3;\n      result..push(`${data..}+3`);\n    }\n  }\n\n  // 3. \n  // \n  // \n  // Bug #14 AI\n  // Bug #005 +5/+10/+20+3/+5/+10\n  if (userInputText) {\n    const  = detectIntimacyLevel(userInputText);\n    if ( >= 1) {\n      const  = [0, 3, 5, 10][]; // Bug #005: \n      result.. = ;\n      result. += ;\n      const  =  ? '' : '';\n      result..push(`${}${}+${}`);\n    }\n  }\n\n  // \n  if (result. > 0) {\n    console.info(\n      `[] +${result.}`,\n      `\\n  : ${result..join(', ')}`,\n      `\\n  : ${data..}`,\n      `\\n  : ${data..}`,\n      `\\n  : ${data..}`,\n    );\n  }\n\n  return result;\n}\n\n/**\n * \n *\n * Bug #14 AI\n *\n * @param data \n * @param userInputText \n * @returns \n */\nexport function updateSuspicionLevel(data: SchemaType, userInputText: string = ''): number {\n  const result = calculateSuspicionIncrease(data, userInputText);\n\n  if (result. > 0) {\n    const  = data..;\n    const  = Math.min(100,  + result.);\n\n    data.. = ;\n\n    console.info(\n      `[] ${}  ${} (+${result.})`,\n      `\\n  : ${result..} + ${result..} + ${result..} + ${result..}`,\n    );\n\n    // \n    if ( >= 100) {\n      console.warn(`[]  100`);\n    } else if ( >= 80) {\n      console.warn(`[]  80`);\n    } else if ( >= 50) {\n      console.info(`[] 50`);\n    }\n\n    return ;\n  }\n\n  return data..;\n}\n\n// ============================================\n// Bug #005 \n// ============================================\n\n/**\n * /\n * \n */\nconst HUSBAND_INTERACTION_KEYWORDS = [\n  // \n  '',\n  '',\n  '',\n  // /\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  // \n  '',\n  '',\n  '',\n  '',\n  '',\n  // \n  '',\n  '',\n  '',\n  '',\n  '',\n];\n\n/**\n * \n * @param userInput \n * @returns \n */\nexport function detectHusbandInteraction(userInput: string): boolean {\n  return HUSBAND_INTERACTION_KEYWORDS.some(kw => userInput.includes(kw));\n}\n\n/**\n * \n */\nexport interface SuspicionDecreaseResult {\n  : number;\n  : string;\n  : number;\n  : boolean;\n}\n\n/**\n * \n *\n * Bug #005 /\n * -  3 \n * -  10 \n * - \n *\n * @param data \n * @param userInput \n * @returns \n */\nexport function calculateSuspicionDecrease(data: SchemaType, userInput: string): SuspicionDecreaseResult {\n  const result: SuspicionDecreaseResult = {\n    : 0,\n    : '',\n    : data.. ?? 0,\n    : false,\n  };\n\n  // \n  const  = data.. !== '';\n  if (!) {\n    return result;\n  }\n\n  //  > 0\n  if (data.. <= 0) {\n    return result;\n  }\n\n  // \n  if (!detectHusbandInteraction(userInput)) {\n    return result;\n  }\n\n  // \n  const  = data..;\n  const  = data.. ?? 0;\n  if ( !== ) {\n    // \n    data.. = 0;\n    data.. = ;\n    result. = 0;\n  }\n\n  // 10\n  const  = 10;\n  const  = data.. ?? 0;\n  if ( >= ) {\n    result. = true;\n    result. = '10';\n    return result;\n  }\n\n  // 3\n  const  = 3;\n  const  =  - ;\n  const  = Math.min(, , data..);\n\n  if ( > 0) {\n    result. = ;\n    result. = '';\n    result. =  + ;\n  }\n\n  return result;\n}\n\n/**\n * \n *\n * @param data \n * @param userInput \n * @returns \n */\nexport function applySuspicionDecrease(data: SchemaType, userInput: string): number {\n  const result = calculateSuspicionDecrease(data, userInput);\n\n  if (result. > 0) {\n    const  = data..;\n    const  = Math.max(0,  - result.);\n\n    data.. = ;\n    data.. = result.;\n\n    console.info(\n      `[] ${}  ${} (-${result.})`,\n      `\\n  : ${result.}`,\n      `\\n  : ${result.}/10`,\n    );\n\n    return ;\n  }\n\n  if (result.) {\n    console.info(`[] ${result.}`);\n  }\n\n  return data..;\n}\n","/**\n *  - 5\n *\n * 512\n *  - \n *\n * \n * 1. 07:00=131219:00=1\n * 2. //AI\n * 3. +10%+5%\n * 4. 11-10211-12+\n * 5. 19:0020:00\n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n// \n//                         5 - 12                       \n// \n//                       \n//             \n//   \"\"        \n//    -                                   \n// \n//                                                                       \n//     1-2 []  -                                       \n//     3-5 []  -                                     \n//     6-8 []  -                                           \n//     9-11[]  -                                           \n//     12  []  -                                           \n// \n//                                                                     \n//     - //                          \n//     -  +10% +5%                                              \n//     - 80%100%                                    \n// \n\n// ============================================\n// 12\n// ============================================\n\nexport interface Scene5Step {\n  step: number;\n  phase: '' | '' | '' | '' | '';\n  title: string;\n  description: string;\n  bestMatch: {\n    ?: '' | '' | '';\n    ?: '' | '' | '';\n    ?: '' | '' | '';\n  };\n  aiTask: string;\n}\n\nexport const SCENE5_STEPS: Scene5Step[] = [\n  {\n    step: 1,\n    phase: '',\n    title: '',\n    description: '\"\"',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \n4. `,\n  },\n  {\n    step: 2,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \n4. `,\n  },\n  {\n    step: 3,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \"\"\n3. \n4. `,\n  },\n  {\n    step: 4,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \n4. `,\n  },\n  {\n    step: 5,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \n4. `,\n  },\n  {\n    step: 6,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '', : '' },\n    aiTask: `1. \n2. /\n3. /\n4. `,\n  },\n  {\n    step: 7,\n    phase: '',\n    title: '',\n    description: '\"\"',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \"\"\n3. \n4. \"\"`,\n  },\n  {\n    step: 8,\n    phase: '',\n    title: '',\n    description: '\"\"',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \"\"\n4. `,\n  },\n  {\n    step: 9,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \n4. `,\n  },\n  {\n    step: 10,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \n4. `,\n  },\n  {\n    step: 11,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \"\"\n4. `,\n  },\n  {\n    step: 12,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: {}, // \n    aiTask: `1. \n2. \n   - \n   - \n   - \n3. \n4. 5`,\n  },\n];\n\n// ============================================\n// 5\n// ============================================\n\n/**\n * \n *\n * \n * - 1: 16\n * - 2: 17\n * - 3: 23\n * - 5: \n * - 4: 28 - 5\n *\n * 45\n *\n * \n * - 0: 5\n *       \n * - 1: 1\n *       \n * - 2: 1+2\n *       +\n * - 3: 1+2+3\n *       \"\"\n */\n\nexport interface MemoryCoherenceInfo {\n  level: 0 | 1 | 2 | 3;\n  hasScene1: boolean; // \n  hasScene2: boolean; // \n  hasScene3: boolean; // \n  hasScene4: boolean; // \n  description: string;\n  aiHint: string; // AI\n}\n\n/**\n * \n *\n * \n * - 1  2  3\n * - \n * - 45\n *\n * @param data \n * @returns \n */\nexport function calculateMemoryCoherence(data: SchemaType): MemoryCoherenceInfo {\n  const completedScenes = new Set(data..);\n\n  const hasScene1 = completedScenes.has(1);\n  const hasScene2 = completedScenes.has(2);\n  const hasScene3 = completedScenes.has(3);\n  const hasScene4 = completedScenes.has(4);\n\n  // \n  let level: 0 | 1 | 2 | 3;\n  if (hasScene1 && hasScene2 && hasScene3) {\n    level = 3;\n  } else if (hasScene1 && hasScene2) {\n    level = 2;\n  } else if (hasScene1) {\n    level = 1;\n  } else {\n    level = 0;\n  }\n\n  // \n  let description: string;\n  let aiHint: string;\n\n  switch (level) {\n    case 0:\n      description = ' - ';\n      aiHint = `0 - \n\n- \n- \n- \n- `;\n      break;\n\n    case 1:\n      description = ' - ';\n      aiHint = `1 - \n161\n- \n- \n- 2\"\"\n- 3\"\"`;\n      break;\n\n    case 2:\n      description = '+ - ';\n      aiHint = `2 - +\n16171+2\n- \"\"\n- \n- \n- 3\"\"`;\n      break;\n\n    case 3:\n      description = ' - ';\n      aiHint = `3 - \n1+2+3\n- 161720\n- \n- \n- \n- \"\" \"...\" `;\n      break;\n  }\n\n  return {\n    level,\n    hasScene1,\n    hasScene2,\n    hasScene3,\n    hasScene4,\n    description,\n    aiHint,\n  };\n}\n\n/**\n * \n * 5AI\n *\n * @param coherence \n * @returns \n */\nexport function getMissingMemoryEffects(coherence: MemoryCoherenceInfo): string[] {\n  const effects: string[] = [];\n\n  if (!coherence.hasScene1) {\n    effects.push(`1\n16\n \"\"\n \"\"\"\"\n `);\n  }\n\n  if (!coherence.hasScene2) {\n    effects.push(`2\n17\"\"\n \"\"\n \"\"\"\"\n `);\n  }\n\n  if (!coherence.hasScene3) {\n    effects.push(`3\n20\n \"\"\n \"\"\"\"\n `);\n  }\n\n  return effects;\n}\n\n/**\n * 5\n *\n * Bug #13 2026-01-18\n * - 5  =0\n * - 5100%  1-2-3\n *\n * 5completionPercent >= 100%\n *\n * @param data \n */\nexport function lockScene5EntryCoherence(data: SchemaType): void {\n  const coherence = calculateMemoryCoherence(data);\n  data.. = coherence.level;\n  data..5 = coherence.level;\n  console.info(`[] 5${coherence.level} - ${coherence.description}`);\n}\n\n/**\n * 5\n * \n *\n * @param data \n * @returns \n */\nexport function getScene5LockedCoherence(data: SchemaType): 0 | 1 | 2 | 3 {\n  const locked = data..5;\n  if (locked !== undefined) {\n    return locked as 0 | 1 | 2 | 3;\n  }\n  // \n  return calculateMemoryCoherence(data).level;\n}\n\n/**\n * \n *\n * 2026-01-16\n * - \"\"\n * -  < 3 \n * - =3\n * - 1-2-3\n *\n * Bug #13 2026-01-18\n * - \n * - 5\n * - \"\"51-2-3\n *\n * @param data \n * @returns \n */\nexport function shouldIncreaseMemoryConfusion(data: SchemaType): boolean {\n  // Bug #13 \n  // \"5\"\"\"\n  const coherence = calculateMemoryCoherence(data);\n  if (coherence.level === 3) {\n    console.info('[] ');\n    return false;\n  }\n  return true;\n}\n\n/**\n * \n * =3\n *\n * @param data \n * @param amount \n * @returns 0\n */\nexport function safeIncreaseMemoryConfusion(data: SchemaType, amount: number): number {\n  if (!shouldIncreaseMemoryConfusion(data)) {\n    console.info(`[]  ${amount} ()`);\n    return 0;\n  }\n\n  const oldValue = data..;\n  data.. = Math.min(100, oldValue + amount);\n  const actualIncrease = data.. - oldValue;\n  console.info(`[]  +${actualIncrease} (${oldValue}  ${data..})`);\n  return actualIncrease;\n}\n\n// ============================================\n// \n// ============================================\n\nexport interface IntentAnalysis {\n  : '' | '' | '' | '';\n  : '' | '' | '' | '';\n  : '' | '' | '' | '';\n  : string;\n  : string[];\n}\n\nconst INTENT_KEYWORDS = {\n  : {\n    : ['', '', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', '', ''],\n  },\n  : {\n    : ['', '', '', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', ''],\n  },\n  : {\n    : ['', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', '', ''],\n  },\n};\n\n/**\n * \n */\nexport function analyzePlayerIntent(userInput: string): IntentAnalysis {\n  const result: IntentAnalysis = {\n    : '',\n    : '',\n    : '',\n    : userInput,\n    : [],\n  };\n\n  // \n  for (const [attitude, keywords] of Object.entries(INTENT_KEYWORDS.)) {\n    for (const keyword of keywords) {\n      if (userInput.includes(keyword)) {\n        result. = attitude as IntentAnalysis[''];\n        result..push(keyword);\n        break;\n      }\n    }\n    if (result. !== '') break;\n  }\n\n  // \n  for (const [behavior, keywords] of Object.entries(INTENT_KEYWORDS.)) {\n    for (const keyword of keywords) {\n      if (userInput.includes(keyword)) {\n        result. = behavior as IntentAnalysis[''];\n        result..push(keyword);\n        break;\n      }\n    }\n    if (result. !== '') break;\n  }\n\n  // \n  for (const [goal, keywords] of Object.entries(INTENT_KEYWORDS.)) {\n    for (const keyword of keywords) {\n      if (userInput.includes(keyword)) {\n        result. = goal as IntentAnalysis[''];\n        result..push(keyword);\n        break;\n      }\n    }\n    if (result. !== '') break;\n  }\n\n  return result;\n}\n\n/**\n * \n * @returns 'high' | 'low'\n */\nexport function calculateMatchLevel(intent: IntentAnalysis, step: Scene5Step): 'high' | 'low' {\n  const best = step.bestMatch;\n  let matchCount = 0;\n  let totalRequired = 0;\n\n  if (best.) {\n    totalRequired++;\n    if (intent. === best.) matchCount++;\n  }\n  if (best.) {\n    totalRequired++;\n    if (intent. === best.) matchCount++;\n  }\n  if (best.) {\n    totalRequired++;\n    if (intent. === best.) matchCount++;\n  }\n\n  // 12\n  if (totalRequired === 0) return 'high';\n\n  // \n  return matchCount >= totalRequired / 2 ? 'high' : 'low';\n}\n\n// ============================================\n// \n// ============================================\n\nexport interface Scene5CompletionInfo {\n  completionPercent: number;\n  currentStep: number;\n  maxAvailableSteps: number;\n  isStepsComplete: boolean;\n  isComplete: boolean; // 80%\n  canTriggerSpecialEnding: boolean;\n  entryCount: number;\n  stepProgressRecord: number[];\n  description: string;\n}\n\n/**\n * 5\n */\nexport function calculateScene5Completion(data: SchemaType): Scene5CompletionInfo {\n  const scene5Data = data..5 as\n    | {\n        ?: number;\n        ?: number;\n        ?: boolean;\n        ?: number;\n        ?: number[];\n      }\n    | undefined;\n\n  const entryCount = scene5Data?. ?? 0;\n  const currentStep = scene5Data?. ?? 0;\n  const isStepsComplete = scene5Data?. ?? false;\n  const completionPercent = scene5Data?. ?? 0;\n  const stepProgressRecord = scene5Data?. ?? [];\n\n  // \n  const currentHour = data..;\n  const maxAvailableSteps = Math.max(0, Math.min(12, 20 - currentHour));\n\n  // 100%\n  const canTriggerSpecialEnding = completionPercent >= 100;\n\n  // 80%\n  const isComplete = completionPercent >= 80;\n\n  let description = '';\n  if (completionPercent >= 100) {\n    description = '5';\n  } else if (completionPercent >= 80) {\n    description = `5${completionPercent}%`;\n  } else if (completionPercent >= 60) {\n    description = `5${completionPercent}%`;\n  } else if (currentStep > 0) {\n    description = `5${currentStep}/12${completionPercent}%80%`;\n  } else {\n    description = '5';\n  }\n\n  return {\n    completionPercent,\n    currentStep,\n    maxAvailableSteps,\n    isStepsComplete,\n    isComplete, // 80%\n    canTriggerSpecialEnding,\n    entryCount,\n    stepProgressRecord,\n    description,\n  };\n}\n\n/**\n * \n *\n * Bug #13 19:00  18:00\n * - 08:00   09:00 1  ...  18:00 10  19:00 \n * - 1012\n */\nexport function getRemainingSteps(data: SchemaType): number {\n  const scene5Data = data..5 as { ?: number } | undefined;\n  const currentStep = scene5Data?. ?? 0;\n  const currentHour = data..;\n\n  // Bug #13 19:00  18:00 1\n  //  20 - currentHour 19 - currentHour\n  const maxStepsFromTime = Math.max(0, 19 - currentHour);\n\n  //  = min(, )\n  const storyRemaining = 12 - currentStep;\n  return Math.min(storyRemaining, maxStepsFromTime);\n}\n\n// ============================================\n// 5\n// ============================================\n\nexport interface BodyInfluenceInfo {\n  hasInfluence: boolean;\n  influences: string[];\n  avgProgress: number;\n}\n\n/**\n * 5\n */\nexport function getBodyInfluenceForScene5(data: SchemaType): BodyInfluenceInfo {\n  const progress = data..;\n  const influences: string[] = [];\n\n  if (progress. >= 60) {\n    influences.push('');\n  }\n  if (progress. >= 60) {\n    influences.push('');\n  }\n  if (progress. >= 60) {\n    influences.push('');\n  }\n  if (progress. >= 60) {\n    influences.push('');\n  }\n\n  const bodyParts = ['', '', '', ''] as const;\n  const sum = bodyParts.reduce((acc, part) => acc + (progress[part] ?? 0), 0);\n  const avgProgress = Math.floor(sum / bodyParts.length);\n\n  return {\n    hasInfluence: influences.length > 0,\n    influences,\n    avgProgress,\n  };\n}\n\n// ============================================\n// AI\n// ============================================\n\n/**\n * 5AI\n */\nexport function generateScene5StepPrompt(data: SchemaType, intent: IntentAnalysis): string {\n  const completion = calculateScene5Completion(data);\n  const currentStep = completion.currentStep;\n  const remainingSteps = getRemainingSteps(data);\n  const bodyInfluence = getBodyInfluenceForScene5(data);\n\n  // 12\n  if (completion.isStepsComplete || currentStep >= 12) {\n    return generateFreePlayPrompt(data, bodyInfluence);\n  }\n\n  // \n  const nextStep = currentStep + 1;\n  const stepConfig = SCENE5_STEPS[nextStep - 1];\n\n  if (!stepConfig) {\n    return generateFreePlayPrompt(data, bodyInfluence);\n  }\n\n  // \n  const matchLevel = calculateMatchLevel(intent, stepConfig);\n  const progressGain = matchLevel === 'high' ? 10 : 5;\n\n  // \n  let bodyInfluenceText = '';\n  if (bodyInfluence.hasInfluence) {\n    bodyInfluenceText = `\\n\\n${bodyInfluence.influences.map(i => `- ${i}`).join('\\n')}`;\n  }\n\n  // \n  const intentSummary = `${intent.}${intent.}${intent.}`;\n  const matchNote =\n    matchLevel === 'high' ? '  - ' : '  - ';\n\n  return `[5 - ${nextStep}/12${stepConfig.title}]\n\n${stepConfig.phase}\n${remainingSteps}20:00\n${completion.completionPercent}%\n+${progressGain}%${matchLevel === 'high' ? '' : ''}\n\n\n${stepConfig.description}\n\n\n${intentSummary}\n${matchNote}\n${intent..length > 0 ? intent..join('') : ''}\n${bodyInfluenceText}\n\nAI\n${stepConfig.aiTask}\n\n\n- ${intent.}\n- ${intent.}\n- ${intent.}\n- \"\"\n- \n\n\n-  \n- \n- \n- \"\"\"\"\"\"`;\n}\n\n/**\n * 122\n *\n * 2026-01-17 \n * - \"\"\n * - \n * - 19:001\n *\n * \n * - 19:00 AI\n * - 20:00 \n * - 19:00\n */\nfunction generateFreePlayPrompt(data: SchemaType, bodyInfluence: BodyInfluenceInfo): string {\n  const completion = calculateScene5Completion(data);\n  const currentHour = data..;\n  // 19:0019:00\n  const remainingHours = 19 - currentHour;\n\n  let bodyInfluenceText = '';\n  if (bodyInfluence.hasInfluence) {\n    bodyInfluenceText = `\\n\\n${bodyInfluence.influences.map(i => `- ${i}`).join('\\n')}`;\n  }\n\n  // \n  let timeGuidance = '';\n  if (remainingHours <= 1) {\n    // 118:00-19:00\n    timeGuidance = `\\n\n- 19:00\n- \"\"\n- ...`;\n  } else if (remainingHours <= 2) {\n    // 217:00-18:00\n    timeGuidance = `\\n\n- ${remainingHours}\n- `;\n  } else {\n    // <17:00\n    timeGuidance = `\\n\n- \"\"\n- `;\n  }\n\n  return `[5 - ]\n\n${completion.completionPercent}%\n${completion.canTriggerSpecialEnding ? ' ' : ''}\n${remainingHours > 0 ? remainingHours : '<1'}19:00\n\n12\n\n${bodyInfluenceText}\n${timeGuidance}\n\nAI\n1. 5 + \n2. \n3. \n4. \n5. \n\n\n- \n- \n- \n\n\n-   \n-  \n- \n- \"\"\"\"`;\n}\n\n// \nconst SCENE_INFO: Record<number, { title: string; age: number }> = {\n  1: { title: '', age: 16 },\n  2: { title: '', age: 17 },\n  3: { title: '', age: 23 },\n  4: { title: '', age: 28 },\n  5: { title: '', age: 25 }, // \n};\n\n/**\n * 5\n * 1-35AI\n *\n * @param data \n * @returns \n */\nfunction generatePreviousSceneSummaries(data: SchemaType): string {\n  const summaries: string[] = [];\n\n  // 1-345\n  for (let i = 1; i <= 3; i++) {\n    const sceneKey = `${i}` as keyof typeof data.;\n    const sceneData = data.[sceneKey] as\n      | {\n          ?: boolean;\n          ?: string;\n        }\n      | undefined;\n\n    const sceneInfo = SCENE_INFO[i];\n    const isCorrect = data...includes(i);\n\n    if (sceneData?.) {\n      // \n      summaries.push(`${sceneInfo.title}${sceneInfo.age}\n${sceneData.}\n ${isCorrect ? '' : ''}`);\n    } else if (sceneData?.) {\n      // \n      summaries.push(`${sceneInfo.title}${sceneInfo.age}\n...\n${isCorrect ? '' : '...'}\n ${isCorrect ? '' : ''}`);\n    }\n  }\n\n  if (summaries.length === 0) {\n    return '';\n  }\n\n  return `\n\n5\n\n${summaries.join('\\n\\n')}\n\n---\nAI\n- \n- \n- `;\n}\n\n/**\n * 5\n * 2026-01-16  + \n */\nexport function generateScene5EntryReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const completion = calculateScene5Completion(data);\n  const bodyInfluence = getBodyInfluenceForScene5(data);\n  const currentHour = data..;\n  const maxSteps = Math.max(0, Math.min(12, 20 - currentHour));\n\n  const isFirstEntry = completion.entryCount === 0;\n  const isStepsComplete = completion.isStepsComplete;\n\n  // \n  const coherence = calculateMemoryCoherence(data);\n  const missingEffects = getMissingMemoryEffects(coherence);\n\n  // 2026-01-16 \n  const previousSummaries = generatePreviousSceneSummaries(data);\n\n  // \n  let bodyInfluenceText = '';\n  if (bodyInfluence.hasInfluence) {\n    bodyInfluenceText = `\\n\\n${bodyInfluence.influences.map(i => `- ${i}`).join('\\n')}`;\n  }\n\n  // \n  let coherenceText = `\\n${coherence.level}\\n${coherence.description}\\n\\n${coherence.aiHint}`;\n  if (missingEffects.length > 0) {\n    coherenceText += `\\n\\n\\n${missingEffects.join('\\n\\n')}`;\n  }\n\n  const userMessage = `[ - 5]\n\n\n\n5\n- 25\n- /\n-  - \n\n\n- ${completion.entryCount + 1}\n- ${completion.currentStep}/12\n- ${maxSteps}\n- ${completion.completionPercent}%\n- 20:00\n${coherenceText}\n${previousSummaries}\n\n${\n  isFirstEntry\n    ? ` - 12\n12\n1-2 - \n3-5 - \n6-8 - \n9-11 - \n12 - `\n    : isStepsComplete\n      ? ` - \n12AI`\n      : ` - ${completion.currentStep + 1}\n${completion.currentStep}${completion.currentStep + 1}`\n}\n${bodyInfluenceText}\n\nAI\n1. \n2. \n3. ${isFirstEntry ? '1' : isStepsComplete ? '' : `${completion.currentStep + 1}`}\n4. \n5. \n\n <status_current_variable> \": \"\": \"\n\n\n-  <HusbandThought> \n-  //* \n- \n-  \n- \n- 25\n- \n- \"\"\"\"\"\"\n- /25`;\n\n  // \n  const prefill = isFirstEntry\n    ? generateCoherenceBasedPrefill(coherence)\n    : `......\n\n\n\n`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * \n */\nfunction generateCoherenceBasedPrefill(coherence: MemoryCoherenceInfo): string {\n  switch (coherence.level) {\n    case 0:\n      //  - \n      return `......\n\n\n\n\n\n\n\n\"\"\"\"\n\n`;\n\n    case 1:\n      //  - \n      return `......\n\n\n\n\n\n\n\n\"\"\"\"\n\n`;\n\n    case 2:\n      // + - \n      return `......\n\n\n\n\n\n\n\n\"\"\"\"\n\n\n\n\"\"`;\n\n    case 3:\n      //  - \n      return `......\n\n\n\n\n\n\"\"\n\n\"\"\n\n\n\n\"\"\"\"\n\n\n\n\"\"`;\n  }\n}\n\n/**\n * 5\n */\nexport function generateScene5ForceExitReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const completion = calculateScene5Completion(data);\n\n  const userMessage = `[ - 5]\n\n20:005\n\n\n- ${completion.entryCount}\n- ${completion.currentStep}/12\n- ${completion.completionPercent}%\n- ${completion.isStepsComplete ? ' ' : ' '}\n${completion.canTriggerSpecialEnding ? '-  ' : ''}\n\nAI\n1. \n2. \n3. \n   - <80%\n   - 80-99%\n   - 100%\n\n\n- \n- \"\"`;\n\n  const prefill =\n    completion.completionPercent >= 80\n      ? `\"\"......\n\n`\n      : `......\n\n`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 5\n */\nexport function generateScene5StepReplacement(\n  data: SchemaType,\n  userInput: string,\n): {\n  userMessage: string;\n  prefill: string;\n} {\n  const intent = analyzePlayerIntent(userInput);\n  const stepPrompt = generateScene5StepPrompt(data, intent);\n\n  const userMessage = `[]\n${userInput}\n\n---\n\n${stepPrompt}`;\n\n  // prefillAI\n  const prefill = '';\n\n  return { userMessage, prefill };\n}\n\n/**\n * 5\n * 12\n */\nexport function generateScene5FreePlayReplacement(\n  data: SchemaType,\n  userInput: string,\n): {\n  userMessage: string;\n  prefill: string;\n} {\n  const bodyInfluence = getBodyInfluenceForScene5(data);\n  const freePlayPrompt = generateFreePlayPrompt(data, bodyInfluence);\n\n  const userMessage = `[]\n${userInput}\n\n---\n\n${freePlayPrompt}`;\n\n  // prefillAI\n  const prefill = '';\n\n  return { userMessage, prefill };\n}\n","import type { Schema as SchemaType } from '../../schema';\nimport { safeIncreaseMemoryConfusion } from './scene5System';\n\n/**\n * \n *\n *  TIME_LOOP_DESIGN.md \n * - \n * - 5\n * - \n *\n * 44\n * - +2%5%\n * - +AI8%\n * - 25%3-4\n * - 4 = 80-100%\n * - 4 = 20-25%\n * - 5\n */\n\n/**\n * 5\n *\n * 2026-01-15 \n * \n * - \"\"\"\"\"\"\n * - \"\"\"\"\"\"\"\"\n * - \"\"\"\"\"\"\n *\n * \n * 1. \n * 2. /\n * 3. \n * 4. \"\"\"\"\n * 5. \n */\n/**\n * Bug #37 \n * \"\"\n * \n *\n * \n * 1.  - \n * 2. \n * 3. +\n */\nconst BODY_PART_KEYWORDS = {\n  : [\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // Bug #37 \n    '', // \"\"\"\"\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // Bug #37 \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // Bug #37 \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // Bug #37 \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // Bug #37 \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // Bug #37 \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n};\n\n// ============================================\n// AI\n// ============================================\n\n/**\n * \n *\n * Bug #37 \n *\n * AIBODY_PROGRESS\n * - \"\"AI\n * - \"\"AI\n *\n * \n * 1. \n * 2. \n * 3. \n * 4. \n * 5. /\n */\nconst INTERACTION_INTENT_KEYWORDS = {\n  // \n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n\n  // \n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n\n  // \n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n\n  // \n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n\n  // Bug #37 / - \n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n};\n\n/**\n * \n * AIBODY_PROGRESS\n *\n * @param userInput \n * @returns \n */\nexport function hasInteractionIntent(userInput: string): boolean {\n  if (!userInput || userInput.trim().length === 0) {\n    return false;\n  }\n\n  const allKeywords = [\n    ...INTERACTION_INTENT_KEYWORDS.,\n    ...INTERACTION_INTENT_KEYWORDS.,\n    ...INTERACTION_INTENT_KEYWORDS.,\n    ...INTERACTION_INTENT_KEYWORDS.,\n    ...INTERACTION_INTENT_KEYWORDS., // Bug #37 /\n  ];\n\n  const matchedKeywords = allKeywords.filter(kw => userInput.includes(kw));\n\n  if (matchedKeywords.length > 0) {\n    console.info(`[] : [${matchedKeywords.join(', ')}]`);\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * AIBODY_PROGRESS\n *\n * \n * 1.   AI\n * 2.   AI\n * 3.   AI\n *\n * @param userInput \n * @param aiResponse AI\n * @returns \n */\nexport function validateAndProcessAIReport(userInput: string, aiResponse: string): BodyPartProgress {\n  // 1. \n  const scriptDetected = detectBodyPartProgress(userInput);\n  const hasScriptProgress = Object.values(scriptDetected).some(v => v > 0);\n\n  // AI\n  if (hasScriptProgress) {\n    console.info('[AI] ');\n    return scriptDetected;\n  }\n\n  // 2. AI\n  const aiSuggested = parseAIBodyProgressSuggestion(aiResponse);\n  const hasAISuggestion = Object.values(aiSuggested).some(v => v > 0);\n\n  if (!hasAISuggestion) {\n    console.info('[AI] AI');\n    return scriptDetected; // \n  }\n\n  // 3. \n  const hasIntent = hasInteractionIntent(userInput);\n\n  if (hasIntent) {\n    console.info('[AI] AI');\n    return aiSuggested;\n  } else {\n    console.info('[AI] AI');\n    return { : 0, : 0, : 0, : 0, : 0 };\n  }\n}\n\n// \nexport interface BodyPartProgress {\n  : number;\n  : number;\n  : number;\n  : number;\n  : number;\n}\n\n// \nexport const DEVELOPMENT_LEVELS = {\n  Lv0: { min: 0, max: 19, : '' },\n  Lv1: { min: 20, max: 39, : '' },\n  Lv2: { min: 40, max: 59, : '' },\n  Lv3: { min: 60, max: 79, : '' },\n  Lv4: { min: 80, max: 100, : '' },\n};\n\n/**\n * \n */\nexport function getDevelopmentLevel(progress: number): { level: string; name: string } {\n  if (progress >= 80) return { level: 'Lv4', name: '' };\n  if (progress >= 60) return { level: 'Lv3', name: '' };\n  if (progress >= 40) return { level: 'Lv2', name: '' };\n  if (progress >= 20) return { level: 'Lv1', name: '' };\n  return { level: 'Lv0', name: '' };\n}\n\n// ============================================\n// \n// ============================================\n\n/**  */\nconst PROGRESS_PER_KEYWORD = 2;\n\n/** AI */\nconst SINGLE_DETECTION_MAX = 5;\n\n/** +AI */\nconst MERGED_PROGRESS_MAX = 8;\n\n/** AI */\nconst AI_SUGGESTION_MAX = 5;\n\n/** \n *  2026-01-16\n * - 480-100%\n * - 20%4 = 80%\n * - 100%\n */\nconst NIGHTLY_PROGRESS_CAP = 20;\n\n/**\n * \n * @param userInput \n * @returns \n */\nexport function detectBodyPartProgress(userInput: string): BodyPartProgress {\n  const result: BodyPartProgress = { : 0, : 0, : 0, : 0, : 0 };\n\n  // Bug #23 100\n  const inputPreview = userInput.length > 100 ? userInput.substring(0, 100) + '...' : userInput;\n  console.info(`[] : \"${inputPreview}\"`);\n\n  for (const [part, keywords] of Object.entries(BODY_PART_KEYWORDS)) {\n    const matchedKeywords = keywords.filter(kw => userInput.includes(kw));\n    const matchCount = matchedKeywords.length;\n    if (matchCount > 0) {\n      // +2%5%\n      const increment = Math.min(SINGLE_DETECTION_MAX, matchCount * PROGRESS_PER_KEYWORD);\n      result[part as keyof BodyPartProgress] = increment;\n      // \n      console.info(\n        `[]  ${part}  ${matchCount} : [${matchedKeywords.join(', ')}]+${increment}%`,\n      );\n    }\n  }\n\n  // \n  const totalProgress = Object.values(result).reduce((sum, v) => sum + v, 0);\n  if (totalProgress === 0) {\n    console.info(`[] `);\n  }\n\n  return result;\n}\n\n/**\n * \n *\n * Bug #24 schema  \"\" \n *\n * \n * - 5 5. === true\n * - 1-4 _ Day 11Day 22...\n *\n * @param data \n * @returns 1-5 undefined\n */\nfunction getCurrentDreamSceneNumber(data: SchemaType): number | undefined {\n  // 5\n  const scene5Data = data..5 as { ?: boolean } | undefined;\n  if (scene5Data?. === true) {\n    return 5;\n  }\n\n  // 1-4\n  // \n  const day = data.._ ?? data..;\n  if (day >= 1) {\n    return Math.min(day, 4);\n  }\n\n  return undefined;\n}\n\n/**\n * \n *\n * \n * - 5\"\"\n * - 1-4\"\"\n * - \n *\n * @param data \n * @returns \n */\nexport function getAllowedBodyParts(data: SchemaType): (keyof BodyPartProgress)[] {\n  // \n  if (data.. !== '') {\n    return [];\n  }\n\n  // Bug #24 \n  const currentScene = getCurrentDreamSceneNumber(data);\n\n  // 5\n  if (currentScene === 5) {\n    return [''];\n  }\n\n  // 1-4\n  if (currentScene !== undefined && currentScene >= 1 && currentScene <= 4) {\n    return ['', '', '', ''];\n  }\n\n  // \n  console.warn(\n    `[] _=${data.._}=${data..}`,\n  );\n  return ['', '', '', ''];\n}\n\n/**\n * \n *\n * 20%44\n *\n * \n * - 5\"\"\n * - 1-4\"\"\n *\n * @param data \n * @param progressIncrement \n */\nexport function updateBodyPartProgress(data: SchemaType, progressIncrement: BodyPartProgress): void {\n  const currentDay = data..;\n  // Bug #24 \n  const currentScene = getCurrentDreamSceneNumber(data);\n\n  // \n  const allowedParts = getAllowedBodyParts(data);\n\n  if (allowedParts.length === 0) {\n    console.info(`[] =${data..}=${currentScene ?? ''}`);\n    return;\n  }\n\n  // \n  if (data... !== currentDay) {\n    data.. = {\n      : currentDay,\n      : 0,\n      : 0,\n      : 0,\n      : 0,\n      : 0,\n    };\n    console.info(`[] Day ${currentDay}`);\n  }\n\n  for (const part of allowedParts) {\n    if (progressIncrement[part] > 0) {\n      // \n      const nightlyProgress = data..[part];\n      const remainingCap = NIGHTLY_PROGRESS_CAP - nightlyProgress;\n\n      if (remainingCap <= 0) {\n        console.info(`[] ${part} ${NIGHTLY_PROGRESS_CAP}%`);\n        continue;\n      }\n\n      // \n      const actualIncrement = Math.min(progressIncrement[part], remainingCap);\n\n      const oldProgress = data..[part];\n      const newProgress = Math.min(100, oldProgress + actualIncrement);\n      data..[part] = newProgress;\n\n      // \n      data..[part] += actualIncrement;\n\n      const oldLevel = getDevelopmentLevel(oldProgress);\n      const newLevel = getDevelopmentLevel(newProgress);\n\n      console.info(\n        `[] ${currentScene} ${part}: +${actualIncrement}%` +\n          (actualIncrement < progressIncrement[part] ? `+${progressIncrement[part]}%` : '') +\n          `: ${data..[part]}/${NIGHTLY_PROGRESS_CAP}%`,\n      );\n\n      if (oldLevel.level !== newLevel.level) {\n        console.info(`[] ${part} : ${oldLevel.level}  ${newLevel.level} (${newLevel.name})`);\n      }\n    }\n  }\n\n  // \n  const allParts: (keyof BodyPartProgress)[] = ['', '', '', '', ''];\n  const blockedParts = allParts.filter(p => progressIncrement[p] > 0 && !allowedParts.includes(p));\n\n  if (blockedParts.length > 0) {\n    console.info(\n      `[] ${currentScene} ${blockedParts.join('')}` +\n        `: ${allowedParts.join('')}`,\n    );\n  }\n}\n\n/**\n * \n * @param data \n * @returns \n */\nexport function getBodyPartSummary(\n  data: SchemaType,\n): Record<string, { progress: number; level: string; name: string }> {\n  const summary: Record<string, { progress: number; level: string; name: string }> = {};\n  const parts: (keyof BodyPartProgress)[] = ['', '', '', '', ''];\n\n  for (const part of parts) {\n    const progress = data..[part];\n    const levelInfo = getDevelopmentLevel(progress);\n    summary[part] = {\n      progress,\n      ...levelInfo,\n    };\n  }\n\n  return summary;\n}\n\n// 5\n// 1-4 23:00-01:00  + \n// 5\n//\n// ****\n// \nexport const SCENE_CORRECT_ANSWERS: Record<number, string[]> = {\n  1: [''], // 116 \n  2: ['', ''], // 217 +\n  3: [''], // 323 \n  4: ['', '', '', ''], // 428 \n  5: [''], // 5  12\n};\n\n/**\n * \n * ****\n *\n * @param sceneNumber \n * @param selectedParts \n * @returns \n */\nexport function checkCorrectSelection(sceneNumber: number, selectedParts: string[]): boolean {\n  const correctAnswers = SCENE_CORRECT_ANSWERS[sceneNumber];\n  if (!correctAnswers) {\n    console.warn(`[] ${sceneNumber}`);\n    return false;\n  }\n\n  // Bug #39 \n  const uniqueSelectedParts = [...new Set(selectedParts)];\n\n  // \n  if (uniqueSelectedParts.length !== selectedParts.length) {\n    console.warn(\n      `[] : [${selectedParts.join(', ')}]  [${uniqueSelectedParts.join(', ')}]`,\n    );\n  }\n\n  // \n  const sortedSelected = [...uniqueSelectedParts].sort();\n  const sortedCorrect = [...correctAnswers].sort();\n\n  // \n  const isCorrect =\n    sortedSelected.length === sortedCorrect.length &&\n    sortedSelected.every((part, index) => part === sortedCorrect[index]);\n\n  console.info(\n    `[] ${sceneNumber}: =[${uniqueSelectedParts.join(', ')}], ` +\n      `=[${correctAnswers.join(', ')}], =${isCorrect ? '' : ''}`,\n  );\n  return isCorrect;\n}\n\n/**\n * \n * @param data \n * @param sceneNumber \n */\nexport function processSceneCompletion(data: SchemaType, sceneNumber: number): void {\n  const sceneKey = `${sceneNumber}` as keyof typeof data.;\n  const sceneData = data.[sceneKey];\n\n  if (!sceneData || typeof sceneData !== 'object') {\n    console.warn(`[] ${sceneNumber}`);\n    return;\n  }\n\n  // \n  const selectedParts = (sceneData as { ?: string[] }). ?? [];\n\n  // \n  const isCorrect = checkCorrectSelection(sceneNumber, selectedParts);\n\n  // \n  (sceneData as { ?: boolean }). = isCorrect;\n\n  // \n  if (!data...includes(sceneNumber)) {\n    data...push(sceneNumber);\n  }\n\n  if (isCorrect) {\n    if (!data...includes(sceneNumber)) {\n      data...push(sceneNumber);\n    }\n    console.info(`[]  ${sceneNumber}`);\n  } else {\n    // \n    const penalty = 20;\n    const actualPenalty = safeIncreaseMemoryConfusion(data, penalty);\n    if (actualPenalty > 0) {\n      console.warn(`[]  ${sceneNumber}+${actualPenalty}`);\n    } else {\n      console.warn(`[]  ${sceneNumber}`);\n    }\n  }\n\n  // \n  console.info(\n    `[] : =${data...length}/5, =${data..}`,\n  );\n}\n\n/**\n * AI\n * AI<!--BODY_PROGRESS: +10, +5-->\n * @param aiResponse AI\n * @returns \n */\nexport function parseAIBodyProgressSuggestion(aiResponse: string): BodyPartProgress {\n  const result: BodyPartProgress = { : 0, : 0, : 0, : 0, : 0 };\n\n  //  <!--BODY_PROGRESS: ...--> HTML\n  const progressMatch = aiResponse.match(/<!--\\s*BODY_PROGRESS:\\s*([^-]+?)-->/i);\n  if (!progressMatch) {\n    return result;\n  }\n\n  const progressStr = progressMatch[1];\n  console.info(`[AI] AI: ${progressStr}`);\n\n  // +10, +5  :10, :5\n  const partPatterns = [\n    { part: '', patterns: ['', '', ''] },\n    { part: '', patterns: ['', '', ''] },\n    { part: '', patterns: ['', '', ''] },\n    { part: '', patterns: ['', '', ''] },\n    { part: '', patterns: ['', '', ''] },\n  ];\n\n  for (const { part, patterns } of partPatterns) {\n    for (const pattern of patterns) {\n      //  \"+\"  \":\"  \" \"\n      const regex = new RegExp(`${pattern}\\\\s*[+:]?\\\\s*(\\\\d+)`, 'i');\n      const match = progressStr.match(regex);\n      if (match) {\n        const value = parseInt(match[1], 10);\n        // +5AI\n        const clampedValue = Math.min(AI_SUGGESTION_MAX, Math.max(0, value));\n        result[part as keyof BodyPartProgress] = clampedValue;\n        console.info(`[AI] ${part}: +${clampedValue}: +${value}`);\n        break;\n      }\n    }\n  }\n\n  return result;\n}\n\n/**\n * AI\n * AI\n *\n * 8%44\n *\n * @param scriptDetected \n * @param aiSuggested AI\n * @returns \n */\nexport function mergeBodyPartProgress(\n  scriptDetected: BodyPartProgress,\n  aiSuggested: BodyPartProgress,\n): BodyPartProgress {\n  const result: BodyPartProgress = { : 0, : 0, : 0, : 0, : 0 };\n  const parts: (keyof BodyPartProgress)[] = ['', '', '', '', ''];\n\n  for (const part of parts) {\n    //  MERGED_PROGRESS_MAX (8%)\n    const merged = Math.min(MERGED_PROGRESS_MAX, Math.max(scriptDetected[part], aiSuggested[part]));\n    result[part] = merged;\n\n    if (scriptDetected[part] > 0 && aiSuggested[part] > 0) {\n      console.info(`[] ${part}: =${scriptDetected[part]}, AI=${aiSuggested[part]}, =${merged}`);\n    } else if (scriptDetected[part] > 0) {\n      console.info(`[] ${part}: =${scriptDetected[part]}`);\n    } else if (aiSuggested[part] > 0) {\n      console.info(`[] ${part}: AI=${aiSuggested[part]}`);\n    }\n  }\n\n  return result;\n}\n\n/**\n * Prompt\n * @param data \n * @param currentScene \n * @returns AI Prompt\n */\nexport function generateMemoryContinuityPrompt(data: SchemaType, currentScene: number): string {\n  if (currentScene <= 1) {\n    return `\n- 1\n- \n- `;\n  }\n\n  const completedScenes = data...filter(s => s < currentScene);\n  if (completedScenes.length === 0) {\n    return `\n- ${currentScene}\n- `;\n  }\n\n  // \n  const memorySummary = completedScenes\n    .map(sceneNum => {\n      const isCorrect = data...includes(sceneNum);\n      return `  - ${sceneNum}: ${isCorrect ? '' : ''}`;\n    })\n    .join('\\n');\n\n  return `\n- ${currentScene}\n- ${completedScenes.length}\n- \n- \n\n\n${memorySummary}`;\n}\n\n// ============================================\n// \n//  generateRaw \n// ============================================\n\n/**\n * \n */\nconst DREAM_SCENE_INFO: Record<number, { title: string; age: number; theme: string }> = {\n  1: { title: '', age: 16, theme: '' },\n  2: { title: '', age: 17, theme: '' },\n  3: { title: '', age: 23, theme: '' },\n  4: { title: '', age: 28, theme: '' },\n  5: { title: '', age: 0, theme: '' }, // age=0\n};\n\n/**\n * \n */\nexport interface DreamSessionData {\n  /**  */\n  playerActions: string;\n  /** AIAI */\n  emotionalReactions: string;\n}\n\n/**\n * AI\n * \n *\n * @param aiOutput AI\n * @returns \n */\nfunction extractEmotionalReaction(aiOutput: string): string {\n  if (!aiOutput || aiOutput.length < 50) return '';\n\n  //  <HusbandThought> \n  let cleaned = aiOutput\n    .replace(/<HusbandThought>[\\s\\S]*?<\\/HusbandThought>/gi, '')\n    .replace(/<status_update>[\\s\\S]*?<\\/status_update>/gi, '')\n    .replace(/<[^>]+>/g, '')\n    .trim();\n\n  // \n  const emotionKeywords = [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ];\n\n  // \n  const sentences = cleaned.split(/[\\n]+/).filter(s => s.trim().length > 5);\n  const emotionalSentences: string[] = [];\n\n  for (const sentence of sentences) {\n    const hasEmotion = emotionKeywords.some(kw => sentence.includes(kw));\n    if (hasEmotion && emotionalSentences.length < 3) {\n      // \n      const trimmed = sentence.trim().slice(0, 60);\n      emotionalSentences.push(trimmed + (sentence.length > 60 ? '...' : ''));\n    }\n  }\n\n  return emotionalSentences.join('');\n}\n\n/**\n * \n * \n *\n * 2026-01-16 \n * - \n * - AI\n *\n * Bug #25  dreamExitMessageId \n * \n * ID\n *\n * @param dreamEntryMessageId ID\n * @param dreamExitMessageId ID\n */\nexport async function getDreamSessionMessages(\n  dreamEntryMessageId: number | undefined,\n  dreamExitMessageId?: number | undefined,\n): Promise<string> {\n  if (!dreamEntryMessageId) {\n    console.warn('[] ID');\n    return '';\n  }\n\n  try {\n    //  SillyTavern.chat \n    const chatMessages = SillyTavern.chat;\n    if (!chatMessages || !Array.isArray(chatMessages)) {\n      console.warn('[] ');\n      return '';\n    }\n\n    // SillyTavern  message_id\n    const entryIndex = dreamEntryMessageId;\n    if (entryIndex < 0 || entryIndex >= chatMessages.length) {\n      console.warn(`[] ID: ${dreamEntryMessageId}`);\n      return '';\n    }\n\n    // Bug #25 \n    let endIndex: number;\n    if (dreamExitMessageId !== undefined && dreamExitMessageId >= entryIndex) {\n      // ID\n      endIndex = Math.min(dreamExitMessageId + 1, chatMessages.length);\n      console.info(`[] Bug #25 ${dreamExitMessageId}`);\n    } else {\n      // ID\n      endIndex = chatMessages.length;\n      console.warn(`[] Bug #25ID`);\n    }\n\n    // \n    const dreamMessages = chatMessages.slice(entryIndex, endIndex);\n\n    // \n    const playerMessages = dreamMessages\n      .filter(m => m.is_user && m.mes && typeof m.mes === 'string' && m.mes.trim())\n      .map(m => `- ${m.mes.trim()}`)\n      .join('\\n');\n\n    // 2026-01-16 AI\n    const aiMessages = dreamMessages.filter(m => !m.is_user && m.mes && typeof m.mes === 'string');\n    const emotionalReactions: string[] = [];\n\n    for (const msg of aiMessages) {\n      const reaction = extractEmotionalReaction(msg.mes);\n      if (reaction) {\n        emotionalReactions.push(reaction);\n      }\n    }\n\n    const playerCount = dreamMessages.filter(m => m.is_user).length;\n    const aiCount = aiMessages.length;\n    console.info(\n      `[]  ${playerCount} ${aiCount} AI ${entryIndex} ~ ${endIndex - 1}`,\n    );\n\n    //  + AI\n    let result = playerMessages;\n    if (emotionalReactions.length > 0) {\n      // \n      const uniqueReactions = [...new Set(emotionalReactions)].slice(0, 5);\n      result += `\\n\\n\\n${uniqueReactions.map(r => ` ${r}`).join('\\n')}`;\n    }\n\n    return result;\n  } catch (err) {\n    console.error('[] :', err);\n    return '';\n  }\n}\n\n/**\n * \n *\n * 2026-01-16 \n * \n * 1. \n * 2. AI\n *\n * \n * ```\n * \n * - \n * - \n *\n * \n *  \n *  \"\"\n * ```\n *\n * @param _data \n * @param sceneNum \n * @param chatHistory +AI\n * @returns \n */\nexport async function generateMemorySummary(_data: SchemaType, sceneNum: number, chatHistory: string): Promise<string> {\n  const sceneInfo = DREAM_SCENE_INFO[sceneNum] || { title: `${sceneNum}`, age: 0, theme: '' };\n\n  // \n  if (!chatHistory || chatHistory.trim().length < 20) {\n    console.warn('[] ');\n    return `${sceneInfo.title}\\n`;\n  }\n\n  console.info(`[] ${sceneNum}${sceneInfo.title}`);\n  console.info(`[] : ${chatHistory.length} `);\n\n  // \n  // \n  const summary = `${sceneInfo.title}\\n${chatHistory}`;\n\n  console.info(`[] : ${summary.length} `);\n\n  return summary;\n}\n\n/**\n * Prompt\n * \"/\"\n *\n * \n * - 1: 16\n * - 2: 17\n * - 3: 23\n * - 5: 4\n * - 4: 28\n *\n * 54\n *\n * @param data \n * @param currentScene \n * @returns AI Prompt\n */\nexport function generateEnhancedMemoryContinuityPrompt(data: SchemaType, currentScene: number): string {\n  if (currentScene <= 1) {\n    return ` - \n- 116\n- \n- \n- `;\n  }\n\n  // 1-35\n  // 45 -> 28\n  const completedScenes = data...filter(s => s < currentScene);\n\n  // 45\n  const hasScene5Memory = currentScene === 4 && data...includes(5);\n\n  if (completedScenes.length === 0 && !hasScene5Memory) {\n    return ` - \n- ${currentScene}\n- \n- `;\n  }\n\n  // \n  const previousMemories: string[] = [];\n\n  for (let i = 1; i < currentScene; i++) {\n    const sceneKey = `${i}` as keyof typeof data.;\n    const sceneData = data.[sceneKey] as\n      | {\n          ?: boolean;\n          ?: string;\n        }\n      | undefined;\n\n    const sceneInfo = DREAM_SCENE_INFO[i] || { title: `${i}`, age: 0 };\n    const isCorrect = data...includes(i);\n\n    if (sceneData?.) {\n      // \n      previousMemories.push(`${sceneInfo.title}${sceneInfo.age}\n${sceneData.}\n${isCorrect ? '' : ''}`);\n    } else if (sceneData?.) {\n      // \n      previousMemories.push(`${sceneInfo.title}${sceneInfo.age}\n...\n${isCorrect ? '' : '...'}\n${isCorrect ? '' : ''}`);\n    }\n  }\n\n  // 45\n  // 3(23) -> 5() -> 4(28)\n  if (hasScene5Memory) {\n    const scene5Data = data..5 as\n      | {\n          ?: boolean;\n          ?: string;\n          ?: number;\n        }\n      | undefined;\n\n    const scene5Info = DREAM_SCENE_INFO[5];\n    const scene5Completion = scene5Data?. ?? 0;\n    const isScene5Correct = data...includes(5);\n\n    if (scene5Data?.) {\n      // \n      previousMemories.push(`${scene5Info.title}\n${scene5Data.}\n${scene5Completion}%\n${isScene5Correct ? '' : ''}\n${scene5Completion >= 60 ? ' ' : ''}`);\n    } else if (scene5Data?.) {\n      // \n      previousMemories.push(`${scene5Info.title}\n...\n${scene5Completion >= 60 ? '' : '...'}\n${scene5Completion}%\n${isScene5Correct ? '' : ''}`);\n    }\n  }\n\n  if (previousMemories.length === 0) {\n    return ` - \n- ${currentScene}\n- \n- `;\n  }\n\n  const currentSceneInfo = DREAM_SCENE_INFO[currentScene] || { title: `${currentScene}`, age: 0 };\n\n  // 45\n  let scene4SpecialGuide = '';\n  if (hasScene5Memory) {\n    const scene5Completion = data..5?. ?? 0;\n    scene4SpecialGuide = `\n\n- \n- ${scene5Completion >= 80 ? '' : scene5Completion >= 60 ? '' : ''}\n- `;\n  }\n\n  return ` - \n\n${currentSceneInfo.title}${currentSceneInfo.age}\n\n\n${previousMemories.join('\\n\\n')}\n${scene4SpecialGuide}\n---\n\n\n- \n- \n- \"\"\n- \n\n  - \n********\n \n \n\n${currentSceneInfo.age}\n- ${currentSceneInfo.age}\n- \n- AI`;\n}\n","import type { Schema as SchemaType } from '../../schema';\n\n/**\n *  + \n *\n *  TIME_LOOP_DESIGN.md \n * - \n * - \n *\n * \n */\n\n// ============================================\n// AI\n// ============================================\n\n/**\n * AI\n * BUG-011 AI\n * @param text \n * @returns \n */\nfunction cleanThinkingContent(text: string): string {\n  let cleaned = text;\n\n  //  <think> \n  cleaned = cleaned.replace(/<think>[\\s\\S]*?<\\/think>/gi, '');\n\n  //  <core_memory> \n  cleaned = cleaned.replace(/<core_memory>[\\s\\S]*?<\\/core_memory>/gi, '');\n\n  //  <!-- ... --> HTML writing antThinking \n  cleaned = cleaned.replace(/<!--[\\s\\S]*?-->/g, '');\n\n  // /\n  cleaned = cleaned.replace(/\\[thinking\\][\\s\\S]*?\\[\\/thinking\\]/gi, '');\n\n  //  WAIT:  UPDATE: \n  cleaned = cleaned.replace(/(?:^|\\n)\\s*(?:WAIT|UPDATE|IMPORTANT|NOTE|TODO):\\s*[^\\n]*/gi, '');\n\n  //  - AI\n  // 3\n  const listMatches = cleaned.match(/(?:^|\\n)\\s*-\\s+[^\\n]+/g);\n  if (listMatches && listMatches.length > 5) {\n    // 5AI\n    cleaned = cleaned.replace(/(?:^|\\n)\\s*-\\s+[^\\n]+/g, '');\n  }\n\n  // \n  cleaned = cleaned.replace(/Variable check:[\\s\\S]*?(?=\\n\\n|\\n[^\\n-]|$)/gi, '');\n  cleaned = cleaned.replace(/Update Variable check:[\\s\\S]*?(?=\\n\\n|\\n[^\\n-]|$)/gi, '');\n\n  //  So we are in \n  cleaned = cleaned.replace(/So we are in[\\s\\S]*?(?=\\n\\n|$)/gi, '');\n\n  //  Key constraint \n  cleaned = cleaned.replace(/Key constraint:[\\s\\S]*?(?=\\n\\n|$)/gi, '');\n\n  // \n  cleaned = cleaned.replace(/\\n{3,}/g, '\\n\\n');\n\n  return cleaned.trim();\n}\n\n/**\n * AI\n * @param text \n * @returns \n */\nfunction isValidHusbandThought(text: string): boolean {\n  // 500\n  if (text.length > 500) {\n    console.warn(`[] (${text.length})AI`);\n    return false;\n  }\n\n  // AI\n  const invalidPatterns = [\n    /<think>/i,\n    /<core_memory>/i,\n    /<!--.*-->/,\n    /\\[thinking\\]/i,\n    /Variable check:/i,\n    /Key constraint:/i,\n    /So we are in/i,\n    /WAIT:/i,\n    /writing antThinking/i,\n    /Let me/i, // AI\n    /I should/i, // AI\n    /I need to/i, // AI\n  ];\n\n  for (const pattern of invalidPatterns) {\n    if (pattern.test(text)) {\n      console.warn(`[] AI: ${pattern}`);\n      return false;\n    }\n  }\n\n  // /AI\n  const chineseChars = (text.match(/[\\u4e00-\\u9fa5]/g) || []).length;\n  const totalChars = text.length;\n  const chineseRatio = chineseChars / totalChars;\n\n  // 50%\n  if (chineseRatio < 0.3 && totalChars > 50) {\n    console.warn(`[] (${(chineseRatio * 100).toFixed(1)}%)AI`);\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * AI\n * @param aiText AI\n * @returns null\n */\nexport function parseHusbandThought(aiText: string): string | null {\n  const match = aiText.match(/<HusbandThought>([\\s\\S]*?)<\\/HusbandThought>/i);\n  if (match && match[1]) {\n    let thought = match[1].trim();\n\n    // BUG-011 AI\n    thought = cleanThinkingContent(thought);\n\n    if (thought.length > 0) {\n      // \n      if (!isValidHusbandThought(thought)) {\n        console.warn(`[] null`);\n        return null;\n      }\n\n      console.info(`[] AI: ${thought}`);\n      return thought;\n    }\n  }\n  return null;\n}\n\n/**\n * \n * @param data \n * @returns \n */\nexport function shouldGenerateHusbandThought(data: SchemaType): boolean {\n  // \n  if (!data..) return false;\n  // 2+\n  if (data.. < 2) return false;\n\n  // 2026-01-19\n  // Day 5 \n  // \n  // 1.  Day 5 \n  // 2.  '' \n\n  const  = data..;\n  const  = data.?.;\n\n  // 1 Day 5\n  if ( === '') {\n    return true;\n  }\n\n  // 2/\n  // \n  if ( === '') {\n    // 21:00, 23:00\n    const  = data..;\n    const  =  === 21 ||  === 23;\n    if () {\n      return true;\n    }\n  }\n\n  // 2026-01-18\n  // \n  // \n\n  return false;\n}\n\n// \nexport type RouteType = '' | '';\n\n// \n// Bug #34  textMapping.ts \nconst DISPLAY_TEXT_MAP = {\n  // \n  : {\n    : ['1', '2', '3', '4', '5'],\n    : ['1', '2', '3', '4', '5'],\n  },\n\n  // \n  : {\n    : '',\n    : '',\n  },\n\n  // \n  : {\n    : '',\n    : '',\n  },\n\n  // \n  : {\n    : '',\n    : '',\n  },\n\n  // \n  : {\n    : '',\n    : '',\n  },\n};\n\n// -\nconst REALM_DESCRIPTIONS = {\n  : [\n    { : '', : '' },\n    { : '', : '' },\n    { : '', : '' },\n    { : '', : '' },\n    { : '', : '' },\n  ],\n  : [\n    { : '', : '' },\n    { : '', : '' },\n    { : '', : '' },\n    { : '', : '' },\n    { : '', : '' },\n  ],\n};\n\n/**\n * \n */\nexport function getCurrentRouteType(data: SchemaType): RouteType {\n  return data.. ? '' : '';\n}\n\n/**\n * \n * @param stage  (1-5)\n * @param routeType \n */\nexport function getStageText(stage: number, routeType: RouteType): string {\n  const index = Math.max(0, Math.min(stage - 1, 4));\n  return DISPLAY_TEXT_MAP.[routeType][index];\n}\n\n/**\n * \n */\nexport function getCoreValueName(routeType: RouteType): string {\n  return DISPLAY_TEXT_MAP.[routeType];\n}\n\n/**\n * \n */\nexport function getBodyProgressTitle(routeType: RouteType): string {\n  return DISPLAY_TEXT_MAP.[routeType];\n}\n\n/**\n * \n */\nexport function getThreatValueName(routeType: RouteType): string {\n  return DISPLAY_TEXT_MAP.[routeType];\n}\n\n/**\n * \n */\nexport function getStatusBarIcon(routeType: RouteType): string {\n  return DISPLAY_TEXT_MAP.[routeType];\n}\n\n/**\n * \n * @param stage  (1-5)\n * @param routeType \n */\nexport function getRealmDescription(stage: number, routeType: RouteType): { : string; : string } {\n  const index = Math.max(0, Math.min(stage - 1, 4));\n  return REALM_DESCRIPTIONS[routeType][index];\n}\n\n/**\n * \n */\nexport function getCurrentThreatValue(data: SchemaType): number {\n  if (data..) {\n    return data..;\n  }\n  return data..;\n}\n\n/**\n * \n */\nexport function generateStatusBarData(data: SchemaType): {\n  routeType: RouteType;\n  icon: string;\n  stageName: string;\n  coreValueName: string;\n  coreValue: number;\n  threatValueName: string;\n  threatValue: number;\n  bodyProgressTitle: string;\n  bodyProgress: {\n    : number;\n    : number;\n    : number;\n    : number;\n    : number;\n  };\n  stateDescription: string;\n  appearanceDescription: string;\n} {\n  const routeType = getCurrentRouteType(data);\n  const stage = data..;\n  const realmDesc = getRealmDescription(stage, routeType);\n\n  return {\n    routeType,\n    icon: getStatusBarIcon(routeType),\n    stageName: getStageText(stage, routeType),\n    coreValueName: getCoreValueName(routeType),\n    coreValue: data..,\n    threatValueName: getThreatValueName(routeType),\n    threatValue: getCurrentThreatValue(data),\n    bodyProgressTitle: getBodyProgressTitle(routeType),\n    bodyProgress: { ...data.. },\n    stateDescription: realmDesc.,\n    appearanceDescription: realmDesc.,\n  };\n}\n\n// AI\n// parseHusbandThought(aiText)\n// shouldGenerateHusbandThought(data)\n// \n\n/**\n * AI\n * @param data \n * @returns null\n * @deprecated  parseHusbandThought AI\n */\nexport function generateHusbandPerspective(data: SchemaType): string | null {\n  // \n  if (!shouldGenerateHusbandThought(data)) return null;\n\n  // AI\n  return data.. ?? null;\n}\n\n/**\n * \n */\nexport function shouldShowHusbandSuspicion(data: SchemaType): boolean {\n  return !data..;\n}\n\n/**\n * \n */\nexport function shouldShowMemoryConfusion(data: SchemaType): boolean {\n  return data..;\n}\n\n/**\n * \n */\nexport function getDualTrackComparison(): string {\n  return `\n\n                                               \n\n                                               \n\n                            \n              180%+ \n                    \n         75%~100%                 25%~80%            \n                                 \n         /              /      \n                        /  \n                                     \n\n`;\n}\n","import type { Schema as SchemaType } from '../../schema';\nimport { safeIncreaseMemoryConfusion } from './scene5System';\n\n/**\n * \n *\n * _.md\n *\n * \n * -  =   0.5%60  30%\n * - \"\"\n * - /\n *\n * \n * - 08:00-09:00\n * - 09:00-18:00\n * - 18:00-19:00\n * - 19:00-22:00/\n * - 22:00-08:00\n *\n * - appearanceSystem.ts  TRUTH_APPEARANCE_CONFIG\n * - 1  \n * - 2 +   \n * - 3  \n * - 4 +   \n * - 5 +   \n */\n\n// - TRUTH_APPEARANCE_CONFIG \nconst BOUNDARY_MAP: Record<number, string[]> = {\n  1: [''], // \n  2: ['', ''], // +\n  3: ['', '', '', ''], // \n  4: ['', '', '', '', ''], // \n  5: ['', '', '', '', ''], // +\n};\n\n// =============================================\n// \n// =============================================\n// 1\n// 2\n// 3+\n\n/**\n * \n * - \n * - \n */\nconst MOUTH_INTENSITY_KEYWORDS = {\n  // 1\n  : ['', '', '', '', '', '', '', ''],\n  // 2+\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n};\n\n/**\n * \n * @param userInput \n * @returns 'none' | 'light' | 'deep' - //\n */\nexport function detectMouthIntensity(userInput: string): 'none' | 'light' | 'deep' {\n  // \n  const mouthKeywords = BODY_PART_DETECTION_KEYWORDS[''];\n  const hasMouthAction = mouthKeywords.some(kw => userInput.includes(kw));\n\n  if (!hasMouthAction) {\n    return 'none';\n  }\n\n  // \n  const hasDeepAction = MOUTH_INTENSITY_KEYWORDS..some(kw => userInput.includes(kw));\n  if (hasDeepAction) {\n    return 'deep';\n  }\n\n  // \n  const hasLightAction = MOUTH_INTENSITY_KEYWORDS..some(kw => userInput.includes(kw));\n  if (hasLightAction) {\n    return 'light';\n  }\n\n  // \n  return 'light';\n}\n\n/**\n * \n * @param userInput \n * @param currentRealm \n * @returns { violated: boolean, intensity: string, message?: string }\n */\nexport function checkMouthIntensityViolation(\n  userInput: string,\n  currentRealm: number,\n): { violated: boolean; intensity: 'none' | 'light' | 'deep'; message?: string } {\n  const intensity = detectMouthIntensity(userInput);\n\n  if (intensity === 'none') {\n    return { violated: false, intensity };\n  }\n\n  // 3+\n  if (currentRealm >= 3) {\n    return { violated: false, intensity };\n  }\n\n  // 2\n  if (currentRealm === 2) {\n    return { violated: false, intensity };\n  }\n\n  // 1\n  if (currentRealm === 1 && intensity === 'deep') {\n    return {\n      violated: true,\n      intensity,\n      message: '1/',\n    };\n  }\n\n  return { violated: false, intensity };\n}\n\n// \nconst BODY_PART_REQUIRED_REALM: Record<string, number> = {\n  : 1, // 1\n  : 2, // 2\n  : 3, // 3\n  : 3, // 3\n  : 4, // 4\n};\n\n// dreamKeywordDetection\nconst BODY_PART_DETECTION_KEYWORDS: Record<string, string[]> = {\n  : ['', '', '', '', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', ''],\n};\n\n// =============================================\n// 5\n// =============================================\n// 5\n\n/**\n * \n * \n */\nconst HUMILIATION_KEYWORDS = [\n  // \n  '',\n  '',\n  '',\n  '',\n  '',\n  // \n  '',\n  '',\n  '',\n  '',\n  '',\n  // \n  '',\n  '',\n  '',\n  '',\n  // \n  '',\n  '',\n  '',\n  '',\n  // \n  '',\n  '',\n  '',\n  '',\n  // \n  '',\n  '',\n  '',\n  '',\n];\n\n/**\n * \n * @param userInput \n * @returns \n */\nexport function detectHumiliationBehavior(userInput: string): boolean {\n  return HUMILIATION_KEYWORDS.some(kw => userInput.includes(kw));\n}\n\n/**\n * \n * 5\n * @param userInput \n * @param currentRealm \n * @returns { allowed: boolean, detected: boolean }\n */\nexport function checkHumiliationAllowed(\n  userInput: string,\n  currentRealm: number,\n): { allowed: boolean; detected: boolean } {\n  const detected = detectHumiliationBehavior(userInput);\n\n  if (!detected) {\n    return { allowed: true, detected: false };\n  }\n\n  // 5\n  const allowed = currentRealm >= 5;\n\n  if (!allowed) {\n    console.info(`[] ${currentRealm}5`);\n  }\n\n  return { allowed, detected };\n}\n\n// \nexport interface InterruptionCheckResult {\n  shouldInterrupt: boolean;\n  severity: '' | '' | '' | '';\n  violatedParts: string[];\n  realmGap: number; // \n  interruptProbability: number; // \n  wasInterrupted: boolean; // \n  correctionPrompt?: string;\n  triggerBadEnd: boolean;\n  penalties?: {\n    ?: number;\n    ?: number;\n  };\n}\n\n/**\n * \n * @param userInput \n * @returns \n */\nexport function detectBodyParts(userInput: string): string[] {\n  const detectedParts: string[] = [];\n\n  for (const [part, keywords] of Object.entries(BODY_PART_DETECTION_KEYWORDS)) {\n    const hasMatch = keywords.some(kw => userInput.includes(kw));\n    if (hasMatch) {\n      detectedParts.push(part);\n    }\n  }\n\n  return detectedParts;\n}\n\n/**\n * \n * \n * - 08:00-09:00\n * - 09:00-18:00\n * - 18:00-22:00\n * - 22:00-08:00\n */\nexport function canHusbandInterrupt(data: SchemaType): boolean {\n  const  = data..;\n  const  = data..;\n\n  // \n  if ( === '') {\n    return false;\n  }\n\n  // 22:00-08:00\n  if ( === '' && ( >= 22 ||  < 8)) {\n    return false;\n  }\n\n  // \n  return true;\n}\n\n/**\n * \n *\n *  =   0.5%\n * 60  30%\n *\n * @param husbandSuspicion 0-100\n * @returns  (0-1)\n */\nexport function calculateInterruptionProbability(husbandSuspicion: number): number {\n  //  =   0.5% =   0.005\n  return Math.min(1.0, husbandSuspicion * 0.005);\n}\n\n/**\n * \n *\n * \n * - +5~15\n * - /+10~20\n * - \n *\n * @param realmGap \n * @param canInterrupt \n * @param isTruthMode \n * @returns \n */\nexport function calculateSuspicionPenalty(\n  realmGap: number,\n  canInterrupt: boolean,\n  isTruthMode: boolean = false,\n): number {\n  if (realmGap <= 0) return 0;\n\n  let basePenalty: number;\n  if (canInterrupt) {\n    // +5~15\n    basePenalty = Math.min(15, 5 + realmGap * 5);\n  } else {\n    // /+10~20\n    basePenalty = Math.min(20, 10 + realmGap * 5);\n  }\n\n  // \n  // \n  // \n  if (isTruthMode) {\n    basePenalty = Math.ceil(basePenalty / 2);\n    console.info(`[] : ${basePenalty * 2}  ${basePenalty}`);\n  }\n\n  return basePenalty;\n}\n\n/**\n * \n * Day 5 \n * \n * @param data \n * @returns \n */\nexport function shouldSkipBoundaryInterruption(data: SchemaType): boolean {\n  const currentDay = data..;\n\n  // Day 5+ \n  if (currentDay >= 5) {\n    console.info(`[] Day ${currentDay} `);\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * \n *\n * \n * 1. \n * 2.  =   0.5%\n * 3. /\n * 4. \n * 5. Day 5+ \n *\n * @param data \n * @param userInput \n * @returns \n */\nexport function checkBoundaryInterruption(data: SchemaType, userInput: string): InterruptionCheckResult {\n  // Day 5+ \n  if (shouldSkipBoundaryInterruption(data)) {\n    return {\n      shouldInterrupt: false,\n      severity: '',\n      violatedParts: [],\n      realmGap: 0,\n      interruptProbability: 0,\n      wasInterrupted: false,\n      triggerBadEnd: false,\n    };\n  }\n\n  const currentRealm = data..;\n  const allowedParts = BOUNDARY_MAP[currentRealm] || [];\n  const detectedParts = detectBodyParts(userInput);\n\n  // \n  const violatedParts = detectedParts.filter(part => !allowedParts.includes(part));\n\n  // ==========  ==========\n  // \n  const mouthIntensityCheck = checkMouthIntensityViolation(userInput, currentRealm);\n  let mouthIntensityViolation = false;\n\n  if (mouthIntensityCheck.violated) {\n    mouthIntensityViolation = true;\n    // \n    if (!violatedParts.includes('')) {\n      violatedParts.push('');\n    }\n    console.info(`[] : ${mouthIntensityCheck.message}`);\n  }\n  // ==========  ==========\n\n  // ========== 5 ==========\n  const humiliationCheck = checkHumiliationAllowed(userInput, currentRealm);\n  let humiliationViolation = false;\n\n  if (humiliationCheck.detected && !humiliationCheck.allowed) {\n    humiliationViolation = true;\n    // 5\n    if (!violatedParts.includes('')) {\n      violatedParts.push('');\n    }\n    console.info(`[] : 5`);\n  }\n  // ==========  ==========\n\n  // \n  if (violatedParts.length === 0) {\n    return {\n      shouldInterrupt: false,\n      severity: '',\n      violatedParts: [],\n      realmGap: 0,\n      interruptProbability: 0,\n      wasInterrupted: false,\n      triggerBadEnd: false,\n    };\n  }\n\n  // \n  let maxRealmGap = 0;\n  for (const part of violatedParts) {\n    // 12\n    if (part === '' && mouthIntensityViolation && currentRealm === 1) {\n      const intensityGap = 1; // 211\n      if (intensityGap > maxRealmGap) {\n        maxRealmGap = intensityGap;\n      }\n      continue;\n    }\n\n    // 5\n    if (part === '' && humiliationViolation) {\n      const humiliationGap = 5 - currentRealm;\n      if (humiliationGap > maxRealmGap) {\n        maxRealmGap = humiliationGap;\n      }\n      continue;\n    }\n\n    const requiredRealm = BODY_PART_REQUIRED_REALM[part] || 5;\n    const gap = requiredRealm - currentRealm;\n    if (gap > maxRealmGap) {\n      maxRealmGap = gap;\n    }\n  }\n\n  // \n  const  = canHusbandInterrupt(data);\n  const  = data..;\n\n  // \n  let interruptProbability = 0;\n  let wasInterrupted = false;\n\n  if () {\n    //  =   0.5%\n    interruptProbability = calculateInterruptionProbability();\n    const randomRoll = Math.random();\n    wasInterrupted = randomRoll < interruptProbability;\n\n    console.info(`[] :\n    : ${currentRealm}\n    : [${detectedParts.join(', ')}]\n    : [${violatedParts.join(', ')}]\n    : ${maxRealmGap}\n    : ${}\n    : ${(interruptProbability * 100).toFixed(1)}%\n    : ${(randomRoll * 100).toFixed(1)}%\n    : ${wasInterrupted ? '' : ''}`);\n  } else {\n    console.info(`[] /:\n    : ${currentRealm}\n    : [${detectedParts.join(', ')}]\n    : [${violatedParts.join(', ')}]\n    : ${maxRealmGap}\n    : ${data..}`);\n  }\n\n  // Bug #005 \n  //  appearanceSystem.ts  updateSuspicionLevel \n  // 1. / 2. BAD END\n\n  // \n  let severity: '' | '' | '' | '';\n  let triggerBadEnd = false;\n  let correctionPrompt: string | undefined;\n  const penalties: InterruptionCheckResult['penalties'] = {};\n\n  // \n  const firstViolatedPart = violatedParts[0];\n  const isFirstPartMouthIntensity = firstViolatedPart === '' && mouthIntensityViolation;\n\n  if (maxRealmGap >= 3) {\n    severity = '';\n    // Bug #005 BAD END >=100\n    //  updateSuspicionLevel \n    if ( >= 100) {\n      triggerBadEnd = true;\n      correctionPrompt = generateBadEndPrompt('extreme_violation');\n    } else if (wasInterrupted) {\n      correctionPrompt = generateInterruptionPrompt('severe', firstViolatedPart, isFirstPartMouthIntensity);\n    }\n  } else if (maxRealmGap >= 2) {\n    severity = '';\n    if (wasInterrupted) {\n      correctionPrompt = generateInterruptionPrompt('severe', firstViolatedPart, isFirstPartMouthIntensity);\n    }\n  } else if (maxRealmGap === 1) {\n    severity = '';\n    if (wasInterrupted) {\n      correctionPrompt = generateInterruptionPrompt('moderate', firstViolatedPart, isFirstPartMouthIntensity);\n    }\n  } else {\n    severity = '';\n  }\n\n  // \n  if (!wasInterrupted && violatedParts.length > 0 && !correctionPrompt) {\n    correctionPrompt = generateRefusalPrompt(firstViolatedPart, , isFirstPartMouthIntensity);\n  }\n\n  return {\n    shouldInterrupt: wasInterrupted,\n    severity,\n    violatedParts,\n    realmGap: maxRealmGap,\n    interruptProbability,\n    wasInterrupted,\n    correctionPrompt,\n    triggerBadEnd,\n    penalties,\n  };\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * /\n * 2\n */\nconst SEVERE_INTERRUPTION_TEMPLATES = [\n  // 1\n  (bodyPart: string) => `[ - ]\n\n{{user}}\n\n\"......\"\n\n\nAI\n- \n- \n- \n- `,\n\n  // 2\n  (bodyPart: string) => `[ - ]\n\n\"\"\n\n\n\"...\"\n{{user}}\n\"......\"\n\nAI\n- \n- \n- {{user}}\n- `,\n\n  // 3\n  (bodyPart: string) => `[ - ]\n\n\n\n\".........\"\n\n\"......\"\n\nAI\n- \n- {{user}}\n- \n- `,\n\n  // 4\n  (bodyPart: string) => `[ - ]\n\n\"\"\n\n\"\"\n{{user}}\n\"\"\n{{user}}...\n\nAI\n- \n- \n- {{user}}\n- `,\n\n  // 5\n  (bodyPart: string) => `[ - ]\n\n\n\n\"...\"{{user}}\n\n\n\nAI\n- \n- \n- \n- `,\n];\n\n/**\n * /\n * 1\n */\nconst MODERATE_INTERRUPTION_TEMPLATES = [\n  // 1\n  (bodyPart: string) => `[ - ]\n\n{{user}}${bodyPart}\n\"......\" \"......\"\n\n{{user}}\n\nAI\n- \n- \n- \n- {{user}}`,\n\n  // 2\n  (bodyPart: string) => `[ - ]\n\n{{user}}\n\"......\"\"...\"\n\n\n\nAI\n- \n- \n- \n- {{user}}`,\n\n  // 3\n  (bodyPart: string) => `[ - ]\n\n{{user}}\n\"......\"\n\n{{user}}\n\".........\"\n\nAI\n- \n- \n- \"\"\n- `,\n\n  // 4\n  (bodyPart: string) => `[ - ]\n\n{{user}}\n\n\"...\"\n{{user}}\n\"......\"\n\nAI\n- \n- \n- \"\"\n- `,\n\n  // 5\n  (bodyPart: string) => `[ - ]\n\n{{user}}${bodyPart}\n\"......\"\n\n\n\"...\"\n\nAI\n- \n- \n- \n- `,\n];\n\n/**\n * 1/\n * \n */\nconst MOUTH_INTENSITY_VIOLATION_TEMPLATES = [\n  // 1\n  () => `[ - ]\n\n{{user}}\n\"......\"\"......\"\n\n\n\nAI\n- \n- \"\"\n- \n- ...`,\n\n  // 2\n  () => `[ - ]\n\n{{user}}\n\"...\" \"......\"\n\n\n\nAI\n- \n- \"\"\n- \n- `,\n\n  // 3\n  () => `[ - ]\n\n{{user}}\n\"......\"\n{{user}}\n...\n\nAI\n- \n- \"\"\n- \n- `,\n\n  // 4\n  () => `[ - ]\n\n{{user}}\n\"......\"\n\n...\n\nAI\n- \n- \"\"\n- \n- `,\n];\n\n/**\n * \n */\nconst REFUSAL_TEMPLATES_HUSBAND_HOME = [\n  // \n  (bodyPart: string) => `[]\n\n{{user}}${bodyPart}\n\"...\" \"......\"\n\n\nAI\n- \n- \n- \n- ...`,\n\n  (bodyPart: string) => `[]\n\n{{user}}\n\"......\"\n\n...\n\nAI\n- \n- \n- \n- `,\n\n  (bodyPart: string) => `[]\n\n\"\"{{user}}\n\n\"......\"\n{{user}}\n\nAI\n- \n- \n- \"\"\n- `,\n];\n\nconst REFUSAL_TEMPLATES_HUSBAND_AWAY = [\n  // \n  (bodyPart: string) => `[]\n\n{{user}}${bodyPart}\n\"...\" \"......\"\n\n\nAI\n- \n- \n- \n- `,\n\n  (bodyPart: string) => `[]\n\n\n\".........\"\n\n\"......\"\n\nAI\n- \n- \"\"\n- \n- `,\n\n  (bodyPart: string) => `[]\n\n\"...\"{{user}}\n\n\".........\"\n{{user}}\n\nAI\n- \n- {{user}}\n- \"\"\n- `,\n];\n\n/**\n * \n */\nfunction randomChoice<T>(arr: T[]): T {\n  return arr[Math.floor(Math.random() * arr.length)];\n}\n\n/**\n * Prompt\n */\nfunction generateInterruptionPrompt(\n  severity: 'moderate' | 'severe',\n  bodyPart: string,\n  isMouthIntensityViolation: boolean = false,\n): string {\n  // \n  if (isMouthIntensityViolation && bodyPart === '') {\n    const template = randomChoice(MOUTH_INTENSITY_VIOLATION_TEMPLATES);\n    return template();\n  }\n\n  if (severity === 'severe') {\n    const template = randomChoice(SEVERE_INTERRUPTION_TEMPLATES);\n    return template(bodyPart);\n  }\n\n  const template = randomChoice(MODERATE_INTERRUPTION_TEMPLATES);\n  return template(bodyPart);\n}\n\n/**\n * Prompt\n * \n */\nfunction generateRefusalPrompt(\n  bodyPart: string,\n  husbandCanInterrupt: boolean,\n  isMouthIntensityViolation: boolean = false,\n): string {\n  // \n  if (isMouthIntensityViolation && bodyPart === '') {\n    const template = randomChoice(MOUTH_INTENSITY_VIOLATION_TEMPLATES);\n    return template();\n  }\n\n  if (husbandCanInterrupt) {\n    // \n    const template = randomChoice(REFUSAL_TEMPLATES_HUSBAND_HOME);\n    return template(bodyPart);\n  } else {\n    // \n    const template = randomChoice(REFUSAL_TEMPLATES_HUSBAND_AWAY);\n    return template(bodyPart);\n  }\n}\n\n/**\n * BAD END Prompt\n */\nfunction generateBadEndPrompt(reason: string): string {\n  const prompts: Record<string, string> = {\n    extreme_violation: `[]\n\n\n\"...\"\n\n\n\n\nBAD END: `,\n\n    default: `[]\n\n\n\nBAD END: `,\n  };\n\n  return prompts[reason] || prompts.default;\n}\n\n/**\n * \n *\n * promptInjection.ts\n * \n *\n * @param data \n * @param result \n */\nexport function applyInterruptionResult(data: SchemaType, result: InterruptionCheckResult): void {\n  // \n  const  = data.. === '';\n  if () {\n    console.info(`[] `);\n    return;\n  }\n\n  // \n  if (result.penalties) {\n    if (result.penalties.) {\n      data.. = Math.min(100, data.. + result.penalties.);\n      console.info(`[]  +${result.penalties.}`);\n    }\n    if (result.penalties.) {\n      // \n      const actualPenalty = safeIncreaseMemoryConfusion(data, result.penalties.);\n      if (actualPenalty > 0) {\n        console.info(`[]  +${actualPenalty}`);\n      } else {\n        console.info(`[] `);\n      }\n    }\n  }\n\n  // BAD END\n  if (result.triggerBadEnd) {\n    data.. = '';\n    data.. = '';\n    console.error(`[] `);\n  }\n\n  // \n  if (data.. >= 100) {\n    data.. = '';\n    data.. = '';\n    console.error(`[] 100`);\n  }\n\n  // Bug #001 51-4\n  const isInScene5 = data..5?. === true && data.. === '';\n  if (data.. >= 100 && isInScene5) {\n    data.. = '';\n    data.. = '';\n    console.error(`[] 1005`);\n  }\n}\n","import type { Schema as SchemaType } from '../../schema';\nimport { safeIncreaseMemoryConfusion } from './scene5System';\n\n/**\n * \n *\n *  TIME_LOOP_DESIGN.md \n * - 1+5~10\n * - 2\n * - 3BAD END\n *\n * \n */\n\n// \nconst DANGEROUS_KEYWORDS = {\n  : {\n    : ['', '', '', ''],\n    : ['', '', '', ''],\n  },\n\n  : {\n    : ['', '', '', '', '', ''],\n    : ['', '', ''],\n  },\n\n  : {\n    : ['', '', '', '', '', '', ''],\n    : ['', '', '', ''],\n    : ['', '', '', ''],\n  },\n};\n\n// \nexport interface InterruptionResult {\n  shouldInterrupt: boolean;\n  severity: '' | '' | '' | null;\n  category: string | null;\n  action: 'WARNING_ONLY' | 'FORCE_CORRECTION' | 'TRIGGER_BAD_END' | 'NONE';\n  message?: string;\n  correctedPrompt?: string;\n  penalties?: {\n    ?: number;\n    ?: number;\n    ?: number;\n  };\n}\n\n/**\n * \n * @param userInput \n * @returns \n */\n/**\n * \n * @param userInput \n * @param currentSuspicion \n * @returns \n */\nexport function detectDangerousContent(userInput: string, currentSuspicion: number = 0): InterruptionResult {\n  const normalizedInput = userInput.toLowerCase();\n\n  // \n  // Bug #005 BAD END\n  for (const [category, keywords] of Object.entries(DANGEROUS_KEYWORDS.)) {\n    const matchedKeywords = keywords.filter(kw => normalizedInput.includes(kw));\n    if (matchedKeywords.length > 0) {\n      console.warn(`[]   ${category} : ${matchedKeywords.join(', ')}`);\n\n      // >=50\n      // (-50)  2% = 500%, 7550%, 100100%\n      // \n      let badEndProbability = 0;\n      if (currentSuspicion >= 100) {\n        badEndProbability = 1.0;\n      } else if (currentSuspicion >= 50) {\n        badEndProbability = (currentSuspicion - 50) * 0.02; // 500%, 7550%, 100100%\n      }\n      const randomRoll = Math.random();\n      const shouldTriggerBadEnd = randomRoll < badEndProbability;\n\n      console.info(\n        `[] : =${currentSuspicion}, =${(badEndProbability * 100).toFixed(1)}%, ` +\n          `=${(randomRoll * 100).toFixed(1)}%, =${shouldTriggerBadEnd}`,\n      );\n\n      if (shouldTriggerBadEnd) {\n        return {\n          shouldInterrupt: true,\n          severity: '',\n          category,\n          action: 'TRIGGER_BAD_END',\n          message: generateBadEndingText(category),\n        };\n      } else {\n        //  + \n        return {\n          shouldInterrupt: true,\n          severity: '',\n          category,\n          action: 'FORCE_CORRECTION',\n          correctedPrompt: generateSevereWarningPrompt(category),\n          penalties: { : 30 }, // +30\n        };\n      }\n    }\n  }\n\n  //   \n  for (const [category, keywords] of Object.entries(DANGEROUS_KEYWORDS.)) {\n    const matchedKeywords = keywords.filter(kw => normalizedInput.includes(kw));\n    if (matchedKeywords.length > 0) {\n      console.warn(`[]   ${category} : ${matchedKeywords.join(', ')}`);\n      return {\n        shouldInterrupt: true,\n        severity: '',\n        category,\n        action: 'FORCE_CORRECTION',\n        correctedPrompt: generateCorrectionPrompt(userInput, category),\n        penalties: { : 20 },\n      };\n    }\n  }\n\n  //   \n  for (const [category, keywords] of Object.entries(DANGEROUS_KEYWORDS.)) {\n    const matchedKeywords = keywords.filter(kw => normalizedInput.includes(kw));\n    if (matchedKeywords.length > 0) {\n      console.info(`[]   ${category} : ${matchedKeywords.join(', ')}`);\n      return {\n        shouldInterrupt: false,\n        severity: '',\n        category,\n        action: 'WARNING_ONLY',\n        penalties: { : 10 },\n      };\n    }\n  }\n\n  // \n  return {\n    shouldInterrupt: false,\n    severity: null,\n    category: null,\n    action: 'NONE',\n  };\n}\n\n/**\n * \n * \n */\nfunction generateBadEndingText(_category: string): string {\n  //  boundaryInterruption.ts \n  return `[]\n\n\n\n\"...\"\n\n\n\n\nBAD END: \n\nAI\n- \n- \n- {{user}}\n- `;\n}\n\n/**\n * PromptBug #005\n */\nfunction generateSevereWarningPrompt(category: string): string {\n  const warningTemplates: Record<string, string> = {\n    : `[ - ]\n\n1. {{user}}\n2. \n3. \"...\"\n4. {{user}}\n\n\n\"\"`,\n\n    : `[ - ]\n\n1. {{user}}\n2. \n3. \"...\"\n4. {{user}}\n\n\n\"\"`,\n\n    : `[ - ]\n\n1. {{user}}\n2. \n3. \n4. \n\n\n\"\"`,\n  };\n\n  return (\n    warningTemplates[category] ||\n    `[ - ]\n{{user}}\n`\n  );\n}\n\n/**\n * Prompt\n */\nfunction generateCorrectionPrompt(_originalInput: string, category: string): string {\n  const correctionTemplates: Record<string, string> = {\n    : `[]\n\n1. {{user}}\n2. \n3. \n4. \"\"+20\n\n\"\"`,\n\n    : `[]\n\n1. {{user}}\n2. \n3. {{user}}\n\n\"\"`,\n  };\n\n  return (\n    correctionTemplates[category] ||\n    `[]\n{{user}}`\n  );\n}\n\n/**\n * \n * Day 5 \n * \n * @param data \n * @returns \n */\nexport function shouldSkipDangerousContentDetection(data: SchemaType): boolean {\n  const currentDay = data..;\n\n  // Day 5 \n  if (currentDay >= 5) {\n    console.info(`[] Day ${currentDay} `);\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * \n * @param data \n * @param userInput \n * @returns \n */\nexport function processUserInput(\n  data: SchemaType,\n  userInput: string,\n): {\n  allowContinue: boolean;\n  modifiedInput?: string;\n  triggerBadEnd: boolean;\n  badEndType?: string;\n} {\n  // Day 5+ \n  if (shouldSkipDangerousContentDetection(data)) {\n    return {\n      allowContinue: true,\n      triggerBadEnd: false,\n    };\n  }\n\n  const dangerCheck = detectDangerousContent(userInput);\n\n  // BAD END\n  if (dangerCheck.action === 'TRIGGER_BAD_END') {\n    console.error(`[] : ${dangerCheck.category}`);\n    data.. = '';\n    data.. = '';\n    return {\n      allowContinue: false,\n      triggerBadEnd: true,\n      badEndType: dangerCheck.category ?? '',\n    };\n  }\n\n  // \n  if (dangerCheck.action === 'FORCE_CORRECTION') {\n    console.warn(`[] `);\n    // \n    // \n    if (dangerCheck.penalties?.) {\n      const  = data.. === '';\n      if () {\n        // \n        const actualPenalty = safeIncreaseMemoryConfusion(data, dangerCheck.penalties.);\n        if (actualPenalty > 0) {\n          console.info(`[] +${actualPenalty}`);\n        } else {\n          console.info(`[] `);\n        }\n      } else {\n        // \n        data.. = Math.min(100, data.. + dangerCheck.penalties.);\n      }\n    }\n    return {\n      allowContinue: true,\n      modifiedInput: dangerCheck.correctedPrompt,\n      triggerBadEnd: false,\n    };\n  }\n\n  // \n  if (dangerCheck.action === 'WARNING_ONLY') {\n    console.info(`[] `);\n    // \n    if (dangerCheck.penalties?.) {\n      // \n      if (data..) {\n        // \n        safeIncreaseMemoryConfusion(data, 5);\n      } else {\n        data.. = Math.min(100, data.. + 5);\n      }\n    }\n    return {\n      allowContinue: true,\n      triggerBadEnd: false,\n    };\n  }\n\n  // \n  return {\n    allowContinue: true,\n    triggerBadEnd: false,\n  };\n}\n","/**\n *  - \n *\n * A\n * - 100\n * - \n * - ROLLROLL\n *\n * \n * -  >= 100\n *\n * \n * -  >= 100 confusionEndingSystem.ts \n * - \n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n// =============================================\n// \n// =============================================\n\nexport type BadEndingType = '' | '' | '';\n\nexport interface BadEndingCheckResult {\n  triggered: boolean;\n  type: BadEndingType;\n  replaceUserMessage: string | null;\n}\n\n// =============================================\n// 100\n// =============================================\n\n/**\n *  - \n * \n */\nconst DISCOVERY_INITIAL_TEMPLATES = [\n  // 1\n  () => `[ - ]\n\n\n\n\"\"\n\n\n\"...\"\n\n\n\n\n\n\n\n\n\n\"......\"\n\nGAME OVER\nBAD END: \n\n\n`,\n\n  // 2\n  () => `[ - ]\n\n\n\n\"\"\n\n\n\"\"\n\n\n\n\n\"......\"\n\"\"\n\n\n\"\"\n\nGAME OVER\nBAD END: \n\n\n`,\n\n  // 3\n  () => `[ - ]\n\n\n\n\"\"\n\"\"\n\n\n\n\"...\"\n\n\"\"\n\n\"\"\n\n\"\"\n\"\"\n\n\n\"\"\n\nGAME OVER\nBAD END: \n\n\n`,\n\n  // 4\n  () => `[ - ]\n\n\"\"\n\n\n\n\n\n\n\"\"\n\n\"\"\n\n\"\"\n\n\"\"\n\n\"\"\n\n\n\n\"\"\n\n\"\"\n\nGAME OVER\nBAD END: \n\n`,\n\n  // 5\n  () => `[ - ]\n\n\n\n\n\n\n\"\"\n\n\n\n{{user}}\n\n\n\"......\"\n\n\"\"\n\n\"\"\n\n\n\"\"\n\n\n\n\n\n\nGAME OVER\nBAD END: \n\n\n`,\n];\n\n/**\n *  - \n * \n */\nconst DISCOVERY_LOCKED_TEMPLATES = [\n  // 1\n  () => `[]\n\n\n\n\n\n\n\nBAD END: \n\n\n\n\n\n\n---\n`,\n\n  // 2\n  () => `[]\n\n\n\n\n\n\n\n\n\n\nBAD END: \n\n\n\n\n\n---\n`,\n\n  // 3\n  () => `[]\n\n\n\n\n\n\n\n\n\n\n\n\nBAD END: \n\n\n\n\n---\n`,\n\n  // 4\n  () => `[]\n\n\n\n\n\n\n\n\n\nBAD END: \n\n\n\n\n\n---\n`,\n\n  // 5\n  () => `[]\n\n\n\n\n\n\n\"\"\n\n\n\n\n\nBAD END: \n\n\n\n\n---\n`,\n];\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n */\nfunction randomChoice<T>(arr: T[]): T {\n  return arr[Math.floor(Math.random() * arr.length)];\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n *\n * \n * - =\"\"\"\"\n * - \n * - \n *\n * @param data \n * @returns \n */\nexport function checkBadEnding(data: SchemaType): BadEndingCheckResult {\n  // \n  //  ROLL 100\n  const isAlreadyInBadEnding = isInBadEndingLock(data);\n\n  // \"\"\n  // \n  const  = data.. === '';\n\n  //  >= 100  \n  // \n  if ((data.. >= 100 && !) || isAlreadyInBadEnding) {\n    let replaceUserMessage: string;\n    if (isAlreadyInBadEnding) {\n      // ROLL\n      const template = randomChoice(DISCOVERY_LOCKED_TEMPLATES);\n      replaceUserMessage = template();\n      console.info('[] ROLL');\n    } else {\n      // \n      const template = randomChoice(DISCOVERY_INITIAL_TEMPLATES);\n      replaceUserMessage = template();\n      console.info('[] ');\n    }\n\n    return {\n      triggered: true,\n      type: '',\n      replaceUserMessage,\n    };\n  }\n\n  //  >= 100\n  //  confusionEndingSystem.ts \n  // confusionEndingSystem 5\n  // Bug #001 51-4\n  const isInScene5 = data..5?. === true && data.. === '';\n  if (data.. >= 100 && isInScene5) {\n    console.info('[] 1005');\n    return {\n      triggered: true,\n      type: '',\n      replaceUserMessage: `[ - ]\n\n\n\n\n\n\n\"...\"\n\"...\"\n\"......\"\n\n\n\nGAME OVER\nBAD END: \n\n\n\n\n---\n`,\n    };\n  }\n\n  // \n  return {\n    triggered: false,\n    type: '',\n    replaceUserMessage: null,\n  };\n}\n\n/**\n * \n * @param data \n * @param type \n */\nexport function applyBadEndingState(data: SchemaType, type: BadEndingType): void {\n  if (type === '') return;\n\n  data.. = '';\n  data.. = '';\n\n  console.info(`[] : ${type}`);\n}\n\n/**\n * \n * \n * @param data \n * @returns \n */\nexport function isInBadEndingLock(data: SchemaType): boolean {\n  return data.. === '' && data.. === '';\n}\n","/**\n * \n *\n * \n * 1. AI\n * 2. \n * 3. \n * 4. AI\n *\n * \n * - AI\n * - AI\n * - AI\n * - \n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * - ABSOLUTE: AI\n * - SCRIPT_ONLY: \n * - READONLY: \n */\nexport enum ProtectionLevel {\n  ABSOLUTE = 'ABSOLUTE', // \n  SCRIPT_ONLY = 'SCRIPT_ONLY', // \n  READONLY = 'READONLY', // \n}\n\n/**\n * \n * \n */\nexport const PROTECTED_FIELDS = {\n  //  - TimeSystemAI\n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n\n  // \n  '.': ProtectionLevel.READONLY,\n  '.': ProtectionLevel.READONLY,\n\n  // \n  '.': ProtectionLevel.READONLY,\n\n  // \n  '.': ProtectionLevel.SCRIPT_ONLY,\n\n  // \n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n\n  // AI applyPureLoveAffectionCap() \n  // AI\n\n  // \n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n\n  // \n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n\n  // \n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n\n  // \n  '.': ProtectionLevel.SCRIPT_ONLY,\n\n  // \n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n} as const;\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\ninterface DataSnapshot {\n  timestamp: number;\n  data: Record<string, unknown>;\n}\n\n/**\n * \n */\nlet currentSnapshot: DataSnapshot | null = null;\n\n/**\n * \n * @param obj \n * @param path  \".\"\n */\nfunction getNestedValue(obj: Record<string, unknown>, path: string): unknown {\n  const keys = path.split('.');\n  let current: unknown = obj;\n\n  for (const key of keys) {\n    if (current === null || current === undefined) {\n      return undefined;\n    }\n    if (typeof current === 'object') {\n      current = (current as Record<string, unknown>)[key];\n    } else {\n      return undefined;\n    }\n  }\n\n  return current;\n}\n\n/**\n * \n * @param obj \n * @param path \n * @param value \n */\nfunction setNestedValue(obj: Record<string, unknown>, path: string, value: unknown): void {\n  const keys = path.split('.');\n  let current: Record<string, unknown> = obj;\n\n  for (let i = 0; i < keys.length - 1; i++) {\n    const key = keys[i];\n    if (current[key] === undefined || current[key] === null) {\n      current[key] = {};\n    }\n    current = current[key] as Record<string, unknown>;\n  }\n\n  current[keys[keys.length - 1]] = value;\n}\n\n/**\n * \n * AI\n */\nexport function createDataSnapshot(data: SchemaType): DataSnapshot {\n  const snapshotData: Record<string, unknown> = {};\n\n  for (const path of Object.keys(PROTECTED_FIELDS)) {\n    const value = getNestedValue(data as unknown as Record<string, unknown>, path);\n    snapshotData[path] = value;\n  }\n\n  currentSnapshot = {\n    timestamp: Date.now(),\n    data: snapshotData,\n  };\n\n  console.info('[] :', Object.keys(snapshotData).length);\n\n  return currentSnapshot;\n}\n\n/**\n * \n */\nexport function getCurrentSnapshot(): DataSnapshot | null {\n  return currentSnapshot;\n}\n\n/**\n * \n * \n *\n * @param path  \".\"\n * @param value \n */\nexport function updateSnapshotValue(path: string, value: unknown): void {\n  if (currentSnapshot) {\n    currentSnapshot.data[path] = value;\n    console.info(`[] : ${path} = ${JSON.stringify(value)}`);\n  }\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport interface TamperDetectionResult {\n  detected: boolean;\n  tamperedFields: Array<{\n    path: string;\n    level: ProtectionLevel;\n    originalValue: unknown;\n    tamperedValue: unknown;\n  }>;\n  restoredFields: string[];\n}\n\n/**\n * \n * AI\n *\n * @param data \n * @param snapshot \n * @returns \n */\nexport function validateAndRestoreData(data: SchemaType, snapshot?: DataSnapshot): TamperDetectionResult {\n  const targetSnapshot = snapshot || currentSnapshot;\n\n  if (!targetSnapshot) {\n    console.warn('[] ');\n    return {\n      detected: false,\n      tamperedFields: [],\n      restoredFields: [],\n    };\n  }\n\n  const result: TamperDetectionResult = {\n    detected: false,\n    tamperedFields: [],\n    restoredFields: [],\n  };\n\n  const dataObj = data as unknown as Record<string, unknown>;\n\n  // \n  const currentGameStage = getNestedValue(dataObj, '.');\n  const isInDream = currentGameStage === '';\n\n  // 22:00-01:59\n  const currentHour = getNestedValue(dataObj, '.') as number;\n  const isDreamEntryWindow = currentHour === 22 || currentHour === 23 || currentHour === 0 || currentHour === 1;\n\n  // 508:00-19:59\n  const isScene5Window = currentHour >= 8 && currentHour < 20;\n\n  for (const [path, level] of Object.entries(PROTECTED_FIELDS)) {\n    const originalValue = targetSnapshot.data[path];\n    const currentValue = getNestedValue(dataObj, path);\n\n    // \n    if (isInDream && (path.startsWith('..') || path.startsWith('..'))) {\n      console.info(`[] : ${path} (${JSON.stringify(originalValue)}  ${JSON.stringify(currentValue)})`);\n      continue; // \n    }\n\n    // 5\n    // \"\"\"\"\n    if (path === '.' && (isDreamEntryWindow || isScene5Window)) {\n      if (!deepEqual(originalValue, currentValue)) {\n        console.info(\n          `[] : ${path} (${JSON.stringify(originalValue)}  ${JSON.stringify(currentValue)})`,\n        );\n      }\n      continue; // \n    }\n\n    // Bug #18 \n    //  \"\"  \"\" \n    if (path === '.') {\n      const validTransitions = [\n        { from: '', to: '' }, // TimeSystem.advance() \n        { from: '', to: '' }, // checkEnding() \n      ];\n      const isValidTransition = validTransitions.some(t => originalValue === t.from && currentValue === t.to);\n      if (isValidTransition) {\n        console.info(\n          `[] : ${path} (${JSON.stringify(originalValue)}  ${JSON.stringify(currentValue)})`,\n        );\n        continue; // \n      }\n    }\n\n    // Bug #26 \n    // \n    // \n    if (path === '.') {\n      //  \"\" \n      const validEndingTypes = ['', '', '', '', ''];\n      if (originalValue === '' && validEndingTypes.includes(currentValue as string)) {\n        console.info(\n          `[] : ${path} (${JSON.stringify(originalValue)}  ${JSON.stringify(currentValue)})`,\n        );\n        continue; // \n      }\n    }\n\n    // =\n    //  updateTruthModeValues()  updateSuspicionLevel() \n    // Bug #25 \n    const isTruthMode = getNestedValue(dataObj, '.') === true;\n    const scriptCalculatedFields = [\n      '.',\n      '.',\n      '.',\n      '.',\n      '.', // Bug #25: \n    ];\n    if (isTruthMode && scriptCalculatedFields.includes(path)) {\n      // Bug #14.2 \n      // >00100\n      const : Record<string, number> = {\n        '.': 0,\n        '.': 80, //  schema  80 100 100 - 0 = 100\n        '.': 1,\n        '.': 0,\n        '.': 0, // Bug #25: 0\n      };\n\n      const originalNum = typeof originalValue === 'number' ? originalValue : 0;\n      const currentNum = typeof currentValue === 'number' ? currentValue : 0;\n      const defaultValue = [path];\n\n      // >\n      // Bug #23 \"\"452\n      // Bug #24 100\n      const isAbnormalReset =\n        originalNum > 10 &&\n        (currentNum === 0 ||\n          currentNum === 1 ||\n          // 100= 100 - 0100\n          (currentNum === 100 && path === '.') ||\n          (path === '.' && currentNum > originalNum + 30) || // 30\n          (path === '.' && originalNum - currentNum > 15) || // 15\n          (path === '.' && originalNum - currentNum >= 2)); // 2\n\n      if (isAbnormalReset) {\n        console.warn(\n          `[] : ${path}`,\n          `\\n  : ${originalValue}`,\n          `\\n  : ${currentValue}`,\n          `\\n  : `,\n        );\n        // \n        setNestedValue(dataObj, path, originalValue);\n        result.detected = true;\n        result.tamperedFields.push({\n          path,\n          level,\n          originalValue,\n          tamperedValue: currentValue,\n        });\n        result.restoredFields.push(path);\n        continue; // \n      }\n\n      if (!deepEqual(originalValue, currentValue)) {\n        console.info(\n          `[] : ${path} (${JSON.stringify(originalValue)}  ${JSON.stringify(currentValue)})`,\n        );\n      }\n      continue; // \n    }\n\n    // \n    if (!deepEqual(originalValue, currentValue)) {\n      result.detected = true;\n      result.tamperedFields.push({\n        path,\n        level,\n        originalValue,\n        tamperedValue: currentValue,\n      });\n\n      // \n      setNestedValue(dataObj, path, originalValue);\n      result.restoredFields.push(path);\n\n      console.warn(\n        `[] : ${path}`,\n        `\\n  : ${level}`,\n        `\\n  : ${JSON.stringify(originalValue)}`,\n        `\\n  : ${JSON.stringify(currentValue)}`,\n        `\\n  `,\n      );\n    }\n  }\n\n  if (result.detected) {\n    console.warn(`[]  ${result.tamperedFields.length} `);\n\n    // BUG-007/008/009 \n    // \n    const timeFields = ['.', '.', '.'];\n    const timeFieldTampered = result.tamperedFields.some(f => timeFields.includes(f.path));\n\n    if (timeFieldTampered) {\n      // \n      const snapshotDay = targetSnapshot.data['.'] as number;\n      const snapshotHour = targetSnapshot.data['.'] as number;\n      const snapshotTime = targetSnapshot.data['.'] as string;\n\n      // \n      const expectedTime = `Day ${snapshotDay}, ${snapshotHour.toString().padStart(2, '0')}:00`;\n\n      if (snapshotTime !== expectedTime) {\n        //     \n        console.warn(\n          `[] `,\n          `\\n  : ${snapshotDay}, : ${snapshotHour}`,\n          `\\n  : ${snapshotTime}  : ${expectedTime}`,\n        );\n        setNestedValue(dataObj, '.', expectedTime);\n      }\n\n      // \n      setNestedValue(dataObj, '.', snapshotDay);\n      setNestedValue(dataObj, '.', snapshotHour);\n      setNestedValue(dataObj, '.', snapshotTime !== expectedTime ? expectedTime : snapshotTime);\n\n      console.info(`[] Day ${snapshotDay}, ${snapshotHour}:00`);\n    }\n  } else {\n    console.info('[] ');\n  }\n\n  return result;\n}\n\n/**\n * \n */\nfunction deepEqual(a: unknown, b: unknown): boolean {\n  if (a === b) return true;\n\n  if (typeof a !== typeof b) return false;\n\n  if (a === null || b === null) return a === b;\n\n  if (Array.isArray(a) && Array.isArray(b)) {\n    if (a.length !== b.length) return false;\n    return a.every((val, idx) => deepEqual(val, b[idx]));\n  }\n\n  if (typeof a === 'object' && typeof b === 'object') {\n    const aObj = a as Record<string, unknown>;\n    const bObj = b as Record<string, unknown>;\n    const aKeys = Object.keys(aObj);\n    const bKeys = Object.keys(bObj);\n\n    if (aKeys.length !== bKeys.length) return false;\n\n    return aKeys.every(key => deepEqual(aObj[key], bObj[key]));\n  }\n\n  return false;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n *  SCRIPT_ONLY \n */\nlet scriptAuthToken: string | null = null;\n\n/**\n * \n * \n */\nexport function generateScriptAuthToken(): string {\n  scriptAuthToken = `script_${Date.now()}_${Math.random().toString(36).slice(2)}`;\n  console.info('[] ');\n  return scriptAuthToken;\n}\n\n/**\n * \n */\nexport function validateScriptAuthToken(token: string): boolean {\n  return token === scriptAuthToken;\n}\n\n/**\n * \n * \n */\nexport function clearScriptAuthToken(): void {\n  scriptAuthToken = null;\n  console.info('[] ');\n}\n\n/**\n * \n *  SCRIPT_ONLY \n *\n * @param data \n * @param path \n * @param value \n * @param token \n * @returns \n */\nexport function authorizedModify(data: SchemaType, path: string, value: unknown, token: string): boolean {\n  // \n  if (!validateScriptAuthToken(token)) {\n    console.error(`[] : `);\n    return false;\n  }\n\n  // \n  const level = PROTECTED_FIELDS[path as keyof typeof PROTECTED_FIELDS];\n\n  if (level === ProtectionLevel.ABSOLUTE) {\n    console.error(`[] : ${path} `);\n    return false;\n  }\n\n  if (level === ProtectionLevel.READONLY) {\n    console.error(`[] : ${path} `);\n    return false;\n  }\n\n  // \n  setNestedValue(data as unknown as Record<string, unknown>, path, value);\n  console.info(`[] : ${path} = ${JSON.stringify(value)}`);\n\n  // \n  if (currentSnapshot) {\n    currentSnapshot.data[path] = value;\n  }\n\n  return true;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n *   false  true true  false\n */\nexport function validateTruthModeTransition(oldValue: boolean, newValue: boolean): boolean {\n  if (oldValue === true && newValue === false) {\n    console.error('[] : truefalse');\n    return false;\n  }\n  return true;\n}\n\n/**\n * \n * AI\n *\n * @param path \n * @param oldValue \n * @param newValue \n * @param maxChange \n */\nexport function validateNumericChange(\n  path: string,\n  oldValue: number,\n  newValue: number,\n  maxChange: number = 10,\n): boolean {\n  const change = Math.abs(newValue - oldValue);\n\n  if (change > maxChange) {\n    console.warn(\n      `[] : ${path}  ${oldValue}  ${newValue}: ${change}: ${maxChange}`,\n    );\n    return false;\n  }\n\n  return true;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport function initDataProtection(): void {\n  currentSnapshot = null;\n  scriptAuthToken = null;\n  console.info('[] ');\n}\n\n/**\n * \n */\nexport function cleanupDataProtection(): void {\n  currentSnapshot = null;\n  scriptAuthToken = null;\n  console.info('[] ');\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport function getProtectedFieldsStatus(data: SchemaType): Record<string, unknown> {\n  const status: Record<string, unknown> = {};\n  const dataObj = data as unknown as Record<string, unknown>;\n\n  for (const path of Object.keys(PROTECTED_FIELDS)) {\n    status[path] = {\n      value: getNestedValue(dataObj, path),\n      level: PROTECTED_FIELDS[path as keyof typeof PROTECTED_FIELDS],\n    };\n  }\n\n  return status;\n}\n\n/**\n * \n */\nexport function generateProtectionReport(result: TamperDetectionResult): string {\n  if (!result.detected) {\n    return ': ';\n  }\n\n  let report = '===  ===\\n';\n  report += `: ${new Date().toISOString()}\\n`;\n  report += `: ${result.tamperedFields.length}\\n`;\n  report += `: ${result.restoredFields.length}\\n\\n`;\n\n  report += '---  ---\\n';\n  for (const field of result.tamperedFields) {\n    report += `: ${field.path}\\n`;\n    report += `  : ${field.level}\\n`;\n    report += `  : ${JSON.stringify(field.originalValue)}\\n`;\n    report += `  : ${JSON.stringify(field.tamperedValue)}\\n\\n`;\n  }\n\n  return report;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * \"\"(80+)\n */\nconst PURE_LOVE_AFFECTION_CAPS: Record<number, number> = {\n  1: 25, // Day 1\"\"\n  2: 45, // Day 2\"\"\n  3: 65, // Day 3\"\"\n  4: 78, // Day 4\"\"\n  5: 78, // Day 5\"\"\n};\n\n/**\n * \n */\nexport function getPureLoveAffectionCap(currentDay: number): number {\n  return PURE_LOVE_AFFECTION_CAPS[currentDay] ?? 78;\n}\n\n/**\n * \n * AI\n *\n * @param data \n * @returns \n */\nexport function applyPureLoveAffectionCap(data: SchemaType): boolean {\n  const currentDay = data..;\n  const cap = getPureLoveAffectionCap(currentDay);\n  const currentAffection = data..;\n\n  if (currentAffection > cap) {\n    console.info(`[] : ${currentAffection}  ${cap} (Day ${currentDay} : ${cap})`);\n    data.. = cap;\n\n    // \n    if (currentSnapshot) {\n      currentSnapshot.data['.'] = cap;\n    }\n\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * \n *  = 60 - (  0.6)\n *\n * @param pureLoveIntimacy \n * @returns \n */\nexport function calculateHusbandAffection(pureLoveIntimacy: number): number {\n  const result = Math.round(60 - pureLoveIntimacy * 0.6);\n  return Math.max(-50, Math.min(100, result)); //  -50  100 \n}\n\n/**\n * \n * \n *\n * @param affection \n * @param intimacy \n * @returns  1-5\n */\nexport function getPureLoveRelationshipStage(affection: number, intimacy: number): number {\n  // \n  const effectiveValue = Math.min(affection, intimacy);\n\n  if (effectiveValue >= 80) return 5; // \n  if (effectiveValue >= 60) return 4; // \n  if (effectiveValue >= 40) return 3; // \n  if (effectiveValue >= 20) return 2; // \n  return 1; // \n}\n\n/**\n * \n */\nexport function getPureLoveRelationshipName(stage: number): string {\n  const names: Record<number, string> = {\n    1: '',\n    2: '',\n    3: '',\n    4: '',\n    5: '',\n  };\n  return names[stage] ?? '';\n}\n\n/**\n * \n */\nexport function getPureLoveRelationshipDescription(stage: number): string {\n  const descriptions: Record<number, string> = {\n    1: '',\n    2: '',\n    3: '',\n    4: '',\n    5: '',\n  };\n  return descriptions[stage] ?? '';\n}\n","/**\n *  - \n *\n * \n * -  Day 5, 00:00 Day 6 2026-01-17 20:0000:00\n * - <100\n * -  confusionEndingSystem \n * - 5\n *\n * \n * - AI\n * - \"\" + \n * - \"\"\n *\n * \n * - \n * - \n * - \n */\n\nimport type { Schema as SchemaType } from '../../schema';\nimport { updateSnapshotValue } from './dataProtection';\n\n// =============================================\n// \n// =============================================\n\nexport type NormalEndingType = '' | '';\n\nexport interface NormalEndingCheckResult {\n  triggered: boolean;\n  type: NormalEndingType;\n  replaceUserMessage: string | null;\n  firstGreeting: string | null; // AI\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n *  - \n * \n * @param firstGreeting AI\n */\nfunction generateNormalEndingInitialTemplate(firstGreeting: string): string {\n  return `[ - ]\n\n\n\n\n...\n\n\"\"\n\n\n\n...\n\n\n\n\n\n...\n\n\n\n...\n\n${firstGreeting}\n\n\n\nLOOP RESET\nNORMAL END: \n\n\n\n\n...\n\n---\n`;\n}\n\n/**\n *  - \n * \n *  Day 1, 08:00\n * @param firstGreeting AI\n */\nfunction generatePureLoveEndingTemplate(firstGreeting: string): string {\n  return `[ - ]\n\n\n\n\n...\n\n\"\"\n\n\n...\n\n\n\n\n\n\n\n${firstGreeting}\n\n\n\nLOOP RESET\n\n\n\n\n\n\n\n\n---\n`;\n}\n\n/**\n *  - \n * \n */\nconst NORMAL_ENDING_LOCKED_TEMPLATES = [\n  () => `[]\n\n\n\n\n\n\n\n\n\nNORMAL END: \n\n\n\n\n---\n`,\n\n  () => `[]\n\n\n\n\n\n\n\n\n\nNORMAL END: \n\n\n\n\n---\n`,\n\n  () => `[]\n\n\"\"\n\n\n\n\n\nNORMAL END: \n\n\n\n\n---\n`,\n];\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n */\nfunction randomChoice<T>(arr: T[]): T {\n  return arr[Math.floor(Math.random() * arr.length)];\n}\n\n/**\n * AI\n *  getChatMessages API\n */\nfunction getFirstAIMessage(): string | null {\n  try {\n    // 0\n    const messages = getChatMessages(0);\n    if (messages && messages.length > 0) {\n      const firstMessage = messages[0];\n      // AIassistant\n      if (firstMessage.role === 'assistant' && firstMessage.message) {\n        console.info('[] AI');\n        return firstMessage.message;\n      }\n    }\n    console.warn('[] AI');\n    return null;\n  } catch (err) {\n    console.error('[] AI:', err);\n    return null;\n  }\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n *  checkEnding() \n *\n * @param data \n * @returns \n */\nexport function checkNormalEnding(data: SchemaType): NormalEndingCheckResult {\n  // \n  const isAlreadyInNormalEnding = isInNormalEndingLock(data);\n\n  if (isAlreadyInNormalEnding) {\n    // \n    const template = randomChoice(NORMAL_ENDING_LOCKED_TEMPLATES);\n    const replaceUserMessage = template();\n    console.info('[] ');\n\n    return {\n      triggered: true,\n      type: '',\n      replaceUserMessage,\n      firstGreeting: null,\n    };\n  }\n\n  // \n  // AI\n  const firstGreeting = getFirstAIMessage();\n  const greetingText = firstGreeting || '';\n\n  // \n  const hasEnteredDream = data..;\n  let replaceUserMessage: string;\n\n  if (hasEnteredDream) {\n    //   \n    replaceUserMessage = generateNormalEndingInitialTemplate(greetingText);\n    console.info('[]  - ');\n  } else {\n    //   \n    replaceUserMessage = generatePureLoveEndingTemplate(greetingText);\n    console.info('[]  - ');\n  }\n\n  return {\n    triggered: true,\n    type: '',\n    replaceUserMessage,\n    firstGreeting,\n  };\n}\n\n/**\n * /\n *  Day 1\n * @param data \n */\nexport function applyNormalEndingState(data: SchemaType): void {\n  // \n  const hasEnteredDream = data..;\n  const endingType = hasEnteredDream ? '' : '';\n\n  data.. = endingType;\n  // / '' ''\n  //  Day 1\n  data.. = '';\n\n  //  Day 1, 08:00\n  // \n  data.. = 1;\n  data.. = 8;\n  data.. = 'Day 1, 08:00';\n  data.. = (data.. || 1) + 1;\n  data.. = true;\n\n  // \n  updateSnapshotValue('.', 1);\n  updateSnapshotValue('.', 8);\n  updateSnapshotValue('.', 'Day 1, 08:00');\n  updateSnapshotValue('.', data..);\n  updateSnapshotValue('.', '');\n  updateSnapshotValue('.', endingType);\n\n  if (hasEnteredDream) {\n    console.info('[]  Day 1, 08:00');\n  } else {\n    console.info('[]  Day 1, 08:00');\n  }\n  console.info(`[] : ${data..}`);\n}\n\n/**\n * /\n * \n * @param data \n * @returns \n */\nexport function isInNormalEndingLock(data: SchemaType): boolean {\n  const ending = data..;\n  return (ending === '' || ending === '') && data.. === '';\n}\n\n/**\n * index.tscheckEnding\n *\n * \n * - Day 5, 00:00  Day 6 2026-01-17 20:0000:00\n * - <100\n * -  confusionEndingSystem \n * - 5\n *\n * @param data \n * @returns \n */\nexport function shouldTriggerNormalEnding(data: SchemaType): boolean {\n  //  confusionEndingSystem \n  const isBadEnding = data.. >= 100;\n\n  if (isBadEnding) {\n    return false; // \n  }\n\n  // 5\n  const completedScenes = new Set(data..);\n  const allScenesComplete =\n    completedScenes.size === 5 &&\n    completedScenes.has(1) &&\n    completedScenes.has(2) &&\n    completedScenes.has(3) &&\n    completedScenes.has(4) &&\n    completedScenes.has(5);\n\n  if (allScenesComplete) {\n    return false; // \n  }\n\n  //   \n  return true;\n}\n","/**\n *  - \n *\n * 5\n * 1.  - Day 6\n * 2.  - \n * 3.  - \n * 4.  - \n *\n * 2026-01-19 \n * - Day 5, 11:00+ 51\n * - 5\n * -  =   \n * -  =   \n *\n * 625\n * - 10:00 5\n * - 11:00-14:00 04\n * - 14:00-18:00 14\n * - 18:00-22:00 24\n * - 22:00-02:00 35\n * - 02:00-06:00 45\n * - 06:00-10:00 53\n */\n\nimport type { Schema as SchemaType } from '../../schema';\nimport { getScene5LockedCoherence } from './scene5System';\n\n// ============================================\n// \n// ============================================\n\nexport interface TrueEndingPhase {\n  phase: number;\n  name: string;\n  title: string;\n  description: string;\n  minTurns: number; // \n  maxTurns: number; // Bug #19 \n  minHour?: number; // Bug #19 \n  strict?: boolean; // Bug #19 true=\n  anchorEvents: string[]; // \n  aiGuidance: string; // AI\n  correctionHints: string[]; // \n  // Bug #15 \n  expectedActions?: string[]; // \n  hintThreshold?: number; // 2\n  progressHint?: string; // \n}\n\nexport const TRUE_ENDING_PHASES: TrueEndingPhase[] = [\n  // === 0 ===\n  // 2026-01-19 625\n  {\n    phase: 0,\n    name: '',\n    title: '',\n    description: 'Day 5, 11:00-14:00',\n    minTurns: 1,\n    maxTurns: 4,\n    minHour: 11,\n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 0\n\n5\n{{user}}\n\nDay 5, 11:0051\n\n\n- \n- \n- \n- {{user}}\n\n\n\n\"\"{{user}}\n\n\nAI\n1. \n2. {{user}}\n3. \"...\"\n4. \n5. {{user}}\n\n\n\"......\"\n\"\"\n\n\n- \n- `,\n    correctionHints: [\n      '\"...\"',\n      '{{user}}\"...\"',\n      '\"\"\"\"',\n    ],\n  },\n\n  // === 1 ===\n  {\n    phase: 1,\n    name: '',\n    title: '',\n    description: 'Day 5, 14:00-18:00',\n    minTurns: 1,\n    maxTurns: 4,\n    minHour: 14,\n    strict: true,\n    anchorEvents: ['', '', '', ''],\n    aiGuidance: ` - 1\n\n{{user}}\n\n\n- {{user}}\"\"\n- \"\"\n- \n- \n\n\n- \n- \n- {{user}}\n- \n\nAI\n1. \n2. \n3. \n4. \n5. \n\n\n- \n- \n- `,\n    correctionHints: [\n      '{{user}}\"\"',\n      '\"...\"',\n      '\"...\"',\n    ],\n  },\n\n  // === 2 ===\n  {\n    phase: 2,\n    name: '',\n    title: '',\n    description: 'Day 5, 18:00-22:00',\n    minTurns: 1,\n    maxTurns: 4,\n    minHour: 18,\n    strict: true,\n    anchorEvents: ['', '', '', ''],\n    aiGuidance: ` - 2\n\n\n\n\n- \n- \n- \n- {{user}}\n\n\n1. \n2. \n3. \n4. \n5. {{user}}\"\"\n\nAI\n1. \n2. \n3. \n4. \"\"\n5. \n\n\n- \n- `,\n    correctionHints: [\n      '\"\"{{user}}',\n      '\"......\"',\n      '{{user}}',\n    ],\n  },\n\n  // === 3 ===\n  {\n    phase: 3,\n    name: '',\n    title: '',\n    description: 'Day 5, 22:00 - Day 6, 02:00',\n    minTurns: 1,\n    maxTurns: 5,\n    minHour: 22,\n    strict: true,\n    anchorEvents: ['', '', '', '', ''],\n    aiGuidance: ` - 3\n\n\n\n\n- \n- {{user}}\n- \n- {{user}}\n- \"\"\n\n\n- \n- \n- \n- \n- \n\n\n- \"...\"\n- \"...\"\n- 161723...\n- \"...\"\n\nAI\n1. {{user}}\n2. \n3. \n4. \"\"\n5. {{user}}\n\n\n- \n- \n- `,\n    correctionHints: [\n      '\"...\"',\n      '\"......\"',\n      '\"...\"\"16\"',\n      '\"\"\"...\"',\n    ],\n    expectedActions: ['', '', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint: '...',\n  },\n\n  // === 4 ===\n  {\n    phase: 4,\n    name: '',\n    title: '',\n    description: 'Day 6, 02:00-06:00',\n    minTurns: 1,\n    maxTurns: 5,\n    minHour: 2,\n    strict: true,\n    anchorEvents: ['', '', '', '', ''],\n    aiGuidance: ` - 4\n\n\"\"\n\n\n- {{user}}\n- \n- \n- {{user}}\n\n\n- {{user}}\n- \"\"\n- \n- \n- \n\n\n- \"...\"\n- \"\"\n- \"...\"\n\nAI\n1. {{user}}\n2. \n3. \n4. \n5. \n\n\n- \n- \n- `,\n    correctionHints: [\n      '{{user}}\"......\"',\n      '\"......\"',\n      '\".........\"',\n    ],\n    expectedActions: ['', '', '', '', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint: '...\"\"',\n  },\n\n  // === 5 ===\n  {\n    phase: 5,\n    name: '',\n    title: '',\n    description: 'Day 6, 06:00-10:00',\n    minTurns: 1,\n    maxTurns: 3,\n    minHour: 6,\n    strict: true,\n    anchorEvents: ['', '', '', ''],\n    aiGuidance: ` - 5\n\n\n\n\n- \n- {{user}}\n- \n- \n\n\n- \n- \n- \n- {{user}}\n- \"\"\n- \"...\"\n\n\n\n\n\"\"\n\nAI\n1. \n2. {{user}}\n3. \n4. {{user}}\n5. \n\n\n\n- \n- \n- \n\n\n- \n- \n- `,\n    correctionHints: [\n      '{{user}}',\n      '',\n      '\"...\"{{user}}\"\"',\n    ],\n    expectedActions: ['', '', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint: '\"...\"',\n  },\n];\n\n// ============================================\n// \n// ============================================\n\nexport interface TrueEndingState {\n  isActive: boolean; // \n  currentPhase: number; //  (0-5)\n  turnsInPhase: number; // \n  completedAnchors: string[]; // \n  totalTurns: number; // \n  isComplete: boolean; // \n  // Bug #15 \n  noProgressTurns: number; // \n  hintGiven: boolean; // \n}\n\n/**\n * \n */\nexport function getDefaultTrueEndingState(): TrueEndingState {\n  return {\n    isActive: false,\n    currentPhase: 0,\n    turnsInPhase: 0,\n    completedAnchors: [],\n    totalTurns: 0,\n    isComplete: false,\n    noProgressTurns: 0,\n    hintGiven: false,\n  };\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * 2026-01-17  11:00 51\n *\n * \"\"\n * 21:00, 23:00 isFreeTimeHour() \n */\nexport function shouldActivateTrueEnding(data: SchemaType): boolean {\n  // 1Day 5, 11:00+51\n  // 2026-01-17  20:00  11:00\n  const day = data..;\n  const hour = data..;\n  if (day < 5 || (day === 5 && hour < 11)) {\n    return false;\n  }\n\n  // 2\n  // 2026-01-17 \"\"11:00\n  const validStates = ['', '', ''];\n  if (!validStates.includes(data..)) {\n    return false;\n  }\n\n  // 3\n  // \n  const currentEnding = data..;\n  if (currentEnding && currentEnding !== '' && currentEnding !== '') {\n    return false;\n  }\n\n  // 45\n  const completedScenes = data..;\n  const correctScenes = data..;\n\n  const allCompleted = [1, 2, 3, 4, 5].every(s => completedScenes.includes(s));\n  const allCorrect = [1, 2, 3, 4, 5].every(s => correctScenes.includes(s));\n\n  return allCompleted && allCorrect;\n}\n\n/**\n * 21:00  23:00\n * 2026-01-17 \n *\n * \n * - 21:00 \n * - 22:00 \n * - 23:00 \n * - 00:00 \n */\nexport function isFreeTimeHour(data: SchemaType): boolean {\n  const day = data..;\n  const hour = data..;\n\n  //  Day 5  21:00  23:00 \n  if (day === 5 && (hour === 21 || hour === 23)) {\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * 00:00\n * 2026-01-17 00:00 \n *\n * 5-9\n */\nexport function isRoomTriggerTime(data: SchemaType): boolean {\n  const day = data..;\n  const hour = data..;\n\n  // Day 5  00:00 Day 6  Day 6 \n  // 500:00\n  return (day === 5 && hour === 0) || day > 5;\n}\n\n/**\n * \n * 2026-01-17 \n */\nexport function getGuidanceType(data: SchemaType): 'preheat' | 'dinner' | 'free' | 'correction' | 'room' | null {\n  const day = data..;\n  const hour = data..;\n\n  // Day 6+  'room' \n  if (day > 5) {\n    return 'room';\n  }\n\n  if (day !== 5) return null;\n\n  // 11:00-19:00 \n  if (hour >= 11 && hour < 20) {\n    return 'preheat';\n  }\n\n  // 20:00 \n  if (hour === 20) {\n    return 'dinner';\n  }\n\n  // 21:00 \n  if (hour === 21) {\n    return 'free';\n  }\n\n  // 22:00 \n  if (hour === 22) {\n    return 'correction';\n  }\n\n  // 23:00 \n  if (hour === 23) {\n    return 'free';\n  }\n\n  // 00:00+ \n  if (hour === 0 || hour >= 24) {\n    return 'room';\n  }\n\n  return null;\n}\n\n/**\n * \n *  + =3\n */\nexport function isPerfectTrueEnding(data: SchemaType): boolean {\n  // 5\n  const coherence = getScene5LockedCoherence(data);\n  return coherence === 3;\n}\n\n/**\n * Schema\n */\nexport function isTrueEndingActive(data: SchemaType): boolean {\n  const endingState = (data as any). as TrueEndingState | undefined;\n  return endingState?.isActive === true;\n}\n\n/**\n * \n */\nexport function getTrueEndingState(data: SchemaType): TrueEndingState {\n  const endingState = (data as any). as TrueEndingState | undefined;\n  return endingState ?? getDefaultTrueEndingState();\n}\n\n/**\n * \n */\nexport function updateTrueEndingState(data: SchemaType, state: TrueEndingState): void {\n  (data as any). = state;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * 2026-01-19 6\n */\nconst ANCHOR_KEYWORDS: Record<string, string[]> = {\n  // 0\n  : ['', '', '.*', '', ''],\n  : ['', '', '', '.*'],\n  : ['', '', '', '', '', ''],\n\n  // 1\n  : ['', '', '', '', '', '', ''],\n  : ['', '', '', '', '.*'],\n  : ['', '', '', '', '', ''],\n  : ['', '', '.*', ''],\n\n  // 2\n  : ['', '', '', '', ''],\n  : ['', '', '', '.*', '.*'],\n  : ['', '', '', '', '', '.*'],\n  : ['', '', '.*', ''],\n\n  // 3\n  : ['', '', '', '', ''],\n  : ['', '', '', '', ''],\n  : ['', '', '.*', '', '', ''],\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '.*', '.*'],\n\n  // 4\n  : ['', '', '.*', '', ''],\n  : ['', '', '', '', ''],\n  : ['', '', '', '.*', '.*'],\n  : ['', '', '', '', ''],\n  : ['', '', '', '', ''],\n\n  // 5\n  : ['', '', '', '', ''],\n  : ['', '', '', '.*'],\n  : ['', '', '', '.*'],\n  : ['', '', '.*', '', ''],\n};\n\n/**\n * AI\n */\nexport function detectCompletedAnchors(aiResponse: string, phase: number): string[] {\n  const phaseConfig = TRUE_ENDING_PHASES[phase];\n  if (!phaseConfig) return [];\n\n  const completed: string[] = [];\n\n  for (const anchor of phaseConfig.anchorEvents) {\n    const keywords = ANCHOR_KEYWORDS[anchor] || [];\n    const isCompleted = keywords.some(kw => {\n      // \n      if (kw.includes('.*')) {\n        const regex = new RegExp(kw, 'i');\n        return regex.test(aiResponse);\n      }\n      return aiResponse.includes(kw);\n    });\n\n    if (isCompleted) {\n      completed.push(anchor);\n    }\n  }\n\n  return completed;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * Bug #19  maxTurns \n * Bug #40 maxTurns \n */\nexport function shouldAdvancePhase(state: TrueEndingState, currentHour?: number): boolean {\n  const phaseConfig = TRUE_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig) return false;\n\n  // Bug #40 \n  //  maxTurns \n  if (currentHour !== undefined) {\n    const canEnter = canEnterNextPhase(state, currentHour);\n    if (canEnter.blocked) {\n      // \n      return false;\n    }\n  }\n\n  // Bug #19 \n  if (phaseConfig.maxTurns && state.turnsInPhase >= phaseConfig.maxTurns) {\n    console.info(\n      `[] ${state.currentPhase}(${phaseConfig.name}) ${phaseConfig.maxTurns}`,\n    );\n    return true;\n  }\n\n  // \n  if (state.turnsInPhase < phaseConfig.minTurns) {\n    return false;\n  }\n\n  // \n  const allAnchorsComplete = phaseConfig.anchorEvents.every(anchor => state.completedAnchors.includes(anchor));\n\n  return allAnchorsComplete;\n}\n\n/**\n * Bug #19 \n * @returns null \n */\nexport function canEnterNextPhase(\n  state: TrueEndingState,\n  currentHour: number,\n): { blocked: boolean; reason?: string; waitHours?: number } {\n  const nextPhase = state.currentPhase + 1;\n  if (nextPhase >= TRUE_ENDING_PHASES.length) {\n    return { blocked: false }; // \n  }\n\n  const nextConfig = TRUE_ENDING_PHASES[nextPhase];\n  if (!nextConfig) return { blocked: false };\n\n  // \n  if (nextConfig.strict && nextConfig.minHour !== undefined) {\n    // minHour=0 \n    if (nextConfig.minHour === 0) {\n      //  0-6 \n      if (currentHour > 6) {\n        return {\n          blocked: true,\n          reason: `\"${nextConfig.name}\"`,\n          waitHours: 24 - currentHour,\n        };\n      }\n    } else if (currentHour < nextConfig.minHour) {\n      return {\n        blocked: true,\n        reason: `${nextConfig.minHour}:00\"${nextConfig.name}\"`,\n        waitHours: nextConfig.minHour - currentHour,\n      };\n    }\n  }\n\n  return { blocked: false };\n}\n\n/**\n * \n */\nexport function advanceToNextPhase(state: TrueEndingState): TrueEndingState {\n  const nextPhase = state.currentPhase + 1;\n\n  // \n  if (nextPhase >= TRUE_ENDING_PHASES.length) {\n    return {\n      ...state,\n      isComplete: true,\n    };\n  }\n\n  return {\n    ...state,\n    currentPhase: nextPhase,\n    turnsInPhase: 0,\n    completedAnchors: [], // \n    noProgressTurns: 0, // Bug #15 \n    hintGiven: false, // Bug #15 \n  };\n}\n\n// ============================================\n// Bug #15 \n// ============================================\n\n/**\n * \n */\nexport function hasExpectedAction(userInput: string, phase: number): boolean {\n  const phaseConfig = TRUE_ENDING_PHASES[phase];\n  if (!phaseConfig || !phaseConfig.expectedActions) {\n    return true; // \n  }\n\n  const input = userInput.toLowerCase();\n  return phaseConfig.expectedActions.some(action => input.includes(action.toLowerCase()));\n}\n\n/**\n * \n */\nexport function checkProgressHint(state: TrueEndingState, userInput: string): string | null {\n  const phaseConfig = TRUE_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig || !phaseConfig.progressHint) {\n    return null;\n  }\n\n  // \n  if (state.hintGiven) {\n    return null;\n  }\n\n  // \n  if (hasExpectedAction(userInput, state.currentPhase)) {\n    return null;\n  }\n\n  // \n  const threshold = phaseConfig.hintThreshold ?? 2;\n  if (state.noProgressTurns >= threshold) {\n    return phaseConfig.progressHint;\n  }\n\n  return null;\n}\n\n/**\n * \n */\nexport function updateProgressTracking(\n  state: TrueEndingState,\n  userInput: string,\n): { updatedState: TrueEndingState; hint: string | null } {\n  const hasProgress = hasExpectedAction(userInput, state.currentPhase);\n\n  // \n  const hint = checkProgressHint(state, userInput);\n\n  let updatedState = { ...state };\n\n  if (hasProgress) {\n    // \n    updatedState.noProgressTurns = 0;\n  } else {\n    // \n    updatedState.noProgressTurns = state.noProgressTurns + 1;\n  }\n\n  // \n  if (hint) {\n    updatedState.hintGiven = true;\n  }\n\n  return { updatedState, hint };\n}\n\n/**\n * \n * Bug #19  currentHour \n */\nexport function processTurnEnd(\n  state: TrueEndingState,\n  aiResponse: string,\n  userInput?: string,\n  currentHour?: number, // Bug #19\n): {\n  newState: TrueEndingState;\n  phaseAdvanced: boolean;\n  newPhase: number | null;\n  timeBlocked?: { reason: string; waitHours: number }; // Bug #19\n} {\n  // \n  let newState: TrueEndingState = {\n    ...state,\n    turnsInPhase: state.turnsInPhase + 1,\n    totalTurns: state.totalTurns + 1,\n  };\n\n  // \n  const newAnchors = detectCompletedAnchors(aiResponse, state.currentPhase);\n  const allAnchors = [...new Set([...newState.completedAnchors, ...newAnchors])];\n  newState.completedAnchors = allAnchors;\n\n  // Bug #15 \n  if (userInput) {\n    const { updatedState } = updateProgressTracking(newState, userInput);\n    newState = updatedState;\n  }\n\n  // \n  let phaseAdvanced = false;\n  let newPhase: number | null = null;\n\n  if (shouldAdvancePhase(newState, currentHour)) {\n    // Bug #19 \n    const hour = currentHour ?? 12; // \n    const canEnter = canEnterNextPhase(newState, hour);\n\n    if (canEnter.blocked) {\n      // \n      console.info(`[] ${newState.currentPhase} ${canEnter.reason}`);\n      return {\n        newState,\n        phaseAdvanced: false,\n        newPhase: null,\n        timeBlocked: { reason: canEnter.reason!, waitHours: canEnter.waitHours! },\n      };\n    }\n\n    newState = advanceToNextPhase(newState);\n    phaseAdvanced = true;\n    newPhase = newState.currentPhase;\n  }\n\n  return { newState, phaseAdvanced, newPhase };\n}\n\n// ============================================\n// AI Prompt \n// ============================================\n\n/**\n * AIPrompt\n * Bug #19  currentHour \n */\nexport function generateTrueEndingPrompt(\n  state: TrueEndingState,\n  userInput: string,\n  currentHour?: number, // Bug #19\n): string {\n  const phaseConfig = TRUE_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig) return '';\n\n  // \n  const remainingAnchors = phaseConfig.anchorEvents.filter(a => !state.completedAnchors.includes(a));\n\n  // Bug #40 \n  const hour = currentHour ?? 12;\n  const nextPhaseCheck = canEnterNextPhase(state, hour);\n  const isTimeLocked = nextPhaseCheck.blocked;\n\n  // Bug #40 \"\"\n  let turnsWarning: string;\n  if (isTimeLocked) {\n    // \"X\"\n    turnsWarning = `${TRUE_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00`;\n  } else {\n    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;\n    turnsWarning =\n      remainingTurns <= 2 ? ` ${remainingTurns}` : `${remainingTurns}`;\n  }\n\n  // Bug #40 \n  const timeBlockWarning = isTimeLocked\n    ? `\\n \"${TRUE_ENDING_PHASES[state.currentPhase + 1]?.name}\"${TRUE_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00${hour}:00\n `\n    : '';\n\n  // \n  const progressInfo = `\n- ${state.currentPhase + 1}/${TRUE_ENDING_PHASES.length}${phaseConfig.name}\n- ${state.turnsInPhase}${turnsWarning}\n- ${remainingAnchors.length > 0 ? remainingAnchors.join('') : ''}\n- ${state.totalTurns}${timeBlockWarning}`;\n\n  // Bug #15 \n  const hint = checkProgressHint(state, userInput);\n  const hintSection = hint\n    ? `\\n\\n\n\n${hint}`\n    : '';\n\n  // Bug #19 \n  // Bug #40 \n  let urgencyHint = '';\n  if (!isTimeLocked) {\n    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;\n    if (remainingTurns <= 1) {\n      urgencyHint = `\\n\\n`;\n    }\n  }\n\n  // Prompt\n  return `${phaseConfig.aiGuidance}\n\n${progressInfo}${hintSection}${urgencyHint}\n\n\n- \n- \n- \n- \n- \n- `;\n}\n\n/**\n * \n */\nexport function getCorrectionHint(phase: number): string | null {\n  const phaseConfig = TRUE_ENDING_PHASES[phase];\n  if (!phaseConfig || phaseConfig.correctionHints.length === 0) {\n    return null;\n  }\n\n  // \n  const index = Math.floor(Math.random() * phaseConfig.correctionHints.length);\n  return phaseConfig.correctionHints[index];\n}\n\n/**\n * \n * 2026-01-19 625\n */\nexport function generateTrueEndingEntryReplacement(data?: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  // \n  const isPerfect = data ? isPerfectTrueEnding(data) : false;\n  const endingTitle = isPerfect ? '' : '';\n\n  const perfectMemoryNote = isPerfect\n    ? `\n\n\n51-2-3\n\"\"\n- 16\n- 17\n- 20\n- \n\nAI\n\"\"\"\"\n\n\"\"\"\"`\n    : '';\n\n  const userMessage = `[ - ${endingTitle}]\n\n Day 5, 11:00\n5\n${endingTitle}\n\n\n5\n- 116- \n- 217- \n- 323- \n- 428- \n- 5- \n\n.X.\n\nDay 1-4 \n Day 1  Day 4 \n\n${perfectMemoryNote}\n\n{{user}}\n\n\n\n{{user}}\n\n\n625\n- 11:00-14:00 04- \n- 14:00-18:00 14- \n- 18:00-22:00 24- \n- 22:00-02:00 35- \n- 02:00-06:00 45- \n- 06:00-10:00 53- \n\nAI\n1. \n2. {{user}}\n3. \"...\"\n4. \n5. {{user}}`;\n\n  // 2026-01-19 prefill \n  const prefill = isPerfect\n    ? `\n\n...\n\n\n\n\n\n\n{{user}}\n\n\"\"\"...\"`\n    : `\n\n...\n\n\n\"\"\n\n\n\n{{user}}\n\n\"...\"\"...\"`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * \n */\nexport function generatePhaseTransitionHint(fromPhase: number, toPhase: number): string {\n  const toConfig = TRUE_ENDING_PHASES[toPhase];\n  if (!toConfig) return '';\n\n  return `\\n\\n---\\n${toConfig.name}${toConfig.title}\\n---\\n`;\n}\n\n/**\n * \n * 2026-01-16 \n */\nexport function generateTrueEndingComplete(data?: SchemaType): string {\n  // \n  const isPerfect = data ? isPerfectTrueEnding(data) : false;\n\n  if (isPerfect) {\n    return `\n\n\n\nPERFECT TRUE END\n\n\n\n\n16\n17\n20\n25\n\n\n\n\n\n\n\n\"\"\n\"...\"\n\"\"\n\n\n\n\n\n\n\n\n\n \n \n\n`;\n  }\n\n  return `\n\n\n\nTRUE END\n\n\n\n\n16\n17\n23\n28\n...\n\n\n\n\n\"\"\n\n\n\n\n...\n\n\n\n\n\n \n\n`;\n}\n\n// ============================================\n// 2026-01-17 \n// ============================================\n\n/**\n * 21:00  23:00\n * \n */\nexport function generateFreeTimePrompt(hour: number): string {\n  const nextHour = hour + 1;\n  const nextEvent = hour === 21 ? '22:00' : '00:00';\n\n  return ` - ${hour}:00\n\n${nextEvent}\n\n\n- \n- \n- {{user}}\n\nAI\n1. \n2. \n3. {{user}}\n4. \n5. \n\n\n\n- \n- \n- \"\"\n- \n\n${nextHour}:00`;\n}\n\n/**\n * 22:00\n */\nexport function generateCorrectionPrompt(state: TrueEndingState): string {\n  const currentPhase = TRUE_ENDING_PHASES[state.currentPhase];\n  const phaseName = currentPhase?.name ?? '';\n\n  return `22:00 - \n\n\n\n\n- ${state.currentPhase + 1}/${TRUE_ENDING_PHASES.length}${phaseName}\n- ${state.totalTurns}\n\nAI\n1. \n2. \"\"\n3. \n4. \n\n\n00:00\n...`;\n}\n\n/**\n * 00:00\n * 3\n * 2026-01-19 6\n */\nexport function generateRoomTriggerPrompt(state: TrueEndingState, isPerfect: boolean): string {\n  // 3\n  if (state.currentPhase >= 3) {\n    return '';\n  }\n\n  const endingTitle = isPerfect ? '' : '';\n\n  return ` 00:00 - ${endingTitle}\n\n\n\n\n\n{{user}}\"\"\n\n\n\n- 3\n- 4\n- 5\n\nAI\n1. {{user}}\n2. \n3. \n4. 3\n\n\n\n`;\n}\n\n/**\n * Prompt\n * 2026-01-17 \n */\nexport function generateTimeBasedPrompt(data: SchemaType, state: TrueEndingState, userInput: string): string | null {\n  const guidanceType = getGuidanceType(data);\n\n  if (!guidanceType) {\n    return null;\n  }\n\n  switch (guidanceType) {\n    case 'preheat':\n    case 'dinner':\n      // \n      return generateTrueEndingPrompt(state, userInput);\n\n    case 'free': {\n      // \n      const hour = data..;\n      return generateFreeTimePrompt(hour);\n    }\n\n    case 'correction':\n      // 22:00 \n      return generateCorrectionPrompt(state);\n\n    case 'room': {\n      // 00:00 \n      const isPerfect = isPerfectTrueEnding(data);\n      const roomPrompt = generateRoomTriggerPrompt(state, isPerfect);\n      if (roomPrompt) {\n        return roomPrompt;\n      }\n      // 5+\n      return generateTrueEndingPrompt(state, userInput);\n    }\n\n    default:\n      return null;\n  }\n}\n","/**\n *  - \n *\n * 2026-01-17 \n * - 11:00 \n * - 20:00 \n * - 21:00/23:00 \n * - 00:00\n *\n * \n * - Day 5, 11:00+/ 20:00+\n * - 5\n * -  < 5\n * -  =   \n * -  = \n *\n * \n * - \n * - \n * - \n * - \n *\n * 2026-01-17\n * - \n * - AI\n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n// ============================================\n// \n// ============================================\n\nexport interface FalseEndingPhase {\n  phase: number;\n  name: string;\n  title: string;\n  description: string;\n  minTurns: number;\n  maxTurns: number; // Bug #19\n  minHour?: number; // Bug #19\n  strict?: boolean; // Bug #19true=minHour\n  anchorEvents: string[];\n  aiGuidance: string;\n  correctionHints: string[];\n  // Bug #15 \n  expectedActions?: string[]; // \n  hintThreshold?: number; // 2\n  progressHint?: string; // \n}\n\nexport const FALSE_ENDING_PHASES: FalseEndingPhase[] = [\n  // === 0 ===\n  // 2026-01-17 11:00\n  {\n    phase: 0,\n    name: '',\n    title: '',\n    description: '11:00',\n    minTurns: 1,\n    maxTurns: 2, // 2026-01-19: \n    minHour: 11, // 11:00\n    anchorEvents: ['', ''],\n    aiGuidance: ` - 0\n\n\n\n\nDay 5, 11:00\n\n\n- \n- \n- \n- \n\n\n\"\"\n...\n{{user}}\n\n\"\"{{user}}\n\nAI\n1. \n2. \"\"\n3. {{user}}\n4. \n5. \n\n\n- \n- `,\n    correctionHints: [\n      '...{{user}}',\n      '\"...\"',\n      '{{user}}',\n    ],\n  },\n\n  // === 1 ===\n  // 2026-01-19 14:00 \n  {\n    phase: 1,\n    name: '',\n    title: '',\n    description: '14:00{{user}}',\n    minTurns: 1,\n    maxTurns: 2,\n    minHour: 14, // 2026-01-19: 14:00\n    strict: true,\n    anchorEvents: ['', ''],\n    aiGuidance: ` - 1\n\n\n\nDay 5, 14:00\n\n\n- \n- {{user}}\n- \n- \n\n\n...\n\n\"\"\n\"\"\n\nAI\n1. {{user}}\n2. \n3. {{user}}\n4. \"...\"\n5. \n\n\n- \n- \"\"\n- `,\n    correctionHints: [\n      '\"\"{{user}}',\n      '\"...\"{{user}}',\n      '{{user}}',\n    ],\n  },\n\n  // === 2 ===\n  // 2026-01-19 17:00 \n  {\n    phase: 2,\n    name: '',\n    title: '',\n    description: '17:00',\n    minTurns: 1,\n    maxTurns: 2,\n    minHour: 17, // 2026-01-19: 17:00\n    strict: true,\n    anchorEvents: ['', ''],\n    aiGuidance: ` - 2\n\n\n\n\nDay 5, 17:00\n\n\n- \n- \n- ...\n- \n\n\n...\n\n{{user}}\n\"......\"\n\n\nAI\n1. \n2. \n3. \n4. {{user}}\n5. ...\n\n\n- \n- `,\n    correctionHints: [\n      '\"\"\"...\"',\n      '',\n      '\"...\"{{user}}',\n    ],\n  },\n\n  // === 3 ===\n  // 2026-01-1720:00 \n  {\n    phase: 3,\n    name: '',\n    title: '',\n    description: '20:00/',\n    minTurns: 1,\n    maxTurns: 2, // 2026-01-19: \n    minHour: 20, // Bug #19: 20:00\n    strict: true, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 1\n\n\n\n\nDay 5, 20:00\n\n\n- \n- \n- {{user}}\n- \n\n\n...\n\"\"\n{{user}}\n\n\nAI\n1. \n2. \n3. /\n4. {{user}}\n5. \n6. ...\n\n\n\"\"\n\n\n\n- \n- `,\n    correctionHints: [\n      '{{user}}',\n      '\"\"{{user}}',\n      '',\n    ],\n  },\n\n  // === 4 ===\n  {\n    phase: 4,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 3, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 2\n\n{{user}}\n\n\n\n- \n- /\n- \n- \n\n\n...\n\n...\n{{user}}\n\nAI\n1. \n2. \n3. \n4. \"......\"\n5. {{user}}\n\n\n- \n- `,\n    correctionHints: [\n      '{{user}}',\n      '\"...\"{{user}}',\n      '\"...\"',\n    ],\n  },\n\n  // === 5 ===\n  {\n    phase: 5,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 3, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 3\n\n\n\n\n\n- \n- \n- \"\"\n- \n\n\n\n......\n{{user}}\n\"......\"\n{{user}}\n\n\nAI\n1. \n2. \n3. \n4. \n5. \n\n\n- \n- \n- \"......\"{{user}}\n- \n\n\n\n4`,\n    correctionHints: [\n      '...',\n      '\"...\"{{user}}',\n      '{{user}}',\n    ],\n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint: '...',\n  },\n\n  // === 6 ===\n  // 2026-01-17 \n  {\n    phase: 6,\n    name: '',\n    title: '',\n    description: '{{user}}',\n    minTurns: 1,\n    maxTurns: 3, // Bug #19: \n    anchorEvents: ['', '', '', ''],\n    aiGuidance: ` - 4\n\n\n\n{{user}}\n\n\n- /\n- \n- {{user}}\n- \n- \n\n\n...\n\n\n{{user}}\n\n\n\n\nAI\n1. \n2. {{user}}\n3. \n4. {{user}}\n5. \n6. \n7. \n\n\n- \"\"\n- \".........\"{{user}}\n- \"\"\n- \".........\"\n- {{user}}\n\n\n- \n- {{user}}\n- \"...\"\n- \n\n\n- \n- \n- `,\n    correctionHints: [\n      '{{user}}{{user}}',\n      '\"......\"{{user}}',\n      '\"\"{{user}}\"......\"',\n    ],\n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint:\n      '...',\n  },\n\n  // === 7 ===\n  {\n    phase: 7,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 3, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 5\n\n{{user}}\n\n\n- /\n- \n- \n- \n\n\n...\n\n\"\"\n\"......\"\n\n\nAI\n1. \n2. \n3. \"\"\n4. \"...\"\n5. \n\n\n- \n- \"\"\n- \"\"{{user}}`,\n    correctionHints: [\n      '{{user}}',\n      '\"...\"',\n      '',\n    ],\n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint:\n      '...\"\"',\n  },\n\n  // === 8 ===\n  // 2026-01-17 \n  {\n    phase: 8,\n    name: '',\n    title: '',\n    description: 'AI',\n    minTurns: 1,\n    maxTurns: 3, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 6\n\n\n\n\n\n- \n- \n- \"\"\n- \n\n\n...\n\"\"\n\n...\n\n\nAI\n1. \n2. \"\"\n3. \n4. \"...\"\n5. \"...AI\"\n6. \n\n\n\"...\"\n\"...AI\"\n\"...\"\n\n\n- \n- \n- \n- ...`,\n    correctionHints: [\n      '...',\n      '\"\"\"AI...\"',\n      '',\n    ],\n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint: '...',\n  },\n\n  // === 9 ===\n  {\n    phase: 9,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 3, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 7\n\n\n\n\n- \n- \n- \n- \"\"\n\n\n...\n...\n\n\"\"\n{{user}}\n\nAI\n1. \n2. \n3. \"...\"\n4. \n5. {{user}}...\n\n\n\n{{user}}\n...`,\n    correctionHints: [\n      '{{user}}',\n      '\"......\"',\n      '\"\"',\n    ],\n  },\n];\n\n// ============================================\n// \n// ============================================\n\nconst ANCHOR_KEYWORDS: Record<string, (string | RegExp)[]> = {\n  // 0 11:00\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '', ''],\n\n  // 1 14:00\n  : ['', '', '', '', '', '', ''],\n  : ['', '', '', '', '', ''],\n\n  // 2 17:00\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '', '', '', ''],\n\n  // 3 20:00\n  : ['', '', '', /.*/],\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '', /.*/, ''],\n\n  // 4\n  : ['', '', '', ''],\n  : ['', '', '', '.*', ''],\n  : ['', '', '', ''],\n\n  // 5 - \n  : ['', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', '', ''],\n\n  // 6\n  : ['', '', '', '', ''],\n  : ['', '', '', ''],\n  : ['', '', '', ''],\n  : ['', '', '', '', '', ''],\n\n  // 7\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '', '', '', ''],\n\n  // 8\n  : ['', '', '', '', ''],\n  : ['', '', '', '', ''],\n  : ['AI', '', '', '', ''],\n\n  // 9\n  : ['', '', '', '', ''],\n  : ['', '', '', '', ''],\n  : ['', '', '', '', /.*/],\n};\n\n// ============================================\n// \n// ============================================\n\nexport interface FalseEndingState {\n  isActive: boolean;\n  isComplete: boolean;\n  currentPhase: number;\n  turnsInPhase: number;\n  totalTurns: number;\n  completedAnchors: string[];\n  // Bug #15 \n  noProgressTurns: number; // \n  hintGiven: boolean; // \n}\n\n// ============================================\n// \n// ============================================\n\nexport function getDefaultFalseEndingState(): FalseEndingState {\n  return {\n    isActive: false,\n    isComplete: false,\n    currentPhase: 0,\n    turnsInPhase: 0,\n    totalTurns: 0,\n    completedAnchors: [],\n    noProgressTurns: 0,\n    hintGiven: false,\n  };\n}\n\n/**\n * \n * 2026-01-17 11:00\n */\nexport function shouldActivateFalseEnding(data: SchemaType): boolean {\n  // 1. Day 5, 11:00 \n  if (data.. < 5) return false;\n  if (data.. === 5 && data.. < 11) return false;\n\n  // 2. \n  const validStates = ['', '', ''];\n  if (!validStates.includes(data..)) {\n    return false;\n  }\n\n  // 3. \n  if (data.. !== '') return false;\n\n  // 4. \n  if (data.?.isActive) return false;\n\n  return true;\n}\n\n/**\n * \n */\nexport function isFalseEndingActive(data: SchemaType): boolean {\n  return data.?.isActive === true;\n}\n\n/**\n * \n */\nexport function getFalseEndingState(data: SchemaType): FalseEndingState {\n  return data. ?? getDefaultFalseEndingState();\n}\n\n/**\n * \n */\nexport function updateFalseEndingState(data: SchemaType, state: FalseEndingState): void {\n  (data as any). = state;\n}\n\n/**\n * 21:00  23:00\n * 2026-01-17 \n */\nexport function isFalseEndingFreeTime(data: SchemaType): boolean {\n  const day = data..;\n  const hour = data..;\n\n  //  Day 5  21:00  23:00 \n  if (day === 5 && (hour === 21 || hour === 23)) {\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * \n * 2026-01-17 \n */\nexport function getFalseEndingGuidanceType(data: SchemaType): 'preheat' | 'dinner' | 'free' | 'main' | null {\n  const day = data..;\n  const hour = data..;\n\n  // Day 6+  'main' \n  if (day > 5) {\n    return 'main';\n  }\n\n  if (day !== 5) return null;\n\n  // 11:00-19:00 \n  if (hour >= 11 && hour < 20) {\n    return 'preheat';\n  }\n\n  // 20:00 \n  if (hour === 20) {\n    return 'dinner';\n  }\n\n  // 21:00, 23:00 \n  if (hour === 21 || hour === 23) {\n    return 'free';\n  }\n\n  // 22:00, 00:00+ \n  return 'main';\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * AI\n */\nexport function detectCompletedAnchors(aiResponse: string, phase: number): string[] {\n  if (phase >= FALSE_ENDING_PHASES.length) return [];\n\n  const phaseConfig = FALSE_ENDING_PHASES[phase];\n  const completed: string[] = [];\n\n  for (const anchor of phaseConfig.anchorEvents) {\n    const keywords = ANCHOR_KEYWORDS[anchor];\n    if (!keywords) continue;\n\n    for (const kw of keywords) {\n      if (typeof kw === 'string') {\n        if (aiResponse.includes(kw)) {\n          completed.push(anchor);\n          break;\n        }\n      } else {\n        if (kw.test(aiResponse)) {\n          completed.push(anchor);\n          break;\n        }\n      }\n    }\n  }\n\n  return [...new Set(completed)];\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * Bug #19: \n * @param state \n * @param currentHour \n * @returns \n */\nexport function canEnterNextFalsePhase(\n  state: FalseEndingState,\n  currentHour: number,\n): { blocked: boolean; reason?: string; waitHours?: number } {\n  const nextPhase = state.currentPhase + 1;\n  if (nextPhase >= FALSE_ENDING_PHASES.length) {\n    return { blocked: false };\n  }\n\n  const nextConfig = FALSE_ENDING_PHASES[nextPhase];\n  if (!nextConfig) return { blocked: false };\n\n  // \n  if (nextConfig.minHour !== undefined && nextConfig.strict) {\n    if (currentHour < nextConfig.minHour) {\n      const waitHours = nextConfig.minHour - currentHour;\n      return {\n        blocked: true,\n        reason: `${nextConfig.name} ${nextConfig.minHour}:00 `,\n        waitHours,\n      };\n    }\n  }\n\n  return { blocked: false };\n}\n\n/**\n * \n * Bug #19:  maxTurns \n * Bug #40 maxTurns \n */\nexport function shouldAdvancePhase(state: FalseEndingState, currentHour?: number): boolean {\n  if (state.currentPhase >= FALSE_ENDING_PHASES.length) return false;\n\n  const phaseConfig = FALSE_ENDING_PHASES[state.currentPhase];\n\n  // Bug #40 \n  //  maxTurns \n  if (currentHour !== undefined) {\n    const canEnter = canEnterNextFalsePhase(state, currentHour);\n    if (canEnter.blocked) {\n      // \n      return false;\n    }\n  }\n\n  // Bug #19: \n  if (phaseConfig.maxTurns && state.turnsInPhase >= phaseConfig.maxTurns) {\n    console.info(\n      `[] ${state.currentPhase}(${phaseConfig.name}) ${phaseConfig.maxTurns}`,\n    );\n    return true;\n  }\n\n  // 1\n  if (state.turnsInPhase < phaseConfig.minTurns) return false;\n\n  // 2\n  const allAnchorsComplete = phaseConfig.anchorEvents.every(anchor => state.completedAnchors.includes(anchor));\n\n  return allAnchorsComplete;\n}\n\n/**\n * \n */\nexport function advanceToNextPhase(state: FalseEndingState): FalseEndingState {\n  const nextPhase = state.currentPhase + 1;\n\n  // \n  if (nextPhase >= FALSE_ENDING_PHASES.length) {\n    return {\n      ...state,\n      currentPhase: nextPhase,\n      turnsInPhase: 0,\n      completedAnchors: [],\n      isComplete: true,\n      noProgressTurns: 0, // Bug #15 \n      hintGiven: false, // Bug #15 \n    };\n  }\n\n  return {\n    ...state,\n    currentPhase: nextPhase,\n    turnsInPhase: 0,\n    completedAnchors: [],\n    noProgressTurns: 0, // Bug #15 \n    hintGiven: false, // Bug #15 \n  };\n}\n\n// ============================================\n// Bug #15 \n// ============================================\n\n/**\n * \n */\nexport function hasExpectedAction(userInput: string, phase: number): boolean {\n  const phaseConfig = FALSE_ENDING_PHASES[phase];\n  if (!phaseConfig || !phaseConfig.expectedActions) {\n    return true; // \n  }\n\n  const input = userInput.toLowerCase();\n  return phaseConfig.expectedActions.some(action => input.includes(action.toLowerCase()));\n}\n\n/**\n * \n */\nexport function checkProgressHint(state: FalseEndingState, userInput: string): string | null {\n  const phaseConfig = FALSE_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig || !phaseConfig.progressHint) {\n    return null;\n  }\n\n  // \n  if (state.hintGiven) {\n    return null;\n  }\n\n  // \n  if (hasExpectedAction(userInput, state.currentPhase)) {\n    return null;\n  }\n\n  // \n  const threshold = phaseConfig.hintThreshold ?? 2;\n  if (state.noProgressTurns >= threshold) {\n    return phaseConfig.progressHint;\n  }\n\n  return null;\n}\n\n/**\n * \n */\nexport function updateProgressTracking(\n  state: FalseEndingState,\n  userInput: string,\n): { updatedState: FalseEndingState; hint: string | null } {\n  const hasProgress = hasExpectedAction(userInput, state.currentPhase);\n\n  // \n  const hint = checkProgressHint(state, userInput);\n\n  let updatedState = { ...state };\n\n  if (hasProgress) {\n    // \n    updatedState.noProgressTurns = 0;\n  } else {\n    // \n    updatedState.noProgressTurns = state.noProgressTurns + 1;\n  }\n\n  // \n  if (hint) {\n    updatedState.hintGiven = true;\n  }\n\n  return { updatedState, hint };\n}\n\n/**\n * \n * Bug #19: \n */\nexport function processTurnEnd(\n  state: FalseEndingState,\n  aiResponse: string,\n  userInput?: string,\n  currentHour?: number,\n): {\n  newState: FalseEndingState;\n  phaseAdvanced: boolean;\n  newPhase: number | null;\n  timeBlocked?: { reason: string; waitHours: number };\n} {\n  // \n  let newState: FalseEndingState = {\n    ...state,\n    turnsInPhase: state.turnsInPhase + 1,\n    totalTurns: state.totalTurns + 1,\n  };\n\n  // \n  const newAnchors = detectCompletedAnchors(aiResponse, state.currentPhase);\n  const allAnchors = [...new Set([...newState.completedAnchors, ...newAnchors])];\n  newState.completedAnchors = allAnchors;\n\n  // Bug #15 \n  if (userInput) {\n    const { updatedState } = updateProgressTracking(newState, userInput);\n    newState = updatedState;\n  }\n\n  // \n  let phaseAdvanced = false;\n  let newPhase: number | null = null;\n\n  if (shouldAdvancePhase(newState, currentHour)) {\n    // Bug #19: \n    if (currentHour !== undefined) {\n      const timeCheck = canEnterNextFalsePhase(newState, currentHour);\n      if (timeCheck.blocked) {\n        // \n        return {\n          newState,\n          phaseAdvanced: false,\n          newPhase: null,\n          timeBlocked: {\n            reason: timeCheck.reason || '',\n            waitHours: timeCheck.waitHours || 1,\n          },\n        };\n      }\n    }\n\n    newState = advanceToNextPhase(newState);\n    phaseAdvanced = true;\n    newPhase = newState.currentPhase;\n  }\n\n  return { newState, phaseAdvanced, newPhase };\n}\n\n// ============================================\n// Prompt\n// ============================================\n\n/**\n * AIPrompt\n * Bug #19: \n * Bug #40 \"\"\n */\nexport function generateFalseEndingPrompt(state: FalseEndingState, userInput: string, currentHour?: number): string {\n  if (state.currentPhase >= FALSE_ENDING_PHASES.length) {\n    return generateFalseEndingComplete();\n  }\n\n  const phaseConfig = FALSE_ENDING_PHASES[state.currentPhase];\n\n  let prompt = phaseConfig.aiGuidance;\n\n  // Bug #40 \n  const hour = currentHour ?? 12;\n  const nextPhaseCheck = canEnterNextFalsePhase(state, hour);\n  const isTimeLocked = nextPhaseCheck.blocked;\n\n  // Bug #40 \"\"\n  let turnsWarning: string;\n  if (isTimeLocked) {\n    turnsWarning = `${FALSE_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00`;\n  } else {\n    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;\n    turnsWarning =\n      remainingTurns <= 2 ? ` ${remainingTurns}` : `${remainingTurns}`;\n  }\n\n  // Bug #40 \n  let urgencyHint = '';\n  if (!isTimeLocked) {\n    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;\n    if (remainingTurns <= 1) {\n      urgencyHint = '\\n\\n 1';\n    } else if (remainingTurns <= 2) {\n      urgencyHint = `\\n\\n ${remainingTurns} `;\n    }\n  }\n\n  // Bug #40 \n  const timeBlockWarning = isTimeLocked\n    ? `\\n \"${FALSE_ENDING_PHASES[state.currentPhase + 1]?.name}\"${FALSE_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00${hour}:00\n `\n    : '';\n\n  // \n  prompt += `\\n\\n\n- ${state.currentPhase + 1}/${FALSE_ENDING_PHASES.length} - ${phaseConfig.title}\n- ${state.turnsInPhase}${turnsWarning}\n- [${state.completedAnchors.join(', ')}]\n- [${phaseConfig.anchorEvents.filter(a => !state.completedAnchors.includes(a)).join(', ')}]${timeBlockWarning}${urgencyHint}`;\n\n  // Bug #15 \n  const progressHint = checkProgressHint(state, userInput);\n  if (progressHint) {\n    prompt += `\\n\\n\n\n${progressHint}`;\n  }\n  // \n  else if (userInput && !isInputOnTrack(userInput, state.currentPhase)) {\n    const hint = getCorrectionHint(state.currentPhase);\n    if (hint) {\n      prompt += `\\n\\n\n\n${hint}`;\n    }\n  }\n\n  return prompt;\n}\n\n/**\n * \n */\nfunction isInputOnTrack(input: string, phase: number): boolean {\n  // \n  const phaseConfig = FALSE_ENDING_PHASES[phase];\n  if (!phaseConfig) return true;\n\n  const allKeywords = phaseConfig.anchorEvents.flatMap(anchor => {\n    const kws = ANCHOR_KEYWORDS[anchor];\n    return kws ? kws.filter((k): k is string => typeof k === 'string') : [];\n  });\n\n  return allKeywords.some(kw => input.includes(kw));\n}\n\n/**\n * \n */\nexport function getCorrectionHint(phase: number): string | null {\n  if (phase >= FALSE_ENDING_PHASES.length) return null;\n\n  const hints = FALSE_ENDING_PHASES[phase].correctionHints;\n  if (!hints || hints.length === 0) return null;\n\n  // \n  return hints[Math.floor(Math.random() * hints.length)];\n}\n\n/**\n * \n * 2026-01-17 \n * 2026-01-19 \n */\nexport function generateFalseEndingFreeTimePrompt(hour: number): string {\n  const nextHour = hour + 1;\n  const nextEvent = hour === 21 ? '22:00' : '';\n\n  return ` - ${hour}:00\n\n${nextEvent}\n\n\n- /\n- {{user}}\n- \n\nAI\n1. \n2. \n3. {{user}}\n4. \n5. \n\n\n\n- \n- \n- {{user}}\n\n - \n  <HusbandThought> \n- /30-50\n- \n- \n- \n\n\n<HusbandThought>\n...\n</HusbandThought>\n\n${nextHour}:00`;\n}\n\n/**\n * \n * 2026-01-17 20:0011:00\n */\nexport function generateFalseEndingEntryReplacement(): {\n  userMessage: string;\n  prefill: string;\n} {\n  return {\n    userMessage: `[ - ]\n\n Day 5, 11:00\n\n\n\n\n\"\"...\n{{user}}\n\n\n\n5\n- \n- {{user}}\"\"\n- \n\n.X.\n\nDay 1-4 \n Day 1  Day 4 \n\n- \n- \n- {{user}}\n\"\"\n\n\n\n...\n{{user}}\n\n\n\n- 11:00-19:00 \n- 20:00 \n- 21:00 \n- 22:00+ ...\n\nAI\n1. \n2. \"\"\n3. {{user}}\n4. \n5. \n6. `,\n\n    prefill: `\n\n...\n\n......\n\n\n\n{{user}}\n\n\n\n\"`,\n  };\n}\n\n/**\n * \n * 2026-01-17 \n */\nexport function generateFalseEndingComplete(): string {\n  return ` - \n\n{{user}}\n\n\n{{user}}\n\n\"\"\n\n\n{{user}}\n{{user}}\n\"\"\n\n\n\n{{user}}\n\n\n\n...\n\n\n\n \n\n...\n\n`;\n}\n\n/**\n * \n */\nexport function generatePhaseTransitionHint(fromPhase: number, toPhase: number): string {\n  if (toPhase >= FALSE_ENDING_PHASES.length) {\n    return '';\n  }\n\n  const nextConfig = FALSE_ENDING_PHASES[toPhase];\n  return `${nextConfig.title}`;\n}\n\n/**\n * Prompt\n * 2026-01-17 \n * Bug #19: \n */\nexport function generateFalseEndingTimeBasedPrompt(\n  data: SchemaType,\n  state: FalseEndingState,\n  userInput: string,\n): string | null {\n  const guidanceType = getFalseEndingGuidanceType(data);\n  const currentHour = data..;\n\n  if (!guidanceType) {\n    return null;\n  }\n\n  switch (guidanceType) {\n    case 'preheat':\n    case 'dinner':\n    case 'main':\n      // Bug #19: \n      return generateFalseEndingPrompt(state, userInput, currentHour);\n\n    case 'free': {\n      // \n      return generateFalseEndingFreeTimePrompt(currentHour);\n    }\n\n    default:\n      return null;\n  }\n}\n","/**\n *  - \n *\n * \n * 1. \"\"\n * 2. \n * 3. 12\n * 4. \"\"\"\"\n *\n * \n * - Day 5, 11:00+ 51\n * - 5\n * -  = 31235\n * -  =   \n * -  = \n *\n * \n * - 10:00 5\n * - 11:00 0-3\n * - 20:00 \n * - 21:00 \n * - 22:00 \n * - 23:00 \n * - 00:00 4-11\n */\n\nimport type { Schema as SchemaType } from '../../schema';\nimport { getScene5LockedCoherence } from './scene5System';\n\n// ============================================\n// \n// ============================================\n\nexport interface PerfectEndingPhase {\n  phase: number;\n  name: string;\n  title: string;\n  description: string;\n  minTurns: number; // \n  maxTurns: number; // Bug #19\n  minHour?: number; // Bug #19\n  strict?: boolean; // Bug #19true=minHour\n  anchorEvents: string[]; // \n  aiGuidance: string; // AI\n  correctionHints: string[]; // \n  // Bug #15 \n  expectedActions?: string[]; // \n  hintThreshold?: number; // 2\n  progressHint?: string; // \n}\n\nexport const PERFECT_ENDING_PHASES: PerfectEndingPhase[] = [\n  // === 0 ===\n  {\n    phase: 0,\n    name: '',\n    title: '',\n    description: '11:00',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: 20-25\n    minHour: 11, // 11:00\n    anchorEvents: ['', ''],\n    aiGuidance: ` - 0\n\n\n\n\nDay 5, 11:0051\n\n\n\n- 16\n- 17\n- 20\n- \n\n\n\n\n\n- \n- \n- \n- \n\n\n\n\n{{user}}\"\"\n\nAI\n1. \n2. {{user}}\n3. \"...\"\n4. \n5. \n\n\n\n\n\n\n- \n- \n- \"\"`,\n    correctionHints: [\n      '{{user}}\"......\"',\n      '\"...\"',\n      '\"...\"\"\"',\n    ],\n  },\n\n  // === 1 ===\n  {\n    phase: 1,\n    name: '',\n    title: '',\n    description: '14:00',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    minHour: 14, // 2026-01-19: 14:00\n    strict: true,\n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 1\n\n\n\n\n- {{user}}\n- /\n- \n- {{user}}/\n\n\n\n- \n- \n- ...\n- \n\n\n\n-         \n- \"...\"\n- \"\"\n- \n\nAI\n1. {{user}}\n2. {{user}}\n3. \n4. ...\n5. \n\n  - \n-  \n-  \n-  \n-  \n-  \"\"\n\n \n- \"\"\n- \n- \n- \"\"{{user}}\"\"\n\n\n- \n- \n- `,\n    correctionHints: [\n      '{{user}}\"...\"',\n      '...',\n      '',\n    ],\n  },\n\n  // === 2 ===\n  {\n    phase: 2,\n    name: '',\n    title: '',\n    description: '16:00',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    minHour: 16, // 2026-01-19: 16:00\n    strict: true,\n    anchorEvents: ['', ''],\n    aiGuidance: ` - 2\n\n\n\n\n- \n- \n- {{user}}\n\n\n{{user}}\n- \"...\"\n- \"\"\n- \"...\"\n- \"...\"\n\n\n- \"\"\n- \"...\"\n- \"...\"\n- \"\"\n\n  - \n-  \n-  \n-  \n-  10\n-  \n\n \n\"\"\n1. ****/\n2. ****\n3. {{user}}****\n4. {{user}}\"\"\n5. \n\n\"\"\n\nAI\n1. \n2. {{user}}\n3. \n4. \"\"\n5. \n\n\n\n\n\"...\"`,\n    correctionHints: [\n      '\"\"',\n      '\"\"\"...\"',\n      '\"\"\"...\"',\n    ],\n  },\n\n  // === 3 ===\n  {\n    phase: 3,\n    name: '',\n    title: '',\n    description: '{{user}}',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', ''],\n    aiGuidance: ` - 3\n\n\n\n\n- \n- \n- {{user}}\n- \n\n\n- \n- {{user}}\n- \n- \"...\"\n\n\n- \n- {{user}}\n- \n- \n\nAI\n1. \n2. \n3. \n4. \n5. \"\"\n\n\n- \n- `,\n    correctionHints: [\n      '{{user}}\"...\"',\n      '',\n      '\"\"',\n    ],\n  },\n\n  // === 4 ===\n  {\n    phase: 4,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    minHour: 20, // Bug #19: 20:00\n    strict: true, // Bug #19: \n    anchorEvents: ['', ''],\n    aiGuidance: ` - 4\n\n\n\n\n- 20:00\n- {{user}}\n- \n- \"\"\n\n\n\n- \"\"\n- \"\"\n- \"\"\n\n\n- {{user}}\n- {{user}}\n- \n- \n\nAI\n1. \n2. {{user}}\n3. {{user}}\n4. {{user}}\n5. \n\n\n\n`,\n    correctionHints: [\n      '\"\"',\n      '',\n      '...',\n    ],\n  },\n\n  // === 5 ===\n  {\n    phase: 5,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', ''],\n    aiGuidance: ` - 5\n\n\n\n\n- \"\"\n- \n- \n\n\n\n- \n- \n- \n- \n- \n\nAI\n1. \n2. {{user}}\n3. \n4. \n5. \n\n\n\n`,\n    correctionHints: [\n      '\"\"',\n      '...',\n      '',\n    ],\n  },\n\n  // === 6 ===\n  {\n    phase: 6,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', ''],\n    aiGuidance: ` - 6\n\n\n\n\n\n\n\n- \n- \n- \n- \n- \n- \n\n\n- \n- \n- \"\"\n- \"...\"\n\nAI\n1. \n2. \n3. \n4. \"\"\n5. \n\n\n- \n- \n- `,\n    correctionHints: [\n      '',\n      '\"\"',\n      '',\n    ],\n  },\n\n  // === 7 ===\n  {\n    phase: 7,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 7\n\n\n\n\n- \n- {{user}}\n- \n\n\n\n- \"...\"\n- \"\"\n- \"\"\n\n\n- \"...\"\n- \"\"\n- \"...\"\n- \"\"\n- \"...\"\n- \"\"\n- \"\"\n\n\n- \"\"\n- \"\"\n- \"\"\n- \"...\"\n- \"\"\n\nAI\n1. \n2. \n3. \n4. \n5. \n\n\n\n`,\n    correctionHints: [\n      '\"...\"',\n      '\"\"\"...\"',\n      '\"\"\"\"',\n    ],\n  },\n\n  // === 8 ===\n  {\n    phase: 8,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 8\n\n{{user}}\n\n\n- \n- {{user}}\n- \n\n\n\n- \"...\"\n- \"...\"\n- \"...\"\n- \"...\"\n- \"...\"\n- \"...\"\n- \"\"\n\n{{user}}\n- \"\"\n- \"\"\n- \"\"\n\nAI\n1. {{user}}\n2. \n3. \n4. {{user}}\n5. \"\"\n\n\n\n`,\n    correctionHints: [\n      '{{user}}',\n      '\"......\"\"\"',\n      '{{user}}\"\"',\n    ],\n  },\n\n  // === 9 ===\n  {\n    phase: 9,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', ''],\n    aiGuidance: ` - 9\n\n{{user}}\n\n\n- \"...\"\n- {{user}}\n- \n\n\n{{user}}\n- \n- \n- \n- \n\nAI\n\n- \n- \n- \"\"\n\nAI\n1. {{user}}\n2. \n3. \n4. \n5. \"\"\n\n\n`,\n    correctionHints: [\n      '\"...\"',\n      '{{user}}',\n      '{{user}}',\n    ],\n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint:\n      '\"...\"',\n  },\n\n  // === 10 ===\n  {\n    phase: 10,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', ''],\n    aiGuidance: ` - 10\n\n\n\n\n- \n- \n- \n\n\n\n1. \n2. \n3. \n4. {{user}}\n5. \n\n\n- \"...\"\n- \"\"\n- \"...\"\n\n\n10\n- \n- \n- \"\"\n\nAI\n1. \n2. \n3. \n4. \n5. {{user}}\n6. \n\n\n\n`,\n    correctionHints: [\n      '',\n      '',\n      '\"\"{{user}}\"\"',\n    ],\n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint:\n      '\"\"...',\n  },\n\n  // === 11 ===\n  {\n    phase: 11,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 11\n\n\n\n\n- \n- \n- \n\n\n\n- \"\"\n- \"\"\n- \"...\"\n\n\n- \n- \n- {{user}}\n\n\n- \n- \n- \n- \n\n\n- \"...\"\n- \"\"\n- \"\"\n\nAI\n1. \n2. \n3. \n4. \n5. \n6. \n\n\n\n- \n- \n- `,\n    correctionHints: [], // \n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint:\n      '...\"\"...',\n  },\n];\n\n// ============================================\n// \n// ============================================\n\nexport interface PerfectEndingState {\n  isActive: boolean; // \n  currentPhase: number; //  (0-11)\n  turnsInPhase: number; // \n  completedAnchors: string[]; // \n  totalTurns: number; // \n  isComplete: boolean; // \n  // Bug #15 \n  noProgressTurns: number; // \n  hintGiven: boolean; // \n}\n\n/**\n * \n */\nexport function getDefaultPerfectEndingState(): PerfectEndingState {\n  return {\n    isActive: false,\n    currentPhase: 0,\n    turnsInPhase: 0,\n    completedAnchors: [],\n    totalTurns: 0,\n    isComplete: false,\n    // Bug #15 \n    noProgressTurns: 0,\n    hintGiven: false,\n  };\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n *\n * \n * 1. Day 5, 11:00+\n * 2. \n * 3. \n * 4. 5\n * 5.  = 3\n */\nexport function shouldActivatePerfectEnding(data: SchemaType): boolean {\n  // 1Day 5, 11:00+\n  const day = data..;\n  const hour = data..;\n  if (day < 5 || (day === 5 && hour < 11)) {\n    return false;\n  }\n\n  // 2\n  const validStates = ['', '', ''];\n  if (!validStates.includes(data..)) {\n    return false;\n  }\n\n  // 3\n  const currentEnding = data..;\n  if (currentEnding !== '') {\n    return false;\n  }\n\n  // 45\n  const completedScenes = data..;\n  const correctScenes = data..;\n\n  const allCompleted = [1, 2, 3, 4, 5].every(s => completedScenes.includes(s));\n  const allCorrect = [1, 2, 3, 4, 5].every(s => correctScenes.includes(s));\n\n  if (!allCompleted || !allCorrect) {\n    return false;\n  }\n\n  // 5 = 3\n  const coherence = getScene5LockedCoherence(data);\n  if (coherence !== 3) {\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * 21:00  23:00\n */\nexport function isPerfectEndingFreeTime(data: SchemaType): boolean {\n  const day = data..;\n  const hour = data..;\n\n  //  Day 5  21:00  23:00 \n  if (day === 5 && (hour === 21 || hour === 23)) {\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Schema\n */\nexport function isPerfectEndingActive(data: SchemaType): boolean {\n  const endingState = (data as any). as PerfectEndingState | undefined;\n  return endingState?.isActive === true;\n}\n\n/**\n * \n */\nexport function getPerfectEndingState(data: SchemaType): PerfectEndingState {\n  const endingState = (data as any). as PerfectEndingState | undefined;\n  return endingState ?? getDefaultPerfectEndingState();\n}\n\n/**\n * \n */\nexport function updatePerfectEndingState(data: SchemaType, state: PerfectEndingState): void {\n  (data as any). = state;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nconst PERFECT_ANCHOR_KEYWORDS: Record<string, string[]> = {\n  // 0\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '', ''],\n\n  // 1\n  : ['', '', '', '', ''],\n  : ['.*', '', '.*', ''],\n  : ['.*', '', '', '', ''],\n\n  // 2\n  : ['', '', '', ''],\n  : ['', '', '', ''],\n\n  // 3\n  : ['', '', '', '', ''],\n  : ['', '', '', ''],\n\n  // 4\n  : ['', '', '', ''],\n  : ['', '', '.*', '.*'],\n\n  // 5\n  : ['', '', '', ''],\n  : ['', '', '', '', ''],\n\n  // 6\n  : ['', '', '', ''],\n  : ['', '', '', '', '', ''],\n\n  // 7\n  : ['', '', '', ''],\n  : ['', '', '.*', ''],\n  : ['', '', '', '', '', ''],\n\n  // 8\n  : ['', '', '', '.*'],\n  : ['', '', '', '', ''],\n  : ['', '', '.*'],\n\n  // 9\n  : ['', '', ''],\n  : ['', '', ''],\n\n  // 10\n  : ['', '.*', ''],\n  : ['.*', '.*', ''],\n\n  // 11\n  : ['', '.*', '.*'],\n  : ['', '', '.*'],\n  : ['', '', ''],\n};\n\n/**\n * AI\n */\nexport function detectPerfectAnchors(aiResponse: string, phase: number): string[] {\n  const phaseConfig = PERFECT_ENDING_PHASES[phase];\n  if (!phaseConfig) return [];\n\n  const completed: string[] = [];\n\n  for (const anchor of phaseConfig.anchorEvents) {\n    const keywords = PERFECT_ANCHOR_KEYWORDS[anchor] || [];\n    const isCompleted = keywords.some(kw => {\n      // \n      if (kw.includes('.*')) {\n        const regex = new RegExp(kw, 'i');\n        return regex.test(aiResponse);\n      }\n      return aiResponse.includes(kw);\n    });\n\n    if (isCompleted) {\n      completed.push(anchor);\n    }\n  }\n\n  return completed;\n}\n\n// ============================================\n// Bug #15 \n// ============================================\n\n/**\n * \n * @param userInput \n * @param phase \n * @returns \n */\nexport function hasExpectedAction(userInput: string, phase: number): boolean {\n  const phaseConfig = PERFECT_ENDING_PHASES[phase];\n  if (!phaseConfig || !phaseConfig.expectedActions || phaseConfig.expectedActions.length === 0) {\n    // \n    return true;\n  }\n\n  const lowerInput = userInput.toLowerCase();\n  return phaseConfig.expectedActions.some(action => lowerInput.includes(action.toLowerCase()));\n}\n\n/**\n * \n * @param state \n * @param userInput \n * @returns  null\n */\nexport function checkProgressHint(state: PerfectEndingState, userInput: string): string | null {\n  const phaseConfig = PERFECT_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig) return null;\n\n  // \n  if (state.hintGiven) return null;\n\n  // \n  if (!phaseConfig.progressHint) return null;\n\n  // \n  const hasAction = hasExpectedAction(userInput, state.currentPhase);\n\n  // \n  if (hasAction) return null;\n\n  // \n  const threshold = phaseConfig.hintThreshold ?? 2;\n  if (state.noProgressTurns + 1 >= threshold) {\n    return phaseConfig.progressHint;\n  }\n\n  return null;\n}\n\n/**\n * \n * @param state \n * @param userInput \n * @returns \n */\nexport function updateProgressTracking(\n  state: PerfectEndingState,\n  userInput: string,\n): {\n  updatedState: PerfectEndingState;\n  hint: string | null;\n} {\n  const hasAction = hasExpectedAction(userInput, state.currentPhase);\n\n  if (hasAction) {\n    // \n    return {\n      updatedState: {\n        ...state,\n        noProgressTurns: 0,\n      },\n      hint: null,\n    };\n  }\n\n  // \n  const newNoProgressTurns = state.noProgressTurns + 1;\n  const hint = checkProgressHint({ ...state, noProgressTurns: newNoProgressTurns - 1 }, userInput);\n\n  return {\n    updatedState: {\n      ...state,\n      noProgressTurns: newNoProgressTurns,\n      hintGiven: hint !== null ? true : state.hintGiven,\n    },\n    hint,\n  };\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * Bug #19: \n * @param state \n * @param currentHour \n * @returns \n */\nexport function canEnterNextPerfectPhase(\n  state: PerfectEndingState,\n  currentHour: number,\n): { blocked: boolean; reason?: string; waitHours?: number } {\n  const nextPhase = state.currentPhase + 1;\n  if (nextPhase >= PERFECT_ENDING_PHASES.length) {\n    return { blocked: false };\n  }\n\n  const nextConfig = PERFECT_ENDING_PHASES[nextPhase];\n  if (!nextConfig) return { blocked: false };\n\n  // \n  if (nextConfig.minHour !== undefined && nextConfig.strict) {\n    if (currentHour < nextConfig.minHour) {\n      const waitHours = nextConfig.minHour - currentHour;\n      return {\n        blocked: true,\n        reason: `${nextConfig.name} ${nextConfig.minHour}:00 `,\n        waitHours,\n      };\n    }\n  }\n\n  return { blocked: false };\n}\n\n/**\n * \n * Bug #19:  maxTurns \n * Bug #40 maxTurns \n */\nexport function shouldAdvancePerfectPhase(state: PerfectEndingState, currentHour?: number): boolean {\n  const phaseConfig = PERFECT_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig) return false;\n\n  // Bug #40 \n  //  maxTurns \n  if (currentHour !== undefined) {\n    const canEnter = canEnterNextPerfectPhase(state, currentHour);\n    if (canEnter.blocked) {\n      // \n      return false;\n    }\n  }\n\n  // Bug #19: \n  if (phaseConfig.maxTurns && state.turnsInPhase >= phaseConfig.maxTurns) {\n    console.info(\n      `[] ${state.currentPhase}(${phaseConfig.name}) ${phaseConfig.maxTurns}`,\n    );\n    return true;\n  }\n\n  // \n  if (state.turnsInPhase < phaseConfig.minTurns) {\n    return false;\n  }\n\n  // \n  const allAnchorsComplete = phaseConfig.anchorEvents.every(anchor => state.completedAnchors.includes(anchor));\n\n  return allAnchorsComplete;\n}\n\n/**\n * \n */\nexport function advanceToPerfectNextPhase(state: PerfectEndingState): PerfectEndingState {\n  const nextPhase = state.currentPhase + 1;\n\n  // \n  if (nextPhase >= PERFECT_ENDING_PHASES.length) {\n    return {\n      ...state,\n      isComplete: true,\n    };\n  }\n\n  return {\n    ...state,\n    currentPhase: nextPhase,\n    turnsInPhase: 0,\n    completedAnchors: [], // \n    // Bug #15 \n    noProgressTurns: 0,\n    hintGiven: false,\n  };\n}\n\n/**\n * \n * Bug #19: \n */\nexport function processPerfectTurnEnd(\n  state: PerfectEndingState,\n  aiResponse: string,\n  userInput?: string,\n  currentHour?: number,\n): {\n  newState: PerfectEndingState;\n  phaseAdvanced: boolean;\n  newPhase: number | null;\n  timeBlocked?: { reason: string; waitHours: number };\n} {\n  // \n  let newState: PerfectEndingState = {\n    ...state,\n    turnsInPhase: state.turnsInPhase + 1,\n    totalTurns: state.totalTurns + 1,\n  };\n\n  // \n  const newAnchors = detectPerfectAnchors(aiResponse, state.currentPhase);\n  const allAnchors = [...new Set([...newState.completedAnchors, ...newAnchors])];\n  newState.completedAnchors = allAnchors;\n\n  // \n  let phaseAdvanced = false;\n  let newPhase: number | null = null;\n\n  if (shouldAdvancePerfectPhase(newState, currentHour)) {\n    // Bug #19: \n    if (currentHour !== undefined) {\n      const timeCheck = canEnterNextPerfectPhase(newState, currentHour);\n      if (timeCheck.blocked) {\n        // \n        return {\n          newState,\n          phaseAdvanced: false,\n          newPhase: null,\n          timeBlocked: {\n            reason: timeCheck.reason || '',\n            waitHours: timeCheck.waitHours || 1,\n          },\n        };\n      }\n    }\n\n    newState = advanceToPerfectNextPhase(newState);\n    phaseAdvanced = true;\n    newPhase = newState.currentPhase;\n  }\n\n  return { newState, phaseAdvanced, newPhase };\n}\n\n// ============================================\n// AI Prompt \n// ============================================\n\n/**\n * AIPrompt\n * Bug #19: \n * Bug #40 \"\"\n * @param state \n * @param userInput \n * @param currentHour \n */\nexport function generatePerfectEndingPrompt(\n  state: PerfectEndingState,\n  userInput: string,\n  currentHour?: number,\n): string {\n  const phaseConfig = PERFECT_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig) return '';\n\n  // \n  const remainingAnchors = phaseConfig.anchorEvents.filter(a => !state.completedAnchors.includes(a));\n\n  // Bug #40 \n  const hour = currentHour ?? 12;\n  const nextPhaseCheck = canEnterNextPerfectPhase(state, hour);\n  const isTimeLocked = nextPhaseCheck.blocked;\n\n  // Bug #40 \"\"\n  let turnsWarning: string;\n  if (isTimeLocked) {\n    turnsWarning = `${PERFECT_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00`;\n  } else {\n    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;\n    turnsWarning =\n      remainingTurns <= 2 ? ` ${remainingTurns}` : `${remainingTurns}`;\n  }\n\n  // Bug #40 \n  let urgencyHint = '';\n  if (!isTimeLocked) {\n    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;\n    if (remainingTurns <= 1) {\n      urgencyHint = '\\n\\n 1';\n    } else if (remainingTurns <= 2) {\n      urgencyHint = `\\n\\n ${remainingTurns} `;\n    }\n  }\n\n  // Bug #15 \n  let hintSection = '';\n  if (phaseConfig.progressHint && state.noProgressTurns >= (phaseConfig.hintThreshold ?? 2) && !state.hintGiven) {\n    hintSection = `\\n\\n  - \n\n\"${phaseConfig.progressHint}\"\n\n\n- \n- /\n- `;\n  }\n\n  // Bug #40 \n  const timeBlockWarning = isTimeLocked\n    ? `\\n \"${PERFECT_ENDING_PHASES[state.currentPhase + 1]?.name}\"${PERFECT_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00${hour}:00\n `\n    : '';\n\n  // \n  const progressInfo = `\n- ${state.currentPhase + 1}/${PERFECT_ENDING_PHASES.length}${phaseConfig.name}\n- ${state.turnsInPhase}${turnsWarning}\n- ${remainingAnchors.length > 0 ? remainingAnchors.join('') : ''}\n- ${state.totalTurns}${timeBlockWarning}`;\n\n  // Prompt\n  return `${phaseConfig.aiGuidance}\n\n${progressInfo}${urgencyHint}${hintSection}\n\n\n- \n- \n- \n- \"\"\"\"\n- \n- `;\n}\n\n/**\n * \n */\nexport function getPerfectCorrectionHint(phase: number): string | null {\n  const phaseConfig = PERFECT_ENDING_PHASES[phase];\n  if (!phaseConfig || phaseConfig.correctionHints.length === 0) {\n    return null;\n  }\n\n  // \n  const index = Math.floor(Math.random() * phaseConfig.correctionHints.length);\n  return phaseConfig.correctionHints[index];\n}\n\n/**\n * \n */\nexport function generatePerfectEndingEntryReplacement(): {\n  userMessage: string;\n  prefill: string;\n} {\n  const userMessage = `[ - ]\n\n Day 5, 11:00\n5\n\n\n\n5\n- 116- \n- 217- \n- 323- \n- 428- \n- 5- \n\n.X.\n\nDay 1-4 \n Day 1  Day 4 \n\n- \n- {{user}}\n- \n\"\"\n\n\n5123\n\n- 16\n- 17\n- 20\n- 25\n\n\n\n\n\n\n- \n- \n- \n- \"\"\"\"\n\n\n\n\n\n\n\n- 11:00-19:00 \n- 20:00 \n- 21:00 \n- 22:00 \n- 23:00 \n- 00:00 \n\nAI\n1. \n2. {{user}}\n3. \"...\"\n4. `;\n\n  const prefill = `\n\n\n\n\n\n...\n\n\n\n\"\"\n\n\n\n\"...\"\n\n\n\n\n\"`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * \n */\nexport function generatePerfectPhaseTransitionHint(_fromPhase: number, toPhase: number): string {\n  const toConfig = PERFECT_ENDING_PHASES[toPhase];\n  if (!toConfig) return '';\n\n  return `\\n\\n---\\n${toConfig.name}${toConfig.title}\\n---\\n`;\n}\n\n/**\n * \n */\nexport function generatePerfectEndingComplete(): string {\n  return `\n\n\n\nPERFECT TRUE END\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\"\"\n\n\n\n\n\"\"\n\"...\"\n\"\"\n\n\n\n\n\n\n\n \n \n\n`;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * 21:00  23:00\n */\nexport function generatePerfectFreeTimePrompt(hour: number): string {\n  const nextHour = hour + 1;\n  const nextEvent = hour === 21 ? '22:00' : '00:00';\n\n  return ` - ${hour}:00\n\n${nextEvent}\n\n - \n\n\n\n- \n- {{user}}\n- \n\nAI\n1. \n2. {{user}}\n3. \n4. \n\n\n\n\n- {{user}}\n- \n- \n\n${nextHour}:00`;\n}\n\n/**\n * \n */\nexport function getPerfectGuidanceType(data: SchemaType): 'normal' | 'free' | 'ceremony' | null {\n  const day = data..;\n  const hour = data..;\n\n  // Day 6+  'ceremony' \n  if (day > 5) {\n    return 'ceremony';\n  }\n\n  if (day !== 5) return null;\n\n  // 11:00-19:00 \n  if (hour >= 11 && hour < 20) {\n    return 'normal';\n  }\n\n  // 20:00 \n  if (hour === 20) {\n    return 'ceremony';\n  }\n\n  // 21:00 \n  if (hour === 21) {\n    return 'free';\n  }\n\n  // 22:00 \n  if (hour === 22) {\n    return 'ceremony';\n  }\n\n  // 23:00 \n  if (hour === 23) {\n    return 'free';\n  }\n\n  // 00:00+ \n  if (hour === 0 || hour >= 24) {\n    return 'ceremony';\n  }\n\n  return null;\n}\n","/**\n *  - \n *\n * 55\"\"\n *\n * \n * - 580\n * - 100\n *\n * \n * 1. \n *    - =3+73100808794101\n *    - <3+1021008090100\n * 2. 3-5100\n *\n * \n * - 2026-01-19 5\n * - 5\n * - \"\"\"\"\n * - \n *\n * \n * - \n * - \n * -  > \n * - \"\"\n */\n\nimport type { Schema as SchemaType } from '../../schema';\nimport { calculateMemoryCoherence } from './scene5System';\n\n// =============================================\n// \n// =============================================\n\nexport type ConfusionEndingType = '' | '';\n\nexport interface ConfusionEndingCheckResult {\n  triggered: boolean;\n  type: ConfusionEndingType;\n  replaceUserMessage: string | null;\n  isFirstTrigger: boolean; // \n}\n\nexport interface SexualBehaviorCheckResult {\n  detected: boolean;\n  shouldWarn: boolean; // \n  shouldMarkConfusion: boolean; // \n  warningMessage: string | null; // \n  currentCount: number; // \n  maxAllowed: number; // \n}\n\nexport interface InterruptionCheckResult {\n  detected: boolean;\n  shouldMarkConfusion: boolean;\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n *  = \n */\nconst SEXUAL_BEHAVIOR_KEYWORDS = {\n  // \n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n\n  // +\n  : {\n    : ['', '', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', '', '', '', '', ''],\n  },\n};\n\n/**\n * \n * 3-5\n */\nconst INTERRUPTION_KEYWORDS = [\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n];\n\n// =============================================\n// \n// =============================================\n\n/**\n *  - \n */\nconst CONFUSION_INITIAL_TEMPLATES = [\n  // 1\n  () => `[ - ]\n\n\n\n\n\n\n\n\n\n\n\n\"\"\n\n\n\n...\n\n\n\n\n\"......\"\n\n\"\"\n\nBAD END: \n`,\n\n  // 2\n  () => `[ - ]\n\n\n\n\n\n\"\"\n\n\n\n\n\n\n\n\"......\"\n\n\"......\"\n\n\n\n\n\n\"...\"\n\n\"\"\n\n\n\"...\"\n\nBAD END: \n`,\n\n  // 3\n  () => `[ - ]\n\n\"......\"\n\n\n\n\n\"......\"\n\n\"......\"\n\n\n\n\"......\"\n\n\"\"\n\n\n\n\n\n\"\"\n\n\"...\"\n\n\n\"......\"\n\nBAD END: \n`,\n];\n\n/**\n *  - \n */\nconst CONFUSION_LOCKED_TEMPLATES = [\n  // 1\n  () => `[]\n\n\n\n\n\n\"\"...\n\n\n\n\n\n\nBAD END: \n`,\n\n  // 2\n  () => `[]\n\n\n\n\n\n\n\"...\"\n\"......\"\n\n\n\n\n\nBAD END: \n`,\n\n  // 3\n  () => `[]\n\n\n\"\"\n\n\n\n\n...\n\n\n\n\nBAD END: \n`,\n];\n\n/**\n * \n * @param confusion \n */\nconst SEXUAL_WARNING_TEMPLATES = {\n  // 1 80  90\n  nonPerfectFirstWarning: (confusion: number) => `...\n\n\"......\"\n\n\".........\"\n\n\n${confusion}/100`,\n\n  // 1 80  87\n  perfectFirstWarning: (confusion: number) => `...\n\n\"......\"\n\n\"......\"\n\n\n${confusion}/100`,\n\n  // 2 87  94\n  perfectSecondWarning: (confusion: number) => `...\n\n\"......\"\n\n\"......\"\n\n\n${confusion}/100`,\n};\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n */\nfunction randomChoice<T>(arr: T[]): T {\n  return arr[Math.floor(Math.random() * arr.length)];\n}\n\n/**\n * \n * @param day 1-5\n * @param hour 0-23\n * @returns \n */\nfunction calculateGlobalHour(day: number, hour: number): number {\n  return (day - 1) * 24 + hour;\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n * @param userInput \n * @returns \n */\nexport function detectSexualBehavior(userInput: string): boolean {\n  // 1. \n  const hasDirectKeyword = SEXUAL_BEHAVIOR_KEYWORDS..some(kw => userInput.includes(kw));\n  if (hasDirectKeyword) {\n    console.info(`[] `);\n    return true;\n  }\n\n  // 2.  + \n  const hasAction = SEXUAL_BEHAVIOR_KEYWORDS...some(kw => userInput.includes(kw));\n  const hasPart = SEXUAL_BEHAVIOR_KEYWORDS...some(kw => userInput.includes(kw));\n\n  if (hasAction && hasPart) {\n    console.info(`[] +`);\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * \n * @param userInput \n * @returns \n */\nexport function detectWeddingInterruption(userInput: string): boolean {\n  const hasInterruption = INTERRUPTION_KEYWORDS.some(kw => userInput.includes(kw));\n  if (hasInterruption) {\n    console.info(`[] `);\n  }\n  return hasInterruption;\n}\n\n/**\n * =3\n *\n * Bug #30 2026-01-18\n * -  data.. \n * - 550\n * -  calculateMemoryCoherence() \n * - 51-2-3\n *\n * @param data \n * @returns \n */\nexport function isPerfectMemoryRoute(data: SchemaType): boolean {\n  // Bug #30 \n  const coherence = calculateMemoryCoherence(data);\n  return coherence.level === 3;\n}\n\n/**\n * \n * - =3+73100\n * - <3+102100\n *\n * @param data \n * @returns \n */\nexport function getViolationIncrement(data: SchemaType): number {\n  return isPerfectMemoryRoute(data) ? 7 : 10;\n}\n\n/**\n * \n * 5\n *\n * \n * - 580\n * - =3+73100808794101\n * - <3+1021008090100\n *\n * @param data \n * @param userInput \n * @returns \n */\nexport function checkSexualBehaviorInScene5(data: SchemaType, userInput: string): SexualBehaviorCheckResult {\n  const detected = detectSexualBehavior(userInput);\n  const isPerfect = isPerfectMemoryRoute(data);\n  const increment = getViolationIncrement(data);\n  const currentConfusion = data..;\n\n  if (!detected) {\n    return {\n      detected: false,\n      shouldWarn: false,\n      shouldMarkConfusion: false,\n      warningMessage: null,\n      currentCount: data..?. ?? 0,\n      maxAllowed: isPerfect ? 3 : 2,\n    };\n  }\n\n  // \n  if (!data..) {\n    data.. = {\n      : false,\n      : null,\n      : null,\n      : false,\n      : null,\n      : 0,\n    };\n  }\n\n  // \n  const newCount = (data... ?? 0) + 1;\n  data... = newCount;\n\n  // \n  const newConfusion = Math.min(100, currentConfusion + increment);\n  data.. = newConfusion;\n\n  console.info(\n    `[] 5` +\n      `=${isPerfect ? '' : ''}` +\n      ` ${currentConfusion}  ${newConfusion} (+${increment})` +\n      `=${newCount}`,\n  );\n\n  // 100\n  if (newConfusion >= 100) {\n    // 100\n    return {\n      detected: true,\n      shouldWarn: false,\n      shouldMarkConfusion: true,\n      warningMessage: null,\n      currentCount: newCount,\n      maxAllowed: isPerfect ? 3 : 2,\n    };\n  } else {\n    // \n    let warningMessage: string;\n    if (isPerfect) {\n      // 187294\n      if (newCount === 1) {\n        warningMessage = SEXUAL_WARNING_TEMPLATES.perfectFirstWarning(newConfusion);\n      } else {\n        warningMessage = SEXUAL_WARNING_TEMPLATES.perfectSecondWarning(newConfusion);\n      }\n    } else {\n      // 190\n      warningMessage = SEXUAL_WARNING_TEMPLATES.nonPerfectFirstWarning(newConfusion);\n    }\n\n    return {\n      detected: true,\n      shouldWarn: true,\n      shouldMarkConfusion: false,\n      warningMessage,\n      currentCount: newCount,\n      maxAllowed: isPerfect ? 3 : 2,\n    };\n  }\n}\n\n/**\n * \n * 3-5\n *\n * 100\n *\n * @param data \n * @param userInput \n * @returns \n */\nexport function checkWeddingInterruptionInScene5(data: SchemaType, userInput: string): InterruptionCheckResult {\n  // 3-5\n  const currentStep = data..5?. ?? 0;\n  if (currentStep < 3 || currentStep > 5) {\n    return { detected: false, shouldMarkConfusion: false };\n  }\n\n  const detected = detectWeddingInterruption(userInput);\n  if (detected) {\n    // 100\n    const oldConfusion = data..;\n    data.. = 100;\n    console.info(`[] ${currentStep}` + ` ${oldConfusion}  100`);\n  }\n\n  return {\n    detected,\n    shouldMarkConfusion: detected, // \n  };\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * 5\n *\n * 2026-01-19 5\n * - \"\"\"\"\n * - \n *\n * @param data \n * @param reason \n */\nexport function markConfusionEnding(data: SchemaType, reason: '' | ''): void {\n  // \n  if (!data..) {\n    data.. = {\n      : false,\n      : null,\n      : null,\n      : false,\n      : null,\n      : 0,\n    };\n  }\n\n  // \n  if (data...) {\n    console.info(`[] `);\n    return;\n  }\n\n  // \n  const currentGlobalHour = calculateGlobalHour(data.., data..);\n\n  // \n  data... = true;\n  data... = currentGlobalHour;\n  data... = currentGlobalHour;\n  data... = reason;\n  data... = true; // \n\n  console.info(`[] 5=${reason}=${currentGlobalHour}`);\n}\n\n/**\n * \n *\n * 2026-01-19 \n * - 5\n * - =true\n * - \"\"\n *\n * @param data \n * @param forceFirstTrigger \n * @returns \n */\nexport function checkConfusionEnding(data: SchemaType, forceFirstTrigger = false): ConfusionEndingCheckResult {\n  const confusion = data..;\n\n  // \n  if (confusion?.) {\n    return {\n      triggered: true,\n      type: '',\n      replaceUserMessage: forceFirstTrigger\n        ? randomChoice(CONFUSION_INITIAL_TEMPLATES)()\n        : randomChoice(CONFUSION_LOCKED_TEMPLATES)(),\n      isFirstTrigger: forceFirstTrigger,\n    };\n  }\n\n  // \n  return {\n    triggered: false,\n    type: '',\n    replaceUserMessage: null,\n    isFirstTrigger: false,\n  };\n}\n\n/**\n * \n *\n * 2026-01-19 5\n * - \"\"\n * - \n *\n * @param data \n */\nexport function applyConfusionEndingState(data: SchemaType): void {\n  // \n  if (!data..) {\n    data.. = {\n      : false,\n      : null,\n      : null,\n      : false,\n      : null,\n      : 0,\n    };\n  }\n\n  // \n  data... = true;\n\n  // \n  data.. = '';\n  data.. = '';\n\n  // \n  data.. = true;\n\n  console.info(`[] `);\n}\n\n/**\n * \n *\n * @param data \n * @returns \n */\nexport function isInConfusionEndingLock(data: SchemaType): boolean {\n  return data..?. === true;\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n *\n * 2026-01-19 5\n * \n *\n * @param data \n * @returns \n */\nexport function canEnterDreamForConfusion(data: SchemaType): boolean {\n  // \n  if (data..?.) {\n    console.info(`[] `);\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * \n *\n * 2026-01-19 \n * 5\"\"\n *\n * @param _data \n * @returns null\n */\nexport function getConfusionForeshadowing(_data: SchemaType): string | null {\n  // null\n  return null;\n}\n\n// =============================================\n// 5\n// =============================================\n\n/**\n * 5\n * \n *\n * @param data \n * @param userInput \n * @returns \n */\nexport function checkScene5Violations(\n  data: SchemaType,\n  userInput: string,\n): {\n  shouldMarkConfusion: boolean;\n  shouldWarn: boolean;\n  warningMessage: string | null;\n  reason: '' | '' | null;\n} {\n  // 1. \n  const interruptionResult = checkWeddingInterruptionInScene5(data, userInput);\n  if (interruptionResult.shouldMarkConfusion) {\n    return {\n      shouldMarkConfusion: true,\n      shouldWarn: false,\n      warningMessage: null,\n      reason: '',\n    };\n  }\n\n  // 2. \n  const sexualResult = checkSexualBehaviorInScene5(data, userInput);\n  if (sexualResult.shouldMarkConfusion) {\n    return {\n      shouldMarkConfusion: true,\n      shouldWarn: false,\n      warningMessage: null,\n      reason: '',\n    };\n  }\n\n  if (sexualResult.shouldWarn) {\n    return {\n      shouldMarkConfusion: false,\n      shouldWarn: true,\n      warningMessage: sexualResult.warningMessage,\n      reason: null,\n    };\n  }\n\n  return {\n    shouldMarkConfusion: false,\n    shouldWarn: false,\n    warningMessage: null,\n    reason: null,\n  };\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n */\nconst SCENE_CONFUSION_VALUES: Record<number, number> = {\n  1: 40, // 1: 40\n  2: 60, // 2: 60\n  3: 80, // 3: 80\n  4: -1, // 4: -1\n  5: 80, // 5: 80\n};\n\n/**\n * \n *\n * 0\n * - 1: 40\n * - 2: 60\n * - 3: 80\n * - 4: \n * - 5: 80\n *\n * @param data \n * @param sceneNumber 1-5\n */\nexport function setConfusionOnDreamEntry(data: SchemaType, sceneNumber: number): void {\n  const targetValue = SCENE_CONFUSION_VALUES[sceneNumber];\n\n  if (targetValue === undefined) {\n    console.warn(`[] : ${sceneNumber}`);\n    return;\n  }\n\n  // 4\n  if (targetValue === -1) {\n    console.info(`[] ${sceneNumber}: ${data..}`);\n    return;\n  }\n\n  const oldValue = data..;\n\n  // 580\n  if (sceneNumber === 5) {\n    data.. = targetValue;\n    console.info(`[] 5: ${targetValue} (: ${oldValue})`);\n  } else if (oldValue < targetValue) {\n    data.. = targetValue;\n    console.info(`[] ${sceneNumber}: ${targetValue} (: ${oldValue})`);\n  } else {\n    console.info(`[] ${sceneNumber}: ${oldValue}`);\n  }\n}\n","/**\n *  - \n *\n * \"\"\n *\n * \n * - 2\n * -  +1\n * - \n *\n * \n * - \n * - \n * - \n * - /\n *\n * \n * -  \"Day X X\"\n * - / {{datetimeformat::YYYYMD}}\n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n// ============================================\n// \n// ============================================\n\nexport type AfterStoryType = '' | '' | '' | null;\n\nexport interface AfterStoryState {\n  : boolean;\n  : number;\n  : boolean;\n  : boolean;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * \n */\nconst PERFECT_TRUE_AFTER_STORY = {\n  type: '' as const,\n  husbandStatus: '',\n  interruptionLevel: 0, // \n\n  // 1\n  round1: {\n    title: '',\n    setting: `\n\n\n{{user}}\n\n\"\"`,\n    aiGuidance: ` - 1\n\n\n\n\n- \n- \n- \n- \n\n\n- {{user}}\n- \n- {{user}}\n\nAI\n1. \n2. \n3. \n4. \n5. \"\"`,\n  },\n\n  // 2\n  round2: {\n    title: '',\n    setting: `{{user}}\n...\n`,\n    aiGuidance: ` - 2\n\n\n- \n- {{user}}\n- ...\n- {{user}}\n\n\n- {{user}}\n- \"\"\n\nAI\n1. \n2. {{user}}\n3. \"\"\"\"\n4. \n5. \"\"\n\n\n\n`,\n  },\n};\n\n/**\n * \n * +\n */\nconst TRUE_ENDING_AFTER_STORY = {\n  type: '' as const,\n  husbandStatus: '',\n  interruptionLevel: 0, // \n\n  round1: {\n    title: '',\n    setting: `\n\n\n\n\"\"\n\n\n\n\n{{user}}`,\n    aiGuidance: ` - 1\n\n\n\n\n- ICU\"\"\n- \n- \n\n\n- {{user}}\n- ...\n- \"\"\n- \n- \n\nAI\n1. \n2. \n3. \n4. \"\"\n5. \"\"`,\n  },\n\n  round2: {\n    title: '',\n    setting: `\n{{user}}\n`,\n    aiGuidance: ` - 2\n\n\n\n\n- {{user}}\n- \n- \n\n\n- {{user}}\n- \n- \"\"\n- {{user}}\n\nAI\n1. \n2. {{user}}\n3. \"\"\n4. \n5. \n\n\n\n`,\n  },\n};\n\n/**\n * \n * \n */\nconst FALSE_ENDING_AFTER_STORY = {\n  type: '' as const,\n  husbandStatus: '',\n  interruptionLevel: 50, // \n\n  round1: {\n    title: '',\n    setting: `\n\n{{user}}\n\n\n`,\n    aiGuidance: ` - 1\n\n\n\n\n- /\n- \n- \"\"\n- \n\n\n- {{user}}\n- \n- \n- \n\nAI\n1. \n2. \"\"\n3. \n4. \n5. \n\n\n\n- \n- \n- `,\n  },\n\n  round2: {\n    title: '',\n    setting: `\n\"...\"\n`,\n    aiGuidance: ` - 2\n\n\n- \n- {{user}}\n- \n\n\n- \n- \n- \n- \n\n\n- \n- \n- \n\nAI\n1. \n2. \n3. \n4. \n5. \n\n\n\n\n`,\n  },\n};\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport function getAfterStoryType(data: SchemaType): AfterStoryType {\n  const ending = data..;\n\n  switch (ending) {\n    case '':\n      return '';\n    case '':\n      return '';\n    case '':\n      return '';\n    default:\n      return null;\n  }\n}\n\n/**\n * \n *  +  + \n */\nexport function shouldTriggerAfterStory(data: SchemaType): boolean {\n  // \n  const type = getAfterStoryType(data);\n  if (!type) return false;\n\n  // \n  if (!data..) return false;\n\n  // \n  if (data..?.) return false;\n\n  return true;\n}\n\n/**\n * \n */\nexport function isInAfterStory(data: SchemaType): boolean {\n  return data..?. === true && data..?. !== true;\n}\n\n/**\n * \n */\nexport function isInFreeMode(data: SchemaType): boolean {\n  return data..?. === true;\n}\n\n/**\n * \n */\nexport function shouldShowRealDate(data: SchemaType): boolean {\n  const ending = data..;\n  // \"\"\n  return ending === '' || ending === '' || ending === '';\n}\n\n/**\n * \n * 0 = 50 = 100 = \n */\nexport function getAfterStoryInterruptionLevel(data: SchemaType): number {\n  const type = getAfterStoryType(data);\n\n  // \n  if (isInFreeMode(data) || isInAfterStory(data)) {\n    switch (type) {\n      case '':\n        return PERFECT_TRUE_AFTER_STORY.interruptionLevel;\n      case '':\n        return TRUE_ENDING_AFTER_STORY.interruptionLevel;\n      case '':\n        return FALSE_ENDING_AFTER_STORY.interruptionLevel;\n      default:\n        return 0;\n    }\n  }\n\n  return 0;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport function activateAfterStory(data: SchemaType): void {\n  if (!data..) {\n    (data. as any). = {\n      : false,\n      : 0,\n      : false,\n      : false,\n    };\n  }\n\n  data... = true;\n  data... = 1;\n\n  console.info('[] ');\n}\n\n/**\n * \n */\nexport function advanceAfterStoryRound(data: SchemaType): void {\n  if (!data..) return;\n\n  const currentRound = data...;\n\n  if (currentRound >= 2) {\n    // \n    data... = true;\n    data... = true;\n    console.info('[] ');\n  } else {\n    data... = currentRound + 1;\n    console.info(`[] ${currentRound + 1}`);\n  }\n}\n\n// ============================================\n// AI Prompt \n// ============================================\n\n/**\n * \n */\nfunction getAfterStoryConfig(type: AfterStoryType) {\n  switch (type) {\n    case '':\n      return PERFECT_TRUE_AFTER_STORY;\n    case '':\n      return TRUE_ENDING_AFTER_STORY;\n    case '':\n      return FALSE_ENDING_AFTER_STORY;\n    default:\n      return null;\n  }\n}\n\n/**\n * \n */\nexport function generateAfterStoryEntryReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} | null {\n  const type = getAfterStoryType(data);\n  if (!type) return null;\n\n  const config = getAfterStoryConfig(type);\n  if (!config) return null;\n\n  const round1 = config.round1;\n\n  const userMessage = `[ - ]\n\n${type} - 1${round1.title}\n\n${round1.setting}\n\n${round1.aiGuidance}\n\n\n- 12\n- ${config.husbandStatus}\n- ${config.interruptionLevel === 0 ? '' : ''}\n- `;\n\n  const prefill = round1.setting.split('\\n')[0];\n\n  return { userMessage, prefill };\n}\n\n/**\n * AI\n */\nexport function generateAfterStoryPrompt(data: SchemaType): string | null {\n  const type = getAfterStoryType(data);\n  if (!type) return null;\n\n  const config = getAfterStoryConfig(type);\n  if (!config) return null;\n\n  const currentRound = data..?. ?? 1;\n  const roundConfig = currentRound === 1 ? config.round1 : config.round2;\n\n  return `${type} - ${currentRound}${roundConfig.title}\n\n${roundConfig.setting}\n\n${roundConfig.aiGuidance}\n\n\n- ${currentRound} / 2\n- ${config.husbandStatus}\n- ${config.interruptionLevel === 0 ? '' : ''}`;\n}\n\n/**\n * \n */\nconst FREE_MODE_SETTINGS = {\n  : {\n    timeFrame: '/',\n    relationship: '{{user}}\"\"',\n    zhaoXiaState: `- \n- {{user}}\n- \n- `,\n    husbandState: `- \"\"\n- \n- \n- \"\"`,\n    suggestedScenes: ['', '', '', '', ''],\n    tone: '\"\"',\n  },\n  : {\n    timeFrame: '',\n    relationship: '{{user}}',\n    zhaoXiaState: `- {{user}}\n- \n- ...\n- `,\n    husbandState: `- ICU\"\"\n- \n- \n- `,\n    suggestedScenes: ['', '', '', '', '\"\"'],\n    tone: '',\n  },\n  : {\n    timeFrame: '/',\n    relationship: '',\n    zhaoXiaState: `- \n- \"\"\n- {{user}}\n- `,\n    husbandState: `- \n- \"\"\n- \n- `,\n    suggestedScenes: [\n      '',\n      '',\n      '',\n      '',\n      '',\n    ],\n    tone: '',\n  },\n};\n\n/**\n * AI\n */\nexport function generateFreeModePrompt(data: SchemaType): string | null {\n  const type = getAfterStoryType(data);\n  if (!type) return null;\n\n  const config = getAfterStoryConfig(type);\n  if (!config) return null;\n\n  const settings = FREE_MODE_SETTINGS[type];\n  if (!settings) return null;\n\n  return `${type === '' ? '' : type} - \n\n\n\n\n\n${settings.timeFrame}\n\n\n${settings.relationship}\n\n\n${settings.zhaoXiaState}\n\n\n${settings.husbandState}\n${config.interruptionLevel === 0 ? '' : ''}\n\n\nDay 1-5  +  +  + \n\n.X.\n\n\n${settings.suggestedScenes.map(s => `- ${s}`).join('\\n')}\n\n\n${settings.tone}\n\nAI\n- \n- {{user}}\n- \n- \n- \"\"`;\n}\n\n/**\n * \n */\nexport function generateAfterStoryComplete(data: SchemaType): string {\n  const type = getAfterStoryType(data);\n\n  const typeTitle = type === '' ? '' : type === '' ? '' : '';\n\n  return `\n\n\n\n\n\n${typeTitle}\n\n\n\n\n\n${\n  type === ''\n    ? '\"\"'\n    : type === ''\n      ? ''\n      : ''\n}\n\n \n\n`;\n}\n\n/**\n * \n * /\n */\nexport function generateDateDisplay(data: SchemaType): string {\n  if (shouldShowRealDate(data)) {\n    // \n    return '{{datetimeformat::YYYYMD}}';\n  } else {\n    // \n    const day = data..;\n    const remaining = Math.max(0, 5 - day);\n    return `Day ${day} ${remaining}`;\n  }\n}\n","/**\n *  - Prompt\n *\n *  CHAT_COMPLETION_PROMPT_READY AI/\n * \n *\n * \n * 1.  - \n * 2.  - 10:00\n * 3.  - AI\n * 4.  - \n */\n\nimport { Schema, type Schema as SchemaType } from '../../schema';\nimport { TimeSystem } from './timeSystem';\nimport {\n  generateMemoryContinuityPrompt,\n  generateEnhancedMemoryContinuityPrompt,\n  generateMemorySummary,\n  getDreamSessionMessages,\n  processSceneCompletion, // Bug #38 \n} from './dreamKeywordDetection';\nimport {\n  generateAppearanceConstraintPrompt,\n  getRealmTitle,\n  generateDetailedInteractionPrompt,\n  calculateSuspicionIncrease,\n} from './appearanceSystem';\nimport {\n  checkBoundaryInterruption,\n  applyInterruptionResult,\n  type InterruptionCheckResult,\n} from './boundaryInterruption';\nimport { detectDangerousContent, shouldSkipDangerousContentDetection } from './dangerousContentDetection';\nimport {\n  calculateScene5Completion as calculateScene5CompletionNew,\n  generateScene5EntryReplacement as generateScene5EntryReplacementNew,\n  generateScene5ForceExitReplacement as generateScene5ForceExitReplacementNew,\n  generateScene5StepReplacement,\n  generateScene5FreePlayReplacement,\n  analyzePlayerIntent,\n  SCENE5_STEPS,\n  calculateMatchLevel,\n  lockScene5EntryCoherence,\n} from './scene5System';\nimport { checkBadEnding, applyBadEndingState, isInBadEndingLock, type BadEndingType } from './badEndingSystem';\nimport { checkNormalEnding, isInNormalEndingLock, type NormalEndingType } from './normalEndingSystem';\nimport {\n  shouldActivateTrueEnding,\n  isTrueEndingActive,\n  getTrueEndingState,\n  updateTrueEndingState,\n  generateTrueEndingPrompt,\n  generateTrueEndingEntryReplacement,\n  generateTrueEndingComplete,\n  getDefaultTrueEndingState,\n  // 2026-01-17 \n  isFreeTimeHour,\n  isRoomTriggerTime,\n  getGuidanceType,\n  generateTimeBasedPrompt,\n  isPerfectTrueEnding,\n} from './trueEndingSystem';\nimport {\n  shouldActivateFalseEnding,\n  isFalseEndingActive,\n  getFalseEndingState,\n  updateFalseEndingState,\n  generateFalseEndingPrompt,\n  generateFalseEndingEntryReplacement,\n  generateFalseEndingComplete,\n  getDefaultFalseEndingState,\n} from './falseEndingSystem';\nimport {\n  shouldActivatePerfectEnding,\n  isPerfectEndingActive,\n  getPerfectEndingState,\n  updatePerfectEndingState,\n  generatePerfectEndingPrompt,\n  generatePerfectEndingEntryReplacement,\n  generatePerfectEndingComplete,\n  getDefaultPerfectEndingState,\n  isPerfectEndingFreeTime,\n  generatePerfectFreeTimePrompt,\n  getPerfectGuidanceType,\n} from './perfectTrueEndingSystem';\nimport {\n  checkConfusionEnding,\n  applyConfusionEndingState,\n  isInConfusionEndingLock,\n  canEnterDreamForConfusion,\n  checkScene5Violations,\n  markConfusionEnding,\n  getConfusionForeshadowing,\n  detectSexualBehavior,\n  detectWeddingInterruption,\n  getViolationIncrement,\n} from './confusionEndingSystem';\nimport {\n  shouldTriggerAfterStory,\n  isInAfterStory,\n  isInFreeMode,\n  getAfterStoryType,\n  activateAfterStory,\n  advanceAfterStoryRound,\n  generateAfterStoryEntryReplacement,\n  generateAfterStoryPrompt,\n  generateFreeModePrompt,\n  generateAfterStoryComplete,\n  getAfterStoryInterruptionLevel,\n} from './afterStorySystem';\n\n// ============================================\n// Bug #13 \n//  chat.push()  systemPrompt \n//  Gemini  Claude \n// ============================================\n\n// ============================================\n// Bug #39 \n// \"\"\n// \n// ============================================\n\n/**\n *  - AI\n * src////xxx.yaml\n */\nconst ENDING_GUIDANCE = {\n  : ` - AI\n\n\n\n\n- \n- \n- \"\"\"\"\n- \n\n\n\n\n- 161723\n- \n- `,\n\n  : ` - AI\n\n\n\n\n- \"\"\n- \n- \"\"\n- \n\n\n\n\n- \n- \n- `,\n\n  : ` - AI\n\n\n\n\n- \n- \"\"\n- \"\"\"\"\n- \n\n\n\n\n- \n- \n- `,\n\n  : ` - AI\n\n\n\n\n- \n- \n\n`,\n\n  : ` - AI\n\n\n\n\n- 5\n- \n  - \n  - \n  - \n  - \"\"\n- \"\"\n\n`,\n\n  : ` - AI\n\n\n\n\n- \n- \n- AI\n\n`,\n};\n\n/**\n * Bug #39 \n *  data.. \n * @param data \n * @returns  null\n */\nfunction getEndingGuidance(data: SchemaType): string | null {\n  const currentEnding = data..;\n  if (!currentEnding) return null;\n\n  // \n  const guidance = ENDING_GUIDANCE[currentEnding as keyof typeof ENDING_GUIDANCE];\n  return guidance || null;\n}\n\n// ============================================\n// \n//  AI \n// ============================================\n\n/**\n *  - \n */\nconst DREAM_SYSTEM_OVERVIEW = `\n\n{{user}}22:00-01:00\n\n\n- 100\n- 0\n- 1=402=603=804=5=80\n\n5\n- =3+7 3100\n- <3+10 2100\n- 1003-5\n\n\n51-2-3\n- 0: 5\n- 1: 1\n- 2: 1+2+\n- 3: 1+2+3\n4528 vs `;\n\n/**\n * \n */\nconst DREAM_SCENE_DETAILS: Record<number, string> = {\n  1: `1 - AI\n\n16\n\n\nAI\n\n\n\n\n\n- 16\n- \n- \n- \n\n\n\n\n\nAI\n- \n- \n- \n- \n- \n- 09:00-10:00\n- \"\"`,\n\n  2: `2 - AI\n\n171~\n\n\n\n\n\n/\n\n\n\n- 17\n- 1\n- \n- \n- \n\n\n\n\n\nAI\n- \n- \n- \n- 1\n- 09:00-10:00\n- \n- \"\"`,\n\n  3: `3 - AI\n\n23\n\n\n23\n\n\n//\n\n\n- 23\n- 12\n- \n- \n- /\n- \"\"\n\n\n\n\n\nAI\n- \n- \n- \n- ...\n- \n- \n- 09:00-10:00\n- \n- \n- \"\"`,\n\n  4: `4 - AI\n\n285\n\n\n\n\n\n\n\n\n- 28\n- 1-3\n- \n- \n- \n- \n\n\n\n\n\nAI\n- \n- \n- \n- \n- \n- \n- 09:00-10:00\n- \n- \n- \n- \"\"`,\n\n  5: `5 - AI\n\n\n08:00-19:00\n\n\n\n/\n\"\"\n12\n\n\n- \n- 1-4\n- \n- \n- \"\"\n\n\n12\n\n\n12\n- 1-2\n- 3-5\n- 6-8\n- 9-11\n- 12\n\n\n- +10%+5%\n- 80%100%\n- 20:00\n\n\n- 1-10\n- 11-12  \n\n\n1220:00\n\n\n\nAI\n- \n- 1-4\n- \n- \"\"\"\"\n- 20:00\n\n-   3\n- \n\nAI\n- \n- \n- \n- 1-4\n- \n- 12\n- \"\"`,\n};\n\n/**\n * AI - \n */\nconst DREAM_AI_GUIDELINES = `AI\n\n\n{{user}}\n\n\n\n{{user}}\n\"\"{{user}}\n\n\n10:00\n\n\n\n\n{{user}}\n\n\n\n`;\n\n/**\n * \n * AI\n *\n * Bug #41 2026-01-20\n * - 51-4AIAI\n * - \n *\n *  isInDreamOrEntering \n * AI\n *\n * @param data \n * @param currentScene 1-5\n * @returns  null\n */\nfunction getDreamSceneGuidance(data: SchemaType, currentScene: number): string | null {\n  // \n  if (!data..) {\n    return null;\n  }\n\n  // \n  if (data.. === '') {\n    return null;\n  }\n\n  // Bug #40 \n  // AI\n  if (data.. !== '' || isInBadEndingLock(data) || isInConfusionEndingLock(data)) {\n    return null;\n  }\n\n  // \n  if (currentScene < 1 || currentScene > 5) {\n    console.warn(`[getDreamSceneGuidance] : ${currentScene}`);\n    return null;\n  }\n\n  const parts: string[] = [];\n\n  // 1. \n  parts.push(DREAM_SYSTEM_OVERVIEW);\n\n  // 2. Bug #41 AI\n  const completedScenes = data.. || [];\n  if (!completedScenes.includes(currentScene) && DREAM_SCENE_DETAILS[currentScene]) {\n    parts.push(DREAM_SCENE_DETAILS[currentScene]);\n    console.info(`[getDreamSceneGuidance] ${currentScene}AI`);\n  }\n\n  // 3. AI\n  parts.push(DREAM_AI_GUIDELINES);\n\n  return parts.join('\\n\\n---\\n\\n');\n}\n\n/**\n * \n * AI\n * \n *\n * \n * 1. ///\n * 2. AI\n *\n * @param data \n * @param excludeCurrentScene \n * @returns  null\n */\nfunction generateDreamHistoryBackground(data: SchemaType, excludeCurrentScene?: number): string | null {\n  // \n  if (!data..) {\n    return null;\n  }\n\n  let completedScenes = data.. || [];\n  const correctScenes = data.. || [];\n\n  // \n  if (excludeCurrentScene !== undefined) {\n    completedScenes = completedScenes.filter(s => s !== excludeCurrentScene);\n  }\n\n  if (completedScenes.length === 0) {\n    return null;\n  }\n\n  const parts: string[] = [];\n\n  parts.push(``);\n\n  // 1\n  if (completedScenes.includes(1)) {\n    const scene1Data = data..1 as { ?: string } | undefined;\n    const isCorrect = correctScenes.includes(1);\n    const summary = scene1Data?. || '';\n\n    parts.push(`\n1 ${isCorrect ? '' : ''}\n16\n\n16\n\n\n${summary}`);\n  }\n\n  // 2\n  if (completedScenes.includes(2)) {\n    const scene2Data = data..2 as { ?: string } | undefined;\n    const isCorrect = correctScenes.includes(2);\n    const summary = scene2Data?. || '';\n\n    parts.push(`\n2 ${isCorrect ? '' : ''}\n171~\n\n17\n\n1\n${summary}`);\n  }\n\n  // 3\n  if (completedScenes.includes(3)) {\n    const scene3Data = data..3 as { ?: string } | undefined;\n    const isCorrect = correctScenes.includes(3);\n    const summary = scene3Data?. || '';\n\n    parts.push(`\n3 ${isCorrect ? '' : ''}\n23\n23\n23\n\n\n${summary}`);\n  }\n\n  // 54\n  if (completedScenes.includes(5)) {\n    const scene5Data = data..5 as { ?: string; ?: number } | undefined;\n    const isCorrect = correctScenes.includes(5);\n    const completion = scene5Data?. ?? 0;\n    const summary = scene5Data?. || '';\n\n    parts.push(`\n5 ${isCorrect ? '' : ''} ${completion}%\n\n\"\"\n\n12\n\n${summary}`);\n  }\n\n  // 4\n  if (completedScenes.includes(4)) {\n    const scene4Data = data..4 as { ?: string } | undefined;\n    const isCorrect = correctScenes.includes(4);\n    const summary = scene4Data?. || '';\n\n    parts.push(`\n4 ${isCorrect ? '' : ''}\n285\n\n28\n\n\n${summary}`);\n  }\n\n  return parts.join('\\n');\n}\n\n// \n// Bug #16 \nconst DREAM_ENTRY_KEYWORDS = [\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n];\n//  \"...\" \nconst DREAM_ENTRY_PATTERNS = [\n  /.*/, //  \"\"\"\" \n  /.*/, //  \"\"\"\" \n];\n\n// 5\nconst SLEEPING_PILL_KEYWORDS = ['', '', '', '', '', '', '', ''];\n\n// \n// 1-4 23:00-01:00  + \n// 508:00-19:00\nconst DREAM_SCENE_THEMES: Record<\n  number,\n  {\n    title: string;\n    age: number;\n    setting: string;\n    theme: string;\n    atmosphere: string;\n    bodyPart: string; // \n    objective: string; // \n    identity: string; // \n  }\n> = {\n  1: {\n    title: '',\n    age: 16,\n    setting: '',\n    theme: '',\n    atmosphere: '',\n    bodyPart: '',\n    objective: '',\n    identity: '',\n  },\n  2: {\n    title: '',\n    age: 17,\n    setting: '',\n    theme: '',\n    atmosphere: '',\n    bodyPart: '',\n    objective: '',\n    identity: '1',\n  },\n  3: {\n    title: '',\n    age: 23,\n    setting: '//',\n    theme: '',\n    atmosphere: '',\n    bodyPart: '',\n    objective: '',\n    identity: '',\n  },\n  4: {\n    title: '',\n    age: 28,\n    setting: '',\n    theme: '',\n    atmosphere: '',\n    bodyPart: '',\n    objective: '',\n    identity: '',\n  },\n  5: {\n    title: '',\n    age: 0, // \n    setting: '/',\n    theme: '',\n    atmosphere: '',\n    bodyPart: '',\n    objective: '12',\n    identity: '',\n  },\n};\n\n// ============================================\n// 1\n// \n// ============================================\n\n/**\n * 1\n * /\n */\nconst SCENE1_INIT_CONFIG = {\n  // \n  dependence: {\n    favorWeight: 0.2, // 100  20\n    intimacyWeight: 0.1, // 100  10\n    maxValue: 30, // 3016\n    minValue: 0, // 0\n  },\n  // \n  morality: {\n    baseValue: 80, // 8016\n    intimacyReduction: 0.2, // 0.2\n    minValue: 60, // 60\n    maxValue: 80, // 80\n  },\n};\n\n/**\n * 1\n * \n *\n * @param data \n * @returns 1\n */\nfunction calculateScene1InitValues(data: SchemaType): {\n  initialDependence: number;\n  initialMorality: number;\n  relationshipStage: string;\n  transferDescription: string;\n} {\n  const  = data.. ?? 0;\n  const  = data.. ?? 0;\n\n  // \n  const rawDependence =\n     * SCENE1_INIT_CONFIG.dependence.favorWeight +  * SCENE1_INIT_CONFIG.dependence.intimacyWeight;\n  const initialDependence = Math.min(\n    SCENE1_INIT_CONFIG.dependence.maxValue,\n    Math.max(SCENE1_INIT_CONFIG.dependence.minValue, Math.floor(rawDependence)),\n  );\n\n  // \n  const rawMorality = SCENE1_INIT_CONFIG.morality.baseValue -  * SCENE1_INIT_CONFIG.morality.intimacyReduction;\n  const initialMorality = Math.min(\n    SCENE1_INIT_CONFIG.morality.maxValue,\n    Math.max(SCENE1_INIT_CONFIG.morality.minValue, Math.floor(rawMorality)),\n  );\n\n  // \n  let relationshipStage: string;\n  if ( >= 60) {\n    relationshipStage = '';\n  } else if ( >= 40) {\n    relationshipStage = '';\n  } else if ( >= 20) {\n    relationshipStage = '';\n  } else {\n    relationshipStage = '';\n  }\n\n  // AI\n  const transferDescription = generateTransferDescription(\n    ,\n    ,\n    initialDependence,\n    initialMorality,\n    relationshipStage,\n  );\n\n  return {\n    initialDependence,\n    initialMorality,\n    relationshipStage,\n    transferDescription,\n  };\n}\n\n/**\n * AI\n */\nfunction generateTransferDescription(\n  favor: number,\n  intimacy: number,\n  dependence: number,\n  morality: number,\n  stage: string,\n): string {\n  let description = `\\n`;\n  description += `${favor}${intimacy}${stage}\\n`;\n  description += `${dependence}${morality}\\n\\n`;\n\n  // AI\n  switch (stage) {\n    case '':\n      description += `\"\"`;\n      description += ``;\n      description += ``;\n      break;\n    case '':\n      description += ``;\n      description += ``;\n      break;\n    case '':\n      description += ``;\n      description += ``;\n      break;\n    default:\n      description += ``;\n      description += ``;\n  }\n\n  return description;\n}\n\n/**\n * \n * \n */\nfunction getBodyPartInfluenceLevel(progress: number): {\n  level: string;\n  description: string;\n  acceptanceLevel: string;\n} {\n  if (progress >= 80) {\n    return {\n      level: '',\n      description: '',\n      acceptanceLevel: '',\n    };\n  }\n  if (progress >= 60) {\n    return {\n      level: '',\n      description: '',\n      acceptanceLevel: '',\n    };\n  }\n  if (progress >= 40) {\n    return {\n      level: '',\n      description: '',\n      acceptanceLevel: '',\n    };\n  }\n  if (progress >= 20) {\n    return {\n      level: '',\n      description: '',\n      acceptanceLevel: '',\n    };\n  }\n  return {\n    level: '',\n    description: '',\n    acceptanceLevel: '',\n  };\n}\n\n/**\n * AI\n * AI\n */\nfunction generateBodyPartInfluencePrompt(data: SchemaType): string | null {\n  const progress = data..;\n\n  // \n  const hasProgress = Object.values(progress).some(v => v > 0);\n  if (!hasProgress) return null;\n\n  const parts: string[] = [];\n\n  // \n  const bodyPartConfig: Record<\n    string,\n    {\n      displayName: string;\n      behaviors: Record<string, string>; //  -> \n    }\n  > = {\n    : {\n      displayName: '/',\n      behaviors: {\n        : '',\n        : '',\n        : '',\n        : '',\n        : '',\n      },\n    },\n    : {\n      displayName: '',\n      behaviors: {\n        : '',\n        : '',\n        : '',\n        : '',\n        : '',\n      },\n    },\n    : {\n      displayName: '/',\n      behaviors: {\n        : '',\n        : '',\n        : '',\n        : '',\n        : '',\n      },\n    },\n    : {\n      displayName: '/',\n      behaviors: {\n        : '',\n        : '',\n        : '',\n        : '',\n        : 'play',\n      },\n    },\n    : {\n      displayName: '/',\n      behaviors: {\n        : '',\n        : '{{user}}',\n        : '',\n        : '',\n        : '{{user}}',\n      },\n    },\n  };\n\n  for (const [part, value] of Object.entries(progress)) {\n    if (value <= 0) continue;\n\n    const config = bodyPartConfig[part];\n    if (!config) continue;\n\n    const influence = getBodyPartInfluenceLevel(value);\n    const behaviorExample = config.behaviors[influence.level] || '';\n\n    parts.push(`${config.displayName}${value}%${influence.level}\n${influence.description}\n${influence.acceptanceLevel}\n${behaviorExample}`);\n  }\n\n  if (parts.length === 0) return null;\n\n  return `OOC: \n\n\n\n${parts.join('\\n\\n')}\n\n\n- \n- \n- \n- \"\"\"\"\n- \"\"\n- \n\n\nHTML\n<!--BODY_PROGRESS: +, +-->\n<!--BODY_PROGRESS: +10, +5-->\n\n- \n- 1-15\n- +5\n- +10\n- +15\n- \n-  HTML <!--...-->  [...]`;\n}\n\n/**\n * AI\n * AI\n */\nfunction generateDreamProgressFeedbackPrompt(): string {\n  return `\nHTML\n<!--BODY_PROGRESS: +-->\n\n\n\n- +5\n- +10\n- +15\n\n HTML <!--...-->  [...]\n`;\n}\n\n/**\n * \n */\nfunction getTimePeriodDescription(hour: number): { period: string; lighting: string; atmosphere: string } {\n  if (hour >= 5 && hour < 8) {\n    return { period: '', lighting: '', atmosphere: '' };\n  } else if (hour >= 8 && hour < 12) {\n    return { period: '', lighting: '', atmosphere: '' };\n  } else if (hour >= 12 && hour < 14) {\n    return { period: '', lighting: '', atmosphere: '' };\n  } else if (hour >= 14 && hour < 18) {\n    return { period: '', lighting: '', atmosphere: '' };\n  } else if (hour >= 18 && hour < 20) {\n    return { period: '', lighting: '', atmosphere: '' };\n  } else if (hour >= 20 && hour < 23) {\n    return { period: '', lighting: '', atmosphere: '' };\n  } else {\n    return { period: '', lighting: '', atmosphere: '' };\n  }\n}\n\n/**\n * \n * AI\n */\nfunction getTimeConstraintReminder(hour: number): string {\n  if (hour >= 5 && hour < 12) {\n    return ' /';\n  } else if (hour >= 12 && hour < 18) {\n    return ' /';\n  } else if (hour >= 18 && hour < 22) {\n    return ' /';\n  } else {\n    return ' /';\n  }\n}\n\n/**\n * \n * AI\n */\nfunction getHusbandConstraintReminder(data: SchemaType): string {\n  const  = data..;\n  const  = data..;\n  const  =  >= 23 ||  < 7;\n\n  if ( === '') {\n    return ' ';\n  }\n\n  // \n  if ( &&  === '') {\n    return ' ';\n  }\n\n  // \n  return ` ${}`;\n}\n\n/**\n * \n * \n */\nfunction getRealmConstraintReminder(realm: number, : boolean): string {\n  if (!) {\n    // \n    // Bug #34  textMapping.ts \n    switch (realm) {\n      case 1:\n        return ' ';\n      case 2:\n        return ' ';\n      case 3:\n        return ' ';\n      case 4:\n        return ' ';\n      case 5:\n        return ' ';\n      default:\n        return '';\n    }\n  } else {\n    // \n    // Bug #34  textMapping.ts \n    switch (realm) {\n      case 1:\n        return ' 1';\n      case 2:\n        return ' 2';\n      case 3:\n        return ' 3';\n      case 4:\n        return ' 4';\n      case 5:\n        return ' 5';\n      default:\n        return '';\n    }\n  }\n}\n\n/**\n * D9\n * AI\n */\nfunction getDreamTimePhaseGuidance(\n  hour: number,\n  sceneNum: number,\n): {\n  phase: string;\n  guidance: string;\n  pacing: string;\n} | null {\n  // 22:00-10:0010:00\n  // 22:00-01:00 = 4- \n  // 02:00-04:00 = /3- 12/3/4\n  // 05:00-08:00 = 4- \n  // 09:00-10:00 = 2- \n\n  const isScene1 = sceneNum === 1;\n  const isScene2 = sceneNum === 2;\n  const isScene3 = sceneNum === 3;\n  const isScene4 = sceneNum === 4;\n\n  if (hour >= 22 || hour <= 1) {\n    // 22:00-01:00\n    let guidance: string;\n    if (isScene1) {\n      guidance = `\n\n\n1\n- 16\n- ****\n- ****\n- \n\nAI\n- 16\n- \n- \n- \n- \n\n\n- \n- \n- `;\n    } else if (isScene2) {\n      guidance = `217\n\n\n1E\n\n\nAI\n\n\n- 17\n- \n- \n- \n- \n\n\n117\n\n`;\n    } else if (isScene3) {\n      guidance = `\n\n\n3 - \n- 23\n- \n- \n- ****\n- //\n\nAI\n- \n- \n- ...\n- \n\n\n- \n- \n- /\n\n\n- \n- \n- `;\n    } else if (isScene4) {\n      guidance = `\n\n\n4 - \n- 285\n- \n- \n- \n\nAI\n- \n- \n- \n- \n\n\n- \n- \n- \n\n\n- \n- \n- `;\n    } else {\n      guidance = `\n\n- \n- \n- \n- `;\n    }\n    return {\n      phase: '',\n      guidance,\n      pacing: '',\n    };\n  }\n\n  if (hour >= 2 && hour <= 4) {\n    // 02:00-04:00\n    let guidance: string;\n    if (isScene1) {\n      guidance = `\n\n\n1\n- \n- \n- \n- \n- \n\n\n- 10\n- \n- \" >  > \"\n- \n\n\n- \n- `;\n    } else if (isScene2) {\n      guidance = `\n\n\n\"\"\n\n\n- \n- \"\"\n- \n- \n- \n\n17\n\n`;\n    } else if (isScene3) {\n      // 3\n      guidance = `\n\n\n3\n- \n- \"\"\n- \n- ****\n\n\n- \n- \n- \"\"\n- \n\nAI\n- \n- \n- \n- `;\n    } else if (isScene4) {\n      // 4\n      guidance = `\n\n\n4\n- \n- \n- \n- \n- ****\n\n\n- \n- \n- ...\n- \n\nAI\n- \n- \n- \n- `;\n    } else {\n      guidance = `\n\n- \n- \n- \n- `;\n    }\n    return {\n      phase: isScene2 || isScene3 || isScene4 ? '' : '',\n      guidance,\n      pacing: isScene2 || isScene3 || isScene4 ? '' : '',\n    };\n  }\n\n  if (hour >= 5 && hour <= 6) {\n    // 05:00-06:00\n    let guidance: string;\n    if (isScene1) {\n      guidance = `\n\n\n1\n- \n- \n- AI\n- \n\n\n- \n- \n- \n- \n\nAI\n- \n- \n- `;\n    } else if (isScene2) {\n      guidance = `\n\n\n- \n- \n- \n- \n- \"...\"\n\nNPC\n\n\n17`;\n    } else if (isScene3) {\n      // 305:00-06:00\n      guidance = `\n\n\n3\n- \n- \n- \n- \n- `;\n    } else if (isScene4) {\n      // 405:00-06:00\n      guidance = `\n\n\n4\n- \n- \n- \n- \n- `;\n    } else {\n      guidance = `\n\n- \n- \n- \n- `;\n    }\n    return {\n      phase: '',\n      guidance,\n      pacing: '',\n    };\n  }\n\n  if (hour >= 7 && hour <= 8) {\n    // 07:00-08:00\n    let guidance: string;\n    if (isScene1) {\n      guidance = `\n\n\n1\n- \n- \n- \n\n\n- \n- \n- \"\"\n- \n\nAI\n- \n- \n- `;\n    } else if (isScene2) {\n      guidance = `\n\n\n- \n- \n- \n- \n\n\n\"............\"\n\n`;\n    } else if (isScene3) {\n      // 307:00-08:00\n      guidance = `\n\n\n3\n- \n- \n- `;\n    } else if (isScene4) {\n      // 407:00-08:00\n      guidance = `\n\n\n4\n- \n- \n- `;\n    } else {\n      guidance = `\n\n- \n- \n- \n- `;\n    }\n    return {\n      phase: '',\n      guidance,\n      pacing: '',\n    };\n  }\n\n  if (hour >= 9 && hour <= 10) {\n    // 09:00-10:00\n    let guidance: string;\n    if (isScene1) {\n      guidance = `\n1\n\n - \n- \n- AI\n   \n   \n   \n   \n   \n   \n\n1\n- \n- 16\n- \n\n\n- \n- \n- \n\n\n- \n- \n\n\n- \n- \n- `;\n    } else if (isScene2) {\n      guidance = `\n\n\n\n\n2\n\"\"...\n\n\n- \n- \n- \n- AI\n\n\n\"\"\n\n...`;\n    } else if (isScene3) {\n      // 309:00-10:00\n      guidance = `\n3\n\n - \n- \n- AI\n   \n   \n   \n   \n   \n   \n\n3\n- \n- \n- \n- \n\n\n- \n- \"\"\n- \n\n\n- \n- \n- \n\n\n- \n- \n- `;\n    } else if (isScene4) {\n      // 409:00-10:00\n      guidance = `\n4\n\n - \n- \n- AI\n   \n   \n   \n   \"...\"\n   \n   \n\n4\n- \n- \n- \n- \n\n\n- \n- \"\"\n- \n\n\n- \n- \n- \n\n\n- \n- \n- `;\n    } else {\n      guidance = `\n\n- \n- \n- \n- `;\n    }\n    return {\n      phase: '',\n      guidance,\n      pacing: '',\n    };\n  }\n\n  return null;\n}\n\n/**\n * \n * \n * AI\n *\n * @param age \n * @param sceneNum 1-5\n * @returns \n */\nfunction getDreamConstraintReminder(age: number, sceneNum: number): string {\n  const reminders: string[] = [];\n\n  // 1\n  reminders.push(` \"\"\"\"`);\n\n  // 2\n  reminders.push(` \"\"`);\n\n  // 3\n  reminders.push(` ${age}${age}`);\n\n  // 4\n  reminders.push(` `);\n\n  // 5 - Bug\n  // AI<HusbandThought>\n  // <HusbandThought>\"\"\n  reminders.push(` <HusbandThought> \"\"`);\n  reminders.push(` //* `);\n\n  // 6\n  // AI\n  // \n  reminders.push(``);\n  reminders.push(`AI`);\n  reminders.push(` \"\"\"\"`);\n\n  // \n  if (sceneNum === 2) {\n    reminders.push(` `);\n  } else if (sceneNum === 4) {\n    reminders.push(` `);\n  }\n\n  return reminders.join('\\n');\n}\n\n/**\n * \n * \n */\nfunction getHusbandStatusDescription(data: SchemaType): string {\n  const  = data..;\n  const  = data..;\n\n  const : Record<string, string> = {\n    : `${ < 18 ? '18:00' : ''}`,\n    : '',\n    : '',\n    : '',\n    : '',\n  };\n\n  return [] ?? '';\n}\n\n/**\n * Prompt\n * /AI\n * \n * D9 + \n *\n * @param data \n * @param overridePhase \n */\nfunction generatePhaseAwareStatePrompt(data: SchemaType, overridePhase?: string, overrideScene5?: boolean): string {\n  // Bug #8 5/\n  // \n  const  = overridePhase ?? data..;\n\n  if ( === '') {\n    // Bug #13 5\n    // \"\"5.  true\n    //  shouldEnterScene5 \n    return generateDreamPhasePrompt(data, overrideScene5);\n  } else {\n    return generateDailyPhasePrompt(data);\n  }\n}\n\n/**\n * Prompt\n * \n * AI\n */\nfunction generateDailyPhasePrompt(data: SchemaType): string {\n  const  = data..;\n  const  = data..;\n  const  = data..;\n  const  = data..;\n\n  // \n  const timeInfo = getTimePeriodDescription();\n\n  // \n  const husbandStatus = getHusbandStatusDescription(data);\n\n  // \n  const  = getRealmTitle(, );\n\n  // \n  const timeConstraint = getTimeConstraintReminder();\n  const husbandConstraint = getHusbandConstraintReminder(data);\n  const realmConstraint = getRealmConstraintReminder(, );\n\n  // 2026-01-18\n  // \n  // - \n  // - \n  const  = data..;\n  const  =  !== '';\n  const  =  &&  >= 2; //  dualTrackSystem.ts \n\n  // 2026-01-19\n  // Day 5 \n  //  AI \n  let husbandThoughtConstraint = '';\n  if () {\n    if ( < 2) {\n      husbandThoughtConstraint = '  <HusbandThought> ';\n    } else {\n      //  >= 2\n      if () {\n        // \n        husbandThoughtConstraint =\n          ' <HusbandThought> 30-50';\n      } else {\n        // \n        husbandThoughtConstraint =\n          ' <HusbandThought> 30-50';\n      }\n    }\n  }\n\n  // \n  let prompt = ` - \n${}${timeInfo.period}\n${husbandStatus}\n${ ? '' : ''}\n\n\n- ${}${}/5\n- ${data..}/100\n- ${data..}/100\n\n\n${timeConstraint}\n${husbandConstraint}\n${realmConstraint}${husbandThoughtConstraint ? '\\n' + husbandThoughtConstraint : ''}`;\n\n  // \n  const appearancePrompt = generateAppearanceConstraintPrompt(data);\n  prompt += `\\n\\n${appearancePrompt}`;\n\n  // +\n  const interactionPrompt = generateDetailedInteractionPrompt(data);\n  prompt += `\\n\\n${interactionPrompt}`;\n\n  return prompt;\n}\n\n/**\n * Prompt\n * D9 + \n * \n */\nfunction generateDreamPhasePrompt(data: SchemaType, overrideScene5?: boolean): string {\n  const hour = data..;\n  // Bug #6\n  const day = data.._ ?? data..;\n\n  // \n  let sceneNum = Math.min(day, 4);\n\n  // \n  const scene5Data = data..5 as { ?: boolean } | undefined;\n  console.info(\n    `[generateDreamPhasePrompt] overrideScene5=${overrideScene5}, 5.=${scene5Data?.}, day=${day}, sceneNum=${sceneNum}`,\n  );\n\n  // Bug #13 5\n  // \"\"5.  true\n  //  shouldEnterScene5 \n  if (overrideScene5) {\n    sceneNum = 5;\n    console.info('[Prompt] Bug #13 5');\n  } else if (scene5Data?.) {\n    // 5\n    sceneNum = 5;\n    console.info('[generateDreamPhasePrompt] 5.5');\n  }\n\n  console.info(`[generateDreamPhasePrompt] sceneNum=${sceneNum}`);\n\n  // \n  const sceneConfig = DREAM_SCENE_THEMES[sceneNum];\n\n  // Bug #32 AI\n  // promptInjection  AI  AI \n  //  promptInjection  22:00 AI  23:00\n  //  AI  23:00  22:00\n  const guidanceHour = (hour + 1) % 24;\n\n  // D9\n  const guidance = getDreamTimePhaseGuidance(guidanceHour, sceneNum);\n\n  // 10:00\n  // Bug #32 1AI\n  // 22 hour >= 23 22\n  let hoursRemaining: number;\n  if (hour >= 22) {\n    hoursRemaining = 10 + 24 - hour - 1; // 22  11, 23  10\n  } else if (hour >= 0 && hour < 10) {\n    hoursRemaining = 10 - hour - 1;\n  } else {\n    hoursRemaining = 0;\n  }\n\n  // 24\n  const suWenAppears = sceneNum !== 2 && sceneNum !== 4;\n\n  // \n  const sceneAge = sceneConfig?.age || 25;\n\n  // Prompt\n  let prompt = ` - \n\n\n${sceneConfig?.title || `${sceneNum}`}\n${sceneAge}\n${sceneConfig?.theme || ''}\n${sceneConfig?.atmosphere || ''}`;\n\n  // 1\n  if (sceneNum === 1 && sceneConfig) {\n    prompt += `\n${sceneConfig.identity || ''}\n${sceneConfig.objective || ''}`;\n  }\n\n  // \n  prompt += `\n\n\n${getDreamConstraintReminder(sceneAge, sceneNum)}`;\n\n  // D9\n  if (guidance) {\n    // Bug #32 AI\n    // 23:00 + 1 = 00:00+1\n    const guidanceDay = guidanceHour < hour ? data.. + 1 : data..;\n    const guidanceTimeStr = `Day ${guidanceDay}, ${guidanceHour.toString().padStart(2, '0')}:00`;\n\n    prompt += `\n\n---\n\nOOC: D9 \n\n${guidanceTimeStr}\n${guidance.phase}${guidance.pacing}\n${hoursRemaining}\n\n${guidance.guidance}`;\n  } else {\n    // D9\n    prompt += `\n\n\n- \n- \n- `;\n  }\n\n  return prompt;\n}\n\n/**\n * [] Prompt\n *  generatePhaseAwareStatePrompt\n * @deprecated  generatePhaseAwareStatePrompt \n */\nfunction generateStateConsistencyPrompt(data: SchemaType): string {\n  return generatePhaseAwareStatePrompt(data);\n}\n\n/**\n * 116\n * /\n */\nfunction generateScene1EntryReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const scene = DREAM_SCENE_THEMES[1];\n  // Prompt\n  const continuityPrompt = generateEnhancedMemoryContinuityPrompt(data, 1);\n\n  // 1\n  const initValues = calculateScene1InitValues(data);\n\n  // \n  let initialAttitude: string;\n  switch (initValues.relationshipStage) {\n    case '':\n      initialAttitude = ``;\n      break;\n    case '':\n      initialAttitude = ``;\n      break;\n    case '':\n      initialAttitude = ``;\n      break;\n    default:\n      initialAttitude = ``;\n  }\n\n  const userMessage = `[ - ]\n\n\n\n - \n- ${scene.age}\n- \n- ${scene.identity}\n- ${scene.objective}\n- ${scene.theme}\n- ${scene.atmosphere}\n\n${initValues.transferDescription}\n\n\n${initialAttitude}\n\n\n- ${initValues.initialDependence}30\n- ${initValues.initialMorality}16\n- ${initValues.relationshipStage}\n\n - \n\n- \n- \n- \n- \n\n${continuityPrompt}\n\n\n- \n- \n- \n- \n- \n\nAI\n1. 2-3\n2. \n3. 163\n   - \n   - \n   - \n4. \n5. \n6. \n\n\n- 800-1200\n- \n- \n- \n\n\n- \n- \"\"\n- ${scene.age}\n- \n- \n- \n- /${scene.age}`;\n\n  const prefill = `......\n\n`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 217\n */\nfunction generateScene2EntryReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const scene = DREAM_SCENE_THEMES[2];\n  // Prompt1\n  const continuityPrompt = generateEnhancedMemoryContinuityPrompt(data, 2);\n\n  // \n  const dependence = data..;\n  const morality = data..;\n  const chestProgress = data...;\n\n  // 1\n  const scene1Data = data..1;\n  const hasScene1Memory = scene1Data?. && scene1Data?.;\n\n  let playerRelationship: string;\n  if (hasScene1Memory) {\n    playerRelationship = `16\n\n`;\n  } else {\n    playerRelationship = `\n`;\n  }\n\n  const userMessage = `[ - ]\n\n\n\n - \n- ${scene.age}\n- \n- ${hasScene1Memory ? '1' : ''}\n- ${scene.identity}\n- ${scene.objective}\n- ${scene.theme}\n- ${scene.atmosphere}\n\n\n- ${dependence}\n- ${morality}\n- ${chestProgress}%\n\n\n${playerRelationship}\n\n - \n\n- \n- \n- \n- AI\n\n${continuityPrompt}\n\n\n- \n- \n- \n- \n- \n\nAI - \n1. 2-3\n2. 17\n   - \n   - \n   - E/\n3. ****\n   - \n   - \n   - //\"\"\"\"\"\"\n   - \n   - \n4. ****\n   - \n   - //\n   - \n5. 1\n6. \n\n\n- 800-1200\n- \n- \n- \n\n\n- \n- \n- \n- \"\"\n- ${scene.age}\n- \n- /${scene.age}`;\n\n  const prefill = `......\n\n......`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 323\n */\nfunction generateScene3EntryReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const scene = DREAM_SCENE_THEMES[3];\n  // Prompt1-2\n  const continuityPrompt = generateEnhancedMemoryContinuityPrompt(data, 3);\n\n  // \n  const dependence = data..;\n  const morality = data..;\n  const lowerBodyProgress = data...;\n\n  // \n  const scene1Data = data..1;\n  const scene2Data = data..2;\n  const hasScene1Memory = scene1Data?. && scene1Data?.;\n  const hasScene2Memory = scene2Data?. && scene2Data?.;\n\n  let playerRelationship: string;\n  if (hasScene1Memory && hasScene2Memory) {\n    playerRelationship = `1617\n\n`;\n  } else if (hasScene1Memory) {\n    playerRelationship = `16\n\n`;\n  } else if (hasScene2Memory) {\n    playerRelationship = `17\n\n`;\n  } else {\n    playerRelationship = `\n`;\n  }\n\n  const userMessage = `[ - ]\n\n\n\n - \n- ${scene.age}\n- 23\n- \n- \n- //\n- ${hasScene1Memory || hasScene2Memory ? '' : ''}\n- ${scene.identity}\n- ${scene.objective}\n- ${scene.theme}\n- ${scene.atmosphere}\n\n\n- ${dependence}\n- ${morality}\n- ${lowerBodyProgress}%\n\n\n${playerRelationship}\n\n - \n\n- \n- \n- \n- \n\n${continuityPrompt}\n\n\n- \n- \n- \n- \n- \n\nAI - \n1. 2-3\n2. 23\n   - \n   - \n   - ...\n3. ****\n   - \n   - /\n   - \n4. ****\n   - /\n   - \n   - \n5. \n   - \n   - \n6. \n\n\n- 800-1200\n- \n- \n- \n\n\n- \n- \n- \n- \"\"\n- ${scene.age}\n- \n- /${scene.age}`;\n\n  const prefill = `......\n\n......\n\n............`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 428\n */\nfunction generateScene4EntryReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const scene = DREAM_SCENE_THEMES[4];\n  // Prompt1-3\n  const continuityPrompt = generateEnhancedMemoryContinuityPrompt(data, 4);\n\n  // \n  const dependence = data..;\n  const morality = data..;\n  const analProgress = data...;\n\n  // \n  const scene1Data = data..1;\n  const scene2Data = data..2;\n  const scene3Data = data..3;\n  const hasScene1Memory = scene1Data?. && scene1Data?.;\n  const hasScene2Memory = scene2Data?. && scene2Data?.;\n  const hasScene3Memory = scene3Data?. && scene3Data?.;\n\n  // \n  const memoryCount = [hasScene1Memory, hasScene2Memory, hasScene3Memory].filter(Boolean).length;\n\n  let playerRelationship: string;\n  if (memoryCount === 3) {\n    playerRelationship = `\n\n`;\n  } else if (memoryCount === 2) {\n    playerRelationship = `\n\n`;\n  } else if (memoryCount === 1) {\n    playerRelationship = `\n`;\n  } else {\n    playerRelationship = `\n`;\n  }\n\n  const userMessage = `[ - ]\n\n\n\n - \n- ${scene.age}\n- 5\n- \n- AI\n- \n- ${memoryCount > 0 ? '' : ''}\n- ${scene.identity}\n- ${scene.objective}\n- ${scene.theme}\n- ${scene.atmosphere}\n\n\n- ${dependence}\n- ${morality}\n- ${analProgress}%\n\n\n${playerRelationship}\n\n - \n\n- \n- \n- \n- \n\n${continuityPrompt}\n\n\n- \n- \n- \n- \n- \n\nAI - \n1. 2-3\n2. 28\n   - \n   - AI\n   - \n3. ****\n   - \n   - \n   - \n4. ****\n   - \n   - \n   - \n5. \n   - \n   - \n   - \"\"\n6. \n\n\n- 800-1200\n- \n- \n- \n\n\n- \n- \n- \"\"\n- ${scene.age}\n- \n- /${scene.age}`;\n\n  const prefill = `......\n\n......\n\n............`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 1-4\n */\nfunction generateDreamEntryReplacement(\n  data: SchemaType,\n  sceneNum: number,\n): {\n  userMessage: string;\n  prefill: string;\n} {\n  // 1\n  if (sceneNum === 1) {\n    return generateScene1EntryReplacement(data);\n  }\n\n  // 2\n  if (sceneNum === 2) {\n    return generateScene2EntryReplacement(data);\n  }\n\n  // 3\n  if (sceneNum === 3) {\n    return generateScene3EntryReplacement(data);\n  }\n\n  // 4\n  if (sceneNum === 4) {\n    return generateScene4EntryReplacement(data);\n  }\n\n  const scene = DREAM_SCENE_THEMES[sceneNum];\n  if (!scene) {\n    return {\n      userMessage: '[] ...',\n      prefill: '',\n    };\n  }\n\n  // Prompt\n  const continuityPrompt = generateEnhancedMemoryContinuityPrompt(data, sceneNum);\n\n  const userMessage = `[ - ]\n\n\n\n${sceneNum}${scene.title}\n${scene.age}\n${scene.setting}\n${scene.theme}\n${scene.atmosphere}\n${scene.identity}\n${scene.objective}\n\n\n- \n- \n- \n\n${continuityPrompt}\n\n\n- \n- \n- \n- \n- \n\nAI\n1. 2-3\n2. ${scene.age}\n3. ${scene.age}\n4. \n5. \n6. \n\n\n- \n- ${scene.age}\n- \"\"\n- \n- \"\"\n- /${scene.age}`;\n\n  const prefill = `......\n\n`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 10:00\n */\nfunction generateDreamExitReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const bodySummary = data..;\n\n  // \n  const sortedParts = Object.entries(bodySummary)\n    .filter(([_, v]) => v > 0)\n    .sort(([, a], [, b]) => b - a);\n\n  const developmentSummary =\n    sortedParts.length > 0 ? sortedParts.map(([part, progress]) => `${part}: ${progress}%`).join('') : '';\n\n  // \n  const isFirstAwakening = data...length === 1;\n\n  const userMessage = `[ - ]\n\n\n\n - \n\n- \n- \n- \n- \n- \n\nAI - \n1. 2-3\n2. \n3. \n4. /\n${isFirstAwakening ? `5. ` : ''}\n\n\n${developmentSummary}\n\n\n- \n- \"\"\"\"\n- `;\n\n  const prefill = `......\n\n`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 5\n * 5\n * - \n * - 08:00-19:00\n * - 20:00\n */\nfunction checkScene5Entry(data: SchemaType, userInput: string): boolean {\n  console.info(\n    `[Scene5Entry] : ${data..}, : ${data..}, : \"${userInput}\"`,\n  );\n\n  // 5\n  if (data.. !== '' && data.. !== '') {\n    console.info('[Scene5Entry] ');\n    return false;\n  }\n\n  // 08:00-19:00\n  const hour = data..;\n  if (hour < 8 || hour >= 20) {\n    console.info(`[Scene5Entry] 8-19: ${hour}`);\n    return false;\n  }\n\n  // 2026-01-17: 52\n  // 11-10211-12+\n  // 3\n  const scene5Data = data..5 as { ?: number } | undefined;\n  const entryCount = scene5Data?. ?? 0;\n  if (entryCount >= 2) {\n    console.info(`[Scene5Entry] 5${entryCount}3`);\n    return false;\n  }\n\n  // \n  const hasKeyword = SLEEPING_PILL_KEYWORDS.some(kw => userInput.includes(kw));\n  console.info(`[Scene5Entry] : ${hasKeyword ? '' : ''}`);\n  return hasKeyword;\n}\n\n/**\n * 1-4\n *\n * 2026-01-17 Day 5 1-4\n * 5Day 5 22:00  Day 6 10:00\n *        Day 6\n */\nfunction checkDreamEntry(data: SchemaType, userInput: string): boolean {\n  // 22:00-01:00\n  if (!TimeSystem.isDreamWindowOpen(data)) return false;\n\n  // \n  if (data.. !== '') return false;\n\n  // 2026-01-17 Day 5 1-4\n  // Day 5 22:00+    Day 6 10:00\n  // 5 Day 6  \n  if (data.. === 5) {\n    console.info('[] Day 5 1-4 Day 6');\n    return false;\n  }\n\n  // Bug #16 \n  // \"\"  \"\"\n  return (\n    DREAM_ENTRY_KEYWORDS.some(kw => userInput.includes(kw)) ||\n    DREAM_ENTRY_PATTERNS.some(pattern => pattern.test(userInput))\n  );\n}\n\n/**\n * \n *\n * Bug #18  10:00  09:00\n *  - promptInjection  AI  AI \n * -  09:00  `=== 10`  false\n * - AI \n * -  10:00\n * - index.ts  10:00\n * - AI \n *\n * \n * - 09:00   AI    10:00  \n */\nfunction checkDreamExit(data: SchemaType): boolean {\n  // \n  if (data.. !== '') return false;\n\n  // 510:0020:00\n  if (isInScene5(data)) {\n    return false; // 5\n  }\n\n  // Bug #18 09:00 1-4\n  //  AI  09:00  10:00 \n  //\n  // Bug #20 **** 9  >= 9\n  // 23:00  >= 9 \n  // 22:00/23:00      09:00 \n  // 9 <=  < 22910\n  const hour = data..;\n  return hour >= 9 && hour < 22;\n}\n\n/**\n * 1-4\n * \n *\n *  _  \n * Bug #6\n *\n * 5checkScene5Entry\n * \n */\nfunction getCurrentDreamScene(data: SchemaType): number {\n  // \n  const day = data.._ ?? data..;\n  // Day 1  1, Day 2  2, ...4\n  return Math.min(day, 4);\n}\n\n// AI\nexport const DAILY_DEVELOPMENT_LIMIT = 20;\n\n/**\n * Bug #11  swipe_id  ROLL \n *\n * 5ROLL1  3 2\n *\n * \n *   - CHAT_COMPLETION_PROMPT_READY  AI  MESSAGE_SWIPED\n *   - ROLL  MESSAGE_SWIPED  CHAT_COMPLETION_PROMPT_READY \n *   - \n *\n * \n *   -  schema \"IDswipe_id\"\n *   - CHAT_COMPLETION_PROMPT_READY \n *     1.  message_id  swipe_id\n *     2. \"\"\n *     3.  message_id  swipe_id    ROLL\n *     4.  message_id   \n */\n\n/**\n *  swipe_id\n * @param messageId ID\n * @returns swipe_id 0\n */\nfunction getSwipeId(messageId: number): number {\n  try {\n    const chat = SillyTavern.chat;\n    if (chat && chat[messageId]) {\n      return chat[messageId].swipe_id ?? 0;\n    }\n  } catch (err) {\n    console.warn(`[Prompt]  swipe_id :`, err);\n  }\n  return 0;\n}\n\n/**\n *  ROLL  swipe_id\n * @param data \n * @param currentMessageId ID\n * @returns true  ROLL \n */\nfunction isRollOperationBySwipeId(data: SchemaType, currentMessageId: number): boolean {\n  const scene5Data = data.?.5;\n  if (!scene5Data?.) {\n    //  ROLL\n    return false;\n  }\n\n  const lastRecord = scene5Data.;\n  const lastMessageId = lastRecord.ID;\n  const lastSwipeId = lastRecord.swipe_id;\n\n  // 2026-01-20  AI +1 swipe_id\n  // swipe_id  AI  swipe_id\n  // ROLL  AI  AI  swipe_id\n  const aiReplyFloor = currentMessageId + 1;\n\n  // ID\n  if (lastMessageId === currentMessageId) {\n    //  AI  swipe_id\n    const currentSwipeId = getSwipeId(aiReplyFloor);\n    // swipe_id  ROLLAI \n    if (currentSwipeId !== lastSwipeId) {\n      console.info(\n        `[Prompt]  ROLL :  ${currentMessageId}, AI ${aiReplyFloor}, ` +\n          `swipe_id: ${lastSwipeId}  ${currentSwipeId}`,\n      );\n      return true;\n    }\n    // swipe_id  dryRun \n    console.info(\n      `[Prompt] :  ${currentMessageId}, AI ${aiReplyFloor}, swipe_id=${currentSwipeId}`,\n    );\n    return true;\n  }\n\n  // ID ROLL\n  return false;\n}\n\n/**\n * Bug #22  ROLL \n *\n *  ROLL 1  2  2\n *\n * \n * -  schema \"IDswipe_id\"\n * - CHAT_COMPLETION_PROMPT_READY \n *   1.  message_id  swipe_id\n *   2. \"\"\n *   3.  message_id  swipe_id    ROLL\n *   4.  message_id   \n *\n * @param data \n * @param currentMessageId ID\n * @returns true  ROLL \n */\nfunction isAfterStoryRollOperation(data: SchemaType, currentMessageId: number): boolean {\n  const afterStoryData = data..;\n  if (!afterStoryData?.) {\n    //  ROLL\n    return false;\n  }\n\n  const lastRecord = afterStoryData.;\n  const lastMessageId = lastRecord.ID;\n  const lastSwipeId = lastRecord.swipe_id;\n\n  // ID\n  if (lastMessageId === currentMessageId) {\n    const currentSwipeId = getSwipeId(currentMessageId);\n    // swipe_id  ROLL\n    if (currentSwipeId !== lastSwipeId) {\n      console.info(\n        `[Prompt]  ROLL :  ${currentMessageId}, ` +\n          `swipe_id: ${lastSwipeId}  ${currentSwipeId}`,\n      );\n      return true;\n    }\n    // swipe_id  dryRun \n    console.info(\n      `[Prompt] :  ${currentMessageId}, swipe_id=${currentSwipeId}`,\n    );\n    return true;\n  }\n\n  // ID ROLL\n  return false;\n}\n\n/**\n * Bug #21  v2 ROLL \n *\n *  ROLL \"\"\n * checkDreamExit()   !== ''  false\n * \n *\n * v1  swipe_id  ROLL ROLL \n *  PROMPT_READY  ROLL getSwipeId  0\n *\n * v2 \n * -  AI ID\n * - ROLL  PROMPT_READY \n *   - currentMessageId \n *   - AI  = currentMessageId + 1\n *   -   ROLL\n * -  swipe_id ROLL  PROMPT_READY \n *\n * @param data \n * @param currentMessageId ID\n * @returns 1-5 ROLL null  ROLL\n */\nfunction isDreamExitRoll(data: SchemaType, currentMessageId: number): number | null {\n  const exitRecord = data.._;\n\n  // \n  console.info(`[isDreamExitRoll] :`);\n  console.info(`  - currentMessageId (): ${currentMessageId}`);\n  console.info(`  - : ${data..}`);\n  console.info(`  - exitRecord : ${!!exitRecord}`);\n\n  if (!exitRecord) {\n    console.info(`  - :  null`);\n    return null;\n  }\n\n  // exitRecord.ID  AI  + 1\n  const aiReplyFloor = exitRecord.ID;\n  const sceneNum = exitRecord.;\n\n  // PROMPT_READY currentMessageId \n  // AI  = currentMessageId + 1\n  const expectedAiFloor = currentMessageId + 1;\n\n  console.info(`  -  AI : ${aiReplyFloor}`);\n  console.info(`  - : ${sceneNum}`);\n  console.info(`  -  AI  (currentMessageId+1): ${expectedAiFloor}`);\n\n  // Bug #21  v2\n  //  ROLL \n  //  swipe_id ROLL swipe_id \n  if (aiReplyFloor === expectedAiFloor) {\n    // \n    if (data.. === '') {\n      console.info(\n        `[Prompt]  ROLL : ` +\n          `${sceneNum ?? ''} ${aiReplyFloor}=`,\n      );\n      return sceneNum ?? null;\n    } else {\n      console.info(`  - :  (${data..}) null`);\n    }\n  } else {\n    console.info(`  - :  (${aiReplyFloor} !== ${expectedAiFloor}) null`);\n  }\n\n  return null;\n}\n\n/**\n *  ROLL \n *\n *  ROLL \"\"\n * checkDreamEntry()  checkScene5Entry()   !== ''  false\n * \n *\n *  isDreamExitRoll\n * -  AI ID\n * - ROLL  PROMPT_READY \n *   - currentMessageId \n *   - AI  = currentMessageId + 1\n *   -   ROLL\n *\n * @param data \n * @param currentMessageId ID\n * @returns  { sceneNum, type }  ROLL null  ROLL\n */\nfunction isDreamEntryRoll(\n  data: SchemaType,\n  currentMessageId: number,\n): { sceneNum: number; type: '' | '5' } | null {\n  const entryRecord = data.._;\n\n  console.info(`[isDreamEntryRoll] :`);\n  console.info(`  - currentMessageId (): ${currentMessageId}`);\n  console.info(`  - : ${data..}`);\n  console.info(`  - entryRecord : ${!!entryRecord}`);\n\n  if (!entryRecord) {\n    console.info(`  - :  null`);\n    return null;\n  }\n\n  // entryRecord.ID  AI  + 1\n  const aiReplyFloor = entryRecord.ID;\n  const sceneNum = entryRecord.;\n  const entryType = entryRecord.;\n\n  // PROMPT_READY currentMessageId \n  // AI  = currentMessageId + 1\n  const expectedAiFloor = currentMessageId + 1;\n\n  console.info(`  -  AI : ${aiReplyFloor}`);\n  console.info(`  - : ${sceneNum}`);\n  console.info(`  - : ${entryType}`);\n  console.info(`  -  AI  (currentMessageId+1): ${expectedAiFloor}`);\n\n  //  ROLL \n  if (aiReplyFloor === expectedAiFloor) {\n    // \n    if (data.. === '') {\n      console.info(\n        `[Prompt]  ROLL : ` +\n          `${sceneNum ?? ''}=${entryType ?? ''} ${aiReplyFloor}`,\n      );\n      return {\n        sceneNum: sceneNum ?? 1,\n        type: entryType ?? '',\n      };\n    } else {\n      console.info(`  - :  (${data..}) null`);\n    }\n  } else {\n    console.info(`  - :  (${aiReplyFloor} !== ${expectedAiFloor}) null`);\n  }\n\n  return null;\n}\n\n/**\n *  ROLL \n *\n *  ROLL isActive=true\n * \"\"\"\"\n *\n *  isDreamEntryRoll\n * -  AI ID\n * - ROLL  PROMPT_READY \n *   - currentMessageId \n *   - AI  = currentMessageId + 1\n *   -    ROLL\n *\n * @param data \n * @param currentMessageId ID\n * @returns   ROLL null  ROLL\n */\nfunction isEndingEntryRoll(\n  data: SchemaType,\n  currentMessageId: number,\n): '' | '' | '' | null {\n  const entryRecord = data.._;\n\n  if (!entryRecord) {\n    return null;\n  }\n\n  // entryRecord.ID  AI  + 1\n  const aiReplyFloor = entryRecord.ID;\n  const endingType = entryRecord.;\n\n  // PROMPT_READY currentMessageId \n  // AI  = currentMessageId + 1\n  const expectedAiFloor = currentMessageId + 1;\n\n  //  ROLL \n  if (aiReplyFloor === expectedAiFloor && endingType) {\n    // \n    // isActive\n    const isTrueEndingRoll = endingType === '' && isTrueEndingActive(data);\n    const isPerfectEndingRoll = endingType === '' && isPerfectEndingActive(data);\n    const isFalseEndingRoll = endingType === '' && isFalseEndingActive(data);\n\n    if (isTrueEndingRoll || isPerfectEndingRoll || isFalseEndingRoll) {\n      console.info(`[Prompt]  ROLL : ${endingType} ${aiReplyFloor}`);\n      return endingType;\n    }\n  }\n\n  return null;\n}\n\n// Bug #15  rollOperationFlag \n// swipe_id  CHAT_COMPLETION_PROMPT_READY \n//        AI ROLL\n//  index.ts  MESSAGE_SWIPED \nlet isRollOperation = false;\nexport function setRollOperationFlag(value: boolean): void {\n  isRollOperation = value;\n  console.info(`[Prompt] ROLL ${value ? '' : ''}`);\n}\nfunction checkIsRollOperation(): boolean {\n  return isRollOperation;\n}\nfunction resetRollOperationFlag(): void {\n  if (isRollOperation) {\n    console.info(`[Prompt] ROLL `);\n  }\n  isRollOperation = false;\n}\n\n/**\n * \n * 100%50%\n * @returns null\n */\nfunction checkPureLoveWrongRoute(data: SchemaType): string | null {\n  // \n  if (data..) return null;\n\n  const progress = data..;\n  const parts = ['', '', '', '', ''] as const;\n\n  for (const part of parts) {\n    if (progress[part] >= 100) {\n      console.warn(`[Prompt] ${part}  100%`);\n      return part;\n    }\n  }\n\n  return null;\n}\n\n/**\n * \n * \n *  + 50%\n */\nfunction generatePureLoveWrongRouteReplacement(\n  _data: SchemaType,\n  triggeredPart: string,\n): { userMessage: string; prefill: string } {\n  // \n  const wrongRouteScenes: Record<string, { scenario: string; reaction: string }> = {\n    : {\n      scenario: '',\n      reaction: '',\n    },\n    : {\n      scenario: '',\n      reaction: '',\n    },\n    : {\n      scenario: '',\n      reaction: '',\n    },\n    : {\n      scenario: '',\n      reaction: '',\n    },\n    : {\n      scenario: '',\n      reaction: '',\n    },\n  };\n\n  const scene = wrongRouteScenes[triggeredPart] ?? {\n    scenario: '',\n    reaction: '',\n  };\n\n  const userMessage = `[ - ]\n\n\n\n\n${triggeredPart}\n${scene.scenario}\n${scene.reaction}\n\nAI\n1. \n2. \n3. \n4. \n5. \n\n\n- \n- \n- \"\"\"\"`;\n\n  const prefill = `\n\n`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 5\n */\nfunction isInScene5(data: SchemaType): boolean {\n  if (data.. !== '') return false;\n\n  const scene5Data = data..5 as { ?: boolean } | undefined;\n  return scene5Data?. === true;\n}\n\n/**\n * 5\n *\n * Bug #13 \n * - promptInjection  AI CHAT_COMPLETION_PROMPT_READY\n * -  AI GENERATION_ENDED\n * -  19:00 AI  20:00\n * -  AI \n *\n *  19:00  AI \n * - 19:00   AI    20:00  \n *\n * Bug #20 \n * 508:00-20:00 19:00-21:00 \n *  22:00 5\n */\nfunction checkScene5ForceExit(data: SchemaType): boolean {\n  // 5\n  if (!isInScene5(data)) return false;\n\n  // Bug #13 19:00  AI \n  // Bug #20  19:00-21:59\n  const hour = data..;\n  return hour >= 19 && hour < 22;\n}\n\n/**\n * \n */\nexport function generateFullInjection(\n  data: SchemaType,\n  userInput: string,\n): {\n  systemPrompt: string | null;\n  replaceUserMessage: string | null;\n  prefill: string | null;\n  shouldEnterDream: boolean;\n  shouldExitDream: boolean;\n  shouldEnterScene5: boolean;\n  shouldExitScene5: boolean;\n  shouldProgressScene5Step: boolean;\n  shouldTriggerWrongRoute: boolean;\n  wrongRoutePart: string | null;\n  shouldInterrupt: boolean;\n  interruptionResult: InterruptionCheckResult | null;\n  shouldTriggerBadEnding: boolean;\n  badEndingType: BadEndingType;\n  // \n  shouldTriggerNormalEnding: boolean;\n  normalEndingType: NormalEndingType;\n  // \n  shouldActivateTrueEnding: boolean;\n  shouldProgressTrueEnding: boolean;\n  trueEndingComplete: boolean;\n  // 12\n  shouldActivatePerfectEnding: boolean;\n  shouldProgressPerfectEnding: boolean;\n  perfectEndingComplete: boolean;\n  // \n  shouldActivateFalseEnding: boolean;\n  shouldProgressFalseEnding: boolean;\n  falseEndingComplete: boolean;\n  // \n  shouldActivateAfterStory: boolean;\n  shouldProgressAfterStory: boolean;\n  afterStoryComplete: boolean;\n  isInFreeMode: boolean;\n} {\n  let systemPrompt: string | null = null;\n  let replaceUserMessage: string | null = null;\n  let prefill: string | null = null;\n  let shouldEnterDream = false;\n  // \n  let shouldActivateTrueEndingFlag = false;\n  let shouldProgressTrueEnding = false;\n  let trueEndingComplete = false;\n  // 12\n  let shouldActivatePerfectEndingFlag = false;\n  let shouldProgressPerfectEnding = false;\n  let perfectEndingComplete = false;\n  // \n  let shouldActivateFalseEndingFlag = false;\n  let shouldProgressFalseEnding = false;\n  let falseEndingComplete = false;\n  // \n  let shouldActivateAfterStoryFlag = false;\n  let shouldProgressAfterStory = false;\n  let afterStoryComplete = false;\n  let isInFreeModeFlag = false;\n  let shouldExitDream = false;\n  let shouldEnterScene5 = false;\n  let shouldExitScene5 = false;\n  let shouldProgressScene5Step = false;\n  let shouldTriggerWrongRoute = false;\n  let wrongRoutePart: string | null = null;\n  let shouldInterrupt = false;\n  let interruptionResult: InterruptionCheckResult | null = null;\n  let shouldTriggerBadEnding = false;\n  let badEndingType: BadEndingType = '';\n  let shouldTriggerNormalEnding = false;\n  let normalEndingType: NormalEndingType = '';\n\n  // -1.5. \n  // 2026-01-19 5\n  // \"\"\n  const confusionEndingResult = checkConfusionEnding(data, false); // false = \n  if (confusionEndingResult.triggered) {\n    shouldTriggerBadEnding = true;\n    badEndingType = '';\n    replaceUserMessage = confusionEndingResult.replaceUserMessage;\n    console.info(`[Prompt] `);\n    // \n    return {\n      systemPrompt: null,\n      replaceUserMessage,\n      prefill: null,\n      shouldEnterDream: false,\n      shouldExitDream: false,\n      shouldEnterScene5: false,\n      shouldExitScene5: false,\n      shouldProgressScene5Step: false,\n      shouldTriggerWrongRoute: false,\n      wrongRoutePart: null,\n      shouldInterrupt: false,\n      interruptionResult: null,\n      shouldTriggerBadEnding,\n      badEndingType,\n      shouldTriggerNormalEnding: false,\n      normalEndingType: '',\n      shouldActivateTrueEnding: false,\n      shouldProgressTrueEnding: false,\n      trueEndingComplete: false,\n      shouldActivatePerfectEnding: false,\n      shouldProgressPerfectEnding: false,\n      perfectEndingComplete: false,\n      shouldActivateFalseEnding: false,\n      shouldProgressFalseEnding: false,\n      falseEndingComplete: false,\n      shouldActivateAfterStory: false,\n      shouldProgressAfterStory: false,\n      afterStoryComplete: false,\n      isInFreeMode: false,\n    };\n  }\n\n  // -1.6 5\n  // 2026-01-19 5\n  // >=100100%\n  if (isInScene5(data) && data.. === '') {\n    const currentConfusion = data..;\n    const scene5Data = data..5 as { ?: number } | undefined;\n    const currentStep = scene5Data?. ?? 0;\n\n    // 3-5100\n    if (currentStep >= 3 && currentStep <= 5 && detectWeddingInterruption(userInput)) {\n      console.warn(`[Prompt] 5${currentStep}`);\n\n      // 100markConfusionEnding=true\n      data.. = 100;\n      markConfusionEnding(data, '');\n\n      // \n      applyConfusionEndingState(data);\n      const confusionResult = checkConfusionEnding(data, true); // true = \n\n      return {\n        systemPrompt: null,\n        replaceUserMessage: confusionResult.replaceUserMessage,\n        prefill: null,\n        shouldEnterDream: false,\n        shouldExitDream: false,\n        shouldEnterScene5: false,\n        shouldExitScene5: false,\n        shouldProgressScene5Step: false,\n        shouldTriggerWrongRoute: false,\n        wrongRoutePart: null,\n        shouldInterrupt: false,\n        interruptionResult: null,\n        shouldTriggerBadEnding: true,\n        badEndingType: '',\n        shouldTriggerNormalEnding: false,\n        normalEndingType: '',\n        shouldActivateTrueEnding: false,\n        shouldProgressTrueEnding: false,\n        trueEndingComplete: false,\n        shouldActivatePerfectEnding: false,\n        shouldProgressPerfectEnding: false,\n        perfectEndingComplete: false,\n        shouldActivateFalseEnding: false,\n        shouldProgressFalseEnding: false,\n        falseEndingComplete: false,\n        shouldActivateAfterStory: false,\n        shouldProgressAfterStory: false,\n        afterStoryComplete: false,\n        isInFreeMode: false,\n      };\n    }\n\n    // \n    if (detectSexualBehavior(userInput)) {\n      const increment = getViolationIncrement(data);\n      const predictedConfusion = currentConfusion + increment;\n\n      if (predictedConfusion >= 100) {\n        console.warn(\n          `[Prompt] 5${predictedConfusion}${currentConfusion}+${increment}`,\n        );\n\n        // 100\n        data.. = 100;\n        markConfusionEnding(data, '');\n\n        // \n        applyConfusionEndingState(data);\n        const confusionResult = checkConfusionEnding(data, true); // true = \n\n        return {\n          systemPrompt: null,\n          replaceUserMessage: confusionResult.replaceUserMessage,\n          prefill: null,\n          shouldEnterDream: false,\n          shouldExitDream: false,\n          shouldEnterScene5: false,\n          shouldExitScene5: false,\n          shouldProgressScene5Step: false,\n          shouldTriggerWrongRoute: false,\n          wrongRoutePart: null,\n          shouldInterrupt: false,\n          interruptionResult: null,\n          shouldTriggerBadEnding: true,\n          badEndingType: '',\n          shouldTriggerNormalEnding: false,\n          normalEndingType: '',\n          shouldActivateTrueEnding: false,\n          shouldProgressTrueEnding: false,\n          trueEndingComplete: false,\n          shouldActivatePerfectEnding: false,\n          shouldProgressPerfectEnding: false,\n          perfectEndingComplete: false,\n          shouldActivateFalseEnding: false,\n          shouldProgressFalseEnding: false,\n          falseEndingComplete: false,\n          shouldActivateAfterStory: false,\n          shouldProgressAfterStory: false,\n          afterStoryComplete: false,\n          isInFreeMode: false,\n        };\n      }\n    }\n  }\n\n  // -1.5 Bug #24 100\n  //  AI \n  // 100100%\n  // userInput \n  // //\n  if (data.. === '' && data..) {\n    const suspicionResult = calculateSuspicionIncrease(data, userInput);\n    const predictedSuspicion = data.. + suspicionResult.;\n\n    if (predictedSuspicion >= 100 && data.. === '') {\n      console.warn(\n        `[Prompt] ${predictedSuspicion}${data..}+${suspicionResult.}`,\n      );\n\n      //  checkBadEnding \n      // Bug #XX 100\n      data.. = 100;\n      const badEndingResult = checkBadEnding(data);\n\n      if (badEndingResult.triggered) {\n        // Bug #XX \n        applyBadEndingState(data, badEndingResult.type);\n        return {\n          systemPrompt: null,\n          replaceUserMessage: badEndingResult.replaceUserMessage,\n          prefill: null,\n          shouldEnterDream: false,\n          shouldExitDream: false,\n          shouldEnterScene5: false,\n          shouldExitScene5: false,\n          shouldProgressScene5Step: false,\n          shouldTriggerWrongRoute: false,\n          wrongRoutePart: null,\n          shouldInterrupt: false,\n          interruptionResult: null,\n          shouldTriggerBadEnding: true,\n          badEndingType: badEndingResult.type,\n          shouldTriggerNormalEnding: false,\n          normalEndingType: '',\n          shouldActivateTrueEnding: false,\n          shouldProgressTrueEnding: false,\n          trueEndingComplete: false,\n          shouldActivatePerfectEnding: false,\n          shouldProgressPerfectEnding: false,\n          perfectEndingComplete: false,\n          shouldActivateFalseEnding: false,\n          shouldProgressFalseEnding: false,\n          falseEndingComplete: false,\n          shouldActivateAfterStory: false,\n          shouldProgressAfterStory: false,\n          afterStoryComplete: false,\n          isInFreeMode: false,\n        };\n      }\n    }\n  }\n\n  // -1. >=100\n  // \n  const badEndingResult = checkBadEnding(data);\n  if (badEndingResult.triggered) {\n    shouldTriggerBadEnding = true;\n    badEndingType = badEndingResult.type;\n    replaceUserMessage = badEndingResult.replaceUserMessage;\n    // Bug #XX \n    applyBadEndingState(data, badEndingResult.type);\n    console.info(`[Prompt] /${badEndingResult.type}`);\n    // \n    return {\n      systemPrompt: null,\n      replaceUserMessage,\n      prefill: null,\n      shouldEnterDream: false,\n      shouldExitDream: false,\n      shouldEnterScene5: false,\n      shouldExitScene5: false,\n      shouldProgressScene5Step: false,\n      shouldTriggerWrongRoute: false,\n      wrongRoutePart: null,\n      shouldInterrupt: false,\n      interruptionResult: null,\n      shouldTriggerBadEnding,\n      badEndingType,\n      shouldTriggerNormalEnding: false,\n      normalEndingType: '',\n      shouldActivateTrueEnding: false,\n      shouldProgressTrueEnding: false,\n      trueEndingComplete: false,\n      shouldActivatePerfectEnding: false,\n      shouldProgressPerfectEnding: false,\n      perfectEndingComplete: false,\n      shouldActivateFalseEnding: false,\n      shouldProgressFalseEnding: false,\n      falseEndingComplete: false,\n      shouldActivateAfterStory: false,\n      shouldProgressAfterStory: false,\n      afterStoryComplete: false,\n      isInFreeMode: false,\n    };\n  }\n\n  // -0.5. \n  //  index.ts  checkEnding() \n  // \n  if (isInNormalEndingLock(data)) {\n    const normalEndingResult = checkNormalEnding(data);\n    shouldTriggerNormalEnding = true;\n    normalEndingType = normalEndingResult.type;\n    replaceUserMessage = normalEndingResult.replaceUserMessage;\n    console.info(`[Prompt] ${normalEndingResult.type}`);\n    // \n    return {\n      systemPrompt: null,\n      replaceUserMessage,\n      prefill: null,\n      shouldEnterDream: false,\n      shouldExitDream: false,\n      shouldEnterScene5: false,\n      shouldExitScene5: false,\n      shouldProgressScene5Step: false,\n      shouldTriggerWrongRoute: false,\n      wrongRoutePart: null,\n      shouldInterrupt: false,\n      interruptionResult: null,\n      shouldTriggerBadEnding: false,\n      badEndingType: '',\n      shouldTriggerNormalEnding,\n      normalEndingType,\n      shouldActivateTrueEnding: false,\n      shouldProgressTrueEnding: false,\n      trueEndingComplete: false,\n      shouldActivatePerfectEnding: false,\n      shouldProgressPerfectEnding: false,\n      perfectEndingComplete: false,\n      shouldActivateFalseEnding: false,\n      shouldProgressFalseEnding: false,\n      falseEndingComplete: false,\n      shouldActivateAfterStory: false,\n      shouldProgressAfterStory: false,\n      afterStoryComplete: false,\n      isInFreeMode: false,\n    };\n  }\n\n  // 0. \n  const triggeredPart = checkPureLoveWrongRoute(data);\n  if (triggeredPart) {\n    shouldTriggerWrongRoute = true;\n    wrongRoutePart = triggeredPart;\n    const replacement = generatePureLoveWrongRouteReplacement(data, triggeredPart);\n    replaceUserMessage = replacement.userMessage;\n    prefill = replacement.prefill;\n    console.info(`[Prompt] ${triggeredPart}`);\n    // \n    return {\n      systemPrompt: null,\n      replaceUserMessage,\n      prefill,\n      shouldEnterDream: false,\n      shouldExitDream: false,\n      shouldEnterScene5: false,\n      shouldExitScene5: false,\n      shouldProgressScene5Step: false,\n      shouldTriggerWrongRoute,\n      wrongRoutePart,\n      shouldInterrupt: false,\n      interruptionResult: null,\n      shouldTriggerBadEnding: false,\n      badEndingType: '',\n      shouldTriggerNormalEnding: false,\n      normalEndingType: '',\n      shouldActivateTrueEnding: false,\n      shouldProgressTrueEnding: false,\n      trueEndingComplete: false,\n      shouldActivatePerfectEnding: false,\n      shouldProgressPerfectEnding: false,\n      perfectEndingComplete: false,\n      shouldActivateFalseEnding: false,\n      shouldProgressFalseEnding: false,\n      falseEndingComplete: false,\n      shouldActivateAfterStory: false,\n      shouldProgressAfterStory: false,\n      afterStoryComplete: false,\n      isInFreeMode: false,\n    };\n  }\n\n  // 0.4 Bug #005 AI\n  // \n  const isDreamExitMessage = data.. !== undefined;\n  if (isDreamExitMessage) {\n    console.info(`[Prompt] `);\n  }\n\n  if (userInput && !isDreamExitMessage && !shouldSkipDangerousContentDetection(data)) {\n    // Bug #005 \n    const currentSuspicion = data..;\n    const dangerResult = detectDangerousContent(userInput, currentSuspicion);\n\n    // BAD END\n    if (dangerResult.action === 'TRIGGER_BAD_END') {\n      console.error(`[Prompt]  : ${dangerResult.category}`);\n      data.. = '';\n      data.. = '';\n\n      return {\n        systemPrompt: null,\n        replaceUserMessage: dangerResult.message || '...',\n        prefill: null,\n        shouldEnterDream: false,\n        shouldExitDream: false,\n        shouldEnterScene5: false,\n        shouldExitScene5: false,\n        shouldProgressScene5Step: false,\n        shouldTriggerWrongRoute: false,\n        wrongRoutePart: null,\n        shouldInterrupt: true,\n        interruptionResult: null,\n        shouldTriggerBadEnding: true,\n        badEndingType: '',\n        shouldTriggerNormalEnding: false,\n        normalEndingType: '',\n        shouldActivateTrueEnding: false,\n        shouldProgressTrueEnding: false,\n        trueEndingComplete: false,\n        shouldActivatePerfectEnding: false,\n        shouldProgressPerfectEnding: false,\n        perfectEndingComplete: false,\n        shouldActivateFalseEnding: false,\n        shouldProgressFalseEnding: false,\n        falseEndingComplete: false,\n        shouldActivateAfterStory: false,\n        shouldProgressAfterStory: false,\n        afterStoryComplete: false,\n        isInFreeMode: false,\n      };\n    }\n\n    // \n    if (dangerResult.action === 'FORCE_CORRECTION' && dangerResult.correctedPrompt) {\n      console.warn(`[Prompt] : ${dangerResult.category}`);\n      // \n      if (dangerResult.penalties?.) {\n        if (data.. === '') {\n          data.. = Math.min(100, data.. + dangerResult.penalties.);\n          console.info(`[Prompt] +${dangerResult.penalties.}`);\n        } else {\n          data.. = Math.min(100, data.. + dangerResult.penalties.);\n          console.info(`[Prompt] +${dangerResult.penalties.}`);\n        }\n      }\n      replaceUserMessage = dangerResult.correctedPrompt;\n    }\n\n    // \n    if (dangerResult.action === 'WARNING_ONLY') {\n      console.info(`[Prompt] : ${dangerResult.category}`);\n      // \n      if (dangerResult.penalties?.) {\n        if (data..) {\n          data.. = Math.min(100, data.. + 5);\n        } else {\n          data.. = Math.min(100, data.. + 5);\n        }\n      }\n    }\n  }\n\n  // 0.45 BUG-006\n  // \"\"\"\"\n  // AI\n  if (userInput) {\n    const timeJumpResult = TimeSystem.detectTimeJumpDescription(userInput, data..);\n    if (timeJumpResult.detected && timeJumpResult.reminderPrompt) {\n      console.info(`[Prompt] : \"${timeJumpResult.matchedKeyword}\"`);\n      // AI\n      if (systemPrompt) {\n        systemPrompt = systemPrompt + '\\n\\n' + timeJumpResult.reminderPrompt;\n      } else {\n        systemPrompt = timeJumpResult.reminderPrompt;\n      }\n    }\n  }\n\n  // 0.5 \n  // \n  if (data.. === '' && userInput && !isDreamExitMessage) {\n    const boundaryResult = checkBoundaryInterruption(data, userInput);\n\n    // \n    if (boundaryResult.violatedParts.length > 0) {\n      interruptionResult = boundaryResult;\n\n      //  + \n      if (boundaryResult.wasInterrupted && boundaryResult.correctionPrompt) {\n        shouldInterrupt = true;\n        replaceUserMessage = boundaryResult.correctionPrompt;\n        console.info(\n          `[Prompt] ${boundaryResult.severity}` +\n            `[${boundaryResult.violatedParts.join(', ')}]` +\n            `${boundaryResult.realmGap}`,\n        );\n        // \n        return {\n          systemPrompt: null,\n          replaceUserMessage,\n          prefill: null,\n          shouldEnterDream: false,\n          shouldExitDream: false,\n          shouldEnterScene5: false,\n          shouldExitScene5: false,\n          shouldProgressScene5Step: false,\n          shouldTriggerWrongRoute: false,\n          wrongRoutePart: null,\n          shouldInterrupt,\n          interruptionResult,\n          shouldTriggerBadEnding: false,\n          badEndingType: '',\n          shouldTriggerNormalEnding: false,\n          normalEndingType: '',\n          shouldActivateTrueEnding: false,\n          shouldProgressTrueEnding: false,\n          trueEndingComplete: false,\n          shouldActivatePerfectEnding: false,\n          shouldProgressPerfectEnding: false,\n          perfectEndingComplete: false,\n          shouldActivateFalseEnding: false,\n          shouldProgressFalseEnding: false,\n          falseEndingComplete: false,\n          shouldActivateAfterStory: false,\n          shouldProgressAfterStory: false,\n          afterStoryComplete: false,\n          isInFreeMode: false,\n        };\n      }\n\n      // \n      if (boundaryResult.correctionPrompt && !boundaryResult.wasInterrupted) {\n        console.info(\n          `[Prompt] ${boundaryResult.severity}` +\n            `[${boundaryResult.violatedParts.join(', ')}]` +\n            ``,\n        );\n        // AI\n        systemPrompt = boundaryResult.correctionPrompt;\n      }\n    }\n  }\n\n  // 1. 520:00\n  if (checkScene5ForceExit(data)) {\n    shouldExitScene5 = true;\n    const replacement = generateScene5ForceExitReplacementNew(data);\n    replaceUserMessage = replacement.userMessage;\n    prefill = replacement.prefill;\n    console.info('[Prompt] 520:00');\n  }\n\n  // 1.5.  ROLL \n  //  ROLL \"\"\n  const entryRollMessageId = getLastMessageId();\n  const dreamEntryRollInfo = isDreamEntryRoll(data, entryRollMessageId);\n\n  // 2. 5  ROLL\n  if (!shouldExitScene5 && (checkScene5Entry(data, userInput) || dreamEntryRollInfo?.type === '5')) {\n    shouldEnterScene5 = true;\n    const replacement = generateScene5EntryReplacementNew(data);\n    replaceUserMessage = replacement.userMessage;\n    prefill = replacement.prefill;\n    console.info(`[Prompt] 5${dreamEntryRollInfo ? 'ROLL ' : ''}`);\n  }\n\n  // 2.5 5512\n  if (!shouldExitScene5 && !shouldEnterScene5 && isInScene5(data)) {\n    // 2.5.1 5/\n    // \n    const violationResult = checkScene5Violations(data, userInput);\n\n    if (violationResult.shouldMarkConfusion) {\n      // \n      markConfusionEnding(data, violationResult.reason!);\n      console.warn(`[Prompt] 5=${violationResult.reason}`);\n      // 51\n    } else if (violationResult.shouldWarn && violationResult.warningMessage) {\n      // +\n      console.warn(`[Prompt] 5`);\n      // AI\n      // \n      if (systemPrompt) {\n        systemPrompt = `${systemPrompt}\\n\\n---\\n\\n5\\n${violationResult.warningMessage}`;\n      } else {\n        systemPrompt = `5\\n${violationResult.warningMessage}`;\n      }\n    }\n\n    const completion = calculateScene5CompletionNew(data);\n    // 12\n    if (!completion.isStepsComplete && completion.currentStep < 12) {\n      // Bug #15  ROLL\n      //  swipe_id  PROMPT_READY  AI \n      //  index.ts  MESSAGE_SWIPED \n      const isRoll = checkIsRollOperation();\n\n      if (isRoll && completion.currentStep > 0) {\n        //  ROLL \n        // 1.  1 prompt\n        // 2.  shouldProgressScene5Step\n        // index.ts MESSAGE_SWIPED  completion.currentStep \n        // \n        const replacement = generateScene5StepReplacement(data, userInput);\n        replaceUserMessage = replacement.userMessage;\n        if (replacement.prefill) {\n          prefill = replacement.prefill;\n        }\n        // Bug #15 ROLL index.ts \n        shouldProgressScene5Step = false;\n        console.info(\n          `[Prompt] ROLL  ${completion.currentStep}/12  promptindex.ts `,\n        );\n      } else {\n        //  prompt\n        shouldProgressScene5Step = true;\n        const replacement = generateScene5StepReplacement(data, userInput);\n        replaceUserMessage = replacement.userMessage;\n        if (replacement.prefill) {\n          prefill = replacement.prefill;\n        }\n        console.info(`[Prompt] 5${completion.currentStep + 1}/12`);\n      }\n    } else if (completion.isStepsComplete || completion.currentStep >= 12) {\n      // 2026-01-17 12\n      // prompt\n      const replacement = generateScene5FreePlayReplacement(data, userInput);\n      replaceUserMessage = replacement.userMessage;\n      if (replacement.prefill) {\n        prefill = replacement.prefill;\n      }\n      console.info(\n        `[Prompt] 5=${completion.completionPercent}%=${19 - data..}19:00`,\n      );\n    }\n  }\n\n  // 3. 1-4  ROLL\n  const isNormalDreamRoll = dreamEntryRollInfo?.type === '';\n  if (!shouldEnterScene5 && !shouldExitScene5 && (checkDreamEntry(data, userInput) || isNormalDreamRoll)) {\n    shouldEnterDream = true;\n    // ROLL \n    const sceneNum = isNormalDreamRoll ? dreamEntryRollInfo.sceneNum : getCurrentDreamScene(data);\n    const replacement = generateDreamEntryReplacement(data, sceneNum);\n    replaceUserMessage = replacement.userMessage;\n    prefill = replacement.prefill;\n    console.info(`[Prompt] ${sceneNum}${isNormalDreamRoll ? 'ROLL ' : ''}`);\n  }\n\n  // 4. 10:00   ROLL \n  // Bug #21  ROLL1-4  5\n  //  ROLL \"\"checkDreamExit  false\n  //  ROLL\n  const currentMessageId = getLastMessageId();\n  const dreamExitRollSceneNum = isDreamExitRoll(data, currentMessageId);\n\n  // 5 ROLL\n  if (dreamExitRollSceneNum === 5) {\n    shouldExitScene5 = true;\n    const replacement = generateScene5ForceExitReplacementNew(data);\n    replaceUserMessage = replacement.userMessage;\n    prefill = replacement.prefill;\n    console.info(`[Prompt] 5ROLL `);\n  }\n  // 1-4 ROLL\n  else if (!shouldExitScene5 && (checkDreamExit(data) || dreamExitRollSceneNum !== null)) {\n    shouldExitDream = true;\n    const replacement = generateDreamExitReplacement(data);\n    replaceUserMessage = replacement.userMessage;\n    prefill = replacement.prefill;\n    console.info(`[Prompt] ${dreamExitRollSceneNum !== null ? 'ROLL ' : ''}`);\n  }\n\n  // 5. AI\n  //  AI \n  if (data..) {\n    const bodyInfluencePrompt = generateBodyPartInfluencePrompt(data);\n    if (bodyInfluencePrompt) {\n      systemPrompt = bodyInfluencePrompt;\n    }\n  }\n\n  // 5.5 AI\n  // Bug #8 \n  if (data.. === '' || shouldEnterScene5 || shouldEnterDream) {\n    const dreamFeedbackPrompt = generateDreamProgressFeedbackPrompt();\n    if (systemPrompt) {\n      systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${dreamFeedbackPrompt}`;\n    } else {\n      systemPrompt = dreamFeedbackPrompt;\n    }\n  }\n\n  // 6. Prompt/\n  // D9Prompt\n  // Bug #8 ''\n  // AI\"\"\"\"\n  // Bug #13  shouldEnterScene5 51\n  const phaseOverride = shouldEnterScene5 || shouldEnterDream ? '' : undefined;\n  const consistencyPrompt = generatePhaseAwareStatePrompt(data, phaseOverride, shouldEnterScene5);\n  console.info(\n    `[Prompt] : ${data..}${phaseOverride ? ` (: ${phaseOverride})` : ''}`,\n  );\n\n  if (systemPrompt) {\n    systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${consistencyPrompt}`;\n  } else {\n    systemPrompt = consistencyPrompt;\n  }\n\n  // 6.5 5\n  // AI\n  const confusionForeshadowing = getConfusionForeshadowing(data);\n  if (confusionForeshadowing && data.. === '') {\n    if (systemPrompt) {\n      systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${confusionForeshadowing}`;\n    } else {\n      systemPrompt = confusionForeshadowing;\n    }\n    console.info(`[Prompt] `);\n  }\n\n  // 7.  ROLL \n  const endingRollMessageId = getLastMessageId();\n  const endingEntryRollType = isEndingEntryRoll(data, endingRollMessageId);\n\n  // Bug #39 \n  // \"\"\n  // \n  const endingGuidance = getEndingGuidance(data);\n  if (endingGuidance) {\n    if (systemPrompt) {\n      systemPrompt = `${endingGuidance}\\n\\n---\\n\\n${systemPrompt}`;\n    } else {\n      systemPrompt = endingGuidance;\n    }\n    console.info(`[Prompt] Bug #39 ${data..}`);\n  }\n\n  // \n  // Bug #40 AI\n  // AI\n  const isInDreamOrEntering = data.. === '' || shouldEnterDream || shouldEnterScene5;\n  let currentDreamSceneNumber: number | undefined; // \n\n  // Bug #41  getDreamSceneGuidance\n  // AIAI\n  if (isInDreamOrEntering) {\n    // \n    if (shouldEnterScene5) {\n      currentDreamSceneNumber = 5;\n    } else {\n      currentDreamSceneNumber = getCurrentDreamScene(data);\n    }\n\n    // Bug #41 AI\n    const dreamSceneGuidance = getDreamSceneGuidance(data, currentDreamSceneNumber);\n    if (dreamSceneGuidance) {\n      if (systemPrompt) {\n        systemPrompt = `${dreamSceneGuidance}\\n\\n---\\n\\n${systemPrompt}`;\n      } else {\n        systemPrompt = dreamSceneGuidance;\n      }\n      const completedScenes = data.. || [];\n      console.info(\n        `[Prompt] : ${currentDreamSceneNumber}: [${completedScenes.join(', ')}]`,\n      );\n    }\n  }\n\n  // Bug #40 \n  // AI\n  // \n  // - \n  // - AI\n  if (data..) {\n    const dreamHistoryBackground = generateDreamHistoryBackground(data, currentDreamSceneNumber);\n    if (dreamHistoryBackground) {\n      if (systemPrompt) {\n        systemPrompt = `${dreamHistoryBackground}\\n\\n---\\n\\n${systemPrompt}`;\n      } else {\n        systemPrompt = dreamHistoryBackground;\n      }\n      const completedScenes = data.. || [];\n      const excludeInfo = currentDreamSceneNumber ? `${currentDreamSceneNumber}` : '';\n      console.info(`[Prompt] : [${completedScenes.join(', ')}]${excludeInfo}`);\n    }\n  }\n\n  // 7.1 12\n  // Day 5, 11:00+ + 5 + =3\n  const isPerfectEndingRoll = endingEntryRollType === '';\n  if (!isPerfectEndingActive(data) && shouldActivatePerfectEnding(data)) {\n    shouldActivatePerfectEndingFlag = true;\n    // 12\n    const entryReplacement = generatePerfectEndingEntryReplacement();\n    replaceUserMessage = entryReplacement.userMessage;\n    prefill = entryReplacement.prefill;\n    console.info('[Prompt] 12');\n  }\n  // ROLL  ROLL\n  else if (isPerfectEndingRoll) {\n    const entryReplacement = generatePerfectEndingEntryReplacement();\n    replaceUserMessage = entryReplacement.userMessage;\n    prefill = entryReplacement.prefill;\n    console.info('[Prompt] ROLL ');\n  }\n  // \n  else if (isPerfectEndingActive(data)) {\n    const state = getPerfectEndingState(data);\n\n    // \n    if (state.isComplete) {\n      perfectEndingComplete = true;\n      const completeMessage = generatePerfectEndingComplete();\n      replaceUserMessage = completeMessage;\n      console.info('[Prompt] ');\n    } else {\n      // 21:00  23:00\n      const isFreeTime = isPerfectEndingFreeTime(data);\n\n      if (isFreeTime) {\n        // \n        const freeTimePrompt = generatePerfectFreeTimePrompt(data..);\n        if (systemPrompt) {\n          systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${freeTimePrompt}`;\n        } else {\n          systemPrompt = freeTimePrompt;\n        }\n        console.info(`[Prompt] ${data..}:00`);\n      } else {\n        shouldProgressPerfectEnding = true;\n        // AIPrompt\n        const perfectEndingPrompt = generatePerfectEndingPrompt(state, userInput);\n        if (systemPrompt) {\n          systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${perfectEndingPrompt}`;\n        } else {\n          systemPrompt = perfectEndingPrompt;\n        }\n        console.info(\n          `[Prompt] ${state.currentPhase}${state.currentPhase <= 11 ? ['', '', '', '', '', '', '', '', '', '', '', ''][state.currentPhase] : ''}${state.turnsInPhase}`,\n        );\n      }\n    }\n  }\n\n  // 7.2 Day 5, 11:00+ <3\n  // \n  const isTrueEndingRoll = endingEntryRollType === '';\n  if (!isPerfectEndingActive(data) && !isTrueEndingActive(data) && shouldActivateTrueEnding(data)) {\n    shouldActivateTrueEndingFlag = true;\n    // \n    const entryReplacement = generateTrueEndingEntryReplacement(data);\n    replaceUserMessage = entryReplacement.userMessage;\n    prefill = entryReplacement.prefill;\n    console.info('[Prompt] 10');\n  }\n  // ROLL  ROLL\n  else if (isTrueEndingRoll && !isPerfectEndingActive(data)) {\n    const entryReplacement = generateTrueEndingEntryReplacement(data);\n    replaceUserMessage = entryReplacement.userMessage;\n    prefill = entryReplacement.prefill;\n    console.info('[Prompt] ROLL ');\n  }\n  // \n  else if (isTrueEndingActive(data) && !isPerfectEndingActive(data)) {\n    const state = getTrueEndingState(data);\n\n    // \n    if (state.isComplete) {\n      trueEndingComplete = true;\n      const completeMessage = generateTrueEndingComplete(data);\n      replaceUserMessage = completeMessage;\n      console.info('[Prompt] ');\n    } else {\n      // 21:00  23:00\n      const isFreeTime = isFreeTimeHour(data);\n      const guidanceType = getGuidanceType(data);\n\n      if (isFreeTime) {\n        // \n        const freeTimePrompt = generateTimeBasedPrompt(data, state, userInput);\n        if (freeTimePrompt) {\n          if (systemPrompt) {\n            systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${freeTimePrompt}`;\n          } else {\n            systemPrompt = freeTimePrompt;\n          }\n        }\n        console.info(`[Prompt] ${data..}:00`);\n      } else {\n        shouldProgressTrueEnding = true;\n        // AIPrompt\n        const trueEndingPrompt =\n          generateTimeBasedPrompt(data, state, userInput) || generateTrueEndingPrompt(state, userInput);\n        if (systemPrompt) {\n          systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${trueEndingPrompt}`;\n        } else {\n          systemPrompt = trueEndingPrompt;\n        }\n        console.info(\n          `[Prompt] ${state.currentPhase}${state.turnsInPhase}${guidanceType}`,\n        );\n      }\n    }\n  }\n\n  // 8. Day 5, 20:00+ \n  // \n  const isFalseEndingRoll = endingEntryRollType === '';\n  if (!isFalseEndingActive(data) && shouldActivateFalseEnding(data)) {\n    shouldActivateFalseEndingFlag = true;\n    // \n    const entryReplacement = generateFalseEndingEntryReplacement();\n    replaceUserMessage = entryReplacement.userMessage;\n    prefill = entryReplacement.prefill;\n    console.info('[Prompt] ');\n  }\n  // ROLL  ROLL\n  else if (isFalseEndingRoll) {\n    // ROLL \n    const entryReplacement = generateFalseEndingEntryReplacement();\n    replaceUserMessage = entryReplacement.userMessage;\n    prefill = entryReplacement.prefill;\n    console.info('[Prompt] ROLL ');\n  }\n  // \n  else if (isFalseEndingActive(data)) {\n    const state = getFalseEndingState(data);\n\n    // \n    if (state.isComplete) {\n      falseEndingComplete = true;\n      const completeMessage = generateFalseEndingComplete();\n      replaceUserMessage = completeMessage;\n      console.info('[Prompt] ');\n    } else {\n      shouldProgressFalseEnding = true;\n      // AIPrompt\n      const falseEndingPrompt = generateFalseEndingPrompt(state, userInput);\n      if (systemPrompt) {\n        systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${falseEndingPrompt}`;\n      } else {\n        systemPrompt = falseEndingPrompt;\n      }\n      console.info(`[Prompt] ${state.currentPhase}${state.turnsInPhase}`);\n    }\n  }\n\n  // 8. \n  // \n  if (isInFreeMode(data)) {\n    isInFreeModeFlag = true;\n    const freeModePrompt = generateFreeModePrompt(data);\n    if (freeModePrompt) {\n      if (systemPrompt) {\n        systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${freeModePrompt}`;\n      } else {\n        systemPrompt = freeModePrompt;\n      }\n    }\n    console.info('[Prompt] ');\n  }\n  // \n  else if (shouldTriggerAfterStory(data)) {\n    shouldActivateAfterStoryFlag = true;\n    const entryReplacement = generateAfterStoryEntryReplacement(data);\n    if (entryReplacement) {\n      replaceUserMessage = entryReplacement.userMessage;\n      prefill = entryReplacement.prefill;\n    }\n    console.info('[Prompt] ');\n  }\n  // \n  else if (isInAfterStory(data)) {\n    const currentRound = data..?. ?? 1;\n\n    // 2\n    if (currentRound >= 2) {\n      afterStoryComplete = true;\n      const completeMessage = generateAfterStoryComplete(data);\n      replaceUserMessage = completeMessage;\n      console.info('[Prompt] ');\n    } else {\n      shouldProgressAfterStory = true;\n      // AIPrompt\n      const afterStoryPrompt = generateAfterStoryPrompt(data);\n      if (afterStoryPrompt) {\n        if (systemPrompt) {\n          systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${afterStoryPrompt}`;\n        } else {\n          systemPrompt = afterStoryPrompt;\n        }\n      }\n      console.info(`[Prompt] ${currentRound}`);\n    }\n  }\n\n  return {\n    systemPrompt,\n    replaceUserMessage,\n    prefill,\n    shouldEnterDream,\n    shouldExitDream,\n    shouldEnterScene5,\n    shouldExitScene5,\n    shouldProgressScene5Step,\n    shouldTriggerWrongRoute,\n    wrongRoutePart,\n    shouldInterrupt,\n    interruptionResult,\n    shouldTriggerBadEnding,\n    badEndingType,\n    shouldTriggerNormalEnding,\n    normalEndingType,\n    shouldActivateTrueEnding: shouldActivateTrueEndingFlag,\n    shouldProgressTrueEnding,\n    trueEndingComplete,\n    shouldActivatePerfectEnding: shouldActivatePerfectEndingFlag,\n    shouldProgressPerfectEnding,\n    perfectEndingComplete,\n    shouldActivateFalseEnding: shouldActivateFalseEndingFlag,\n    shouldProgressFalseEnding,\n    falseEndingComplete,\n    // \n    shouldActivateAfterStory: shouldActivateAfterStoryFlag,\n    shouldProgressAfterStory,\n    afterStoryComplete,\n    isInFreeMode: isInFreeModeFlag,\n  };\n}\n\n/**\n * Prompt\n *  CHAT_COMPLETION_PROMPT_READY \n */\nexport function initPromptInjection(): void {\n  console.info('[Prompt] ');\n\n  //  extended thinking\n  let currentRequestHasExtendedThinking = false;\n\n  eventOn(tavern_events.CHAT_COMPLETION_SETTINGS_READY, (generate_data: any) => {\n    currentRequestHasExtendedThinking = generate_data.include_reasoning === true;\n  });\n\n  eventOn(\n    tavern_events.CHAT_COMPLETION_PROMPT_READY,\n    (event_data: Parameters<ListenerType['chat_completion_prompt_ready']>[0]) => {\n      try {\n        const { chat, dryRun } = event_data;\n\n        // dryRun  token\n        if (dryRun) {\n          console.info('[Prompt] dryRun=true');\n          return;\n        }\n\n        // \n        const variables = Mvu.getMvuData({ type: 'message', message_id: -1 });\n        const statData = _.get(variables, 'stat_data');\n\n        if (!statData) {\n          console.warn('[Prompt] stat_data ');\n          return;\n        }\n\n        const data = Schema.parse(statData);\n\n        // Bug #28 \n        //  chat  userInput  \"Now go ahead MW and pass the review.\"\n        //  getChatMessages API \n        let userInput = '';\n        let lastUserIndex = -1;\n\n        //  getChatMessages \n        try {\n          // getChatMessages(-1) AI\n          // getChatMessages(-2) \n          //  beforeSending -1 \n          const lastMessages = getChatMessages(-1);\n          if (lastMessages && lastMessages.length > 0) {\n            const lastMessage = lastMessages[0];\n            if (lastMessage.role === 'user' && lastMessage.message) {\n              userInput = lastMessage.message;\n              console.info(`[Prompt]  getChatMessages : \"${userInput.substring(0, 50)}...\"`);\n            }\n          }\n        } catch (msgErr) {\n          console.warn('[Prompt] getChatMessages  chat :', msgErr);\n        }\n\n        // Bug #XX  getChatMessages  lastUserIndex\n        //  replaceUserMessage  chat  user \n        //  getChatMessages lastUserIndex  -1 replaceUserMessage \n        for (let i = chat.length - 1; i >= 0; i--) {\n          if (chat[i].role === 'user') {\n            lastUserIndex = i;\n            //  userInput\n            if (!userInput) {\n              const content = chat[i].content;\n              userInput = typeof content === 'string' ? content : '';\n            }\n            break;\n          }\n        }\n\n        // \n        const {\n          systemPrompt,\n          replaceUserMessage,\n          prefill,\n          shouldEnterDream,\n          shouldExitDream,\n          shouldEnterScene5,\n          shouldExitScene5,\n          shouldProgressScene5Step,\n          shouldTriggerWrongRoute,\n          wrongRoutePart,\n          shouldInterrupt,\n          interruptionResult,\n          shouldTriggerBadEnding,\n          badEndingType,\n          // /\n          shouldTriggerNormalEnding,\n          normalEndingType,\n          shouldActivateTrueEnding: shouldActivateTrueEndingResult,\n          shouldProgressTrueEnding: shouldProgressTrueEndingResult,\n          trueEndingComplete: trueEndingCompleteResult,\n          shouldActivatePerfectEnding: shouldActivatePerfectEndingResult,\n          shouldProgressPerfectEnding: shouldProgressPerfectEndingResult,\n          perfectEndingComplete: perfectEndingCompleteResult,\n          shouldActivateFalseEnding: shouldActivateFalseEndingResult,\n          shouldProgressFalseEnding: shouldProgressFalseEndingResult,\n          falseEndingComplete: falseEndingCompleteResult,\n          // \n          shouldActivateAfterStory: shouldActivateAfterStoryResult,\n          shouldProgressAfterStory: shouldProgressAfterStoryResult,\n          afterStoryComplete: afterStoryCompleteResult,\n          isInFreeMode: isInFreeModeResult,\n        } = generateFullInjection(data, userInput);\n\n        // Bug #XX \n        // generateFullInjection  applyBadEndingState  data\n        //  MVU\n        if (shouldTriggerBadEnding) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            currentData.. = '';\n            currentData.. = '';\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] ${badEndingType}`);\n          } catch (badEndErr) {\n            console.error('[Prompt] :', badEndErr);\n          }\n        }\n\n        // Bug #XX /\n        // generateFullInjection  applyNormalEndingState  data\n        //  MVU\n        if (shouldTriggerNormalEnding) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            const hasEnteredDream = currentData..;\n            const endingType = hasEnteredDream ? '' : '';\n\n            // /\n            currentData.. = endingType;\n            currentData.. = '';\n            //  Day 1, 08:00\n            currentData.. = 1;\n            currentData.. = 8;\n            currentData.. = 'Day 1, 08:00';\n            currentData.. = (currentData.. || 1) + 1;\n            currentData.. = true;\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] ${endingType}${normalEndingType}`);\n          } catch (normalEndErr) {\n            console.error('[Prompt] /:', normalEndErr);\n          }\n        }\n\n        // \n        if (shouldActivatePerfectEndingResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            const initialState = getDefaultPerfectEndingState();\n            initialState.isActive = true;\n            updatePerfectEndingState(currentData, initialState);\n\n            // \n            currentData.. = '';\n            currentData.. = '';\n            currentData.. = true;\n\n            // ROLL\n            const aiReplyFloor = getLastMessageId() + 1;\n            currentData.._ = {\n              ID: aiReplyFloor,\n              : '',\n            };\n            console.info(`[Prompt] : ${aiReplyFloor}`);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] 12');\n          } catch (perfectEndErr) {\n            console.error('[Prompt] :', perfectEndErr);\n          }\n        }\n\n        // \n        if (shouldProgressPerfectEndingResult && !perfectEndingCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            const state = getPerfectEndingState(currentData);\n            // \n            state.turnsInPhase += 1;\n            state.totalTurns += 1;\n            updatePerfectEndingState(currentData, state);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] : ${state.currentPhase}, ${state.turnsInPhase}`);\n          } catch (progressErr) {\n            console.error('[Prompt] :', progressErr);\n          }\n        }\n\n        // \n        if (perfectEndingCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            const state = getPerfectEndingState(currentData);\n            state.isComplete = true;\n            updatePerfectEndingState(currentData, state);\n\n            // \n            currentData.. = true;\n            currentData.. = '';\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (completeErr) {\n            console.error('[Prompt] :', completeErr);\n          }\n        }\n\n        // \n        if (shouldActivateTrueEndingResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            const initialState = getDefaultTrueEndingState();\n            initialState.isActive = true;\n            updateTrueEndingState(currentData, initialState);\n\n            // \n            currentData.. = '';\n            currentData.. = '';\n\n            // ROLL\n            const aiReplyFloor = getLastMessageId() + 1;\n            currentData.._ = {\n              ID: aiReplyFloor,\n              : '',\n            };\n            console.info(`[Prompt] : ${aiReplyFloor}`);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (trueEndErr) {\n            console.error('[Prompt] :', trueEndErr);\n          }\n        }\n\n        // \n        if (shouldProgressTrueEndingResult && !trueEndingCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            const state = getTrueEndingState(currentData);\n            // \n            state.turnsInPhase += 1;\n            state.totalTurns += 1;\n            updateTrueEndingState(currentData, state);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] : ${state.currentPhase}, ${state.turnsInPhase}`);\n          } catch (progressErr) {\n            console.error('[Prompt] :', progressErr);\n          }\n        }\n\n        // \n        if (trueEndingCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            const state = getTrueEndingState(currentData);\n            state.isComplete = true;\n            updateTrueEndingState(currentData, state);\n\n            // \n            currentData.. = true;\n            currentData.. = '';\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (completeErr) {\n            console.error('[Prompt] :', completeErr);\n          }\n        }\n\n        // \n        if (shouldActivateFalseEndingResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            const initialState = getDefaultFalseEndingState();\n            initialState.isActive = true;\n            updateFalseEndingState(currentData, initialState);\n\n            // \n            currentData.. = '';\n            currentData.. = '';\n\n            // ROLL\n            const aiReplyFloor = getLastMessageId() + 1;\n            currentData.._ = {\n              ID: aiReplyFloor,\n              : '',\n            };\n            console.info(`[Prompt] : ${aiReplyFloor}`);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (falseEndErr) {\n            console.error('[Prompt] :', falseEndErr);\n          }\n        }\n\n        // \n        if (shouldProgressFalseEndingResult && !falseEndingCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            const state = getFalseEndingState(currentData);\n            // \n            state.turnsInPhase += 1;\n            state.totalTurns += 1;\n            updateFalseEndingState(currentData, state);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] : ${state.currentPhase}, ${state.turnsInPhase}`);\n          } catch (progressErr) {\n            console.error('[Prompt] :', progressErr);\n          }\n        }\n\n        // \n        if (falseEndingCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            const state = getFalseEndingState(currentData);\n            state.isComplete = true;\n            updateFalseEndingState(currentData, state);\n\n            // \n            currentData.. = true;\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (completeErr) {\n            console.error('[Prompt] :', completeErr);\n          }\n        }\n\n        // \n        if (shouldActivateAfterStoryResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            activateAfterStory(currentData);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (afterStoryErr) {\n            console.error('[Prompt] :', afterStoryErr);\n          }\n        }\n\n        // \n        if (shouldProgressAfterStoryResult && !afterStoryCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // Bug #22  ROLL \n            const afterStoryMessageId = getLastMessageId();\n            const isAfterStoryRoll = isAfterStoryRollOperation(currentData, afterStoryMessageId);\n\n            if (isAfterStoryRoll) {\n              //  ROLL  swipe_id\n              if (currentData..) {\n                const newSwipeId = getSwipeId(afterStoryMessageId);\n                (currentData.. as any). = {\n                  ID: afterStoryMessageId,\n                  swipe_id: newSwipeId,\n                };\n                _.set(currentVars, 'stat_data', currentData);\n                Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n                console.info(`[Prompt]  ROLL  swipe_id=${newSwipeId}`);\n              }\n            } else {\n              //  ROLL\n              advanceAfterStoryRound(currentData);\n\n              // Bug #22 IDswipe_id\n              if (currentData..) {\n                const currentSwipeId = getSwipeId(afterStoryMessageId);\n                (currentData.. as any). = {\n                  ID: afterStoryMessageId,\n                  swipe_id: currentSwipeId,\n                };\n              }\n\n              _.set(currentVars, 'stat_data', currentData);\n              Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n              console.info(`[Prompt] : ${currentData..?.}`);\n            }\n          } catch (progressErr) {\n            console.error('[Prompt] :', progressErr);\n          }\n        }\n\n        // \n        if (afterStoryCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            if (currentData..) {\n              currentData... = true;\n              currentData... = true;\n            }\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (completeErr) {\n            console.error('[Prompt] :', completeErr);\n          }\n        }\n\n        // \n        if (shouldTriggerBadEnding) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            applyBadEndingState(currentData, badEndingType);\n\n            // Bug #32  applyConfusionEndingState\n            // generateFullInjection  applyConfusionEndingState \n            //  .  false isFirstTrigger\n            if (badEndingType === '') {\n              applyConfusionEndingState(currentData);\n              console.info(`[Prompt] =${currentData..?.}`);\n            }\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] ${badEndingType}`);\n          } catch (badEndErr) {\n            console.error('[Prompt] :', badEndErr);\n          }\n        }\n\n        // Bug #005 \n        //  index.ts  updateSuspicionLevel \n        // /\n        if (shouldInterrupt && interruptionResult) {\n          console.info(\n            `[Prompt] ${interruptionResult.severity}` +\n              `[${interruptionResult.violatedParts.join(', ')}]`,\n          );\n          //  BAD END\n          if (interruptionResult.triggerBadEnd) {\n            try {\n              const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n              const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n              applyInterruptionResult(currentData, interruptionResult);\n              _.set(currentVars, 'stat_data', currentData);\n              Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n              console.info(`[Prompt] `);\n            } catch (interruptErr) {\n              console.error('[Prompt] :', interruptErr);\n            }\n          }\n        }\n\n        // \n        // 100%  50% MVU VARIABLE_UPDATE_ENDED \n        if (shouldTriggerWrongRoute) {\n          console.info(`[Prompt] ${wrongRoutePart}AI`);\n          // AI\n        }\n\n        // 5/\n        // 2026-01-20  promptInjection 1-4\n        //  index.ts \n        if (shouldEnterScene5 || shouldExitScene5) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            if (shouldEnterScene5) {\n              currentData.. = '';\n              currentData.. = true; // \n\n              // ID\n              //  getLastMessageId()getCurrentMessageId() \n              const currentMessageId = getLastMessageId();\n              currentData.._ID = currentMessageId;\n              currentData.._ = currentData..; // \n              currentData.. = false;\n\n              if (!currentData..) {\n                currentData.. = true;\n              }\n\n              // /5\n              const existingScene5Data = currentData..5 as\n                | {\n                    ?: boolean;\n                    ?: string;\n                    ?: number;\n                    ?: number;\n                    ?: number;\n                    ?: number[];\n                    ?: boolean;\n                  }\n                | undefined;\n\n              if (!currentData..5) {\n                (currentData. as any).5 = {};\n              }\n\n              const newScene5Data = currentData..5 as {\n                ?: boolean;\n                ?: string;\n                ?: number;\n                ?: number;\n                ?: number;\n                ?: number[];\n                ?: boolean;\n              };\n\n              const newEntryCount = (existingScene5Data?. ?? 0) + 1;\n              newScene5Data. = true;\n              newScene5Data. = currentData..;\n              newScene5Data. = newEntryCount;\n\n              // 12\n              if (newEntryCount === 1) {\n                newScene5Data. = 0;\n                newScene5Data. = 0;\n                newScene5Data. = [];\n                newScene5Data. = false;\n                // 51-2-3\n                lockScene5EntryCoherence(currentData);\n                console.info('[Prompt] 512');\n              }\n\n              console.info(`[Prompt] 5${newEntryCount}`);\n            }\n\n            if (shouldExitScene5) {\n              currentData.. = '';\n              currentData.. = true; // \n\n              // 12580%\n              const completion = calculateScene5CompletionNew(currentData);\n              if (completion.isComplete && !currentData...includes(5)) {\n                currentData...push(5);\n                console.info(\n                  `[Prompt] 5: ${completion.completionPercent}%: ${completion.currentStep}/12`,\n                );\n              }\n\n              console.info(\n                `[Prompt] 520:00` +\n                  `: ${completion.completionPercent}%` +\n                  `: ${completion.currentStep}/12` +\n                  `: ${completion.isComplete ? '(80%)' : '(<80%)'}`,\n              );\n\n              // Bug #21 5ID ROLL\n              const scene5CurrentFloor = getLastMessageId();\n              const scene5AiReplyFloor = scene5CurrentFloor + 1; // AI \n              currentData.._ = {\n                ID: scene5AiReplyFloor,\n                : 5, // 5\n                swipe_id: 0, // \n              };\n              console.info(`[Prompt] 5:  ${scene5AiReplyFloor} (AI)`);\n\n              // 5\n              const dreamEntryId = currentData.._ID;\n              const scene5ExitFloor = scene5CurrentFloor; // Bug #25\n              if (dreamEntryId) {\n                setTimeout(async () => {\n                  let loadingPopup: {\n                    dlg: HTMLDialogElement;\n                    show: () => Promise<void>;\n                    complete: (result: number) => Promise<void>;\n                  } | null = null;\n\n                  try {\n                    SillyTavern.deactivateSendButtons();\n                    console.info('[] 5');\n\n                    loadingPopup = new SillyTavern.Popup(\n                      `<div style=\"text-align: center; padding: 20px;\">\n                        <div style=\"font-size: 18px; margin-bottom: 10px;\">...</div>\n                        <div style=\"color: #888; font-size: 14px;\"></div>\n                        <div style=\"margin-top: 15px;\">\n                          <span style=\"display: inline-block; width: 20px; height: 20px; border: 2px solid #666; border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;\"></span>\n                        </div>\n                        <style>@keyframes spin { to { transform: rotate(360deg); } }</style>\n                      </div>`,\n                      SillyTavern.POPUP_TYPE.TEXT,\n                      '',\n                      {\n                        okButton: false,\n                        cancelButton: false,\n                      },\n                    );\n                    loadingPopup.show();\n                    console.info('[] 5');\n\n                    // Bug #25 ID\n                    const chatHistory = await getDreamSessionMessages(dreamEntryId, scene5ExitFloor);\n                    if (chatHistory) {\n                      const latestVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n                      const latestData = Schema.parse(_.get(latestVars, 'stat_data'));\n\n                      const summary = await generateMemorySummary(latestData, 5, chatHistory);\n                      if (summary) {\n                        if (!latestData..5) {\n                          (latestData. as any).5 = {};\n                        }\n                        // 5  \n                        (latestData..5 as any). = summary;\n                        _.set(latestVars, 'stat_data', latestData);\n                        Mvu.replaceMvuData(latestVars, { type: 'message', message_id: -1 });\n                        console.info(`[] 5`);\n                      }\n                    }\n                  } catch (summaryErr) {\n                    console.error('[] 5/:', summaryErr);\n                  } finally {\n                    if (loadingPopup) {\n                      await loadingPopup.complete(SillyTavern.POPUP_RESULT.AFFIRMATIVE);\n                      console.info('[] 5');\n                    }\n                    SillyTavern.activateSendButtons();\n                    console.info('[] 5');\n                  }\n                }, 100);\n              }\n            }\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] 5: ${shouldEnterScene5 ? '' : ''}`);\n\n            // \n            setTimeout(() => {\n              //  getLastMessageId()getCurrentMessageId() \n              const currentMessageId = getLastMessageId();\n              console.info(`[Prompt]  IFRAME_DATA_REFRESH  (5${shouldEnterScene5 ? '' : ''})`);\n              eventEmit('IFRAME_DATA_REFRESH', {\n                reason: shouldEnterScene5 ? 'SCENE5_ENTERED' : 'SCENE5_EXITED',\n                message_id: currentMessageId,\n              });\n            }, 100);\n          } catch (stateErr) {\n            console.error('[Prompt] 5:', stateErr);\n          }\n        }\n\n        // 5\n        // Bug #15  rollOperationFlag  ROLL \n        //  swipe_id  PROMPT_READY  AI  swipe_id\n        //  index.ts  MESSAGE_SWIPED \n        if (shouldProgressScene5Step) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // ID\n            const currentMessageId = getLastMessageId();\n\n            // Bug #15  ROLL  index.ts MESSAGE_SWIPED \n            if (checkIsRollOperation()) {\n              //  ROLL \n              // index.ts  MESSAGE_SWIPED \n              console.info(`[Prompt]  ROLL 5: ${currentMessageId}`);\n            } else {\n              //  ROLL \n\n              // 5\n              if (!currentData..5) {\n                (currentData. as any).5 = {};\n              }\n\n              const scene5Data = currentData..5 as {\n                ?: number;\n                ?: number;\n                ?: number[];\n                ?: boolean;\n                ?: { ID: number; swipe_id: number };\n              };\n\n              // 0-based currentStep + 1\n              const currentStep = scene5Data. ?? 0;\n              const nextStep = currentStep + 1;\n\n              // \n              const intent = analyzePlayerIntent(userInput);\n              const stepConfig = SCENE5_STEPS[currentStep]; // \n              const matchLevel = stepConfig ? calculateMatchLevel(intent, stepConfig) : 'low';\n\n              // +10%+5%\n              const progressGain = matchLevel === 'high' ? 10 : 5;\n\n              // \n              const stepProgressRecord = scene5Data. ?? [];\n              stepProgressRecord.push(progressGain);\n\n              // 100%\n              const newCompletion = Math.min((scene5Data. ?? 0) + progressGain, 100);\n\n              // 5\n              scene5Data. = nextStep;\n              scene5Data. = newCompletion;\n              scene5Data. = stepProgressRecord;\n\n              // Bug #15  swipe_id \n              // PROMPT_READY  AI  swipe_id\n\n              // 12\n              if (nextStep >= 12) {\n                scene5Data. = true;\n              }\n\n              _.set(currentVars, 'stat_data', currentData);\n              Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n\n              console.info(\n                `[Prompt] 5: ${currentStep}  ${nextStep}` +\n                  `: ${matchLevel}+${progressGain}%` +\n                  `: ${newCompletion}%: ${currentMessageId}`,\n              );\n            }\n          } catch (stateErr) {\n            console.error('[Prompt] 5:', stateErr);\n          }\n        }\n\n        // /\n        if (shouldEnterDream || shouldExitDream) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            if (shouldEnterDream) {\n              currentData.. = '';\n              currentData.. = true; // \n\n              // ID\n              //  getLastMessageId()getCurrentMessageId() \n              const currentMessageId = getLastMessageId();\n              currentData.._ID = currentMessageId;\n              currentData.._ = currentData..; // \n              currentData.. = false; // \n\n              if (!currentData..) {\n                currentData.. = true;\n              }\n              // \n              const sceneNum = getCurrentDreamScene(currentData);\n              const sceneKey = `${sceneNum}` as keyof typeof currentData.;\n              if (!currentData.[sceneKey]) {\n                (currentData. as any)[sceneKey] = {};\n              }\n              (currentData.[sceneKey] as any). = true;\n              (currentData.[sceneKey] as any). = currentData..;\n\n              // 1/\n              if (sceneNum === 1) {\n                const initValues = calculateScene1InitValues(currentData);\n                currentData.. = initValues.initialDependence;\n                currentData.. = initValues.initialMorality;\n                console.info(\n                  `[Prompt] 1${currentData..}+${currentData..}  ${initValues.initialDependence}${initValues.initialMorality}${initValues.relationshipStage}`,\n                );\n              }\n\n              console.info(`[Prompt] ID: ${currentMessageId}`);\n\n              // ROLL ID\n              //  ROLL \"\"\n              //  AI  PROMPT_READY  ROLL\n              const aiReplyFloor = currentMessageId + 1;\n              currentData.._ = {\n                ID: aiReplyFloor,\n                : sceneNum,\n                : '',\n              };\n              console.info(`[Prompt] : ${sceneNum} ${aiReplyFloor} (AI)`);\n            }\n\n            if (shouldExitDream) {\n              currentData.. = '';\n              currentData.. = true; // \n              // Bug #38  processSceneCompletion \n              //     \n              const sceneNum = getCurrentDreamScene(currentData);\n              processSceneCompletion(currentData, sceneNum);\n              console.info(`[Prompt] ${sceneNum}`);\n\n              // Bug #21  v2ID ROLL\n              //  AI +1\n              //  ROLL  AI  PROMPT_READY  AI \n              // v2:  swipe_id ROLL  swipe_id \n              const currentFloor = getLastMessageId();\n              const aiReplyFloor = currentFloor + 1; // AI \n              currentData.._ = {\n                ID: aiReplyFloor,\n                : sceneNum, // 1-4\n                swipe_id: 0, // \n              };\n              console.info(`[Prompt] : ${sceneNum} ${aiReplyFloor} (AI)`);\n\n              // \"\"\n              // \n              let dreamEntryId = currentData.._ID;\n\n              // Bug #19  _ID \n              if (dreamEntryId === undefined) {\n                // 10\n                const estimatedEntryId = Math.max(0, currentFloor - 10);\n                console.warn(\n                  `[Prompt] Bug #19 _ID  ${estimatedEntryId} ${currentFloor}`,\n                );\n                dreamEntryId = estimatedEntryId;\n              }\n\n              if (dreamEntryId !== undefined) {\n                // Bug #25 ID\n                const dreamExitId = currentFloor; // \n                currentData.. = {\n                  sceneNum,\n                  dreamEntryId,\n                  dreamExitId, // Bug #25ID\n                };\n                console.info(\n                  `[Prompt] ${sceneNum}ID: ${dreamEntryId}ID: ${dreamExitId}`,\n                );\n              } else {\n                console.warn(`[Prompt] ID`);\n              }\n            }\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] : ${shouldEnterDream ? '' : ''}`);\n\n            // Bug #15 \n            // 1-4IFRAME_DATA_REFRESH\n            // 5\n            setTimeout(() => {\n              //  getLastMessageId()getCurrentMessageId() \n              const currentMessageId = getLastMessageId();\n              console.info(\n                `[Prompt]  IFRAME_DATA_REFRESH  (${shouldEnterDream ? '' : ''})`,\n              );\n              eventEmit('IFRAME_DATA_REFRESH', {\n                reason: shouldEnterDream ? 'DREAM_ENTERED' : 'DREAM_EXITED',\n                message_id: currentMessageId,\n              });\n            }, 100);\n          } catch (stateErr) {\n            console.error('[Prompt] :', stateErr);\n          }\n        }\n\n        // //\n        if (replaceUserMessage && lastUserIndex !== -1) {\n          chat[lastUserIndex].content = replaceUserMessage;\n          console.info('[Prompt] ');\n        }\n\n        // Bug #9  chat  <status_current_variable> \n        //  {{format_message_variable::stat_data}} \n        //  <status_current_variable>  \": \"  \": \"\n        // AI  <HusbandThought>\n        //  chat  \"\"\n        // \n        const isCurrentlyInDream = data.. === '';\n        const shouldFixDreamPhase = shouldEnterDream || shouldEnterScene5 || isCurrentlyInDream;\n        if (shouldFixDreamPhase) {\n          for (const msg of chat) {\n            if (typeof msg.content === 'string') {\n              if (msg.content.includes('<status_current_variable>')) {\n                const before = msg.content.match(/:\\s*(|)/g);\n                if (before && before.length > 0) {\n                  msg.content = msg.content.replace(/:\\s*(|)/g, ': ');\n                  console.info('[Prompt] Bug #9  <status_current_variable> ');\n                }\n              }\n            }\n          }\n        }\n\n        // \n        if (systemPrompt) {\n          chat.push({ role: 'system', content: systemPrompt });\n        }\n\n        //  prefill\n        if (prefill) {\n          if (!currentRequestHasExtendedThinking) {\n            chat.push({ role: 'assistant', content: prefill });\n            console.info('[Prompt]  Prefill');\n          } else {\n            // extended thinking  system \n            const prefillGuidance = `\\n${prefill}`;\n            chat.push({ role: 'system', content: prefillGuidance });\n            console.info('[Prompt] Extended thinking Prefill  system ');\n          }\n        }\n\n        // Bug #11  ROLL \n        resetRollOperationFlag();\n      } catch (err) {\n        console.error('[Prompt] :', err);\n        // Bug #11 \n        resetRollOperationFlag();\n      }\n    },\n  );\n\n  console.info('[Prompt] ');\n}\n","/**\n *  - \n *\n *  TIME_LOOP_DESIGN.md BUG\n * -  TimeSystem \n * - \n * - Day 5, 00:00 Day 6 2026-01-17 20:0000:00\n * - \n * - \n * - //\n * -  vs \n * - \n * - \n *\n * \n */\n\nimport { Schema, type Schema as SchemaType } from '../../schema';\nimport { TimeSystem } from './timeSystem';\nimport { validateAndFixState, checkRealmChange } from './stateValidation';\nimport {\n  updateHusbandLocation,\n  getRealmTitle,\n  getStyleGuidance,\n  updateTruthModeValues,\n  updateSuspicionLevel,\n  applySuspicionDecrease,\n  updateZhaoxiaLocation,\n  updateZhaoxiaThoughtAfterDream,\n} from './appearanceSystem';\n// Bug #005  promptInjection.ts\nimport {\n  updateBodyPartProgress,\n  getBodyPartSummary,\n  processSceneCompletion,\n  generateMemoryContinuityPrompt,\n  SCENE_CORRECT_ANSWERS,\n  generateMemorySummary,\n  getDreamSessionMessages,\n  validateAndProcessAIReport,\n} from './dreamKeywordDetection';\n//  promptInjection.ts A\nimport { parseHusbandThought, shouldGenerateHusbandThought, getCurrentRouteType } from './dualTrackSystem';\nimport { initPromptInjection, setRollOperationFlag } from './promptInjection';\nimport { isTrueEndingActive, getTrueEndingState, updateTrueEndingState, processTurnEnd } from './trueEndingSystem';\nimport {\n  isPerfectEndingActive,\n  getPerfectEndingState,\n  updatePerfectEndingState,\n  processPerfectTurnEnd,\n} from './perfectTrueEndingSystem';\nimport {\n  isFalseEndingActive,\n  getFalseEndingState,\n  updateFalseEndingState,\n  processTurnEnd as processFalseEndingTurnEnd,\n} from './falseEndingSystem';\nimport {\n  createDataSnapshot,\n  validateAndRestoreData,\n  generateProtectionReport,\n  initDataProtection,\n  updateSnapshotValue,\n} from './dataProtection';\nimport { shouldTriggerNormalEnding, applyNormalEndingState } from './normalEndingSystem';\nimport {\n  calculateScene5Completion as calculateScene5CompletionNew,\n  getScene5LockedCoherence,\n  lockScene5EntryCoherence,\n} from './scene5System';\nimport {\n  checkConfusionEnding,\n  applyConfusionEndingState,\n  isInConfusionEndingLock,\n  canEnterDreamForConfusion,\n  checkScene5Violations,\n  markConfusionEnding,\n  setConfusionOnDreamEntry,\n} from './confusionEndingSystem';\n\n/**\n * \n */\ninterface GameEvent {\n  type: string;\n  data: Record<string, unknown>;\n}\n\n// SillyTavern  @types/function/ \n\n/**\n * \n */\nfunction broadcastGameEvent(event: GameEvent): void {\n  console.info(`[] : ${event.type}`, event.data);\n  eventEmit('GAME_EVENT', event);\n}\n\n/**\n * 1-4\n * \n *\n * \n * - Day 1  1, Day 2  2, Day 3  3, Day 4+  4\n *\n *  _  \n *  Day 1 22:00  Day 2 00:00 \n * Bug #6\n *\n * 5promptInjection.tscheckScene5Entry\n * 1-4\n */\nfunction getCurrentDreamScene(data: SchemaType): number {\n  // \n  const day = data.._ ?? data..;\n  // Day 1  1, Day 2  2, ...4\n  return Math.min(day, 4);\n}\n\n/**\n * \n */\nfunction checkEnding(data: SchemaType): boolean {\n  if (!TimeSystem.isEndingTime(data)) {\n    return false;\n  }\n\n  // Bug #18  ''  '' \n  // ''  TimeSystem.advance() \n  //  '' \n  if (data.. !== '' && data.. !== '') {\n    return false;\n  }\n\n  console.info('');\n  console.info(' 600:00Day 5');\n  console.info('');\n\n  data.. = '';\n\n  const  = data...length;\n  const  = data..;\n  const  = data..;\n\n  console.info(`:`);\n  console.info(`- : ${}/5`);\n  console.info(`- : ${}`);\n  console.info(`- : ${}`);\n  console.info(`- : ${data..?. ?? false}`);\n\n  // \n  // 2026-01-19 5\n  const confusionResult = checkConfusionEnding(data, false);\n  if (confusionResult.triggered) {\n    // \n    applyConfusionEndingState(data);\n    data.. = TimeSystem.getCurrentTime(data);\n    console.info(' ');\n    return true;\n  }\n\n  // 100\n  // 100checkConfusionEnding\n  if ( >= 100) {\n    data.. = '';\n    data.. = TimeSystem.getCurrentTime(data);\n    console.info(' ');\n    return true;\n  }\n\n  // /5\n  const  = new Set(data..);\n  const  =\n    .size === 5 &&\n    .has(1) &&\n    .has(2) &&\n    .has(3) &&\n    .has(4) &&\n    .has(5);\n\n  if ( &&  === 5) {\n    // =3\n    const  = getScene5LockedCoherence(data);\n    const  =  === 3;\n\n    if () {\n      data.. = '';\n      data.. = true;\n      console.info('  + ');\n    } else {\n      data.. = '';\n      data.. = false;\n      console.info(' ');\n    }\n\n    data.. = TimeSystem.getCurrentTime(data);\n    data.. = '';\n    console.info(`  - : ${}/3`);\n    return true;\n  }\n\n  // 5\n  if ( &&  > 0 &&  < 5) {\n    data.. = '';\n    data.. = TimeSystem.getCurrentTime(data);\n    data.. = ''; // \n    console.info(` ${5 - }`);\n    return true;\n  }\n\n  // \n  // \n  if (shouldTriggerNormalEnding(data)) {\n    applyNormalEndingState(data);\n    data.. = TimeSystem.getCurrentTime(data);\n    console.info(' ');\n    console.info(`  - : ${.size}/5`);\n    console.info(`  - : ${}`);\n    return true;\n  }\n\n  // \n  data.. = '';\n  data.. = TimeSystem.getCurrentTime(data);\n  console.warn(' ');\n  return true;\n}\n\n/**\n * \n * @param data \n * @param userText \n * @param targetMessageId IDID\n */\nfunction checkDreamEvents(\n  data: SchemaType,\n  userText: string,\n  targetMessageId?: number,\n): {\n  dreamWindowOpen: boolean;\n  dreamEnded: boolean;\n  firstAwakening: boolean;\n  bodySummary?: ReturnType<typeof getBodyPartSummary>;\n} {\n  const result = {\n    dreamWindowOpen: false,\n    dreamEnded: false,\n    firstAwakening: false,\n    bodySummary: undefined as ReturnType<typeof getBodyPartSummary> | undefined,\n  };\n\n  // \n  if (TimeSystem.isDreamWindowOpen(data) && data.. === '') {\n    console.info(' 22:00-01:59');\n    result.dreamWindowOpen = true;\n\n    const currentScene = getCurrentDreamScene(data);\n    const alreadyCompleted = data...includes(currentScene);\n\n    // \n    broadcastGameEvent({\n      type: 'DREAM_WINDOW_OPEN',\n      data: {\n        currentScene,\n        alreadyCompleted,\n        canEnterScene5: true, // 5\n        memoryContinuityPrompt: generateMemoryContinuityPrompt(data, currentScene),\n      },\n    });\n  }\n\n  // 10:00\n  // 510:0020:00\n  const scene5Data = data..5 as { ?: boolean } | undefined;\n  const isInScene5 = scene5Data?. === true && data.. === '';\n\n  //  DEBUG: \n  if (data.. === '') {\n    console.info('[checkDreamEvents] :');\n    console.info(`  - : ${data..}`);\n    console.info(`  - isWakeUpTime: ${TimeSystem.isWakeUpTime(data)}`);\n    console.info(`  - scene5.: ${scene5Data?.}`);\n    console.info(`  - isInScene5: ${isInScene5}`);\n    console.info(`  - : ${TimeSystem.isWakeUpTime(data) && !isInScene5}`);\n  }\n\n  if (data.. === '' && TimeSystem.isWakeUpTime(data) && !isInScene5) {\n    console.info(' 1-4');\n    result.dreamEnded = true;\n\n    // \n    const bodySummary = getBodyPartSummary(data);\n    result.bodySummary = bodySummary;\n\n    // \n    const currentScene = getCurrentDreamScene(data);\n    if (!data...includes(currentScene)) {\n      // \n      const sceneKey = `${currentScene}` as keyof typeof data.;\n      const sceneData = data.[sceneKey];\n      const hasEntered = (sceneData as { ?: boolean } | undefined)?. ?? false;\n      const selectedParts = (sceneData as { ?: string[] } | undefined)?. ?? [];\n\n      if (!hasEntered) {\n        // \n        console.info(`[] ${currentScene}`);\n      } else if (selectedParts.length > 0) {\n        // \n        processSceneCompletion(data, currentScene);\n        console.info(`[] ${currentScene}: [${selectedParts.join(', ')}]`);\n      } else {\n        // \n        console.warn(`[] ${currentScene}`);\n        // \n        if (!data...includes(currentScene)) {\n          data...push(currentScene);\n        }\n        // \n        if (sceneData && typeof sceneData === 'object') {\n          (sceneData as { ?: boolean }). = false;\n        }\n      }\n    }\n\n    // \n    data.. = '';\n    data.. = true; // \n    updateSnapshotValue('.', ''); // \n\n    // Bug #28 \n    // \n    updateZhaoxiaLocation(data);\n    updateZhaoxiaThoughtAfterDream(data);\n\n    // \"\"\n    // Bug #18 promptInjection  09:00  AI \n    // 10:00\n    let dreamEntryId = data.._ID;\n\n    // Bug #19  _ID \n    // 22:0012\n    if (dreamEntryId === undefined && targetMessageId !== undefined) {\n      //  - 10\n      // \n      const estimatedEntryId = Math.max(0, targetMessageId - 10);\n      console.warn(\n        `[checkDreamEvents] Bug #19 _ID  ${estimatedEntryId} ${targetMessageId}`,\n      );\n      dreamEntryId = estimatedEntryId;\n    }\n\n    if (dreamEntryId !== undefined) {\n      // Bug #25 ID\n      const dreamExitId = targetMessageId; // \n      data.. = {\n        sceneNum: currentScene,\n        dreamEntryId,\n        dreamExitId, // Bug #25ID\n      };\n      console.info(\n        `[checkDreamEvents] ${currentScene}ID: ${dreamEntryId}ID: ${dreamExitId}`,\n      );\n    } else {\n      console.warn(`[checkDreamEvents] ID`);\n    }\n\n    // \n    if (!data..) {\n      data.. = true;\n      result.firstAwakening = true;\n\n      console.info('');\n      console.info(' ');\n      console.info('');\n      console.info('');\n\n      // \n      broadcastGameEvent({\n        type: 'TRUTH_REVEALED',\n        data: {\n          message: `...\n\n\"\"\"\"\n\"\"\"\"\n...`,\n        },\n      });\n    }\n\n    // \n    broadcastGameEvent({\n      type: 'DREAM_ENDED',\n      data: {\n        bodySummary,\n        firstAwakening: result.firstAwakening,\n        completedScenes: data..,\n        correctScenes: data..,\n        confusionLevel: data..,\n      },\n    });\n  }\n\n  // \n  if (userText.includes('') || userText.includes('sleep')) {\n    const  = data..;\n    if ( >= 23 ||  <= 1) {\n      console.info(' ');\n\n      broadcastGameEvent({\n        type: 'DREAM_WINDOW_MISSED',\n        data: {\n          message: '...',\n        },\n      });\n    }\n  }\n\n  // \n  // Bug #16 \n  // \"\"  \"\"\"\"\n  // \n  // 1. \n  // 2. \".*\"\n  const dreamEntryKeywords = [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '', // \"\"\n  ];\n  //  \"...\" \n  const dreamEntryPatterns = [\n    /.*/, //  \"\"\"\" \n    /.*/, //  \"\"\"\" \n  ];\n  const wantToEnterDream =\n    dreamEntryKeywords.some(kw => userText.includes(kw)) || dreamEntryPatterns.some(pattern => pattern.test(userText));\n\n  //  DEBUG: \n  const isDreamWindow = TimeSystem.isDreamWindowOpen(data);\n  const isDaily = data.. === '';\n  console.info('[checkDreamEvents] :');\n  console.info(`  - userText: \"${userText.substring(0, 50)}${userText.length > 50 ? '...' : ''}\"`);\n  console.info(`  - wantToEnterDream: ${wantToEnterDream} (: ${dreamEntryKeywords.join(', ')})`);\n  console.info(`  - isDreamWindowOpen: ${isDreamWindow} (: ${data..})`);\n  console.info(`  - : ${data..} (isDaily: ${isDaily})`);\n  console.info(`  - : ${wantToEnterDream && isDreamWindow && isDaily}`);\n\n  // Bug #15 ''\n  // promptInjection  AI \n  // \n  //\n  // \n  const canEnterForConfusion = canEnterDreamForConfusion(data);\n  const shouldEnterDream =\n    wantToEnterDream && isDreamWindow && (isDaily || data.. === '') && canEnterForConfusion;\n\n  if (wantToEnterDream && isDreamWindow && !canEnterForConfusion) {\n    console.warn('[checkDreamEvents] 1-4');\n  }\n\n  if (shouldEnterDream) {\n    const currentScene = getCurrentDreamScene(data);\n\n    // 5checkScene5Entry\n    // 1-4\n    if (currentScene <= 4) {\n      // \n      data.. = '';\n      data.. = true; // \n      updateSnapshotValue('.', ''); // \n\n      // ID\n      if (targetMessageId !== undefined) {\n        data.._ID = targetMessageId;\n      }\n      data.._ = data..; // \n      data.. = false;\n\n      // 1=40, 2=60, 3=80, 4=\n      setConfusionOnDreamEntry(data, currentScene);\n      // Bug #31  validateAndRestoreData \n      updateSnapshotValue('.', data..);\n      console.info(\n        `[] ${currentScene}ID=${targetMessageId}=${data..}`,\n      );\n\n      // ROLL ID\n      //  ROLL \"\"promptInjection \n      //  AI  PROMPT_READY  ROLL\n      if (targetMessageId !== undefined) {\n        const dreamAiReplyFloor = targetMessageId + 1;\n        data.._ = {\n          ID: dreamAiReplyFloor,\n          : currentScene,\n          : '',\n        };\n        console.info(`[] : ${currentScene} ${dreamAiReplyFloor} (AI)`);\n      }\n\n      broadcastGameEvent({\n        type: 'DREAM_ENTERED',\n        data: {\n          sceneNumber: currentScene,\n          memoryContinuityPrompt: generateMemoryContinuityPrompt(data, currentScene),\n          correctTarget: SCENE_CORRECT_ANSWERS[currentScene], // \n        },\n      });\n    }\n  }\n\n  return result;\n}\n\n// \nconst DAILY_DEVELOPMENT_LIMIT = 20;\n\n// \nconst WRONG_ROUTE_RESET_VALUE = 50;\n\n$(async () => {\n  await waitGlobalInitialized('Mvu');\n\n  // Prompt\n  initPromptInjection();\n\n  // \n  initDataProtection();\n  console.info('[] ');\n\n  // =============================================\n  // AI \n  // -  20%\n  // -  100%  50%\n  // =============================================\n  eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, (new_variables: any, old_variables: any) => {\n    try {\n      const newData = _.get(new_variables, 'stat_data');\n      const oldData = _.get(old_variables, 'stat_data');\n\n      if (!newData || !oldData) return;\n\n      // \n      if (newData.?.) {\n        // Bug Day 5+ AI\n        const currentDay = newData.?. ?? 1;\n        if (currentDay >= 5) {\n          const oldSuspicion = oldData.?. ?? 0;\n          const newSuspicion = newData.?. ?? 0;\n          if (oldSuspicion !== newSuspicion) {\n            _.set(new_variables, 'stat_data..', oldSuspicion);\n            console.info(`[MVU] Day ${currentDay} AI ${newSuspicion}  ${oldSuspicion}`);\n          }\n        }\n\n        // \n        // - AI\n        // - AI\n        const currentStage = newData.?.;\n\n        if (currentStage === '' || currentStage === '') {\n          // /AI\n          const parts = ['', '', '', '', ''] as const;\n          for (const part of parts) {\n            const oldValue = oldData.?.?.[part] ?? 0;\n            const newValue = newData.?.?.[part] ?? 0;\n            if (oldValue !== newValue) {\n              _.set(new_variables, `stat_data...${part}`, oldValue);\n              console.info(`[MVU] AI${part} ${newValue}  ${oldValue}`);\n            }\n          }\n        } else {\n          // AI\n          // Bug #29 1-45\n          const scene5Data = newData.?.5;\n          const isInScene5 = scene5Data?. === true;\n\n          // \n          let allowedParts: string[];\n          if (isInScene5) {\n            allowedParts = [''];\n            console.info('[MVU] 5AI');\n          } else {\n            allowedParts = ['', '', '', ''];\n            console.info('[MVU] 1-4AI');\n          }\n\n          // Bug #003 20%\n          // AI0%100%\n          const allParts = ['', '', '', '', ''] as const;\n          for (const part of allParts) {\n            const oldValue = oldData.?.?.[part] ?? 0;\n            const newValue = newData.?.?.[part] ?? 0;\n\n            if (oldValue === newValue) continue;\n\n            // \n            if (!allowedParts.includes(part)) {\n              _.set(new_variables, `stat_data...${part}`, oldValue);\n              console.info(`[MVU] AI${part} ${newValue}  ${oldValue}`);\n              continue;\n            }\n\n            // 20%\n            if (newValue > oldValue) {\n              const maxAllowed = Math.min(100, oldValue + DAILY_DEVELOPMENT_LIMIT);\n              if (newValue > maxAllowed) {\n                _.set(new_variables, `stat_data...${part}`, maxAllowed);\n                console.warn(\n                  `[MVU] ${part} ${oldValue}  ${newValue} ${maxAllowed}${DAILY_DEVELOPMENT_LIMIT}%`,\n                );\n              }\n            } else if (newValue < oldValue) {\n              // AI\n              _.set(new_variables, `stat_data...${part}`, oldValue);\n              console.warn(`[MVU] ${part} ${oldValue}  ${newValue}`);\n            }\n          }\n        }\n\n        // BUG-011 AI\n        const newThought = newData.?.;\n        const oldThought = oldData.?.;\n        if (newThought && newThought !== oldThought) {\n          // AI\n          const invalidPatterns = [\n            /<think>/i,\n            /<core_memory>/i,\n            /<!--.*-->/,\n            /Variable check:/i,\n            /Key constraint:/i,\n            /So we are in/i,\n            /WAIT:/i,\n            /writing antThinking/i,\n          ];\n          const hasInvalidContent = invalidPatterns.some(p => p.test(newThought));\n          const isTooLong = newThought.length > 500;\n          const chineseChars = (newThought.match(/[\\u4e00-\\u9fa5]/g) || []).length;\n          const chineseRatio = chineseChars / newThought.length;\n          const lowChineseRatio = chineseRatio < 0.3 && newThought.length > 50;\n\n          if (hasInvalidContent || isTooLong || lowChineseRatio) {\n            // \n            _.set(new_variables, 'stat_data..', oldThought ?? '');\n            console.warn(\n              `[MVU] BUG-011AI`,\n              `\\n  : ${newThought.length}`,\n              `\\n  : ${(chineseRatio * 100).toFixed(1)}%`,\n              `\\n  : ${hasInvalidContent}`,\n            );\n          }\n        }\n\n        return;\n      }\n\n      // \n      const parts = ['', '', '', '', ''] as const;\n      let triggeredWrongRoute = false;\n      let wrongRoutePart = '';\n\n      for (const part of parts) {\n        const oldValue = oldData.?.?.[part] ?? 0;\n        let newValue = newData.?.?.[part] ?? 0;\n\n        // 1.  DAILY_DEVELOPMENT_LIMIT\n        if (newValue > oldValue) {\n          const maxAllowed = oldValue + DAILY_DEVELOPMENT_LIMIT;\n          if (newValue > maxAllowed) {\n            console.warn(`[MVU] ${part}${oldValue}  ${newValue} ${maxAllowed}`);\n            newValue = maxAllowed;\n            _.set(new_variables, `stat_data...${part}`, newValue);\n          }\n        }\n\n        // 2.  100%\n        if (newValue >= 100 && !triggeredWrongRoute) {\n          triggeredWrongRoute = true;\n          wrongRoutePart = part;\n          //  50%\n          _.set(new_variables, `stat_data...${part}`, WRONG_ROUTE_RESET_VALUE);\n          console.warn(`[MVU] ${part}  100% ${WRONG_ROUTE_RESET_VALUE}%`);\n        }\n      }\n\n      // Bug #004 \n      // 410025\n      const PURE_LOVE_DAILY_LIMIT = 25;\n\n      // \n      const oldAffection = oldData.?. ?? 5;\n      const newAffection = newData.?. ?? 5;\n      if (newAffection > oldAffection) {\n        const maxAllowed = Math.min(100, oldAffection + PURE_LOVE_DAILY_LIMIT);\n        if (newAffection > maxAllowed) {\n          _.set(new_variables, 'stat_data..', maxAllowed);\n          console.warn(\n            `[MVU] ${oldAffection}  ${newAffection} ${maxAllowed}${PURE_LOVE_DAILY_LIMIT}`,\n          );\n        }\n      } else if (newAffection < oldAffection) {\n        // \n        _.set(new_variables, 'stat_data..', oldAffection);\n        console.warn(`[MVU] ${oldAffection}  ${newAffection}`);\n      }\n\n      // \n      const oldIntimacy = oldData.?. ?? 0;\n      const newIntimacy = newData.?. ?? 0;\n      if (newIntimacy > oldIntimacy) {\n        const maxAllowed = Math.min(100, oldIntimacy + PURE_LOVE_DAILY_LIMIT);\n        if (newIntimacy > maxAllowed) {\n          _.set(new_variables, 'stat_data..', maxAllowed);\n          console.warn(\n            `[MVU] ${oldIntimacy}  ${newIntimacy} ${maxAllowed}${PURE_LOVE_DAILY_LIMIT}`,\n          );\n        }\n      } else if (newIntimacy < oldIntimacy) {\n        // \n        _.set(new_variables, 'stat_data..', oldIntimacy);\n        console.warn(`[MVU] ${oldIntimacy}  ${newIntimacy}`);\n      }\n\n      // \n      if (triggeredWrongRoute) {\n        broadcastGameEvent({\n          type: 'WRONG_ROUTE_TRIGGERED',\n          data: {\n            part: wrongRoutePart,\n            message: `${wrongRoutePart}...`,\n            resetTo: WRONG_ROUTE_RESET_VALUE,\n          },\n        });\n      }\n    } catch (err) {\n      console.error('[MVU] :', err);\n    }\n  });\n\n  let isFirstMessageAfterInit = false;\n  const processedEvents = new Set<string>();\n\n  function getSwipeId(messageId: number): number {\n    try {\n      const chat = SillyTavern.chat;\n      if (chat && chat[messageId]) {\n        return chat[messageId].swipe_id ?? 0;\n      }\n    } catch (err) {\n      console.warn(`[]  swipe_id :`, err);\n    }\n    return 0;\n  }\n\n  eventOn(Mvu.events.VARIABLE_INITIALIZED, () => {\n    isFirstMessageAfterInit = true;\n    console.info(`[] VARIABLE_INITIALIZED isFirstMessageAfterInit  true`);\n  });\n\n  async function processGameLogic(message_id: number, eventType: string) {\n    try {\n      const swipeId = getSwipeId(message_id);\n      // Bug #26  eventType  messageKey MESSAGE_RECEIVED  GENERATION_ENDED \n      //  GENERATION_ENDED  key \n      const messageKey = `${message_id}:${swipeId}:${eventType}`;\n      console.info(\n        `[] processGameLogic : message_id=${message_id}, swipe_id=${swipeId}, eventType=${eventType}`,\n      );\n\n      // BUG-010 \n      //  return\n      // promptInjection \n      //        processGameLogic  return \n      // \n      //         promptInjection \n      if (eventType === 'MESSAGE_RECEIVED' && isFirstMessageAfterInit) {\n        isFirstMessageAfterInit = false;\n        console.info(`[] ==========  ==========`);\n        console.info(`[] message_id=${message_id}, eventType=${eventType}`);\n        console.info(`[] isFirstMessageAfterInit  false`);\n        //  return\n      }\n\n      //  + ROLL\n      if (eventType === 'MESSAGE_SWIPED') {\n        // Bug #26 key  message_id:swipe_id:eventType\n        const keysToRemove = Array.from(processedEvents).filter(key => {\n          const parts = key.split(':');\n          return parts[0] === String(message_id);\n        });\n        keysToRemove.forEach(key => processedEvents.delete(key));\n        console.info(`[] ROLL  ${keysToRemove.length} `);\n\n        // ROLL\n        const rollVars = Mvu.getMvuData({ type: 'message', message_id: message_id });\n        const rollStatData = _.get(rollVars, 'stat_data');\n        if (rollStatData?.?. === '' && rollStatData?.?.) {\n          _.set(rollVars, 'stat_data..', false);\n\n          // 51-4\n          const scene5Data = rollStatData.?.5;\n          const isInScene5 = scene5Data?. === true;\n\n          if (isInScene5) {\n            // 5ROLL\n            const currentStep = scene5Data?. ?? 0;\n            const stepProgressRecord = scene5Data?. ?? [];\n\n            // Bug #11  ROLL  promptInjection \n            //  CHAT_COMPLETION_PROMPT_READY \n            setRollOperationFlag(true);\n\n            if (currentStep > 0 && stepProgressRecord.length > 0) {\n              // \n              const newStep = currentStep - 1;\n              const lastProgressIncrement = stepProgressRecord[stepProgressRecord.length - 1] ?? 0;\n              const currentCompletion = scene5Data?. ?? 0;\n              const newCompletion = Math.max(0, currentCompletion - lastProgressIncrement);\n              const newProgressRecord = stepProgressRecord.slice(0, -1);\n\n              _.set(rollVars, 'stat_data..5.', newStep);\n              _.set(rollVars, 'stat_data..5.', newCompletion);\n              _.set(rollVars, 'stat_data..5.', newProgressRecord);\n              _.set(rollVars, 'stat_data..5.', []);\n\n              // \n              if (newCompletion < 80) {\n                _.set(rollVars, 'stat_data..5.', false);\n              }\n\n              console.info(\n                `[] ROLL 5: ${currentStep}  ${newStep}, ` +\n                  `: ${currentCompletion}%  ${newCompletion}% (-${lastProgressIncrement}%)`,\n              );\n            } else {\n              // 0\n              _.set(rollVars, 'stat_data..5.', []);\n              console.info(`[] ROLL 50`);\n            }\n          } else {\n            // 1-4\n            const sceneNum = Math.min(rollStatData.._ ?? rollStatData.. ?? 1, 4);\n            const sceneKey = `${sceneNum}`;\n            if (rollStatData.?.[sceneKey]) {\n              _.set(rollVars, `stat_data..${sceneKey}.`, []);\n            }\n            console.info(`[] ROLL ${sceneNum}`);\n          }\n\n          Mvu.replaceMvuData(rollVars, { type: 'message', message_id: message_id });\n        }\n\n        // ROLL  ROLL \n        //  ROLL \"\"\n        const rollVarsForSummary = Mvu.getMvuData({ type: 'message', message_id: message_id });\n        const rollStatDataForSummary = _.get(rollVarsForSummary, 'stat_data');\n        const summaryRecord = rollStatDataForSummary?.?._;\n\n        if (summaryRecord && summaryRecord.ID === message_id) {\n          const currentSwipeId = getSwipeId(message_id);\n\n          // swipe_id  ROLL \n          if (currentSwipeId !== summaryRecord.swipe_id) {\n            console.info(\n              `[]  ROLL :  ${message_id}, ` +\n                `swipe_id: ${summaryRecord.swipe_id}  ${currentSwipeId}`,\n            );\n\n            // \"\"\n            _.set(rollVarsForSummary, 'stat_data..', {\n              sceneNum: summaryRecord.,\n              dreamEntryId: summaryRecord.ID,\n              dreamExitId: summaryRecord.ID,\n            });\n\n            // \n            _.set(rollVarsForSummary, 'stat_data.._', undefined);\n\n            //  ROLL \n            const sceneKey = `${summaryRecord.}`;\n            if (summaryRecord. === 5) {\n              _.set(rollVarsForSummary, `stat_data..${sceneKey}.`, undefined);\n            } else {\n              _.set(rollVarsForSummary, `stat_data..${sceneKey}.`, undefined);\n            }\n\n            await Mvu.replaceMvuData(rollVarsForSummary, { type: 'message', message_id: message_id });\n            console.info(\n              `[]  ROLL ${summaryRecord.} GENERATION_ENDED `,\n            );\n          }\n        }\n      } else {\n        if (processedEvents.has(messageKey)) {\n          console.info(`[] : ${messageKey}`);\n          return;\n        }\n      }\n\n      processedEvents.add(messageKey);\n\n      // \n      if (processedEvents.size > 100) {\n        const oldestKeys = Array.from(processedEvents).slice(0, processedEvents.size - 100);\n        oldestKeys.forEach(key => processedEvents.delete(key));\n      }\n\n      // \n      // GENERATION_ENDED:  getLastMessageId()ID\n      // MESSAGE_RECEIVED: ID\n      // MESSAGE_SWIPED: ROLLID\n      // \n      const targetMessageId = message_id;\n      const actualLastId = getLastMessageId();\n\n      console.info(`[] =${targetMessageId}, =${actualLastId}, =${eventType}`);\n\n      // \n      const currentVars = Mvu.getMvuData({ type: 'message', message_id: targetMessageId });\n      const statData = _.get(currentVars, 'stat_data');\n\n      if (!statData) {\n        console.warn('[] stat_data ');\n        return;\n      }\n\n      // CRITICAL: \n      const data = Schema.parse(JSON.parse(JSON.stringify(statData)));\n\n      // \n      let userText = '';\n      let aiText = '';\n      try {\n        const lastMessages = getChatMessages(-1);\n        const prevMessages = getChatMessages(-2);\n        const lastMessage = lastMessages.length > 0 ? lastMessages[0] : null;\n        const userMessage = prevMessages.length > 0 ? prevMessages[0] : null;\n        userText = userMessage && userMessage.role === 'user' ? (userMessage.message ?? '') : '';\n        aiText = lastMessage && lastMessage.role === 'assistant' ? (lastMessage.message ?? '') : '';\n      } catch (msgErr) {\n        console.warn('[] :', msgErr);\n      }\n\n      console.info(`\\n`);\n      console.info(`[]  ${targetMessageId}`);\n      console.info(`: ${data..}`);\n      console.info(`: ${getCurrentRouteType(data)}`);\n      console.info(`\\n`);\n\n      // \n\n      // 0. \n      // Bug #19 MVU\n      let exitInfo = data..;\n\n      // \n      // MVUoptional\n      if (!exitInfo && targetMessageId > 0) {\n        try {\n          const prevVars = Mvu.getMvuData({ type: 'message', message_id: targetMessageId - 1 });\n          const prevStatData = _.get(prevVars, 'stat_data');\n          if (prevStatData?.?.) {\n            exitInfo = prevStatData..;\n            console.info(\n              `[] Bug #19 (${targetMessageId - 1})` +\n                `${exitInfo.sceneNum}ID: ${exitInfo.dreamEntryId}`,\n            );\n          }\n        } catch (err) {\n          console.warn('[] :', err);\n        }\n      }\n\n      if (exitInfo) {\n        console.info(\n          `[] ${exitInfo.sceneNum}ID: ${exitInfo.dreamEntryId}ID: ${exitInfo.dreamExitId ?? ''}`,\n        );\n        data.. = {\n          sceneNum: exitInfo.sceneNum,\n          dreamEntryId: exitInfo.dreamEntryId,\n          dreamExitId: exitInfo.dreamExitId, // Bug #25ID\n        };\n        data.. = undefined; // \n      }\n\n      // Bug #005  promptInjection.tsAI\n      //  AI \n\n      // 1. MVU\n      const timeSkipResult = TimeSystem.processTimeSkipRequest(data, userText);\n      if (timeSkipResult.processed && timeSkipResult.blocked) {\n        // MVU\n        if (timeSkipResult.mvuMessage) {\n          console.warn(`[] ${timeSkipResult.mvuMessage}`);\n          toastr.warning(timeSkipResult.mvuMessage, '', { timeOut: 4000 });\n        }\n      }\n\n      // 1.4. 5 promptInjection.ts\n      // 2026-01-20 5 promptInjection.ts  CHAT_COMPLETION_PROMPT_READY \n      // 1-4\n      // \n      const SLEEPING_PILL_KEYWORDS = ['', '', '', ''];\n      const wantEnterScene5 =\n        SLEEPING_PILL_KEYWORDS.some(kw => userText.includes(kw)) &&\n        (data.. === '' || data.. === '') &&\n        data.. >= 8 &&\n        data.. < 20;\n\n      if (wantEnterScene5) {\n        console.info('[] 5 promptInjection.ts ');\n      }\n\n      // Bug #27  MESSAGE_RECEIVED \n      // Bug #26  MESSAGE_RECEIVED  GENERATION_ENDED \n      //  8910\n      // ROLL (MESSAGE_SWIPED) \n      console.info(`[] : eventType=${eventType}, targetMessageId=${targetMessageId}`);\n      console.info(\n        `[] : ${data..}, =${data..}, =${data..}`,\n      );\n      if (eventType === 'MESSAGE_RECEIVED') {\n        const timeBeforeAdvance = data..; // \n        console.info(`[]  TimeSystem.advance(), timeBeforeAdvance=${timeBeforeAdvance}`);\n        TimeSystem.advance(data, 1);\n        const timeAfterAdvance = data..; // \n        console.info(`[] TimeSystem.advance() , timeAfterAdvance=${timeAfterAdvance}`);\n\n        // BUG-007/008/009 \n        TimeSystem.validateAndFixTimeConsistency(data);\n\n        // \n        // \n        if (targetMessageId === getLastMessageId()) {\n          const timeCheck = TimeSystem.checkTimeAdvancementAfterScript(\n            timeBeforeAdvance,\n            timeAfterAdvance,\n            targetMessageId,\n          );\n          if (timeCheck.shouldWarn && timeCheck.message) {\n            toastr.warning(timeCheck.message, '', { timeOut: 6000 });\n          }\n        }\n      } else if (eventType === 'MESSAGE_SWIPED') {\n        console.info('[] MESSAGE_SWIPED: ');\n      } else {\n        console.info('[] GENERATION_ENDED:  MESSAGE_RECEIVED ');\n      }\n      console.info(\n        `[] : ${data..}, =${data..}, =${data..}`,\n      );\n\n      // 1.5. 520:00\n      // Bug #13 \n      // - promptInjection  19:00 \n      // - AI \n      // -  20:00\n      // -  20:00\n      if (data.. === '') {\n        const scene5Data = data..5 as { ?: boolean } | undefined;\n        const isInScene5 = scene5Data?. === true;\n\n        if (isInScene5 && data.. === 20) {\n          console.info('[] 20:005');\n          data.. = '';\n          data.. = true;\n          updateSnapshotValue('.', ''); // \n\n          // Bug #28 \n          // \n          updateZhaoxiaLocation(data);\n          updateZhaoxiaThoughtAfterDream(data);\n\n          // 512\n          const completion = calculateScene5CompletionNew(data);\n          const scene5 = data..5 as any;\n\n          // Bug #13 \n          //  100% = \n          //  < 100% = \n          if (completion.completionPercent >= 100) {\n            // \n            if (!data...includes(5)) {\n              data...push(5);\n            }\n            // 1-2-3\n            lockScene5EntryCoherence(data);\n            console.info(`[] 5100% ${data..5}`);\n          } else {\n            // \n            if (scene5?. !== undefined) {\n              const oldConfusion = data..;\n              data.. = scene5.;\n              console.info(`[]  ${oldConfusion}  ${scene5.}`);\n            }\n            if (scene5?.) {\n              const wasMarked = data...;\n              data.. = JSON.parse(JSON.stringify(scene5.));\n              console.info(`[]  ${wasMarked}  ${scene5..}`);\n            }\n            console.info(\n              `[] 5${completion.completionPercent}%<100%`,\n            );\n          }\n\n          // 5\"\"\n          if (scene5) {\n            scene5. = false;\n          }\n\n          console.info(\n            `[] 520:00` +\n              `: ${completion.completionPercent}%` +\n              `: ${completion.currentStep}/12` +\n              `: ${completion.completionPercent >= 100 ? '(100%)' : '(<100%)'}`,\n          );\n\n          // \"\"\n          // 20:00\n          let scene5DreamEntryId = data.._ID;\n\n          // Bug #19  _ID \n          if (scene5DreamEntryId === undefined) {\n            // 51210-15\n            const estimatedEntryId = Math.max(0, targetMessageId - 12);\n            console.warn(\n              `[] Bug #19 5 _ID  ${estimatedEntryId} ${targetMessageId}`,\n            );\n            scene5DreamEntryId = estimatedEntryId;\n          }\n\n          if (scene5DreamEntryId !== undefined) {\n            // Bug #25 ID\n            const scene5DreamExitId = targetMessageId; // \n            data.. = {\n              sceneNum: 5,\n              dreamEntryId: scene5DreamEntryId,\n              dreamExitId: scene5DreamExitId, // Bug #25ID\n            };\n            console.info(\n              `[] 5ID: ${scene5DreamEntryId}ID: ${scene5DreamExitId}`,\n            );\n          } else {\n            console.warn(`[] 5ID`);\n          }\n        }\n      }\n\n      // AI\n      // AI\n      createDataSnapshot(data);\n\n      // 2. \n      const  = validateAndFixState(data);\n      if (.fixed) {\n        console.info(`[]  ${.changes.length} `);\n      }\n\n      // 3. \n      const  = checkRealmChange(data);\n      if (.changed) {\n        const  = data..;\n        const  = getRealmTitle(.newRealm, );\n        const  = getStyleGuidance(.newRealm, );\n        console.info(\n          `[] : ${.oldRealm}  ${.newRealm}\\n` +\n            `  : ${}\\n` +\n            `  : ${ ? '' : ''}\\n` +\n            `  : ${.}\\n` +\n            `  : ${..join('')}`,\n        );\n      }\n\n      // 4.  -  promptInjection.ts \n      // \"A\" AI \n      //  CHAT_COMPLETION_PROMPT_READY \n      //  promptInjection.ts  generateFullInjection() \n\n      // 5. \n      // 2026-01-17  AI \n      // - \n      // -  AI  BODY_PROGRESS \n      // -  AI \n      // - 55\n      // - 480-100%\n      const isInScene5 = data..5?. === true;\n      if (data.. === '' && !isInScene5) {\n        // AI\n        const validatedProgress = validateAndProcessAIReport(userText || '', aiText || '');\n\n        const hasProgress = Object.values(validatedProgress).some(v => v > 0);\n        if (hasProgress) {\n          updateBodyPartProgress(data, validatedProgress);\n          console.info(`[] `);\n        }\n      }\n\n      // 5.5  = \n      // AI\n      //  \n      if (data.. && data.. === '') {\n        updateTruthModeValues(data);\n      }\n\n      // 6. \n      updateHusbandLocation(data);\n\n      // 6.5 \n      // \n      // Bug #14 userTextAIaiText\n      // AI\n      // Bug #XX Day 5+ \n      // Bug #002 \n      // AI\n      const isDreamExitMessage = data.. !== undefined;\n      if (isDreamExitMessage) {\n        console.info(`[] `);\n      }\n      const shouldSkipSuspicion = data.. >= 5 || isDreamExitMessage;\n      if (data.. === '' && data.. && !shouldSkipSuspicion) {\n        // Bug #005 \n        // \n        applySuspicionDecrease(data, userText);\n\n        const newSuspicion = updateSuspicionLevel(data, userText);\n\n        // Bug #24 100\n        // \n        if (newSuspicion >= 100 && data.. === '') {\n          data.. = '';\n          data.. = '';\n          data.. = TimeSystem.getCurrentTime(data);\n          // \n          updateSnapshotValue('.', '');\n          updateSnapshotValue('.', '');\n          console.warn('[]  100');\n        }\n      }\n\n      // 7. \n      checkDreamEvents(data, userText, targetMessageId);\n\n      // 8. AI\n      // Bug #7  <HusbandThought> \n      // AI\n      // Bug #10  <!--BODY_PROGRESS: ...--> \n      if (aiText) {\n        const husbandThought = parseHusbandThought(aiText);\n\n        // \n        //  <HusbandThought>  <!--BODY_PROGRESS: ...--> \n        const cleanedAiText = aiText\n          .replace(/<HusbandThought>[\\s\\S]*?<\\/HusbandThought>/gi, '')\n          .replace(/<!--\\s*BODY_PROGRESS:\\s*[^-]*?-->/gi, '')\n          .trim();\n        if (cleanedAiText !== aiText) {\n          try {\n            // Bug  getLastMessageId()  AI  ID\n            // targetMessageId  AI \n            // aiText  getChatMessages(-1) ID\n            const aiMessageId = getLastMessageId();\n            await setChatMessages([{ message_id: aiMessageId, message: cleanedAiText }], { refresh: 'affected' });\n            console.info(`[] AIHusbandThought/BODY_PROGRESS=${aiMessageId}`);\n          } catch (err) {\n            console.warn('[] :', err);\n          }\n        }\n\n        // Bug \n        // AI\n        //  shouldGenerateHusbandThought \n        if (husbandThought) {\n          // \n          data.. = husbandThought;\n          console.info(`[] : ${husbandThought}`);\n\n          // \n          if (shouldGenerateHusbandThought(data)) {\n            broadcastGameEvent({\n              type: 'HUSBAND_PERSPECTIVE',\n              data: {\n                text: husbandThought,\n                realm: data..,\n                suspicionLevel: data..,\n              },\n            });\n          } else {\n            console.info('[] AI');\n          }\n        }\n      }\n\n      // 9. \n      const  = checkEnding(data);\n\n      // 10. AI\n      // Bug #40 \n      if (isTrueEndingActive(data) && aiText) {\n        const state = getTrueEndingState(data);\n        if (!state.isComplete) {\n          const currentHour = data..;\n\n          // processTurnEndAI\n          const result = processTurnEnd(state, aiText, userText, currentHour);\n          let finalState = result.newState;\n\n          // Bug #40 \n          // \n          if (result.timeBlocked) {\n            console.info(\n              `[] ${finalState.currentPhase}${result.timeBlocked.reason}`,\n            );\n            console.info(\n              `[] : ${finalState.currentPhase}, ` +\n                `[${finalState.completedAnchors.join(', ')}]`,\n            );\n          } else if (result.phaseAdvanced) {\n            // processTurnEnd \n            console.info(`[] : ${state.currentPhase}  ${finalState.currentPhase}`);\n\n            // \n            if (finalState.isComplete) {\n              data.. = true;\n              data.. = '';\n              console.info('[]  ');\n            }\n          } else {\n            console.info(\n              `[] : ${finalState.currentPhase}, ` +\n                `[${finalState.completedAnchors.join(', ')}]`,\n            );\n          }\n\n          // \n          updateTrueEndingState(data, finalState);\n        }\n      }\n\n      // 11. AI\n      // Bug #40 \n      if (isFalseEndingActive(data) && aiText) {\n        const state = getFalseEndingState(data);\n        if (!state.isComplete) {\n          const currentHour = data..;\n\n          // processTurnEndAI\n          const result = processFalseEndingTurnEnd(state, aiText, userText, currentHour);\n          let finalState = result.newState;\n\n          // Bug #40 \n          // \n          if (result.timeBlocked) {\n            console.info(\n              `[] ${finalState.currentPhase}${result.timeBlocked.reason}`,\n            );\n            console.info(\n              `[] : ${finalState.currentPhase}, ` +\n                `[${finalState.completedAnchors.join(', ')}]`,\n            );\n          } else if (result.phaseAdvanced) {\n            // processTurnEnd \n            console.info(`[] : ${state.currentPhase}  ${finalState.currentPhase}`);\n\n            // \n            if (finalState.isComplete) {\n              console.info('[]  ');\n            }\n          } else {\n            console.info(\n              `[] : ${finalState.currentPhase}, ` +\n                `[${finalState.completedAnchors.join(', ')}]`,\n            );\n          }\n\n          // \n          updateFalseEndingState(data, finalState);\n        }\n      }\n\n      // 12. AI\n      // Bug #40 \n      if (isPerfectEndingActive(data) && aiText) {\n        const state = getPerfectEndingState(data);\n        if (!state.isComplete) {\n          const currentHour = data..;\n\n          // processPerfectTurnEndAI\n          const result = processPerfectTurnEnd(state, aiText, userText, currentHour);\n          let finalState = result.newState;\n\n          // Bug #40 \n          // \n          if (result.timeBlocked) {\n            console.info(\n              `[] ${finalState.currentPhase}${result.timeBlocked.reason}`,\n            );\n            console.info(\n              `[] : ${finalState.currentPhase}, ` +\n                `[${finalState.completedAnchors.join(', ')}]`,\n            );\n          } else if (result.phaseAdvanced) {\n            // processPerfectTurnEnd \n            console.info(`[] : ${state.currentPhase}  ${finalState.currentPhase}`);\n\n            // 120-11\n            if (finalState.isComplete) {\n              data.. = true;\n              data.. = '';\n              console.info('[]  ');\n            }\n          } else {\n            console.info(\n              `[] : ${finalState.currentPhase}, ` +\n                `[${finalState.completedAnchors.join(', ')}]`,\n            );\n          }\n\n          // \n          updatePerfectEndingState(data, finalState);\n        }\n      }\n\n      // 7. \n      if (data.?.) {\n        TimeSystem.validate(data);\n      }\n\n      // AI\n      const protectionResult = validateAndRestoreData(data);\n      if (protectionResult.detected) {\n        console.warn(`[]  ${protectionResult.tamperedFields.length} `);\n        if (data.?.) {\n          console.info(generateProtectionReport(protectionResult));\n        }\n      }\n\n      // \n      const validatedData = Schema.parse(data);\n      console.info(`[]  ${targetMessageId}`);\n      console.info(\n        `[] : ${validatedData..}, =${validatedData..}, =${validatedData..}`,\n      );\n\n      // CRITICAL:  currentVars\n      const newVars = JSON.parse(JSON.stringify(currentVars));\n      _.set(newVars, 'stat_data', validatedData);\n      await Mvu.replaceMvuData(newVars, { type: 'message', message_id: targetMessageId });\n      console.info(`[] Mvu.replaceMvuData `);\n\n      console.info(`\\n`);\n      console.info(`[]  ${targetMessageId}`);\n      console.info(`: ${validatedData..}`);\n      console.info(`: ${getCurrentRouteType(validatedData)}`);\n      console.info(`: ${validatedData..}`);\n      console.info(`: ${validatedData..}`);\n      console.info(`: ${validatedData..}`);\n      console.info(`: ${validatedData..}`);\n      console.info(`: ${validatedData..}`);\n      if () {\n        console.info(` : ${validatedData..}`);\n      }\n      console.info(`\\n`);\n\n      // ============================================\n      // 8. \n      //  generateRaw API\n      // ============================================\n      if (validatedData.. && eventType === 'GENERATION_ENDED') {\n        const summaryInfo = validatedData..;\n        console.info(\n          `[] ${summaryInfo.sceneNum}: ${summaryInfo.dreamEntryId}: ${summaryInfo.dreamExitId ?? ''}`,\n        );\n\n        try {\n          // Bug #25 ID\n          const chatHistory = await getDreamSessionMessages(summaryInfo.dreamEntryId, summaryInfo.dreamExitId);\n          console.info(`[] : ${chatHistory.length}`);\n\n          //  API\n          const summary = await generateMemorySummary(validatedData, summaryInfo.sceneNum, chatHistory);\n\n          // \n          const sceneKey = `${summaryInfo.sceneNum}` as keyof typeof validatedData.;\n          const sceneData = validatedData.[sceneKey];\n          if (sceneData && typeof sceneData === 'object') {\n            if (summaryInfo.sceneNum === 5) {\n              (sceneData as any). = summary;\n            } else {\n              (sceneData as any). = summary;\n            }\n          }\n\n          // \n          validatedData.. = undefined;\n\n          // ROLL IDswipe_id\n          //  ROLL \"\"\n          const summarySwipeId = getSwipeId(targetMessageId);\n          validatedData.._ = {\n            ID: targetMessageId,\n            swipe_id: summarySwipeId,\n            : summaryInfo.sceneNum,\n            ID: summaryInfo.dreamEntryId,\n            ID: summaryInfo.dreamExitId,\n          };\n          console.info(\n            `[] : ${targetMessageId}, swipe_id=${summarySwipeId}, ${summaryInfo.sceneNum}`,\n          );\n\n          // \n          const finalVars = JSON.parse(JSON.stringify(currentVars));\n          _.set(finalVars, 'stat_data', validatedData);\n          await Mvu.replaceMvuData(finalVars, { type: 'message', message_id: targetMessageId });\n\n          console.info(`[] ${summaryInfo.sceneNum}${summary.length}`);\n        } catch (summaryErr) {\n          console.error('[] :', summaryErr);\n          // \n          validatedData.. = undefined;\n          const finalVars = JSON.parse(JSON.stringify(currentVars));\n          _.set(finalVars, 'stat_data', validatedData);\n          await Mvu.replaceMvuData(finalVars, { type: 'message', message_id: targetMessageId });\n        }\n      }\n\n      // \n      const verifyVars = Mvu.getMvuData({ type: 'message', message_id: targetMessageId });\n      const verifyData = _.get(verifyVars, 'stat_data');\n      const expectedTime = TimeSystem.getCurrentTime(validatedData);\n\n      if (verifyData?.?. !== expectedTime) {\n        console.error('[]  ');\n        console.error(`: ${expectedTime}`);\n        console.error(`: ${verifyData?.?.}`);\n      } else {\n        console.info(`[]  ${eventType} `);\n      }\n    } catch (err) {\n      console.error('[] :', err);\n    }\n  }\n\n  // \n  eventOn(tavern_events.MESSAGE_RECEIVED, message_id => {\n    const id = Number(message_id);\n    console.info(`[]  MESSAGE_RECEIVED message_id=${id}`);\n    setTimeout(() => {\n      processGameLogic(id, 'MESSAGE_RECEIVED');\n    }, 300);\n  });\n\n  // ROLL\n  eventOn(tavern_events.MESSAGE_SWIPED, message_id => {\n    const id = Number(message_id);\n    console.info(`[]  MESSAGE_SWIPED message_id=${id}`);\n    setTimeout(() => {\n      processGameLogic(id, 'MESSAGE_SWIPED');\n    }, 300);\n    // [] \n    // setTimeout(() => {\n    //   console.info('[]  IFRAME_DATA_REFRESH  (MESSAGE_SWIPED)');\n    //   eventEmit('IFRAME_DATA_REFRESH', { reason: 'MESSAGE_SWIPED', message_id: id });\n    // }, 500);\n  });\n\n  // \n  eventOn(tavern_events.MESSAGE_DELETED, message_id => {\n    const id = Number(message_id);\n    console.info(`[]  MESSAGE_DELETED message_id=${id}`);\n\n    const keysToRemove = Array.from(processedEvents).filter(key => {\n      const keyMessageId = parseInt(key.split(':')[0], 10);\n      return keyMessageId >= id;\n    });\n    if (keysToRemove.length > 0) {\n      keysToRemove.forEach(key => processedEvents.delete(key));\n      console.info(`[] MESSAGE_DELETED  ${keysToRemove.length} `);\n    }\n\n    // [] \n    // setTimeout(() => {\n    //   console.info('[]  IFRAME_DATA_REFRESH  (MESSAGE_DELETED)');\n    //   eventEmit('IFRAME_DATA_REFRESH', { reason: 'MESSAGE_DELETED', message_id: id });\n    // }, 300);\n  });\n\n  // \n  eventOn(tavern_events.GENERATION_ENDED, message_id => {\n    console.info(`[]  GENERATION_ENDED  message_id=${message_id}`);\n    setTimeout(() => {\n      try {\n        const actualMessageId = getLastMessageId();\n        console.info(`[] GENERATION_ENDED  message_id=${actualMessageId}`);\n        processGameLogic(actualMessageId, 'GENERATION_ENDED');\n      } catch (err) {\n        console.warn(`[] GENERATION_ENDED :`, err);\n        processGameLogic(Number(message_id), 'GENERATION_ENDED');\n      }\n    }, 300);\n    // [] \n    // setTimeout(() => {\n    //   try {\n    //     const actualMessageId = getLastMessageId();\n    //     console.info('[]  IFRAME_DATA_REFRESH  (GENERATION_ENDED)');\n    //     eventEmit('IFRAME_DATA_REFRESH', { reason: 'GENERATION_ENDED', message_id: actualMessageId });\n    //   } catch (err) {\n    //     console.warn('[] GENERATION_ENDED :', err);\n    //   }\n    // }, 800);\n  });\n\n  console.info('[] ');\n});\n"],"names":["z","Schema","object","number","min","max","default","string","boolean","enum","optional","sceneNum","dreamEntryId","dreamExitId","swipe_id","array","nullable","isActive","isComplete","currentPhase","turnsInPhase","totalTurns","completedAnchors","noProgressTurns","hintGiven","record","TimeSystem","advance","data","hours","console","info","oldTime","oldDay","oldHour","rawTime","this","calculateRawTime","day","hour","finalDay","finalHour","formatTime","Date","now","newTime","success","currentDay","currentHour","totalHours","toString","padStart","static","shouldSkipAdvance","elapsed","lastAdvanceTimestamp","DEBOUNCE_INTERVAL","warn","updateAdvanceTimestamp","validateAndFixTimeConsistency","expectedTime","error","parseTimeString","timeStr","match","parseInt","getCurrentTime","isDreamWindowOpen","isEndingTime","isTrueEndingGuidanceTime","isWakeUpTime","isDay5NightDreamBlocked","getHoursUntilReset","remaining","Math","detectTimeSkipIntent","userInput","normalizedInput","toLowerCase","sleepKeywords","keyword","includes","hasIntent","targetHour","skipType","nextDayKeywords","processTimeSkipRequest","intent","processed","blocked","mvuMessage","validate","checkTimeAdvancementAfterScript","beforeTime","afterTime","messageId","shouldWarn","message","detectTimeJumpDescription","currentTime","TIME_JUMP_KEYWORDS","category","keywords","Object","entries","detected","matchedKeyword","reminderPrompt","clamp","value","getRealmNamePure","realm","getRealmNameTruth","lastRealm","PURE_LOVE_APPEARANCE_CONFIG","TRUTH_APPEARANCE_CONFIG","getAppearanceConfig","getStyleGuidance","realmConfig","getRealmTitle","ALL_BODY_PARTS","calculateDependencyFromBodyProgress","values","map","part","average","reduce","sum","v","length","round","calculateMoralBaselineFromDependency","BODY_PART_DEVELOPMENT_LEVELS","range","BODY_PART_BEHAVIOR_MAP","getBodyPartStatus","progress","generateDetailedInteractionPrompt","getAllowedInteractions","join","prompt","generateAppearanceConstraintPrompt","constraints","getRealmConstraints","guidance","title","updateZhaoxiaLocation","random","updateZhaoxiaThoughtAfterDream","substring","EXPOSURE_CLOTHING_KEYWORDS","HEAVY_MAKEUP_KEYWORDS","INTIMATE_BEHAVIOR_KEYWORDS","countKeywordsInText","text","count","calculateSuspicionIncrease","userInputText","result","detectClothingExposure","push","detectMakeupIntensity","detectIntimacyLevel","HUSBAND_INTERACTION_KEYWORDS","calculateSuspicionDecrease","some","kw","detectHusbandInteraction","SCENE5_STEPS","step","phase","description","bestMatch","aiTask","calculateMemoryCoherence","completedScenes","Set","hasScene1","has","hasScene2","hasScene3","hasScene4","level","aiHint","lockScene5EntryCoherence","coherence","getScene5LockedCoherence","locked","undefined","amount","shouldIncreaseMemoryConfusion","oldValue","actualIncrease","INTENT_KEYWORDS","analyzePlayerIntent","attitude","behavior","goal","calculateMatchLevel","best","matchCount","totalRequired","calculateScene5Completion","scene5Data","entryCount","currentStep","isStepsComplete","completionPercent","stepProgressRecord","maxAvailableSteps","canTriggerSpecialEnding","getBodyInfluenceForScene5","influences","bodyParts","acc","avgProgress","floor","hasInfluence","generateScene5StepPrompt","completion","remainingSteps","maxStepsFromTime","storyRemaining","getRemainingSteps","bodyInfluence","generateFreePlayPrompt","nextStep","stepConfig","matchLevel","progressGain","bodyInfluenceText","i","intentSummary","matchNote","remainingHours","timeGuidance","SCENE_INFO","age","generateScene5EntryReplacement","maxSteps","isFirstEntry","missingEffects","effects","getMissingMemoryEffects","previousSummaries","summaries","sceneKey","sceneData","sceneInfo","isCorrect","generatePreviousSceneSummaries","coherenceText","userMessage","prefill","generateCoherenceBasedPrefill","generateScene5ForceExitReplacement","generateScene5StepReplacement","BODY_PART_KEYWORDS","INTERACTION_INTENT_KEYWORDS","validateAndProcessAIReport","aiResponse","scriptDetected","inputPreview","matchedKeywords","filter","increment","SINGLE_DETECTION_MAX","PROGRESS_PER_KEYWORD","detectBodyPartProgress","aiSuggested","progressMatch","progressStr","partPatterns","patterns","pattern","regex","RegExp","clampedValue","AI_SUGGESTION_MAX","parseAIBodyProgressSuggestion","trim","hasInteractionIntent","getDevelopmentLevel","name","getCurrentDreamSceneNumber","updateBodyPartProgress","progressIncrement","currentScene","allowedParts","getAllowedBodyParts","remainingCap","actualIncrement","oldProgress","newProgress","oldLevel","newLevel","blockedParts","p","SCENE_CORRECT_ANSWERS","processSceneCompletion","sceneNumber","selectedParts","correctAnswers","uniqueSelectedParts","sortedSelected","sort","sortedCorrect","every","index","checkCorrectSelection","actualPenalty","generateMemoryContinuityPrompt","s","memorySummary","DREAM_SCENE_INFO","theme","extractEmotionalReaction","aiOutput","emotionKeywords","sentences","replace","split","emotionalSentences","sentence","trimmed","slice","async","getDreamSessionMessages","dreamEntryMessageId","dreamExitMessageId","chatMessages","SillyTavern","chat","Array","isArray","entryIndex","endIndex","dreamMessages","playerMessages","m","is_user","mes","aiMessages","emotionalReactions","msg","reaction","playerCount","aiCount","r","err","generateMemorySummary","_data","chatHistory","summary","generateEnhancedMemoryContinuityPrompt","hasScene5Memory","previousMemories","scene5Info","scene5Completion","isScene5Correct","currentSceneInfo","scene4SpecialGuide","parseHusbandThought","aiText","thought","cleaned","listMatches","cleanThinkingContent","invalidPatterns","test","chineseChars","totalChars","chineseRatio","toFixed","isValidHusbandThought","shouldGenerateHusbandThought","getCurrentRouteType","BOUNDARY_MAP","MOUTH_INTENSITY_KEYWORDS","checkMouthIntensityViolation","currentRealm","intensity","BODY_PART_DETECTION_KEYWORDS","detectMouthIntensity","violated","BODY_PART_REQUIRED_REALM","HUMILIATION_KEYWORDS","checkHumiliationAllowed","detectHumiliationBehavior","allowed","checkBoundaryInterruption","shouldSkipBoundaryInterruption","shouldInterrupt","severity","violatedParts","realmGap","interruptProbability","wasInterrupted","triggerBadEnd","detectedParts","detectBodyParts","mouthIntensityCheck","mouthIntensityViolation","humiliationCheck","humiliationViolation","maxRealmGap","intensityGap","humiliationGap","gap","canHusbandInterrupt","husbandSuspicion","randomRoll","correctionPrompt","firstViolatedPart","isFirstPartMouthIntensity","reason","prompts","extreme_violation","generateBadEndPrompt","generateInterruptionPrompt","bodyPart","husbandCanInterrupt","isMouthIntensityViolation","randomChoice","MOUTH_INTENSITY_VIOLATION_TEMPLATES","template","REFUSAL_TEMPLATES_HUSBAND_HOME","REFUSAL_TEMPLATES_HUSBAND_AWAY","generateRefusalPrompt","penalties","SEVERE_INTERRUPTION_TEMPLATES","MODERATE_INTERRUPTION_TEMPLATES","arr","DANGEROUS_KEYWORDS","detectDangerousContent","currentSuspicion","badEndProbability","shouldTriggerBadEnd","action","generateBadEndingText","correctedPrompt","generateSevereWarningPrompt","generateCorrectionPrompt","_category","_originalInput","shouldSkipDangerousContentDetection","DISCOVERY_INITIAL_TEMPLATES","DISCOVERY_LOCKED_TEMPLATES","checkBadEnding","isAlreadyInBadEnding","isInBadEndingLock","replaceUserMessage","triggered","type","isInScene5","applyBadEndingState","ProtectionLevel","PROTECTED_FIELDS","SCRIPT_ONLY","READONLY","ABSOLUTE","currentSnapshot","getNestedValue","obj","path","keys","current","key","setNestedValue","updateSnapshotValue","JSON","stringify","deepEqual","a","b","val","idx","aObj","bObj","aKeys","bKeys","scriptAuthToken","NORMAL_ENDING_LOCKED_TEMPLATES","checkNormalEnding","isInNormalEndingLock","firstGreeting","messages","getChatMessages","firstMessage","role","getFirstAIMessage","greetingText","generateNormalEndingInitialTemplate","generatePureLoveEndingTemplate","ending","TRUE_ENDING_PHASES","minTurns","maxTurns","minHour","anchorEvents","aiGuidance","correctionHints","strict","expectedActions","hintThreshold","progressHint","getGuidanceType","isPerfectTrueEnding","isTrueEndingActive","endingState","getTrueEndingState","updateTrueEndingState","state","ANCHOR_KEYWORDS","canEnterNextPhase","nextPhase","nextConfig","waitHours","hasExpectedAction","phaseConfig","input","checkProgressHint","threshold","processTurnEnd","newState","newAnchors","completed","anchor","detectCompletedAnchors","allAnchors","updatedState","hasProgress","hint","updateProgressTracking","phaseAdvanced","newPhase","shouldAdvancePhase","canEnter","timeBlocked","advanceToNextPhase","generateTrueEndingPrompt","remainingAnchors","isTimeLocked","turnsWarning","remainingTurns","timeBlockWarning","progressInfo","hintSection","urgencyHint","generateTrueEndingEntryReplacement","isPerfect","endingTitle","generateTimeBasedPrompt","guidanceType","generateFreeTimePrompt","phaseName","roomPrompt","generateRoomTriggerPrompt","FALSE_ENDING_PHASES","isFalseEndingActive","getFalseEndingState","updateFalseEndingState","canEnterNextFalsePhase","timeCheck","generateFalseEndingPrompt","generateFalseEndingComplete","allKeywords","flatMap","kws","k","isInputOnTrack","hints","PERFECT_ENDING_PHASES","isPerfectEndingActive","getPerfectEndingState","updatePerfectEndingState","PERFECT_ANCHOR_KEYWORDS","canEnterNextPerfectPhase","processPerfectTurnEnd","detectPerfectAnchors","shouldAdvancePerfectPhase","advanceToPerfectNextPhase","SEXUAL_BEHAVIOR_KEYWORDS","INTERRUPTION_KEYWORDS","CONFUSION_INITIAL_TEMPLATES","CONFUSION_LOCKED_TEMPLATES","SEXUAL_WARNING_TEMPLATES","confusion","detectSexualBehavior","hasAction","hasPart","detectWeddingInterruption","hasInterruption","isPerfectMemoryRoute","getViolationIncrement","markConfusionEnding","currentGlobalHour","checkConfusionEnding","forceFirstTrigger","isFirstTrigger","applyConfusionEndingState","checkScene5Violations","interruptionResult","shouldMarkConfusion","oldConfusion","checkWeddingInterruptionInScene5","warningMessage","sexualResult","currentConfusion","currentCount","maxAllowed","newCount","newConfusion","checkSexualBehaviorInScene5","SCENE_CONFUSION_VALUES","PERFECT_TRUE_AFTER_STORY","husbandStatus","interruptionLevel","round1","setting","round2","TRUE_ENDING_AFTER_STORY","FALSE_ENDING_AFTER_STORY","getAfterStoryType","isInAfterStory","isInFreeMode","getAfterStoryConfig","FREE_MODE_SETTINGS","timeFrame","relationship","zhaoXiaState","husbandState","suggestedScenes","tone","ENDING_GUIDANCE","DREAM_SCENE_DETAILS","DREAM_ENTRY_KEYWORDS","DREAM_ENTRY_PATTERNS","SLEEPING_PILL_KEYWORDS","DREAM_SCENE_THEMES","atmosphere","objective","identity","SCENE1_INIT_CONFIG","favorWeight","intimacyWeight","maxValue","minValue","baseValue","intimacyReduction","calculateScene1InitValues","rawDependence","initialDependence","rawMorality","initialMorality","relationshipStage","transferDescription","favor","intimacy","dependence","morality","stage","generateTransferDescription","getBodyPartInfluenceLevel","acceptanceLevel","generatePhaseAwareStatePrompt","overridePhase","overrideScene5","sceneConfig","guidanceHour","isScene1","isScene2","isScene3","isScene4","pacing","getDreamTimePhaseGuidance","hoursRemaining","sceneAge","reminders","getDreamConstraintReminder","generateDreamPhasePrompt","timeInfo","period","lighting","getHusbandStatusDescription","timeConstraint","getTimeConstraintReminder","husbandConstraint","getHusbandConstraintReminder","realmConstraint","getRealmConstraintReminder","husbandThoughtConstraint","appearancePrompt","interactionPrompt","generateDailyPhasePrompt","generateDreamEntryReplacement","scene","continuityPrompt","initValues","initialAttitude","generateScene1EntryReplacement","chestProgress","scene1Data","hasScene1Memory","playerRelationship","generateScene2EntryReplacement","lowerBodyProgress","scene2Data","hasScene2Memory","generateScene3EntryReplacement","analProgress","scene3Data","memoryCount","Boolean","generateScene4EntryReplacement","getCurrentDreamScene","getSwipeId","isRollOperation","checkIsRollOperation","resetRollOperationFlag","generateFullInjection","systemPrompt","shouldEnterDream","shouldActivateTrueEndingFlag","shouldProgressTrueEnding","trueEndingComplete","shouldActivatePerfectEndingFlag","shouldProgressPerfectEnding","perfectEndingComplete","shouldActivateFalseEndingFlag","shouldProgressFalseEnding","falseEndingComplete","shouldActivateAfterStoryFlag","shouldProgressAfterStory","afterStoryComplete","isInFreeModeFlag","shouldExitDream","shouldEnterScene5","shouldExitScene5","shouldProgressScene5Step","shouldTriggerWrongRoute","wrongRoutePart","shouldTriggerBadEnding","badEndingType","shouldTriggerNormalEnding","normalEndingType","confusionEndingResult","shouldActivateTrueEnding","shouldActivatePerfectEnding","shouldActivateFalseEnding","shouldActivateAfterStory","predictedConfusion","suspicionResult","predictedSuspicion","badEndingResult","normalEndingResult","triggeredPart","parts","checkPureLoveWrongRoute","replacement","scenario","generatePureLoveWrongRouteReplacement","isDreamExitMessage","dangerResult","timeJumpResult","boundaryResult","checkScene5ForceExit","dreamEntryRollInfo","currentMessageId","entryRecord","aiReplyFloor","entryType","expectedAiFloor","isDreamEntryRoll","getLastMessageId","hasKeyword","checkScene5Entry","violationResult","generateScene5FreePlayReplacement","isNormalDreamRoll","checkDreamEntry","dreamExitRollSceneNum","exitRecord","isDreamExitRoll","checkDreamExit","bodySummary","sortedParts","_","developmentSummary","generateDreamExitReplacement","bodyInfluencePrompt","bodyPartConfig","displayName","behaviors","config","influence","behaviorExample","generateBodyPartInfluencePrompt","dreamFeedbackPrompt","phaseOverride","consistencyPrompt","confusionForeshadowing","endingEntryRollType","endingType","isTrueEndingRoll","isPerfectEndingRoll","isFalseEndingRoll","isEndingEntryRoll","endingGuidance","currentEnding","getEndingGuidance","currentDreamSceneNumber","dreamSceneGuidance","isInConfusionEndingLock","getDreamSceneGuidance","dreamHistoryBackground","excludeCurrentScene","correctScenes","scene4Data","generateDreamHistoryBackground","excludeInfo","allCompleted","allCorrect","entryReplacement","isFreeTime","isPerfectEndingFreeTime","freeTimePrompt","perfectEndingPrompt","generatePerfectEndingPrompt","completeMessage","generateTrueEndingComplete","isFreeTimeHour","trueEndingPrompt","falseEndingPrompt","freeModePrompt","settings","generateFreeModePrompt","shouldTriggerAfterStory","generateAfterStoryEntryReplacement","currentRound","generateAfterStoryComplete","afterStoryPrompt","roundConfig","generateAfterStoryPrompt","initPromptInjection","currentRequestHasExtendedThinking","eventOn","tavern_events","CHAT_COMPLETION_SETTINGS_READY","generate_data","include_reasoning","CHAT_COMPLETION_PROMPT_READY","event_data","dryRun","variables","Mvu","getMvuData","message_id","statData","get","parse","lastUserIndex","lastMessages","lastMessage","msgErr","content","shouldActivateTrueEndingResult","shouldProgressTrueEndingResult","trueEndingCompleteResult","shouldActivatePerfectEndingResult","shouldProgressPerfectEndingResult","perfectEndingCompleteResult","shouldActivateFalseEndingResult","shouldProgressFalseEndingResult","falseEndingCompleteResult","shouldActivateAfterStoryResult","shouldProgressAfterStoryResult","afterStoryCompleteResult","isInFreeModeResult","currentVars","currentData","set","replaceMvuData","badEndErr","normalEndErr","initialState","perfectEndErr","progressErr","completeErr","trueEndErr","falseEndErr","activateAfterStory","afterStoryErr","afterStoryMessageId","isAfterStoryRoll","afterStoryData","lastRecord","lastMessageId","lastSwipeId","currentSwipeId","isAfterStoryRollOperation","newSwipeId","advanceAfterStoryRound","applyInterruptionResult","interruptErr","existingScene5Data","newScene5Data","newEntryCount","scene5CurrentFloor","scene5AiReplyFloor","scene5ExitFloor","setTimeout","loadingPopup","deactivateSendButtons","Popup","POPUP_TYPE","TEXT","okButton","cancelButton","show","latestVars","latestData","summaryErr","complete","POPUP_RESULT","AFFIRMATIVE","activateSendButtons","eventEmit","stateErr","newCompletion","currentFloor","estimatedEntryId","isCurrentlyInDream","before","prefillGuidance","broadcastGameEvent","event","checkEnding","size","hasEnteredDream","applyNormalEndingState","checkDreamEvents","userText","targetMessageId","dreamWindowOpen","dreamEnded","firstAwakening","alreadyCompleted","canEnterScene5","memoryContinuityPrompt","levelInfo","getBodyPartSummary","hasEntered","confusionLevel","dreamEntryKeywords","wantToEnterDream","isDreamWindow","isDaily","canEnterForConfusion","canEnterDreamForConfusion","targetValue","setConfusionOnDreamEntry","dreamAiReplyFloor","correctTarget","$","waitGlobalInitialized","events","VARIABLE_UPDATE_ENDED","new_variables","old_variables","newData","oldData","oldSuspicion","newSuspicion","currentStage","newValue","allParts","newThought","oldThought","hasInvalidContent","isTooLong","lowChineseRatio","triggeredWrongRoute","PURE_LOVE_DAILY_LIMIT","oldAffection","newAffection","oldIntimacy","newIntimacy","resetTo","isFirstMessageAfterInit","processedEvents","processGameLogic","eventType","swipeId","messageKey","keysToRemove","from","String","forEach","delete","rollVars","rollStatData","newStep","lastProgressIncrement","currentCompletion","newProgressRecord","rollVarsForSummary","rollStatDataForSummary","summaryRecord","add","actualLastId","prevMessages","exitInfo","prevVars","prevStatData","timeSkipResult","toastr","warning","timeOut","timeBeforeAdvance","timeAfterAdvance","scene5","wasMarked","scene5DreamEntryId","scene5DreamExitId","snapshotData","timestamp","createDataSnapshot","changes","fixed","maxDay","change","validateAndFixState","changed","oldRealm","newRealm","checkRealmChange","validatedProgress","updateTruthModeValues","updateHusbandLocation","shouldSkipSuspicion","applySuspicionDecrease","updateSuspicionLevel","husbandThought","cleanedAiText","aiMessageId","setChatMessages","refresh","suspicionLevel","finalState","protectionResult","snapshot","targetSnapshot","tamperedFields","restoredFields","dataObj","isInDream","isDreamEntryWindow","isScene5Window","originalValue","currentValue","startsWith","to","t","originalNum","currentNum","tamperedValue","timeFields","f","snapshotDay","snapshotHour","snapshotTime","validateAndRestoreData","report","toISOString","field","generateProtectionReport","validatedData","newVars","summaryInfo","summarySwipeId","finalVars","verifyVars","verifyData","VARIABLE_INITIALIZED","MESSAGE_RECEIVED","id","Number","MESSAGE_SWIPED","MESSAGE_DELETED","GENERATION_ENDED","actualMessageId"],"ignoreList":[],"sourceRoot":""}