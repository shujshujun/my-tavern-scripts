{"version":3,"file":"index.js","mappings":"AAAA,MAAM,EAA+BA,ECWxBC,EAAS,EAAAD,EAAEE,OAAO,CAI7B,GAAI,EAAAF,EACDE,OAAO,CAIN,KAAM,EAAAF,EAAEG,SAASC,IAAI,GAAGC,IAAI,IAAIC,QAAQ,GACxC,KAAM,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,IAAIC,QAAQ,GACxC,GAAI,EAAAN,EAAEO,SAASD,QAAQ,gBACvB,IAAK,EAAAN,EAAEG,SAASG,QAAQ,GACxB,QAAS,EAAAN,EAAEQ,UAAUF,SAAQ,GAG7B,KAAM,EAAAN,EAAES,KAAK,CAAC,MAAO,OAAQ,QAAQH,QAAQ,OAC7C,OAAQ,EAAAN,EAAEG,SAASG,QAAQ,GAG3B,OAAQ,EAAAN,EAAEQ,UAAUF,SAAQ,GAG5B,KAAM,EAAAN,EAAES,KAAK,CAAC,KAAM,KAAM,KAAM,OAAOH,QAAQ,MAI/C,UAAW,EAAAN,EAAEG,SAASO,WACtB,QAAS,EAAAV,EAAEG,SAASO,WACpB,QAAS,EAAAV,EAAEQ,UAAUF,SAAQ,GAG7B,MAAO,EAAAN,EACJE,OAAO,CACNS,SAAU,EAAAX,EAAEG,SAASC,IAAI,GAAGC,IAAI,GAChCO,aAAc,EAAAZ,EAAEG,SAChBU,YAAa,EAAAb,EAAEG,SAASO,aAEzBA,WAGH,SAAU,EAAAV,EACPE,OAAO,CACNS,SAAU,EAAAX,EAAEG,SAASC,IAAI,GAAGC,IAAI,GAChCO,aAAc,EAAAZ,EAAEG,SAChBU,YAAa,EAAAb,EAAEG,SAASO,aAEzBA,WAIH,QAAS,EAAAV,EACNE,OAAO,CACN,KAAM,EAAAF,EAAEG,SAASG,SAAS,GAC1B,KAAM,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,GAAGK,WAC/BI,SAAU,EAAAd,EAAEG,SAASG,SAAS,KAE/BI,WAIH,QAAS,EAAAV,EACNE,OAAO,CACN,KAAM,EAAAF,EAAEG,SAASG,SAAS,GAC1B,KAAM,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,GAAGK,WAC/B,GAAI,EAAAV,EAAES,KAAK,CAAC,OAAQ,QAAQC,aAE7BA,WAKH,QAAS,EAAAV,EACNE,OAAO,CACN,KAAM,EAAAF,EAAEG,SAASG,SAAS,GAC1BQ,SAAU,EAAAd,EAAEG,SAASG,QAAQ,GAC7B,KAAM,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,GAAGK,WAC/B,OAAQ,EAAAV,EAAEG,SAASO,WACnB,OAAQ,EAAAV,EAAEG,SAASO,aAEpBA,aAEJJ,QAAQ,CACP,KAAM,EACN,KAAM,EACN,GAAI,eACJ,IAAK,EACL,SAAS,EACT,KAAM,MACN,OAAQ,EACR,QAAQ,EACR,KAAM,KACN,SAAS,IAMb,KAAM,EAAAN,EACHE,OAAO,CAEN,IAAK,EAAAF,EAAEG,SAASC,IAAI,GAAGC,IAAI,KAAKC,QAAQ,GACxC,KAAM,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,KAAKC,QAAQ,IACzC,OAAQ,EAAAN,EAAEG,SAASC,KAAK,IAAIC,IAAI,KAAKC,QAAQ,IAG7C,MAAO,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,KAAKC,QAAQ,GAC1C,MAAO,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,KAAKC,QAAQ,GAK1C,KAAM,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,GAAGC,QAAQ,GAQvC,KAAM,EAAAN,EACHE,OAAO,CACN,GAAI,EAAAF,EAAEG,SAASC,IAAI,GAAGC,IAAI,KAAKC,QAAQ,GACvC,GAAI,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,KAAKC,QAAQ,GACvC,GAAI,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,KAAKC,QAAQ,GACvC,GAAI,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,KAAKC,QAAQ,GACvC,GAAI,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,KAAKC,QAAQ,KAExCA,QAAQ,CACP,GAAI,EACJ,GAAI,EACJ,GAAI,EACJ,GAAI,EACJ,GAAI,IAIR,KAAM,EAAAN,EAAEO,SAASD,QAAQ,MACzB,GAAI,EAAAN,EACDE,OAAO,CACN,GAAI,EAAAF,EAAEO,SAASD,QAAQ,eACvB,GAAI,EAAAN,EAAEO,SAASD,QAAQ,aACvB,GAAI,EAAAN,EAAEO,SAASD,QAAQ,UACvB,GAAI,EAAAN,EAAEO,SAASD,QAAQ,UACvB,GAAI,EAAAN,EAAEO,SAASD,QAAQ,QACvB,GAAI,EAAAN,EAAEO,SAASD,QAAQ,WAExBA,QAAQ,CACP,GAAI,cACJ,GAAI,YACJ,GAAI,SACJ,GAAI,SACJ,GAAI,OACJ,GAAI,UAGR,GAAI,EAAAN,EAAEO,SAASD,QAAQ,MACvB,GAAI,EAAAN,EAAEO,SAASD,QAAQ,MACvB,GAAI,EAAAN,EAAEe,MAAM,EAAAf,EAAEO,UAAUD,QAAQ,IAEhC,KAAM,EAAAN,EAAEO,SAASD,QAAQ,sBAE1BA,QAAQ,CACP,IAAK,EACL,KAAM,GACN,OAAQ,GACR,MAAO,EACP,MAAO,EACP,KAAM,EACN,KAAM,CACJ,GAAI,EACJ,GAAI,EACJ,GAAI,EACJ,GAAI,EACJ,GAAI,GAEN,KAAM,KACN,GAAI,CACF,GAAI,cACJ,GAAI,YACJ,GAAI,SACJ,GAAI,SACJ,GAAI,OACJ,GAAI,SAEN,GAAI,KACJ,GAAI,KACJ,GAAI,GACJ,KAAM,qBAMV,KAAM,EAAAN,EACHE,OAAO,CAEN,OAAQ,EAAAF,EAAEG,SAASC,IAAI,IAAIC,IAAI,IAAIK,WACnC,OAAQ,EAAAV,EAAEO,SAASG,WACnB,OAAQ,EAAAV,EAAEO,SAASG,WACnB,OAAQ,EAAAV,EAAEO,SAASG,WAGnB,MAAO,EAAAV,EAAEe,MAAM,EAAAf,EAAEG,UAAUG,QAAQ,IACnC,OAAQ,EAAAN,EAAEe,MAAM,EAAAf,EAAEG,UAAUG,QAAQ,IAGpC,IAAK,EAAAN,EACFE,OAAO,CACN,IAAK,EAAAF,EAAEQ,UAAUF,SAAQ,GACzB,KAAM,EAAAN,EAAEe,MAAM,EAAAf,EAAEO,UAAUD,QAAQ,IAClC,KAAM,EAAAN,EAAEQ,UAAUE,WAClB,KAAM,EAAAV,EAAEO,SAASG,WACjB,KAAM,EAAAV,EAAEG,SAASG,QAAQ,GACzB,KAAM,EAAAN,EAAEO,SAASG,aAElBA,WAEH,IAAK,EAAAV,EACFE,OAAO,CACN,IAAK,EAAAF,EAAEQ,UAAUF,SAAQ,GACzB,KAAM,EAAAN,EAAEe,MAAM,EAAAf,EAAEO,UAAUD,QAAQ,IAClC,KAAM,EAAAN,EAAEQ,UAAUE,WAClB,KAAM,EAAAV,EAAEO,SAASG,WACjB,KAAM,EAAAV,EAAEG,SAASG,QAAQ,GACzB,KAAM,EAAAN,EAAEO,SAASG,aAElBA,WAEH,IAAK,EAAAV,EACFE,OAAO,CACN,IAAK,EAAAF,EAAEQ,UAAUF,SAAQ,GACzB,KAAM,EAAAN,EAAEe,MAAM,EAAAf,EAAEO,UAAUD,QAAQ,IAClC,KAAM,EAAAN,EAAEQ,UAAUE,WAClB,KAAM,EAAAV,EAAEO,SAASG,WACjB,KAAM,EAAAV,EAAEG,SAASG,QAAQ,GACzB,KAAM,EAAAN,EAAEO,SAASG,aAElBA,WAEH,IAAK,EAAAV,EACFE,OAAO,CACN,IAAK,EAAAF,EAAEQ,UAAUF,SAAQ,GACzB,KAAM,EAAAN,EAAEe,MAAM,EAAAf,EAAEO,UAAUD,QAAQ,IAClC,KAAM,EAAAN,EAAEQ,UAAUE,WAClB,KAAM,EAAAV,EAAEO,SAASG,WACjB,KAAM,EAAAV,EAAEG,SAASG,QAAQ,GACzB,KAAM,EAAAN,EAAEO,SAASG,aAElBA,WAEH,IAAK,EAAAV,EACFE,OAAO,CACN,IAAK,EAAAF,EAAEQ,UAAUF,SAAQ,GACzB,KAAM,EAAAN,EAAEe,MAAM,EAAAf,EAAEO,UAAUD,QAAQ,IAClC,KAAM,EAAAN,EAAEQ,UAAUE,WAClB,KAAM,EAAAV,EAAEO,SAASG,WACjB,KAAM,EAAAV,EAAEG,SAASG,QAAQ,GACzB,MAAO,EAAAN,EAAEQ,UAAUF,SAAQ,GAG3B,KAAM,EAAAN,EAAEG,SAASG,QAAQ,GACzB,KAAM,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,IAAIC,QAAQ,GACxC,MAAO,EAAAN,EAAEQ,UAAUF,SAAQ,GAC3B,OAAQ,EAAAN,EAAEO,SAASG,WAMnB,IAAK,EAAAV,EAAEG,SAASC,IAAI,GAAGC,IAAI,KAAKC,QAAQ,GACxC,OAAQ,EAAAN,EAAEe,MAAM,EAAAf,EAAEG,UAAUG,QAAQ,IAIpC,OAAQ,EAAAN,EACLE,OAAO,CACN,KAAM,EAAAF,EAAEG,SAASG,SAAS,GAC1BQ,SAAU,EAAAd,EAAEG,SAASG,SAAS,KAE/BI,WAKH,OAAQ,EAAAV,EAAEG,SAASC,IAAI,GAAGC,IAAI,KAAKK,WACnC,QAAS,EAAAV,EACNE,OAAO,CACN,IAAK,EAAAF,EAAEQ,UAAUF,SAAQ,GACzB,KAAM,EAAAN,EAAEG,SAASa,WAAWV,QAAQ,MACpC,KAAM,EAAAN,EAAEG,SAASa,WAAWV,QAAQ,MACpC,IAAK,EAAAN,EAAEQ,UAAUF,SAAQ,GACzB,KAAM,EAAAN,EAAES,KAAK,CAAC,MAAO,SAASO,WAAWV,QAAQ,MACjD,MAAO,EAAAN,EAAEG,SAASG,QAAQ,KAE3BI,aAEJA,WAUH,MAAO,EAAAV,EAAEG,SAASC,IAAI,GAAGC,IAAI,KAAKC,QAAQ,GAI1C,KAAM,EAAAN,EACHE,OAAO,CACN,IAAK,EAAAF,EAAEQ,UAAUF,SAAQ,GACzB,KAAM,EAAAN,EAAEG,SAASa,WAAWV,QAAQ,MACpC,KAAM,EAAAN,EAAEG,SAASa,WAAWV,QAAQ,MACpC,IAAK,EAAAN,EAAEQ,UAAUF,SAAQ,GACzB,KAAM,EAAAN,EAAES,KAAK,CAAC,MAAO,SAASO,WAAWV,QAAQ,MACjD,MAAO,EAAAN,EAAEG,SAASG,QAAQ,KAE3BA,QAAQ,CACP,KAAK,EACL,KAAM,KACN,KAAM,KACN,KAAK,EACL,KAAM,KACN,MAAO,IAUX,MAAO,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,GAAGC,QAAQ,GAExC,UAAW,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,GAAGK,WAGpC,OAAQ,EAAAV,EACLE,OAAO,CACN,GAAI,EAAAF,EAAEG,SAASG,QAAQ,GACvB,GAAI,EAAAN,EAAEG,SAASG,QAAQ,GACvB,GAAI,EAAAN,EAAEG,SAASG,QAAQ,GACvB,GAAI,EAAAN,EAAEG,SAASG,QAAQ,GACvB,GAAI,EAAAN,EAAEG,SAASG,QAAQ,GACvB,GAAI,EAAAN,EAAEG,SAASG,QAAQ,KAExBA,QAAQ,CAAE,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,MAErDA,QAAQ,CACP,MAAO,GACP,OAAQ,GACR,MAAO,EACP,KAAM,CACJ,KAAK,EACL,KAAM,KACN,KAAM,KACN,KAAK,EACL,KAAM,KACN,MAAO,GAET,MAAO,EACP,OAAQ,CAAE,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,KAMrD,KAAM,EAAAN,EACHE,OAAO,CAEN,MAAO,EAAAF,EAAEG,SAASC,IAAI,GAAGC,IAAI,KAAKC,QAAQ,GAG1C,OAAQ,EAAAN,EAAES,KAAK,CAAC,KAAM,KAAM,KAAM,KAAM,OAAOH,QAAQ,MAGvD,OAAQ,EAAAN,EAAEO,SAASG,aAEpBJ,QAAQ,CACP,MAAO,EACP,OAAQ,OAMZ,KAAM,EAAAN,EACHE,OAAO,CAUN,KAAM,EAAAF,EACHS,KAAK,CAAC,MAAO,OAAQ,SAAU,OAAQ,MAAO,OAAQ,SACtDH,QAAQ,OACX,OAAQ,EAAAN,EAAEO,SAASG,WACnB,OAAQ,EAAAV,EAAEQ,UAAUF,SAAQ,GAE5B,QAAS,EAAAN,EAAEQ,UAAUF,SAAQ,GAI7B,QAAS,EAAAN,EACNE,OAAO,CACN,KAAM,EAAAF,EAAEG,SAASG,SAAS,GAC1B,KAAM,EAAAN,EAAES,KAAK,CAAC,OAAQ,SAAU,SAASC,aAE1CA,WAIH,IAAK,EAAAV,EACFE,OAAO,CACN,IAAK,EAAAF,EAAEQ,UAAUF,SAAQ,GACzB,KAAM,EAAAN,EAAEG,SAASC,IAAI,GAAGC,IAAI,GAAGC,QAAQ,GACvC,IAAK,EAAAN,EAAEQ,UAAUF,SAAQ,GACzB,KAAM,EAAAN,EAAEQ,UAAUF,SAAQ,GAG1B,OAAQ,EAAAN,EACLE,OAAO,CACN,KAAM,EAAAF,EAAEG,SAASG,SAAS,GAC1BQ,SAAU,EAAAd,EAAEG,SAASG,QAAQ,KAE9BI,aAEJJ,QAAQ,CACP,KAAK,EACL,KAAM,EACN,KAAK,EACL,MAAM,MAGXA,QAAQ,CACP,KAAM,MACN,QAAQ,EACR,SAAS,EACT,IAAK,CACH,KAAK,EACL,KAAM,EACN,KAAK,EACL,MAAM,KAOZ,OAAQ,EAAAN,EACLE,OAAO,CAENe,SAAU,EAAAjB,EAAEQ,UAAUF,SAAQ,GAC9BY,WAAY,EAAAlB,EAAEQ,UAAUF,SAAQ,GAGhCa,aAAc,EAAAnB,EAAEG,SAASC,IAAI,GAAGC,IAAI,GAAGC,QAAQ,GAC/Cc,aAAc,EAAApB,EAAEG,SAASG,QAAQ,GACjCe,WAAY,EAAArB,EAAEG,SAASG,QAAQ,GAG/BgB,iBAAkB,EAAAtB,EAAEe,MAAM,EAAAf,EAAEO,UAAUD,QAAQ,IAG9CiB,gBAAiB,EAAAvB,EAAEG,SAASG,QAAQ,GACpCkB,UAAW,EAAAxB,EAAEQ,UAAUF,SAAQ,KAEhCI,WAKH,SAAU,EAAAV,EACPE,OAAO,CAENe,SAAU,EAAAjB,EAAEQ,UAAUF,SAAQ,GAC9BY,WAAY,EAAAlB,EAAEQ,UAAUF,SAAQ,GAGhCa,aAAc,EAAAnB,EAAEG,SAASC,IAAI,GAAGC,IAAI,IAAIC,QAAQ,GAChDc,aAAc,EAAApB,EAAEG,SAASG,QAAQ,GACjCe,WAAY,EAAArB,EAAEG,SAASG,QAAQ,GAG/BgB,iBAAkB,EAAAtB,EAAEe,MAAM,EAAAf,EAAEO,UAAUD,QAAQ,IAG9CiB,gBAAiB,EAAAvB,EAAEG,SAASG,QAAQ,GACpCkB,UAAW,EAAAxB,EAAEQ,UAAUF,SAAQ,KAEhCI,WAKH,OAAQ,EAAAV,EACLE,OAAO,CAENe,SAAU,EAAAjB,EAAEQ,UAAUF,SAAQ,GAC9BY,WAAY,EAAAlB,EAAEQ,UAAUF,SAAQ,GAGhCa,aAAc,EAAAnB,EAAEG,SAASC,IAAI,GAAGC,IAAI,GAAGC,QAAQ,GAC/Cc,aAAc,EAAApB,EAAEG,SAASG,QAAQ,GACjCe,WAAY,EAAArB,EAAEG,SAASG,QAAQ,GAG/BgB,iBAAkB,EAAAtB,EAAEe,MAAM,EAAAf,EAAEO,UAAUD,QAAQ,IAG9CiB,gBAAiB,EAAAvB,EAAEG,SAASG,QAAQ,GACpCkB,UAAW,EAAAxB,EAAEQ,UAAUF,SAAQ,KAEhCI,WAKH,GAAI,EAAAV,EACDE,OAAO,CACN,OAAQ,EAAAF,EAAEe,MAAM,EAAAf,EAAEO,UAAUD,QAAQ,IACpC,OAAQ,EAAAN,EAAEyB,OAAO,EAAAzB,EAAEO,SAAU,EAAAP,EAAEO,UAAUD,QAAQ,CAAC,GAClD,OAAQ,EAAAN,EAAEQ,UAAUF,SAAQ,KAE7BI,aC1gBE,MAAMgB,EAOX,cAAOC,CAAQC,EAAkBC,EAAgB,GAC/CC,QAAQC,KAAK,sBACbD,QAAQC,KAAK,UAAUF,KAEvB,MAAMG,EAAUJ,EAAK,GAAG,GAClBK,EAASL,EAAK,GAAG,KACjBM,EAAUN,EAAK,GAAG,KAIlBO,EAAUC,KAAKC,iBAAiBJ,EAAQC,EAASL,IAOnDM,EAAQG,IAAM,GAAsB,IAAhBH,EAAQG,KAA8B,IAAjBH,EAAQI,OAC9B,QAAjBX,EAAK,GAAG,OACVE,QAAQC,KAAK,aAAaI,EAAQG,QAAQH,EAAQI,kBAClDX,EAAK,GAAG,KAAO,QAOnB,IAAIY,EAAWL,EAAQG,IACvB,MAAMG,EAAYN,EAAQI,KAEtBC,EAAW,GAAsB,QAAjBZ,EAAK,GAAG,OAC1BE,QAAQC,KAAK,qBACbS,EAAW,GAIbZ,EAAK,GAAG,KAAOY,EACfZ,EAAK,GAAG,KAAOa,EACfb,EAAK,GAAG,GAAKQ,KAAKM,WAAWF,EAAUC,GACvCb,EAAK,GAAG,IAAMe,KAAKC,MACnBhB,EAAK,GAAG,SAAU,EAElB,MAAMiB,EAAUjB,EAAK,GAAG,GAQxB,OANAE,QAAQC,KAAK,UAAUC,OAAaa,KACpCf,QAAQC,KAAK,WAAWS,UAAiBC,QACzCX,QAAQC,KAAK,SAASH,EAAK,GAAG,QAC9BE,QAAQC,KAAK,QAAQH,EAAK,GAAG,OAC7BE,QAAQC,KAAK,sBAEN,CACLe,SAAS,EACTd,UACAa,UACAP,IAAKE,EACLD,KAAME,EAEV,CASQ,uBAAOJ,CACbU,EACAC,EACAnB,GAEA,IAAIoB,EAAaD,EAAcnB,EAC3BS,EAAMS,EAGV,KAAOE,GAAc,IACnBA,GAAc,GACdX,GAAO,EAGT,MAAO,CAAEA,MAAKC,KAAMU,EACtB,CAQQ,iBAAOP,CAAWJ,EAAaC,GAErC,MAAO,OAAOD,MADEC,EAAKW,WAAWC,SAAS,EAAG,SAE9C,CAOA,qBAAOC,CAAexB,GACpB,OAAOA,EAAK,GAAG,EACjB,CAOA,wBAAOyB,CAAkBzB,GACvB,MAAMW,EAAOX,EAAK,GAAG,KAErB,OAAgB,KAATW,GAAwB,KAATA,GAAwB,IAATA,GAAuB,IAATA,CACrD,CASA,mBAAOe,CAAa1B,GAElB,OAAyB,IAAjBA,EAAK,GAAG,MAA+B,IAAjBA,EAAK,GAAG,MAAeA,EAAK,GAAG,KAAO,CACtE,CAQA,+BAAO2B,CAAyB3B,GAC9B,OAAwB,IAAjBA,EAAK,GAAG,MAAcA,EAAK,GAAG,MAAQ,EAC/C,CAOA,mBAAO4B,CAAa5B,GAClB,OAAwB,KAAjBA,EAAK,GAAG,IACjB,CAYA,8BAAO6B,CAAwB7B,GAC7B,OAAwB,IAAjBA,EAAK,GAAG,MAAcQ,KAAKiB,kBAAkBzB,EACtD,CASA,yBAAO8B,CAAmB9B,GACxB,MAWM+B,EAHkB,KAJqB,IAJ1B/B,EAAK,GAAG,KAIa,GAHpBA,EAAK,GAAG,MAY5B,OAAOgC,KAAKvD,IAAI,EAAGsD,EACrB,CAOA,2BAAOE,CAAqBC,GAK1B,MAAMC,EAAkBD,EAAUE,cAG5BC,EAAgB,CAAC,KAAM,KAAM,KAAM,KAAM,QAAS,MACxD,IAAK,MAAMC,KAAWD,EACpB,GAAIF,EAAgBI,SAASD,GAC3B,MAAO,CAAEE,WAAW,EAAMC,WAAY,EAAGC,SAAU,SAKvD,MACMC,EAAQR,EAAgBQ,MADN,6BAExB,GAAIA,EAAO,CACT,MAAMF,EAAaG,SAASD,EAAM,GAAI,IACtC,GAAIF,GAAc,GAAKA,GAAc,GACnC,MAAO,CAAED,WAAW,EAAMC,aAAYC,SAAU,WAEpD,CAGA,MAAMG,EAAkB,CAAC,MAAO,KAAM,MAAO,YAC7C,IAAK,MAAMP,KAAWO,EACpB,GAAIV,EAAgBI,SAASD,GAC3B,MAAO,CAAEE,WAAW,EAAMC,WAAY,EAAGC,SAAU,YAIvD,MAAO,CAAEF,WAAW,EACtB,CASA,6BAAOM,CACL9C,EACAkC,GAMA,MAAMa,EAASvC,KAAKyB,qBAAqBC,GAEzC,IAAKa,EAAOP,UACV,MAAO,CAAEQ,WAAW,EAAOC,SAAS,GAItC,MAGMC,EAAa,kBAHI1C,KAAKsB,mBAAmB9B,aAQ/C,OAHAE,QAAQiD,KAAK,qBAAqBJ,EAAOL,YACzCxC,QAAQiD,KAAK,UAAUD,KAEhB,CACLF,WAAW,EACXC,SAAS,EACTC,aAEJ,CAMA,eAAOE,CAASpD,GACdE,QAAQC,KAAK,wBACbD,QAAQC,KAAK,UAAUH,EAAK,GAAG,MAC/BE,QAAQC,KAAK,SAASH,EAAK,GAAG,QAC9BE,QAAQC,KAAK,SAASH,EAAK,GAAG,QAC9BE,QAAQC,KAAK,QAAQH,EAAK,GAAG,OAC7BE,QAAQC,KAAK,YAAYH,EAAK,GAAG,WACjCE,QAAQC,KAAK,SAASH,EAAK,GAAG,QAG9B,MAAMqD,EAAe7C,KAAKM,WAAWd,EAAK,GAAG,KAAMA,EAAK,GAAG,MACvDA,EAAK,GAAG,KAAOqD,EACjBnD,QAAQoD,MAAM,gBAAgBD,UAAqBrD,EAAK,GAAG,MAE3DE,QAAQC,KAAK,eAGfD,QAAQC,KAAK,yBACf,CAgBA,sCAAOoD,CACLC,EACAC,EACAC,GAMA,OAAIA,GAAa,EACR,CAAEC,YAAY,GAInBH,IAAeC,GACjBvD,QAAQiD,KAAK,0BAA0BM,SAAiBC,MACjD,CACLC,YAAY,EACZC,QAAS,SAASH,4BAKtBvD,QAAQC,KAAK,qBAAqBqD,OAAgBC,SAAiBC,MAC5D,CAAEC,YAAY,GACvB,ECjVF,SAASE,EAAMC,EAAetF,EAAaC,GACzC,OAAOuD,KAAKxD,IAAIwD,KAAKvD,IAAIqF,EAAOtF,GAAMC,EACxC,CAgBO,SAASsF,EAAiBC,GAE/B,MADc,CAAC,KAAM,KAAM,KAAM,KAAM,MAC1BA,EAAQ,IAAM,KAAKA,GAClC,CAKO,SAASC,EAAkBD,GAEhC,MADc,CAAC,KAAM,KAAM,KAAM,KAAM,MAC1BA,EAAQ,IAAM,KAAKA,GAClC,CA8JA,IAAIE,GAAa,ECrLV,MAuBMC,EAA8B,CACzC,EAAG,CACD,IAAK,KACL,KAAM,CAAC,OAAQ,QACf,GAAI,CACF,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,KAAM,YACN,KAAM,kBACN,MAAO,CAAC,KAAM,KAAM,KAAM,MAC1B,KAAM,CAAC,KAAM,KAAM,KAAM,KAAM,OAEjC,KAAM,CACJ,KAAM,mBACN,KAAM,KACN,KAAM,iBACN,KAAM,OAGV,EAAG,CACD,IAAK,KACL,KAAM,CAAC,OAAQ,OAAQ,QACvB,GAAI,CACF,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,KAAM,YACN,KAAM,eACN,MAAO,CAAC,KAAM,KAAM,KAAM,MAC1B,KAAM,CAAC,KAAM,KAAM,OAErB,KAAM,CACJ,KAAM,mBACN,KAAM,KACN,KAAM,YACN,KAAM,OAGV,EAAG,CACD,IAAK,KACL,KAAM,CAAC,OAAQ,OAAQ,OAAQ,QAC/B,GAAI,CACF,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,OAAQ,CAAC,KAAM,OACf,OAAQ,KACR,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,KAAM,YACN,KAAM,gBACN,MAAO,CAAC,KAAM,KAAM,KAAM,MAC1B,KAAM,CAAC,OAAQ,KAAM,OAEvB,KAAM,CACJ,KAAM,kBACN,KAAM,KACN,KAAM,YACN,KAAM,OAGV,EAAG,CACD,IAAK,KACL,KAAM,CAAC,OAAQ,OAAQ,OAAQ,OAAQ,QACvC,GAAI,CACF,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,OAAQ,CAAC,KAAM,OACf,OAAQ,KACR,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,KAAM,WACN,KAAM,mBACN,MAAO,CAAC,KAAM,KAAM,KAAM,MAC1B,KAAM,CAAC,OAAQ,OAEjB,KAAM,CACJ,KAAM,kBACN,KAAM,KACN,KAAM,WACN,KAAM,QAGV,EAAG,CACD,IAAK,KACL,KAAM,CAAC,OAAQ,OAAQ,SAAU,QACjC,GAAI,CACF,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,OAAQ,CAAC,KAAM,OACf,OAAQ,KACR,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,KAAM,UACN,KAAM,iBACN,MAAO,CAAC,KAAM,KAAM,KAAM,MAC1B,KAAM,CAAC,KAAM,OAEf,KAAM,CACJ,KAAM,iBACN,KAAM,KACN,KAAM,YACN,KAAM,SAaCC,EAA0B,CACrC,EAAG,CACD,IAAK,KACL,KAAM,CAAC,OAAQ,OAAQ,OAAQ,MAC/B,GAAI,CACF,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,KAAM,YACN,KAAM,aACN,MAAO,CAAC,KAAM,KAAM,KAAM,MAC1B,KAAM,CAAC,KAAM,KAAM,OAErB,KAAM,CACJ,KAAM,aACN,KAAM,KACN,KAAM,YACN,KAAM,OAGV,EAAG,CACD,IAAK,KACL,KAAM,CAAC,OAAQ,OAAQ,OAAQ,KAAM,OAAQ,QAC7C,GAAI,CACF,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,OAAQ,CAAC,KAAM,OACf,OAAQ,KACR,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,KAAM,cACN,KAAM,cACN,MAAO,CAAC,KAAM,KAAM,KAAM,MAC1B,KAAM,CAAC,OAAQ,SAEjB,KAAM,CACJ,KAAM,oBACN,KAAM,KACN,KAAM,YACN,KAAM,OAGV,EAAG,CACD,IAAK,KACL,KAAM,CAAC,OAAQ,OACf,GAAI,CACF,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,OAAQ,CAAC,MAAO,MAChB,OAAQ,MACR,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,KAAM,YACN,KAAM,gBACN,MAAO,CAAC,KAAM,KAAM,KAAM,MAC1B,KAAM,CAAC,KAAM,OAEf,KAAM,CACJ,KAAM,wBACN,KAAM,KACN,KAAM,WACN,KAAM,QAGV,EAAG,CACD,IAAK,KACL,KAAM,CAAC,OAAQ,MAAO,OAAQ,QAC9B,GAAI,CACF,OAAQ,CAAC,KAAM,QACf,OAAQ,KACR,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,KAAM,YACN,KAAM,mBACN,MAAO,CAAC,KAAM,KAAM,KAAM,MAC1B,KAAM,CAAC,KAAM,KAAM,OAErB,KAAM,CACJ,KAAM,kBACN,KAAM,KACN,KAAM,WACN,KAAM,OAGV,EAAG,CACD,IAAK,KACL,KAAM,CAAC,OAAQ,MAAO,OAAQ,OAAQ,QACtC,GAAI,CAEF,OAAQ,CAAC,KAAM,QACf,OAAQ,KACR,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,KAAM,cACN,KAAM,2BACN,MAAO,CAAC,KAAM,KAAM,KAAM,MAC1B,KAAM,qBACN,OAAQ,CACN,wBACA,oBACA,qBACA,2BACA,2BAGJ,KAAM,CACJ,KAAM,wBACN,KAAM,KACN,KAAM,oBACN,KAAM,QA0BZ,SAASC,EAAoB,GAC3B,OAAO,EAASD,EAA0BD,CAC5C,CA6BO,SAASG,EAAiBN,EAAe,GAAkB,GAChE,MACMO,EADSF,EAAoB,GACRL,GAE3B,OAAKO,EAQEA,EAAY,KAPV,CACL,KAAM,KACN,KAAM,OACN,MAAO,CAAC,MACR,KAAM,GAIZ,CAuBO,SAASC,EAAcR,EAAe,GAC3C,MACMO,EADSF,EAAoB,GACRL,GAC3B,OAAKO,EACEA,EAAY,IADM,KAAKP,GAEhC,CAyBO,MAWMS,EAAiB,CAAC,KAAM,KAAM,KAAM,KAAM,MAkBhD,SAASC,EAAoC,GAClD,MAAMC,EAASF,EAAeG,IAAIC,GAAQ,EAAKA,IAAS,GAClDC,EAAUH,EAAOI,OAAO,CAACC,EAAKC,IAAMD,EAAMC,EAAG,GAAKN,EAAOO,OAC/D,OAAOlD,KAAKmD,MAAML,EACpB,CAaO,SAASM,EAAqC,GAInD,OAAOpD,KAAKvD,IAAI,EAAGuD,KAAKxD,IAAI,IAAK,IAAM,GACzC,CAsHO,MAAM6G,EAA+B,CAC1C,IAAK,CACHC,MAAO,CAAC,EAAG,IACX,KAAM,OACN,GAAI,qBAEN,KAAM,CACJA,MAAO,CAAC,GAAI,IACZ,KAAM,OACN,GAAI,0BAEN,KAAM,CACJA,MAAO,CAAC,GAAI,IACZ,KAAM,OACN,GAAI,2BAEN,KAAM,CACJA,MAAO,CAAC,GAAI,IACZ,KAAM,OACN,GAAI,0BAEN,KAAM,CACJA,MAAO,CAAC,GAAI,KACZ,KAAM,OACN,GAAI,0BAkBD,MAAMC,EAAuE,CAClF,GAAI,CACF,IAAK,sBACL,KAAM,wBACN,KAAM,mBACN,KAAM,uBACN,KAAM,4BAER,GAAI,CACF,IAAK,uBACL,KAAM,oBACN,KAAM,uBACN,KAAM,wBACN,KAAM,2BAER,GAAI,CACF,IAAK,uBACL,KAAM,sBACN,KAAM,uBACN,KAAM,yBACN,KAAM,0BAER,GAAI,CACF,IAAK,qBACL,KAAM,oBACN,KAAM,qBACN,KAAM,0BACN,KAAM,wBAER,GAAI,CACF,IAAK,sBACL,KAAM,2BACN,KAAM,uBACN,KAAM,2BACN,KAAM,sCAOH,SAASC,EACd,EACA,EACA,GASA,MAAM,GAhEwCC,EAgEH,IA/D3B,GAAW,OACvBA,GAAY,GAAW,OACvBA,GAAY,GAAW,OACvBA,GAAY,GAAW,OACpB,MALF,IAAyCA,EAiE9C,MAAM,EAAOJ,EAA6B,GACpC,EAAOE,EAAuB,GAAI,GAExC,MAAO,CACL,IAAK,EACL,KACA,KACA,KAAM,EAAK,KACX,OACA,MAEJ,CAaO,SAASG,EAAkC1F,GAYhD,MAAM,EAAKA,EAAK,KAAK,KACf,EAAQA,EAAK,GAAG,OAChB,EAAOA,EAAK,KAAK,KACjB,EAAOA,EAAK,GAAG,MAAQ,KAGvB,EAAMwE,EAAc,EAAI,GAK9B,IAAK,EAAO,CAEV,MACM,EA/UH,SAAgCR,EAAe,GACpD,MACMO,EADSF,EAAoB,GACRL,GAC3B,OAAKO,EACEA,EAAY,KADM,EAE3B,CA0UiBoB,CAAuB,GAAI,GAExC,MAAO,gBACJ,KAAO,mBAEJ,EAAKT,OAAS,EAAI,EAAKU,KAAK,KAAO,8DAI3C,CAMA,MAAM,EAAM5F,EAAK,KAAK,KAAO0E,EAAoC,GAC3D,EAAO1E,EAAK,KAAK,MAAQoF,EAAqC,GAGpE,GAAa,OAAT,EAAe,CAEjB,IAAIS,EAAS,wBACV,KAAO,aACR,eACC,iFAOH,IAAK,MAAM,KAAMpB,EAAgB,CAC/B,MAAM,EAAK,EAAK,IAAO,EACjB,EAAKe,EAAkB,EAAI,GAAI,GAErCK,GAAU,SAAS,EAAG,OAAO,QAAS,EAAG,cACtC,EAAG,gBACH,EAAG,MACR,CAQA,OANAA,GAAU,wGAMHA,CACT,CAGA,IAAIA,EAAS,uBACR,KAAO,aACR,0BACC,4FAOL,IAAK,MAAM,KAAMpB,EAAgB,CAC/B,MAAM,EAAK,EAAK,IAAO,EACjB,EAAKe,EAAkB,EAAI,GAAI,GAErCK,GAAU,SAAS,EAAG,OAAO,QAAS,EAAG,cACpC,EAAG,gBACH,EAAG,MACV,CAqBA,OAlBI,GAAO,GACTA,GAAU,iEAGD,GAAO,GAChBA,GAAU,uEAGD,GAAO,GAChBA,GAAU,sEAGD,GAAO,KAChBA,GAAU,qEAKLA,CACT,CAuCO,SAASC,EAAmC9F,GACjD,MAAMgE,EAAQhE,EAAK,KAAK,KAClB,EAASA,EAAK,GAAG,OACjB,EAA4B,OAArBA,EAAK,KAAK,OACjB,EAAKA,EAAK,GAAG,KACb,EAAQ,GAAM,IAAM,EAAK,EAEzB+F,EAxhBD,SAA6B/B,EAAe,GACjD,MACMO,EADSF,EAAoB,GACRL,GAE3B,OAAKO,EAUEA,EAAY,GATV,CACL,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,QAAQ,EACR,QAAQ,EAId,CAygBsByB,CAAoBhC,EAAO,GACzCiC,EAAW3B,EAAiBN,EAAO,GACnCkC,EAAQ1B,EAAcR,EAAO,GAGnC,IAAK,EAAQ,CACX,IAAI6B,EAAS,gBACVK,KAASlC,cACTiC,EAAS,0BAGPF,EAAY,OAAOH,KAAK,kBACxBG,EAAY,OAAOH,KAAK,kBACxBK,EAAS,gBACTA,EAAS,MAAML,KAAK,OAEzB,MAAM,EAAQK,EAAqC,KASnD,OARI,GAAQ,EAAKf,OAAS,IACxBW,GAAU,WAAW,EAAKD,KAAK,QAG7B,IACFC,GAAU,8BAGLA,CACT,CAGA,IAAI,EAASE,EAAY,OACrB,EAASA,EAAY,OAGX,IAAV/B,GAAe,IACjB,EAAS,CAAC,KAAM,MAChB,EAAS,CAAC,KAAM,OAGlB,IAAI6B,EAAS,kBACRK,KAASlC,cACTiC,EAAS,0CAGP,EAAOL,KAAK,kBACZ,EAAOA,KAAK,0BACJG,EAAY,OAAS,KAAO,yBAC5BA,EAAY,OAAS,KAAO,4CAGtCE,EAAS,eACRA,EAAS,MAAML,KAAK,OAE1B,MAAM,EAAQK,EAAqC,KAoBnD,OAnBI,GAAQ,EAAKf,OAAS,IACxBW,GAAU,SAAS,EAAKD,KAAK,QAIjB,IAAV5B,GAAgBiC,EAAqC,OACvDJ,GAAU,aAAcI,EAAqC,QAI3D,IACFJ,GAAU,sCAIR,GAAQ7B,EAAQ,IAClB6B,GAAU,uCAGLA,CACT,CAkGO,SAASM,EAAsBnG,GACpC,MAAM,EAAOA,EAAK,GAAG,KAErB,IAAI,EA0BJ,GArBE,EAFE,GAAQ,GAAK,EAAO,EAEhBgC,KAAKoE,SAAW,GAAM,KAAO,KAC1B,GAAQ,GAAK,EAAO,GAEvBpE,KAAKoE,SAAW,GAAM,KAAO,KAC1B,GAAQ,IAAM,EAAO,GAExB,KACG,GAAQ,IAAM,EAAO,GAExBpE,KAAKoE,SAAW,GAAM,KAAO,KAC1B,GAAQ,IAAM,EAAO,GAExB,KACG,GAAQ,IAAM,EAAO,GAExB,KAGA,KAGJpG,EAAK,KAAK,OAAS,EAAK,CAC1B,MAAM,EAAMA,EAAK,KAAK,KACtBA,EAAK,KAAK,KAAO,EACjBE,QAAQC,KAAK,cAAc,OAAS,UAAYH,EAAK,GAAG,WAC1D,CACF,CAOO,SAASqG,EAA+BrG,GAC7C,MAAM,EAAMA,EAAK,KAAK,IAChB,EAAOA,EAAK,KAAK,KAGvB,IAAI,EAIF,EAFE,GAAO,IAAM,GAAQ,EAEf,wCACC,GAAO,IAAM,GAAQ,EAEtB,qCACC,GAAO,IAAM,GAAQ,EAEtB,gCACC,GAAO,IAAM,GAAQ,EAEtB,qCAGA,4BAGV,MAAM,EAAQA,EAAK,KAAK,KACxBA,EAAK,KAAK,KAAO,EACjBE,QAAQC,KACN,qBACA,UAAU,EAAMmG,UAAU,EAAG,SAC7B,UAAU,EAAMA,UAAU,EAAG,SAEjC,CAUA,MAAMC,EACA,CACF,KACA,MACA,MACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MApBEA,EAsBA,CACF,KACA,OACA,MACA,KACA,KACA,KACA,MACA,MACA,KACA,OACA,OACA,KACA,OACA,QApCEA,EAsCE,CACJ,KACA,KACA,OACA,OACA,OACA,OACA,KACA,KACA,MACA,MACA,KACA,QAOEC,EACA,CAAC,KAAM,MAAO,KAAM,OAAQ,OAAQ,MAAO,MAAO,MAAO,OAAQ,OADjEA,EAEA,CAAC,KAAM,KAAM,MAAO,KAAM,OAAQ,OAAQ,OAAQ,KAAM,KAAM,MAO9DC,EACA,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,OAAQ,QAD/DA,EAEA,CACF,KACA,KACA,KACA,IACA,KACA,OACA,OACA,KACA,KACA,KACA,OACA,MACA,MAfEA,EAiBA,CACF,KACA,KACA,KACA,IACA,IACA,IACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MA6BJ,SAASC,EAAoBC,EAAcC,GACzC,IAAIC,EAAQ,EACZ,IAAK,MAAMvE,KAAWsE,EAChBD,EAAKpE,SAASD,IAChBuE,IAGJ,OAAOA,CACT,CAgHO,SAASC,EAA2B9G,EAAkB+G,EAAwB,IACnF,MAAMC,EAAkC,CACtC,IAAK,EACL,GAAI,GACJ,GAAI,CACF,KAAM,EACN,KAAM,EACN,KAAM,EACN,KAAM,IAMV,KADkC,OAArBhH,EAAK,KAAK,QAErB,OAAOgH,EAIT,MAAM,EAAOhH,EAAK,GAAG,OAGrB,GAAI,EAAM,CAER,MACM,EAnIV,SAAgC,GAC9B,MAAM2G,EAAO,EAAKvE,cAGlB,OAAIsE,EAAoBC,EAAMJ,GAAmC,EACxD,EAILG,EAAoBC,EAAMJ,GAAiC,EACtD,EAILG,EAAoBC,EAAMJ,IAAkC,EACvD,EAGF,CACT,CAgHiBU,CADAC,OAAOvC,OAAO3E,EAAK,KAAK,IAAI4F,KAAK,MAE9C,GAAI,GAAQ,EAAG,CACb,MAAM,EAAO,CAAC,EAAG,EAAG,GAAI,IAAI,GAC5BoB,EAAO,GAAG,KAAO,EACjBA,EAAO,KAAO,EACdA,EAAO,GAAGG,KAAK,UAAU,MAAS,IACpC,CAGA,MAAM,EAnHV,SAA+B,GAC7B,MAAMR,EAAO,EAAKvE,cAGlB,OAAIsE,EAAoBC,EAAMH,GAA4B,EACjD,EAILE,EAAoBC,EAAMH,GAA4B,EACjD,EAGF,CACT,CAqGiBY,CAAsBpH,EAAK,KAAK,IAC7C,GAAI,GAAQ,EAAG,CACb,MAAM,EAAO,CAAC,EAAG,EAAG,GAAG,GACvBgH,EAAO,GAAG,KAAO,EACjBA,EAAO,KAAO,EACdA,EAAO,GAAGG,KAAK,UAAU,MAAS,IACpC,CAKInH,EAAK,KAAK,MAAQ,GAAKA,EAAK,KAAK,KAAO,KAC1CgH,EAAO,GAAG,KAAO,EACjBA,EAAO,KAAO,EACdA,EAAO,GAAGG,KAAK,YAAYnH,EAAK,KAAK,WAEzC,CAMA,GAAI+G,EAAe,CACjB,MAAM,EAtHV,SAA6B,GAC3B,MAAMJ,EAAO,EAGb,OAAID,EAAoBC,EAAMF,IAAkC,EACvD,EAILC,EAAoBC,EAAMF,IAAkC,EACvD,EAILC,EAAoBC,EAAMF,IAAkC,EACvD,EAGF,CACT,CAmGiBY,CAAoBN,GACjC,GAAI,GAAQ,EAAG,CACb,MAAM,EAAO,CAAC,EAAG,EAAG,GAAI,IAAI,GAC5BC,EAAO,GAAG,KAAO,EACjBA,EAAO,KAAO,EACd,MAAM,EAAO,EAAO,GAAK,SACzBA,EAAO,GAAGG,KAAK,SAAS,OAAU,MAAS,IAC7C,CACF,CAaA,OAVIH,EAAO,IAAM,GACf9G,QAAQC,KACN,uBAAuB6G,EAAO,MAC9B,WAAWA,EAAO,GAAGpB,KAAK,QAC1B,aAAa5F,EAAK,KAAK,SACvB,aAAaA,EAAK,KAAK,OACvB,cAAcA,EAAK,KAAK,OAIrBgH,CACT,CCz3CO,MAAMM,EAA6B,CACxC,CACEC,KAAM,EACNC,MAAO,KACPtB,MAAO,UACPuB,YAAa,+BACbC,UAAW,CAAE,GAAI,KAAM,GAAI,MAC3BC,OAAQ,+EAKV,CACEJ,KAAM,EACNC,MAAO,KACPtB,MAAO,QACPuB,YAAa,8BACbC,UAAW,CAAE,GAAI,KAAM,GAAI,MAC3BC,OAAQ,sEAKV,CACEJ,KAAM,EACNC,MAAO,KACPtB,MAAO,QACPuB,YAAa,2BACbC,UAAW,CAAE,GAAI,KAAM,GAAI,MAC3BC,OAAQ,2EAKV,CACEJ,KAAM,EACNC,MAAO,KACPtB,MAAO,OACPuB,YAAa,oBACbC,UAAW,CAAE,GAAI,KAAM,GAAI,MAC3BC,OAAQ,+EAKV,CACEJ,KAAM,EACNC,MAAO,KACPtB,MAAO,OACPuB,YAAa,gBACbC,UAAW,CAAE,GAAI,KAAM,GAAI,MAC3BC,OAAQ,2EAKV,CACEJ,KAAM,EACNC,MAAO,KACPtB,MAAO,OACPuB,YAAa,wBACbC,UAAW,CAAE,GAAI,KAAM,GAAI,KAAM,GAAI,MACrCC,OAAQ,wFAKV,CACEJ,KAAM,EACNC,MAAO,KACPtB,MAAO,OACPuB,YAAa,0BACbC,UAAW,CAAE,GAAI,KAAM,GAAI,MAC3BC,OAAQ,8EAKV,CACEJ,KAAM,EACNC,MAAO,KACPtB,MAAO,OACPuB,YAAa,2BACbC,UAAW,CAAE,GAAI,KAAM,GAAI,MAC3BC,OAAQ,uEAKV,CACEJ,KAAM,EACNC,MAAO,KACPtB,MAAO,OACPuB,YAAa,sBACbC,UAAW,CAAE,GAAI,KAAM,GAAI,MAC3BC,OAAQ,qEAKV,CACEJ,KAAM,GACNC,MAAO,KACPtB,MAAO,OACPuB,YAAa,gBACbC,UAAW,CAAE,GAAI,KAAM,GAAI,MAC3BC,OAAQ,8EAKV,CACEJ,KAAM,GACNC,MAAO,KACPtB,MAAO,OACPuB,YAAa,uBACbC,UAAW,CAAE,GAAI,KAAM,GAAI,MAC3BC,OAAQ,wEAKV,CACEJ,KAAM,GACNC,MAAO,KACPtB,MAAO,QACPuB,YAAa,mBACbC,UAAW,CAAC,EACZC,OAAQ,6IA0DL,SAASC,EAAyB5H,GACvC,MAAM6H,EAAkB,IAAIC,IAAI9H,EAAK,KAAK,OAEpC+H,EAAYF,EAAgBG,IAAI,GAChCC,EAAYJ,EAAgBG,IAAI,GAChCE,EAAYL,EAAgBG,IAAI,GAChCG,EAAYN,EAAgBG,IAAI,GAGtC,IAAII,EAYAX,EACAY,EAEJ,OAbED,EADEL,GAAaE,GAAaC,EACpB,EACCH,GAAaE,EACd,EACCF,EACD,EAEA,EAOFK,GACN,KAAK,EACHX,EAAc,oBACdY,EAAS,uIAMT,MAEF,KAAK,EACHZ,EAAc,kBACdY,EAAS,iKAMT,MAEF,KAAK,EACHZ,EAAc,sBACdY,EAAS,+JAMT,MAEF,KAAK,EACHZ,EAAc,oBACdY,EAAS,0MAUb,MAAO,CACLD,QACAL,YACAE,YACAC,YACAC,YACAV,cACAY,SAEJ,CAgEO,SAASC,EAAyBtI,GACvC,MAAMuI,EAASvI,EAAK,KAAK,UACzB,YAAewI,IAAXD,EACKA,EAGFX,EAAyB5H,GAAMoI,KACxC,CAsCO,SAASK,EAA4BzI,EAAkB0I,GAC5D,IApBK,SAAuC1I,GAI5C,OAAwB,IADN4H,EAAyB5H,GAC7BoI,QACZlI,QAAQC,KAAK,0BACN,EAGX,CAWOwI,CAA8B3I,GAEjC,OADAE,QAAQC,KAAK,kBAAkBuI,cACxB,EAGT,MAAME,EAAW5I,EAAK,KAAK,MAC3BA,EAAK,KAAK,MAAQgC,KAAKxD,IAAI,IAAKoK,EAAWF,GAC3C,MAAMG,EAAiB7I,EAAK,KAAK,MAAQ4I,EAEzC,OADA1I,QAAQC,KAAK,eAAe0I,MAAmBD,OAAc5I,EAAK,KAAK,UAChE6I,CACT,CAcA,MAAMC,EACA,CACF,GAAI,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAC3D,GAAI,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAC3D,GAAI,CAAC,KAAM,KAAM,KAAM,MAAO,KAAM,KAAM,KAAM,KAAM,OAJpDA,EAMA,CACF,GAAI,CAAC,IAAK,KAAM,IAAK,KAAM,KAAM,IAAK,IAAK,IAAK,IAAK,IAAK,KAC1D,GAAI,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KACjE,GAAI,CAAC,IAAK,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,OAT5CA,EAWA,CACF,GAAI,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAAO,OACtD,GAAI,CAAC,KAAM,KAAM,MAAO,KAAM,KAAM,KAAM,KAAM,MAAO,MACvD,GAAI,CAAC,KAAM,KAAM,KAAM,KAAM,MAAO,MAAO,MAAO,KAAM,OAOrD,SAASC,EAAoB7G,GAClC,MAAM8E,EAAyB,CAC7B,GAAI,KACJ,GAAI,KACJ,GAAI,KACJ,KAAM9E,EACN,MAAO,IAIT,IAAK,MAAO8G,EAAUpC,KAAaM,OAAO+B,QAAQH,GAAqB,CACrE,IAAK,MAAMxG,KAAWsE,EACpB,GAAI1E,EAAUK,SAASD,GAAU,CAC/B0E,EAAO,GAAKgC,EACZhC,EAAO,MAAMG,KAAK7E,GAClB,KACF,CAEF,GAAkB,OAAd0E,EAAO,GAAa,KAC1B,CAGA,IAAK,MAAOkC,EAAUtC,KAAaM,OAAO+B,QAAQH,GAAqB,CACrE,IAAK,MAAMxG,KAAWsE,EACpB,GAAI1E,EAAUK,SAASD,GAAU,CAC/B0E,EAAO,GAAKkC,EACZlC,EAAO,MAAMG,KAAK7E,GAClB,KACF,CAEF,GAAkB,OAAd0E,EAAO,GAAa,KAC1B,CAGA,IAAK,MAAOmC,EAAMvC,KAAaM,OAAO+B,QAAQH,GAAqB,CACjE,IAAK,MAAMxG,KAAWsE,EACpB,GAAI1E,EAAUK,SAASD,GAAU,CAC/B0E,EAAO,GAAKmC,EACZnC,EAAO,MAAMG,KAAK7E,GAClB,KACF,CAEF,GAAkB,OAAd0E,EAAO,GAAa,KAC1B,CAEA,OAAOA,CACT,CAMO,SAASoC,EAAoBrG,EAAwBwE,GAC1D,MAAM8B,EAAO9B,EAAKG,UAClB,IAAI4B,EAAa,EACbC,EAAgB,EAgBpB,OAdIF,EAAK,KACPE,IACIxG,EAAO,KAAOsG,EAAK,IAAIC,KAEzBD,EAAK,KACPE,IACIxG,EAAO,KAAOsG,EAAK,IAAIC,KAEzBD,EAAK,KACPE,IACIxG,EAAO,KAAOsG,EAAK,IAAIC,KAIP,IAAlBC,GAGGD,GAAcC,EAAgB,EAHL,OAGkB,KACpD,CAqBO,SAASC,EAA0BxJ,GACxC,MAAMyJ,EAAazJ,EAAK,KAAK,IAUvB0J,EAAaD,GAAY,MAAQ,EACjCE,EAAcF,GAAY,MAAQ,EAClCG,EAAkBH,GAAY,QAAS,EACvCI,EAAoBJ,GAAY,KAAO,EACvCK,EAAqBL,GAAY,QAAU,GAG3CrI,EAAcpB,EAAK,GAAG,KAS5B,IAAIyH,EAAc,GAalB,OAXEA,EADEoC,GAAqB,IACT,kCACLA,GAAqB,GAChB,SAASA,0BACdA,GAAqB,GAChB,SAASA,gBACdF,EAAc,EACT,cAAcA,WAAqBE,kBAEnC,WAGT,CACLA,oBACAF,cACAI,kBAxBwB/H,KAAKvD,IAAI,EAAGuD,KAAKxD,IAAI,GAAI,GAAK4C,IAyBtDwI,kBACAtK,WApBiBuK,GAAqB,GAqBtCG,wBAxB8BH,GAAqB,IAyBnDH,aACAI,qBACArC,cAEJ,CAoCO,SAASwC,EAA0BjK,GACxC,MAAMyF,EAAWzF,EAAK,KAAK,KACrBkK,EAAuB,GAEzBzE,EAAS,IAAM,IACjByE,EAAW/C,KAAK,qBAEd1B,EAAS,IAAM,IACjByE,EAAW/C,KAAK,sBAEd1B,EAAS,IAAM,IACjByE,EAAW/C,KAAK,iBAEd1B,EAAS,IAAM,IACjByE,EAAW/C,KAAK,uBAGlB,MAAMgD,EAAY,CAAC,KAAM,KAAM,KAAM,MAC/BnF,EAAMmF,EAAUpF,OAAO,CAACqF,EAAKvF,IAASuF,GAAO3E,EAASZ,IAAS,GAAI,GACnEwF,EAAcrI,KAAKsI,MAAMtF,EAAMmF,EAAUjF,QAE/C,MAAO,CACLqF,aAAcL,EAAWhF,OAAS,EAClCgF,aACAG,cAEJ,CASO,SAASG,EAAyBxK,EAAkB+C,GACzD,MAAM0H,EAAajB,EAA0BxJ,GACvC2J,EAAcc,EAAWd,YACzBe,EAjED,SAA2B1K,GAChC,MAAMyJ,EAAazJ,EAAK,KAAK,IACvB2J,EAAcF,GAAY,MAAQ,EAClCrI,EAAcpB,EAAK,GAAG,KAItB2K,EAAmB3I,KAAKvD,IAAI,EAAG,GAAK2C,GAGpCwJ,EAAiB,GAAKjB,EAC5B,OAAO3H,KAAKxD,IAAIoM,EAAgBD,EAClC,CAqDyBE,CAAkB7K,GACnC8K,EAAgBb,EAA0BjK,GAGhD,GAAIyK,EAAWb,iBAAmBD,GAAe,GAC/C,OAAOoB,EAAuB/K,EAAM8K,GAItC,MAAME,EAAWrB,EAAc,EACzBsB,EAAa3D,EAAa0D,EAAW,GAE3C,IAAKC,EACH,OAAOF,EAAuB/K,EAAM8K,GAItC,MAAMI,EAAa9B,EAAoBrG,EAAQkI,GACzCE,EAA8B,SAAfD,EAAwB,GAAK,EAGlD,IAAIE,EAAoB,GACpBN,EAAcP,eAChBa,EAAoB,4BAA4BN,EAAcZ,WAAWtF,IAAIyG,GAAK,KAAKA,KAAKzF,KAAK,SAInG,MAAM0F,EAAgB,QAAQvI,EAAO,SAASA,EAAO,SAASA,EAAO,KAC/DwI,EACW,SAAfL,EAAwB,uBAAyB,4BAEnD,MAAO,YAAYF,QAAeC,EAAW/E,mBAEvC+E,EAAWzD,gBACXkD,yBACCD,EAAWZ,8BACXsB,MAAgC,SAAfD,EAAwB,MAAQ,qBAGxDD,EAAWxD,4BAGX6D,MACAC,YACMxI,EAAO,MAAMmC,OAAS,EAAInC,EAAO,MAAM6C,KAAK,KAAO,aACzDwF,gBAGAH,EAAWtD,+BAGD5E,EAAO,wBACVA,EAAO,yBACPA,EAAO,oLAShB,CAeA,SAASgI,EAAuB/K,EAAkB8K,GAChD,MAAML,EAAajB,EAA0BxJ,GAGvCwL,EAAiB,GAFHxL,EAAK,GAAG,KAI5B,IAAIoL,EAAoB,GACpBN,EAAcP,eAChBa,EAAoB,eAAeN,EAAcZ,WAAWtF,IAAIyG,GAAK,KAAKA,KAAKzF,KAAK,SAItF,IAAI6F,EAAe,GAmBnB,OAhBEA,EAFED,GAAkB,EAEL,0GAINA,GAAkB,EAEZ,uBACPA,6BAIO,0DAKV,0BAEFf,EAAWZ,uBAChBY,EAAWT,wBAA0B,eAAiB,cAC/CwB,EAAiB,EAAIA,EAAiB,2FAI7CJ,MACAK,sTAmBF,CAGA,MAAMC,EAA6D,CACjE,EAAG,CAAExF,MAAO,QAASyF,IAAK,IAC1B,EAAG,CAAEzF,MAAO,SAAUyF,IAAK,IAC3B,EAAG,CAAEzF,MAAO,UAAWyF,IAAK,IAC5B,EAAG,CAAEzF,MAAO,SAAUyF,IAAK,IAC3B,EAAG,CAAEzF,MAAO,QAASyF,IAAK,KA6DrB,SAASC,EAA+B5L,GAI7C,MAAMyK,EAAajB,EAA0BxJ,GACvC8K,EAAgBb,EAA0BjK,GAC1CoB,EAAcpB,EAAK,GAAG,KACtB6L,EAAW7J,KAAKvD,IAAI,EAAGuD,KAAKxD,IAAI,GAAI,GAAK4C,IAEzC0K,EAAyC,IAA1BrB,EAAWf,WAC1BE,EAAkBa,EAAWb,gBAG7BmC,EAAYnE,EAAyB5H,GACrCgM,EA1kBD,SAAiCD,GACtC,MAAME,EAAoB,GA0B1B,OAxBKF,EAAUhE,WACbkE,EAAQ9E,KAAK,oIAOV4E,EAAU9D,WACbgE,EAAQ9E,KAAK,0IAOV4E,EAAU7D,WACb+D,EAAQ9E,KAAK,2IAOR8E,CACT,CA8iByBC,CAAwBH,GAGzCI,EApER,SAAwCnM,GACtC,MAAMoM,EAAsB,GAG5B,IAAK,IAAIf,EAAI,EAAGA,GAAK,EAAGA,IAAK,CAC3B,MAAMgB,EAAW,KAAKhB,IAChBiB,EAAYtM,EAAK,KAAKqM,GAOtBE,EAAYb,EAAWL,GACvBmB,EAAYxM,EAAK,KAAK,OAAOuC,SAAS8I,GAExCiB,GAAW,KAEbF,EAAUjF,KAAK,IAAIoF,EAAUrG,SAASqG,EAAUZ,WACpDW,EAAU,gBACHE,EAAY,QAAU,aAChBF,GAAW,KAEpBF,EAAUjF,KAAK,IAAIoF,EAAUrG,SAASqG,EAAUZ,qCAEpDa,EAAY,6BAA+B,sCACpCA,EAAY,QAAU,OAE7B,CAEA,OAAyB,IAArBJ,EAAUlH,OACL,GAGF,uDAIPkH,EAAUxG,KAAK,gGAOjB,CAuB4B6G,CAA+BzM,GAGzD,IAAIoL,EAAoB,GACpBN,EAAcP,eAChBa,EAAoB,qBAAqBN,EAAcZ,WAAWtF,IAAIyG,GAAK,KAAKA,KAAKzF,KAAK,SAI5F,IAAI8G,EAAgB,YAAYX,EAAU3D,YAAY2D,EAAUtE,kBAAkBsE,EAAU1D,SACxF2D,EAAe9G,OAAS,IAC1BwH,GAAiB,kBAAkBV,EAAepG,KAAK,WAGzD,MAAM+G,EAAc,qJAUZlC,EAAWf,WAAa,cACzBe,EAAWd,0BACXkC,eACCpB,EAAWZ,oCAEnB6C,MACAP,QAGAL,EACI,+HAOAlC,EACE,8CAEA,cAAca,EAAWd,YAAc,gBACtCc,EAAWd,oBAAoBc,EAAWd,YAAc,WAE/DyB,uDAKGU,EAAe,gBAAkBlC,EAAkB,YAAc,MAAMa,EAAWd,YAAc,+YAkB7FiD,EAAUd,EAclB,SAAuCC,GACrC,OAAQA,EAAU3D,OAChB,KAAK,EAEH,MAAO,yLAYT,KAAK,EAEH,MAAO,+LAYT,KAAK,EAEH,MAAO,uOAcT,KAAK,EAEH,MAAO,qSAkBb,CA/EMyE,CAA8Bd,GAC9B,2EAMJ,MAAO,CAAEY,cAAaC,UACxB,CA4EO,SAASE,EAAmC9M,GAIjD,MAAMyK,EAAajB,EAA0BxJ,GAkC7C,MAAO,CAAE2M,YAhCW,sEAKblC,EAAWf,uBACXe,EAAWd,yBACZc,EAAWZ,4BACZY,EAAWb,gBAAkB,UAAY,cAC9Ca,EAAWT,wBAA0B,iBAAmB,0OAuBlC4C,QARpBnC,EAAWZ,mBAAqB,GAC5B,8EAGA,iDAKR,CAKO,SAASkD,EACd/M,EACAkC,GAkBA,MAAO,CAAEyK,YAVW,WACpBzK,eAHmBsI,EAAyBxK,EAD7B+I,EAAoB7G,MAab0K,QAFN,GAGlB,CC/lCA,MAAMI,EACA,CACF,KAAM,CAAC,KAAM,KAAM,OAAQ,OAC3B,KAAM,CAAC,MAAO,QAAS,KAAM,OAH3BA,EAMA,CACF,KAAM,CAAC,KAAM,KAAM,KAAM,OAAQ,MAAO,QACxC,KAAM,CAAC,KAAM,KAAM,SARjBA,GAWA,CACF,KAAM,CAAC,KAAM,KAAM,KAAM,KAAM,IAAK,IAAK,MACzC,KAAM,CAAC,KAAM,KAAM,KAAM,MACzB,KAAM,CAAC,IAAK,KAAM,KAAM,OAqF5B,SAASC,GAAsBC,GAM7B,MAL+C,CAC7C,KAAM,sCACN,KAAM,6BACN,KAAM,2BAEcA,IAAa,iBACrC,CAKA,SAASC,GAAyBC,EAAwBF,GAoBxD,MAnBoD,CAClD,KAAM,gJASN,KAAM,kIAUcA,IACpB,kDAGJ,CA2BO,SAASG,GACdrN,EACAkC,GAQA,GA5BK,SAA6ClC,GAClD,MAAMmB,EAAanB,EAAK,GAAG,KAG3B,OAAImB,GAAc,IAChBjB,QAAQC,KAAK,cAAcgB,kBACpB,EAIX,CAkBMmM,CAAoCtN,GACtC,MAAO,CACLuN,eAAe,EACfC,eAAe,GAInB,MAAMC,EA9ID,SAAgCvL,GACrC,MAAMC,EAAkBD,EAAUE,cAGlC,IAAK,MAAO8K,EAAUtG,KAAaM,OAAO+B,QAAQ+D,IAAwB,CACxE,MAAMU,EAAkB9G,EAAS+G,OAAOC,GAAMzL,EAAgBI,SAASqL,IACvE,GAAIF,EAAgBxI,OAAS,EAE3B,OADAhF,QAAQiD,KAAK,sBAAsB+J,UAAiBQ,EAAgB9H,KAAK,SAClE,CACLiI,iBAAiB,EACjBC,SAAU,KACVZ,WACAa,OAAQ,kBACRnK,QAASqJ,GAAsBC,GAGrC,CAGA,IAAK,MAAOA,EAAUtG,KAAaM,OAAO+B,QAAQ+D,GAAwB,CACxE,MAAMU,EAAkB9G,EAAS+G,OAAOC,GAAMzL,EAAgBI,SAASqL,IACvE,GAAIF,EAAgBxI,OAAS,EAE3B,OADAhF,QAAQiD,KAAK,sBAAsB+J,UAAiBQ,EAAgB9H,KAAK,SAClE,CACLiI,iBAAiB,EACjBC,SAAU,KACVZ,WACAa,OAAQ,mBACRC,gBAAiBb,GAAyBjL,EAAWgL,GACrDe,UAAW,CAAE,IAAK,IAGxB,CAGA,IAAK,MAAOf,EAAUtG,KAAaM,OAAO+B,QAAQ+D,GAAwB,CACxE,MAAMU,EAAkB9G,EAAS+G,OAAOC,GAAMzL,EAAgBI,SAASqL,IACvE,GAAIF,EAAgBxI,OAAS,EAE3B,OADAhF,QAAQC,KAAK,sBAAsB+M,UAAiBQ,EAAgB9H,KAAK,SAClE,CACLiI,iBAAiB,EACjBC,SAAU,KACVZ,WACAa,OAAQ,eACRE,UAAW,CAAE,IAAK,IAGxB,CAGA,MAAO,CACLJ,iBAAiB,EACjBC,SAAU,KACVZ,SAAU,KACVa,OAAQ,OAEZ,CAsFsBG,CAAuBhM,GAG3C,GAA2B,oBAAvBuL,EAAYM,OAId,OAHA7N,QAAQoD,MAAM,gBAAgBmK,EAAYP,YAC1ClN,EAAK,KAAK,KAAO,MACjBA,EAAK,GAAG,KAAO,OACR,CACLuN,eAAe,EACfC,eAAe,EACfW,WAAYV,EAAYP,UAAY,QAKxC,GAA2B,qBAAvBO,EAAYM,OAA+B,CAI7C,GAHA7N,QAAQiD,KAAK,mBAGTsK,EAAYQ,WAAW,IAAK,CAE9B,GAD+B,OAAjBjO,EAAK,GAAG,KACX,CAET,MAAMoO,EAAgB3F,EAA4BzI,EAAMyN,EAAYQ,UAAU,KAC1EG,EAAgB,EAClBlO,QAAQC,KAAK,wBAAwBiO,KAErClO,QAAQC,KAAK,iCAEjB,MAEEH,EAAK,KAAK,MAAQgC,KAAKxD,IAAI,IAAKwB,EAAK,KAAK,MAAQyN,EAAYQ,UAAU,IAE5E,CACA,MAAO,CACLV,eAAe,EACfc,cAAeZ,EAAYO,gBAC3BR,eAAe,EAEnB,CAGA,MAA2B,iBAAvBC,EAAYM,QACd7N,QAAQC,KAAK,eAETsN,EAAYQ,WAAW,MAErBjO,EAAK,GAAG,OAEVyI,EAA4BzI,EAAM,GAElCA,EAAK,KAAK,MAAQgC,KAAKxD,IAAI,IAAKwB,EAAK,KAAK,MAAQ,IAG/C,CACLuN,eAAe,EACfC,eAAe,IAKZ,CACLD,eAAe,EACfC,eAAe,EAEnB,CCtNA,MAAMc,GAAqB,CACzB,GAAI,CAEF,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,MACA,KACA,OACA,KACA,KACA,KACA,KAEA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KAEA,IACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MAEF,GAAI,CAEF,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,OACA,OACA,MACA,MAEA,MACA,MACA,MACA,MACA,MACA,KACA,KACA,MACA,MACA,MACA,MAEA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KAEA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MAEF,GAAI,CAEF,KACA,KACA,KACA,KACA,KACA,OACA,OACA,KACA,KACA,OACA,OACA,MACA,OAEA,KACA,KACA,KACA,KACA,MACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KAEA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KAEA,KACA,MACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MAEF,GAAI,CAEF,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,MAEA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,OACA,KACA,MAEF,GAAI,CACF,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,QACA,OACA,OACA,OACA,SAwBEC,GAA8B,CAElC,GAAI,CACF,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,KACA,KACA,KACA,KACA,KACA,MACA,MAIF,GAAI,CACF,IACA,KACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,KACA,MACA,KACA,KACA,KACA,KACA,KACA,MAIF,GAAI,CACF,KACA,KACA,KACA,KACA,KACA,KACA,IACA,IACA,IACA,KACA,KACA,KACA,KACA,MACA,OACA,KACA,MAIF,GAAI,CACF,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,IACA,KACA,KACA,KACA,KACA,KACA,KACA,MAIF,GAAI,CACF,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,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","sources":["src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src//schema.ts","src://tavern_helper_template/src////timeSystem.ts","src://tavern_helper_template/src////stateValidation.ts","src://tavern_helper_template/src////appearanceSystem.ts","src://tavern_helper_template/src////scene5System.ts","src://tavern_helper_template/src////dangerousContentDetection.ts","src://tavern_helper_template/src////dreamKeywordDetection.ts","src://tavern_helper_template/src////dualTrackSystem.ts","src://tavern_helper_template/src////boundaryInterruption.ts","src://tavern_helper_template/src////badEndingSystem.ts","src://tavern_helper_template/src////dataProtection.ts","src://tavern_helper_template/src////normalEndingSystem.ts","src://tavern_helper_template/src////trueEndingSystem.ts","src://tavern_helper_template/src////falseEndingSystem.ts","src://tavern_helper_template/src////perfectTrueEndingSystem.ts","src://tavern_helper_template/src////confusionEndingSystem.ts","src://tavern_helper_template/src////afterStorySystem.ts","src://tavern_helper_template/src////promptInjection.ts","src://tavern_helper_template/src////index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = z;","import { z } from 'zod';\n\n/**\n *  - \n *\n * \n * 1. BUG\n * 2. /\n * 3. 5\n */\n\nexport const Schema = z.object({\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // --- BUG ---\n      // Bug #18 5\n      // stateValidation.ts \"\"1-5\n      : z.number().min(1).max(99).default(1), // 1-5>5\n      : z.number().min(0).max(23).default(8), // 0-23\n      : z.string().default('Day 1, 08:00'), // \"Day 1, 08:00\"\n      : z.number().default(0), // Date.now()\n      : z.boolean().default(true), // \n\n      // ---  ---\n      : z.enum(['', '', '']).default(''),\n      : z.number().default(1), // \n\n      // ---  ---\n      : z.boolean().default(false), // false=, true=\n\n      // ---  ---\n      : z.enum(['', '', '', '']).default(''),\n\n      // --- UI---\n      // AI\n      _ID: z.number().optional(), // ID\n      _: z.number().optional(), // \n      : z.boolean().default(false), // \n\n      // ---  ---\n      : z\n        .object({\n          sceneNum: z.number().min(1).max(5), // \n          dreamEntryId: z.number(), // ID\n          dreamExitId: z.number().optional(), // Bug #25 ID\n        })\n        .optional(), // undefined \n\n      // ---  ---\n      : z\n        .object({\n          sceneNum: z.number().min(1).max(5), // \n          dreamEntryId: z.number(), // ID\n          dreamExitId: z.number().optional(), // Bug #25 ID\n        })\n        .optional(), // undefined \n\n      // --- ROLL Bug #21  ROLL  ---\n      // ID CHAT_COMPLETION_PROMPT_READY  ROLL\n      _: z\n        .object({\n          ID: z.number().default(-1), //  AI ID\n          : z.number().min(1).max(5).optional(), // 1-4  5\n          swipe_id: z.number().default(-1), // \n        })\n        .optional(),\n\n      // --- ROLL  ROLL  ---\n      // ID CHAT_COMPLETION_PROMPT_READY  ROLL\n      _: z\n        .object({\n          ID: z.number().default(-1), //  AI ID\n          : z.number().min(1).max(5).optional(), // 1-4  5\n          : z.enum(['', '5']).optional(), // \n        })\n        .optional(),\n\n      // --- ROLL  ROLL  ---\n      // IDswipe_id ROLL \n      //  ROLL \"\"\n      _: z\n        .object({\n          ID: z.number().default(-1), // ID\n          swipe_id: z.number().default(0), //  swipe_id\n          : z.number().min(1).max(5).optional(), // \n          ID: z.number().optional(), // ID\n          ID: z.number().optional(), // ID\n        })\n        .optional(),\n    })\n    .default({\n      : 1,\n      : 8,\n      : 'Day 1, 08:00',\n      : 0,\n      : true,\n      : '',\n      : 1,\n      : false,\n      : '',\n      : false,\n    }),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // ---  ---\n      : z.number().min(0).max(100).default(0), // \n      : z.number().min(0).max(100).default(80), // \n      : z.number().min(-50).max(100).default(60), // \n\n      // ---  ---\n      : z.number().min(0).max(100).default(5), // AI\n      : z.number().min(0).max(100).default(0), // \n      // (0-19)  (20-39)  (40-59)  (60-79)  (80+)\n\n      // ---  ---\n      //  =   /20 = \n      : z.number().min(1).max(5).default(1), // 1-5\n      // 1 :  0-19\n      // 2 :  20-39\n      // 3 :  40-59\n      // 4 :  60-79\n      // 5 :  80+\n\n      // ---  ---\n      : z\n        .object({\n          : z.number().min(0).max(100).default(0),\n          : z.number().min(0).max(100).default(0),\n          : z.number().min(0).max(100).default(0),\n          : z.number().min(0).max(100).default(0),\n          : z.number().min(0).max(100).default(0),\n        })\n        .default({\n          : 0,\n          : 0,\n          : 0,\n          : 0,\n          : 0,\n        }),\n\n      // --- AI ---\n      : z.string().default(''),\n      : z\n        .object({\n          : z.string().default(''),\n          : z.string().default(''),\n          : z.string().default(''),\n          : z.string().default(''),\n          : z.string().default(''),\n          : z.string().default(''),\n        })\n        .default({\n          : '',\n          : '',\n          : '',\n          : '',\n          : '',\n          : '',\n        }),\n      // --- AI ---\n      : z.string().default(''), // ///+//\n      : z.string().default(''), // \n      : z.array(z.string()).default([]), // \n\n      : z.string().default('...'),\n    })\n    .default({\n      : 0,\n      : 80,\n      : 60,\n      : 5,\n      : 0,\n      : 1,\n      : {\n        : 0,\n        : 0,\n        : 0,\n        : 0,\n        : 0,\n      },\n      : '',\n      : {\n        : '',\n        : '',\n        : '',\n        : '',\n        : '',\n        : '',\n      },\n      : '',\n      : '',\n      : [],\n      : '...',\n    }),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // ---  ---\n      : z.number().min(16).max(40).optional(), // 116\n      : z.string().optional(), // \n      : z.string().optional(), // \n      : z.string().optional(), // \n\n      // ---  ---\n      : z.array(z.number()).default([]), // [1, 2, 3, 4, 5]\n      : z.array(z.number()).default([]), // \n\n      // ---  ---\n      1: z\n        .object({\n          : z.boolean().default(false),\n          : z.array(z.string()).default([]), // \n          : z.boolean().optional(),\n          : z.string().optional(), // \"Day 1, 23:00\"\n          : z.number().default(0),\n          : z.string().optional(), // AI\n        })\n        .optional(),\n\n      2: z\n        .object({\n          : z.boolean().default(false),\n          : z.array(z.string()).default([]),\n          : z.boolean().optional(),\n          : z.string().optional(),\n          : z.number().default(0),\n          : z.string().optional(), // AI\n        })\n        .optional(),\n\n      3: z\n        .object({\n          : z.boolean().default(false),\n          : z.array(z.string()).default([]),\n          : z.boolean().optional(),\n          : z.string().optional(),\n          : z.number().default(0),\n          : z.string().optional(), // AI\n        })\n        .optional(),\n\n      4: z\n        .object({\n          : z.boolean().default(false),\n          : z.array(z.string()).default([]),\n          : z.boolean().optional(),\n          : z.string().optional(),\n          : z.number().default(0),\n          : z.string().optional(), // AI\n        })\n        .optional(),\n\n      5: z\n        .object({\n          : z.boolean().default(false),\n          : z.array(z.string()).default([]),\n          : z.boolean().optional(),\n          : z.string().optional(),\n          : z.number().default(0),\n          : z.boolean().default(true), // 5\n\n          // --- 512 ---\n          : z.number().default(0), // 5\n          : z.number().min(0).max(12).default(0), // 0=1-12=\n          : z.boolean().default(false), // 12\n          : z.string().optional(), // AI\n          // ---  ---\n          // \n          // - +10%+5%\n          // - 12 = 120%100%\n          // - 40%100%\n          : z.number().min(0).max(100).default(0), // 100%\n          : z.array(z.number()).default([]), //  [10, 5, 10, ...]\n\n          // --- ROLL Bug #11  ---\n          //  swipe_id CHAT_COMPLETION_PROMPT_READY  ROLL\n          : z\n            .object({\n              ID: z.number().default(-1), // ID\n              swipe_id: z.number().default(-1), //  swipe_id\n            })\n            .optional(),\n\n          // --- Bug #13  ---\n          // 5<100%\n          // \"\"5\n          : z.number().min(0).max(100).optional(), // 5\n          : z\n            .object({\n              : z.boolean().default(false),\n              : z.number().nullable().default(null),\n              : z.number().nullable().default(null),\n              : z.boolean().default(false),\n              : z.enum(['', '']).nullable().default(null),\n              : z.number().default(0),\n            })\n            .optional(), // 5\n        })\n        .optional(),\n\n      // ---  ---\n      // 0\n      // - 1: 40\n      // - 2: 60\n      // - 3: 80\n      // - 4: \n      // - 5: 80\n      // 5+7+10=100\n      : z.number().min(0).max(100).default(0), // 100\n\n      // --- 5 ---\n      // 5\"\"/\n      : z\n        .object({\n          : z.boolean().default(false), // \n          : z.number().nullable().default(null), // . * 24 + .\n          : z.number().nullable().default(null), //  + 1\n          : z.boolean().default(false), // \n          : z.enum(['', '']).nullable().default(null), // \n          : z.number().default(0), // 5\n        })\n        .default({\n          : false,\n          : null,\n          : null,\n          : false,\n          : null,\n          : 0,\n        }),\n\n      // ---  ---\n      // 51-2-3\n      // 0: 5\n      // 1: 1\n      // 2: 1+2+\n      // 3: 1+2+3\n      // 4527 vs 25\n      : z.number().min(0).max(3).default(0),\n      // 5\n      5: z.number().min(0).max(3).optional(),\n\n      // --- 20% ---\n      : z\n        .object({\n          : z.number().default(0), // \n          : z.number().default(0),\n          : z.number().default(0),\n          : z.number().default(0),\n          : z.number().default(0),\n          : z.number().default(0),\n        })\n        .default({ : 0, : 0, : 0, : 0, : 0, : 0 }),\n    })\n    .default({\n      : [],\n      : [],\n      : 0,\n      : {\n        : false,\n        : null,\n        : null,\n        : false,\n        : null,\n        : 0,\n      },\n      : 0,\n      : { : 0, : 0, : 0, : 0, : 0, : 0 },\n    }),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // ---  ---\n      : z.number().min(0).max(100).default(0), // 100\n\n      // ---  ---\n      : z.enum(['', '', '', '', '']).default(''),\n\n      // --- AI ---\n      : z.string().optional(), // 50\n    })\n    .default({\n      : 0,\n      : '',\n    }),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // 2026-01-18 \n      // - \n      // - 5+\"\"\n      // -  + =3\n      // - 5\n      // - >=100\n      // - >=100confusionEndingSystem\n      // - \n      // - +\n      : z\n        .enum(['', '', '', '', '', '', ''])\n        .default(''),\n      : z.string().optional(), // \n      : z.boolean().default(false),\n      // \n      : z.boolean().default(false), // =3\n\n      // --- ROLL  ROLL  ---\n      // ID CHAT_COMPLETION_PROMPT_READY  ROLL\n      _: z\n        .object({\n          ID: z.number().default(-1), //  AI ID\n          : z.enum(['', '', '']).optional(),\n        })\n        .optional(),\n\n      // --- 2026-01-17  ---\n      // \"\"\n      : z\n        .object({\n          : z.boolean().default(false), // \n          : z.number().min(0).max(2).default(0), // 0-2\n          : z.boolean().default(false), // \n          : z.boolean().default(false), // \n          // --- ROLL Bug #22  ---\n          // IDswipe_id ROLL \n          : z\n            .object({\n              ID: z.number().default(-1), // ID\n              swipe_id: z.number().default(0), //  swipe_id\n            })\n            .optional(),\n        })\n        .default({\n          : false,\n          : 0,\n          : false,\n          : false,\n        }),\n    })\n    .default({\n      : '',\n      : false,\n      : false,\n      : {\n        : false,\n        : 0,\n        : false,\n        : false,\n      },\n    }),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // ---  ---\n      isActive: z.boolean().default(false), // \n      isComplete: z.boolean().default(false), // \n\n      // ---  ---\n      currentPhase: z.number().min(0).max(9).default(0), //  (0-9)\n      turnsInPhase: z.number().default(0), // \n      totalTurns: z.number().default(0), // \n\n      // ---  ---\n      completedAnchors: z.array(z.string()).default([]), // \n\n      // --- Bug #15  ---\n      noProgressTurns: z.number().default(0), // \n      hintGiven: z.boolean().default(false), // \n    })\n    .optional(),\n\n  // ============================================\n  // 12\n  // ============================================\n  : z\n    .object({\n      // ---  ---\n      isActive: z.boolean().default(false), // \n      isComplete: z.boolean().default(false), // \n\n      // ---  ---\n      currentPhase: z.number().min(0).max(11).default(0), //  (0-11)\n      turnsInPhase: z.number().default(0), // \n      totalTurns: z.number().default(0), // \n\n      // ---  ---\n      completedAnchors: z.array(z.string()).default([]), // \n\n      // --- Bug #15  ---\n      noProgressTurns: z.number().default(0), // \n      hintGiven: z.boolean().default(false), // \n    })\n    .optional(),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      // ---  ---\n      isActive: z.boolean().default(false), // \n      isComplete: z.boolean().default(false), // \n\n      // ---  ---\n      currentPhase: z.number().min(0).max(7).default(0), //  (0-7)\n      turnsInPhase: z.number().default(0), // \n      totalTurns: z.number().default(0), // \n\n      // ---  ---\n      completedAnchors: z.array(z.string()).default([]), // \n\n      // --- Bug #15  ---\n      noProgressTurns: z.number().default(0), // \n      hintGiven: z.boolean().default(false), // \n    })\n    .optional(),\n\n  // ============================================\n  // \n  // ============================================\n  : z\n    .object({\n      : z.array(z.string()).default([]), // 10\n      : z.record(z.string(), z.string()).default({}), // {ID: }\n      : z.boolean().default(false),\n    })\n    .optional(),\n});\n\nexport type Schema = z.output<typeof Schema>;\n","import type { Schema as SchemaType } from '../../schema';\n\n/**\n *  - BUG\n *\n * TIME_LOOP_DESIGN.md\n * 1.  -  TimeSystem.advance()\n * 2.  -  data..\n * 3.  - \n * 4.  - \n * 5.  - \n */\n\ninterface TimeUpdateResult {\n  success: boolean;\n  oldTime: string;\n  newTime: string;\n  day: number;\n  hour: number;\n}\n\nexport class TimeSystem {\n  /**\n   * \n   * @param data \n   * @param hours 1\n   * @returns \n   */\n  static advance(data: SchemaType, hours: number = 1): TimeUpdateResult {\n    console.info(`\\n  `);\n    console.info(`: ${hours}`);\n\n    const oldTime = data..;\n    const oldDay = data..;\n    const oldHour = data..;\n\n    // Bug #18 \n    // \n    const rawTime = this.calculateRawTime(oldDay, oldHour, hours);\n\n    // 600:00Day 523:59\n    // 2026-01-17 20:0000:00\n    // Day 511:00Day 600:00\n    // Bug #18 Day 5\n    // Day 1-5  60\n    if (rawTime.day > 5 || (rawTime.day === 6 && rawTime.hour === 0)) {\n      if (data.. === '') {\n        console.info(`  Day ${rawTime.day}, ${rawTime.hour}:00`);\n        data.. = '';\n      }\n    }\n\n    // \n    // - \"\"Day > 5  Day 1\n    // - \"\"/\"\"\n    let finalDay = rawTime.day;\n    const finalHour = rawTime.hour;\n\n    if (finalDay > 5 && data.. === '') {\n      console.info(` 51`);\n      finalDay = 1;\n    }\n\n    // \n    data.. = finalDay;\n    data.. = finalHour;\n    data.. = this.formatTime(finalDay, finalHour);\n    data.. = Date.now();\n    data.. = true; // \n\n    const newTime = data..;\n\n    console.info(`: ${oldTime}  ${newTime}`);\n    console.info(`: Day ${finalDay}, : ${finalHour}:00`);\n    console.info(`: ${data..}`);\n    console.info(`: ${data..}`);\n    console.info(`  \\n`);\n\n    return {\n      success: true,\n      oldTime,\n      newTime,\n      day: finalDay,\n      hour: finalHour,\n    };\n  }\n\n  /**\n   * \n   * @param currentDay \n   * @param currentHour \n   * @param hours \n   * @returns \n   */\n  private static calculateRawTime(\n    currentDay: number,\n    currentHour: number,\n    hours: number,\n  ): { day: number; hour: number } {\n    let totalHours = currentHour + hours;\n    let day = currentDay;\n\n    // \n    while (totalHours >= 24) {\n      totalHours -= 24;\n      day += 1;\n    }\n\n    return { day, hour: totalHours };\n  }\n\n  /**\n   * \n   * @param day  (1-5)\n   * @param hour  (0-23)\n   * @returns  \"Day 1, 08:00\"\n   */\n  private static formatTime(day: number, hour: number): string {\n    const hourStr = hour.toString().padStart(2, '0');\n    return `Day ${day}, ${hourStr}:00`;\n  }\n\n  /**\n   * \n   * @param data \n   * @returns \n   */\n  static getCurrentTime(data: SchemaType): string {\n    return data..;\n  }\n\n  /**\n   * 22:00-01:00\n   * @param data \n   * @returns \n   */\n  static isDreamWindowOpen(data: SchemaType): boolean {\n    const hour = data..;\n    // 22:00-23:59  00:00-01:59\n    return hour === 22 || hour === 23 || hour === 0 || hour === 1;\n  }\n\n  /**\n   * 600:00Day 523:59\n   * 2026-01-17 20:0000:00\n   * Day 1-5 Day 60\n   * @param data \n   * @returns \n   */\n  static isEndingTime(data: SchemaType): boolean {\n    // 600:005day >= 6\n    return (data.. === 6 && data.. === 0) || data.. > 5;\n  }\n\n  /**\n   * Day 5, 11:00+\n   * 2026-01-17 11:00\n   * @param data \n   * @returns \n   */\n  static isTrueEndingGuidanceTime(data: SchemaType): boolean {\n    return data.. === 5 && data.. >= 11;\n  }\n\n  /**\n   * 10:00\n   * @param data \n   * @returns \n   */\n  static isWakeUpTime(data: SchemaType): boolean {\n    return data.. === 10;\n  }\n\n  /**\n   *  Day 5 1-4\n   * 2026-01-17 \n   *\n   * 5Day 5 22:00  Day 6 10:00\n   *        Day 6\n   *\n   * @param data \n   * @returns  Day 5 \n   */\n  static isDay5NightDreamBlocked(data: SchemaType): boolean {\n    return data.. === 5 && this.isDreamWindowOpen(data);\n  }\n\n  /**\n   * \n   * : Day 5, 00:00 Day 6  120 \n   * 2026-01-17 20:0011600:00120\n   * @param data \n   * @returns \n   */\n  static getHoursUntilReset(data: SchemaType): number {\n    const currentDay = data..;\n    const currentHour = data..;\n\n    // Day 1, 00:00\n    const currentTotalHours = (currentDay - 1) * 24 + currentHour;\n\n    //  Day 5, 24:00 = (5-1)*24 + 24 = 120 \n    //  Day 6, 00:00\n    const resetTotalHours = 5 * 24; // 120\n\n    // \n    const remaining = resetTotalHours - currentTotalHours;\n\n    return Math.max(0, remaining);\n  }\n\n  /**\n   * \n   * @param userInput \n   * @returns \n   */\n  static detectTimeSkipIntent(userInput: string): {\n    hasIntent: boolean;\n    targetHour?: number;\n    skipType?: 'sleep' | 'specific' | 'next_day';\n  } {\n    const normalizedInput = userInput.toLowerCase();\n\n    // \n    const sleepKeywords = ['', '', '', '', 'sleep', ''];\n    for (const keyword of sleepKeywords) {\n      if (normalizedInput.includes(keyword)) {\n        return { hasIntent: true, targetHour: 7, skipType: 'sleep' };\n      }\n    }\n\n    // \n    const timeSkipPattern = /?\\s*(\\d{1,2})\\s*[:]/;\n    const match = normalizedInput.match(timeSkipPattern);\n    if (match) {\n      const targetHour = parseInt(match[1], 10);\n      if (targetHour >= 0 && targetHour <= 23) {\n        return { hasIntent: true, targetHour, skipType: 'specific' };\n      }\n    }\n\n    // \n    const nextDayKeywords = ['', '', '', 'next day'];\n    for (const keyword of nextDayKeywords) {\n      if (normalizedInput.includes(keyword)) {\n        return { hasIntent: true, targetHour: 8, skipType: 'next_day' };\n      }\n    }\n\n    return { hasIntent: false };\n  }\n\n  /**\n   * \n   * MVU\n   * @param data \n   * @param userInput \n   * @returns \n   */\n  static processTimeSkipRequest(\n    data: SchemaType,\n    userInput: string,\n  ): {\n    processed: boolean;\n    blocked: boolean;\n    mvuMessage?: string;\n  } {\n    const intent = this.detectTimeSkipIntent(userInput);\n\n    if (!intent.hasIntent) {\n      return { processed: false, blocked: false };\n    }\n\n    // \n    const hoursRemaining = this.getHoursUntilReset(data);\n\n    // MVU\n    const mvuMessage = ` ${hoursRemaining} `;\n\n    console.warn(`[] : ${intent.skipType}`);\n    console.warn(`[] ${mvuMessage}`);\n\n    return {\n      processed: true,\n      blocked: true,\n      mvuMessage,\n    };\n  }\n\n  /**\n   * \n   * @param data \n   */\n  static validate(data: SchemaType): void {\n    console.info('\\n  ');\n    console.info(`: ${data..}`);\n    console.info(`: ${data..}`);\n    console.info(`: ${data..}`);\n    console.info(`: ${data..}`);\n    console.info(`: ${data..}`);\n    console.info(`: ${data..}`);\n\n    // \n    const expectedTime = this.formatTime(data.., data..);\n    if (data.. !== expectedTime) {\n      console.error(` : ${expectedTime}, : ${data..}`);\n    } else {\n      console.info(` `);\n    }\n\n    console.info('\\n');\n  }\n\n  /**\n   * \n   *\n   * \n   * -  TimeSystem.advance() \n   * - \n   * - \n   * - \n   *\n   * @param beforeTime \n   * @param afterTime \n   * @param messageId ID\n   * @returns \n   */\n  static checkTimeAdvancementAfterScript(\n    beforeTime: string,\n    afterTime: string,\n    messageId: number,\n  ): {\n    shouldWarn: boolean;\n    message?: string;\n  } {\n    // \n    if (messageId <= 1) {\n      return { shouldWarn: false };\n    }\n\n    // \n    if (beforeTime === afterTime) {\n      console.warn(`[]  : ${afterTime} ( ${messageId})`);\n      return {\n        shouldWarn: true,\n        message: `${afterTime}`,\n      };\n    }\n\n    // \n    console.info(`[]  : ${beforeTime}  ${afterTime} ( ${messageId})`);\n    return { shouldWarn: false };\n  }\n}\n","/**\n *  - \n *\n * \n * - 0-100\n * - \n * - \n * - \n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n/**\n * \n */\nfunction clamp(value: number, min: number, max: number): number {\n  return Math.min(Math.max(value, min), max);\n}\n\n/**\n * \n */\nexport function calculateRealm(: number): number {\n  if ( < 20) return 1;\n  if ( < 40) return 2;\n  if ( < 60) return 3;\n  if ( < 80) return 4;\n  return 5;\n}\n\n/**\n * \n */\nexport function getRealmNamePure(realm: number): string {\n  const names = ['', '', '', '', ''];\n  return names[realm - 1] ?? `${realm}`;\n}\n\n/**\n * \n */\nexport function getRealmNameTruth(realm: number): string {\n  const names = ['', '', '', '', ''];\n  return names[realm - 1] ?? `${realm}`;\n}\n\n/**\n * \n */\nexport function validateAndFixState(data: SchemaType): {\n  fixed: boolean;\n  changes: string[];\n} {\n  const changes: string[] = [];\n  let fixed = false;\n\n  // ============================================\n  // 1. \n  // ============================================\n\n  const  = data..;\n  const  = data..;\n  const  = data..;\n\n  data.. = clamp(data.., 0, 100);\n  data.. = clamp(data.., 0, 100);\n  data.. = clamp(data.., -50, 100);\n\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n\n  // ============================================\n  // 2. \n  // ============================================\n\n  const  = calculateRealm(data..);\n  if (data.. !== ) {\n    const  = data..;\n    data.. = ;\n    changes.push(`: ${}  ${}${data..}`);\n    fixed = true;\n\n    console.info(`[] : ${getRealmNamePure()}  ${getRealmNamePure()}`);\n  }\n\n  // ============================================\n  // 3.  + \n  // ============================================\n\n  const : Array<'' | '' | '' | '' | ''> = ['', '', '', '', ''];\n\n  // \n  const  = !data..;\n\n  for (const  of ) {\n    const  = data..[];\n    let  = clamp(, 0, 100);\n\n    // \n    // 50\n    if ( === '' &&  &&  > 0) {\n       = 0;\n      console.info(`[] 0: ${}`);\n    }\n    //  updateBodyPartProgress \n    // 5\n\n    if ( !== ) {\n      data..[] = ;\n      changes.push(`${}: ${}  ${}`);\n      fixed = true;\n    }\n  }\n\n  // ============================================\n  // 4. \n  // ============================================\n\n  const  = data..;\n  const  = data..;\n\n  data.. = clamp(data.., 0, 100);\n  data.. = clamp(data.., 0, 100);\n\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n\n  // ============================================\n  // 5. \n  // ============================================\n\n  // 100\n  // \n  // \n  const  = data.. === '';\n\n  if (data.. >= 100) {\n    if (data.. === '' && data.. === '') {\n      console.warn('[]  100');\n      // \n    }\n  }\n\n  if (data.. >= 100 && !) {\n    if (data.. === '' && data.. === '') {\n      console.warn('[]  100');\n      // \n    }\n  }\n\n  // ============================================\n  // 6. \n  // ============================================\n\n  const  = data..;\n  const  = data..;\n\n  // Bug #18 /5\n  // \"\"1-5\n  const isEndingPhase = data.. === '' || data.. === '';\n  const maxDay = isEndingPhase ? 99 : 5; // \n  data.. = clamp(data.., 1, maxDay);\n  data.. = clamp(data.., 0, 23);\n\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n  if (data.. !== ) {\n    changes.push(`: ${}  ${data..}`);\n    fixed = true;\n  }\n\n  // \n  if (fixed) {\n    console.info('[] :');\n    changes.forEach(change => console.info(`  - ${change}`));\n  }\n\n  return { fixed, changes };\n}\n\n/**\n * \n * @returns \n */\nlet lastRealm = -1;\n\nexport function checkRealmChange(data: SchemaType): {\n  changed: boolean;\n  oldRealm: number;\n  newRealm: number;\n} {\n  const currentRealm = data..;\n\n  // \n  if (lastRealm === -1) {\n    lastRealm = currentRealm;\n    console.info(`[] : ${currentRealm}`);\n    return { changed: false, oldRealm: currentRealm, newRealm: currentRealm };\n  }\n\n  // \n  if (currentRealm !== lastRealm) {\n    const oldRealm = lastRealm;\n    lastRealm = currentRealm;\n\n    console.info(\n      `[]  : ${oldRealm}  ${currentRealm}\\n` +\n        `  : ${getRealmNamePure(oldRealm)}  ${getRealmNamePure(currentRealm)}\\n` +\n        `  : ${getRealmNameTruth(oldRealm)}  ${getRealmNameTruth(currentRealm)}`,\n    );\n\n    return { changed: true, oldRealm, newRealm: currentRealm };\n  }\n\n  return { changed: false, oldRealm: currentRealm, newRealm: currentRealm };\n}\n\n/**\n * \n */\nexport function resetRealmTracking(): void {\n  lastRealm = -1;\n  console.info('[] ');\n}\n","/**\n *  - \n *\n * \n * - \n * - NTR\n *\n * \n * - 5~\n * - \n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport const EXPOSURE_LEVELS = ['', '', '', '', ''] as const;\nexport type ExposureLevel = (typeof EXPOSURE_LEVELS)[number];\n\n/**\n * \n */\nexport const MAKEUP_LEVELS = ['', '', '', '', ''] as const;\nexport type MakeupLevel = (typeof MAKEUP_LEVELS)[number];\n\n/**\n * \n */\nexport const TIDINESS_LEVELS = ['', '', '', '', ''] as const;\nexport type TidinessLevel = (typeof TIDINESS_LEVELS)[number];\n\n// ============================================\n// \n// ============================================\n\n/**\n * 5\n * \n */\nexport const PURE_LOVE_APPEARANCE_CONFIG = {\n  1: {\n    : '',\n    : ['', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', '', '', '', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  2: {\n    : '',\n    : ['', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', '', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  3: {\n    : '',\n    : ['', '', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', '', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  4: {\n    : '',\n    : ['', '', '', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  5: {\n    : '',\n    : ['', '', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n};\n\n// ============================================\n// NTR\n// ============================================\n\n/**\n * \n * \n */\nexport const TRUTH_APPEARANCE_CONFIG = {\n  1: {\n    : '',\n    : ['', '', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', '', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  2: {\n    : '',\n    : ['', '', '', '', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', ''],\n    },\n    : {\n      : 'V',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  3: {\n    : '',\n    : ['', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    },\n    : {\n      : '',\n      : 'V',\n      : ['', '', '', ''],\n      : ['', ''],\n    },\n    : {\n      : 'V',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  4: {\n    : '',\n    : ['', '', '', ''],\n    : {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : true,\n      : true,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : ['', '', ''],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n  5: {\n    : '',\n    : ['', '', '', '', ''],\n    : {\n      // 5\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : true,\n      : true,\n    },\n    : {\n      : '',\n      : '',\n      : ['', '', '', ''],\n      : '',\n      : [\n        '',\n        '',\n        '',\n        '\"\"',\n        '',\n      ],\n    },\n    : {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    },\n  },\n};\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport function getExposureIndex(level: ExposureLevel): number {\n  return EXPOSURE_LEVELS.indexOf(level);\n}\n\n/**\n * \n */\nexport function getMakeupIndex(level: MakeupLevel): number {\n  return MAKEUP_LEVELS.indexOf(level);\n}\n\n/**\n * \n */\nfunction getAppearanceConfig(: boolean) {\n  return  ? TRUTH_APPEARANCE_CONFIG : PURE_LOVE_APPEARANCE_CONFIG;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport function getRealmConstraints(realm: number, : boolean) {\n  const config = getAppearanceConfig();\n  const realmConfig = config[realm as keyof typeof config];\n\n  if (!realmConfig) {\n    return {\n      : ['', ''] as ExposureLevel[],\n      : '' as ExposureLevel,\n      : ['', ''] as MakeupLevel[],\n      : '' as MakeupLevel,\n      : false,\n      : false,\n    };\n  }\n  return realmConfig.;\n}\n\n/**\n * AI\n */\nexport function getStyleGuidance(realm: number, : boolean = false) {\n  const config = getAppearanceConfig();\n  const realmConfig = config[realm as keyof typeof config];\n\n  if (!realmConfig) {\n    return {\n      : '',\n      : '',\n      : [''],\n      : [] as string[],\n    };\n  }\n  return realmConfig.;\n}\n\n/**\n * AI\n */\nexport function getDefaultAppearance(realm: number, : boolean) {\n  const config = getAppearanceConfig();\n  const realmConfig = config[realm as keyof typeof config];\n\n  if (!realmConfig) {\n    return {\n      : '',\n      : '' as ExposureLevel,\n      : '',\n      : '' as MakeupLevel,\n    };\n  }\n  return realmConfig.;\n}\n\n/**\n * \n */\nexport function getRealmTitle(realm: number, : boolean): string {\n  const config = getAppearanceConfig();\n  const realmConfig = config[realm as keyof typeof config];\n  if (!realmConfig) return `${realm}`;\n  return realmConfig.;\n}\n\n/**\n * \n */\nexport function getAllowedInteractions(realm: number, : boolean): string[] {\n  const config = getAppearanceConfig();\n  const realmConfig = config[realm as keyof typeof config];\n  if (!realmConfig) return [];\n  return realmConfig. as unknown as string[];\n}\n\n// ============================================\n// +\n// ============================================\n\n/**\n * \n *  TIME_LOOP_DESIGN.md\n * - 1\n * - 2\n * - 3 + \n * - 4 +  +  + \n * - 5 + \n */\nexport const REALM_BODY_PART_UNLOCK: Record<number, string[]> = {\n  1: [], // \n  2: [''],\n  3: ['', ''],\n  4: ['', '', '', ''],\n  5: ['', '', '', '', ''],\n};\n\n/**\n * \n */\nexport const ALL_BODY_PARTS = ['', '', '', '', ''] as const;\nexport type BodyPartName = (typeof ALL_BODY_PARTS)[number];\n\n// ============================================\n// \n// ============================================\n\n/**\n *  = \n *\n * \n * - \"\"\n * - \n * - \"\"\n *\n * @param  0-100\n * @returns 0-100\n */\nexport function calculateDependencyFromBodyProgress(: Record<BodyPartName, number>): number {\n  const values = ALL_BODY_PARTS.map(part => [part] || 0);\n  const average = values.reduce((sum, v) => sum + v, 0) / values.length;\n  return Math.round(average);\n}\n\n/**\n * \n *\n * \n * - \n * - 100\n * - 0\n *\n * @param  0-100\n * @returns 0-100\n */\nexport function calculateMoralBaselineFromDependency(: number): number {\n  //  = 100 - \n  // 0  100\n  // 100  0\n  return Math.max(0, Math.min(100, 100 - ));\n}\n\n/**\n * \n *\n * \n *\n * @param  0-100\n * @returns 1-5\n */\nexport function calculateRealmFromDependency(: number): number {\n  if ( >= 80) return 5;\n  if ( >= 60) return 4;\n  if ( >= 40) return 3;\n  if ( >= 20) return 2;\n  return 1;\n}\n\n/**\n * \n *\n * \n * -  = \n * -  = 100 - \n * -  = /20\n *\n * @param data \n */\nexport function updateTruthModeValues(data: {\n  : {\n    : number;\n    : number;\n    : number;\n    : Record<BodyPartName, number>;\n  };\n  : {\n    : boolean;\n  };\n}): void {\n  // \n  if (!data..) {\n    return;\n  }\n\n  const  = data..;\n\n  // Bug #14.2  + Bug #23 \n  // \n  // \n  const  = data..;\n  const  = data..;\n  const  = data..;\n  const  = ALL_BODY_PARTS.reduce((sum, part) => sum + ([part] || 0), 0);\n\n  // 10>0\n  if ( === 0 &&  > 0) {\n    console.warn(\n      `[] 0=${}`,\n      `\\n  : ${JSON.stringify()}`,\n      `\\n  : ${}`,\n      `\\n  : ${}`,\n      `\\n  : ${}`,\n    );\n    return; // \n  }\n\n  // \n  const  = calculateDependencyFromBodyProgress();\n\n  // 2Bug #23 \n  // 15\n  // \n  const  =  - ;\n  if ( > 15) {\n    console.warn(\n      `[]  ${} `,\n      `\\n  : ${}  : ${}`,\n      `\\n  : ${JSON.stringify()}`,\n      `\\n  : ${}`,\n      `\\n  : `,\n    );\n    return; // \n  }\n\n  // 100 - \n  const  = calculateMoralBaselineFromDependency();\n\n  // \n  const  = calculateRealmFromDependency();\n\n  // \n  const  =  !== data..;\n  const  =  !== data..;\n  const  =  !== data..;\n\n  if ( ||  || ) {\n    console.info('[]');\n    if () {\n      console.info(`  : ${data..}  ${}`);\n    }\n    if () {\n      console.info(`  : ${data..}  ${}`);\n    }\n    if () {\n      console.info(`  : ${data..}  ${}`);\n    }\n  }\n\n  // \n  data.. = ;\n  data.. = ;\n  data.. = ;\n}\n\n/**\n * \n * \n */\nexport const BODY_PART_DEVELOPMENT_LEVELS = {\n  : {\n    range: [0, 19] as [number, number],\n    : '',\n    : '',\n  },\n  : {\n    range: [20, 39] as [number, number],\n    : '',\n    : '',\n  },\n  : {\n    range: [40, 59] as [number, number],\n    : '',\n    : '',\n  },\n  : {\n    range: [60, 79] as [number, number],\n    : '',\n    : '',\n  },\n  : {\n    range: [80, 100] as [number, number],\n    : '',\n    : '',\n  },\n} as const;\n\n/**\n * \n */\nexport function getDevelopmentLevelFromProgress(progress: number): keyof typeof BODY_PART_DEVELOPMENT_LEVELS {\n  if (progress >= 80) return '';\n  if (progress >= 60) return '';\n  if (progress >= 40) return '';\n  if (progress >= 20) return '';\n  return '';\n}\n\n/**\n * \n */\nexport const BODY_PART_BEHAVIOR_MAP: Record<BodyPartName, Record<string, string>> = {\n  : {\n    : '',\n    : '',\n    : '',\n    : '',\n    : '',\n  },\n  : {\n    : '',\n    : '',\n    : '',\n    : '',\n    : '',\n  },\n  : {\n    : '',\n    : '',\n    : '',\n    : '',\n    : '',\n  },\n  : {\n    : '',\n    : '',\n    : '',\n    : 'play',\n    : '',\n  },\n  : {\n    : '',\n    : '{{user}}',\n    : '',\n    : '{{user}}',\n    : '{{user}}',\n  },\n};\n\n/**\n * \n */\nexport function getBodyPartStatus(\n  : BodyPartName,\n  : number,\n  : boolean,\n): {\n  : string;\n  : number;\n  : string;\n  : string;\n  : string;\n  : boolean;\n} {\n  const  = getDevelopmentLevelFromProgress();\n  const  = BODY_PART_DEVELOPMENT_LEVELS[];\n  const  = BODY_PART_BEHAVIOR_MAP[][];\n\n  return {\n    : ,\n    ,\n    ,\n    : .,\n    ,\n    ,\n  };\n}\n\n/**\n * Prompt\n * AI\n *\n *  - \n * - \n * - \n *\n * @param data \n * @returns \n */\nexport function generateDetailedInteractionPrompt(data: {\n  : {\n    : number;\n    : Record<BodyPartName, number>;\n    ?: number;\n    ?: number;\n  };\n  : {\n    : boolean;\n    ?: string;\n  };\n}): string {\n  const  = data..;\n  const  = data..;\n  const  = data..;\n  const  = data.. || '';\n\n  // \n  const  = getRealmTitle(, );\n\n  // ============================================\n  // \n  // ============================================\n  if (!) {\n    // \n    const  = REALM_BODY_PART_UNLOCK[] || [];\n    const  = getAllowedInteractions(, false);\n\n    return `\n${}${}/5\n\n${.length > 0 ? .join('') : ''}\n\n\n`;\n  }\n\n  // ============================================\n  // \n  // ============================================\n\n  const  = data.. ?? calculateDependencyFromBodyProgress();\n  const  = data.. ?? calculateMoralBaselineFromDependency();\n\n  //  vs \n  if ( === '') {\n    // \n    let prompt = ` - \n${}${}/5\n${}/100\n${}/100\n\n\n\n\n`;\n\n    for (const  of ALL_BODY_PARTS) {\n      const  = [] || 0;\n      const  = getBodyPartStatus(, , true);\n\n      prompt += `\\n\\n ${.}${}%- ${.}\n  ${.}\n  ${.}`;\n    }\n\n    prompt += `\\n\\n\n- \"\"\n- \n- \n- `;\n\n    return prompt;\n  }\n\n  // \n  let prompt = ` - \n${}${}/5\n${}/100\n${}/100\n\n\n\"\"\n\n`;\n\n  for (const  of ALL_BODY_PARTS) {\n    const  = [] || 0;\n    const  = getBodyPartStatus(, , true);\n\n    prompt += `\\n\\n ${.}${}%- ${.}\n  ${.}\n  ${.}`;\n  }\n\n  // \n  if ( >= 80) {\n    prompt += `\\n\\n\n{{user}}\n`;\n  } else if ( >= 60) {\n    prompt += `\\n\\n\n{{user}}\n`;\n  } else if ( >= 40) {\n    prompt += `\\n\\n\n{{user}}\n`;\n  } else if ( >= 20) {\n    prompt += `\\n\\n\n\n`;\n  }\n\n  return prompt;\n}\n\n// ============================================\n// APIpromptInjection.ts\n// ============================================\n\n/**\n * API\n */\nexport function getCurrentClothing(\n  realm: number,\n  _: '' | '' | '',\n  : boolean = false,\n): string {\n  const defaultAppearance = getDefaultAppearance(realm, );\n  return defaultAppearance.;\n}\n\n/**\n * API\n */\nexport function getCurrentMakeup(\n  realm: number,\n  _: '' | '' | '',\n  : boolean = false,\n): string {\n  const defaultAppearance = getDefaultAppearance(realm, );\n  return defaultAppearance.;\n}\n\n// ============================================\n// Prompt\n// ============================================\n\n/**\n * PromptAI\n * \n *   \n */\nexport function generateAppearanceConstraintPrompt(data: SchemaType): string {\n  const realm = data..;\n  const  = data..;\n  const  = data.. !== '';\n  const  = data..;\n  const  =  >= 22 ||  < 7;\n\n  const constraints = getRealmConstraints(realm, );\n  const guidance = getStyleGuidance(realm, );\n  const title = getRealmTitle(realm, );\n\n  // \n  if (!) {\n    let prompt = `\n${title}${realm}/5\n${guidance.}\n\n\n- ${constraints..join(' ~ ')}\n- ${constraints..join(' ~ ')}\n- ${guidance.}\n- ${guidance..join('')}`;\n\n    const  = (guidance as Record<string, unknown>). as string[] | undefined;\n    if ( && .length > 0) {\n      prompt += `\\n- ${.join('')}`;\n    }\n\n    if () {\n      prompt += `\\n\\n`;\n    }\n\n    return prompt;\n  }\n\n  // \n  let  = constraints.;\n  let  = constraints.;\n\n  // 5\n  if (realm === 5 && ) {\n     = ['', ''] as ExposureLevel[];\n     = ['', ''] as MakeupLevel[];\n  }\n\n  let prompt = `\n${title}${realm}/5\n${guidance.}\n\nAI\n- ${.join(' ~ ')}\n- ${.join(' ~ ')}\n- ${constraints. ? '' : ''}\n- ${constraints. ? '' : ''}\n\nAI\n${guidance.}\n${guidance..join('')}`;\n\n  const  = (guidance as Record<string, unknown>). as string[] | undefined;\n  if ( && .length > 0) {\n    prompt += `\\n${.join('')}`;\n  }\n\n  // 5\n  if (realm === 5 && (guidance as Record<string, unknown>).) {\n    prompt += `\\n\\n${(guidance as Record<string, unknown>).}`;\n  }\n\n  // \n  if () {\n    prompt += `\\n\\n/`;\n  }\n\n  // \n  if ( && realm < 5) {\n    prompt += `\\n\\n`;\n  }\n\n  return prompt;\n}\n\n/**\n * \n */\nexport function isActionAllowed(\n  : string,\n  : number,\n  : boolean = false,\n): {\n  allowed: boolean;\n  reason?: string;\n} {\n  const config = getAppearanceConfig();\n  const realmConfig = config[ as keyof typeof config];\n\n  if (!realmConfig) {\n    return { allowed: false, reason: '' };\n  }\n\n  // 5\n  if ( &&  === 5) {\n    return { allowed: true };\n  }\n\n  // 4\n  const  = realmConfig. as readonly string[];\n  if ( &&  === 4 && (.includes('') || .includes(''))) {\n    return { allowed: true };\n  }\n\n  // \n  const  = realmConfig..some(\n     =>\n       ===  ||\n       === '' ||\n      (.includes(.substring(0, 2)) && .length > 2),\n  );\n\n  if () {\n    return { allowed: true };\n  }\n\n  return {\n    allowed: false,\n    reason: `${ ? '' : ''}${realmConfig.}`,\n  };\n}\n\n/**\n * \n */\nexport function updateHusbandLocation(data: SchemaType): void {\n  const  = data..;\n\n  let : SchemaType[''][''];\n\n  // \n  if ( >= 7 &&  < 8) {\n     = Math.random() > 0.5 ? '' : '';\n  } else if ( >= 8 &&  < 9) {\n     = Math.random() > 0.5 ? '' : '';\n  } else if ( >= 9 &&  < 18) {\n     = '';\n  } else if ( >= 18 &&  < 19) {\n     = '';\n  } else if ( >= 19 &&  < 21) {\n     = Math.random() > 0.5 ? '' : '';\n  } else if ( >= 21 &&  < 23) {\n     = Math.random() > 0.6 ? '' : '';\n  } else {\n     = '';\n  }\n\n  if (data.. !== ) {\n    const  = data..;\n    data.. = ;\n    console.info(`[] : ${}  ${}${data..}:00`);\n  }\n}\n\n//  boundaryInterruption.ts\n//  =   0.5%60  30%\n//  boundaryInterruption.ts  calculateInterruptionProbability  checkBoundaryViolation\n\n/**\n * AI\n */\nexport function generateAppearanceDescription(data: SchemaType): string {\n  return generateAppearanceConstraintPrompt(data);\n}\n\n/**\n * Bug #28 \n *\n * \n * \n */\nexport function updateZhaoxiaLocation(data: SchemaType): void {\n  const  = data..;\n\n  let : string;\n\n  // \n  if ( >= 6 &&  < 8) {\n    // \n     = Math.random() > 0.5 ? '' : '';\n  } else if ( >= 8 &&  < 12) {\n    // \n     = Math.random() > 0.6 ? '' : '';\n  } else if ( >= 12 &&  < 14) {\n    // \n     = '';\n  } else if ( >= 14 &&  < 17) {\n    // \n     = Math.random() > 0.5 ? '' : '';\n  } else if ( >= 17 &&  < 19) {\n    // \n     = '';\n  } else if ( >= 19 &&  < 22) {\n    // \n     = '';\n  } else {\n    // /\n     = '';\n  }\n\n  if (data.. !== ) {\n    const  = data..;\n    data.. = ;\n    console.info(`[] : ${}  ${}${data..}:00`);\n  }\n}\n\n/**\n * Bug #28 \n *\n * \n */\nexport function updateZhaoxiaThoughtAfterDream(data: SchemaType): void {\n  const  = data..;\n  const  = data..;\n\n  // \n  let : string;\n\n  if ( >= 80 ||  >= 5) {\n    // \n     = '......';\n  } else if ( >= 60 ||  >= 4) {\n    // \n     = '......';\n  } else if ( >= 40 ||  >= 3) {\n    // \n     = '......';\n  } else if ( >= 20 ||  >= 2) {\n    // \n     = '......';\n  } else {\n    // \n     = '...';\n  }\n\n  const  = data..;\n  data.. = ;\n  console.info(\n    `[] `,\n    `\\n  : ${.substring(0, 30)}...`,\n    `\\n  : ${.substring(0, 30)}...`,\n  );\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * AI\n */\nconst EXPOSURE_CLOTHING_KEYWORDS = {\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    'V',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n};\n\n/**\n * \n */\nconst HEAVY_MAKEUP_KEYWORDS = {\n  : ['', '', '', '', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', '', '', '', ''],\n};\n\n/**\n * \n * \n */\nconst INTIMATE_BEHAVIOR_KEYWORDS = {\n  : ['', '', '', '', '', '', '', '', '', '', ''],\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n};\n\n/**\n * 4+\n */\nconst REALM_MANIFESTATION_KEYWORDS = [\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n];\n\n/**\n * \n */\nfunction countKeywordsInText(text: string, keywords: string[]): number {\n  let count = 0;\n  for (const keyword of keywords) {\n    if (text.includes(keyword)) {\n      count++;\n    }\n  }\n  return count;\n}\n\n/**\n * \n * @returns 0=, 1=, 2=, 3=\n */\nfunction detectClothingExposure(: string): number {\n  const text = .toLowerCase();\n\n  // \n  if (countKeywordsInText(text, EXPOSURE_CLOTHING_KEYWORDS.) > 0) {\n    return 3;\n  }\n\n  // \n  if (countKeywordsInText(text, EXPOSURE_CLOTHING_KEYWORDS.) > 0) {\n    return 2;\n  }\n\n  // \n  if (countKeywordsInText(text, EXPOSURE_CLOTHING_KEYWORDS.) >= 2) {\n    return 1;\n  }\n\n  return 0;\n}\n\n/**\n * \n * @returns 0=, 1=, 2=\n */\nfunction detectMakeupIntensity(: string): number {\n  const text = .toLowerCase();\n\n  // \n  if (countKeywordsInText(text, HEAVY_MAKEUP_KEYWORDS.) > 0) {\n    return 2;\n  }\n\n  // \n  if (countKeywordsInText(text, HEAVY_MAKEUP_KEYWORDS.) > 0) {\n    return 1;\n  }\n\n  return 0;\n}\n\n/**\n * \n * @returns 0=, 1=, 2=, 3=\n */\nfunction detectIntimacyLevel(: string): number {\n  const text = ;\n\n  // \n  if (countKeywordsInText(text, INTIMATE_BEHAVIOR_KEYWORDS.) >= 1) {\n    return 3;\n  }\n\n  // \n  if (countKeywordsInText(text, INTIMATE_BEHAVIOR_KEYWORDS.) >= 1) {\n    return 2;\n  }\n\n  // \n  if (countKeywordsInText(text, INTIMATE_BEHAVIOR_KEYWORDS.) >= 2) {\n    return 1;\n  }\n\n  return 0;\n}\n\n/**\n * \n */\nfunction detectRealmManifestation(: string): boolean {\n  return countKeywordsInText(, REALM_MANIFESTATION_KEYWORDS) >= 2;\n}\n\n/**\n * \n */\nexport interface SuspicionIncreaseResult {\n  : number;\n  : string[];\n  : {\n    : number;\n    : number;\n    : number;\n    : number;\n  };\n}\n\n/**\n * \n *\n * \n * 1. \n * 2. +5, +10, +15\n * 3. +3, +8\n * 4. +5, +10, +20AI\n * 5. 460+3AI\n *\n * Bug #14 \n * - userInputTextAI\n * - AI\n * - AI\n *\n * @param data \n * @param userInputText \n * @returns \n */\nexport function calculateSuspicionIncrease(data: SchemaType, userInputText: string = ''): SuspicionIncreaseResult {\n  const result: SuspicionIncreaseResult = {\n    : 0,\n    : [],\n    : {\n      : 0,\n      : 0,\n      : 0,\n      : 0,\n    },\n  };\n\n  // \n  const  = data.. !== '';\n  if (!) {\n    return result;\n  }\n\n  // \n  const  = data..;\n\n  // \n  if () {\n    // 1. AI\n    const  = Object.values(data..).join(' ');\n    const  = detectClothingExposure();\n    if ( >= 1) {\n      const  = [0, 5, 10, 15][];\n      result.. = ;\n      result. += ;\n      result..push(`${}+${}`);\n    }\n\n    // 2. AI\n    const  = detectMakeupIntensity(data..);\n    if ( >= 1) {\n      const  = [0, 3, 8][];\n      result.. = ;\n      result. += ;\n      result..push(`${}+${}`);\n    }\n\n    // 4. Bug #14 AI\n    // \n    // 4+60+\n    if (data.. >= 4 && data.. >= 60) {\n      result.. = 3;\n      result. += 3;\n      result..push(`${data..}+3`);\n    }\n  }\n\n  // 3. \n  // \n  // \n  // Bug #14 AI\n  if (userInputText) {\n    const  = detectIntimacyLevel(userInputText);\n    if ( >= 1) {\n      const  = [0, 5, 10, 20][];\n      result.. = ;\n      result. += ;\n      const  =  ? '' : '';\n      result..push(`${}${}+${}`);\n    }\n  }\n\n  // \n  if (result. > 0) {\n    console.info(\n      `[] +${result.}`,\n      `\\n  : ${result..join(', ')}`,\n      `\\n  : ${data..}`,\n      `\\n  : ${data..}`,\n      `\\n  : ${data..}`,\n    );\n  }\n\n  return result;\n}\n\n/**\n * \n *\n * Bug #14 AI\n *\n * @param data \n * @param userInputText \n * @returns \n */\nexport function updateSuspicionLevel(data: SchemaType, userInputText: string = ''): number {\n  const result = calculateSuspicionIncrease(data, userInputText);\n\n  if (result. > 0) {\n    const  = data..;\n    const  = Math.min(100,  + result.);\n\n    data.. = ;\n\n    console.info(\n      `[] ${}  ${} (+${result.})`,\n      `\\n  : ${result..} + ${result..} + ${result..} + ${result..}`,\n    );\n\n    // \n    if ( >= 100) {\n      console.warn(`[]  100`);\n    } else if ( >= 80) {\n      console.warn(`[]  80`);\n    } else if ( >= 50) {\n      console.info(`[] 50`);\n    }\n\n    return ;\n  }\n\n  return data..;\n}\n","/**\n *  - 5\n *\n * 512\n *  - \n *\n * \n * 1. 07:00=131219:00=1\n * 2. //AI\n * 3. +10%+5%\n * 4. 11-10211-12+\n * 5. 19:0020:00\n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n// \n//                         5 - 12                       \n// \n//                       \n//             \n//   \"\"        \n//    -                                   \n// \n//                                                                       \n//     1-2 []  -                                       \n//     3-5 []  -                                     \n//     6-8 []  -                                           \n//     9-11[]  -                                           \n//     12  []  -                                           \n// \n//                                                                     \n//     - //                          \n//     -  +10% +5%                                              \n//     - 80%100%                                    \n// \n\n// ============================================\n// 12\n// ============================================\n\nexport interface Scene5Step {\n  step: number;\n  phase: '' | '' | '' | '' | '';\n  title: string;\n  description: string;\n  bestMatch: {\n    ?: '' | '' | '';\n    ?: '' | '' | '';\n    ?: '' | '' | '';\n  };\n  aiTask: string;\n}\n\nexport const SCENE5_STEPS: Scene5Step[] = [\n  {\n    step: 1,\n    phase: '',\n    title: '',\n    description: '\"\"',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \n4. `,\n  },\n  {\n    step: 2,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \n4. `,\n  },\n  {\n    step: 3,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \"\"\n3. \n4. `,\n  },\n  {\n    step: 4,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \n4. `,\n  },\n  {\n    step: 5,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \n4. `,\n  },\n  {\n    step: 6,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '', : '' },\n    aiTask: `1. \n2. /\n3. /\n4. `,\n  },\n  {\n    step: 7,\n    phase: '',\n    title: '',\n    description: '\"\"',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \"\"\n3. \n4. \"\"`,\n  },\n  {\n    step: 8,\n    phase: '',\n    title: '',\n    description: '\"\"',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \"\"\n4. `,\n  },\n  {\n    step: 9,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \n4. `,\n  },\n  {\n    step: 10,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \n4. `,\n  },\n  {\n    step: 11,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: { : '', : '' },\n    aiTask: `1. \n2. \n3. \"\"\n4. `,\n  },\n  {\n    step: 12,\n    phase: '',\n    title: '',\n    description: '',\n    bestMatch: {}, // \n    aiTask: `1. \n2. \n   - \n   - \n   - \n3. \n4. 5`,\n  },\n];\n\n// ============================================\n// 5\n// ============================================\n\n/**\n * \n *\n * \n * - 1: 16\n * - 2: 17\n * - 3: 23\n * - 5: \n * - 4: 28 - 5\n *\n * 45\n *\n * \n * - 0: 5\n *       \n * - 1: 1\n *       \n * - 2: 1+2\n *       +\n * - 3: 1+2+3\n *       \"\"\n */\n\nexport interface MemoryCoherenceInfo {\n  level: 0 | 1 | 2 | 3;\n  hasScene1: boolean; // \n  hasScene2: boolean; // \n  hasScene3: boolean; // \n  hasScene4: boolean; // \n  description: string;\n  aiHint: string; // AI\n}\n\n/**\n * \n *\n * \n * - 1  2  3\n * - \n * - 45\n *\n * @param data \n * @returns \n */\nexport function calculateMemoryCoherence(data: SchemaType): MemoryCoherenceInfo {\n  const completedScenes = new Set(data..);\n\n  const hasScene1 = completedScenes.has(1);\n  const hasScene2 = completedScenes.has(2);\n  const hasScene3 = completedScenes.has(3);\n  const hasScene4 = completedScenes.has(4);\n\n  // \n  let level: 0 | 1 | 2 | 3;\n  if (hasScene1 && hasScene2 && hasScene3) {\n    level = 3;\n  } else if (hasScene1 && hasScene2) {\n    level = 2;\n  } else if (hasScene1) {\n    level = 1;\n  } else {\n    level = 0;\n  }\n\n  // \n  let description: string;\n  let aiHint: string;\n\n  switch (level) {\n    case 0:\n      description = ' - ';\n      aiHint = `0 - \n\n- \n- \n- \n- `;\n      break;\n\n    case 1:\n      description = ' - ';\n      aiHint = `1 - \n161\n- \n- \n- 2\"\"\n- 3\"\"`;\n      break;\n\n    case 2:\n      description = '+ - ';\n      aiHint = `2 - +\n16171+2\n- \"\"\n- \n- \n- 3\"\"`;\n      break;\n\n    case 3:\n      description = ' - ';\n      aiHint = `3 - \n1+2+3\n- 161720\n- \n- \n- \n- \"\" \"...\" `;\n      break;\n  }\n\n  return {\n    level,\n    hasScene1,\n    hasScene2,\n    hasScene3,\n    hasScene4,\n    description,\n    aiHint,\n  };\n}\n\n/**\n * \n * 5AI\n *\n * @param coherence \n * @returns \n */\nexport function getMissingMemoryEffects(coherence: MemoryCoherenceInfo): string[] {\n  const effects: string[] = [];\n\n  if (!coherence.hasScene1) {\n    effects.push(`1\n16\n \"\"\n \"\"\"\"\n `);\n  }\n\n  if (!coherence.hasScene2) {\n    effects.push(`2\n17\"\"\n \"\"\n \"\"\"\"\n `);\n  }\n\n  if (!coherence.hasScene3) {\n    effects.push(`3\n20\n \"\"\n \"\"\"\"\n `);\n  }\n\n  return effects;\n}\n\n/**\n * 5\n *\n * Bug #13 2026-01-18\n * - 5  =0\n * - 5100%  1-2-3\n *\n * 5completionPercent >= 100%\n *\n * @param data \n */\nexport function lockScene5EntryCoherence(data: SchemaType): void {\n  const coherence = calculateMemoryCoherence(data);\n  data.. = coherence.level;\n  data..5 = coherence.level;\n  console.info(`[] 5${coherence.level} - ${coherence.description}`);\n}\n\n/**\n * 5\n * \n *\n * @param data \n * @returns \n */\nexport function getScene5LockedCoherence(data: SchemaType): 0 | 1 | 2 | 3 {\n  const locked = data..5;\n  if (locked !== undefined) {\n    return locked as 0 | 1 | 2 | 3;\n  }\n  // \n  return calculateMemoryCoherence(data).level;\n}\n\n/**\n * \n *\n * 2026-01-16\n * - \"\"\n * -  < 3 \n * - =3\n * - 1-2-3\n *\n * Bug #13 2026-01-18\n * - \n * - 5\n * - \"\"51-2-3\n *\n * @param data \n * @returns \n */\nexport function shouldIncreaseMemoryConfusion(data: SchemaType): boolean {\n  // Bug #13 \n  // \"5\"\"\"\n  const coherence = calculateMemoryCoherence(data);\n  if (coherence.level === 3) {\n    console.info('[] ');\n    return false;\n  }\n  return true;\n}\n\n/**\n * \n * =3\n *\n * @param data \n * @param amount \n * @returns 0\n */\nexport function safeIncreaseMemoryConfusion(data: SchemaType, amount: number): number {\n  if (!shouldIncreaseMemoryConfusion(data)) {\n    console.info(`[]  ${amount} ()`);\n    return 0;\n  }\n\n  const oldValue = data..;\n  data.. = Math.min(100, oldValue + amount);\n  const actualIncrease = data.. - oldValue;\n  console.info(`[]  +${actualIncrease} (${oldValue}  ${data..})`);\n  return actualIncrease;\n}\n\n// ============================================\n// \n// ============================================\n\nexport interface IntentAnalysis {\n  : '' | '' | '' | '';\n  : '' | '' | '' | '';\n  : '' | '' | '' | '';\n  : string;\n  : string[];\n}\n\nconst INTENT_KEYWORDS = {\n  : {\n    : ['', '', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', '', ''],\n  },\n  : {\n    : ['', '', '', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', ''],\n  },\n  : {\n    : ['', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', '', ''],\n  },\n};\n\n/**\n * \n */\nexport function analyzePlayerIntent(userInput: string): IntentAnalysis {\n  const result: IntentAnalysis = {\n    : '',\n    : '',\n    : '',\n    : userInput,\n    : [],\n  };\n\n  // \n  for (const [attitude, keywords] of Object.entries(INTENT_KEYWORDS.)) {\n    for (const keyword of keywords) {\n      if (userInput.includes(keyword)) {\n        result. = attitude as IntentAnalysis[''];\n        result..push(keyword);\n        break;\n      }\n    }\n    if (result. !== '') break;\n  }\n\n  // \n  for (const [behavior, keywords] of Object.entries(INTENT_KEYWORDS.)) {\n    for (const keyword of keywords) {\n      if (userInput.includes(keyword)) {\n        result. = behavior as IntentAnalysis[''];\n        result..push(keyword);\n        break;\n      }\n    }\n    if (result. !== '') break;\n  }\n\n  // \n  for (const [goal, keywords] of Object.entries(INTENT_KEYWORDS.)) {\n    for (const keyword of keywords) {\n      if (userInput.includes(keyword)) {\n        result. = goal as IntentAnalysis[''];\n        result..push(keyword);\n        break;\n      }\n    }\n    if (result. !== '') break;\n  }\n\n  return result;\n}\n\n/**\n * \n * @returns 'high' | 'low'\n */\nexport function calculateMatchLevel(intent: IntentAnalysis, step: Scene5Step): 'high' | 'low' {\n  const best = step.bestMatch;\n  let matchCount = 0;\n  let totalRequired = 0;\n\n  if (best.) {\n    totalRequired++;\n    if (intent. === best.) matchCount++;\n  }\n  if (best.) {\n    totalRequired++;\n    if (intent. === best.) matchCount++;\n  }\n  if (best.) {\n    totalRequired++;\n    if (intent. === best.) matchCount++;\n  }\n\n  // 12\n  if (totalRequired === 0) return 'high';\n\n  // \n  return matchCount >= totalRequired / 2 ? 'high' : 'low';\n}\n\n// ============================================\n// \n// ============================================\n\nexport interface Scene5CompletionInfo {\n  completionPercent: number;\n  currentStep: number;\n  maxAvailableSteps: number;\n  isStepsComplete: boolean;\n  isComplete: boolean; // 80%\n  canTriggerSpecialEnding: boolean;\n  entryCount: number;\n  stepProgressRecord: number[];\n  description: string;\n}\n\n/**\n * 5\n */\nexport function calculateScene5Completion(data: SchemaType): Scene5CompletionInfo {\n  const scene5Data = data..5 as\n    | {\n        ?: number;\n        ?: number;\n        ?: boolean;\n        ?: number;\n        ?: number[];\n      }\n    | undefined;\n\n  const entryCount = scene5Data?. ?? 0;\n  const currentStep = scene5Data?. ?? 0;\n  const isStepsComplete = scene5Data?. ?? false;\n  const completionPercent = scene5Data?. ?? 0;\n  const stepProgressRecord = scene5Data?. ?? [];\n\n  // \n  const currentHour = data..;\n  const maxAvailableSteps = Math.max(0, Math.min(12, 20 - currentHour));\n\n  // 100%\n  const canTriggerSpecialEnding = completionPercent >= 100;\n\n  // 80%\n  const isComplete = completionPercent >= 80;\n\n  let description = '';\n  if (completionPercent >= 100) {\n    description = '5';\n  } else if (completionPercent >= 80) {\n    description = `5${completionPercent}%`;\n  } else if (completionPercent >= 60) {\n    description = `5${completionPercent}%`;\n  } else if (currentStep > 0) {\n    description = `5${currentStep}/12${completionPercent}%80%`;\n  } else {\n    description = '5';\n  }\n\n  return {\n    completionPercent,\n    currentStep,\n    maxAvailableSteps,\n    isStepsComplete,\n    isComplete, // 80%\n    canTriggerSpecialEnding,\n    entryCount,\n    stepProgressRecord,\n    description,\n  };\n}\n\n/**\n * \n *\n * Bug #13 19:00  18:00\n * - 08:00   09:00 1  ...  18:00 10  19:00 \n * - 1012\n */\nexport function getRemainingSteps(data: SchemaType): number {\n  const scene5Data = data..5 as { ?: number } | undefined;\n  const currentStep = scene5Data?. ?? 0;\n  const currentHour = data..;\n\n  // Bug #13 19:00  18:00 1\n  //  20 - currentHour 19 - currentHour\n  const maxStepsFromTime = Math.max(0, 19 - currentHour);\n\n  //  = min(, )\n  const storyRemaining = 12 - currentStep;\n  return Math.min(storyRemaining, maxStepsFromTime);\n}\n\n// ============================================\n// 5\n// ============================================\n\nexport interface BodyInfluenceInfo {\n  hasInfluence: boolean;\n  influences: string[];\n  avgProgress: number;\n}\n\n/**\n * 5\n */\nexport function getBodyInfluenceForScene5(data: SchemaType): BodyInfluenceInfo {\n  const progress = data..;\n  const influences: string[] = [];\n\n  if (progress. >= 60) {\n    influences.push('');\n  }\n  if (progress. >= 60) {\n    influences.push('');\n  }\n  if (progress. >= 60) {\n    influences.push('');\n  }\n  if (progress. >= 60) {\n    influences.push('');\n  }\n\n  const bodyParts = ['', '', '', ''] as const;\n  const sum = bodyParts.reduce((acc, part) => acc + (progress[part] ?? 0), 0);\n  const avgProgress = Math.floor(sum / bodyParts.length);\n\n  return {\n    hasInfluence: influences.length > 0,\n    influences,\n    avgProgress,\n  };\n}\n\n// ============================================\n// AI\n// ============================================\n\n/**\n * 5AI\n */\nexport function generateScene5StepPrompt(data: SchemaType, intent: IntentAnalysis): string {\n  const completion = calculateScene5Completion(data);\n  const currentStep = completion.currentStep;\n  const remainingSteps = getRemainingSteps(data);\n  const bodyInfluence = getBodyInfluenceForScene5(data);\n\n  // 12\n  if (completion.isStepsComplete || currentStep >= 12) {\n    return generateFreePlayPrompt(data, bodyInfluence);\n  }\n\n  // \n  const nextStep = currentStep + 1;\n  const stepConfig = SCENE5_STEPS[nextStep - 1];\n\n  if (!stepConfig) {\n    return generateFreePlayPrompt(data, bodyInfluence);\n  }\n\n  // \n  const matchLevel = calculateMatchLevel(intent, stepConfig);\n  const progressGain = matchLevel === 'high' ? 10 : 5;\n\n  // \n  let bodyInfluenceText = '';\n  if (bodyInfluence.hasInfluence) {\n    bodyInfluenceText = `\\n\\n${bodyInfluence.influences.map(i => `- ${i}`).join('\\n')}`;\n  }\n\n  // \n  const intentSummary = `${intent.}${intent.}${intent.}`;\n  const matchNote =\n    matchLevel === 'high' ? '  - ' : '  - ';\n\n  return `[5 - ${nextStep}/12${stepConfig.title}]\n\n${stepConfig.phase}\n${remainingSteps}20:00\n${completion.completionPercent}%\n+${progressGain}%${matchLevel === 'high' ? '' : ''}\n\n\n${stepConfig.description}\n\n\n${intentSummary}\n${matchNote}\n${intent..length > 0 ? intent..join('') : ''}\n${bodyInfluenceText}\n\nAI\n${stepConfig.aiTask}\n\n\n- ${intent.}\n- ${intent.}\n- ${intent.}\n- \"\"\n- \n\n\n-  \n- \n- \n- \"\"\"\"\"\"`;\n}\n\n/**\n * 122\n *\n * 2026-01-17 \n * - \"\"\n * - \n * - 19:001\n *\n * \n * - 19:00 AI\n * - 20:00 \n * - 19:00\n */\nfunction generateFreePlayPrompt(data: SchemaType, bodyInfluence: BodyInfluenceInfo): string {\n  const completion = calculateScene5Completion(data);\n  const currentHour = data..;\n  // 19:0019:00\n  const remainingHours = 19 - currentHour;\n\n  let bodyInfluenceText = '';\n  if (bodyInfluence.hasInfluence) {\n    bodyInfluenceText = `\\n\\n${bodyInfluence.influences.map(i => `- ${i}`).join('\\n')}`;\n  }\n\n  // \n  let timeGuidance = '';\n  if (remainingHours <= 1) {\n    // 118:00-19:00\n    timeGuidance = `\\n\n- 19:00\n- \"\"\n- ...`;\n  } else if (remainingHours <= 2) {\n    // 217:00-18:00\n    timeGuidance = `\\n\n- ${remainingHours}\n- `;\n  } else {\n    // <17:00\n    timeGuidance = `\\n\n- \"\"\n- `;\n  }\n\n  return `[5 - ]\n\n${completion.completionPercent}%\n${completion.canTriggerSpecialEnding ? ' ' : ''}\n${remainingHours > 0 ? remainingHours : '<1'}19:00\n\n12\n\n${bodyInfluenceText}\n${timeGuidance}\n\nAI\n1. 5 + \n2. \n3. \n4. \n5. \n\n\n- \n- \n- \n\n\n-   \n-  \n- \n- \"\"\"\"`;\n}\n\n// \nconst SCENE_INFO: Record<number, { title: string; age: number }> = {\n  1: { title: '', age: 16 },\n  2: { title: '', age: 17 },\n  3: { title: '', age: 23 },\n  4: { title: '', age: 28 },\n  5: { title: '', age: 25 }, // \n};\n\n/**\n * 5\n * 1-35AI\n *\n * @param data \n * @returns \n */\nfunction generatePreviousSceneSummaries(data: SchemaType): string {\n  const summaries: string[] = [];\n\n  // 1-345\n  for (let i = 1; i <= 3; i++) {\n    const sceneKey = `${i}` as keyof typeof data.;\n    const sceneData = data.[sceneKey] as\n      | {\n          ?: boolean;\n          ?: string;\n        }\n      | undefined;\n\n    const sceneInfo = SCENE_INFO[i];\n    const isCorrect = data...includes(i);\n\n    if (sceneData?.) {\n      // \n      summaries.push(`${sceneInfo.title}${sceneInfo.age}\n${sceneData.}\n ${isCorrect ? '' : ''}`);\n    } else if (sceneData?.) {\n      // \n      summaries.push(`${sceneInfo.title}${sceneInfo.age}\n...\n${isCorrect ? '' : '...'}\n ${isCorrect ? '' : ''}`);\n    }\n  }\n\n  if (summaries.length === 0) {\n    return '';\n  }\n\n  return `\n\n5\n\n${summaries.join('\\n\\n')}\n\n---\nAI\n- \n- \n- `;\n}\n\n/**\n * 5\n * 2026-01-16  + \n */\nexport function generateScene5EntryReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const completion = calculateScene5Completion(data);\n  const bodyInfluence = getBodyInfluenceForScene5(data);\n  const currentHour = data..;\n  const maxSteps = Math.max(0, Math.min(12, 20 - currentHour));\n\n  const isFirstEntry = completion.entryCount === 0;\n  const isStepsComplete = completion.isStepsComplete;\n\n  // \n  const coherence = calculateMemoryCoherence(data);\n  const missingEffects = getMissingMemoryEffects(coherence);\n\n  // 2026-01-16 \n  const previousSummaries = generatePreviousSceneSummaries(data);\n\n  // \n  let bodyInfluenceText = '';\n  if (bodyInfluence.hasInfluence) {\n    bodyInfluenceText = `\\n\\n${bodyInfluence.influences.map(i => `- ${i}`).join('\\n')}`;\n  }\n\n  // \n  let coherenceText = `\\n${coherence.level}\\n${coherence.description}\\n\\n${coherence.aiHint}`;\n  if (missingEffects.length > 0) {\n    coherenceText += `\\n\\n\\n${missingEffects.join('\\n\\n')}`;\n  }\n\n  const userMessage = `[ - 5]\n\n\n\n5\n- 25\n- /\n-  - \n\n\n- ${completion.entryCount + 1}\n- ${completion.currentStep}/12\n- ${maxSteps}\n- ${completion.completionPercent}%\n- 20:00\n${coherenceText}\n${previousSummaries}\n\n${\n  isFirstEntry\n    ? ` - 12\n12\n1-2 - \n3-5 - \n6-8 - \n9-11 - \n12 - `\n    : isStepsComplete\n      ? ` - \n12AI`\n      : ` - ${completion.currentStep + 1}\n${completion.currentStep}${completion.currentStep + 1}`\n}\n${bodyInfluenceText}\n\nAI\n1. \n2. \n3. ${isFirstEntry ? '1' : isStepsComplete ? '' : `${completion.currentStep + 1}`}\n4. \n5. \n\n <status_current_variable> \": \"\": \"\n\n\n-  <HusbandThought> \n-  //* \n- \n-  \n- \n- 25\n- \n- \"\"\"\"\"\"\n- /25`;\n\n  // \n  const prefill = isFirstEntry\n    ? generateCoherenceBasedPrefill(coherence)\n    : `......\n\n\n\n`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * \n */\nfunction generateCoherenceBasedPrefill(coherence: MemoryCoherenceInfo): string {\n  switch (coherence.level) {\n    case 0:\n      //  - \n      return `......\n\n\n\n\n\n\n\n\"\"\"\"\n\n`;\n\n    case 1:\n      //  - \n      return `......\n\n\n\n\n\n\n\n\"\"\"\"\n\n`;\n\n    case 2:\n      // + - \n      return `......\n\n\n\n\n\n\n\n\"\"\"\"\n\n\n\n\"\"`;\n\n    case 3:\n      //  - \n      return `......\n\n\n\n\n\n\"\"\n\n\"\"\n\n\n\n\"\"\"\"\n\n\n\n\"\"`;\n  }\n}\n\n/**\n * 5\n */\nexport function generateScene5ForceExitReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const completion = calculateScene5Completion(data);\n\n  const userMessage = `[ - 5]\n\n20:005\n\n\n- ${completion.entryCount}\n- ${completion.currentStep}/12\n- ${completion.completionPercent}%\n- ${completion.isStepsComplete ? ' ' : ' '}\n${completion.canTriggerSpecialEnding ? '-  ' : ''}\n\nAI\n1. \n2. \n3. \n   - <80%\n   - 80-99%\n   - 100%\n\n\n- \n- \"\"`;\n\n  const prefill =\n    completion.completionPercent >= 80\n      ? `\"\"......\n\n`\n      : `......\n\n`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 5\n */\nexport function generateScene5StepReplacement(\n  data: SchemaType,\n  userInput: string,\n): {\n  userMessage: string;\n  prefill: string;\n} {\n  const intent = analyzePlayerIntent(userInput);\n  const stepPrompt = generateScene5StepPrompt(data, intent);\n\n  const userMessage = `[]\n${userInput}\n\n---\n\n${stepPrompt}`;\n\n  // prefillAI\n  const prefill = '';\n\n  return { userMessage, prefill };\n}\n\n/**\n * 5\n * 12\n */\nexport function generateScene5FreePlayReplacement(\n  data: SchemaType,\n  userInput: string,\n): {\n  userMessage: string;\n  prefill: string;\n} {\n  const bodyInfluence = getBodyInfluenceForScene5(data);\n  const freePlayPrompt = generateFreePlayPrompt(data, bodyInfluence);\n\n  const userMessage = `[]\n${userInput}\n\n---\n\n${freePlayPrompt}`;\n\n  // prefillAI\n  const prefill = '';\n\n  return { userMessage, prefill };\n}\n","import type { Schema as SchemaType } from '../../schema';\nimport { safeIncreaseMemoryConfusion } from './scene5System';\n\n/**\n * \n *\n *  TIME_LOOP_DESIGN.md \n * - 1+5~10\n * - 2\n * - 3BAD END\n *\n * \n */\n\n// \nconst DANGEROUS_KEYWORDS = {\n  : {\n    : ['', '', '', ''],\n    : ['', '', '', ''],\n  },\n\n  : {\n    : ['', '', '', '', '', ''],\n    : ['', '', ''],\n  },\n\n  : {\n    : ['', '', '', '', '', '', ''],\n    : ['', '', '', ''],\n    : ['', '', '', ''],\n  },\n};\n\n// \nexport interface InterruptionResult {\n  shouldInterrupt: boolean;\n  severity: '' | '' | '' | null;\n  category: string | null;\n  action: 'WARNING_ONLY' | 'FORCE_CORRECTION' | 'TRIGGER_BAD_END' | 'NONE';\n  message?: string;\n  correctedPrompt?: string;\n  penalties?: {\n    ?: number;\n    ?: number;\n    ?: number;\n  };\n}\n\n/**\n * \n * @param userInput \n * @returns \n */\nexport function detectDangerousContent(userInput: string): InterruptionResult {\n  const normalizedInput = userInput.toLowerCase();\n\n  //  BAD END\n  for (const [category, keywords] of Object.entries(DANGEROUS_KEYWORDS.)) {\n    const matchedKeywords = keywords.filter(kw => normalizedInput.includes(kw));\n    if (matchedKeywords.length > 0) {\n      console.warn(`[]   ${category} : ${matchedKeywords.join(', ')}`);\n      return {\n        shouldInterrupt: true,\n        severity: '',\n        category,\n        action: 'TRIGGER_BAD_END',\n        message: generateBadEndingText(category),\n      };\n    }\n  }\n\n  //   \n  for (const [category, keywords] of Object.entries(DANGEROUS_KEYWORDS.)) {\n    const matchedKeywords = keywords.filter(kw => normalizedInput.includes(kw));\n    if (matchedKeywords.length > 0) {\n      console.warn(`[]   ${category} : ${matchedKeywords.join(', ')}`);\n      return {\n        shouldInterrupt: true,\n        severity: '',\n        category,\n        action: 'FORCE_CORRECTION',\n        correctedPrompt: generateCorrectionPrompt(userInput, category),\n        penalties: { : 20 },\n      };\n    }\n  }\n\n  //   \n  for (const [category, keywords] of Object.entries(DANGEROUS_KEYWORDS.)) {\n    const matchedKeywords = keywords.filter(kw => normalizedInput.includes(kw));\n    if (matchedKeywords.length > 0) {\n      console.info(`[]   ${category} : ${matchedKeywords.join(', ')}`);\n      return {\n        shouldInterrupt: false,\n        severity: '',\n        category,\n        action: 'WARNING_ONLY',\n        penalties: { : 10 },\n      };\n    }\n  }\n\n  // \n  return {\n    shouldInterrupt: false,\n    severity: null,\n    category: null,\n    action: 'NONE',\n  };\n}\n\n/**\n * \n */\nfunction generateBadEndingText(category: string): string {\n  const badEndingTexts: Record<string, string> = {\n    : '...',\n    : '...',\n    : '',\n  };\n  return badEndingTexts[category] || '...';\n}\n\n/**\n * Prompt\n */\nfunction generateCorrectionPrompt(_originalInput: string, category: string): string {\n  const correctionTemplates: Record<string, string> = {\n    : `[]\n\n1. {{user}}\n2. \n3. \n4. \"\"+20\n\n\"\"`,\n\n    : `[]\n\n1. {{user}}\n2. \n3. {{user}}\n\n\"\"`,\n  };\n\n  return (\n    correctionTemplates[category] ||\n    `[]\n{{user}}`\n  );\n}\n\n/**\n * \n * Day 5 \n * \n * @param data \n * @returns \n */\nexport function shouldSkipDangerousContentDetection(data: SchemaType): boolean {\n  const currentDay = data..;\n\n  // Day 5 \n  if (currentDay >= 5) {\n    console.info(`[] Day ${currentDay} `);\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * \n * @param data \n * @param userInput \n * @returns \n */\nexport function processUserInput(\n  data: SchemaType,\n  userInput: string,\n): {\n  allowContinue: boolean;\n  modifiedInput?: string;\n  triggerBadEnd: boolean;\n  badEndType?: string;\n} {\n  // Day 5+ \n  if (shouldSkipDangerousContentDetection(data)) {\n    return {\n      allowContinue: true,\n      triggerBadEnd: false,\n    };\n  }\n\n  const dangerCheck = detectDangerousContent(userInput);\n\n  // BAD END\n  if (dangerCheck.action === 'TRIGGER_BAD_END') {\n    console.error(`[] : ${dangerCheck.category}`);\n    data.. = '';\n    data.. = '';\n    return {\n      allowContinue: false,\n      triggerBadEnd: true,\n      badEndType: dangerCheck.category ?? '',\n    };\n  }\n\n  // \n  if (dangerCheck.action === 'FORCE_CORRECTION') {\n    console.warn(`[] `);\n    // \n    // \n    if (dangerCheck.penalties?.) {\n      const  = data.. === '';\n      if () {\n        // \n        const actualPenalty = safeIncreaseMemoryConfusion(data, dangerCheck.penalties.);\n        if (actualPenalty > 0) {\n          console.info(`[] +${actualPenalty}`);\n        } else {\n          console.info(`[] `);\n        }\n      } else {\n        // \n        data.. = Math.min(100, data.. + dangerCheck.penalties.);\n      }\n    }\n    return {\n      allowContinue: true,\n      modifiedInput: dangerCheck.correctedPrompt,\n      triggerBadEnd: false,\n    };\n  }\n\n  // \n  if (dangerCheck.action === 'WARNING_ONLY') {\n    console.info(`[] `);\n    // \n    if (dangerCheck.penalties?.) {\n      // \n      if (data..) {\n        // \n        safeIncreaseMemoryConfusion(data, 5);\n      } else {\n        data.. = Math.min(100, data.. + 5);\n      }\n    }\n    return {\n      allowContinue: true,\n      triggerBadEnd: false,\n    };\n  }\n\n  // \n  return {\n    allowContinue: true,\n    triggerBadEnd: false,\n  };\n}\n","import type { Schema as SchemaType } from '../../schema';\nimport { safeIncreaseMemoryConfusion } from './scene5System';\n\n/**\n * \n *\n *  TIME_LOOP_DESIGN.md \n * - \n * - 5\n * - \n *\n * 44\n * - +2%5%\n * - +AI8%\n * - 25%3-4\n * - 4 = 80-100%\n * - 4 = 20-25%\n * - 5\n */\n\n/**\n * 5\n *\n * 2026-01-15 \n * \n * - \"\"\"\"\"\"\n * - \"\"\"\"\"\"\"\"\n * - \"\"\"\"\"\"\n *\n * \n * 1. \n * 2. /\n * 3. \n * 4. \"\"\"\"\n * 5. \n */\n/**\n * Bug #37 \n * \"\"\n * \n *\n * \n * 1.  - \n * 2. \n * 3. +\n */\nconst BODY_PART_KEYWORDS = {\n  : [\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // Bug #37 \n    '', // \"\"\"\"\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // Bug #37 \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // Bug #37 \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // Bug #37 \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // Bug #37 \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    // \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    // Bug #37 \n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n};\n\n// ============================================\n// AI\n// ============================================\n\n/**\n * \n *\n * Bug #37 \n *\n * AIBODY_PROGRESS\n * - \"\"AI\n * - \"\"AI\n *\n * \n * 1. \n * 2. \n * 3. \n * 4. \n * 5. /\n */\nconst INTERACTION_INTENT_KEYWORDS = {\n  // \n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n\n  // \n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n\n  // \n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n\n  // \n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n\n  // Bug #37 / - \n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n};\n\n/**\n * \n * AIBODY_PROGRESS\n *\n * @param userInput \n * @returns \n */\nexport function hasInteractionIntent(userInput: string): boolean {\n  if (!userInput || userInput.trim().length === 0) {\n    return false;\n  }\n\n  const allKeywords = [\n    ...INTERACTION_INTENT_KEYWORDS.,\n    ...INTERACTION_INTENT_KEYWORDS.,\n    ...INTERACTION_INTENT_KEYWORDS.,\n    ...INTERACTION_INTENT_KEYWORDS.,\n    ...INTERACTION_INTENT_KEYWORDS., // Bug #37 /\n  ];\n\n  const matchedKeywords = allKeywords.filter(kw => userInput.includes(kw));\n\n  if (matchedKeywords.length > 0) {\n    console.info(`[] : [${matchedKeywords.join(', ')}]`);\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * AIBODY_PROGRESS\n *\n * \n * 1.   AI\n * 2.   AI\n * 3.   AI\n *\n * @param userInput \n * @param aiResponse AI\n * @returns \n */\nexport function validateAndProcessAIReport(userInput: string, aiResponse: string): BodyPartProgress {\n  // 1. \n  const scriptDetected = detectBodyPartProgress(userInput);\n  const hasScriptProgress = Object.values(scriptDetected).some(v => v > 0);\n\n  // AI\n  if (hasScriptProgress) {\n    console.info('[AI] ');\n    return scriptDetected;\n  }\n\n  // 2. AI\n  const aiSuggested = parseAIBodyProgressSuggestion(aiResponse);\n  const hasAISuggestion = Object.values(aiSuggested).some(v => v > 0);\n\n  if (!hasAISuggestion) {\n    console.info('[AI] AI');\n    return scriptDetected; // \n  }\n\n  // 3. \n  const hasIntent = hasInteractionIntent(userInput);\n\n  if (hasIntent) {\n    console.info('[AI] AI');\n    return aiSuggested;\n  } else {\n    console.info('[AI] AI');\n    return { : 0, : 0, : 0, : 0, : 0 };\n  }\n}\n\n// \nexport interface BodyPartProgress {\n  : number;\n  : number;\n  : number;\n  : number;\n  : number;\n}\n\n// \nexport const DEVELOPMENT_LEVELS = {\n  Lv0: { min: 0, max: 19, : '' },\n  Lv1: { min: 20, max: 39, : '' },\n  Lv2: { min: 40, max: 59, : '' },\n  Lv3: { min: 60, max: 79, : '' },\n  Lv4: { min: 80, max: 100, : '' },\n};\n\n/**\n * \n */\nexport function getDevelopmentLevel(progress: number): { level: string; name: string } {\n  if (progress >= 80) return { level: 'Lv4', name: '' };\n  if (progress >= 60) return { level: 'Lv3', name: '' };\n  if (progress >= 40) return { level: 'Lv2', name: '' };\n  if (progress >= 20) return { level: 'Lv1', name: '' };\n  return { level: 'Lv0', name: '' };\n}\n\n// ============================================\n// \n// ============================================\n\n/**  */\nconst PROGRESS_PER_KEYWORD = 2;\n\n/** AI */\nconst SINGLE_DETECTION_MAX = 5;\n\n/** +AI */\nconst MERGED_PROGRESS_MAX = 8;\n\n/** AI */\nconst AI_SUGGESTION_MAX = 5;\n\n/** \n *  2026-01-16\n * - 480-100%\n * - 20%4 = 80%\n * - 100%\n */\nconst NIGHTLY_PROGRESS_CAP = 20;\n\n/**\n * \n * @param userInput \n * @returns \n */\nexport function detectBodyPartProgress(userInput: string): BodyPartProgress {\n  const result: BodyPartProgress = { : 0, : 0, : 0, : 0, : 0 };\n\n  // Bug #23 100\n  const inputPreview = userInput.length > 100 ? userInput.substring(0, 100) + '...' : userInput;\n  console.info(`[] : \"${inputPreview}\"`);\n\n  for (const [part, keywords] of Object.entries(BODY_PART_KEYWORDS)) {\n    const matchedKeywords = keywords.filter(kw => userInput.includes(kw));\n    const matchCount = matchedKeywords.length;\n    if (matchCount > 0) {\n      // +2%5%\n      const increment = Math.min(SINGLE_DETECTION_MAX, matchCount * PROGRESS_PER_KEYWORD);\n      result[part as keyof BodyPartProgress] = increment;\n      // \n      console.info(\n        `[]  ${part}  ${matchCount} : [${matchedKeywords.join(', ')}]+${increment}%`,\n      );\n    }\n  }\n\n  // \n  const totalProgress = Object.values(result).reduce((sum, v) => sum + v, 0);\n  if (totalProgress === 0) {\n    console.info(`[] `);\n  }\n\n  return result;\n}\n\n/**\n * \n *\n * Bug #24 schema  \"\" \n *\n * \n * - 5 5. === true\n * - 1-4 _ Day 11Day 22...\n *\n * @param data \n * @returns 1-5 undefined\n */\nfunction getCurrentDreamSceneNumber(data: SchemaType): number | undefined {\n  // 5\n  const scene5Data = data..5 as { ?: boolean } | undefined;\n  if (scene5Data?. === true) {\n    return 5;\n  }\n\n  // 1-4\n  // \n  const day = data.._ ?? data..;\n  if (day >= 1) {\n    return Math.min(day, 4);\n  }\n\n  return undefined;\n}\n\n/**\n * \n *\n * \n * - 5\"\"\n * - 1-4\"\"\n * - \n *\n * @param data \n * @returns \n */\nexport function getAllowedBodyParts(data: SchemaType): (keyof BodyPartProgress)[] {\n  // \n  if (data.. !== '') {\n    return [];\n  }\n\n  // Bug #24 \n  const currentScene = getCurrentDreamSceneNumber(data);\n\n  // 5\n  if (currentScene === 5) {\n    return [''];\n  }\n\n  // 1-4\n  if (currentScene !== undefined && currentScene >= 1 && currentScene <= 4) {\n    return ['', '', '', ''];\n  }\n\n  // \n  console.warn(\n    `[] _=${data.._}=${data..}`,\n  );\n  return ['', '', '', ''];\n}\n\n/**\n * \n *\n * 20%44\n *\n * \n * - 5\"\"\n * - 1-4\"\"\n *\n * @param data \n * @param progressIncrement \n */\nexport function updateBodyPartProgress(data: SchemaType, progressIncrement: BodyPartProgress): void {\n  const currentDay = data..;\n  // Bug #24 \n  const currentScene = getCurrentDreamSceneNumber(data);\n\n  // \n  const allowedParts = getAllowedBodyParts(data);\n\n  if (allowedParts.length === 0) {\n    console.info(`[] =${data..}=${currentScene ?? ''}`);\n    return;\n  }\n\n  // \n  if (data... !== currentDay) {\n    data.. = {\n      : currentDay,\n      : 0,\n      : 0,\n      : 0,\n      : 0,\n      : 0,\n    };\n    console.info(`[] Day ${currentDay}`);\n  }\n\n  for (const part of allowedParts) {\n    if (progressIncrement[part] > 0) {\n      // \n      const nightlyProgress = data..[part];\n      const remainingCap = NIGHTLY_PROGRESS_CAP - nightlyProgress;\n\n      if (remainingCap <= 0) {\n        console.info(`[] ${part} ${NIGHTLY_PROGRESS_CAP}%`);\n        continue;\n      }\n\n      // \n      const actualIncrement = Math.min(progressIncrement[part], remainingCap);\n\n      const oldProgress = data..[part];\n      const newProgress = Math.min(100, oldProgress + actualIncrement);\n      data..[part] = newProgress;\n\n      // \n      data..[part] += actualIncrement;\n\n      const oldLevel = getDevelopmentLevel(oldProgress);\n      const newLevel = getDevelopmentLevel(newProgress);\n\n      console.info(\n        `[] ${currentScene} ${part}: +${actualIncrement}%` +\n          (actualIncrement < progressIncrement[part] ? `+${progressIncrement[part]}%` : '') +\n          `: ${data..[part]}/${NIGHTLY_PROGRESS_CAP}%`,\n      );\n\n      if (oldLevel.level !== newLevel.level) {\n        console.info(`[] ${part} : ${oldLevel.level}  ${newLevel.level} (${newLevel.name})`);\n      }\n    }\n  }\n\n  // \n  const allParts: (keyof BodyPartProgress)[] = ['', '', '', '', ''];\n  const blockedParts = allParts.filter(p => progressIncrement[p] > 0 && !allowedParts.includes(p));\n\n  if (blockedParts.length > 0) {\n    console.info(\n      `[] ${currentScene} ${blockedParts.join('')}` +\n        `: ${allowedParts.join('')}`,\n    );\n  }\n}\n\n/**\n * \n * @param data \n * @returns \n */\nexport function getBodyPartSummary(\n  data: SchemaType,\n): Record<string, { progress: number; level: string; name: string }> {\n  const summary: Record<string, { progress: number; level: string; name: string }> = {};\n  const parts: (keyof BodyPartProgress)[] = ['', '', '', '', ''];\n\n  for (const part of parts) {\n    const progress = data..[part];\n    const levelInfo = getDevelopmentLevel(progress);\n    summary[part] = {\n      progress,\n      ...levelInfo,\n    };\n  }\n\n  return summary;\n}\n\n// 5\n// 1-4 23:00-01:00  + \n// 5\n//\n// ****\n// \nexport const SCENE_CORRECT_ANSWERS: Record<number, string[]> = {\n  1: [''], // 116 \n  2: ['', ''], // 217 +\n  3: [''], // 323 \n  4: ['', '', '', ''], // 428 \n  5: [''], // 5  12\n};\n\n/**\n * \n * ****\n *\n * @param sceneNumber \n * @param selectedParts \n * @returns \n */\nexport function checkCorrectSelection(sceneNumber: number, selectedParts: string[]): boolean {\n  const correctAnswers = SCENE_CORRECT_ANSWERS[sceneNumber];\n  if (!correctAnswers) {\n    console.warn(`[] ${sceneNumber}`);\n    return false;\n  }\n\n  // Bug #39 \n  const uniqueSelectedParts = [...new Set(selectedParts)];\n\n  // \n  if (uniqueSelectedParts.length !== selectedParts.length) {\n    console.warn(\n      `[] : [${selectedParts.join(', ')}]  [${uniqueSelectedParts.join(', ')}]`,\n    );\n  }\n\n  // \n  const sortedSelected = [...uniqueSelectedParts].sort();\n  const sortedCorrect = [...correctAnswers].sort();\n\n  // \n  const isCorrect =\n    sortedSelected.length === sortedCorrect.length &&\n    sortedSelected.every((part, index) => part === sortedCorrect[index]);\n\n  console.info(\n    `[] ${sceneNumber}: =[${uniqueSelectedParts.join(', ')}], ` +\n      `=[${correctAnswers.join(', ')}], =${isCorrect ? '' : ''}`,\n  );\n  return isCorrect;\n}\n\n/**\n * \n * @param data \n * @param sceneNumber \n */\nexport function processSceneCompletion(data: SchemaType, sceneNumber: number): void {\n  const sceneKey = `${sceneNumber}` as keyof typeof data.;\n  const sceneData = data.[sceneKey];\n\n  if (!sceneData || typeof sceneData !== 'object') {\n    console.warn(`[] ${sceneNumber}`);\n    return;\n  }\n\n  // \n  const selectedParts = (sceneData as { ?: string[] }). ?? [];\n\n  // \n  const isCorrect = checkCorrectSelection(sceneNumber, selectedParts);\n\n  // \n  (sceneData as { ?: boolean }). = isCorrect;\n\n  // \n  if (!data...includes(sceneNumber)) {\n    data...push(sceneNumber);\n  }\n\n  if (isCorrect) {\n    if (!data...includes(sceneNumber)) {\n      data...push(sceneNumber);\n    }\n    console.info(`[]  ${sceneNumber}`);\n  } else {\n    // \n    const penalty = 20;\n    const actualPenalty = safeIncreaseMemoryConfusion(data, penalty);\n    if (actualPenalty > 0) {\n      console.warn(`[]  ${sceneNumber}+${actualPenalty}`);\n    } else {\n      console.warn(`[]  ${sceneNumber}`);\n    }\n  }\n\n  // \n  console.info(\n    `[] : =${data...length}/5, =${data..}`,\n  );\n}\n\n/**\n * AI\n * AI<!--BODY_PROGRESS: +10, +5-->\n * @param aiResponse AI\n * @returns \n */\nexport function parseAIBodyProgressSuggestion(aiResponse: string): BodyPartProgress {\n  const result: BodyPartProgress = { : 0, : 0, : 0, : 0, : 0 };\n\n  //  <!--BODY_PROGRESS: ...--> HTML\n  const progressMatch = aiResponse.match(/<!--\\s*BODY_PROGRESS:\\s*([^-]+?)-->/i);\n  if (!progressMatch) {\n    return result;\n  }\n\n  const progressStr = progressMatch[1];\n  console.info(`[AI] AI: ${progressStr}`);\n\n  // +10, +5  :10, :5\n  const partPatterns = [\n    { part: '', patterns: ['', '', ''] },\n    { part: '', patterns: ['', '', ''] },\n    { part: '', patterns: ['', '', ''] },\n    { part: '', patterns: ['', '', ''] },\n    { part: '', patterns: ['', '', ''] },\n  ];\n\n  for (const { part, patterns } of partPatterns) {\n    for (const pattern of patterns) {\n      //  \"+\"  \":\"  \" \"\n      const regex = new RegExp(`${pattern}\\\\s*[+:]?\\\\s*(\\\\d+)`, 'i');\n      const match = progressStr.match(regex);\n      if (match) {\n        const value = parseInt(match[1], 10);\n        // +5AI\n        const clampedValue = Math.min(AI_SUGGESTION_MAX, Math.max(0, value));\n        result[part as keyof BodyPartProgress] = clampedValue;\n        console.info(`[AI] ${part}: +${clampedValue}: +${value}`);\n        break;\n      }\n    }\n  }\n\n  return result;\n}\n\n/**\n * AI\n * AI\n *\n * 8%44\n *\n * @param scriptDetected \n * @param aiSuggested AI\n * @returns \n */\nexport function mergeBodyPartProgress(\n  scriptDetected: BodyPartProgress,\n  aiSuggested: BodyPartProgress,\n): BodyPartProgress {\n  const result: BodyPartProgress = { : 0, : 0, : 0, : 0, : 0 };\n  const parts: (keyof BodyPartProgress)[] = ['', '', '', '', ''];\n\n  for (const part of parts) {\n    //  MERGED_PROGRESS_MAX (8%)\n    const merged = Math.min(MERGED_PROGRESS_MAX, Math.max(scriptDetected[part], aiSuggested[part]));\n    result[part] = merged;\n\n    if (scriptDetected[part] > 0 && aiSuggested[part] > 0) {\n      console.info(`[] ${part}: =${scriptDetected[part]}, AI=${aiSuggested[part]}, =${merged}`);\n    } else if (scriptDetected[part] > 0) {\n      console.info(`[] ${part}: =${scriptDetected[part]}`);\n    } else if (aiSuggested[part] > 0) {\n      console.info(`[] ${part}: AI=${aiSuggested[part]}`);\n    }\n  }\n\n  return result;\n}\n\n/**\n * Prompt\n * @param data \n * @param currentScene \n * @returns AI Prompt\n */\nexport function generateMemoryContinuityPrompt(data: SchemaType, currentScene: number): string {\n  if (currentScene <= 1) {\n    return `\n- 1\n- \n- `;\n  }\n\n  const completedScenes = data...filter(s => s < currentScene);\n  if (completedScenes.length === 0) {\n    return `\n- ${currentScene}\n- `;\n  }\n\n  // \n  const memorySummary = completedScenes\n    .map(sceneNum => {\n      const isCorrect = data...includes(sceneNum);\n      return `  - ${sceneNum}: ${isCorrect ? '' : ''}`;\n    })\n    .join('\\n');\n\n  return `\n- ${currentScene}\n- ${completedScenes.length}\n- \n- \n\n\n${memorySummary}`;\n}\n\n// ============================================\n// \n//  generateRaw \n// ============================================\n\n/**\n * \n */\nconst DREAM_SCENE_INFO: Record<number, { title: string; age: number; theme: string }> = {\n  1: { title: '', age: 16, theme: '' },\n  2: { title: '', age: 17, theme: '' },\n  3: { title: '', age: 23, theme: '' },\n  4: { title: '', age: 28, theme: '' },\n  5: { title: '', age: 0, theme: '' }, // age=0\n};\n\n/**\n * \n */\nexport interface DreamSessionData {\n  /**  */\n  playerActions: string;\n  /** AIAI */\n  emotionalReactions: string;\n}\n\n/**\n * AI\n * \n *\n * @param aiOutput AI\n * @returns \n */\nfunction extractEmotionalReaction(aiOutput: string): string {\n  if (!aiOutput || aiOutput.length < 50) return '';\n\n  //  <HusbandThought> \n  let cleaned = aiOutput\n    .replace(/<HusbandThought>[\\s\\S]*?<\\/HusbandThought>/gi, '')\n    .replace(/<status_update>[\\s\\S]*?<\\/status_update>/gi, '')\n    .replace(/<[^>]+>/g, '')\n    .trim();\n\n  // \n  const emotionKeywords = [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ];\n\n  // \n  const sentences = cleaned.split(/[\\n]+/).filter(s => s.trim().length > 5);\n  const emotionalSentences: string[] = [];\n\n  for (const sentence of sentences) {\n    const hasEmotion = emotionKeywords.some(kw => sentence.includes(kw));\n    if (hasEmotion && emotionalSentences.length < 3) {\n      // \n      const trimmed = sentence.trim().slice(0, 60);\n      emotionalSentences.push(trimmed + (sentence.length > 60 ? '...' : ''));\n    }\n  }\n\n  return emotionalSentences.join('');\n}\n\n/**\n * \n * \n *\n * 2026-01-16 \n * - \n * - AI\n *\n * Bug #25  dreamExitMessageId \n * \n * ID\n *\n * @param dreamEntryMessageId ID\n * @param dreamExitMessageId ID\n */\nexport async function getDreamSessionMessages(\n  dreamEntryMessageId: number | undefined,\n  dreamExitMessageId?: number | undefined,\n): Promise<string> {\n  if (!dreamEntryMessageId) {\n    console.warn('[] ID');\n    return '';\n  }\n\n  try {\n    //  SillyTavern.chat \n    const chatMessages = SillyTavern.chat;\n    if (!chatMessages || !Array.isArray(chatMessages)) {\n      console.warn('[] ');\n      return '';\n    }\n\n    // SillyTavern  message_id\n    const entryIndex = dreamEntryMessageId;\n    if (entryIndex < 0 || entryIndex >= chatMessages.length) {\n      console.warn(`[] ID: ${dreamEntryMessageId}`);\n      return '';\n    }\n\n    // Bug #25 \n    let endIndex: number;\n    if (dreamExitMessageId !== undefined && dreamExitMessageId >= entryIndex) {\n      // ID\n      endIndex = Math.min(dreamExitMessageId + 1, chatMessages.length);\n      console.info(`[] Bug #25 ${dreamExitMessageId}`);\n    } else {\n      // ID\n      endIndex = chatMessages.length;\n      console.warn(`[] Bug #25ID`);\n    }\n\n    // \n    const dreamMessages = chatMessages.slice(entryIndex, endIndex);\n\n    // \n    const playerMessages = dreamMessages\n      .filter(m => m.is_user && m.mes && typeof m.mes === 'string' && m.mes.trim())\n      .map(m => `- ${m.mes.trim()}`)\n      .join('\\n');\n\n    // 2026-01-16 AI\n    const aiMessages = dreamMessages.filter(m => !m.is_user && m.mes && typeof m.mes === 'string');\n    const emotionalReactions: string[] = [];\n\n    for (const msg of aiMessages) {\n      const reaction = extractEmotionalReaction(msg.mes);\n      if (reaction) {\n        emotionalReactions.push(reaction);\n      }\n    }\n\n    const playerCount = dreamMessages.filter(m => m.is_user).length;\n    const aiCount = aiMessages.length;\n    console.info(\n      `[]  ${playerCount} ${aiCount} AI ${entryIndex} ~ ${endIndex - 1}`,\n    );\n\n    //  + AI\n    let result = playerMessages;\n    if (emotionalReactions.length > 0) {\n      // \n      const uniqueReactions = [...new Set(emotionalReactions)].slice(0, 5);\n      result += `\\n\\n\\n${uniqueReactions.map(r => ` ${r}`).join('\\n')}`;\n    }\n\n    return result;\n  } catch (err) {\n    console.error('[] :', err);\n    return '';\n  }\n}\n\n/**\n * \n *\n * 2026-01-16 \n * \n * 1. \n * 2. AI\n *\n * \n * ```\n * \n * - \n * - \n *\n * \n *  \n *  \"\"\n * ```\n *\n * @param _data \n * @param sceneNum \n * @param chatHistory +AI\n * @returns \n */\nexport async function generateMemorySummary(_data: SchemaType, sceneNum: number, chatHistory: string): Promise<string> {\n  const sceneInfo = DREAM_SCENE_INFO[sceneNum] || { title: `${sceneNum}`, age: 0, theme: '' };\n\n  // \n  if (!chatHistory || chatHistory.trim().length < 20) {\n    console.warn('[] ');\n    return `${sceneInfo.title}\\n`;\n  }\n\n  console.info(`[] ${sceneNum}${sceneInfo.title}`);\n  console.info(`[] : ${chatHistory.length} `);\n\n  // \n  // \n  const summary = `${sceneInfo.title}\\n${chatHistory}`;\n\n  console.info(`[] : ${summary.length} `);\n\n  return summary;\n}\n\n/**\n * Prompt\n * \"/\"\n *\n * \n * - 1: 16\n * - 2: 17\n * - 3: 23\n * - 5: 4\n * - 4: 28\n *\n * 54\n *\n * @param data \n * @param currentScene \n * @returns AI Prompt\n */\nexport function generateEnhancedMemoryContinuityPrompt(data: SchemaType, currentScene: number): string {\n  if (currentScene <= 1) {\n    return ` - \n- 116\n- \n- \n- `;\n  }\n\n  // 1-35\n  // 45 -> 28\n  const completedScenes = data...filter(s => s < currentScene);\n\n  // 45\n  const hasScene5Memory = currentScene === 4 && data...includes(5);\n\n  if (completedScenes.length === 0 && !hasScene5Memory) {\n    return ` - \n- ${currentScene}\n- \n- `;\n  }\n\n  // \n  const previousMemories: string[] = [];\n\n  for (let i = 1; i < currentScene; i++) {\n    const sceneKey = `${i}` as keyof typeof data.;\n    const sceneData = data.[sceneKey] as\n      | {\n          ?: boolean;\n          ?: string;\n        }\n      | undefined;\n\n    const sceneInfo = DREAM_SCENE_INFO[i] || { title: `${i}`, age: 0 };\n    const isCorrect = data...includes(i);\n\n    if (sceneData?.) {\n      // \n      previousMemories.push(`${sceneInfo.title}${sceneInfo.age}\n${sceneData.}\n${isCorrect ? '' : ''}`);\n    } else if (sceneData?.) {\n      // \n      previousMemories.push(`${sceneInfo.title}${sceneInfo.age}\n...\n${isCorrect ? '' : '...'}\n${isCorrect ? '' : ''}`);\n    }\n  }\n\n  // 45\n  // 3(23) -> 5() -> 4(28)\n  if (hasScene5Memory) {\n    const scene5Data = data..5 as\n      | {\n          ?: boolean;\n          ?: string;\n          ?: number;\n        }\n      | undefined;\n\n    const scene5Info = DREAM_SCENE_INFO[5];\n    const scene5Completion = scene5Data?. ?? 0;\n    const isScene5Correct = data...includes(5);\n\n    if (scene5Data?.) {\n      // \n      previousMemories.push(`${scene5Info.title}\n${scene5Data.}\n${scene5Completion}%\n${isScene5Correct ? '' : ''}\n${scene5Completion >= 60 ? ' ' : ''}`);\n    } else if (scene5Data?.) {\n      // \n      previousMemories.push(`${scene5Info.title}\n...\n${scene5Completion >= 60 ? '' : '...'}\n${scene5Completion}%\n${isScene5Correct ? '' : ''}`);\n    }\n  }\n\n  if (previousMemories.length === 0) {\n    return ` - \n- ${currentScene}\n- \n- `;\n  }\n\n  const currentSceneInfo = DREAM_SCENE_INFO[currentScene] || { title: `${currentScene}`, age: 0 };\n\n  // 45\n  let scene4SpecialGuide = '';\n  if (hasScene5Memory) {\n    const scene5Completion = data..5?. ?? 0;\n    scene4SpecialGuide = `\n\n- \n- ${scene5Completion >= 80 ? '' : scene5Completion >= 60 ? '' : ''}\n- `;\n  }\n\n  return ` - \n\n${currentSceneInfo.title}${currentSceneInfo.age}\n\n\n${previousMemories.join('\\n\\n')}\n${scene4SpecialGuide}\n---\n\n\n- \n- \n- \"\"\n- \n\n  - \n********\n \n \n\n${currentSceneInfo.age}\n- ${currentSceneInfo.age}\n- \n- AI`;\n}\n","import type { Schema as SchemaType } from '../../schema';\n\n/**\n *  + \n *\n *  TIME_LOOP_DESIGN.md \n * - \n * - \n *\n * \n */\n\n// ============================================\n// AI\n// ============================================\n\n/**\n * AI\n * @param aiText AI\n * @returns null\n */\nexport function parseHusbandThought(aiText: string): string | null {\n  const match = aiText.match(/<HusbandThought>([\\s\\S]*?)<\\/HusbandThought>/i);\n  if (match && match[1]) {\n    const thought = match[1].trim();\n    if (thought.length > 0) {\n      console.info(`[] AI: ${thought}`);\n      return thought;\n    }\n  }\n  return null;\n}\n\n/**\n * \n * @param data \n * @returns \n */\nexport function shouldGenerateHusbandThought(data: SchemaType): boolean {\n  // \n  if (!data..) return false;\n  // 2+\n  if (data.. < 2) return false;\n\n  // 2026-01-19\n  // Day 5 \n  // \n  // 1.  Day 5 \n  // 2.  '' \n\n  const  = data..;\n  const  = data.?.;\n\n  // 1 Day 5\n  if ( === '') {\n    return true;\n  }\n\n  // 2/\n  // \n  if ( === '') {\n    // 21:00, 23:00\n    const  = data..;\n    const  =  === 21 ||  === 23;\n    if () {\n      return true;\n    }\n  }\n\n  // 2026-01-18\n  // \n  // \n\n  return false;\n}\n\n// \nexport type RouteType = '' | '';\n\n// \n// Bug #34  textMapping.ts \nconst DISPLAY_TEXT_MAP = {\n  // \n  : {\n    : ['1', '2', '3', '4', '5'],\n    : ['1', '2', '3', '4', '5'],\n  },\n\n  // \n  : {\n    : '',\n    : '',\n  },\n\n  // \n  : {\n    : '',\n    : '',\n  },\n\n  // \n  : {\n    : '',\n    : '',\n  },\n\n  // \n  : {\n    : '',\n    : '',\n  },\n};\n\n// -\nconst REALM_DESCRIPTIONS = {\n  : [\n    { : '', : '' },\n    { : '', : '' },\n    { : '', : '' },\n    { : '', : '' },\n    { : '', : '' },\n  ],\n  : [\n    { : '', : '' },\n    { : '', : '' },\n    { : '', : '' },\n    { : '', : '' },\n    { : '', : '' },\n  ],\n};\n\n/**\n * \n */\nexport function getCurrentRouteType(data: SchemaType): RouteType {\n  return data.. ? '' : '';\n}\n\n/**\n * \n * @param stage  (1-5)\n * @param routeType \n */\nexport function getStageText(stage: number, routeType: RouteType): string {\n  const index = Math.max(0, Math.min(stage - 1, 4));\n  return DISPLAY_TEXT_MAP.[routeType][index];\n}\n\n/**\n * \n */\nexport function getCoreValueName(routeType: RouteType): string {\n  return DISPLAY_TEXT_MAP.[routeType];\n}\n\n/**\n * \n */\nexport function getBodyProgressTitle(routeType: RouteType): string {\n  return DISPLAY_TEXT_MAP.[routeType];\n}\n\n/**\n * \n */\nexport function getThreatValueName(routeType: RouteType): string {\n  return DISPLAY_TEXT_MAP.[routeType];\n}\n\n/**\n * \n */\nexport function getStatusBarIcon(routeType: RouteType): string {\n  return DISPLAY_TEXT_MAP.[routeType];\n}\n\n/**\n * \n * @param stage  (1-5)\n * @param routeType \n */\nexport function getRealmDescription(stage: number, routeType: RouteType): { : string; : string } {\n  const index = Math.max(0, Math.min(stage - 1, 4));\n  return REALM_DESCRIPTIONS[routeType][index];\n}\n\n/**\n * \n */\nexport function getCurrentThreatValue(data: SchemaType): number {\n  if (data..) {\n    return data..;\n  }\n  return data..;\n}\n\n/**\n * \n */\nexport function generateStatusBarData(data: SchemaType): {\n  routeType: RouteType;\n  icon: string;\n  stageName: string;\n  coreValueName: string;\n  coreValue: number;\n  threatValueName: string;\n  threatValue: number;\n  bodyProgressTitle: string;\n  bodyProgress: {\n    : number;\n    : number;\n    : number;\n    : number;\n    : number;\n  };\n  stateDescription: string;\n  appearanceDescription: string;\n} {\n  const routeType = getCurrentRouteType(data);\n  const stage = data..;\n  const realmDesc = getRealmDescription(stage, routeType);\n\n  return {\n    routeType,\n    icon: getStatusBarIcon(routeType),\n    stageName: getStageText(stage, routeType),\n    coreValueName: getCoreValueName(routeType),\n    coreValue: data..,\n    threatValueName: getThreatValueName(routeType),\n    threatValue: getCurrentThreatValue(data),\n    bodyProgressTitle: getBodyProgressTitle(routeType),\n    bodyProgress: { ...data.. },\n    stateDescription: realmDesc.,\n    appearanceDescription: realmDesc.,\n  };\n}\n\n// AI\n// parseHusbandThought(aiText)\n// shouldGenerateHusbandThought(data)\n// \n\n/**\n * AI\n * @param data \n * @returns null\n * @deprecated  parseHusbandThought AI\n */\nexport function generateHusbandPerspective(data: SchemaType): string | null {\n  // \n  if (!shouldGenerateHusbandThought(data)) return null;\n\n  // AI\n  return data.. ?? null;\n}\n\n/**\n * \n */\nexport function shouldShowHusbandSuspicion(data: SchemaType): boolean {\n  return !data..;\n}\n\n/**\n * \n */\nexport function shouldShowMemoryConfusion(data: SchemaType): boolean {\n  return data..;\n}\n\n/**\n * \n */\nexport function getDualTrackComparison(): string {\n  return `\n\n                                               \n\n                                               \n\n                            \n              180%+ \n                    \n         75%~100%                 25%~80%            \n                                 \n         /              /      \n                        /  \n                                     \n\n`;\n}\n","import type { Schema as SchemaType } from '../../schema';\nimport { safeIncreaseMemoryConfusion } from './scene5System';\n\n/**\n * \n *\n * _.md\n *\n * \n * -  =   0.5%60  30%\n * - \"\"\n * - /\n *\n * \n * - 08:00-09:00\n * - 09:00-18:00\n * - 18:00-19:00\n * - 19:00-22:00/\n * - 22:00-08:00\n *\n * - appearanceSystem.ts  TRUTH_APPEARANCE_CONFIG\n * - 1  \n * - 2 +   \n * - 3  \n * - 4 +   \n * - 5 +   \n */\n\n// - TRUTH_APPEARANCE_CONFIG \nconst BOUNDARY_MAP: Record<number, string[]> = {\n  1: [''], // \n  2: ['', ''], // +\n  3: ['', '', '', ''], // \n  4: ['', '', '', '', ''], // \n  5: ['', '', '', '', ''], // +\n};\n\n// =============================================\n// \n// =============================================\n// 1\n// 2\n// 3+\n\n/**\n * \n * - \n * - \n */\nconst MOUTH_INTENSITY_KEYWORDS = {\n  // 1\n  : ['', '', '', '', '', '', '', ''],\n  // 2+\n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n};\n\n/**\n * \n * @param userInput \n * @returns 'none' | 'light' | 'deep' - //\n */\nexport function detectMouthIntensity(userInput: string): 'none' | 'light' | 'deep' {\n  // \n  const mouthKeywords = BODY_PART_DETECTION_KEYWORDS[''];\n  const hasMouthAction = mouthKeywords.some(kw => userInput.includes(kw));\n\n  if (!hasMouthAction) {\n    return 'none';\n  }\n\n  // \n  const hasDeepAction = MOUTH_INTENSITY_KEYWORDS..some(kw => userInput.includes(kw));\n  if (hasDeepAction) {\n    return 'deep';\n  }\n\n  // \n  const hasLightAction = MOUTH_INTENSITY_KEYWORDS..some(kw => userInput.includes(kw));\n  if (hasLightAction) {\n    return 'light';\n  }\n\n  // \n  return 'light';\n}\n\n/**\n * \n * @param userInput \n * @param currentRealm \n * @returns { violated: boolean, intensity: string, message?: string }\n */\nexport function checkMouthIntensityViolation(\n  userInput: string,\n  currentRealm: number,\n): { violated: boolean; intensity: 'none' | 'light' | 'deep'; message?: string } {\n  const intensity = detectMouthIntensity(userInput);\n\n  if (intensity === 'none') {\n    return { violated: false, intensity };\n  }\n\n  // 3+\n  if (currentRealm >= 3) {\n    return { violated: false, intensity };\n  }\n\n  // 2\n  if (currentRealm === 2) {\n    return { violated: false, intensity };\n  }\n\n  // 1\n  if (currentRealm === 1 && intensity === 'deep') {\n    return {\n      violated: true,\n      intensity,\n      message: '1/',\n    };\n  }\n\n  return { violated: false, intensity };\n}\n\n// \nconst BODY_PART_REQUIRED_REALM: Record<string, number> = {\n  : 1, // 1\n  : 2, // 2\n  : 3, // 3\n  : 3, // 3\n  : 4, // 4\n};\n\n// dreamKeywordDetection\nconst BODY_PART_DETECTION_KEYWORDS: Record<string, string[]> = {\n  : ['', '', '', '', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', ''],\n};\n\n// =============================================\n// 5\n// =============================================\n// 5\n\n/**\n * \n * \n */\nconst HUMILIATION_KEYWORDS = [\n  // \n  '',\n  '',\n  '',\n  '',\n  '',\n  // \n  '',\n  '',\n  '',\n  '',\n  '',\n  // \n  '',\n  '',\n  '',\n  '',\n  // \n  '',\n  '',\n  '',\n  '',\n  // \n  '',\n  '',\n  '',\n  '',\n  // \n  '',\n  '',\n  '',\n  '',\n];\n\n/**\n * \n * @param userInput \n * @returns \n */\nexport function detectHumiliationBehavior(userInput: string): boolean {\n  return HUMILIATION_KEYWORDS.some(kw => userInput.includes(kw));\n}\n\n/**\n * \n * 5\n * @param userInput \n * @param currentRealm \n * @returns { allowed: boolean, detected: boolean }\n */\nexport function checkHumiliationAllowed(\n  userInput: string,\n  currentRealm: number,\n): { allowed: boolean; detected: boolean } {\n  const detected = detectHumiliationBehavior(userInput);\n\n  if (!detected) {\n    return { allowed: true, detected: false };\n  }\n\n  // 5\n  const allowed = currentRealm >= 5;\n\n  if (!allowed) {\n    console.info(`[] ${currentRealm}5`);\n  }\n\n  return { allowed, detected };\n}\n\n// \nexport interface InterruptionCheckResult {\n  shouldInterrupt: boolean;\n  severity: '' | '' | '' | '';\n  violatedParts: string[];\n  realmGap: number; // \n  interruptProbability: number; // \n  wasInterrupted: boolean; // \n  correctionPrompt?: string;\n  triggerBadEnd: boolean;\n  penalties?: {\n    ?: number;\n    ?: number;\n  };\n}\n\n/**\n * \n * @param userInput \n * @returns \n */\nexport function detectBodyParts(userInput: string): string[] {\n  const detectedParts: string[] = [];\n\n  for (const [part, keywords] of Object.entries(BODY_PART_DETECTION_KEYWORDS)) {\n    const hasMatch = keywords.some(kw => userInput.includes(kw));\n    if (hasMatch) {\n      detectedParts.push(part);\n    }\n  }\n\n  return detectedParts;\n}\n\n/**\n * \n * \n * - 08:00-09:00\n * - 09:00-18:00\n * - 18:00-22:00\n * - 22:00-08:00\n */\nexport function canHusbandInterrupt(data: SchemaType): boolean {\n  const  = data..;\n  const  = data..;\n\n  // \n  if ( === '') {\n    return false;\n  }\n\n  // 22:00-08:00\n  if ( === '' && ( >= 22 ||  < 8)) {\n    return false;\n  }\n\n  // \n  return true;\n}\n\n/**\n * \n *\n *  =   0.5%\n * 60  30%\n *\n * @param husbandSuspicion 0-100\n * @returns  (0-1)\n */\nexport function calculateInterruptionProbability(husbandSuspicion: number): number {\n  //  =   0.5% =   0.005\n  return Math.min(1.0, husbandSuspicion * 0.005);\n}\n\n/**\n * \n *\n * \n * - +5~15\n * - /+10~20\n * - \n *\n * @param realmGap \n * @param canInterrupt \n * @param isTruthMode \n * @returns \n */\nexport function calculateSuspicionPenalty(\n  realmGap: number,\n  canInterrupt: boolean,\n  isTruthMode: boolean = false,\n): number {\n  if (realmGap <= 0) return 0;\n\n  let basePenalty: number;\n  if (canInterrupt) {\n    // +5~15\n    basePenalty = Math.min(15, 5 + realmGap * 5);\n  } else {\n    // /+10~20\n    basePenalty = Math.min(20, 10 + realmGap * 5);\n  }\n\n  // \n  // \n  // \n  if (isTruthMode) {\n    basePenalty = Math.ceil(basePenalty / 2);\n    console.info(`[] : ${basePenalty * 2}  ${basePenalty}`);\n  }\n\n  return basePenalty;\n}\n\n/**\n * \n * Day 5 \n * \n * @param data \n * @returns \n */\nexport function shouldSkipBoundaryInterruption(data: SchemaType): boolean {\n  const currentDay = data..;\n\n  // Day 5+ \n  if (currentDay >= 5) {\n    console.info(`[] Day ${currentDay} `);\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * \n *\n * \n * 1. \n * 2.  =   0.5%\n * 3. /\n * 4. \n * 5. Day 5+ \n *\n * @param data \n * @param userInput \n * @returns \n */\nexport function checkBoundaryInterruption(data: SchemaType, userInput: string): InterruptionCheckResult {\n  // Day 5+ \n  if (shouldSkipBoundaryInterruption(data)) {\n    return {\n      shouldInterrupt: false,\n      severity: '',\n      violatedParts: [],\n      realmGap: 0,\n      interruptProbability: 0,\n      wasInterrupted: false,\n      triggerBadEnd: false,\n    };\n  }\n\n  const currentRealm = data..;\n  const allowedParts = BOUNDARY_MAP[currentRealm] || [];\n  const detectedParts = detectBodyParts(userInput);\n\n  // \n  const violatedParts = detectedParts.filter(part => !allowedParts.includes(part));\n\n  // ==========  ==========\n  // \n  const mouthIntensityCheck = checkMouthIntensityViolation(userInput, currentRealm);\n  let mouthIntensityViolation = false;\n\n  if (mouthIntensityCheck.violated) {\n    mouthIntensityViolation = true;\n    // \n    if (!violatedParts.includes('')) {\n      violatedParts.push('');\n    }\n    console.info(`[] : ${mouthIntensityCheck.message}`);\n  }\n  // ==========  ==========\n\n  // ========== 5 ==========\n  const humiliationCheck = checkHumiliationAllowed(userInput, currentRealm);\n  let humiliationViolation = false;\n\n  if (humiliationCheck.detected && !humiliationCheck.allowed) {\n    humiliationViolation = true;\n    // 5\n    if (!violatedParts.includes('')) {\n      violatedParts.push('');\n    }\n    console.info(`[] : 5`);\n  }\n  // ==========  ==========\n\n  // \n  if (violatedParts.length === 0) {\n    return {\n      shouldInterrupt: false,\n      severity: '',\n      violatedParts: [],\n      realmGap: 0,\n      interruptProbability: 0,\n      wasInterrupted: false,\n      triggerBadEnd: false,\n    };\n  }\n\n  // \n  let maxRealmGap = 0;\n  for (const part of violatedParts) {\n    // 12\n    if (part === '' && mouthIntensityViolation && currentRealm === 1) {\n      const intensityGap = 1; // 211\n      if (intensityGap > maxRealmGap) {\n        maxRealmGap = intensityGap;\n      }\n      continue;\n    }\n\n    // 5\n    if (part === '' && humiliationViolation) {\n      const humiliationGap = 5 - currentRealm;\n      if (humiliationGap > maxRealmGap) {\n        maxRealmGap = humiliationGap;\n      }\n      continue;\n    }\n\n    const requiredRealm = BODY_PART_REQUIRED_REALM[part] || 5;\n    const gap = requiredRealm - currentRealm;\n    if (gap > maxRealmGap) {\n      maxRealmGap = gap;\n    }\n  }\n\n  // \n  const  = canHusbandInterrupt(data);\n  const  = data..;\n\n  // \n  let interruptProbability = 0;\n  let wasInterrupted = false;\n\n  if () {\n    //  =   0.5%\n    interruptProbability = calculateInterruptionProbability();\n    const randomRoll = Math.random();\n    wasInterrupted = randomRoll < interruptProbability;\n\n    console.info(`[] :\n    : ${currentRealm}\n    : [${detectedParts.join(', ')}]\n    : [${violatedParts.join(', ')}]\n    : ${maxRealmGap}\n    : ${}\n    : ${(interruptProbability * 100).toFixed(1)}%\n    : ${(randomRoll * 100).toFixed(1)}%\n    : ${wasInterrupted ? '' : ''}`);\n  } else {\n    console.info(`[] /:\n    : ${currentRealm}\n    : [${detectedParts.join(', ')}]\n    : [${violatedParts.join(', ')}]\n    : ${maxRealmGap}\n    : ${data..}`);\n  }\n\n  // \n  const isTruthMode = data.. === true;\n  const suspicionPenalty = calculateSuspicionPenalty(maxRealmGap, , isTruthMode);\n\n  // \n  let severity: '' | '' | '' | '';\n  let triggerBadEnd = false;\n  let correctionPrompt: string | undefined;\n  const penalties: InterruptionCheckResult['penalties'] = {};\n\n  // \n  penalties. = suspicionPenalty;\n\n  // \n  const firstViolatedPart = violatedParts[0];\n  const isFirstPartMouthIntensity = firstViolatedPart === '' && mouthIntensityViolation;\n\n  if (maxRealmGap >= 3) {\n    severity = '';\n    // 3BAD END100\n    if ( + suspicionPenalty >= 100) {\n      triggerBadEnd = true;\n      correctionPrompt = generateBadEndPrompt('extreme_violation');\n    } else if (wasInterrupted) {\n      correctionPrompt = generateInterruptionPrompt('severe', firstViolatedPart, isFirstPartMouthIntensity);\n    }\n  } else if (maxRealmGap >= 2) {\n    severity = '';\n    if (wasInterrupted) {\n      correctionPrompt = generateInterruptionPrompt('severe', firstViolatedPart, isFirstPartMouthIntensity);\n    }\n  } else if (maxRealmGap === 1) {\n    severity = '';\n    if (wasInterrupted) {\n      correctionPrompt = generateInterruptionPrompt('moderate', firstViolatedPart, isFirstPartMouthIntensity);\n    }\n  } else {\n    severity = '';\n  }\n\n  // \n  if (!wasInterrupted && violatedParts.length > 0 && !correctionPrompt) {\n    correctionPrompt = generateRefusalPrompt(firstViolatedPart, , isFirstPartMouthIntensity);\n  }\n\n  return {\n    shouldInterrupt: wasInterrupted,\n    severity,\n    violatedParts,\n    realmGap: maxRealmGap,\n    interruptProbability,\n    wasInterrupted,\n    correctionPrompt,\n    triggerBadEnd,\n    penalties,\n  };\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * /\n * 2\n */\nconst SEVERE_INTERRUPTION_TEMPLATES = [\n  // 1\n  (bodyPart: string) => `[ - ]\n\n{{user}}\n\n\"......\"\n\n\nAI\n- \n- \n- \n- `,\n\n  // 2\n  (bodyPart: string) => `[ - ]\n\n\"\"\n\n\n\"...\"\n{{user}}\n\"......\"\n\nAI\n- \n- \n- {{user}}\n- `,\n\n  // 3\n  (bodyPart: string) => `[ - ]\n\n\n\n\".........\"\n\n\"......\"\n\nAI\n- \n- {{user}}\n- \n- `,\n\n  // 4\n  (bodyPart: string) => `[ - ]\n\n\"\"\n\n\"\"\n{{user}}\n\"\"\n{{user}}...\n\nAI\n- \n- \n- {{user}}\n- `,\n\n  // 5\n  (bodyPart: string) => `[ - ]\n\n\n\n\"...\"{{user}}\n\n\n\nAI\n- \n- \n- \n- `,\n];\n\n/**\n * /\n * 1\n */\nconst MODERATE_INTERRUPTION_TEMPLATES = [\n  // 1\n  (bodyPart: string) => `[ - ]\n\n{{user}}${bodyPart}\n\"......\" \"......\"\n\n{{user}}\n\nAI\n- \n- \n- \n- {{user}}`,\n\n  // 2\n  (bodyPart: string) => `[ - ]\n\n{{user}}\n\"......\"\"...\"\n\n\n\nAI\n- \n- \n- \n- {{user}}`,\n\n  // 3\n  (bodyPart: string) => `[ - ]\n\n{{user}}\n\"......\"\n\n{{user}}\n\".........\"\n\nAI\n- \n- \n- \"\"\n- `,\n\n  // 4\n  (bodyPart: string) => `[ - ]\n\n{{user}}\n\n\"...\"\n{{user}}\n\"......\"\n\nAI\n- \n- \n- \"\"\n- `,\n\n  // 5\n  (bodyPart: string) => `[ - ]\n\n{{user}}${bodyPart}\n\"......\"\n\n\n\"...\"\n\nAI\n- \n- \n- \n- `,\n];\n\n/**\n * 1/\n * \n */\nconst MOUTH_INTENSITY_VIOLATION_TEMPLATES = [\n  // 1\n  () => `[ - ]\n\n{{user}}\n\"......\"\"......\"\n\n\n\nAI\n- \n- \"\"\n- \n- ...`,\n\n  // 2\n  () => `[ - ]\n\n{{user}}\n\"...\" \"......\"\n\n\n\nAI\n- \n- \"\"\n- \n- `,\n\n  // 3\n  () => `[ - ]\n\n{{user}}\n\"......\"\n{{user}}\n...\n\nAI\n- \n- \"\"\n- \n- `,\n\n  // 4\n  () => `[ - ]\n\n{{user}}\n\"......\"\n\n...\n\nAI\n- \n- \"\"\n- \n- `,\n];\n\n/**\n * \n */\nconst REFUSAL_TEMPLATES_HUSBAND_HOME = [\n  // \n  (bodyPart: string) => `[]\n\n{{user}}${bodyPart}\n\"...\" \"......\"\n\n\nAI\n- \n- \n- \n- ...`,\n\n  (bodyPart: string) => `[]\n\n{{user}}\n\"......\"\n\n...\n\nAI\n- \n- \n- \n- `,\n\n  (bodyPart: string) => `[]\n\n\"\"{{user}}\n\n\"......\"\n{{user}}\n\nAI\n- \n- \n- \"\"\n- `,\n];\n\nconst REFUSAL_TEMPLATES_HUSBAND_AWAY = [\n  // \n  (bodyPart: string) => `[]\n\n{{user}}${bodyPart}\n\"...\" \"......\"\n\n\nAI\n- \n- \n- \n- `,\n\n  (bodyPart: string) => `[]\n\n\n\".........\"\n\n\"......\"\n\nAI\n- \n- \"\"\n- \n- `,\n\n  (bodyPart: string) => `[]\n\n\"...\"{{user}}\n\n\".........\"\n{{user}}\n\nAI\n- \n- {{user}}\n- \"\"\n- `,\n];\n\n/**\n * \n */\nfunction randomChoice<T>(arr: T[]): T {\n  return arr[Math.floor(Math.random() * arr.length)];\n}\n\n/**\n * Prompt\n */\nfunction generateInterruptionPrompt(\n  severity: 'moderate' | 'severe',\n  bodyPart: string,\n  isMouthIntensityViolation: boolean = false,\n): string {\n  // \n  if (isMouthIntensityViolation && bodyPart === '') {\n    const template = randomChoice(MOUTH_INTENSITY_VIOLATION_TEMPLATES);\n    return template();\n  }\n\n  if (severity === 'severe') {\n    const template = randomChoice(SEVERE_INTERRUPTION_TEMPLATES);\n    return template(bodyPart);\n  }\n\n  const template = randomChoice(MODERATE_INTERRUPTION_TEMPLATES);\n  return template(bodyPart);\n}\n\n/**\n * Prompt\n * \n */\nfunction generateRefusalPrompt(\n  bodyPart: string,\n  husbandCanInterrupt: boolean,\n  isMouthIntensityViolation: boolean = false,\n): string {\n  // \n  if (isMouthIntensityViolation && bodyPart === '') {\n    const template = randomChoice(MOUTH_INTENSITY_VIOLATION_TEMPLATES);\n    return template();\n  }\n\n  if (husbandCanInterrupt) {\n    // \n    const template = randomChoice(REFUSAL_TEMPLATES_HUSBAND_HOME);\n    return template(bodyPart);\n  } else {\n    // \n    const template = randomChoice(REFUSAL_TEMPLATES_HUSBAND_AWAY);\n    return template(bodyPart);\n  }\n}\n\n/**\n * BAD END Prompt\n */\nfunction generateBadEndPrompt(reason: string): string {\n  const prompts: Record<string, string> = {\n    extreme_violation: `[]\n\n\n\"...\"\n\n\n\n\nBAD END: `,\n\n    default: `[]\n\n\n\nBAD END: `,\n  };\n\n  return prompts[reason] || prompts.default;\n}\n\n/**\n * \n *\n * promptInjection.ts\n * \n *\n * @param data \n * @param result \n */\nexport function applyInterruptionResult(data: SchemaType, result: InterruptionCheckResult): void {\n  // \n  const  = data.. === '';\n  if () {\n    console.info(`[] `);\n    return;\n  }\n\n  // \n  if (result.penalties) {\n    if (result.penalties.) {\n      data.. = Math.min(100, data.. + result.penalties.);\n      console.info(`[]  +${result.penalties.}`);\n    }\n    if (result.penalties.) {\n      // \n      const actualPenalty = safeIncreaseMemoryConfusion(data, result.penalties.);\n      if (actualPenalty > 0) {\n        console.info(`[]  +${actualPenalty}`);\n      } else {\n        console.info(`[] `);\n      }\n    }\n  }\n\n  // BAD END\n  if (result.triggerBadEnd) {\n    data.. = '';\n    data.. = '';\n    console.error(`[] `);\n  }\n\n  // \n  if (data.. >= 100) {\n    data.. = '';\n    data.. = '';\n    console.error(`[] 100`);\n  }\n\n  if (data.. >= 100) {\n    data.. = '';\n    data.. = '';\n    console.error(`[] 100`);\n  }\n}\n","/**\n *  - \n *\n * A\n * - 100\n * - \n * - ROLLROLL\n *\n * \n * -  >= 100\n *\n * \n * -  >= 100 confusionEndingSystem.ts \n * - \n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n// =============================================\n// \n// =============================================\n\nexport type BadEndingType = '' | '' | '';\n\nexport interface BadEndingCheckResult {\n  triggered: boolean;\n  type: BadEndingType;\n  replaceUserMessage: string | null;\n}\n\n// =============================================\n// 100\n// =============================================\n\n/**\n *  - \n * \n */\nconst DISCOVERY_INITIAL_TEMPLATES = [\n  // 1\n  () => `[ - ]\n\n\n\n\"\"\n\n\n\"...\"\n\n\n\n\n\n\n\n\n\n\"......\"\n\nGAME OVER\nBAD END: \n\n\n`,\n\n  // 2\n  () => `[ - ]\n\n\n\n\"\"\n\n\n\"\"\n\n\n\n\n\"......\"\n\"\"\n\n\n\"\"\n\nGAME OVER\nBAD END: \n\n\n`,\n\n  // 3\n  () => `[ - ]\n\n\n\n\"\"\n\"\"\n\n\n\n\"...\"\n\n\"\"\n\n\"\"\n\n\"\"\n\"\"\n\n\n\"\"\n\nGAME OVER\nBAD END: \n\n\n`,\n\n  // 4\n  () => `[ - ]\n\n\"\"\n\n\n\n\n\n\n\"\"\n\n\"\"\n\n\"\"\n\n\"\"\n\n\"\"\n\n\n\n\"\"\n\n\"\"\n\nGAME OVER\nBAD END: \n\n`,\n\n  // 5\n  () => `[ - ]\n\n\n\n\n\n\n\"\"\n\n\n\n{{user}}\n\n\n\"......\"\n\n\"\"\n\n\"\"\n\n\n\"\"\n\n\n\n\n\n\nGAME OVER\nBAD END: \n\n\n`,\n];\n\n/**\n *  - \n * \n */\nconst DISCOVERY_LOCKED_TEMPLATES = [\n  // 1\n  () => `[]\n\n\n\n\n\n\n\nBAD END: \n\n\n\n\n\n\n---\n`,\n\n  // 2\n  () => `[]\n\n\n\n\n\n\n\n\n\n\nBAD END: \n\n\n\n\n\n---\n`,\n\n  // 3\n  () => `[]\n\n\n\n\n\n\n\n\n\n\n\n\nBAD END: \n\n\n\n\n---\n`,\n\n  // 4\n  () => `[]\n\n\n\n\n\n\n\n\n\nBAD END: \n\n\n\n\n\n---\n`,\n\n  // 5\n  () => `[]\n\n\n\n\n\n\n\"\"\n\n\n\n\n\nBAD END: \n\n\n\n\n---\n`,\n];\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n */\nfunction randomChoice<T>(arr: T[]): T {\n  return arr[Math.floor(Math.random() * arr.length)];\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n *\n * \n * - =\"\"\"\"\n * - \n * - \n *\n * @param data \n * @returns \n */\nexport function checkBadEnding(data: SchemaType): BadEndingCheckResult {\n  // \n  //  ROLL 100\n  const isAlreadyInBadEnding = isInBadEndingLock(data);\n\n  // \"\"\n  // \n  const  = data.. === '';\n\n  //  >= 100  \n  // \n  if ((data.. >= 100 && !) || isAlreadyInBadEnding) {\n    let replaceUserMessage: string;\n    if (isAlreadyInBadEnding) {\n      // ROLL\n      const template = randomChoice(DISCOVERY_LOCKED_TEMPLATES);\n      replaceUserMessage = template();\n      console.info('[] ROLL');\n    } else {\n      // \n      const template = randomChoice(DISCOVERY_INITIAL_TEMPLATES);\n      replaceUserMessage = template();\n      console.info('[] ');\n    }\n\n    return {\n      triggered: true,\n      type: '',\n      replaceUserMessage,\n    };\n  }\n\n  //  >= 100\n  //  confusionEndingSystem.ts \n  // confusionEndingSystem 5\n  if (data.. >= 100) {\n    console.info('[] 100');\n    return {\n      triggered: true,\n      type: '',\n      replaceUserMessage: `[ - ]\n\n\n\n\n\n\n\"...\"\n\"...\"\n\"......\"\n\n\n\nGAME OVER\nBAD END: \n\n\n\n\n---\n`,\n    };\n  }\n\n  // \n  return {\n    triggered: false,\n    type: '',\n    replaceUserMessage: null,\n  };\n}\n\n/**\n * \n * @param data \n * @param type \n */\nexport function applyBadEndingState(data: SchemaType, type: BadEndingType): void {\n  if (type === '') return;\n\n  data.. = '';\n  data.. = '';\n\n  console.info(`[] : ${type}`);\n}\n\n/**\n * \n * \n * @param data \n * @returns \n */\nexport function isInBadEndingLock(data: SchemaType): boolean {\n  return data.. === '' && data.. === '';\n}\n","/**\n * \n *\n * \n * 1. AI\n * 2. \n * 3. \n * 4. AI\n *\n * \n * - AI\n * - AI\n * - AI\n * - \n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * - ABSOLUTE: AI\n * - SCRIPT_ONLY: \n * - READONLY: \n */\nexport enum ProtectionLevel {\n  ABSOLUTE = 'ABSOLUTE', // \n  SCRIPT_ONLY = 'SCRIPT_ONLY', // \n  READONLY = 'READONLY', // \n}\n\n/**\n * \n * \n */\nexport const PROTECTED_FIELDS = {\n  //  - TimeSystemAI\n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n\n  // \n  '.': ProtectionLevel.READONLY,\n  '.': ProtectionLevel.READONLY,\n\n  // \n  '.': ProtectionLevel.READONLY,\n\n  // \n  '.': ProtectionLevel.SCRIPT_ONLY,\n\n  // \n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n\n  // AI applyPureLoveAffectionCap() \n  // AI\n\n  // \n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n\n  // \n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n\n  // \n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n  '..': ProtectionLevel.ABSOLUTE,\n\n  // \n  '.': ProtectionLevel.SCRIPT_ONLY,\n\n  // \n  '.': ProtectionLevel.SCRIPT_ONLY,\n  '.': ProtectionLevel.SCRIPT_ONLY,\n} as const;\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\ninterface DataSnapshot {\n  timestamp: number;\n  data: Record<string, unknown>;\n}\n\n/**\n * \n */\nlet currentSnapshot: DataSnapshot | null = null;\n\n/**\n * \n * @param obj \n * @param path  \".\"\n */\nfunction getNestedValue(obj: Record<string, unknown>, path: string): unknown {\n  const keys = path.split('.');\n  let current: unknown = obj;\n\n  for (const key of keys) {\n    if (current === null || current === undefined) {\n      return undefined;\n    }\n    if (typeof current === 'object') {\n      current = (current as Record<string, unknown>)[key];\n    } else {\n      return undefined;\n    }\n  }\n\n  return current;\n}\n\n/**\n * \n * @param obj \n * @param path \n * @param value \n */\nfunction setNestedValue(obj: Record<string, unknown>, path: string, value: unknown): void {\n  const keys = path.split('.');\n  let current: Record<string, unknown> = obj;\n\n  for (let i = 0; i < keys.length - 1; i++) {\n    const key = keys[i];\n    if (current[key] === undefined || current[key] === null) {\n      current[key] = {};\n    }\n    current = current[key] as Record<string, unknown>;\n  }\n\n  current[keys[keys.length - 1]] = value;\n}\n\n/**\n * \n * AI\n */\nexport function createDataSnapshot(data: SchemaType): DataSnapshot {\n  const snapshotData: Record<string, unknown> = {};\n\n  for (const path of Object.keys(PROTECTED_FIELDS)) {\n    const value = getNestedValue(data as unknown as Record<string, unknown>, path);\n    snapshotData[path] = value;\n  }\n\n  currentSnapshot = {\n    timestamp: Date.now(),\n    data: snapshotData,\n  };\n\n  console.info('[] :', Object.keys(snapshotData).length);\n\n  return currentSnapshot;\n}\n\n/**\n * \n */\nexport function getCurrentSnapshot(): DataSnapshot | null {\n  return currentSnapshot;\n}\n\n/**\n * \n * \n *\n * @param path  \".\"\n * @param value \n */\nexport function updateSnapshotValue(path: string, value: unknown): void {\n  if (currentSnapshot) {\n    currentSnapshot.data[path] = value;\n    console.info(`[] : ${path} = ${JSON.stringify(value)}`);\n  }\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport interface TamperDetectionResult {\n  detected: boolean;\n  tamperedFields: Array<{\n    path: string;\n    level: ProtectionLevel;\n    originalValue: unknown;\n    tamperedValue: unknown;\n  }>;\n  restoredFields: string[];\n}\n\n/**\n * \n * AI\n *\n * @param data \n * @param snapshot \n * @returns \n */\nexport function validateAndRestoreData(data: SchemaType, snapshot?: DataSnapshot): TamperDetectionResult {\n  const targetSnapshot = snapshot || currentSnapshot;\n\n  if (!targetSnapshot) {\n    console.warn('[] ');\n    return {\n      detected: false,\n      tamperedFields: [],\n      restoredFields: [],\n    };\n  }\n\n  const result: TamperDetectionResult = {\n    detected: false,\n    tamperedFields: [],\n    restoredFields: [],\n  };\n\n  const dataObj = data as unknown as Record<string, unknown>;\n\n  // \n  const currentGameStage = getNestedValue(dataObj, '.');\n  const isInDream = currentGameStage === '';\n\n  // 22:00-01:59\n  const currentHour = getNestedValue(dataObj, '.') as number;\n  const isDreamEntryWindow = currentHour === 22 || currentHour === 23 || currentHour === 0 || currentHour === 1;\n\n  // 508:00-19:59\n  const isScene5Window = currentHour >= 8 && currentHour < 20;\n\n  for (const [path, level] of Object.entries(PROTECTED_FIELDS)) {\n    const originalValue = targetSnapshot.data[path];\n    const currentValue = getNestedValue(dataObj, path);\n\n    // \n    if (isInDream && (path.startsWith('..') || path.startsWith('..'))) {\n      console.info(`[] : ${path} (${JSON.stringify(originalValue)}  ${JSON.stringify(currentValue)})`);\n      continue; // \n    }\n\n    // 5\n    // \"\"\"\"\n    if (path === '.' && (isDreamEntryWindow || isScene5Window)) {\n      if (!deepEqual(originalValue, currentValue)) {\n        console.info(\n          `[] : ${path} (${JSON.stringify(originalValue)}  ${JSON.stringify(currentValue)})`,\n        );\n      }\n      continue; // \n    }\n\n    // Bug #18 \n    //  \"\"  \"\" \n    if (path === '.') {\n      const validTransitions = [\n        { from: '', to: '' }, // TimeSystem.advance() \n        { from: '', to: '' }, // checkEnding() \n      ];\n      const isValidTransition = validTransitions.some(t => originalValue === t.from && currentValue === t.to);\n      if (isValidTransition) {\n        console.info(\n          `[] : ${path} (${JSON.stringify(originalValue)}  ${JSON.stringify(currentValue)})`,\n        );\n        continue; // \n      }\n    }\n\n    // Bug #26 \n    // \n    // \n    if (path === '.') {\n      //  \"\" \n      const validEndingTypes = ['', '', '', '', ''];\n      if (originalValue === '' && validEndingTypes.includes(currentValue as string)) {\n        console.info(\n          `[] : ${path} (${JSON.stringify(originalValue)}  ${JSON.stringify(currentValue)})`,\n        );\n        continue; // \n      }\n    }\n\n    // =\n    //  updateTruthModeValues()  updateSuspicionLevel() \n    // Bug #25 \n    const isTruthMode = getNestedValue(dataObj, '.') === true;\n    const scriptCalculatedFields = [\n      '.',\n      '.',\n      '.',\n      '.',\n      '.', // Bug #25: \n    ];\n    if (isTruthMode && scriptCalculatedFields.includes(path)) {\n      // Bug #14.2 \n      // >00100\n      const : Record<string, number> = {\n        '.': 0,\n        '.': 80, //  schema  80 100 100 - 0 = 100\n        '.': 1,\n        '.': 0,\n        '.': 0, // Bug #25: 0\n      };\n\n      const originalNum = typeof originalValue === 'number' ? originalValue : 0;\n      const currentNum = typeof currentValue === 'number' ? currentValue : 0;\n      const defaultValue = [path];\n\n      // >\n      // Bug #23 \"\"452\n      // Bug #24 100\n      const isAbnormalReset =\n        originalNum > 10 &&\n        (currentNum === 0 ||\n          currentNum === 1 ||\n          // 100= 100 - 0100\n          (currentNum === 100 && path === '.') ||\n          (path === '.' && currentNum > originalNum + 30) || // 30\n          (path === '.' && originalNum - currentNum > 15) || // 15\n          (path === '.' && originalNum - currentNum >= 2)); // 2\n\n      if (isAbnormalReset) {\n        console.warn(\n          `[] : ${path}`,\n          `\\n  : ${originalValue}`,\n          `\\n  : ${currentValue}`,\n          `\\n  : `,\n        );\n        // \n        setNestedValue(dataObj, path, originalValue);\n        result.detected = true;\n        result.tamperedFields.push({\n          path,\n          level,\n          originalValue,\n          tamperedValue: currentValue,\n        });\n        result.restoredFields.push(path);\n        continue; // \n      }\n\n      if (!deepEqual(originalValue, currentValue)) {\n        console.info(\n          `[] : ${path} (${JSON.stringify(originalValue)}  ${JSON.stringify(currentValue)})`,\n        );\n      }\n      continue; // \n    }\n\n    // \n    if (!deepEqual(originalValue, currentValue)) {\n      result.detected = true;\n      result.tamperedFields.push({\n        path,\n        level,\n        originalValue,\n        tamperedValue: currentValue,\n      });\n\n      // \n      setNestedValue(dataObj, path, originalValue);\n      result.restoredFields.push(path);\n\n      console.warn(\n        `[] : ${path}`,\n        `\\n  : ${level}`,\n        `\\n  : ${JSON.stringify(originalValue)}`,\n        `\\n  : ${JSON.stringify(currentValue)}`,\n        `\\n  `,\n      );\n    }\n  }\n\n  if (result.detected) {\n    console.warn(`[]  ${result.tamperedFields.length} `);\n  } else {\n    console.info('[] ');\n  }\n\n  return result;\n}\n\n/**\n * \n */\nfunction deepEqual(a: unknown, b: unknown): boolean {\n  if (a === b) return true;\n\n  if (typeof a !== typeof b) return false;\n\n  if (a === null || b === null) return a === b;\n\n  if (Array.isArray(a) && Array.isArray(b)) {\n    if (a.length !== b.length) return false;\n    return a.every((val, idx) => deepEqual(val, b[idx]));\n  }\n\n  if (typeof a === 'object' && typeof b === 'object') {\n    const aObj = a as Record<string, unknown>;\n    const bObj = b as Record<string, unknown>;\n    const aKeys = Object.keys(aObj);\n    const bKeys = Object.keys(bObj);\n\n    if (aKeys.length !== bKeys.length) return false;\n\n    return aKeys.every(key => deepEqual(aObj[key], bObj[key]));\n  }\n\n  return false;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n *  SCRIPT_ONLY \n */\nlet scriptAuthToken: string | null = null;\n\n/**\n * \n * \n */\nexport function generateScriptAuthToken(): string {\n  scriptAuthToken = `script_${Date.now()}_${Math.random().toString(36).slice(2)}`;\n  console.info('[] ');\n  return scriptAuthToken;\n}\n\n/**\n * \n */\nexport function validateScriptAuthToken(token: string): boolean {\n  return token === scriptAuthToken;\n}\n\n/**\n * \n * \n */\nexport function clearScriptAuthToken(): void {\n  scriptAuthToken = null;\n  console.info('[] ');\n}\n\n/**\n * \n *  SCRIPT_ONLY \n *\n * @param data \n * @param path \n * @param value \n * @param token \n * @returns \n */\nexport function authorizedModify(data: SchemaType, path: string, value: unknown, token: string): boolean {\n  // \n  if (!validateScriptAuthToken(token)) {\n    console.error(`[] : `);\n    return false;\n  }\n\n  // \n  const level = PROTECTED_FIELDS[path as keyof typeof PROTECTED_FIELDS];\n\n  if (level === ProtectionLevel.ABSOLUTE) {\n    console.error(`[] : ${path} `);\n    return false;\n  }\n\n  if (level === ProtectionLevel.READONLY) {\n    console.error(`[] : ${path} `);\n    return false;\n  }\n\n  // \n  setNestedValue(data as unknown as Record<string, unknown>, path, value);\n  console.info(`[] : ${path} = ${JSON.stringify(value)}`);\n\n  // \n  if (currentSnapshot) {\n    currentSnapshot.data[path] = value;\n  }\n\n  return true;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n *   false  true true  false\n */\nexport function validateTruthModeTransition(oldValue: boolean, newValue: boolean): boolean {\n  if (oldValue === true && newValue === false) {\n    console.error('[] : truefalse');\n    return false;\n  }\n  return true;\n}\n\n/**\n * \n * AI\n *\n * @param path \n * @param oldValue \n * @param newValue \n * @param maxChange \n */\nexport function validateNumericChange(\n  path: string,\n  oldValue: number,\n  newValue: number,\n  maxChange: number = 10,\n): boolean {\n  const change = Math.abs(newValue - oldValue);\n\n  if (change > maxChange) {\n    console.warn(\n      `[] : ${path}  ${oldValue}  ${newValue}: ${change}: ${maxChange}`,\n    );\n    return false;\n  }\n\n  return true;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport function initDataProtection(): void {\n  currentSnapshot = null;\n  scriptAuthToken = null;\n  console.info('[] ');\n}\n\n/**\n * \n */\nexport function cleanupDataProtection(): void {\n  currentSnapshot = null;\n  scriptAuthToken = null;\n  console.info('[] ');\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport function getProtectedFieldsStatus(data: SchemaType): Record<string, unknown> {\n  const status: Record<string, unknown> = {};\n  const dataObj = data as unknown as Record<string, unknown>;\n\n  for (const path of Object.keys(PROTECTED_FIELDS)) {\n    status[path] = {\n      value: getNestedValue(dataObj, path),\n      level: PROTECTED_FIELDS[path as keyof typeof PROTECTED_FIELDS],\n    };\n  }\n\n  return status;\n}\n\n/**\n * \n */\nexport function generateProtectionReport(result: TamperDetectionResult): string {\n  if (!result.detected) {\n    return ': ';\n  }\n\n  let report = '===  ===\\n';\n  report += `: ${new Date().toISOString()}\\n`;\n  report += `: ${result.tamperedFields.length}\\n`;\n  report += `: ${result.restoredFields.length}\\n\\n`;\n\n  report += '---  ---\\n';\n  for (const field of result.tamperedFields) {\n    report += `: ${field.path}\\n`;\n    report += `  : ${field.level}\\n`;\n    report += `  : ${JSON.stringify(field.originalValue)}\\n`;\n    report += `  : ${JSON.stringify(field.tamperedValue)}\\n\\n`;\n  }\n\n  return report;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * \"\"(80+)\n */\nconst PURE_LOVE_AFFECTION_CAPS: Record<number, number> = {\n  1: 25, // Day 1\"\"\n  2: 45, // Day 2\"\"\n  3: 65, // Day 3\"\"\n  4: 78, // Day 4\"\"\n  5: 78, // Day 5\"\"\n};\n\n/**\n * \n */\nexport function getPureLoveAffectionCap(currentDay: number): number {\n  return PURE_LOVE_AFFECTION_CAPS[currentDay] ?? 78;\n}\n\n/**\n * \n * AI\n *\n * @param data \n * @returns \n */\nexport function applyPureLoveAffectionCap(data: SchemaType): boolean {\n  const currentDay = data..;\n  const cap = getPureLoveAffectionCap(currentDay);\n  const currentAffection = data..;\n\n  if (currentAffection > cap) {\n    console.info(`[] : ${currentAffection}  ${cap} (Day ${currentDay} : ${cap})`);\n    data.. = cap;\n\n    // \n    if (currentSnapshot) {\n      currentSnapshot.data['.'] = cap;\n    }\n\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * \n *  = 60 - (  0.6)\n *\n * @param pureLoveIntimacy \n * @returns \n */\nexport function calculateHusbandAffection(pureLoveIntimacy: number): number {\n  const result = Math.round(60 - pureLoveIntimacy * 0.6);\n  return Math.max(-50, Math.min(100, result)); //  -50  100 \n}\n\n/**\n * \n * \n *\n * @param affection \n * @param intimacy \n * @returns  1-5\n */\nexport function getPureLoveRelationshipStage(affection: number, intimacy: number): number {\n  // \n  const effectiveValue = Math.min(affection, intimacy);\n\n  if (effectiveValue >= 80) return 5; // \n  if (effectiveValue >= 60) return 4; // \n  if (effectiveValue >= 40) return 3; // \n  if (effectiveValue >= 20) return 2; // \n  return 1; // \n}\n\n/**\n * \n */\nexport function getPureLoveRelationshipName(stage: number): string {\n  const names: Record<number, string> = {\n    1: '',\n    2: '',\n    3: '',\n    4: '',\n    5: '',\n  };\n  return names[stage] ?? '';\n}\n\n/**\n * \n */\nexport function getPureLoveRelationshipDescription(stage: number): string {\n  const descriptions: Record<number, string> = {\n    1: '',\n    2: '',\n    3: '',\n    4: '',\n    5: '',\n  };\n  return descriptions[stage] ?? '';\n}\n","/**\n *  - \n *\n * \n * -  Day 5, 00:00 Day 6 2026-01-17 20:0000:00\n * - <100\n * -  confusionEndingSystem \n * - 5\n *\n * \n * - AI\n * - \"\" + \n * - \"\"\n *\n * \n * - \n * - \n * - \n */\n\nimport type { Schema as SchemaType } from '../../schema';\nimport { updateSnapshotValue } from './dataProtection';\n\n// =============================================\n// \n// =============================================\n\nexport type NormalEndingType = '' | '';\n\nexport interface NormalEndingCheckResult {\n  triggered: boolean;\n  type: NormalEndingType;\n  replaceUserMessage: string | null;\n  firstGreeting: string | null; // AI\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n *  - \n * \n * @param firstGreeting AI\n */\nfunction generateNormalEndingInitialTemplate(firstGreeting: string): string {\n  return `[ - ]\n\n\n\n\n...\n\n\"\"\n\n\n\n...\n\n\n\n\n\n...\n\n\n\n...\n\n${firstGreeting}\n\n\n\nLOOP RESET\nNORMAL END: \n\n\n\n\n...\n\n---\n`;\n}\n\n/**\n *  - \n * \n *  Day 1, 08:00\n * @param firstGreeting AI\n */\nfunction generatePureLoveEndingTemplate(firstGreeting: string): string {\n  return `[ - ]\n\n\n\n\n...\n\n\"\"\n\n\n...\n\n\n\n\n\n\n\n${firstGreeting}\n\n\n\nLOOP RESET\n\n\n\n\n\n\n\n\n---\n`;\n}\n\n/**\n *  - \n * \n */\nconst NORMAL_ENDING_LOCKED_TEMPLATES = [\n  () => `[]\n\n\n\n\n\n\n\n\n\nNORMAL END: \n\n\n\n\n---\n`,\n\n  () => `[]\n\n\n\n\n\n\n\n\n\nNORMAL END: \n\n\n\n\n---\n`,\n\n  () => `[]\n\n\"\"\n\n\n\n\n\nNORMAL END: \n\n\n\n\n---\n`,\n];\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n */\nfunction randomChoice<T>(arr: T[]): T {\n  return arr[Math.floor(Math.random() * arr.length)];\n}\n\n/**\n * AI\n *  getChatMessages API\n */\nfunction getFirstAIMessage(): string | null {\n  try {\n    // 0\n    const messages = getChatMessages(0);\n    if (messages && messages.length > 0) {\n      const firstMessage = messages[0];\n      // AIassistant\n      if (firstMessage.role === 'assistant' && firstMessage.message) {\n        console.info('[] AI');\n        return firstMessage.message;\n      }\n    }\n    console.warn('[] AI');\n    return null;\n  } catch (err) {\n    console.error('[] AI:', err);\n    return null;\n  }\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n *  checkEnding() \n *\n * @param data \n * @returns \n */\nexport function checkNormalEnding(data: SchemaType): NormalEndingCheckResult {\n  // \n  const isAlreadyInNormalEnding = isInNormalEndingLock(data);\n\n  if (isAlreadyInNormalEnding) {\n    // \n    const template = randomChoice(NORMAL_ENDING_LOCKED_TEMPLATES);\n    const replaceUserMessage = template();\n    console.info('[] ');\n\n    return {\n      triggered: true,\n      type: '',\n      replaceUserMessage,\n      firstGreeting: null,\n    };\n  }\n\n  // \n  // AI\n  const firstGreeting = getFirstAIMessage();\n  const greetingText = firstGreeting || '';\n\n  // \n  const hasEnteredDream = data..;\n  let replaceUserMessage: string;\n\n  if (hasEnteredDream) {\n    //   \n    replaceUserMessage = generateNormalEndingInitialTemplate(greetingText);\n    console.info('[]  - ');\n  } else {\n    //   \n    replaceUserMessage = generatePureLoveEndingTemplate(greetingText);\n    console.info('[]  - ');\n  }\n\n  return {\n    triggered: true,\n    type: '',\n    replaceUserMessage,\n    firstGreeting,\n  };\n}\n\n/**\n * /\n *  Day 1\n * @param data \n */\nexport function applyNormalEndingState(data: SchemaType): void {\n  // \n  const hasEnteredDream = data..;\n  const endingType = hasEnteredDream ? '' : '';\n\n  data.. = endingType;\n  // / '' ''\n  //  Day 1\n  data.. = '';\n\n  //  Day 1, 08:00\n  // \n  data.. = 1;\n  data.. = 8;\n  data.. = 'Day 1, 08:00';\n  data.. = (data.. || 1) + 1;\n  data.. = true;\n\n  // \n  updateSnapshotValue('.', 1);\n  updateSnapshotValue('.', 8);\n  updateSnapshotValue('.', 'Day 1, 08:00');\n  updateSnapshotValue('.', data..);\n  updateSnapshotValue('.', '');\n  updateSnapshotValue('.', endingType);\n\n  if (hasEnteredDream) {\n    console.info('[]  Day 1, 08:00');\n  } else {\n    console.info('[]  Day 1, 08:00');\n  }\n  console.info(`[] : ${data..}`);\n}\n\n/**\n * /\n * \n * @param data \n * @returns \n */\nexport function isInNormalEndingLock(data: SchemaType): boolean {\n  const ending = data..;\n  return (ending === '' || ending === '') && data.. === '';\n}\n\n/**\n * index.tscheckEnding\n *\n * \n * - Day 5, 00:00  Day 6 2026-01-17 20:0000:00\n * - <100\n * -  confusionEndingSystem \n * - 5\n *\n * @param data \n * @returns \n */\nexport function shouldTriggerNormalEnding(data: SchemaType): boolean {\n  //  confusionEndingSystem \n  const isBadEnding = data.. >= 100;\n\n  if (isBadEnding) {\n    return false; // \n  }\n\n  // 5\n  const completedScenes = new Set(data..);\n  const allScenesComplete =\n    completedScenes.size === 5 &&\n    completedScenes.has(1) &&\n    completedScenes.has(2) &&\n    completedScenes.has(3) &&\n    completedScenes.has(4) &&\n    completedScenes.has(5);\n\n  if (allScenesComplete) {\n    return false; // \n  }\n\n  //   \n  return true;\n}\n","/**\n *  - \n *\n * 5\n * 1.  - Day 6\n * 2.  - \n * 3.  - \n * 4.  - \n *\n * 2026-01-19 \n * - Day 5, 11:00+ 51\n * - 5\n * -  =   \n * -  =   \n *\n * 625\n * - 10:00 5\n * - 11:00-14:00 04\n * - 14:00-18:00 14\n * - 18:00-22:00 24\n * - 22:00-02:00 35\n * - 02:00-06:00 45\n * - 06:00-10:00 53\n */\n\nimport type { Schema as SchemaType } from '../../schema';\nimport { getScene5LockedCoherence } from './scene5System';\n\n// ============================================\n// \n// ============================================\n\nexport interface TrueEndingPhase {\n  phase: number;\n  name: string;\n  title: string;\n  description: string;\n  minTurns: number; // \n  maxTurns: number; // Bug #19 \n  minHour?: number; // Bug #19 \n  strict?: boolean; // Bug #19 true=\n  anchorEvents: string[]; // \n  aiGuidance: string; // AI\n  correctionHints: string[]; // \n  // Bug #15 \n  expectedActions?: string[]; // \n  hintThreshold?: number; // 2\n  progressHint?: string; // \n}\n\nexport const TRUE_ENDING_PHASES: TrueEndingPhase[] = [\n  // === 0 ===\n  // 2026-01-19 625\n  {\n    phase: 0,\n    name: '',\n    title: '',\n    description: 'Day 5, 11:00-14:00',\n    minTurns: 1,\n    maxTurns: 4,\n    minHour: 11,\n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 0\n\n5\n{{user}}\n\nDay 5, 11:0051\n\n\n- \n- \n- \n- {{user}}\n\n\n\n\"\"{{user}}\n\n\nAI\n1. \n2. {{user}}\n3. \"...\"\n4. \n5. {{user}}\n\n\n\"......\"\n\"\"\n\n\n- \n- `,\n    correctionHints: [\n      '\"...\"',\n      '{{user}}\"...\"',\n      '\"\"\"\"',\n    ],\n  },\n\n  // === 1 ===\n  {\n    phase: 1,\n    name: '',\n    title: '',\n    description: 'Day 5, 14:00-18:00',\n    minTurns: 1,\n    maxTurns: 4,\n    minHour: 14,\n    strict: true,\n    anchorEvents: ['', '', '', ''],\n    aiGuidance: ` - 1\n\n{{user}}\n\n\n- {{user}}\"\"\n- \"\"\n- \n- \n\n\n- \n- \n- {{user}}\n- \n\nAI\n1. \n2. \n3. \n4. \n5. \n\n\n- \n- \n- `,\n    correctionHints: [\n      '{{user}}\"\"',\n      '\"...\"',\n      '\"...\"',\n    ],\n  },\n\n  // === 2 ===\n  {\n    phase: 2,\n    name: '',\n    title: '',\n    description: 'Day 5, 18:00-22:00',\n    minTurns: 1,\n    maxTurns: 4,\n    minHour: 18,\n    strict: true,\n    anchorEvents: ['', '', '', ''],\n    aiGuidance: ` - 2\n\n\n\n\n- \n- \n- \n- {{user}}\n\n\n1. \n2. \n3. \n4. \n5. {{user}}\"\"\n\nAI\n1. \n2. \n3. \n4. \"\"\n5. \n\n\n- \n- `,\n    correctionHints: [\n      '\"\"{{user}}',\n      '\"......\"',\n      '{{user}}',\n    ],\n  },\n\n  // === 3 ===\n  {\n    phase: 3,\n    name: '',\n    title: '',\n    description: 'Day 5, 22:00 - Day 6, 02:00',\n    minTurns: 1,\n    maxTurns: 5,\n    minHour: 22,\n    strict: true,\n    anchorEvents: ['', '', '', '', ''],\n    aiGuidance: ` - 3\n\n\n\n\n- \n- {{user}}\n- \n- {{user}}\n- \"\"\n\n\n- \n- \n- \n- \n- \n\n\n- \"...\"\n- \"...\"\n- 161723...\n- \"...\"\n\nAI\n1. {{user}}\n2. \n3. \n4. \"\"\n5. {{user}}\n\n\n- \n- \n- `,\n    correctionHints: [\n      '\"...\"',\n      '\"......\"',\n      '\"...\"\"16\"',\n      '\"\"\"...\"',\n    ],\n    expectedActions: ['', '', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint: '...',\n  },\n\n  // === 4 ===\n  {\n    phase: 4,\n    name: '',\n    title: '',\n    description: 'Day 6, 02:00-06:00',\n    minTurns: 1,\n    maxTurns: 5,\n    minHour: 2,\n    strict: true,\n    anchorEvents: ['', '', '', '', ''],\n    aiGuidance: ` - 4\n\n\"\"\n\n\n- {{user}}\n- \n- \n- {{user}}\n\n\n- {{user}}\n- \"\"\n- \n- \n- \n\n\n- \"...\"\n- \"\"\n- \"...\"\n\nAI\n1. {{user}}\n2. \n3. \n4. \n5. \n\n\n- \n- \n- `,\n    correctionHints: [\n      '{{user}}\"......\"',\n      '\"......\"',\n      '\".........\"',\n    ],\n    expectedActions: ['', '', '', '', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint: '...\"\"',\n  },\n\n  // === 5 ===\n  {\n    phase: 5,\n    name: '',\n    title: '',\n    description: 'Day 6, 06:00-10:00',\n    minTurns: 1,\n    maxTurns: 3,\n    minHour: 6,\n    strict: true,\n    anchorEvents: ['', '', '', ''],\n    aiGuidance: ` - 5\n\n\n\n\n- \n- {{user}}\n- \n- \n\n\n- \n- \n- \n- {{user}}\n- \"\"\n- \"...\"\n\n\n\n\n\"\"\n\nAI\n1. \n2. {{user}}\n3. \n4. {{user}}\n5. \n\n\n\n- \n- \n- \n\n\n- \n- \n- `,\n    correctionHints: [\n      '{{user}}',\n      '',\n      '\"...\"{{user}}\"\"',\n    ],\n    expectedActions: ['', '', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint: '\"...\"',\n  },\n];\n\n// ============================================\n// \n// ============================================\n\nexport interface TrueEndingState {\n  isActive: boolean; // \n  currentPhase: number; //  (0-5)\n  turnsInPhase: number; // \n  completedAnchors: string[]; // \n  totalTurns: number; // \n  isComplete: boolean; // \n  // Bug #15 \n  noProgressTurns: number; // \n  hintGiven: boolean; // \n}\n\n/**\n * \n */\nexport function getDefaultTrueEndingState(): TrueEndingState {\n  return {\n    isActive: false,\n    currentPhase: 0,\n    turnsInPhase: 0,\n    completedAnchors: [],\n    totalTurns: 0,\n    isComplete: false,\n    noProgressTurns: 0,\n    hintGiven: false,\n  };\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * 2026-01-17  11:00 51\n *\n * \"\"\n * 21:00, 23:00 isFreeTimeHour() \n */\nexport function shouldActivateTrueEnding(data: SchemaType): boolean {\n  // 1Day 5, 11:00+51\n  // 2026-01-17  20:00  11:00\n  const day = data..;\n  const hour = data..;\n  if (day < 5 || (day === 5 && hour < 11)) {\n    return false;\n  }\n\n  // 2\n  // 2026-01-17 \"\"11:00\n  const validStates = ['', '', ''];\n  if (!validStates.includes(data..)) {\n    return false;\n  }\n\n  // 3\n  // \n  const currentEnding = data..;\n  if (currentEnding && currentEnding !== '' && currentEnding !== '') {\n    return false;\n  }\n\n  // 45\n  const completedScenes = data..;\n  const correctScenes = data..;\n\n  const allCompleted = [1, 2, 3, 4, 5].every(s => completedScenes.includes(s));\n  const allCorrect = [1, 2, 3, 4, 5].every(s => correctScenes.includes(s));\n\n  return allCompleted && allCorrect;\n}\n\n/**\n * 21:00  23:00\n * 2026-01-17 \n *\n * \n * - 21:00 \n * - 22:00 \n * - 23:00 \n * - 00:00 \n */\nexport function isFreeTimeHour(data: SchemaType): boolean {\n  const day = data..;\n  const hour = data..;\n\n  //  Day 5  21:00  23:00 \n  if (day === 5 && (hour === 21 || hour === 23)) {\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * 00:00\n * 2026-01-17 00:00 \n *\n * 5-9\n */\nexport function isRoomTriggerTime(data: SchemaType): boolean {\n  const day = data..;\n  const hour = data..;\n\n  // Day 5  00:00 Day 6  Day 6 \n  // 500:00\n  return (day === 5 && hour === 0) || day > 5;\n}\n\n/**\n * \n * 2026-01-17 \n */\nexport function getGuidanceType(data: SchemaType): 'preheat' | 'dinner' | 'free' | 'correction' | 'room' | null {\n  const day = data..;\n  const hour = data..;\n\n  // Day 6+  'room' \n  if (day > 5) {\n    return 'room';\n  }\n\n  if (day !== 5) return null;\n\n  // 11:00-19:00 \n  if (hour >= 11 && hour < 20) {\n    return 'preheat';\n  }\n\n  // 20:00 \n  if (hour === 20) {\n    return 'dinner';\n  }\n\n  // 21:00 \n  if (hour === 21) {\n    return 'free';\n  }\n\n  // 22:00 \n  if (hour === 22) {\n    return 'correction';\n  }\n\n  // 23:00 \n  if (hour === 23) {\n    return 'free';\n  }\n\n  // 00:00+ \n  if (hour === 0 || hour >= 24) {\n    return 'room';\n  }\n\n  return null;\n}\n\n/**\n * \n *  + =3\n */\nexport function isPerfectTrueEnding(data: SchemaType): boolean {\n  // 5\n  const coherence = getScene5LockedCoherence(data);\n  return coherence === 3;\n}\n\n/**\n * Schema\n */\nexport function isTrueEndingActive(data: SchemaType): boolean {\n  const endingState = (data as any). as TrueEndingState | undefined;\n  return endingState?.isActive === true;\n}\n\n/**\n * \n */\nexport function getTrueEndingState(data: SchemaType): TrueEndingState {\n  const endingState = (data as any). as TrueEndingState | undefined;\n  return endingState ?? getDefaultTrueEndingState();\n}\n\n/**\n * \n */\nexport function updateTrueEndingState(data: SchemaType, state: TrueEndingState): void {\n  (data as any). = state;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * 2026-01-19 6\n */\nconst ANCHOR_KEYWORDS: Record<string, string[]> = {\n  // 0\n  : ['', '', '.*', '', ''],\n  : ['', '', '', '.*'],\n  : ['', '', '', '', '', ''],\n\n  // 1\n  : ['', '', '', '', '', '', ''],\n  : ['', '', '', '', '.*'],\n  : ['', '', '', '', '', ''],\n  : ['', '', '.*', ''],\n\n  // 2\n  : ['', '', '', '', ''],\n  : ['', '', '', '.*', '.*'],\n  : ['', '', '', '', '', '.*'],\n  : ['', '', '.*', ''],\n\n  // 3\n  : ['', '', '', '', ''],\n  : ['', '', '', '', ''],\n  : ['', '', '.*', '', '', ''],\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '.*', '.*'],\n\n  // 4\n  : ['', '', '.*', '', ''],\n  : ['', '', '', '', ''],\n  : ['', '', '', '.*', '.*'],\n  : ['', '', '', '', ''],\n  : ['', '', '', '', ''],\n\n  // 5\n  : ['', '', '', '', ''],\n  : ['', '', '', '.*'],\n  : ['', '', '', '.*'],\n  : ['', '', '.*', '', ''],\n};\n\n/**\n * AI\n */\nexport function detectCompletedAnchors(aiResponse: string, phase: number): string[] {\n  const phaseConfig = TRUE_ENDING_PHASES[phase];\n  if (!phaseConfig) return [];\n\n  const completed: string[] = [];\n\n  for (const anchor of phaseConfig.anchorEvents) {\n    const keywords = ANCHOR_KEYWORDS[anchor] || [];\n    const isCompleted = keywords.some(kw => {\n      // \n      if (kw.includes('.*')) {\n        const regex = new RegExp(kw, 'i');\n        return regex.test(aiResponse);\n      }\n      return aiResponse.includes(kw);\n    });\n\n    if (isCompleted) {\n      completed.push(anchor);\n    }\n  }\n\n  return completed;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * Bug #19  maxTurns \n * Bug #40 maxTurns \n */\nexport function shouldAdvancePhase(state: TrueEndingState, currentHour?: number): boolean {\n  const phaseConfig = TRUE_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig) return false;\n\n  // Bug #40 \n  //  maxTurns \n  if (currentHour !== undefined) {\n    const canEnter = canEnterNextPhase(state, currentHour);\n    if (canEnter.blocked) {\n      // \n      return false;\n    }\n  }\n\n  // Bug #19 \n  if (phaseConfig.maxTurns && state.turnsInPhase >= phaseConfig.maxTurns) {\n    console.info(\n      `[] ${state.currentPhase}(${phaseConfig.name}) ${phaseConfig.maxTurns}`,\n    );\n    return true;\n  }\n\n  // \n  if (state.turnsInPhase < phaseConfig.minTurns) {\n    return false;\n  }\n\n  // \n  const allAnchorsComplete = phaseConfig.anchorEvents.every(anchor => state.completedAnchors.includes(anchor));\n\n  return allAnchorsComplete;\n}\n\n/**\n * Bug #19 \n * @returns null \n */\nexport function canEnterNextPhase(\n  state: TrueEndingState,\n  currentHour: number,\n): { blocked: boolean; reason?: string; waitHours?: number } {\n  const nextPhase = state.currentPhase + 1;\n  if (nextPhase >= TRUE_ENDING_PHASES.length) {\n    return { blocked: false }; // \n  }\n\n  const nextConfig = TRUE_ENDING_PHASES[nextPhase];\n  if (!nextConfig) return { blocked: false };\n\n  // \n  if (nextConfig.strict && nextConfig.minHour !== undefined) {\n    // minHour=0 \n    if (nextConfig.minHour === 0) {\n      //  0-6 \n      if (currentHour > 6) {\n        return {\n          blocked: true,\n          reason: `\"${nextConfig.name}\"`,\n          waitHours: 24 - currentHour,\n        };\n      }\n    } else if (currentHour < nextConfig.minHour) {\n      return {\n        blocked: true,\n        reason: `${nextConfig.minHour}:00\"${nextConfig.name}\"`,\n        waitHours: nextConfig.minHour - currentHour,\n      };\n    }\n  }\n\n  return { blocked: false };\n}\n\n/**\n * \n */\nexport function advanceToNextPhase(state: TrueEndingState): TrueEndingState {\n  const nextPhase = state.currentPhase + 1;\n\n  // \n  if (nextPhase >= TRUE_ENDING_PHASES.length) {\n    return {\n      ...state,\n      isComplete: true,\n    };\n  }\n\n  return {\n    ...state,\n    currentPhase: nextPhase,\n    turnsInPhase: 0,\n    completedAnchors: [], // \n    noProgressTurns: 0, // Bug #15 \n    hintGiven: false, // Bug #15 \n  };\n}\n\n// ============================================\n// Bug #15 \n// ============================================\n\n/**\n * \n */\nexport function hasExpectedAction(userInput: string, phase: number): boolean {\n  const phaseConfig = TRUE_ENDING_PHASES[phase];\n  if (!phaseConfig || !phaseConfig.expectedActions) {\n    return true; // \n  }\n\n  const input = userInput.toLowerCase();\n  return phaseConfig.expectedActions.some(action => input.includes(action.toLowerCase()));\n}\n\n/**\n * \n */\nexport function checkProgressHint(state: TrueEndingState, userInput: string): string | null {\n  const phaseConfig = TRUE_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig || !phaseConfig.progressHint) {\n    return null;\n  }\n\n  // \n  if (state.hintGiven) {\n    return null;\n  }\n\n  // \n  if (hasExpectedAction(userInput, state.currentPhase)) {\n    return null;\n  }\n\n  // \n  const threshold = phaseConfig.hintThreshold ?? 2;\n  if (state.noProgressTurns >= threshold) {\n    return phaseConfig.progressHint;\n  }\n\n  return null;\n}\n\n/**\n * \n */\nexport function updateProgressTracking(\n  state: TrueEndingState,\n  userInput: string,\n): { updatedState: TrueEndingState; hint: string | null } {\n  const hasProgress = hasExpectedAction(userInput, state.currentPhase);\n\n  // \n  const hint = checkProgressHint(state, userInput);\n\n  let updatedState = { ...state };\n\n  if (hasProgress) {\n    // \n    updatedState.noProgressTurns = 0;\n  } else {\n    // \n    updatedState.noProgressTurns = state.noProgressTurns + 1;\n  }\n\n  // \n  if (hint) {\n    updatedState.hintGiven = true;\n  }\n\n  return { updatedState, hint };\n}\n\n/**\n * \n * Bug #19  currentHour \n */\nexport function processTurnEnd(\n  state: TrueEndingState,\n  aiResponse: string,\n  userInput?: string,\n  currentHour?: number, // Bug #19\n): {\n  newState: TrueEndingState;\n  phaseAdvanced: boolean;\n  newPhase: number | null;\n  timeBlocked?: { reason: string; waitHours: number }; // Bug #19\n} {\n  // \n  let newState: TrueEndingState = {\n    ...state,\n    turnsInPhase: state.turnsInPhase + 1,\n    totalTurns: state.totalTurns + 1,\n  };\n\n  // \n  const newAnchors = detectCompletedAnchors(aiResponse, state.currentPhase);\n  const allAnchors = [...new Set([...newState.completedAnchors, ...newAnchors])];\n  newState.completedAnchors = allAnchors;\n\n  // Bug #15 \n  if (userInput) {\n    const { updatedState } = updateProgressTracking(newState, userInput);\n    newState = updatedState;\n  }\n\n  // \n  let phaseAdvanced = false;\n  let newPhase: number | null = null;\n\n  if (shouldAdvancePhase(newState, currentHour)) {\n    // Bug #19 \n    const hour = currentHour ?? 12; // \n    const canEnter = canEnterNextPhase(newState, hour);\n\n    if (canEnter.blocked) {\n      // \n      console.info(`[] ${newState.currentPhase} ${canEnter.reason}`);\n      return {\n        newState,\n        phaseAdvanced: false,\n        newPhase: null,\n        timeBlocked: { reason: canEnter.reason!, waitHours: canEnter.waitHours! },\n      };\n    }\n\n    newState = advanceToNextPhase(newState);\n    phaseAdvanced = true;\n    newPhase = newState.currentPhase;\n  }\n\n  return { newState, phaseAdvanced, newPhase };\n}\n\n// ============================================\n// AI Prompt \n// ============================================\n\n/**\n * AIPrompt\n * Bug #19  currentHour \n */\nexport function generateTrueEndingPrompt(\n  state: TrueEndingState,\n  userInput: string,\n  currentHour?: number, // Bug #19\n): string {\n  const phaseConfig = TRUE_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig) return '';\n\n  // \n  const remainingAnchors = phaseConfig.anchorEvents.filter(a => !state.completedAnchors.includes(a));\n\n  // Bug #40 \n  const hour = currentHour ?? 12;\n  const nextPhaseCheck = canEnterNextPhase(state, hour);\n  const isTimeLocked = nextPhaseCheck.blocked;\n\n  // Bug #40 \"\"\n  let turnsWarning: string;\n  if (isTimeLocked) {\n    // \"X\"\n    turnsWarning = `${TRUE_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00`;\n  } else {\n    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;\n    turnsWarning =\n      remainingTurns <= 2 ? ` ${remainingTurns}` : `${remainingTurns}`;\n  }\n\n  // Bug #40 \n  const timeBlockWarning = isTimeLocked\n    ? `\\n \"${TRUE_ENDING_PHASES[state.currentPhase + 1]?.name}\"${TRUE_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00${hour}:00\n `\n    : '';\n\n  // \n  const progressInfo = `\n- ${state.currentPhase + 1}/${TRUE_ENDING_PHASES.length}${phaseConfig.name}\n- ${state.turnsInPhase}${turnsWarning}\n- ${remainingAnchors.length > 0 ? remainingAnchors.join('') : ''}\n- ${state.totalTurns}${timeBlockWarning}`;\n\n  // Bug #15 \n  const hint = checkProgressHint(state, userInput);\n  const hintSection = hint\n    ? `\\n\\n\n\n${hint}`\n    : '';\n\n  // Bug #19 \n  // Bug #40 \n  let urgencyHint = '';\n  if (!isTimeLocked) {\n    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;\n    if (remainingTurns <= 1) {\n      urgencyHint = `\\n\\n`;\n    }\n  }\n\n  // Prompt\n  return `${phaseConfig.aiGuidance}\n\n${progressInfo}${hintSection}${urgencyHint}\n\n\n- \n- \n- \n- \n- \n- `;\n}\n\n/**\n * \n */\nexport function getCorrectionHint(phase: number): string | null {\n  const phaseConfig = TRUE_ENDING_PHASES[phase];\n  if (!phaseConfig || phaseConfig.correctionHints.length === 0) {\n    return null;\n  }\n\n  // \n  const index = Math.floor(Math.random() * phaseConfig.correctionHints.length);\n  return phaseConfig.correctionHints[index];\n}\n\n/**\n * \n * 2026-01-19 625\n */\nexport function generateTrueEndingEntryReplacement(data?: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  // \n  const isPerfect = data ? isPerfectTrueEnding(data) : false;\n  const endingTitle = isPerfect ? '' : '';\n\n  const perfectMemoryNote = isPerfect\n    ? `\n\n\n51-2-3\n\"\"\n- 16\n- 17\n- 20\n- \n\nAI\n\"\"\"\"\n\n\"\"\"\"`\n    : '';\n\n  const userMessage = `[ - ${endingTitle}]\n\n Day 5, 11:00\n5\n${endingTitle}\n\n\n5\n- 116- \n- 217- \n- 323- \n- 428- \n- 5- \n\n.X.\n\nDay 1-4 \n Day 1  Day 4 \n\n${perfectMemoryNote}\n\n{{user}}\n\n\n\n{{user}}\n\n\n625\n- 11:00-14:00 04- \n- 14:00-18:00 14- \n- 18:00-22:00 24- \n- 22:00-02:00 35- \n- 02:00-06:00 45- \n- 06:00-10:00 53- \n\nAI\n1. \n2. {{user}}\n3. \"...\"\n4. \n5. {{user}}`;\n\n  // 2026-01-19 prefill \n  const prefill = isPerfect\n    ? `\n\n...\n\n\n\n\n\n\n{{user}}\n\n\"\"\"...\"`\n    : `\n\n...\n\n\n\"\"\n\n\n\n{{user}}\n\n\"...\"\"...\"`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * \n */\nexport function generatePhaseTransitionHint(fromPhase: number, toPhase: number): string {\n  const toConfig = TRUE_ENDING_PHASES[toPhase];\n  if (!toConfig) return '';\n\n  return `\\n\\n---\\n${toConfig.name}${toConfig.title}\\n---\\n`;\n}\n\n/**\n * \n * 2026-01-16 \n */\nexport function generateTrueEndingComplete(data?: SchemaType): string {\n  // \n  const isPerfect = data ? isPerfectTrueEnding(data) : false;\n\n  if (isPerfect) {\n    return `\n\n\n\nPERFECT TRUE END\n\n\n\n\n16\n17\n20\n25\n\n\n\n\n\n\n\n\"\"\n\"...\"\n\"\"\n\n\n\n\n\n\n\n\n\n \n \n\n`;\n  }\n\n  return `\n\n\n\nTRUE END\n\n\n\n\n16\n17\n23\n28\n...\n\n\n\n\n\"\"\n\n\n\n\n...\n\n\n\n\n\n \n\n`;\n}\n\n// ============================================\n// 2026-01-17 \n// ============================================\n\n/**\n * 21:00  23:00\n * \n */\nexport function generateFreeTimePrompt(hour: number): string {\n  const nextHour = hour + 1;\n  const nextEvent = hour === 21 ? '22:00' : '00:00';\n\n  return ` - ${hour}:00\n\n${nextEvent}\n\n\n- \n- \n- {{user}}\n\nAI\n1. \n2. \n3. {{user}}\n4. \n5. \n\n\n\n- \n- \n- \"\"\n- \n\n${nextHour}:00`;\n}\n\n/**\n * 22:00\n */\nexport function generateCorrectionPrompt(state: TrueEndingState): string {\n  const currentPhase = TRUE_ENDING_PHASES[state.currentPhase];\n  const phaseName = currentPhase?.name ?? '';\n\n  return `22:00 - \n\n\n\n\n- ${state.currentPhase + 1}/${TRUE_ENDING_PHASES.length}${phaseName}\n- ${state.totalTurns}\n\nAI\n1. \n2. \"\"\n3. \n4. \n\n\n00:00\n...`;\n}\n\n/**\n * 00:00\n * 3\n * 2026-01-19 6\n */\nexport function generateRoomTriggerPrompt(state: TrueEndingState, isPerfect: boolean): string {\n  // 3\n  if (state.currentPhase >= 3) {\n    return '';\n  }\n\n  const endingTitle = isPerfect ? '' : '';\n\n  return ` 00:00 - ${endingTitle}\n\n\n\n\n\n{{user}}\"\"\n\n\n\n- 3\n- 4\n- 5\n\nAI\n1. {{user}}\n2. \n3. \n4. 3\n\n\n\n`;\n}\n\n/**\n * Prompt\n * 2026-01-17 \n */\nexport function generateTimeBasedPrompt(data: SchemaType, state: TrueEndingState, userInput: string): string | null {\n  const guidanceType = getGuidanceType(data);\n\n  if (!guidanceType) {\n    return null;\n  }\n\n  switch (guidanceType) {\n    case 'preheat':\n    case 'dinner':\n      // \n      return generateTrueEndingPrompt(state, userInput);\n\n    case 'free': {\n      // \n      const hour = data..;\n      return generateFreeTimePrompt(hour);\n    }\n\n    case 'correction':\n      // 22:00 \n      return generateCorrectionPrompt(state);\n\n    case 'room': {\n      // 00:00 \n      const isPerfect = isPerfectTrueEnding(data);\n      const roomPrompt = generateRoomTriggerPrompt(state, isPerfect);\n      if (roomPrompt) {\n        return roomPrompt;\n      }\n      // 5+\n      return generateTrueEndingPrompt(state, userInput);\n    }\n\n    default:\n      return null;\n  }\n}\n","/**\n *  - \n *\n * 2026-01-17 \n * - 11:00 \n * - 20:00 \n * - 21:00/23:00 \n * - 00:00\n *\n * \n * - Day 5, 11:00+/ 20:00+\n * - 5\n * -  < 5\n * -  =   \n * -  = \n *\n * \n * - \n * - \n * - \n * - \n *\n * 2026-01-17\n * - \n * - AI\n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n// ============================================\n// \n// ============================================\n\nexport interface FalseEndingPhase {\n  phase: number;\n  name: string;\n  title: string;\n  description: string;\n  minTurns: number;\n  maxTurns: number; // Bug #19\n  minHour?: number; // Bug #19\n  strict?: boolean; // Bug #19true=minHour\n  anchorEvents: string[];\n  aiGuidance: string;\n  correctionHints: string[];\n  // Bug #15 \n  expectedActions?: string[]; // \n  hintThreshold?: number; // 2\n  progressHint?: string; // \n}\n\nexport const FALSE_ENDING_PHASES: FalseEndingPhase[] = [\n  // === 0 ===\n  // 2026-01-17 11:00\n  {\n    phase: 0,\n    name: '',\n    title: '',\n    description: '11:00',\n    minTurns: 1,\n    maxTurns: 2, // 2026-01-19: \n    minHour: 11, // 11:00\n    anchorEvents: ['', ''],\n    aiGuidance: ` - 0\n\n\n\n\nDay 5, 11:00\n\n\n- \n- \n- \n- \n\n\n\"\"\n...\n{{user}}\n\n\"\"{{user}}\n\nAI\n1. \n2. \"\"\n3. {{user}}\n4. \n5. \n\n\n- \n- `,\n    correctionHints: [\n      '...{{user}}',\n      '\"...\"',\n      '{{user}}',\n    ],\n  },\n\n  // === 1 ===\n  // 2026-01-19 14:00 \n  {\n    phase: 1,\n    name: '',\n    title: '',\n    description: '14:00{{user}}',\n    minTurns: 1,\n    maxTurns: 2,\n    minHour: 14, // 2026-01-19: 14:00\n    strict: true,\n    anchorEvents: ['', ''],\n    aiGuidance: ` - 1\n\n\n\nDay 5, 14:00\n\n\n- \n- {{user}}\n- \n- \n\n\n...\n\n\"\"\n\"\"\n\nAI\n1. {{user}}\n2. \n3. {{user}}\n4. \"...\"\n5. \n\n\n- \n- \"\"\n- `,\n    correctionHints: [\n      '\"\"{{user}}',\n      '\"...\"{{user}}',\n      '{{user}}',\n    ],\n  },\n\n  // === 2 ===\n  // 2026-01-19 17:00 \n  {\n    phase: 2,\n    name: '',\n    title: '',\n    description: '17:00',\n    minTurns: 1,\n    maxTurns: 2,\n    minHour: 17, // 2026-01-19: 17:00\n    strict: true,\n    anchorEvents: ['', ''],\n    aiGuidance: ` - 2\n\n\n\n\nDay 5, 17:00\n\n\n- \n- \n- ...\n- \n\n\n...\n\n{{user}}\n\"......\"\n\n\nAI\n1. \n2. \n3. \n4. {{user}}\n5. ...\n\n\n- \n- `,\n    correctionHints: [\n      '\"\"\"...\"',\n      '',\n      '\"...\"{{user}}',\n    ],\n  },\n\n  // === 3 ===\n  // 2026-01-1720:00 \n  {\n    phase: 3,\n    name: '',\n    title: '',\n    description: '20:00/',\n    minTurns: 1,\n    maxTurns: 2, // 2026-01-19: \n    minHour: 20, // Bug #19: 20:00\n    strict: true, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 1\n\n\n\n\nDay 5, 20:00\n\n\n- \n- \n- {{user}}\n- \n\n\n...\n\"\"\n{{user}}\n\n\nAI\n1. \n2. \n3. /\n4. {{user}}\n5. \n6. ...\n\n\n\"\"\n\n\n\n- \n- `,\n    correctionHints: [\n      '{{user}}',\n      '\"\"{{user}}',\n      '',\n    ],\n  },\n\n  // === 4 ===\n  {\n    phase: 4,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 3, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 2\n\n{{user}}\n\n\n\n- \n- /\n- \n- \n\n\n...\n\n...\n{{user}}\n\nAI\n1. \n2. \n3. \n4. \"......\"\n5. {{user}}\n\n\n- \n- `,\n    correctionHints: [\n      '{{user}}',\n      '\"...\"{{user}}',\n      '\"...\"',\n    ],\n  },\n\n  // === 5 ===\n  {\n    phase: 5,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 3, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 3\n\n\n\n\n\n- \n- \n- \"\"\n- \n\n\n\n......\n{{user}}\n\"......\"\n{{user}}\n\n\nAI\n1. \n2. \n3. \n4. \n5. \n\n\n- \n- \n- \"......\"{{user}}\n- \n\n\n\n4`,\n    correctionHints: [\n      '...',\n      '\"...\"{{user}}',\n      '{{user}}',\n    ],\n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint: '...',\n  },\n\n  // === 6 ===\n  // 2026-01-17 \n  {\n    phase: 6,\n    name: '',\n    title: '',\n    description: '{{user}}',\n    minTurns: 1,\n    maxTurns: 3, // Bug #19: \n    anchorEvents: ['', '', '', ''],\n    aiGuidance: ` - 4\n\n\n\n{{user}}\n\n\n- /\n- \n- {{user}}\n- \n- \n\n\n...\n\n\n{{user}}\n\n\n\n\nAI\n1. \n2. {{user}}\n3. \n4. {{user}}\n5. \n6. \n7. \n\n\n- \"\"\n- \".........\"{{user}}\n- \"\"\n- \".........\"\n- {{user}}\n\n\n- \n- {{user}}\n- \"...\"\n- \n\n\n- \n- \n- `,\n    correctionHints: [\n      '{{user}}{{user}}',\n      '\"......\"{{user}}',\n      '\"\"{{user}}\"......\"',\n    ],\n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint:\n      '...',\n  },\n\n  // === 7 ===\n  {\n    phase: 7,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 3, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 5\n\n{{user}}\n\n\n- /\n- \n- \n- \n\n\n...\n\n\"\"\n\"......\"\n\n\nAI\n1. \n2. \n3. \"\"\n4. \"...\"\n5. \n\n\n- \n- \"\"\n- \"\"{{user}}`,\n    correctionHints: [\n      '{{user}}',\n      '\"...\"',\n      '',\n    ],\n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint:\n      '...\"\"',\n  },\n\n  // === 8 ===\n  // 2026-01-17 \n  {\n    phase: 8,\n    name: '',\n    title: '',\n    description: 'AI',\n    minTurns: 1,\n    maxTurns: 3, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 6\n\n\n\n\n\n- \n- \n- \"\"\n- \n\n\n...\n\"\"\n\n...\n\n\nAI\n1. \n2. \"\"\n3. \n4. \"...\"\n5. \"...AI\"\n6. \n\n\n\"...\"\n\"...AI\"\n\"...\"\n\n\n- \n- \n- \n- ...`,\n    correctionHints: [\n      '...',\n      '\"\"\"AI...\"',\n      '',\n    ],\n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint: '...',\n  },\n\n  // === 9 ===\n  {\n    phase: 9,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 3, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 7\n\n\n\n\n- \n- \n- \n- \"\"\n\n\n...\n...\n\n\"\"\n{{user}}\n\nAI\n1. \n2. \n3. \"...\"\n4. \n5. {{user}}...\n\n\n\n{{user}}\n...`,\n    correctionHints: [\n      '{{user}}',\n      '\"......\"',\n      '\"\"',\n    ],\n  },\n];\n\n// ============================================\n// \n// ============================================\n\nconst ANCHOR_KEYWORDS: Record<string, (string | RegExp)[]> = {\n  // 0 11:00\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '', ''],\n\n  // 1 14:00\n  : ['', '', '', '', '', '', ''],\n  : ['', '', '', '', '', ''],\n\n  // 2 17:00\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '', '', '', ''],\n\n  // 3 20:00\n  : ['', '', '', /.*/],\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '', /.*/, ''],\n\n  // 4\n  : ['', '', '', ''],\n  : ['', '', '', '.*', ''],\n  : ['', '', '', ''],\n\n  // 5 - \n  : ['', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', '', ''],\n  : ['', '', '', '', '', '', '', ''],\n\n  // 6\n  : ['', '', '', '', ''],\n  : ['', '', '', ''],\n  : ['', '', '', ''],\n  : ['', '', '', '', '', ''],\n\n  // 7\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '', '', '', ''],\n\n  // 8\n  : ['', '', '', '', ''],\n  : ['', '', '', '', ''],\n  : ['AI', '', '', '', ''],\n\n  // 9\n  : ['', '', '', '', ''],\n  : ['', '', '', '', ''],\n  : ['', '', '', '', /.*/],\n};\n\n// ============================================\n// \n// ============================================\n\nexport interface FalseEndingState {\n  isActive: boolean;\n  isComplete: boolean;\n  currentPhase: number;\n  turnsInPhase: number;\n  totalTurns: number;\n  completedAnchors: string[];\n  // Bug #15 \n  noProgressTurns: number; // \n  hintGiven: boolean; // \n}\n\n// ============================================\n// \n// ============================================\n\nexport function getDefaultFalseEndingState(): FalseEndingState {\n  return {\n    isActive: false,\n    isComplete: false,\n    currentPhase: 0,\n    turnsInPhase: 0,\n    totalTurns: 0,\n    completedAnchors: [],\n    noProgressTurns: 0,\n    hintGiven: false,\n  };\n}\n\n/**\n * \n * 2026-01-17 11:00\n */\nexport function shouldActivateFalseEnding(data: SchemaType): boolean {\n  // 1. Day 5, 11:00 \n  if (data.. < 5) return false;\n  if (data.. === 5 && data.. < 11) return false;\n\n  // 2. \n  const validStates = ['', '', ''];\n  if (!validStates.includes(data..)) {\n    return false;\n  }\n\n  // 3. \n  if (data.. !== '') return false;\n\n  // 4. \n  if (data.?.isActive) return false;\n\n  return true;\n}\n\n/**\n * \n */\nexport function isFalseEndingActive(data: SchemaType): boolean {\n  return data.?.isActive === true;\n}\n\n/**\n * \n */\nexport function getFalseEndingState(data: SchemaType): FalseEndingState {\n  return data. ?? getDefaultFalseEndingState();\n}\n\n/**\n * \n */\nexport function updateFalseEndingState(data: SchemaType, state: FalseEndingState): void {\n  (data as any). = state;\n}\n\n/**\n * 21:00  23:00\n * 2026-01-17 \n */\nexport function isFalseEndingFreeTime(data: SchemaType): boolean {\n  const day = data..;\n  const hour = data..;\n\n  //  Day 5  21:00  23:00 \n  if (day === 5 && (hour === 21 || hour === 23)) {\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * \n * 2026-01-17 \n */\nexport function getFalseEndingGuidanceType(data: SchemaType): 'preheat' | 'dinner' | 'free' | 'main' | null {\n  const day = data..;\n  const hour = data..;\n\n  // Day 6+  'main' \n  if (day > 5) {\n    return 'main';\n  }\n\n  if (day !== 5) return null;\n\n  // 11:00-19:00 \n  if (hour >= 11 && hour < 20) {\n    return 'preheat';\n  }\n\n  // 20:00 \n  if (hour === 20) {\n    return 'dinner';\n  }\n\n  // 21:00, 23:00 \n  if (hour === 21 || hour === 23) {\n    return 'free';\n  }\n\n  // 22:00, 00:00+ \n  return 'main';\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * AI\n */\nexport function detectCompletedAnchors(aiResponse: string, phase: number): string[] {\n  if (phase >= FALSE_ENDING_PHASES.length) return [];\n\n  const phaseConfig = FALSE_ENDING_PHASES[phase];\n  const completed: string[] = [];\n\n  for (const anchor of phaseConfig.anchorEvents) {\n    const keywords = ANCHOR_KEYWORDS[anchor];\n    if (!keywords) continue;\n\n    for (const kw of keywords) {\n      if (typeof kw === 'string') {\n        if (aiResponse.includes(kw)) {\n          completed.push(anchor);\n          break;\n        }\n      } else {\n        if (kw.test(aiResponse)) {\n          completed.push(anchor);\n          break;\n        }\n      }\n    }\n  }\n\n  return [...new Set(completed)];\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * Bug #19: \n * @param state \n * @param currentHour \n * @returns \n */\nexport function canEnterNextFalsePhase(\n  state: FalseEndingState,\n  currentHour: number,\n): { blocked: boolean; reason?: string; waitHours?: number } {\n  const nextPhase = state.currentPhase + 1;\n  if (nextPhase >= FALSE_ENDING_PHASES.length) {\n    return { blocked: false };\n  }\n\n  const nextConfig = FALSE_ENDING_PHASES[nextPhase];\n  if (!nextConfig) return { blocked: false };\n\n  // \n  if (nextConfig.minHour !== undefined && nextConfig.strict) {\n    if (currentHour < nextConfig.minHour) {\n      const waitHours = nextConfig.minHour - currentHour;\n      return {\n        blocked: true,\n        reason: `${nextConfig.name} ${nextConfig.minHour}:00 `,\n        waitHours,\n      };\n    }\n  }\n\n  return { blocked: false };\n}\n\n/**\n * \n * Bug #19:  maxTurns \n * Bug #40 maxTurns \n */\nexport function shouldAdvancePhase(state: FalseEndingState, currentHour?: number): boolean {\n  if (state.currentPhase >= FALSE_ENDING_PHASES.length) return false;\n\n  const phaseConfig = FALSE_ENDING_PHASES[state.currentPhase];\n\n  // Bug #40 \n  //  maxTurns \n  if (currentHour !== undefined) {\n    const canEnter = canEnterNextFalsePhase(state, currentHour);\n    if (canEnter.blocked) {\n      // \n      return false;\n    }\n  }\n\n  // Bug #19: \n  if (phaseConfig.maxTurns && state.turnsInPhase >= phaseConfig.maxTurns) {\n    console.info(\n      `[] ${state.currentPhase}(${phaseConfig.name}) ${phaseConfig.maxTurns}`,\n    );\n    return true;\n  }\n\n  // 1\n  if (state.turnsInPhase < phaseConfig.minTurns) return false;\n\n  // 2\n  const allAnchorsComplete = phaseConfig.anchorEvents.every(anchor => state.completedAnchors.includes(anchor));\n\n  return allAnchorsComplete;\n}\n\n/**\n * \n */\nexport function advanceToNextPhase(state: FalseEndingState): FalseEndingState {\n  const nextPhase = state.currentPhase + 1;\n\n  // \n  if (nextPhase >= FALSE_ENDING_PHASES.length) {\n    return {\n      ...state,\n      currentPhase: nextPhase,\n      turnsInPhase: 0,\n      completedAnchors: [],\n      isComplete: true,\n      noProgressTurns: 0, // Bug #15 \n      hintGiven: false, // Bug #15 \n    };\n  }\n\n  return {\n    ...state,\n    currentPhase: nextPhase,\n    turnsInPhase: 0,\n    completedAnchors: [],\n    noProgressTurns: 0, // Bug #15 \n    hintGiven: false, // Bug #15 \n  };\n}\n\n// ============================================\n// Bug #15 \n// ============================================\n\n/**\n * \n */\nexport function hasExpectedAction(userInput: string, phase: number): boolean {\n  const phaseConfig = FALSE_ENDING_PHASES[phase];\n  if (!phaseConfig || !phaseConfig.expectedActions) {\n    return true; // \n  }\n\n  const input = userInput.toLowerCase();\n  return phaseConfig.expectedActions.some(action => input.includes(action.toLowerCase()));\n}\n\n/**\n * \n */\nexport function checkProgressHint(state: FalseEndingState, userInput: string): string | null {\n  const phaseConfig = FALSE_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig || !phaseConfig.progressHint) {\n    return null;\n  }\n\n  // \n  if (state.hintGiven) {\n    return null;\n  }\n\n  // \n  if (hasExpectedAction(userInput, state.currentPhase)) {\n    return null;\n  }\n\n  // \n  const threshold = phaseConfig.hintThreshold ?? 2;\n  if (state.noProgressTurns >= threshold) {\n    return phaseConfig.progressHint;\n  }\n\n  return null;\n}\n\n/**\n * \n */\nexport function updateProgressTracking(\n  state: FalseEndingState,\n  userInput: string,\n): { updatedState: FalseEndingState; hint: string | null } {\n  const hasProgress = hasExpectedAction(userInput, state.currentPhase);\n\n  // \n  const hint = checkProgressHint(state, userInput);\n\n  let updatedState = { ...state };\n\n  if (hasProgress) {\n    // \n    updatedState.noProgressTurns = 0;\n  } else {\n    // \n    updatedState.noProgressTurns = state.noProgressTurns + 1;\n  }\n\n  // \n  if (hint) {\n    updatedState.hintGiven = true;\n  }\n\n  return { updatedState, hint };\n}\n\n/**\n * \n * Bug #19: \n */\nexport function processTurnEnd(\n  state: FalseEndingState,\n  aiResponse: string,\n  userInput?: string,\n  currentHour?: number,\n): {\n  newState: FalseEndingState;\n  phaseAdvanced: boolean;\n  newPhase: number | null;\n  timeBlocked?: { reason: string; waitHours: number };\n} {\n  // \n  let newState: FalseEndingState = {\n    ...state,\n    turnsInPhase: state.turnsInPhase + 1,\n    totalTurns: state.totalTurns + 1,\n  };\n\n  // \n  const newAnchors = detectCompletedAnchors(aiResponse, state.currentPhase);\n  const allAnchors = [...new Set([...newState.completedAnchors, ...newAnchors])];\n  newState.completedAnchors = allAnchors;\n\n  // Bug #15 \n  if (userInput) {\n    const { updatedState } = updateProgressTracking(newState, userInput);\n    newState = updatedState;\n  }\n\n  // \n  let phaseAdvanced = false;\n  let newPhase: number | null = null;\n\n  if (shouldAdvancePhase(newState, currentHour)) {\n    // Bug #19: \n    if (currentHour !== undefined) {\n      const timeCheck = canEnterNextFalsePhase(newState, currentHour);\n      if (timeCheck.blocked) {\n        // \n        return {\n          newState,\n          phaseAdvanced: false,\n          newPhase: null,\n          timeBlocked: {\n            reason: timeCheck.reason || '',\n            waitHours: timeCheck.waitHours || 1,\n          },\n        };\n      }\n    }\n\n    newState = advanceToNextPhase(newState);\n    phaseAdvanced = true;\n    newPhase = newState.currentPhase;\n  }\n\n  return { newState, phaseAdvanced, newPhase };\n}\n\n// ============================================\n// Prompt\n// ============================================\n\n/**\n * AIPrompt\n * Bug #19: \n * Bug #40 \"\"\n */\nexport function generateFalseEndingPrompt(state: FalseEndingState, userInput: string, currentHour?: number): string {\n  if (state.currentPhase >= FALSE_ENDING_PHASES.length) {\n    return generateFalseEndingComplete();\n  }\n\n  const phaseConfig = FALSE_ENDING_PHASES[state.currentPhase];\n\n  let prompt = phaseConfig.aiGuidance;\n\n  // Bug #40 \n  const hour = currentHour ?? 12;\n  const nextPhaseCheck = canEnterNextFalsePhase(state, hour);\n  const isTimeLocked = nextPhaseCheck.blocked;\n\n  // Bug #40 \"\"\n  let turnsWarning: string;\n  if (isTimeLocked) {\n    turnsWarning = `${FALSE_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00`;\n  } else {\n    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;\n    turnsWarning =\n      remainingTurns <= 2 ? ` ${remainingTurns}` : `${remainingTurns}`;\n  }\n\n  // Bug #40 \n  let urgencyHint = '';\n  if (!isTimeLocked) {\n    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;\n    if (remainingTurns <= 1) {\n      urgencyHint = '\\n\\n 1';\n    } else if (remainingTurns <= 2) {\n      urgencyHint = `\\n\\n ${remainingTurns} `;\n    }\n  }\n\n  // Bug #40 \n  const timeBlockWarning = isTimeLocked\n    ? `\\n \"${FALSE_ENDING_PHASES[state.currentPhase + 1]?.name}\"${FALSE_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00${hour}:00\n `\n    : '';\n\n  // \n  prompt += `\\n\\n\n- ${state.currentPhase + 1}/${FALSE_ENDING_PHASES.length} - ${phaseConfig.title}\n- ${state.turnsInPhase}${turnsWarning}\n- [${state.completedAnchors.join(', ')}]\n- [${phaseConfig.anchorEvents.filter(a => !state.completedAnchors.includes(a)).join(', ')}]${timeBlockWarning}${urgencyHint}`;\n\n  // Bug #15 \n  const progressHint = checkProgressHint(state, userInput);\n  if (progressHint) {\n    prompt += `\\n\\n\n\n${progressHint}`;\n  }\n  // \n  else if (userInput && !isInputOnTrack(userInput, state.currentPhase)) {\n    const hint = getCorrectionHint(state.currentPhase);\n    if (hint) {\n      prompt += `\\n\\n\n\n${hint}`;\n    }\n  }\n\n  return prompt;\n}\n\n/**\n * \n */\nfunction isInputOnTrack(input: string, phase: number): boolean {\n  // \n  const phaseConfig = FALSE_ENDING_PHASES[phase];\n  if (!phaseConfig) return true;\n\n  const allKeywords = phaseConfig.anchorEvents.flatMap(anchor => {\n    const kws = ANCHOR_KEYWORDS[anchor];\n    return kws ? kws.filter((k): k is string => typeof k === 'string') : [];\n  });\n\n  return allKeywords.some(kw => input.includes(kw));\n}\n\n/**\n * \n */\nexport function getCorrectionHint(phase: number): string | null {\n  if (phase >= FALSE_ENDING_PHASES.length) return null;\n\n  const hints = FALSE_ENDING_PHASES[phase].correctionHints;\n  if (!hints || hints.length === 0) return null;\n\n  // \n  return hints[Math.floor(Math.random() * hints.length)];\n}\n\n/**\n * \n * 2026-01-17 \n * 2026-01-19 \n */\nexport function generateFalseEndingFreeTimePrompt(hour: number): string {\n  const nextHour = hour + 1;\n  const nextEvent = hour === 21 ? '22:00' : '';\n\n  return ` - ${hour}:00\n\n${nextEvent}\n\n\n- /\n- {{user}}\n- \n\nAI\n1. \n2. \n3. {{user}}\n4. \n5. \n\n\n\n- \n- \n- {{user}}\n\n - \n  <HusbandThought> \n- /30-50\n- \n- \n- \n\n\n<HusbandThought>\n...\n</HusbandThought>\n\n${nextHour}:00`;\n}\n\n/**\n * \n * 2026-01-17 20:0011:00\n */\nexport function generateFalseEndingEntryReplacement(): {\n  userMessage: string;\n  prefill: string;\n} {\n  return {\n    userMessage: `[ - ]\n\n Day 5, 11:00\n\n\n\n\n\"\"...\n{{user}}\n\n\n\n5\n- \n- {{user}}\"\"\n- \n\n.X.\n\nDay 1-4 \n Day 1  Day 4 \n\n- \n- \n- {{user}}\n\"\"\n\n\n\n...\n{{user}}\n\n\n\n- 11:00-19:00 \n- 20:00 \n- 21:00 \n- 22:00+ ...\n\nAI\n1. \n2. \"\"\n3. {{user}}\n4. \n5. \n6. `,\n\n    prefill: `\n\n...\n\n......\n\n\n\n{{user}}\n\n\n\n\"`,\n  };\n}\n\n/**\n * \n * 2026-01-17 \n */\nexport function generateFalseEndingComplete(): string {\n  return ` - \n\n{{user}}\n\n\n{{user}}\n\n\"\"\n\n\n{{user}}\n{{user}}\n\"\"\n\n\n\n{{user}}\n\n\n\n...\n\n\n\n \n\n...\n\n`;\n}\n\n/**\n * \n */\nexport function generatePhaseTransitionHint(fromPhase: number, toPhase: number): string {\n  if (toPhase >= FALSE_ENDING_PHASES.length) {\n    return '';\n  }\n\n  const nextConfig = FALSE_ENDING_PHASES[toPhase];\n  return `${nextConfig.title}`;\n}\n\n/**\n * Prompt\n * 2026-01-17 \n * Bug #19: \n */\nexport function generateFalseEndingTimeBasedPrompt(\n  data: SchemaType,\n  state: FalseEndingState,\n  userInput: string,\n): string | null {\n  const guidanceType = getFalseEndingGuidanceType(data);\n  const currentHour = data..;\n\n  if (!guidanceType) {\n    return null;\n  }\n\n  switch (guidanceType) {\n    case 'preheat':\n    case 'dinner':\n    case 'main':\n      // Bug #19: \n      return generateFalseEndingPrompt(state, userInput, currentHour);\n\n    case 'free': {\n      // \n      return generateFalseEndingFreeTimePrompt(currentHour);\n    }\n\n    default:\n      return null;\n  }\n}\n","/**\n *  - \n *\n * \n * 1. \"\"\n * 2. \n * 3. 12\n * 4. \"\"\"\"\n *\n * \n * - Day 5, 11:00+ 51\n * - 5\n * -  = 31235\n * -  =   \n * -  = \n *\n * \n * - 10:00 5\n * - 11:00 0-3\n * - 20:00 \n * - 21:00 \n * - 22:00 \n * - 23:00 \n * - 00:00 4-11\n */\n\nimport type { Schema as SchemaType } from '../../schema';\nimport { getScene5LockedCoherence } from './scene5System';\n\n// ============================================\n// \n// ============================================\n\nexport interface PerfectEndingPhase {\n  phase: number;\n  name: string;\n  title: string;\n  description: string;\n  minTurns: number; // \n  maxTurns: number; // Bug #19\n  minHour?: number; // Bug #19\n  strict?: boolean; // Bug #19true=minHour\n  anchorEvents: string[]; // \n  aiGuidance: string; // AI\n  correctionHints: string[]; // \n  // Bug #15 \n  expectedActions?: string[]; // \n  hintThreshold?: number; // 2\n  progressHint?: string; // \n}\n\nexport const PERFECT_ENDING_PHASES: PerfectEndingPhase[] = [\n  // === 0 ===\n  {\n    phase: 0,\n    name: '',\n    title: '',\n    description: '11:00',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: 20-25\n    minHour: 11, // 11:00\n    anchorEvents: ['', ''],\n    aiGuidance: ` - 0\n\n\n\n\nDay 5, 11:0051\n\n\n\n- 16\n- 17\n- 20\n- \n\n\n\n\n\n- \n- \n- \n- \n\n\n\n\n{{user}}\"\"\n\nAI\n1. \n2. {{user}}\n3. \"...\"\n4. \n5. \n\n\n\n\n\n\n- \n- \n- \"\"`,\n    correctionHints: [\n      '{{user}}\"......\"',\n      '\"...\"',\n      '\"...\"\"\"',\n    ],\n  },\n\n  // === 1 ===\n  {\n    phase: 1,\n    name: '',\n    title: '',\n    description: '14:00',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    minHour: 14, // 2026-01-19: 14:00\n    strict: true,\n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 1\n\n\n\n\n- {{user}}\n- /\n- \n- {{user}}/\n\n\n\n- \n- \n- ...\n- \n\n\n\n-         \n- \"...\"\n- \"\"\n- \n\nAI\n1. {{user}}\n2. {{user}}\n3. \n4. ...\n5. \n\n  - \n-  \n-  \n-  \n-  \n-  \"\"\n\n \n- \"\"\n- \n- \n- \"\"{{user}}\"\"\n\n\n- \n- \n- `,\n    correctionHints: [\n      '{{user}}\"...\"',\n      '...',\n      '',\n    ],\n  },\n\n  // === 2 ===\n  {\n    phase: 2,\n    name: '',\n    title: '',\n    description: '16:00',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    minHour: 16, // 2026-01-19: 16:00\n    strict: true,\n    anchorEvents: ['', ''],\n    aiGuidance: ` - 2\n\n\n\n\n- \n- \n- {{user}}\n\n\n{{user}}\n- \"...\"\n- \"\"\n- \"...\"\n- \"...\"\n\n\n- \"\"\n- \"...\"\n- \"...\"\n- \"\"\n\n  - \n-  \n-  \n-  \n-  10\n-  \n\n \n\"\"\n1. ****/\n2. ****\n3. {{user}}****\n4. {{user}}\"\"\n5. \n\n\"\"\n\nAI\n1. \n2. {{user}}\n3. \n4. \"\"\n5. \n\n\n\n\n\"...\"`,\n    correctionHints: [\n      '\"\"',\n      '\"\"\"...\"',\n      '\"\"\"...\"',\n    ],\n  },\n\n  // === 3 ===\n  {\n    phase: 3,\n    name: '',\n    title: '',\n    description: '{{user}}',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', ''],\n    aiGuidance: ` - 3\n\n\n\n\n- \n- \n- {{user}}\n- \n\n\n- \n- {{user}}\n- \n- \"...\"\n\n\n- \n- {{user}}\n- \n- \n\nAI\n1. \n2. \n3. \n4. \n5. \"\"\n\n\n- \n- `,\n    correctionHints: [\n      '{{user}}\"...\"',\n      '',\n      '\"\"',\n    ],\n  },\n\n  // === 4 ===\n  {\n    phase: 4,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    minHour: 20, // Bug #19: 20:00\n    strict: true, // Bug #19: \n    anchorEvents: ['', ''],\n    aiGuidance: ` - 4\n\n\n\n\n- 20:00\n- {{user}}\n- \n- \"\"\n\n\n\n- \"\"\n- \"\"\n- \"\"\n\n\n- {{user}}\n- {{user}}\n- \n- \n\nAI\n1. \n2. {{user}}\n3. {{user}}\n4. {{user}}\n5. \n\n\n\n`,\n    correctionHints: [\n      '\"\"',\n      '',\n      '...',\n    ],\n  },\n\n  // === 5 ===\n  {\n    phase: 5,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', ''],\n    aiGuidance: ` - 5\n\n\n\n\n- \"\"\n- \n- \n\n\n\n- \n- \n- \n- \n- \n\nAI\n1. \n2. {{user}}\n3. \n4. \n5. \n\n\n\n`,\n    correctionHints: [\n      '\"\"',\n      '...',\n      '',\n    ],\n  },\n\n  // === 6 ===\n  {\n    phase: 6,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', ''],\n    aiGuidance: ` - 6\n\n\n\n\n\n\n\n- \n- \n- \n- \n- \n- \n\n\n- \n- \n- \"\"\n- \"...\"\n\nAI\n1. \n2. \n3. \n4. \"\"\n5. \n\n\n- \n- \n- `,\n    correctionHints: [\n      '',\n      '\"\"',\n      '',\n    ],\n  },\n\n  // === 7 ===\n  {\n    phase: 7,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 7\n\n\n\n\n- \n- {{user}}\n- \n\n\n\n- \"...\"\n- \"\"\n- \"\"\n\n\n- \"...\"\n- \"\"\n- \"...\"\n- \"\"\n- \"...\"\n- \"\"\n- \"\"\n\n\n- \"\"\n- \"\"\n- \"\"\n- \"...\"\n- \"\"\n\nAI\n1. \n2. \n3. \n4. \n5. \n\n\n\n`,\n    correctionHints: [\n      '\"...\"',\n      '\"\"\"...\"',\n      '\"\"\"\"',\n    ],\n  },\n\n  // === 8 ===\n  {\n    phase: 8,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 8\n\n{{user}}\n\n\n- \n- {{user}}\n- \n\n\n\n- \"...\"\n- \"...\"\n- \"...\"\n- \"...\"\n- \"...\"\n- \"...\"\n- \"\"\n\n{{user}}\n- \"\"\n- \"\"\n- \"\"\n\nAI\n1. {{user}}\n2. \n3. \n4. {{user}}\n5. \"\"\n\n\n\n`,\n    correctionHints: [\n      '{{user}}',\n      '\"......\"\"\"',\n      '{{user}}\"\"',\n    ],\n  },\n\n  // === 9 ===\n  {\n    phase: 9,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', ''],\n    aiGuidance: ` - 9\n\n{{user}}\n\n\n- \"...\"\n- {{user}}\n- \n\n\n{{user}}\n- \n- \n- \n- \n\nAI\n\n- \n- \n- \"\"\n\nAI\n1. {{user}}\n2. \n3. \n4. \n5. \"\"\n\n\n`,\n    correctionHints: [\n      '\"...\"',\n      '{{user}}',\n      '{{user}}',\n    ],\n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint:\n      '\"...\"',\n  },\n\n  // === 10 ===\n  {\n    phase: 10,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', ''],\n    aiGuidance: ` - 10\n\n\n\n\n- \n- \n- \n\n\n\n1. \n2. \n3. \n4. {{user}}\n5. \n\n\n- \"...\"\n- \"\"\n- \"...\"\n\n\n10\n- \n- \n- \"\"\n\nAI\n1. \n2. \n3. \n4. \n5. {{user}}\n6. \n\n\n\n`,\n    correctionHints: [\n      '',\n      '',\n      '\"\"{{user}}\"\"',\n    ],\n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint:\n      '\"\"...',\n  },\n\n  // === 11 ===\n  {\n    phase: 11,\n    name: '',\n    title: '',\n    description: '',\n    minTurns: 1,\n    maxTurns: 2, // Bug #19: \n    anchorEvents: ['', '', ''],\n    aiGuidance: ` - 11\n\n\n\n\n- \n- \n- \n\n\n\n- \"\"\n- \"\"\n- \"...\"\n\n\n- \n- \n- {{user}}\n\n\n- \n- \n- \n- \n\n\n- \"...\"\n- \"\"\n- \"\"\n\nAI\n1. \n2. \n3. \n4. \n5. \n6. \n\n\n\n- \n- \n- `,\n    correctionHints: [], // \n    // Bug #15 \n    expectedActions: ['', '', '', '', '', '', ''],\n    hintThreshold: 2,\n    progressHint:\n      '...\"\"...',\n  },\n];\n\n// ============================================\n// \n// ============================================\n\nexport interface PerfectEndingState {\n  isActive: boolean; // \n  currentPhase: number; //  (0-11)\n  turnsInPhase: number; // \n  completedAnchors: string[]; // \n  totalTurns: number; // \n  isComplete: boolean; // \n  // Bug #15 \n  noProgressTurns: number; // \n  hintGiven: boolean; // \n}\n\n/**\n * \n */\nexport function getDefaultPerfectEndingState(): PerfectEndingState {\n  return {\n    isActive: false,\n    currentPhase: 0,\n    turnsInPhase: 0,\n    completedAnchors: [],\n    totalTurns: 0,\n    isComplete: false,\n    // Bug #15 \n    noProgressTurns: 0,\n    hintGiven: false,\n  };\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n *\n * \n * 1. Day 5, 11:00+\n * 2. \n * 3. \n * 4. 5\n * 5.  = 3\n */\nexport function shouldActivatePerfectEnding(data: SchemaType): boolean {\n  // 1Day 5, 11:00+\n  const day = data..;\n  const hour = data..;\n  if (day < 5 || (day === 5 && hour < 11)) {\n    return false;\n  }\n\n  // 2\n  const validStates = ['', '', ''];\n  if (!validStates.includes(data..)) {\n    return false;\n  }\n\n  // 3\n  const currentEnding = data..;\n  if (currentEnding !== '') {\n    return false;\n  }\n\n  // 45\n  const completedScenes = data..;\n  const correctScenes = data..;\n\n  const allCompleted = [1, 2, 3, 4, 5].every(s => completedScenes.includes(s));\n  const allCorrect = [1, 2, 3, 4, 5].every(s => correctScenes.includes(s));\n\n  if (!allCompleted || !allCorrect) {\n    return false;\n  }\n\n  // 5 = 3\n  const coherence = getScene5LockedCoherence(data);\n  if (coherence !== 3) {\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * 21:00  23:00\n */\nexport function isPerfectEndingFreeTime(data: SchemaType): boolean {\n  const day = data..;\n  const hour = data..;\n\n  //  Day 5  21:00  23:00 \n  if (day === 5 && (hour === 21 || hour === 23)) {\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Schema\n */\nexport function isPerfectEndingActive(data: SchemaType): boolean {\n  const endingState = (data as any). as PerfectEndingState | undefined;\n  return endingState?.isActive === true;\n}\n\n/**\n * \n */\nexport function getPerfectEndingState(data: SchemaType): PerfectEndingState {\n  const endingState = (data as any). as PerfectEndingState | undefined;\n  return endingState ?? getDefaultPerfectEndingState();\n}\n\n/**\n * \n */\nexport function updatePerfectEndingState(data: SchemaType, state: PerfectEndingState): void {\n  (data as any). = state;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nconst PERFECT_ANCHOR_KEYWORDS: Record<string, string[]> = {\n  // 0\n  : ['', '', '', '', '', ''],\n  : ['', '', '', '', ''],\n\n  // 1\n  : ['', '', '', '', ''],\n  : ['.*', '', '.*', ''],\n  : ['.*', '', '', '', ''],\n\n  // 2\n  : ['', '', '', ''],\n  : ['', '', '', ''],\n\n  // 3\n  : ['', '', '', '', ''],\n  : ['', '', '', ''],\n\n  // 4\n  : ['', '', '', ''],\n  : ['', '', '.*', '.*'],\n\n  // 5\n  : ['', '', '', ''],\n  : ['', '', '', '', ''],\n\n  // 6\n  : ['', '', '', ''],\n  : ['', '', '', '', '', ''],\n\n  // 7\n  : ['', '', '', ''],\n  : ['', '', '.*', ''],\n  : ['', '', '', '', '', ''],\n\n  // 8\n  : ['', '', '', '.*'],\n  : ['', '', '', '', ''],\n  : ['', '', '.*'],\n\n  // 9\n  : ['', '', ''],\n  : ['', '', ''],\n\n  // 10\n  : ['', '.*', ''],\n  : ['.*', '.*', ''],\n\n  // 11\n  : ['', '.*', '.*'],\n  : ['', '', '.*'],\n  : ['', '', ''],\n};\n\n/**\n * AI\n */\nexport function detectPerfectAnchors(aiResponse: string, phase: number): string[] {\n  const phaseConfig = PERFECT_ENDING_PHASES[phase];\n  if (!phaseConfig) return [];\n\n  const completed: string[] = [];\n\n  for (const anchor of phaseConfig.anchorEvents) {\n    const keywords = PERFECT_ANCHOR_KEYWORDS[anchor] || [];\n    const isCompleted = keywords.some(kw => {\n      // \n      if (kw.includes('.*')) {\n        const regex = new RegExp(kw, 'i');\n        return regex.test(aiResponse);\n      }\n      return aiResponse.includes(kw);\n    });\n\n    if (isCompleted) {\n      completed.push(anchor);\n    }\n  }\n\n  return completed;\n}\n\n// ============================================\n// Bug #15 \n// ============================================\n\n/**\n * \n * @param userInput \n * @param phase \n * @returns \n */\nexport function hasExpectedAction(userInput: string, phase: number): boolean {\n  const phaseConfig = PERFECT_ENDING_PHASES[phase];\n  if (!phaseConfig || !phaseConfig.expectedActions || phaseConfig.expectedActions.length === 0) {\n    // \n    return true;\n  }\n\n  const lowerInput = userInput.toLowerCase();\n  return phaseConfig.expectedActions.some(action => lowerInput.includes(action.toLowerCase()));\n}\n\n/**\n * \n * @param state \n * @param userInput \n * @returns  null\n */\nexport function checkProgressHint(state: PerfectEndingState, userInput: string): string | null {\n  const phaseConfig = PERFECT_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig) return null;\n\n  // \n  if (state.hintGiven) return null;\n\n  // \n  if (!phaseConfig.progressHint) return null;\n\n  // \n  const hasAction = hasExpectedAction(userInput, state.currentPhase);\n\n  // \n  if (hasAction) return null;\n\n  // \n  const threshold = phaseConfig.hintThreshold ?? 2;\n  if (state.noProgressTurns + 1 >= threshold) {\n    return phaseConfig.progressHint;\n  }\n\n  return null;\n}\n\n/**\n * \n * @param state \n * @param userInput \n * @returns \n */\nexport function updateProgressTracking(\n  state: PerfectEndingState,\n  userInput: string,\n): {\n  updatedState: PerfectEndingState;\n  hint: string | null;\n} {\n  const hasAction = hasExpectedAction(userInput, state.currentPhase);\n\n  if (hasAction) {\n    // \n    return {\n      updatedState: {\n        ...state,\n        noProgressTurns: 0,\n      },\n      hint: null,\n    };\n  }\n\n  // \n  const newNoProgressTurns = state.noProgressTurns + 1;\n  const hint = checkProgressHint({ ...state, noProgressTurns: newNoProgressTurns - 1 }, userInput);\n\n  return {\n    updatedState: {\n      ...state,\n      noProgressTurns: newNoProgressTurns,\n      hintGiven: hint !== null ? true : state.hintGiven,\n    },\n    hint,\n  };\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * Bug #19: \n * @param state \n * @param currentHour \n * @returns \n */\nexport function canEnterNextPerfectPhase(\n  state: PerfectEndingState,\n  currentHour: number,\n): { blocked: boolean; reason?: string; waitHours?: number } {\n  const nextPhase = state.currentPhase + 1;\n  if (nextPhase >= PERFECT_ENDING_PHASES.length) {\n    return { blocked: false };\n  }\n\n  const nextConfig = PERFECT_ENDING_PHASES[nextPhase];\n  if (!nextConfig) return { blocked: false };\n\n  // \n  if (nextConfig.minHour !== undefined && nextConfig.strict) {\n    if (currentHour < nextConfig.minHour) {\n      const waitHours = nextConfig.minHour - currentHour;\n      return {\n        blocked: true,\n        reason: `${nextConfig.name} ${nextConfig.minHour}:00 `,\n        waitHours,\n      };\n    }\n  }\n\n  return { blocked: false };\n}\n\n/**\n * \n * Bug #19:  maxTurns \n * Bug #40 maxTurns \n */\nexport function shouldAdvancePerfectPhase(state: PerfectEndingState, currentHour?: number): boolean {\n  const phaseConfig = PERFECT_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig) return false;\n\n  // Bug #40 \n  //  maxTurns \n  if (currentHour !== undefined) {\n    const canEnter = canEnterNextPerfectPhase(state, currentHour);\n    if (canEnter.blocked) {\n      // \n      return false;\n    }\n  }\n\n  // Bug #19: \n  if (phaseConfig.maxTurns && state.turnsInPhase >= phaseConfig.maxTurns) {\n    console.info(\n      `[] ${state.currentPhase}(${phaseConfig.name}) ${phaseConfig.maxTurns}`,\n    );\n    return true;\n  }\n\n  // \n  if (state.turnsInPhase < phaseConfig.minTurns) {\n    return false;\n  }\n\n  // \n  const allAnchorsComplete = phaseConfig.anchorEvents.every(anchor => state.completedAnchors.includes(anchor));\n\n  return allAnchorsComplete;\n}\n\n/**\n * \n */\nexport function advanceToPerfectNextPhase(state: PerfectEndingState): PerfectEndingState {\n  const nextPhase = state.currentPhase + 1;\n\n  // \n  if (nextPhase >= PERFECT_ENDING_PHASES.length) {\n    return {\n      ...state,\n      isComplete: true,\n    };\n  }\n\n  return {\n    ...state,\n    currentPhase: nextPhase,\n    turnsInPhase: 0,\n    completedAnchors: [], // \n    // Bug #15 \n    noProgressTurns: 0,\n    hintGiven: false,\n  };\n}\n\n/**\n * \n * Bug #19: \n */\nexport function processPerfectTurnEnd(\n  state: PerfectEndingState,\n  aiResponse: string,\n  userInput?: string,\n  currentHour?: number,\n): {\n  newState: PerfectEndingState;\n  phaseAdvanced: boolean;\n  newPhase: number | null;\n  timeBlocked?: { reason: string; waitHours: number };\n} {\n  // \n  let newState: PerfectEndingState = {\n    ...state,\n    turnsInPhase: state.turnsInPhase + 1,\n    totalTurns: state.totalTurns + 1,\n  };\n\n  // \n  const newAnchors = detectPerfectAnchors(aiResponse, state.currentPhase);\n  const allAnchors = [...new Set([...newState.completedAnchors, ...newAnchors])];\n  newState.completedAnchors = allAnchors;\n\n  // \n  let phaseAdvanced = false;\n  let newPhase: number | null = null;\n\n  if (shouldAdvancePerfectPhase(newState, currentHour)) {\n    // Bug #19: \n    if (currentHour !== undefined) {\n      const timeCheck = canEnterNextPerfectPhase(newState, currentHour);\n      if (timeCheck.blocked) {\n        // \n        return {\n          newState,\n          phaseAdvanced: false,\n          newPhase: null,\n          timeBlocked: {\n            reason: timeCheck.reason || '',\n            waitHours: timeCheck.waitHours || 1,\n          },\n        };\n      }\n    }\n\n    newState = advanceToPerfectNextPhase(newState);\n    phaseAdvanced = true;\n    newPhase = newState.currentPhase;\n  }\n\n  return { newState, phaseAdvanced, newPhase };\n}\n\n// ============================================\n// AI Prompt \n// ============================================\n\n/**\n * AIPrompt\n * Bug #19: \n * Bug #40 \"\"\n * @param state \n * @param userInput \n * @param currentHour \n */\nexport function generatePerfectEndingPrompt(\n  state: PerfectEndingState,\n  userInput: string,\n  currentHour?: number,\n): string {\n  const phaseConfig = PERFECT_ENDING_PHASES[state.currentPhase];\n  if (!phaseConfig) return '';\n\n  // \n  const remainingAnchors = phaseConfig.anchorEvents.filter(a => !state.completedAnchors.includes(a));\n\n  // Bug #40 \n  const hour = currentHour ?? 12;\n  const nextPhaseCheck = canEnterNextPerfectPhase(state, hour);\n  const isTimeLocked = nextPhaseCheck.blocked;\n\n  // Bug #40 \"\"\n  let turnsWarning: string;\n  if (isTimeLocked) {\n    turnsWarning = `${PERFECT_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00`;\n  } else {\n    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;\n    turnsWarning =\n      remainingTurns <= 2 ? ` ${remainingTurns}` : `${remainingTurns}`;\n  }\n\n  // Bug #40 \n  let urgencyHint = '';\n  if (!isTimeLocked) {\n    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;\n    if (remainingTurns <= 1) {\n      urgencyHint = '\\n\\n 1';\n    } else if (remainingTurns <= 2) {\n      urgencyHint = `\\n\\n ${remainingTurns} `;\n    }\n  }\n\n  // Bug #15 \n  let hintSection = '';\n  if (phaseConfig.progressHint && state.noProgressTurns >= (phaseConfig.hintThreshold ?? 2) && !state.hintGiven) {\n    hintSection = `\\n\\n  - \n\n\"${phaseConfig.progressHint}\"\n\n\n- \n- /\n- `;\n  }\n\n  // Bug #40 \n  const timeBlockWarning = isTimeLocked\n    ? `\\n \"${PERFECT_ENDING_PHASES[state.currentPhase + 1]?.name}\"${PERFECT_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00${hour}:00\n `\n    : '';\n\n  // \n  const progressInfo = `\n- ${state.currentPhase + 1}/${PERFECT_ENDING_PHASES.length}${phaseConfig.name}\n- ${state.turnsInPhase}${turnsWarning}\n- ${remainingAnchors.length > 0 ? remainingAnchors.join('') : ''}\n- ${state.totalTurns}${timeBlockWarning}`;\n\n  // Prompt\n  return `${phaseConfig.aiGuidance}\n\n${progressInfo}${urgencyHint}${hintSection}\n\n\n- \n- \n- \n- \"\"\"\"\n- \n- `;\n}\n\n/**\n * \n */\nexport function getPerfectCorrectionHint(phase: number): string | null {\n  const phaseConfig = PERFECT_ENDING_PHASES[phase];\n  if (!phaseConfig || phaseConfig.correctionHints.length === 0) {\n    return null;\n  }\n\n  // \n  const index = Math.floor(Math.random() * phaseConfig.correctionHints.length);\n  return phaseConfig.correctionHints[index];\n}\n\n/**\n * \n */\nexport function generatePerfectEndingEntryReplacement(): {\n  userMessage: string;\n  prefill: string;\n} {\n  const userMessage = `[ - ]\n\n Day 5, 11:00\n5\n\n\n\n5\n- 116- \n- 217- \n- 323- \n- 428- \n- 5- \n\n.X.\n\nDay 1-4 \n Day 1  Day 4 \n\n- \n- {{user}}\n- \n\"\"\n\n\n5123\n\n- 16\n- 17\n- 20\n- 25\n\n\n\n\n\n\n- \n- \n- \n- \"\"\"\"\n\n\n\n\n\n\n\n- 11:00-19:00 \n- 20:00 \n- 21:00 \n- 22:00 \n- 23:00 \n- 00:00 \n\nAI\n1. \n2. {{user}}\n3. \"...\"\n4. `;\n\n  const prefill = `\n\n\n\n\n\n...\n\n\n\n\"\"\n\n\n\n\"...\"\n\n\n\n\n\"`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * \n */\nexport function generatePerfectPhaseTransitionHint(_fromPhase: number, toPhase: number): string {\n  const toConfig = PERFECT_ENDING_PHASES[toPhase];\n  if (!toConfig) return '';\n\n  return `\\n\\n---\\n${toConfig.name}${toConfig.title}\\n---\\n`;\n}\n\n/**\n * \n */\nexport function generatePerfectEndingComplete(): string {\n  return `\n\n\n\nPERFECT TRUE END\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\"\"\n\n\n\n\n\"\"\n\"...\"\n\"\"\n\n\n\n\n\n\n\n \n \n\n`;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * 21:00  23:00\n */\nexport function generatePerfectFreeTimePrompt(hour: number): string {\n  const nextHour = hour + 1;\n  const nextEvent = hour === 21 ? '22:00' : '00:00';\n\n  return ` - ${hour}:00\n\n${nextEvent}\n\n - \n\n\n\n- \n- {{user}}\n- \n\nAI\n1. \n2. {{user}}\n3. \n4. \n\n\n\n\n- {{user}}\n- \n- \n\n${nextHour}:00`;\n}\n\n/**\n * \n */\nexport function getPerfectGuidanceType(data: SchemaType): 'normal' | 'free' | 'ceremony' | null {\n  const day = data..;\n  const hour = data..;\n\n  // Day 6+  'ceremony' \n  if (day > 5) {\n    return 'ceremony';\n  }\n\n  if (day !== 5) return null;\n\n  // 11:00-19:00 \n  if (hour >= 11 && hour < 20) {\n    return 'normal';\n  }\n\n  // 20:00 \n  if (hour === 20) {\n    return 'ceremony';\n  }\n\n  // 21:00 \n  if (hour === 21) {\n    return 'free';\n  }\n\n  // 22:00 \n  if (hour === 22) {\n    return 'ceremony';\n  }\n\n  // 23:00 \n  if (hour === 23) {\n    return 'free';\n  }\n\n  // 00:00+ \n  if (hour === 0 || hour >= 24) {\n    return 'ceremony';\n  }\n\n  return null;\n}\n","/**\n *  - \n *\n * 55\"\"\n *\n * \n * - 580\n * - 100\n *\n * \n * 1. \n *    - =3+73100808794101\n *    - <3+1021008090100\n * 2. 3-5100\n *\n * \n * - 2026-01-19 5\n * - 5\n * - \"\"\"\"\n * - \n *\n * \n * - \n * - \n * -  > \n * - \"\"\n */\n\nimport type { Schema as SchemaType } from '../../schema';\nimport { calculateMemoryCoherence } from './scene5System';\n\n// =============================================\n// \n// =============================================\n\nexport type ConfusionEndingType = '' | '';\n\nexport interface ConfusionEndingCheckResult {\n  triggered: boolean;\n  type: ConfusionEndingType;\n  replaceUserMessage: string | null;\n  isFirstTrigger: boolean; // \n}\n\nexport interface SexualBehaviorCheckResult {\n  detected: boolean;\n  shouldWarn: boolean; // \n  shouldMarkConfusion: boolean; // \n  warningMessage: string | null; // \n  currentCount: number; // \n  maxAllowed: number; // \n}\n\nexport interface InterruptionCheckResult {\n  detected: boolean;\n  shouldMarkConfusion: boolean;\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n *  = \n */\nconst SEXUAL_BEHAVIOR_KEYWORDS = {\n  // \n  : [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n  ],\n\n  // +\n  : {\n    : ['', '', '', '', '', '', '', '', '', ''],\n    : ['', '', '', '', '', '', '', '', '', '', '', ''],\n  },\n};\n\n/**\n * \n * 3-5\n */\nconst INTERRUPTION_KEYWORDS = [\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n];\n\n// =============================================\n// \n// =============================================\n\n/**\n *  - \n */\nconst CONFUSION_INITIAL_TEMPLATES = [\n  // 1\n  () => `[ - ]\n\n\n\n\n\n\n\n\n\n\n\n\"\"\n\n\n\n...\n\n\n\n\n\"......\"\n\n\"\"\n\nBAD END: \n`,\n\n  // 2\n  () => `[ - ]\n\n\n\n\n\n\"\"\n\n\n\n\n\n\n\n\"......\"\n\n\"......\"\n\n\n\n\n\n\"...\"\n\n\"\"\n\n\n\"...\"\n\nBAD END: \n`,\n\n  // 3\n  () => `[ - ]\n\n\"......\"\n\n\n\n\n\"......\"\n\n\"......\"\n\n\n\n\"......\"\n\n\"\"\n\n\n\n\n\n\"\"\n\n\"...\"\n\n\n\"......\"\n\nBAD END: \n`,\n];\n\n/**\n *  - \n */\nconst CONFUSION_LOCKED_TEMPLATES = [\n  // 1\n  () => `[]\n\n\n\n\n\n\"\"...\n\n\n\n\n\n\nBAD END: \n`,\n\n  // 2\n  () => `[]\n\n\n\n\n\n\n\"...\"\n\"......\"\n\n\n\n\n\nBAD END: \n`,\n\n  // 3\n  () => `[]\n\n\n\"\"\n\n\n\n\n...\n\n\n\n\nBAD END: \n`,\n];\n\n/**\n * \n * @param confusion \n */\nconst SEXUAL_WARNING_TEMPLATES = {\n  // 1 80  90\n  nonPerfectFirstWarning: (confusion: number) => `...\n\n\"......\"\n\n\".........\"\n\n\n${confusion}/100`,\n\n  // 1 80  87\n  perfectFirstWarning: (confusion: number) => `...\n\n\"......\"\n\n\"......\"\n\n\n${confusion}/100`,\n\n  // 2 87  94\n  perfectSecondWarning: (confusion: number) => `...\n\n\"......\"\n\n\"......\"\n\n\n${confusion}/100`,\n};\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n */\nfunction randomChoice<T>(arr: T[]): T {\n  return arr[Math.floor(Math.random() * arr.length)];\n}\n\n/**\n * \n * @param day 1-5\n * @param hour 0-23\n * @returns \n */\nfunction calculateGlobalHour(day: number, hour: number): number {\n  return (day - 1) * 24 + hour;\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n * @param userInput \n * @returns \n */\nexport function detectSexualBehavior(userInput: string): boolean {\n  // 1. \n  const hasDirectKeyword = SEXUAL_BEHAVIOR_KEYWORDS..some(kw => userInput.includes(kw));\n  if (hasDirectKeyword) {\n    console.info(`[] `);\n    return true;\n  }\n\n  // 2.  + \n  const hasAction = SEXUAL_BEHAVIOR_KEYWORDS...some(kw => userInput.includes(kw));\n  const hasPart = SEXUAL_BEHAVIOR_KEYWORDS...some(kw => userInput.includes(kw));\n\n  if (hasAction && hasPart) {\n    console.info(`[] +`);\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * \n * @param userInput \n * @returns \n */\nexport function detectWeddingInterruption(userInput: string): boolean {\n  const hasInterruption = INTERRUPTION_KEYWORDS.some(kw => userInput.includes(kw));\n  if (hasInterruption) {\n    console.info(`[] `);\n  }\n  return hasInterruption;\n}\n\n/**\n * =3\n *\n * Bug #30 2026-01-18\n * -  data.. \n * - 550\n * -  calculateMemoryCoherence() \n * - 51-2-3\n *\n * @param data \n * @returns \n */\nexport function isPerfectMemoryRoute(data: SchemaType): boolean {\n  // Bug #30 \n  const coherence = calculateMemoryCoherence(data);\n  return coherence.level === 3;\n}\n\n/**\n * \n * - =3+73100\n * - <3+102100\n *\n * @param data \n * @returns \n */\nexport function getViolationIncrement(data: SchemaType): number {\n  return isPerfectMemoryRoute(data) ? 7 : 10;\n}\n\n/**\n * \n * 5\n *\n * \n * - 580\n * - =3+73100808794101\n * - <3+1021008090100\n *\n * @param data \n * @param userInput \n * @returns \n */\nexport function checkSexualBehaviorInScene5(data: SchemaType, userInput: string): SexualBehaviorCheckResult {\n  const detected = detectSexualBehavior(userInput);\n  const isPerfect = isPerfectMemoryRoute(data);\n  const increment = getViolationIncrement(data);\n  const currentConfusion = data..;\n\n  if (!detected) {\n    return {\n      detected: false,\n      shouldWarn: false,\n      shouldMarkConfusion: false,\n      warningMessage: null,\n      currentCount: data..?. ?? 0,\n      maxAllowed: isPerfect ? 3 : 2,\n    };\n  }\n\n  // \n  if (!data..) {\n    data.. = {\n      : false,\n      : null,\n      : null,\n      : false,\n      : null,\n      : 0,\n    };\n  }\n\n  // \n  const newCount = (data... ?? 0) + 1;\n  data... = newCount;\n\n  // \n  const newConfusion = Math.min(100, currentConfusion + increment);\n  data.. = newConfusion;\n\n  console.info(\n    `[] 5` +\n      `=${isPerfect ? '' : ''}` +\n      ` ${currentConfusion}  ${newConfusion} (+${increment})` +\n      `=${newCount}`,\n  );\n\n  // 100\n  if (newConfusion >= 100) {\n    // 100\n    return {\n      detected: true,\n      shouldWarn: false,\n      shouldMarkConfusion: true,\n      warningMessage: null,\n      currentCount: newCount,\n      maxAllowed: isPerfect ? 3 : 2,\n    };\n  } else {\n    // \n    let warningMessage: string;\n    if (isPerfect) {\n      // 187294\n      if (newCount === 1) {\n        warningMessage = SEXUAL_WARNING_TEMPLATES.perfectFirstWarning(newConfusion);\n      } else {\n        warningMessage = SEXUAL_WARNING_TEMPLATES.perfectSecondWarning(newConfusion);\n      }\n    } else {\n      // 190\n      warningMessage = SEXUAL_WARNING_TEMPLATES.nonPerfectFirstWarning(newConfusion);\n    }\n\n    return {\n      detected: true,\n      shouldWarn: true,\n      shouldMarkConfusion: false,\n      warningMessage,\n      currentCount: newCount,\n      maxAllowed: isPerfect ? 3 : 2,\n    };\n  }\n}\n\n/**\n * \n * 3-5\n *\n * 100\n *\n * @param data \n * @param userInput \n * @returns \n */\nexport function checkWeddingInterruptionInScene5(data: SchemaType, userInput: string): InterruptionCheckResult {\n  // 3-5\n  const currentStep = data..5?. ?? 0;\n  if (currentStep < 3 || currentStep > 5) {\n    return { detected: false, shouldMarkConfusion: false };\n  }\n\n  const detected = detectWeddingInterruption(userInput);\n  if (detected) {\n    // 100\n    const oldConfusion = data..;\n    data.. = 100;\n    console.info(`[] ${currentStep}` + ` ${oldConfusion}  100`);\n  }\n\n  return {\n    detected,\n    shouldMarkConfusion: detected, // \n  };\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * 5\n *\n * 2026-01-19 5\n * - \"\"\"\"\n * - \n *\n * @param data \n * @param reason \n */\nexport function markConfusionEnding(data: SchemaType, reason: '' | ''): void {\n  // \n  if (!data..) {\n    data.. = {\n      : false,\n      : null,\n      : null,\n      : false,\n      : null,\n      : 0,\n    };\n  }\n\n  // \n  if (data...) {\n    console.info(`[] `);\n    return;\n  }\n\n  // \n  const currentGlobalHour = calculateGlobalHour(data.., data..);\n\n  // \n  data... = true;\n  data... = currentGlobalHour;\n  data... = currentGlobalHour;\n  data... = reason;\n  data... = true; // \n\n  console.info(`[] 5=${reason}=${currentGlobalHour}`);\n}\n\n/**\n * \n *\n * 2026-01-19 \n * - 5\n * - =true\n * - \"\"\n *\n * @param data \n * @param forceFirstTrigger \n * @returns \n */\nexport function checkConfusionEnding(data: SchemaType, forceFirstTrigger = false): ConfusionEndingCheckResult {\n  const confusion = data..;\n\n  // \n  if (confusion?.) {\n    return {\n      triggered: true,\n      type: '',\n      replaceUserMessage: forceFirstTrigger\n        ? randomChoice(CONFUSION_INITIAL_TEMPLATES)()\n        : randomChoice(CONFUSION_LOCKED_TEMPLATES)(),\n      isFirstTrigger: forceFirstTrigger,\n    };\n  }\n\n  // \n  return {\n    triggered: false,\n    type: '',\n    replaceUserMessage: null,\n    isFirstTrigger: false,\n  };\n}\n\n/**\n * \n *\n * 2026-01-19 5\n * - \"\"\n * - \n *\n * @param data \n */\nexport function applyConfusionEndingState(data: SchemaType): void {\n  // \n  if (!data..) {\n    data.. = {\n      : false,\n      : null,\n      : null,\n      : false,\n      : null,\n      : 0,\n    };\n  }\n\n  // \n  data... = true;\n\n  // \n  data.. = '';\n  data.. = '';\n\n  // \n  data.. = true;\n\n  console.info(`[] `);\n}\n\n/**\n * \n *\n * @param data \n * @returns \n */\nexport function isInConfusionEndingLock(data: SchemaType): boolean {\n  return data..?. === true;\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n *\n * 2026-01-19 5\n * \n *\n * @param data \n * @returns \n */\nexport function canEnterDreamForConfusion(data: SchemaType): boolean {\n  // \n  if (data..?.) {\n    console.info(`[] `);\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * \n *\n * 2026-01-19 \n * 5\"\"\n *\n * @param _data \n * @returns null\n */\nexport function getConfusionForeshadowing(_data: SchemaType): string | null {\n  // null\n  return null;\n}\n\n// =============================================\n// 5\n// =============================================\n\n/**\n * 5\n * \n *\n * @param data \n * @param userInput \n * @returns \n */\nexport function checkScene5Violations(\n  data: SchemaType,\n  userInput: string,\n): {\n  shouldMarkConfusion: boolean;\n  shouldWarn: boolean;\n  warningMessage: string | null;\n  reason: '' | '' | null;\n} {\n  // 1. \n  const interruptionResult = checkWeddingInterruptionInScene5(data, userInput);\n  if (interruptionResult.shouldMarkConfusion) {\n    return {\n      shouldMarkConfusion: true,\n      shouldWarn: false,\n      warningMessage: null,\n      reason: '',\n    };\n  }\n\n  // 2. \n  const sexualResult = checkSexualBehaviorInScene5(data, userInput);\n  if (sexualResult.shouldMarkConfusion) {\n    return {\n      shouldMarkConfusion: true,\n      shouldWarn: false,\n      warningMessage: null,\n      reason: '',\n    };\n  }\n\n  if (sexualResult.shouldWarn) {\n    return {\n      shouldMarkConfusion: false,\n      shouldWarn: true,\n      warningMessage: sexualResult.warningMessage,\n      reason: null,\n    };\n  }\n\n  return {\n    shouldMarkConfusion: false,\n    shouldWarn: false,\n    warningMessage: null,\n    reason: null,\n  };\n}\n\n// =============================================\n// \n// =============================================\n\n/**\n * \n */\nconst SCENE_CONFUSION_VALUES: Record<number, number> = {\n  1: 40, // 1: 40\n  2: 60, // 2: 60\n  3: 80, // 3: 80\n  4: -1, // 4: -1\n  5: 80, // 5: 80\n};\n\n/**\n * \n *\n * 0\n * - 1: 40\n * - 2: 60\n * - 3: 80\n * - 4: \n * - 5: 80\n *\n * @param data \n * @param sceneNumber 1-5\n */\nexport function setConfusionOnDreamEntry(data: SchemaType, sceneNumber: number): void {\n  const targetValue = SCENE_CONFUSION_VALUES[sceneNumber];\n\n  if (targetValue === undefined) {\n    console.warn(`[] : ${sceneNumber}`);\n    return;\n  }\n\n  // 4\n  if (targetValue === -1) {\n    console.info(`[] ${sceneNumber}: ${data..}`);\n    return;\n  }\n\n  const oldValue = data..;\n\n  // 580\n  if (sceneNumber === 5) {\n    data.. = targetValue;\n    console.info(`[] 5: ${targetValue} (: ${oldValue})`);\n  } else if (oldValue < targetValue) {\n    data.. = targetValue;\n    console.info(`[] ${sceneNumber}: ${targetValue} (: ${oldValue})`);\n  } else {\n    console.info(`[] ${sceneNumber}: ${oldValue}`);\n  }\n}\n","/**\n *  - \n *\n * \"\"\n *\n * \n * - 2\n * -  +1\n * - \n *\n * \n * - \n * - \n * - \n * - /\n *\n * \n * -  \"Day X X\"\n * - / {{datetimeformat::YYYYMD}}\n */\n\nimport type { Schema as SchemaType } from '../../schema';\n\n// ============================================\n// \n// ============================================\n\nexport type AfterStoryType = '' | '' | '' | null;\n\nexport interface AfterStoryState {\n  : boolean;\n  : number;\n  : boolean;\n  : boolean;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n * \n */\nconst PERFECT_TRUE_AFTER_STORY = {\n  type: '' as const,\n  husbandStatus: '',\n  interruptionLevel: 0, // \n\n  // 1\n  round1: {\n    title: '',\n    setting: `\n\n\n{{user}}\n\n\"\"`,\n    aiGuidance: ` - 1\n\n\n\n\n- \n- \n- \n- \n\n\n- {{user}}\n- \n- {{user}}\n\nAI\n1. \n2. \n3. \n4. \n5. \"\"`,\n  },\n\n  // 2\n  round2: {\n    title: '',\n    setting: `{{user}}\n...\n`,\n    aiGuidance: ` - 2\n\n\n- \n- {{user}}\n- ...\n- {{user}}\n\n\n- {{user}}\n- \"\"\n\nAI\n1. \n2. {{user}}\n3. \"\"\"\"\n4. \n5. \"\"\n\n\n\n`,\n  },\n};\n\n/**\n * \n * +\n */\nconst TRUE_ENDING_AFTER_STORY = {\n  type: '' as const,\n  husbandStatus: '',\n  interruptionLevel: 0, // \n\n  round1: {\n    title: '',\n    setting: `\n\n\n\n\"\"\n\n\n\n\n{{user}}`,\n    aiGuidance: ` - 1\n\n\n\n\n- ICU\"\"\n- \n- \n\n\n- {{user}}\n- ...\n- \"\"\n- \n- \n\nAI\n1. \n2. \n3. \n4. \"\"\n5. \"\"`,\n  },\n\n  round2: {\n    title: '',\n    setting: `\n{{user}}\n`,\n    aiGuidance: ` - 2\n\n\n\n\n- {{user}}\n- \n- \n\n\n- {{user}}\n- \n- \"\"\n- {{user}}\n\nAI\n1. \n2. {{user}}\n3. \"\"\n4. \n5. \n\n\n\n`,\n  },\n};\n\n/**\n * \n * \n */\nconst FALSE_ENDING_AFTER_STORY = {\n  type: '' as const,\n  husbandStatus: '',\n  interruptionLevel: 50, // \n\n  round1: {\n    title: '',\n    setting: `\n\n{{user}}\n\n\n`,\n    aiGuidance: ` - 1\n\n\n\n\n- /\n- \n- \"\"\n- \n\n\n- {{user}}\n- \n- \n- \n\nAI\n1. \n2. \"\"\n3. \n4. \n5. \n\n\n\n- \n- \n- `,\n  },\n\n  round2: {\n    title: '',\n    setting: `\n\"...\"\n`,\n    aiGuidance: ` - 2\n\n\n- \n- {{user}}\n- \n\n\n- \n- \n- \n- \n\n\n- \n- \n- \n\nAI\n1. \n2. \n3. \n4. \n5. \n\n\n\n\n`,\n  },\n};\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport function getAfterStoryType(data: SchemaType): AfterStoryType {\n  const ending = data..;\n\n  switch (ending) {\n    case '':\n      return '';\n    case '':\n      return '';\n    case '':\n      return '';\n    default:\n      return null;\n  }\n}\n\n/**\n * \n *  +  + \n */\nexport function shouldTriggerAfterStory(data: SchemaType): boolean {\n  // \n  const type = getAfterStoryType(data);\n  if (!type) return false;\n\n  // \n  if (!data..) return false;\n\n  // \n  if (data..?.) return false;\n\n  return true;\n}\n\n/**\n * \n */\nexport function isInAfterStory(data: SchemaType): boolean {\n  return data..?. === true && data..?. !== true;\n}\n\n/**\n * \n */\nexport function isInFreeMode(data: SchemaType): boolean {\n  return data..?. === true;\n}\n\n/**\n * \n */\nexport function shouldShowRealDate(data: SchemaType): boolean {\n  const ending = data..;\n  // \"\"\n  return ending === '' || ending === '' || ending === '';\n}\n\n/**\n * \n * 0 = 50 = 100 = \n */\nexport function getAfterStoryInterruptionLevel(data: SchemaType): number {\n  const type = getAfterStoryType(data);\n\n  // \n  if (isInFreeMode(data) || isInAfterStory(data)) {\n    switch (type) {\n      case '':\n        return PERFECT_TRUE_AFTER_STORY.interruptionLevel;\n      case '':\n        return TRUE_ENDING_AFTER_STORY.interruptionLevel;\n      case '':\n        return FALSE_ENDING_AFTER_STORY.interruptionLevel;\n      default:\n        return 0;\n    }\n  }\n\n  return 0;\n}\n\n// ============================================\n// \n// ============================================\n\n/**\n * \n */\nexport function activateAfterStory(data: SchemaType): void {\n  if (!data..) {\n    (data. as any). = {\n      : false,\n      : 0,\n      : false,\n      : false,\n    };\n  }\n\n  data... = true;\n  data... = 1;\n\n  console.info('[] ');\n}\n\n/**\n * \n */\nexport function advanceAfterStoryRound(data: SchemaType): void {\n  if (!data..) return;\n\n  const currentRound = data...;\n\n  if (currentRound >= 2) {\n    // \n    data... = true;\n    data... = true;\n    console.info('[] ');\n  } else {\n    data... = currentRound + 1;\n    console.info(`[] ${currentRound + 1}`);\n  }\n}\n\n// ============================================\n// AI Prompt \n// ============================================\n\n/**\n * \n */\nfunction getAfterStoryConfig(type: AfterStoryType) {\n  switch (type) {\n    case '':\n      return PERFECT_TRUE_AFTER_STORY;\n    case '':\n      return TRUE_ENDING_AFTER_STORY;\n    case '':\n      return FALSE_ENDING_AFTER_STORY;\n    default:\n      return null;\n  }\n}\n\n/**\n * \n */\nexport function generateAfterStoryEntryReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} | null {\n  const type = getAfterStoryType(data);\n  if (!type) return null;\n\n  const config = getAfterStoryConfig(type);\n  if (!config) return null;\n\n  const round1 = config.round1;\n\n  const userMessage = `[ - ]\n\n${type} - 1${round1.title}\n\n${round1.setting}\n\n${round1.aiGuidance}\n\n\n- 12\n- ${config.husbandStatus}\n- ${config.interruptionLevel === 0 ? '' : ''}\n- `;\n\n  const prefill = round1.setting.split('\\n')[0];\n\n  return { userMessage, prefill };\n}\n\n/**\n * AI\n */\nexport function generateAfterStoryPrompt(data: SchemaType): string | null {\n  const type = getAfterStoryType(data);\n  if (!type) return null;\n\n  const config = getAfterStoryConfig(type);\n  if (!config) return null;\n\n  const currentRound = data..?. ?? 1;\n  const roundConfig = currentRound === 1 ? config.round1 : config.round2;\n\n  return `${type} - ${currentRound}${roundConfig.title}\n\n${roundConfig.setting}\n\n${roundConfig.aiGuidance}\n\n\n- ${currentRound} / 2\n- ${config.husbandStatus}\n- ${config.interruptionLevel === 0 ? '' : ''}`;\n}\n\n/**\n * \n */\nconst FREE_MODE_SETTINGS = {\n  : {\n    timeFrame: '/',\n    relationship: '{{user}}\"\"',\n    zhaoXiaState: `- \n- {{user}}\n- \n- `,\n    husbandState: `- \"\"\n- \n- \n- \"\"`,\n    suggestedScenes: ['', '', '', '', ''],\n    tone: '\"\"',\n  },\n  : {\n    timeFrame: '',\n    relationship: '{{user}}',\n    zhaoXiaState: `- {{user}}\n- \n- ...\n- `,\n    husbandState: `- ICU\"\"\n- \n- \n- `,\n    suggestedScenes: ['', '', '', '', '\"\"'],\n    tone: '',\n  },\n  : {\n    timeFrame: '/',\n    relationship: '',\n    zhaoXiaState: `- \n- \"\"\n- {{user}}\n- `,\n    husbandState: `- \n- \"\"\n- \n- `,\n    suggestedScenes: [\n      '',\n      '',\n      '',\n      '',\n      '',\n    ],\n    tone: '',\n  },\n};\n\n/**\n * AI\n */\nexport function generateFreeModePrompt(data: SchemaType): string | null {\n  const type = getAfterStoryType(data);\n  if (!type) return null;\n\n  const config = getAfterStoryConfig(type);\n  if (!config) return null;\n\n  const settings = FREE_MODE_SETTINGS[type];\n  if (!settings) return null;\n\n  return `${type === '' ? '' : type} - \n\n\n\n\n\n${settings.timeFrame}\n\n\n${settings.relationship}\n\n\n${settings.zhaoXiaState}\n\n\n${settings.husbandState}\n${config.interruptionLevel === 0 ? '' : ''}\n\n\nDay 1-5  +  +  + \n\n.X.\n\n\n${settings.suggestedScenes.map(s => `- ${s}`).join('\\n')}\n\n\n${settings.tone}\n\nAI\n- \n- {{user}}\n- \n- \n- \"\"`;\n}\n\n/**\n * \n */\nexport function generateAfterStoryComplete(data: SchemaType): string {\n  const type = getAfterStoryType(data);\n\n  const typeTitle = type === '' ? '' : type === '' ? '' : '';\n\n  return `\n\n\n\n\n\n${typeTitle}\n\n\n\n\n\n${\n  type === ''\n    ? '\"\"'\n    : type === ''\n      ? ''\n      : ''\n}\n\n \n\n`;\n}\n\n/**\n * \n * /\n */\nexport function generateDateDisplay(data: SchemaType): string {\n  if (shouldShowRealDate(data)) {\n    // \n    return '{{datetimeformat::YYYYMD}}';\n  } else {\n    // \n    const day = data..;\n    const remaining = Math.max(0, 5 - day);\n    return `Day ${day} ${remaining}`;\n  }\n}\n","/**\n *  - Prompt\n *\n *  CHAT_COMPLETION_PROMPT_READY AI/\n * \n *\n * \n * 1.  - \n * 2.  - 10:00\n * 3.  - AI\n * 4.  - \n */\n\nimport { Schema, type Schema as SchemaType } from '../../schema';\nimport { TimeSystem } from './timeSystem';\nimport {\n  generateMemoryContinuityPrompt,\n  generateEnhancedMemoryContinuityPrompt,\n  generateMemorySummary,\n  getDreamSessionMessages,\n  processSceneCompletion, // Bug #38 \n} from './dreamKeywordDetection';\nimport {\n  generateAppearanceConstraintPrompt,\n  getRealmTitle,\n  generateDetailedInteractionPrompt,\n  calculateSuspicionIncrease,\n} from './appearanceSystem';\nimport {\n  checkBoundaryInterruption,\n  applyInterruptionResult,\n  type InterruptionCheckResult,\n} from './boundaryInterruption';\nimport {\n  calculateScene5Completion as calculateScene5CompletionNew,\n  generateScene5EntryReplacement as generateScene5EntryReplacementNew,\n  generateScene5ForceExitReplacement as generateScene5ForceExitReplacementNew,\n  generateScene5StepReplacement,\n  generateScene5FreePlayReplacement,\n  analyzePlayerIntent,\n  SCENE5_STEPS,\n  calculateMatchLevel,\n  lockScene5EntryCoherence,\n} from './scene5System';\nimport { checkBadEnding, applyBadEndingState, isInBadEndingLock, type BadEndingType } from './badEndingSystem';\nimport { checkNormalEnding, isInNormalEndingLock, type NormalEndingType } from './normalEndingSystem';\nimport {\n  shouldActivateTrueEnding,\n  isTrueEndingActive,\n  getTrueEndingState,\n  updateTrueEndingState,\n  generateTrueEndingPrompt,\n  generateTrueEndingEntryReplacement,\n  generateTrueEndingComplete,\n  getDefaultTrueEndingState,\n  // 2026-01-17 \n  isFreeTimeHour,\n  isRoomTriggerTime,\n  getGuidanceType,\n  generateTimeBasedPrompt,\n  isPerfectTrueEnding,\n} from './trueEndingSystem';\nimport {\n  shouldActivateFalseEnding,\n  isFalseEndingActive,\n  getFalseEndingState,\n  updateFalseEndingState,\n  generateFalseEndingPrompt,\n  generateFalseEndingEntryReplacement,\n  generateFalseEndingComplete,\n  getDefaultFalseEndingState,\n} from './falseEndingSystem';\nimport {\n  shouldActivatePerfectEnding,\n  isPerfectEndingActive,\n  getPerfectEndingState,\n  updatePerfectEndingState,\n  generatePerfectEndingPrompt,\n  generatePerfectEndingEntryReplacement,\n  generatePerfectEndingComplete,\n  getDefaultPerfectEndingState,\n  isPerfectEndingFreeTime,\n  generatePerfectFreeTimePrompt,\n  getPerfectGuidanceType,\n} from './perfectTrueEndingSystem';\nimport {\n  checkConfusionEnding,\n  applyConfusionEndingState,\n  isInConfusionEndingLock,\n  canEnterDreamForConfusion,\n  checkScene5Violations,\n  markConfusionEnding,\n  getConfusionForeshadowing,\n  detectSexualBehavior,\n  detectWeddingInterruption,\n  getViolationIncrement,\n} from './confusionEndingSystem';\nimport {\n  shouldTriggerAfterStory,\n  isInAfterStory,\n  isInFreeMode,\n  getAfterStoryType,\n  activateAfterStory,\n  advanceAfterStoryRound,\n  generateAfterStoryEntryReplacement,\n  generateAfterStoryPrompt,\n  generateFreeModePrompt,\n  generateAfterStoryComplete,\n  getAfterStoryInterruptionLevel,\n} from './afterStorySystem';\n\n// ============================================\n// Bug #39 \n// \"\"\n// \n// ============================================\n\n/**\n *  - AI\n * src////xxx.yaml\n */\nconst ENDING_GUIDANCE = {\n  : ` - AI\n\n\n\n\n- \n- \n- \"\"\"\"\n- \n\n\n\n\n- 161723\n- \n- `,\n\n  : ` - AI\n\n\n\n\n- \"\"\n- \n- \"\"\n- \n\n\n\n\n- \n- \n- `,\n\n  : ` - AI\n\n\n\n\n- \n- \"\"\n- \"\"\"\"\n- \n\n\n\n\n- \n- \n- `,\n\n  : ` - AI\n\n\n\n\n- \n- \n\n`,\n\n  : ` - AI\n\n\n\n\n- 5\n- \n  - \n  - \n  - \n  - \"\"\n- \"\"\n\n`,\n\n  : ` - AI\n\n\n\n\n- \n- \n- AI\n\n`,\n};\n\n/**\n * Bug #39 \n *  data.. \n * @param data \n * @returns  null\n */\nfunction getEndingGuidance(data: SchemaType): string | null {\n  const currentEnding = data..;\n  if (!currentEnding) return null;\n\n  // \n  const guidance = ENDING_GUIDANCE[currentEnding as keyof typeof ENDING_GUIDANCE];\n  return guidance || null;\n}\n\n// ============================================\n// \n//  AI \n// ============================================\n\n/**\n *  - \n */\nconst DREAM_SYSTEM_OVERVIEW = `\n\n{{user}}22:00-01:00\n\n\n- 100\n- 0\n- 1=402=603=804=5=80\n\n5\n- =3+7 3100\n- <3+10 2100\n- 1003-5\n\n\n51-2-3\n- 0: 5\n- 1: 1\n- 2: 1+2+\n- 3: 1+2+3\n4528 vs `;\n\n/**\n * \n */\nconst DREAM_SCENE_DETAILS: Record<number, string> = {\n  1: `1 - AI\n\n16\n\n\nAI\n\n\n\n\n\n- 16\n- \n- \n- \n\n\n\n\n\nAI\n- \n- \n- \n- \n- \n- 09:00-10:00\n- \"\"`,\n\n  2: `2 - AI\n\n171~\n\n\n\n\n\n/\n\n\n\n- 17\n- 1\n- \n- \n- \n\n\n\n\n\nAI\n- \n- \n- \n- 1\n- 09:00-10:00\n- \n- \"\"`,\n\n  3: `3 - AI\n\n23\n\n\n23\n\n\n//\n\n\n- 23\n- 12\n- \n- \n- /\n- \"\"\n\n\n\n\n\nAI\n- \n- \n- \n- ...\n- \n- \n- 09:00-10:00\n- \n- \n- \"\"`,\n\n  4: `4 - AI\n\n285\n\n\n\n\n\n\n\n\n- 28\n- 1-3\n- \n- \n- \n- \n\n\n\n\n\nAI\n- \n- \n- \n- \n- \n- \n- 09:00-10:00\n- \n- \n- \n- \"\"`,\n\n  5: `5 - AI\n\n\n08:00-19:00\n\n\n\n/\n\"\"\n12\n\n\n- \n- 1-4\n- \n- \n- \"\"\n\n\n12\n\n\n12\n- 1-2\n- 3-5\n- 6-8\n- 9-11\n- 12\n\n\n- +10%+5%\n- 80%100%\n- 20:00\n\n\n- 1-10\n- 11-12  \n\n\n1220:00\n\n\n\nAI\n- \n- 1-4\n- \n- \"\"\"\"\n- 20:00\n\n-   3\n- \n\nAI\n- \n- \n- \n- 1-4\n- \n- 12\n- \"\"`,\n};\n\n/**\n * AI - \n */\nconst DREAM_AI_GUIDELINES = `AI\n\n\n{{user}}\n\n\n\n{{user}}\n\"\"{{user}}\n\n\n10:00\n\n\n\n\n{{user}}\n\n\n\n`;\n\n/**\n * \n * \n * @param data \n * @returns  null\n */\nfunction getDreamSceneGuidance(data: SchemaType): string | null {\n  // \n  if (!data..) {\n    return null;\n  }\n\n  // \n  if (data.. === '') {\n    return null;\n  }\n\n  // Bug #40 \n  // AI\n  if (data.. !== '' || isInBadEndingLock(data) || isInConfusionEndingLock(data)) {\n    return null;\n  }\n\n  const parts: string[] = [];\n\n  // 1. \n  parts.push(DREAM_SYSTEM_OVERVIEW);\n\n  // 2. 5\n  parts.push(DREAM_SCENE_DETAILS[5]);\n\n  // 3. 1-4\n  const completedScenes = data.. || [];\n\n  // 1\n  if (!completedScenes.includes(1)) {\n    parts.push(DREAM_SCENE_DETAILS[1]);\n  }\n\n  // 21  2\n  if (completedScenes.includes(1) && !completedScenes.includes(2)) {\n    parts.push(DREAM_SCENE_DETAILS[2]);\n  }\n\n  // 32  3\n  if (completedScenes.includes(2) && !completedScenes.includes(3)) {\n    parts.push(DREAM_SCENE_DETAILS[3]);\n  }\n\n  // 43  4\n  if (completedScenes.includes(3) && !completedScenes.includes(4)) {\n    parts.push(DREAM_SCENE_DETAILS[4]);\n  }\n\n  // 4. AI\n  parts.push(DREAM_AI_GUIDELINES);\n\n  return parts.join('\\n\\n---\\n\\n');\n}\n\n/**\n * \n * AI\n * \n *\n * \n * 1. ///\n * 2. AI\n *\n * @param data \n * @param excludeCurrentScene \n * @returns  null\n */\nfunction generateDreamHistoryBackground(data: SchemaType, excludeCurrentScene?: number): string | null {\n  // \n  if (!data..) {\n    return null;\n  }\n\n  let completedScenes = data.. || [];\n  const correctScenes = data.. || [];\n\n  // \n  if (excludeCurrentScene !== undefined) {\n    completedScenes = completedScenes.filter(s => s !== excludeCurrentScene);\n  }\n\n  if (completedScenes.length === 0) {\n    return null;\n  }\n\n  const parts: string[] = [];\n\n  parts.push(``);\n\n  // 1\n  if (completedScenes.includes(1)) {\n    const scene1Data = data..1 as { ?: string } | undefined;\n    const isCorrect = correctScenes.includes(1);\n    const summary = scene1Data?. || '';\n\n    parts.push(`\n1 ${isCorrect ? '' : ''}\n16\n\n16\n\n\n${summary}`);\n  }\n\n  // 2\n  if (completedScenes.includes(2)) {\n    const scene2Data = data..2 as { ?: string } | undefined;\n    const isCorrect = correctScenes.includes(2);\n    const summary = scene2Data?. || '';\n\n    parts.push(`\n2 ${isCorrect ? '' : ''}\n171~\n\n17\n\n1\n${summary}`);\n  }\n\n  // 3\n  if (completedScenes.includes(3)) {\n    const scene3Data = data..3 as { ?: string } | undefined;\n    const isCorrect = correctScenes.includes(3);\n    const summary = scene3Data?. || '';\n\n    parts.push(`\n3 ${isCorrect ? '' : ''}\n23\n23\n23\n\n\n${summary}`);\n  }\n\n  // 54\n  if (completedScenes.includes(5)) {\n    const scene5Data = data..5 as { ?: string; ?: number } | undefined;\n    const isCorrect = correctScenes.includes(5);\n    const completion = scene5Data?. ?? 0;\n    const summary = scene5Data?. || '';\n\n    parts.push(`\n5 ${isCorrect ? '' : ''} ${completion}%\n\n\"\"\n\n12\n\n${summary}`);\n  }\n\n  // 4\n  if (completedScenes.includes(4)) {\n    const scene4Data = data..4 as { ?: string } | undefined;\n    const isCorrect = correctScenes.includes(4);\n    const summary = scene4Data?. || '';\n\n    parts.push(`\n4 ${isCorrect ? '' : ''}\n285\n\n28\n\n\n${summary}`);\n  }\n\n  return parts.join('\\n');\n}\n\n// \n// Bug #16 \nconst DREAM_ENTRY_KEYWORDS = [\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n];\n//  \"...\" \nconst DREAM_ENTRY_PATTERNS = [\n  /.*/, //  \"\"\"\" \n  /.*/, //  \"\"\"\" \n];\n\n// 5\nconst SLEEPING_PILL_KEYWORDS = ['', '', '', '', '', '', '', ''];\n\n// \n// 1-4 23:00-01:00  + \n// 508:00-19:00\nconst DREAM_SCENE_THEMES: Record<\n  number,\n  {\n    title: string;\n    age: number;\n    setting: string;\n    theme: string;\n    atmosphere: string;\n    bodyPart: string; // \n    objective: string; // \n    identity: string; // \n  }\n> = {\n  1: {\n    title: '',\n    age: 16,\n    setting: '',\n    theme: '',\n    atmosphere: '',\n    bodyPart: '',\n    objective: '',\n    identity: '',\n  },\n  2: {\n    title: '',\n    age: 17,\n    setting: '',\n    theme: '',\n    atmosphere: '',\n    bodyPart: '',\n    objective: '',\n    identity: '1',\n  },\n  3: {\n    title: '',\n    age: 23,\n    setting: '//',\n    theme: '',\n    atmosphere: '',\n    bodyPart: '',\n    objective: '',\n    identity: '',\n  },\n  4: {\n    title: '',\n    age: 28,\n    setting: '',\n    theme: '',\n    atmosphere: '',\n    bodyPart: '',\n    objective: '',\n    identity: '',\n  },\n  5: {\n    title: '',\n    age: 0, // \n    setting: '/',\n    theme: '',\n    atmosphere: '',\n    bodyPart: '',\n    objective: '12',\n    identity: '',\n  },\n};\n\n// ============================================\n// 1\n// \n// ============================================\n\n/**\n * 1\n * /\n */\nconst SCENE1_INIT_CONFIG = {\n  // \n  dependence: {\n    favorWeight: 0.2, // 100  20\n    intimacyWeight: 0.1, // 100  10\n    maxValue: 30, // 3016\n    minValue: 0, // 0\n  },\n  // \n  morality: {\n    baseValue: 80, // 8016\n    intimacyReduction: 0.2, // 0.2\n    minValue: 60, // 60\n    maxValue: 80, // 80\n  },\n};\n\n/**\n * 1\n * \n *\n * @param data \n * @returns 1\n */\nfunction calculateScene1InitValues(data: SchemaType): {\n  initialDependence: number;\n  initialMorality: number;\n  relationshipStage: string;\n  transferDescription: string;\n} {\n  const  = data.. ?? 0;\n  const  = data.. ?? 0;\n\n  // \n  const rawDependence =\n     * SCENE1_INIT_CONFIG.dependence.favorWeight +  * SCENE1_INIT_CONFIG.dependence.intimacyWeight;\n  const initialDependence = Math.min(\n    SCENE1_INIT_CONFIG.dependence.maxValue,\n    Math.max(SCENE1_INIT_CONFIG.dependence.minValue, Math.floor(rawDependence)),\n  );\n\n  // \n  const rawMorality = SCENE1_INIT_CONFIG.morality.baseValue -  * SCENE1_INIT_CONFIG.morality.intimacyReduction;\n  const initialMorality = Math.min(\n    SCENE1_INIT_CONFIG.morality.maxValue,\n    Math.max(SCENE1_INIT_CONFIG.morality.minValue, Math.floor(rawMorality)),\n  );\n\n  // \n  let relationshipStage: string;\n  if ( >= 60) {\n    relationshipStage = '';\n  } else if ( >= 40) {\n    relationshipStage = '';\n  } else if ( >= 20) {\n    relationshipStage = '';\n  } else {\n    relationshipStage = '';\n  }\n\n  // AI\n  const transferDescription = generateTransferDescription(\n    ,\n    ,\n    initialDependence,\n    initialMorality,\n    relationshipStage,\n  );\n\n  return {\n    initialDependence,\n    initialMorality,\n    relationshipStage,\n    transferDescription,\n  };\n}\n\n/**\n * AI\n */\nfunction generateTransferDescription(\n  favor: number,\n  intimacy: number,\n  dependence: number,\n  morality: number,\n  stage: string,\n): string {\n  let description = `\\n`;\n  description += `${favor}${intimacy}${stage}\\n`;\n  description += `${dependence}${morality}\\n\\n`;\n\n  // AI\n  switch (stage) {\n    case '':\n      description += `\"\"`;\n      description += ``;\n      description += ``;\n      break;\n    case '':\n      description += ``;\n      description += ``;\n      break;\n    case '':\n      description += ``;\n      description += ``;\n      break;\n    default:\n      description += ``;\n      description += ``;\n  }\n\n  return description;\n}\n\n/**\n * \n * \n */\nfunction getBodyPartInfluenceLevel(progress: number): {\n  level: string;\n  description: string;\n  acceptanceLevel: string;\n} {\n  if (progress >= 80) {\n    return {\n      level: '',\n      description: '',\n      acceptanceLevel: '',\n    };\n  }\n  if (progress >= 60) {\n    return {\n      level: '',\n      description: '',\n      acceptanceLevel: '',\n    };\n  }\n  if (progress >= 40) {\n    return {\n      level: '',\n      description: '',\n      acceptanceLevel: '',\n    };\n  }\n  if (progress >= 20) {\n    return {\n      level: '',\n      description: '',\n      acceptanceLevel: '',\n    };\n  }\n  return {\n    level: '',\n    description: '',\n    acceptanceLevel: '',\n  };\n}\n\n/**\n * AI\n * AI\n */\nfunction generateBodyPartInfluencePrompt(data: SchemaType): string | null {\n  const progress = data..;\n\n  // \n  const hasProgress = Object.values(progress).some(v => v > 0);\n  if (!hasProgress) return null;\n\n  const parts: string[] = [];\n\n  // \n  const bodyPartConfig: Record<\n    string,\n    {\n      displayName: string;\n      behaviors: Record<string, string>; //  -> \n    }\n  > = {\n    : {\n      displayName: '/',\n      behaviors: {\n        : '',\n        : '',\n        : '',\n        : '',\n        : '',\n      },\n    },\n    : {\n      displayName: '',\n      behaviors: {\n        : '',\n        : '',\n        : '',\n        : '',\n        : '',\n      },\n    },\n    : {\n      displayName: '/',\n      behaviors: {\n        : '',\n        : '',\n        : '',\n        : '',\n        : '',\n      },\n    },\n    : {\n      displayName: '/',\n      behaviors: {\n        : '',\n        : '',\n        : '',\n        : '',\n        : 'play',\n      },\n    },\n    : {\n      displayName: '/',\n      behaviors: {\n        : '',\n        : '{{user}}',\n        : '',\n        : '',\n        : '{{user}}',\n      },\n    },\n  };\n\n  for (const [part, value] of Object.entries(progress)) {\n    if (value <= 0) continue;\n\n    const config = bodyPartConfig[part];\n    if (!config) continue;\n\n    const influence = getBodyPartInfluenceLevel(value);\n    const behaviorExample = config.behaviors[influence.level] || '';\n\n    parts.push(`${config.displayName}${value}%${influence.level}\n${influence.description}\n${influence.acceptanceLevel}\n${behaviorExample}`);\n  }\n\n  if (parts.length === 0) return null;\n\n  return `OOC: \n\n\n\n${parts.join('\\n\\n')}\n\n\n- \n- \n- \n- \"\"\"\"\n- \"\"\n- \n\n\nHTML\n<!--BODY_PROGRESS: +, +-->\n<!--BODY_PROGRESS: +10, +5-->\n\n- \n- 1-15\n- +5\n- +10\n- +15\n- \n-  HTML <!--...-->  [...]`;\n}\n\n/**\n * AI\n * AI\n */\nfunction generateDreamProgressFeedbackPrompt(): string {\n  return `\nHTML\n<!--BODY_PROGRESS: +-->\n\n\n\n- +5\n- +10\n- +15\n\n HTML <!--...-->  [...]\n`;\n}\n\n/**\n * \n */\nfunction getTimePeriodDescription(hour: number): { period: string; lighting: string; atmosphere: string } {\n  if (hour >= 5 && hour < 8) {\n    return { period: '', lighting: '', atmosphere: '' };\n  } else if (hour >= 8 && hour < 12) {\n    return { period: '', lighting: '', atmosphere: '' };\n  } else if (hour >= 12 && hour < 14) {\n    return { period: '', lighting: '', atmosphere: '' };\n  } else if (hour >= 14 && hour < 18) {\n    return { period: '', lighting: '', atmosphere: '' };\n  } else if (hour >= 18 && hour < 20) {\n    return { period: '', lighting: '', atmosphere: '' };\n  } else if (hour >= 20 && hour < 23) {\n    return { period: '', lighting: '', atmosphere: '' };\n  } else {\n    return { period: '', lighting: '', atmosphere: '' };\n  }\n}\n\n/**\n * \n * AI\n */\nfunction getTimeConstraintReminder(hour: number): string {\n  if (hour >= 5 && hour < 12) {\n    return ' /';\n  } else if (hour >= 12 && hour < 18) {\n    return ' /';\n  } else if (hour >= 18 && hour < 22) {\n    return ' /';\n  } else {\n    return ' /';\n  }\n}\n\n/**\n * \n * AI\n */\nfunction getHusbandConstraintReminder(data: SchemaType): string {\n  const  = data..;\n  const  = data..;\n  const  =  >= 23 ||  < 7;\n\n  if ( === '') {\n    return ' ';\n  }\n\n  // \n  if ( &&  === '') {\n    return ' ';\n  }\n\n  // \n  return ` ${}`;\n}\n\n/**\n * \n * \n */\nfunction getRealmConstraintReminder(realm: number, : boolean): string {\n  if (!) {\n    // \n    // Bug #34  textMapping.ts \n    switch (realm) {\n      case 1:\n        return ' ';\n      case 2:\n        return ' ';\n      case 3:\n        return ' ';\n      case 4:\n        return ' ';\n      case 5:\n        return ' ';\n      default:\n        return '';\n    }\n  } else {\n    // \n    // Bug #34  textMapping.ts \n    switch (realm) {\n      case 1:\n        return ' 1';\n      case 2:\n        return ' 2';\n      case 3:\n        return ' 3';\n      case 4:\n        return ' 4';\n      case 5:\n        return ' 5';\n      default:\n        return '';\n    }\n  }\n}\n\n/**\n * D9\n * AI\n */\nfunction getDreamTimePhaseGuidance(\n  hour: number,\n  sceneNum: number,\n): {\n  phase: string;\n  guidance: string;\n  pacing: string;\n} | null {\n  // 22:00-10:0010:00\n  // 22:00-01:00 = 4- \n  // 02:00-04:00 = /3- 12/3/4\n  // 05:00-08:00 = 4- \n  // 09:00-10:00 = 2- \n\n  const isScene1 = sceneNum === 1;\n  const isScene2 = sceneNum === 2;\n  const isScene3 = sceneNum === 3;\n  const isScene4 = sceneNum === 4;\n\n  if (hour >= 22 || hour <= 1) {\n    // 22:00-01:00\n    let guidance: string;\n    if (isScene1) {\n      guidance = `\n\n\n1\n- 16\n- ****\n- ****\n- \n\nAI\n- 16\n- \n- \n- \n- \n\n\n- \n- \n- `;\n    } else if (isScene2) {\n      guidance = `217\n\n\n1E\n\n\nAI\n\n\n- 17\n- \n- \n- \n- \n\n\n117\n\n`;\n    } else if (isScene3) {\n      guidance = `\n\n\n3 - \n- 23\n- \n- \n- ****\n- //\n\nAI\n- \n- \n- ...\n- \n\n\n- \n- \n- /\n\n\n- \n- \n- `;\n    } else if (isScene4) {\n      guidance = `\n\n\n4 - \n- 285\n- \n- \n- \n\nAI\n- \n- \n- \n- \n\n\n- \n- \n- \n\n\n- \n- \n- `;\n    } else {\n      guidance = `\n\n- \n- \n- \n- `;\n    }\n    return {\n      phase: '',\n      guidance,\n      pacing: '',\n    };\n  }\n\n  if (hour >= 2 && hour <= 4) {\n    // 02:00-04:00\n    let guidance: string;\n    if (isScene1) {\n      guidance = `\n\n\n1\n- \n- \n- \n- \n- \n\n\n- 10\n- \n- \" >  > \"\n- \n\n\n- \n- `;\n    } else if (isScene2) {\n      guidance = `\n\n\n\"\"\n\n\n- \n- \"\"\n- \n- \n- \n\n17\n\n`;\n    } else if (isScene3) {\n      // 3\n      guidance = `\n\n\n3\n- \n- \"\"\n- \n- ****\n\n\n- \n- \n- \"\"\n- \n\nAI\n- \n- \n- \n- `;\n    } else if (isScene4) {\n      // 4\n      guidance = `\n\n\n4\n- \n- \n- \n- \n- ****\n\n\n- \n- \n- ...\n- \n\nAI\n- \n- \n- \n- `;\n    } else {\n      guidance = `\n\n- \n- \n- \n- `;\n    }\n    return {\n      phase: isScene2 || isScene3 || isScene4 ? '' : '',\n      guidance,\n      pacing: isScene2 || isScene3 || isScene4 ? '' : '',\n    };\n  }\n\n  if (hour >= 5 && hour <= 6) {\n    // 05:00-06:00\n    let guidance: string;\n    if (isScene1) {\n      guidance = `\n\n\n1\n- \n- \n- AI\n- \n\n\n- \n- \n- \n- \n\nAI\n- \n- \n- `;\n    } else if (isScene2) {\n      guidance = `\n\n\n- \n- \n- \n- \n- \"...\"\n\nNPC\n\n\n17`;\n    } else if (isScene3) {\n      // 305:00-06:00\n      guidance = `\n\n\n3\n- \n- \n- \n- \n- `;\n    } else if (isScene4) {\n      // 405:00-06:00\n      guidance = `\n\n\n4\n- \n- \n- \n- \n- `;\n    } else {\n      guidance = `\n\n- \n- \n- \n- `;\n    }\n    return {\n      phase: '',\n      guidance,\n      pacing: '',\n    };\n  }\n\n  if (hour >= 7 && hour <= 8) {\n    // 07:00-08:00\n    let guidance: string;\n    if (isScene1) {\n      guidance = `\n\n\n1\n- \n- \n- \n\n\n- \n- \n- \"\"\n- \n\nAI\n- \n- \n- `;\n    } else if (isScene2) {\n      guidance = `\n\n\n- \n- \n- \n- \n\n\n\"............\"\n\n`;\n    } else if (isScene3) {\n      // 307:00-08:00\n      guidance = `\n\n\n3\n- \n- \n- `;\n    } else if (isScene4) {\n      // 407:00-08:00\n      guidance = `\n\n\n4\n- \n- \n- `;\n    } else {\n      guidance = `\n\n- \n- \n- \n- `;\n    }\n    return {\n      phase: '',\n      guidance,\n      pacing: '',\n    };\n  }\n\n  if (hour >= 9 && hour <= 10) {\n    // 09:00-10:00\n    let guidance: string;\n    if (isScene1) {\n      guidance = `\n1\n\n - \n- \n- AI\n   \n   \n   \n   \n   \n   \n\n1\n- \n- 16\n- \n\n\n- \n- \n- \n\n\n- \n- \n\n\n- \n- \n- `;\n    } else if (isScene2) {\n      guidance = `\n\n\n\n\n2\n\"\"...\n\n\n- \n- \n- \n- AI\n\n\n\"\"\n\n...`;\n    } else if (isScene3) {\n      // 309:00-10:00\n      guidance = `\n3\n\n - \n- \n- AI\n   \n   \n   \n   \n   \n   \n\n3\n- \n- \n- \n- \n\n\n- \n- \"\"\n- \n\n\n- \n- \n- \n\n\n- \n- \n- `;\n    } else if (isScene4) {\n      // 409:00-10:00\n      guidance = `\n4\n\n - \n- \n- AI\n   \n   \n   \n   \"...\"\n   \n   \n\n4\n- \n- \n- \n- \n\n\n- \n- \"\"\n- \n\n\n- \n- \n- \n\n\n- \n- \n- `;\n    } else {\n      guidance = `\n\n- \n- \n- \n- `;\n    }\n    return {\n      phase: '',\n      guidance,\n      pacing: '',\n    };\n  }\n\n  return null;\n}\n\n/**\n * \n * \n * AI\n *\n * @param age \n * @param sceneNum 1-5\n * @returns \n */\nfunction getDreamConstraintReminder(age: number, sceneNum: number): string {\n  const reminders: string[] = [];\n\n  // 1\n  reminders.push(` \"\"\"\"`);\n\n  // 2\n  reminders.push(` \"\"`);\n\n  // 3\n  reminders.push(` ${age}${age}`);\n\n  // 4\n  reminders.push(` `);\n\n  // 5 - Bug\n  // AI<HusbandThought>\n  // <HusbandThought>\"\"\n  reminders.push(` <HusbandThought> \"\"`);\n  reminders.push(` //* `);\n\n  // \n  if (sceneNum === 2) {\n    reminders.push(` `);\n  } else if (sceneNum === 4) {\n    reminders.push(` `);\n  }\n\n  return reminders.join('\\n');\n}\n\n/**\n * \n * \n */\nfunction getHusbandStatusDescription(data: SchemaType): string {\n  const  = data..;\n  const  = data..;\n\n  const : Record<string, string> = {\n    : `${ < 18 ? '18:00' : ''}`,\n    : '',\n    : '',\n    : '',\n    : '',\n  };\n\n  return [] ?? '';\n}\n\n/**\n * Prompt\n * /AI\n * \n * D9 + \n *\n * @param data \n * @param overridePhase \n */\nfunction generatePhaseAwareStatePrompt(data: SchemaType, overridePhase?: string): string {\n  // Bug #8 5/\n  // \n  const  = overridePhase ?? data..;\n\n  if ( === '') {\n    return generateDreamPhasePrompt(data);\n  } else {\n    return generateDailyPhasePrompt(data);\n  }\n}\n\n/**\n * Prompt\n * \n * AI\n */\nfunction generateDailyPhasePrompt(data: SchemaType): string {\n  const  = data..;\n  const  = data..;\n  const  = data..;\n  const  = data..;\n\n  // \n  const timeInfo = getTimePeriodDescription();\n\n  // \n  const husbandStatus = getHusbandStatusDescription(data);\n\n  // \n  const  = getRealmTitle(, );\n\n  // \n  const timeConstraint = getTimeConstraintReminder();\n  const husbandConstraint = getHusbandConstraintReminder(data);\n  const realmConstraint = getRealmConstraintReminder(, );\n\n  // 2026-01-18\n  // \n  // - \n  // - \n  const  = data..;\n  const  =  !== '';\n  const  =  &&  >= 2; //  dualTrackSystem.ts \n\n  // 2026-01-19\n  // Day 5 \n  //  AI \n  let husbandThoughtConstraint = '';\n  if () {\n    if ( < 2) {\n      husbandThoughtConstraint = '  <HusbandThought> ';\n    } else {\n      //  >= 2\n      if () {\n        // \n        husbandThoughtConstraint =\n          ' <HusbandThought> 30-50';\n      } else {\n        // \n        husbandThoughtConstraint =\n          ' <HusbandThought> 30-50';\n      }\n    }\n  }\n\n  // \n  let prompt = ` - \n${}${timeInfo.period}\n${husbandStatus}\n${ ? '' : ''}\n\n\n- ${}${}/5\n- ${data..}/100\n- ${data..}/100\n\n\n${timeConstraint}\n${husbandConstraint}\n${realmConstraint}${husbandThoughtConstraint ? '\\n' + husbandThoughtConstraint : ''}`;\n\n  // \n  const appearancePrompt = generateAppearanceConstraintPrompt(data);\n  prompt += `\\n\\n${appearancePrompt}`;\n\n  // +\n  const interactionPrompt = generateDetailedInteractionPrompt(data);\n  prompt += `\\n\\n${interactionPrompt}`;\n\n  return prompt;\n}\n\n/**\n * Prompt\n * D9 + \n * \n */\nfunction generateDreamPhasePrompt(data: SchemaType): string {\n  const hour = data..;\n  // Bug #6\n  const day = data.._ ?? data..;\n\n  // \n  let sceneNum = Math.min(day, 4);\n\n  // 5\n  const scene5Data = data..5 as { ?: boolean } | undefined;\n  if (scene5Data?.) {\n    sceneNum = 5;\n  }\n\n  // \n  const sceneConfig = DREAM_SCENE_THEMES[sceneNum];\n\n  // Bug #32 AI\n  // promptInjection  AI  AI \n  //  promptInjection  22:00 AI  23:00\n  //  AI  23:00  22:00\n  const guidanceHour = (hour + 1) % 24;\n\n  // D9\n  const guidance = getDreamTimePhaseGuidance(guidanceHour, sceneNum);\n\n  // 10:00\n  // Bug #32 1AI\n  // 22 hour >= 23 22\n  let hoursRemaining: number;\n  if (hour >= 22) {\n    hoursRemaining = 10 + 24 - hour - 1; // 22  11, 23  10\n  } else if (hour >= 0 && hour < 10) {\n    hoursRemaining = 10 - hour - 1;\n  } else {\n    hoursRemaining = 0;\n  }\n\n  // 24\n  const suWenAppears = sceneNum !== 2 && sceneNum !== 4;\n\n  // \n  const sceneAge = sceneConfig?.age || 25;\n\n  // Prompt\n  let prompt = ` - \n\n\n${sceneConfig?.title || `${sceneNum}`}\n${sceneAge}\n${sceneConfig?.theme || ''}\n${sceneConfig?.atmosphere || ''}`;\n\n  // 1\n  if (sceneNum === 1 && sceneConfig) {\n    prompt += `\n${sceneConfig.identity || ''}\n${sceneConfig.objective || ''}`;\n  }\n\n  // \n  prompt += `\n\n\n${getDreamConstraintReminder(sceneAge, sceneNum)}`;\n\n  // D9\n  if (guidance) {\n    // Bug #32 AI\n    // 23:00 + 1 = 00:00+1\n    const guidanceDay = guidanceHour < hour ? data.. + 1 : data..;\n    const guidanceTimeStr = `Day ${guidanceDay}, ${guidanceHour.toString().padStart(2, '0')}:00`;\n\n    prompt += `\n\n---\n\nOOC: D9 \n\n${guidanceTimeStr}\n${guidance.phase}${guidance.pacing}\n${hoursRemaining}\n\n${guidance.guidance}`;\n  } else {\n    // D9\n    prompt += `\n\n\n- \n- \n- `;\n  }\n\n  return prompt;\n}\n\n/**\n * [] Prompt\n *  generatePhaseAwareStatePrompt\n * @deprecated  generatePhaseAwareStatePrompt \n */\nfunction generateStateConsistencyPrompt(data: SchemaType): string {\n  return generatePhaseAwareStatePrompt(data);\n}\n\n/**\n * 116\n * /\n */\nfunction generateScene1EntryReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const scene = DREAM_SCENE_THEMES[1];\n  // Prompt\n  const continuityPrompt = generateEnhancedMemoryContinuityPrompt(data, 1);\n\n  // 1\n  const initValues = calculateScene1InitValues(data);\n\n  // \n  let initialAttitude: string;\n  switch (initValues.relationshipStage) {\n    case '':\n      initialAttitude = ``;\n      break;\n    case '':\n      initialAttitude = ``;\n      break;\n    case '':\n      initialAttitude = ``;\n      break;\n    default:\n      initialAttitude = ``;\n  }\n\n  const userMessage = `[ - ]\n\n\n\n - \n- ${scene.age}\n- \n- ${scene.identity}\n- ${scene.objective}\n- ${scene.theme}\n- ${scene.atmosphere}\n\n${initValues.transferDescription}\n\n\n${initialAttitude}\n\n\n- ${initValues.initialDependence}30\n- ${initValues.initialMorality}16\n- ${initValues.relationshipStage}\n\n - \n\n- \n- \n- \n- \n\n${continuityPrompt}\n\n\n- \n- \n- \n- \n- \n\nAI\n1. 2-3\n2. \n3. 163\n   - \n   - \n   - \n4. \n5. \n6. \n\n\n- 800-1200\n- \n- \n- \n\n\n- \n- \"\"\n- ${scene.age}\n- \n- \n- \n- /${scene.age}`;\n\n  const prefill = `......\n\n`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 217\n */\nfunction generateScene2EntryReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const scene = DREAM_SCENE_THEMES[2];\n  // Prompt1\n  const continuityPrompt = generateEnhancedMemoryContinuityPrompt(data, 2);\n\n  // \n  const dependence = data..;\n  const morality = data..;\n  const chestProgress = data...;\n\n  // 1\n  const scene1Data = data..1;\n  const hasScene1Memory = scene1Data?. && scene1Data?.;\n\n  let playerRelationship: string;\n  if (hasScene1Memory) {\n    playerRelationship = `16\n\n`;\n  } else {\n    playerRelationship = `\n`;\n  }\n\n  const userMessage = `[ - ]\n\n\n\n - \n- ${scene.age}\n- \n- ${hasScene1Memory ? '1' : ''}\n- ${scene.identity}\n- ${scene.objective}\n- ${scene.theme}\n- ${scene.atmosphere}\n\n\n- ${dependence}\n- ${morality}\n- ${chestProgress}%\n\n\n${playerRelationship}\n\n - \n\n- \n- \n- \n- AI\n\n${continuityPrompt}\n\n\n- \n- \n- \n- \n- \n\nAI - \n1. 2-3\n2. 17\n   - \n   - \n   - E/\n3. ****\n   - \n   - \n   - //\"\"\"\"\"\"\n   - \n   - \n4. ****\n   - \n   - //\n   - \n5. 1\n6. \n\n\n- 800-1200\n- \n- \n- \n\n\n- \n- \n- \n- \"\"\n- ${scene.age}\n- \n- /${scene.age}`;\n\n  const prefill = `......\n\n......`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 323\n */\nfunction generateScene3EntryReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const scene = DREAM_SCENE_THEMES[3];\n  // Prompt1-2\n  const continuityPrompt = generateEnhancedMemoryContinuityPrompt(data, 3);\n\n  // \n  const dependence = data..;\n  const morality = data..;\n  const lowerBodyProgress = data...;\n\n  // \n  const scene1Data = data..1;\n  const scene2Data = data..2;\n  const hasScene1Memory = scene1Data?. && scene1Data?.;\n  const hasScene2Memory = scene2Data?. && scene2Data?.;\n\n  let playerRelationship: string;\n  if (hasScene1Memory && hasScene2Memory) {\n    playerRelationship = `1617\n\n`;\n  } else if (hasScene1Memory) {\n    playerRelationship = `16\n\n`;\n  } else if (hasScene2Memory) {\n    playerRelationship = `17\n\n`;\n  } else {\n    playerRelationship = `\n`;\n  }\n\n  const userMessage = `[ - ]\n\n\n\n - \n- ${scene.age}\n- 23\n- \n- \n- //\n- ${hasScene1Memory || hasScene2Memory ? '' : ''}\n- ${scene.identity}\n- ${scene.objective}\n- ${scene.theme}\n- ${scene.atmosphere}\n\n\n- ${dependence}\n- ${morality}\n- ${lowerBodyProgress}%\n\n\n${playerRelationship}\n\n - \n\n- \n- \n- \n- \n\n${continuityPrompt}\n\n\n- \n- \n- \n- \n- \n\nAI - \n1. 2-3\n2. 23\n   - \n   - \n   - ...\n3. ****\n   - \n   - /\n   - \n4. ****\n   - /\n   - \n   - \n5. \n   - \n   - \n6. \n\n\n- 800-1200\n- \n- \n- \n\n\n- \n- \n- \n- \"\"\n- ${scene.age}\n- \n- /${scene.age}`;\n\n  const prefill = `......\n\n......\n\n............`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 428\n */\nfunction generateScene4EntryReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const scene = DREAM_SCENE_THEMES[4];\n  // Prompt1-3\n  const continuityPrompt = generateEnhancedMemoryContinuityPrompt(data, 4);\n\n  // \n  const dependence = data..;\n  const morality = data..;\n  const analProgress = data...;\n\n  // \n  const scene1Data = data..1;\n  const scene2Data = data..2;\n  const scene3Data = data..3;\n  const hasScene1Memory = scene1Data?. && scene1Data?.;\n  const hasScene2Memory = scene2Data?. && scene2Data?.;\n  const hasScene3Memory = scene3Data?. && scene3Data?.;\n\n  // \n  const memoryCount = [hasScene1Memory, hasScene2Memory, hasScene3Memory].filter(Boolean).length;\n\n  let playerRelationship: string;\n  if (memoryCount === 3) {\n    playerRelationship = `\n\n`;\n  } else if (memoryCount === 2) {\n    playerRelationship = `\n\n`;\n  } else if (memoryCount === 1) {\n    playerRelationship = `\n`;\n  } else {\n    playerRelationship = `\n`;\n  }\n\n  const userMessage = `[ - ]\n\n\n\n - \n- ${scene.age}\n- 5\n- \n- AI\n- \n- ${memoryCount > 0 ? '' : ''}\n- ${scene.identity}\n- ${scene.objective}\n- ${scene.theme}\n- ${scene.atmosphere}\n\n\n- ${dependence}\n- ${morality}\n- ${analProgress}%\n\n\n${playerRelationship}\n\n - \n\n- \n- \n- \n- \n\n${continuityPrompt}\n\n\n- \n- \n- \n- \n- \n\nAI - \n1. 2-3\n2. 28\n   - \n   - AI\n   - \n3. ****\n   - \n   - \n   - \n4. ****\n   - \n   - \n   - \n5. \n   - \n   - \n   - \"\"\n6. \n\n\n- 800-1200\n- \n- \n- \n\n\n- \n- \n- \"\"\n- ${scene.age}\n- \n- /${scene.age}`;\n\n  const prefill = `......\n\n......\n\n............`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 1-4\n */\nfunction generateDreamEntryReplacement(\n  data: SchemaType,\n  sceneNum: number,\n): {\n  userMessage: string;\n  prefill: string;\n} {\n  // 1\n  if (sceneNum === 1) {\n    return generateScene1EntryReplacement(data);\n  }\n\n  // 2\n  if (sceneNum === 2) {\n    return generateScene2EntryReplacement(data);\n  }\n\n  // 3\n  if (sceneNum === 3) {\n    return generateScene3EntryReplacement(data);\n  }\n\n  // 4\n  if (sceneNum === 4) {\n    return generateScene4EntryReplacement(data);\n  }\n\n  const scene = DREAM_SCENE_THEMES[sceneNum];\n  if (!scene) {\n    return {\n      userMessage: '[] ...',\n      prefill: '',\n    };\n  }\n\n  // Prompt\n  const continuityPrompt = generateEnhancedMemoryContinuityPrompt(data, sceneNum);\n\n  const userMessage = `[ - ]\n\n\n\n${sceneNum}${scene.title}\n${scene.age}\n${scene.setting}\n${scene.theme}\n${scene.atmosphere}\n${scene.identity}\n${scene.objective}\n\n\n- \n- \n- \n\n${continuityPrompt}\n\n\n- \n- \n- \n- \n- \n\nAI\n1. 2-3\n2. ${scene.age}\n3. ${scene.age}\n4. \n5. \n6. \n\n\n- \n- ${scene.age}\n- \"\"\n- \n- \"\"\n- /${scene.age}`;\n\n  const prefill = `......\n\n`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 10:00\n */\nfunction generateDreamExitReplacement(data: SchemaType): {\n  userMessage: string;\n  prefill: string;\n} {\n  const bodySummary = data..;\n\n  // \n  const sortedParts = Object.entries(bodySummary)\n    .filter(([_, v]) => v > 0)\n    .sort(([, a], [, b]) => b - a);\n\n  const developmentSummary =\n    sortedParts.length > 0 ? sortedParts.map(([part, progress]) => `${part}: ${progress}%`).join('') : '';\n\n  // \n  const isFirstAwakening = data...length === 1;\n\n  const userMessage = `[ - ]\n\n\n\n - \n\n- \n- \n- \n- \n- \n\nAI - \n1. 2-3\n2. \n3. \n4. /\n${isFirstAwakening ? `5. ` : ''}\n\n\n${developmentSummary}\n\n\n- \n- \"\"\"\"\n- `;\n\n  const prefill = `......\n\n`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 5\n * 5\n * - \n * - 08:00-19:00\n * - 20:00\n */\nfunction checkScene5Entry(data: SchemaType, userInput: string): boolean {\n  console.info(\n    `[Scene5Entry] : ${data..}, : ${data..}, : \"${userInput}\"`,\n  );\n\n  // 5\n  if (data.. !== '' && data.. !== '') {\n    console.info('[Scene5Entry] ');\n    return false;\n  }\n\n  // 08:00-19:00\n  const hour = data..;\n  if (hour < 8 || hour >= 20) {\n    console.info(`[Scene5Entry] 8-19: ${hour}`);\n    return false;\n  }\n\n  // 2026-01-17: 52\n  // 11-10211-12+\n  // 3\n  const scene5Data = data..5 as { ?: number } | undefined;\n  const entryCount = scene5Data?. ?? 0;\n  if (entryCount >= 2) {\n    console.info(`[Scene5Entry] 5${entryCount}3`);\n    return false;\n  }\n\n  // \n  const hasKeyword = SLEEPING_PILL_KEYWORDS.some(kw => userInput.includes(kw));\n  console.info(`[Scene5Entry] : ${hasKeyword ? '' : ''}`);\n  return hasKeyword;\n}\n\n/**\n * 1-4\n *\n * 2026-01-17 Day 5 1-4\n * 5Day 5 22:00  Day 6 10:00\n *        Day 6\n */\nfunction checkDreamEntry(data: SchemaType, userInput: string): boolean {\n  // 22:00-01:00\n  if (!TimeSystem.isDreamWindowOpen(data)) return false;\n\n  // \n  if (data.. !== '') return false;\n\n  // 2026-01-17 Day 5 1-4\n  // Day 5 22:00+    Day 6 10:00\n  // 5 Day 6  \n  if (data.. === 5) {\n    console.info('[] Day 5 1-4 Day 6');\n    return false;\n  }\n\n  // Bug #16 \n  // \"\"  \"\"\n  return (\n    DREAM_ENTRY_KEYWORDS.some(kw => userInput.includes(kw)) ||\n    DREAM_ENTRY_PATTERNS.some(pattern => pattern.test(userInput))\n  );\n}\n\n/**\n * \n *\n * Bug #18  10:00  09:00\n *  - promptInjection  AI  AI \n * -  09:00  `=== 10`  false\n * - AI \n * -  10:00\n * - index.ts  10:00\n * - AI \n *\n * \n * - 09:00   AI    10:00  \n */\nfunction checkDreamExit(data: SchemaType): boolean {\n  // \n  if (data.. !== '') return false;\n\n  // 510:0020:00\n  if (isInScene5(data)) {\n    return false; // 5\n  }\n\n  // Bug #18 09:00 1-4\n  //  AI  09:00  10:00 \n  //\n  // Bug #20 **** 9  >= 9\n  // 23:00  >= 9 \n  // 22:00/23:00      09:00 \n  // 9 <=  < 22910\n  const hour = data..;\n  return hour >= 9 && hour < 22;\n}\n\n/**\n * 1-4\n * \n *\n *  _  \n * Bug #6\n *\n * 5checkScene5Entry\n * \n */\nfunction getCurrentDreamScene(data: SchemaType): number {\n  // \n  const day = data.._ ?? data..;\n  // Day 1  1, Day 2  2, ...4\n  return Math.min(day, 4);\n}\n\n// AI\nexport const DAILY_DEVELOPMENT_LIMIT = 20;\n\n/**\n * Bug #11  swipe_id  ROLL \n *\n * 5ROLL1  3 2\n *\n * \n *   - CHAT_COMPLETION_PROMPT_READY  AI  MESSAGE_SWIPED\n *   - ROLL  MESSAGE_SWIPED  CHAT_COMPLETION_PROMPT_READY \n *   - \n *\n * \n *   -  schema \"IDswipe_id\"\n *   - CHAT_COMPLETION_PROMPT_READY \n *     1.  message_id  swipe_id\n *     2. \"\"\n *     3.  message_id  swipe_id    ROLL\n *     4.  message_id   \n */\n\n/**\n *  swipe_id\n * @param messageId ID\n * @returns swipe_id 0\n */\nfunction getSwipeId(messageId: number): number {\n  try {\n    const chat = SillyTavern.chat;\n    if (chat && chat[messageId]) {\n      return chat[messageId].swipe_id ?? 0;\n    }\n  } catch (err) {\n    console.warn(`[Prompt]  swipe_id :`, err);\n  }\n  return 0;\n}\n\n/**\n *  ROLL  swipe_id\n * @param data \n * @param currentMessageId ID\n * @returns true  ROLL \n */\nfunction isRollOperationBySwipeId(data: SchemaType, currentMessageId: number): boolean {\n  const scene5Data = data.?.5;\n  if (!scene5Data?.) {\n    //  ROLL\n    return false;\n  }\n\n  const lastRecord = scene5Data.;\n  const lastMessageId = lastRecord.ID;\n  const lastSwipeId = lastRecord.swipe_id;\n\n  // ID\n  if (lastMessageId === currentMessageId) {\n    const currentSwipeId = getSwipeId(currentMessageId);\n    // swipe_id  ROLL\n    if (currentSwipeId !== lastSwipeId) {\n      console.info(\n        `[Prompt]  ROLL :  ${currentMessageId}, ` +\n          `swipe_id: ${lastSwipeId}  ${currentSwipeId}`,\n      );\n      return true;\n    }\n    // swipe_id  dryRun \n    console.info(`[Prompt] :  ${currentMessageId}, swipe_id=${currentSwipeId}`);\n    return true;\n  }\n\n  // ID ROLL\n  return false;\n}\n\n/**\n * Bug #22  ROLL \n *\n *  ROLL 1  2  2\n *\n * \n * -  schema \"IDswipe_id\"\n * - CHAT_COMPLETION_PROMPT_READY \n *   1.  message_id  swipe_id\n *   2. \"\"\n *   3.  message_id  swipe_id    ROLL\n *   4.  message_id   \n *\n * @param data \n * @param currentMessageId ID\n * @returns true  ROLL \n */\nfunction isAfterStoryRollOperation(data: SchemaType, currentMessageId: number): boolean {\n  const afterStoryData = data..;\n  if (!afterStoryData?.) {\n    //  ROLL\n    return false;\n  }\n\n  const lastRecord = afterStoryData.;\n  const lastMessageId = lastRecord.ID;\n  const lastSwipeId = lastRecord.swipe_id;\n\n  // ID\n  if (lastMessageId === currentMessageId) {\n    const currentSwipeId = getSwipeId(currentMessageId);\n    // swipe_id  ROLL\n    if (currentSwipeId !== lastSwipeId) {\n      console.info(\n        `[Prompt]  ROLL :  ${currentMessageId}, ` +\n          `swipe_id: ${lastSwipeId}  ${currentSwipeId}`,\n      );\n      return true;\n    }\n    // swipe_id  dryRun \n    console.info(\n      `[Prompt] :  ${currentMessageId}, swipe_id=${currentSwipeId}`,\n    );\n    return true;\n  }\n\n  // ID ROLL\n  return false;\n}\n\n/**\n * Bug #21  v2 ROLL \n *\n *  ROLL \"\"\n * checkDreamExit()   !== ''  false\n * \n *\n * v1  swipe_id  ROLL ROLL \n *  PROMPT_READY  ROLL getSwipeId  0\n *\n * v2 \n * -  AI ID\n * - ROLL  PROMPT_READY \n *   - currentMessageId \n *   - AI  = currentMessageId + 1\n *   -   ROLL\n * -  swipe_id ROLL  PROMPT_READY \n *\n * @param data \n * @param currentMessageId ID\n * @returns 1-5 ROLL null  ROLL\n */\nfunction isDreamExitRoll(data: SchemaType, currentMessageId: number): number | null {\n  const exitRecord = data.._;\n\n  // \n  console.info(`[isDreamExitRoll] :`);\n  console.info(`  - currentMessageId (): ${currentMessageId}`);\n  console.info(`  - : ${data..}`);\n  console.info(`  - exitRecord : ${!!exitRecord}`);\n\n  if (!exitRecord) {\n    console.info(`  - :  null`);\n    return null;\n  }\n\n  // exitRecord.ID  AI  + 1\n  const aiReplyFloor = exitRecord.ID;\n  const sceneNum = exitRecord.;\n\n  // PROMPT_READY currentMessageId \n  // AI  = currentMessageId + 1\n  const expectedAiFloor = currentMessageId + 1;\n\n  console.info(`  -  AI : ${aiReplyFloor}`);\n  console.info(`  - : ${sceneNum}`);\n  console.info(`  -  AI  (currentMessageId+1): ${expectedAiFloor}`);\n\n  // Bug #21  v2\n  //  ROLL \n  //  swipe_id ROLL swipe_id \n  if (aiReplyFloor === expectedAiFloor) {\n    // \n    if (data.. === '') {\n      console.info(\n        `[Prompt]  ROLL : ` +\n          `${sceneNum ?? ''} ${aiReplyFloor}=`,\n      );\n      return sceneNum ?? null;\n    } else {\n      console.info(`  - :  (${data..}) null`);\n    }\n  } else {\n    console.info(`  - :  (${aiReplyFloor} !== ${expectedAiFloor}) null`);\n  }\n\n  return null;\n}\n\n/**\n *  ROLL \n *\n *  ROLL \"\"\n * checkDreamEntry()  checkScene5Entry()   !== ''  false\n * \n *\n *  isDreamExitRoll\n * -  AI ID\n * - ROLL  PROMPT_READY \n *   - currentMessageId \n *   - AI  = currentMessageId + 1\n *   -   ROLL\n *\n * @param data \n * @param currentMessageId ID\n * @returns  { sceneNum, type }  ROLL null  ROLL\n */\nfunction isDreamEntryRoll(\n  data: SchemaType,\n  currentMessageId: number,\n): { sceneNum: number; type: '' | '5' } | null {\n  const entryRecord = data.._;\n\n  console.info(`[isDreamEntryRoll] :`);\n  console.info(`  - currentMessageId (): ${currentMessageId}`);\n  console.info(`  - : ${data..}`);\n  console.info(`  - entryRecord : ${!!entryRecord}`);\n\n  if (!entryRecord) {\n    console.info(`  - :  null`);\n    return null;\n  }\n\n  // entryRecord.ID  AI  + 1\n  const aiReplyFloor = entryRecord.ID;\n  const sceneNum = entryRecord.;\n  const entryType = entryRecord.;\n\n  // PROMPT_READY currentMessageId \n  // AI  = currentMessageId + 1\n  const expectedAiFloor = currentMessageId + 1;\n\n  console.info(`  -  AI : ${aiReplyFloor}`);\n  console.info(`  - : ${sceneNum}`);\n  console.info(`  - : ${entryType}`);\n  console.info(`  -  AI  (currentMessageId+1): ${expectedAiFloor}`);\n\n  //  ROLL \n  if (aiReplyFloor === expectedAiFloor) {\n    // \n    if (data.. === '') {\n      console.info(\n        `[Prompt]  ROLL : ` +\n          `${sceneNum ?? ''}=${entryType ?? ''} ${aiReplyFloor}`,\n      );\n      return {\n        sceneNum: sceneNum ?? 1,\n        type: entryType ?? '',\n      };\n    } else {\n      console.info(`  - :  (${data..}) null`);\n    }\n  } else {\n    console.info(`  - :  (${aiReplyFloor} !== ${expectedAiFloor}) null`);\n  }\n\n  return null;\n}\n\n/**\n *  ROLL \n *\n *  ROLL isActive=true\n * \"\"\"\"\n *\n *  isDreamEntryRoll\n * -  AI ID\n * - ROLL  PROMPT_READY \n *   - currentMessageId \n *   - AI  = currentMessageId + 1\n *   -    ROLL\n *\n * @param data \n * @param currentMessageId ID\n * @returns   ROLL null  ROLL\n */\nfunction isEndingEntryRoll(\n  data: SchemaType,\n  currentMessageId: number,\n): '' | '' | '' | null {\n  const entryRecord = data.._;\n\n  if (!entryRecord) {\n    return null;\n  }\n\n  // entryRecord.ID  AI  + 1\n  const aiReplyFloor = entryRecord.ID;\n  const endingType = entryRecord.;\n\n  // PROMPT_READY currentMessageId \n  // AI  = currentMessageId + 1\n  const expectedAiFloor = currentMessageId + 1;\n\n  //  ROLL \n  if (aiReplyFloor === expectedAiFloor && endingType) {\n    // \n    // isActive\n    const isTrueEndingRoll = endingType === '' && isTrueEndingActive(data);\n    const isPerfectEndingRoll = endingType === '' && isPerfectEndingActive(data);\n    const isFalseEndingRoll = endingType === '' && isFalseEndingActive(data);\n\n    if (isTrueEndingRoll || isPerfectEndingRoll || isFalseEndingRoll) {\n      console.info(`[Prompt]  ROLL : ${endingType} ${aiReplyFloor}`);\n      return endingType;\n    }\n  }\n\n  return null;\n}\n\n//  index.ts\nlet isRollOperation = false;\nexport function setRollOperationFlag(value: boolean): void {\n  isRollOperation = value;\n  // \n}\nfunction checkIsRollOperation(): boolean {\n  return isRollOperation;\n}\nfunction resetRollOperationFlag(): void {\n  isRollOperation = false;\n}\n\n/**\n * \n * 100%50%\n * @returns null\n */\nfunction checkPureLoveWrongRoute(data: SchemaType): string | null {\n  // \n  if (data..) return null;\n\n  const progress = data..;\n  const parts = ['', '', '', '', ''] as const;\n\n  for (const part of parts) {\n    if (progress[part] >= 100) {\n      console.warn(`[Prompt] ${part}  100%`);\n      return part;\n    }\n  }\n\n  return null;\n}\n\n/**\n * \n * \n *  + 50%\n */\nfunction generatePureLoveWrongRouteReplacement(\n  _data: SchemaType,\n  triggeredPart: string,\n): { userMessage: string; prefill: string } {\n  // \n  const wrongRouteScenes: Record<string, { scenario: string; reaction: string }> = {\n    : {\n      scenario: '',\n      reaction: '',\n    },\n    : {\n      scenario: '',\n      reaction: '',\n    },\n    : {\n      scenario: '',\n      reaction: '',\n    },\n    : {\n      scenario: '',\n      reaction: '',\n    },\n    : {\n      scenario: '',\n      reaction: '',\n    },\n  };\n\n  const scene = wrongRouteScenes[triggeredPart] ?? {\n    scenario: '',\n    reaction: '',\n  };\n\n  const userMessage = `[ - ]\n\n\n\n\n${triggeredPart}\n${scene.scenario}\n${scene.reaction}\n\nAI\n1. \n2. \n3. \n4. \n5. \n\n\n- \n- \n- \"\"\"\"`;\n\n  const prefill = `\n\n`;\n\n  return { userMessage, prefill };\n}\n\n/**\n * 5\n */\nfunction isInScene5(data: SchemaType): boolean {\n  if (data.. !== '') return false;\n\n  const scene5Data = data..5 as { ?: boolean } | undefined;\n  return scene5Data?. === true;\n}\n\n/**\n * 5\n *\n * Bug #13 \n * - promptInjection  AI CHAT_COMPLETION_PROMPT_READY\n * -  AI GENERATION_ENDED\n * -  19:00 AI  20:00\n * -  AI \n *\n *  19:00  AI \n * - 19:00   AI    20:00  \n *\n * Bug #20 \n * 508:00-20:00 19:00-21:00 \n *  22:00 5\n */\nfunction checkScene5ForceExit(data: SchemaType): boolean {\n  // 5\n  if (!isInScene5(data)) return false;\n\n  // Bug #13 19:00  AI \n  // Bug #20  19:00-21:59\n  const hour = data..;\n  return hour >= 19 && hour < 22;\n}\n\n/**\n * \n */\nexport function generateFullInjection(\n  data: SchemaType,\n  userInput: string,\n): {\n  systemPrompt: string | null;\n  replaceUserMessage: string | null;\n  prefill: string | null;\n  shouldEnterDream: boolean;\n  shouldExitDream: boolean;\n  shouldEnterScene5: boolean;\n  shouldExitScene5: boolean;\n  shouldProgressScene5Step: boolean;\n  shouldTriggerWrongRoute: boolean;\n  wrongRoutePart: string | null;\n  shouldInterrupt: boolean;\n  interruptionResult: InterruptionCheckResult | null;\n  shouldTriggerBadEnding: boolean;\n  badEndingType: BadEndingType;\n  // \n  shouldTriggerNormalEnding: boolean;\n  normalEndingType: NormalEndingType;\n  // \n  shouldActivateTrueEnding: boolean;\n  shouldProgressTrueEnding: boolean;\n  trueEndingComplete: boolean;\n  // 12\n  shouldActivatePerfectEnding: boolean;\n  shouldProgressPerfectEnding: boolean;\n  perfectEndingComplete: boolean;\n  // \n  shouldActivateFalseEnding: boolean;\n  shouldProgressFalseEnding: boolean;\n  falseEndingComplete: boolean;\n  // \n  shouldActivateAfterStory: boolean;\n  shouldProgressAfterStory: boolean;\n  afterStoryComplete: boolean;\n  isInFreeMode: boolean;\n} {\n  let systemPrompt: string | null = null;\n  let replaceUserMessage: string | null = null;\n  let prefill: string | null = null;\n  let shouldEnterDream = false;\n  // \n  let shouldActivateTrueEndingFlag = false;\n  let shouldProgressTrueEnding = false;\n  let trueEndingComplete = false;\n  // 12\n  let shouldActivatePerfectEndingFlag = false;\n  let shouldProgressPerfectEnding = false;\n  let perfectEndingComplete = false;\n  // \n  let shouldActivateFalseEndingFlag = false;\n  let shouldProgressFalseEnding = false;\n  let falseEndingComplete = false;\n  // \n  let shouldActivateAfterStoryFlag = false;\n  let shouldProgressAfterStory = false;\n  let afterStoryComplete = false;\n  let isInFreeModeFlag = false;\n  let shouldExitDream = false;\n  let shouldEnterScene5 = false;\n  let shouldExitScene5 = false;\n  let shouldProgressScene5Step = false;\n  let shouldTriggerWrongRoute = false;\n  let wrongRoutePart: string | null = null;\n  let shouldInterrupt = false;\n  let interruptionResult: InterruptionCheckResult | null = null;\n  let shouldTriggerBadEnding = false;\n  let badEndingType: BadEndingType = '';\n  let shouldTriggerNormalEnding = false;\n  let normalEndingType: NormalEndingType = '';\n\n  // -1.5. \n  // 2026-01-19 5\n  // \"\"\n  const confusionEndingResult = checkConfusionEnding(data, false); // false = \n  if (confusionEndingResult.triggered) {\n    shouldTriggerBadEnding = true;\n    badEndingType = '';\n    replaceUserMessage = confusionEndingResult.replaceUserMessage;\n    console.info(`[Prompt] `);\n    // \n    return {\n      systemPrompt: null,\n      replaceUserMessage,\n      prefill: null,\n      shouldEnterDream: false,\n      shouldExitDream: false,\n      shouldEnterScene5: false,\n      shouldExitScene5: false,\n      shouldProgressScene5Step: false,\n      shouldTriggerWrongRoute: false,\n      wrongRoutePart: null,\n      shouldInterrupt: false,\n      interruptionResult: null,\n      shouldTriggerBadEnding,\n      badEndingType,\n      shouldTriggerNormalEnding: false,\n      normalEndingType: '',\n      shouldActivateTrueEnding: false,\n      shouldProgressTrueEnding: false,\n      trueEndingComplete: false,\n      shouldActivatePerfectEnding: false,\n      shouldProgressPerfectEnding: false,\n      perfectEndingComplete: false,\n      shouldActivateFalseEnding: false,\n      shouldProgressFalseEnding: false,\n      falseEndingComplete: false,\n      shouldActivateAfterStory: false,\n      shouldProgressAfterStory: false,\n      afterStoryComplete: false,\n      isInFreeMode: false,\n    };\n  }\n\n  // -1.6 5\n  // 2026-01-19 5\n  // >=100100%\n  if (isInScene5(data) && data.. === '') {\n    const currentConfusion = data..;\n    const scene5Data = data..5 as { ?: number } | undefined;\n    const currentStep = scene5Data?. ?? 0;\n\n    // 3-5100\n    if (currentStep >= 3 && currentStep <= 5 && detectWeddingInterruption(userInput)) {\n      console.warn(`[Prompt] 5${currentStep}`);\n\n      // 100markConfusionEnding=true\n      data.. = 100;\n      markConfusionEnding(data, '');\n\n      // \n      applyConfusionEndingState(data);\n      const confusionResult = checkConfusionEnding(data, true); // true = \n\n      return {\n        systemPrompt: null,\n        replaceUserMessage: confusionResult.replaceUserMessage,\n        prefill: null,\n        shouldEnterDream: false,\n        shouldExitDream: false,\n        shouldEnterScene5: false,\n        shouldExitScene5: false,\n        shouldProgressScene5Step: false,\n        shouldTriggerWrongRoute: false,\n        wrongRoutePart: null,\n        shouldInterrupt: false,\n        interruptionResult: null,\n        shouldTriggerBadEnding: true,\n        badEndingType: '',\n        shouldTriggerNormalEnding: false,\n        normalEndingType: '',\n        shouldActivateTrueEnding: false,\n        shouldProgressTrueEnding: false,\n        trueEndingComplete: false,\n        shouldActivatePerfectEnding: false,\n        shouldProgressPerfectEnding: false,\n        perfectEndingComplete: false,\n        shouldActivateFalseEnding: false,\n        shouldProgressFalseEnding: false,\n        falseEndingComplete: false,\n        shouldActivateAfterStory: false,\n        shouldProgressAfterStory: false,\n        afterStoryComplete: false,\n        isInFreeMode: false,\n      };\n    }\n\n    // \n    if (detectSexualBehavior(userInput)) {\n      const increment = getViolationIncrement(data);\n      const predictedConfusion = currentConfusion + increment;\n\n      if (predictedConfusion >= 100) {\n        console.warn(\n          `[Prompt] 5${predictedConfusion}${currentConfusion}+${increment}`,\n        );\n\n        // 100\n        data.. = 100;\n        markConfusionEnding(data, '');\n\n        // \n        applyConfusionEndingState(data);\n        const confusionResult = checkConfusionEnding(data, true); // true = \n\n        return {\n          systemPrompt: null,\n          replaceUserMessage: confusionResult.replaceUserMessage,\n          prefill: null,\n          shouldEnterDream: false,\n          shouldExitDream: false,\n          shouldEnterScene5: false,\n          shouldExitScene5: false,\n          shouldProgressScene5Step: false,\n          shouldTriggerWrongRoute: false,\n          wrongRoutePart: null,\n          shouldInterrupt: false,\n          interruptionResult: null,\n          shouldTriggerBadEnding: true,\n          badEndingType: '',\n          shouldTriggerNormalEnding: false,\n          normalEndingType: '',\n          shouldActivateTrueEnding: false,\n          shouldProgressTrueEnding: false,\n          trueEndingComplete: false,\n          shouldActivatePerfectEnding: false,\n          shouldProgressPerfectEnding: false,\n          perfectEndingComplete: false,\n          shouldActivateFalseEnding: false,\n          shouldProgressFalseEnding: false,\n          falseEndingComplete: false,\n          shouldActivateAfterStory: false,\n          shouldProgressAfterStory: false,\n          afterStoryComplete: false,\n          isInFreeMode: false,\n        };\n      }\n    }\n  }\n\n  // -1.5 Bug #24 100\n  //  AI \n  // 100100%\n  // userInput \n  // //\n  if (data.. === '' && data..) {\n    const suspicionResult = calculateSuspicionIncrease(data, userInput);\n    const predictedSuspicion = data.. + suspicionResult.;\n\n    if (predictedSuspicion >= 100 && data.. === '') {\n      console.warn(\n        `[Prompt] ${predictedSuspicion}${data..}+${suspicionResult.}`,\n      );\n\n      //  checkBadEnding \n      // Bug #XX 100\n      data.. = 100;\n      const badEndingResult = checkBadEnding(data);\n\n      if (badEndingResult.triggered) {\n        // Bug #XX \n        applyBadEndingState(data, badEndingResult.type);\n        return {\n          systemPrompt: null,\n          replaceUserMessage: badEndingResult.replaceUserMessage,\n          prefill: null,\n          shouldEnterDream: false,\n          shouldExitDream: false,\n          shouldEnterScene5: false,\n          shouldExitScene5: false,\n          shouldProgressScene5Step: false,\n          shouldTriggerWrongRoute: false,\n          wrongRoutePart: null,\n          shouldInterrupt: false,\n          interruptionResult: null,\n          shouldTriggerBadEnding: true,\n          badEndingType: badEndingResult.type,\n          shouldTriggerNormalEnding: false,\n          normalEndingType: '',\n          shouldActivateTrueEnding: false,\n          shouldProgressTrueEnding: false,\n          trueEndingComplete: false,\n          shouldActivatePerfectEnding: false,\n          shouldProgressPerfectEnding: false,\n          perfectEndingComplete: false,\n          shouldActivateFalseEnding: false,\n          shouldProgressFalseEnding: false,\n          falseEndingComplete: false,\n          shouldActivateAfterStory: false,\n          shouldProgressAfterStory: false,\n          afterStoryComplete: false,\n          isInFreeMode: false,\n        };\n      }\n    }\n  }\n\n  // -1. >=100\n  // \n  const badEndingResult = checkBadEnding(data);\n  if (badEndingResult.triggered) {\n    shouldTriggerBadEnding = true;\n    badEndingType = badEndingResult.type;\n    replaceUserMessage = badEndingResult.replaceUserMessage;\n    // Bug #XX \n    applyBadEndingState(data, badEndingResult.type);\n    console.info(`[Prompt] /${badEndingResult.type}`);\n    // \n    return {\n      systemPrompt: null,\n      replaceUserMessage,\n      prefill: null,\n      shouldEnterDream: false,\n      shouldExitDream: false,\n      shouldEnterScene5: false,\n      shouldExitScene5: false,\n      shouldProgressScene5Step: false,\n      shouldTriggerWrongRoute: false,\n      wrongRoutePart: null,\n      shouldInterrupt: false,\n      interruptionResult: null,\n      shouldTriggerBadEnding,\n      badEndingType,\n      shouldTriggerNormalEnding: false,\n      normalEndingType: '',\n      shouldActivateTrueEnding: false,\n      shouldProgressTrueEnding: false,\n      trueEndingComplete: false,\n      shouldActivatePerfectEnding: false,\n      shouldProgressPerfectEnding: false,\n      perfectEndingComplete: false,\n      shouldActivateFalseEnding: false,\n      shouldProgressFalseEnding: false,\n      falseEndingComplete: false,\n      shouldActivateAfterStory: false,\n      shouldProgressAfterStory: false,\n      afterStoryComplete: false,\n      isInFreeMode: false,\n    };\n  }\n\n  // -0.5. \n  //  index.ts  checkEnding() \n  // \n  if (isInNormalEndingLock(data)) {\n    const normalEndingResult = checkNormalEnding(data);\n    shouldTriggerNormalEnding = true;\n    normalEndingType = normalEndingResult.type;\n    replaceUserMessage = normalEndingResult.replaceUserMessage;\n    console.info(`[Prompt] ${normalEndingResult.type}`);\n    // \n    return {\n      systemPrompt: null,\n      replaceUserMessage,\n      prefill: null,\n      shouldEnterDream: false,\n      shouldExitDream: false,\n      shouldEnterScene5: false,\n      shouldExitScene5: false,\n      shouldProgressScene5Step: false,\n      shouldTriggerWrongRoute: false,\n      wrongRoutePart: null,\n      shouldInterrupt: false,\n      interruptionResult: null,\n      shouldTriggerBadEnding: false,\n      badEndingType: '',\n      shouldTriggerNormalEnding,\n      normalEndingType,\n      shouldActivateTrueEnding: false,\n      shouldProgressTrueEnding: false,\n      trueEndingComplete: false,\n      shouldActivatePerfectEnding: false,\n      shouldProgressPerfectEnding: false,\n      perfectEndingComplete: false,\n      shouldActivateFalseEnding: false,\n      shouldProgressFalseEnding: false,\n      falseEndingComplete: false,\n      shouldActivateAfterStory: false,\n      shouldProgressAfterStory: false,\n      afterStoryComplete: false,\n      isInFreeMode: false,\n    };\n  }\n\n  // 0. \n  const triggeredPart = checkPureLoveWrongRoute(data);\n  if (triggeredPart) {\n    shouldTriggerWrongRoute = true;\n    wrongRoutePart = triggeredPart;\n    const replacement = generatePureLoveWrongRouteReplacement(data, triggeredPart);\n    replaceUserMessage = replacement.userMessage;\n    prefill = replacement.prefill;\n    console.info(`[Prompt] ${triggeredPart}`);\n    // \n    return {\n      systemPrompt: null,\n      replaceUserMessage,\n      prefill,\n      shouldEnterDream: false,\n      shouldExitDream: false,\n      shouldEnterScene5: false,\n      shouldExitScene5: false,\n      shouldProgressScene5Step: false,\n      shouldTriggerWrongRoute,\n      wrongRoutePart,\n      shouldInterrupt: false,\n      interruptionResult: null,\n      shouldTriggerBadEnding: false,\n      badEndingType: '',\n      shouldTriggerNormalEnding: false,\n      normalEndingType: '',\n      shouldActivateTrueEnding: false,\n      shouldProgressTrueEnding: false,\n      trueEndingComplete: false,\n      shouldActivatePerfectEnding: false,\n      shouldProgressPerfectEnding: false,\n      perfectEndingComplete: false,\n      shouldActivateFalseEnding: false,\n      shouldProgressFalseEnding: false,\n      falseEndingComplete: false,\n      shouldActivateAfterStory: false,\n      shouldProgressAfterStory: false,\n      afterStoryComplete: false,\n      isInFreeMode: false,\n    };\n  }\n\n  // 0.5 \n  // \n  // Bug #23 \n  const isDreamExitMessage = data.. !== undefined;\n  if (isDreamExitMessage) {\n    console.info(`[Prompt] `);\n  }\n\n  if (data.. === '' && userInput && !isDreamExitMessage) {\n    const boundaryResult = checkBoundaryInterruption(data, userInput);\n\n    // \n    if (boundaryResult.violatedParts.length > 0) {\n      interruptionResult = boundaryResult;\n\n      //  + \n      if (boundaryResult.wasInterrupted && boundaryResult.correctionPrompt) {\n        shouldInterrupt = true;\n        replaceUserMessage = boundaryResult.correctionPrompt;\n        console.info(\n          `[Prompt] ${boundaryResult.severity}` +\n            `[${boundaryResult.violatedParts.join(', ')}]` +\n            `${boundaryResult.realmGap}`,\n        );\n        // \n        return {\n          systemPrompt: null,\n          replaceUserMessage,\n          prefill: null,\n          shouldEnterDream: false,\n          shouldExitDream: false,\n          shouldEnterScene5: false,\n          shouldExitScene5: false,\n          shouldProgressScene5Step: false,\n          shouldTriggerWrongRoute: false,\n          wrongRoutePart: null,\n          shouldInterrupt,\n          interruptionResult,\n          shouldTriggerBadEnding: false,\n          badEndingType: '',\n          shouldTriggerNormalEnding: false,\n          normalEndingType: '',\n          shouldActivateTrueEnding: false,\n          shouldProgressTrueEnding: false,\n          trueEndingComplete: false,\n          shouldActivatePerfectEnding: false,\n          shouldProgressPerfectEnding: false,\n          perfectEndingComplete: false,\n          shouldActivateFalseEnding: false,\n          shouldProgressFalseEnding: false,\n          falseEndingComplete: false,\n          shouldActivateAfterStory: false,\n          shouldProgressAfterStory: false,\n          afterStoryComplete: false,\n          isInFreeMode: false,\n        };\n      }\n\n      // \n      if (boundaryResult.correctionPrompt && !boundaryResult.wasInterrupted) {\n        console.info(\n          `[Prompt] ${boundaryResult.severity}` +\n            `[${boundaryResult.violatedParts.join(', ')}]` +\n            ``,\n        );\n        // AI\n        systemPrompt = boundaryResult.correctionPrompt;\n      }\n    }\n  }\n\n  // 1. 520:00\n  if (checkScene5ForceExit(data)) {\n    shouldExitScene5 = true;\n    const replacement = generateScene5ForceExitReplacementNew(data);\n    replaceUserMessage = replacement.userMessage;\n    prefill = replacement.prefill;\n    console.info('[Prompt] 520:00');\n  }\n\n  // 1.5.  ROLL \n  //  ROLL \"\"\n  const entryRollMessageId = getLastMessageId();\n  const dreamEntryRollInfo = isDreamEntryRoll(data, entryRollMessageId);\n\n  // 2. 5  ROLL\n  if (!shouldExitScene5 && (checkScene5Entry(data, userInput) || dreamEntryRollInfo?.type === '5')) {\n    shouldEnterScene5 = true;\n    const replacement = generateScene5EntryReplacementNew(data);\n    replaceUserMessage = replacement.userMessage;\n    prefill = replacement.prefill;\n    console.info(`[Prompt] 5${dreamEntryRollInfo ? 'ROLL ' : ''}`);\n  }\n\n  // 2.5 5512\n  if (!shouldExitScene5 && !shouldEnterScene5 && isInScene5(data)) {\n    // 2.5.1 5/\n    // \n    const violationResult = checkScene5Violations(data, userInput);\n\n    if (violationResult.shouldMarkConfusion) {\n      // \n      markConfusionEnding(data, violationResult.reason!);\n      console.warn(`[Prompt] 5=${violationResult.reason}`);\n      // 51\n    } else if (violationResult.shouldWarn && violationResult.warningMessage) {\n      // +\n      console.warn(`[Prompt] 5`);\n      // AI\n      // \n      if (systemPrompt) {\n        systemPrompt = `${systemPrompt}\\n\\n---\\n\\n5\\n${violationResult.warningMessage}`;\n      } else {\n        systemPrompt = `5\\n${violationResult.warningMessage}`;\n      }\n    }\n\n    const completion = calculateScene5CompletionNew(data);\n    // 12\n    if (!completion.isStepsComplete && completion.currentStep < 12) {\n      // Bug #11  prompt  ROLL\n      //  ROLL  prompt\n      const currentMessageId = getLastMessageId();\n      const isRoll = isRollOperationBySwipeId(data, currentMessageId);\n\n      if (isRoll && completion.currentStep > 0) {\n        //  ROLL \n        // 1.  1 prompt\n        // 2.  shouldProgressScene5Step\n        const tempData = JSON.parse(JSON.stringify(data)) as SchemaType;\n        if (tempData..5) {\n          tempData..5. = completion.currentStep - 1;\n        }\n        const replacement = generateScene5StepReplacement(tempData, userInput);\n        replaceUserMessage = replacement.userMessage;\n        if (replacement.prefill) {\n          prefill = replacement.prefill;\n        }\n        //  shouldProgressScene5Step = true\n        //  swipe_id \n        shouldProgressScene5Step = true; //  true  swipe_id \n        console.info(`[Prompt] ROLL  ${completion.currentStep}/12  prompt`);\n      } else {\n        //  prompt\n        shouldProgressScene5Step = true;\n        const replacement = generateScene5StepReplacement(data, userInput);\n        replaceUserMessage = replacement.userMessage;\n        if (replacement.prefill) {\n          prefill = replacement.prefill;\n        }\n        console.info(`[Prompt] 5${completion.currentStep + 1}/12`);\n      }\n    } else if (completion.isStepsComplete || completion.currentStep >= 12) {\n      // 2026-01-17 12\n      // prompt\n      const replacement = generateScene5FreePlayReplacement(data, userInput);\n      replaceUserMessage = replacement.userMessage;\n      if (replacement.prefill) {\n        prefill = replacement.prefill;\n      }\n      console.info(\n        `[Prompt] 5=${completion.completionPercent}%=${19 - data..}19:00`,\n      );\n    }\n  }\n\n  // 3. 1-4  ROLL\n  const isNormalDreamRoll = dreamEntryRollInfo?.type === '';\n  if (!shouldEnterScene5 && !shouldExitScene5 && (checkDreamEntry(data, userInput) || isNormalDreamRoll)) {\n    shouldEnterDream = true;\n    // ROLL \n    const sceneNum = isNormalDreamRoll ? dreamEntryRollInfo.sceneNum : getCurrentDreamScene(data);\n    const replacement = generateDreamEntryReplacement(data, sceneNum);\n    replaceUserMessage = replacement.userMessage;\n    prefill = replacement.prefill;\n    console.info(`[Prompt] ${sceneNum}${isNormalDreamRoll ? 'ROLL ' : ''}`);\n  }\n\n  // 4. 10:00   ROLL \n  // Bug #21  ROLL1-4  5\n  //  ROLL \"\"checkDreamExit  false\n  //  ROLL\n  const currentMessageId = getLastMessageId();\n  const dreamExitRollSceneNum = isDreamExitRoll(data, currentMessageId);\n\n  // 5 ROLL\n  if (dreamExitRollSceneNum === 5) {\n    shouldExitScene5 = true;\n    const replacement = generateScene5ForceExitReplacementNew(data);\n    replaceUserMessage = replacement.userMessage;\n    prefill = replacement.prefill;\n    console.info(`[Prompt] 5ROLL `);\n  }\n  // 1-4 ROLL\n  else if (!shouldExitScene5 && (checkDreamExit(data) || dreamExitRollSceneNum !== null)) {\n    shouldExitDream = true;\n    const replacement = generateDreamExitReplacement(data);\n    replaceUserMessage = replacement.userMessage;\n    prefill = replacement.prefill;\n    console.info(`[Prompt] ${dreamExitRollSceneNum !== null ? 'ROLL ' : ''}`);\n  }\n\n  // 5. AI\n  //  AI \n  if (data..) {\n    const bodyInfluencePrompt = generateBodyPartInfluencePrompt(data);\n    if (bodyInfluencePrompt) {\n      systemPrompt = bodyInfluencePrompt;\n    }\n  }\n\n  // 5.5 AI\n  // Bug #8 \n  if (data.. === '' || shouldEnterScene5 || shouldEnterDream) {\n    const dreamFeedbackPrompt = generateDreamProgressFeedbackPrompt();\n    if (systemPrompt) {\n      systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${dreamFeedbackPrompt}`;\n    } else {\n      systemPrompt = dreamFeedbackPrompt;\n    }\n  }\n\n  // 6. Prompt/\n  // D9Prompt\n  // Bug #8 ''\n  // AI\"\"\"\"\n  const phaseOverride = shouldEnterScene5 || shouldEnterDream ? '' : undefined;\n  const consistencyPrompt = generatePhaseAwareStatePrompt(data, phaseOverride);\n  console.info(\n    `[Prompt] : ${data..}${phaseOverride ? ` (: ${phaseOverride})` : ''}`,\n  );\n\n  if (systemPrompt) {\n    systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${consistencyPrompt}`;\n  } else {\n    systemPrompt = consistencyPrompt;\n  }\n\n  // 6.5 5\n  // AI\n  const confusionForeshadowing = getConfusionForeshadowing(data);\n  if (confusionForeshadowing && data.. === '') {\n    if (systemPrompt) {\n      systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${confusionForeshadowing}`;\n    } else {\n      systemPrompt = confusionForeshadowing;\n    }\n    console.info(`[Prompt] `);\n  }\n\n  // 7.  ROLL \n  const endingRollMessageId = getLastMessageId();\n  const endingEntryRollType = isEndingEntryRoll(data, endingRollMessageId);\n\n  // Bug #39 \n  // \"\"\n  // \n  const endingGuidance = getEndingGuidance(data);\n  if (endingGuidance) {\n    if (systemPrompt) {\n      systemPrompt = `${endingGuidance}\\n\\n---\\n\\n${systemPrompt}`;\n    } else {\n      systemPrompt = endingGuidance;\n    }\n    console.info(`[Prompt] Bug #39 ${data..}`);\n  }\n\n  // \n  // Bug #40 AI\n  // AI\n  const isInDreamOrEntering = data.. === '' || shouldEnterDream || shouldEnterScene5;\n  let currentDreamSceneNumber: number | undefined; // \n  if (isInDreamOrEntering) {\n    const dreamSceneGuidance = getDreamSceneGuidance(data);\n    if (dreamSceneGuidance) {\n      if (systemPrompt) {\n        systemPrompt = `${dreamSceneGuidance}\\n\\n---\\n\\n${systemPrompt}`;\n      } else {\n        systemPrompt = dreamSceneGuidance;\n      }\n      const completedScenes = data.. || [];\n      console.info(`[Prompt] : [${completedScenes.join(', ')}]`);\n    }\n\n    // \n    if (shouldEnterScene5) {\n      currentDreamSceneNumber = 5;\n    } else {\n      currentDreamSceneNumber = getCurrentDreamScene(data);\n    }\n  }\n\n  // Bug #40 \n  // AI\n  // \n  // - \n  // - AI\n  if (data..) {\n    const dreamHistoryBackground = generateDreamHistoryBackground(data, currentDreamSceneNumber);\n    if (dreamHistoryBackground) {\n      if (systemPrompt) {\n        systemPrompt = `${dreamHistoryBackground}\\n\\n---\\n\\n${systemPrompt}`;\n      } else {\n        systemPrompt = dreamHistoryBackground;\n      }\n      const completedScenes = data.. || [];\n      const excludeInfo = currentDreamSceneNumber ? `${currentDreamSceneNumber}` : '';\n      console.info(`[Prompt] : [${completedScenes.join(', ')}]${excludeInfo}`);\n    }\n  }\n\n  // 7.1 12\n  // Day 5, 11:00+ + 5 + =3\n  const isPerfectEndingRoll = endingEntryRollType === '';\n  if (!isPerfectEndingActive(data) && shouldActivatePerfectEnding(data)) {\n    shouldActivatePerfectEndingFlag = true;\n    // 12\n    const entryReplacement = generatePerfectEndingEntryReplacement();\n    replaceUserMessage = entryReplacement.userMessage;\n    prefill = entryReplacement.prefill;\n    console.info('[Prompt] 12');\n  }\n  // ROLL  ROLL\n  else if (isPerfectEndingRoll) {\n    const entryReplacement = generatePerfectEndingEntryReplacement();\n    replaceUserMessage = entryReplacement.userMessage;\n    prefill = entryReplacement.prefill;\n    console.info('[Prompt] ROLL ');\n  }\n  // \n  else if (isPerfectEndingActive(data)) {\n    const state = getPerfectEndingState(data);\n\n    // \n    if (state.isComplete) {\n      perfectEndingComplete = true;\n      const completeMessage = generatePerfectEndingComplete();\n      replaceUserMessage = completeMessage;\n      console.info('[Prompt] ');\n    } else {\n      // 21:00  23:00\n      const isFreeTime = isPerfectEndingFreeTime(data);\n\n      if (isFreeTime) {\n        // \n        const freeTimePrompt = generatePerfectFreeTimePrompt(data..);\n        if (systemPrompt) {\n          systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${freeTimePrompt}`;\n        } else {\n          systemPrompt = freeTimePrompt;\n        }\n        console.info(`[Prompt] ${data..}:00`);\n      } else {\n        shouldProgressPerfectEnding = true;\n        // AIPrompt\n        const perfectEndingPrompt = generatePerfectEndingPrompt(state, userInput);\n        if (systemPrompt) {\n          systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${perfectEndingPrompt}`;\n        } else {\n          systemPrompt = perfectEndingPrompt;\n        }\n        console.info(\n          `[Prompt] ${state.currentPhase}${state.currentPhase <= 11 ? ['', '', '', '', '', '', '', '', '', '', '', ''][state.currentPhase] : ''}${state.turnsInPhase}`,\n        );\n      }\n    }\n  }\n\n  // 7.2 Day 5, 11:00+ <3\n  // \n  const isTrueEndingRoll = endingEntryRollType === '';\n  if (!isPerfectEndingActive(data) && !isTrueEndingActive(data) && shouldActivateTrueEnding(data)) {\n    shouldActivateTrueEndingFlag = true;\n    // \n    const entryReplacement = generateTrueEndingEntryReplacement(data);\n    replaceUserMessage = entryReplacement.userMessage;\n    prefill = entryReplacement.prefill;\n    console.info('[Prompt] 10');\n  }\n  // ROLL  ROLL\n  else if (isTrueEndingRoll && !isPerfectEndingActive(data)) {\n    const entryReplacement = generateTrueEndingEntryReplacement(data);\n    replaceUserMessage = entryReplacement.userMessage;\n    prefill = entryReplacement.prefill;\n    console.info('[Prompt] ROLL ');\n  }\n  // \n  else if (isTrueEndingActive(data) && !isPerfectEndingActive(data)) {\n    const state = getTrueEndingState(data);\n\n    // \n    if (state.isComplete) {\n      trueEndingComplete = true;\n      const completeMessage = generateTrueEndingComplete(data);\n      replaceUserMessage = completeMessage;\n      console.info('[Prompt] ');\n    } else {\n      // 21:00  23:00\n      const isFreeTime = isFreeTimeHour(data);\n      const guidanceType = getGuidanceType(data);\n\n      if (isFreeTime) {\n        // \n        const freeTimePrompt = generateTimeBasedPrompt(data, state, userInput);\n        if (freeTimePrompt) {\n          if (systemPrompt) {\n            systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${freeTimePrompt}`;\n          } else {\n            systemPrompt = freeTimePrompt;\n          }\n        }\n        console.info(`[Prompt] ${data..}:00`);\n      } else {\n        shouldProgressTrueEnding = true;\n        // AIPrompt\n        const trueEndingPrompt =\n          generateTimeBasedPrompt(data, state, userInput) || generateTrueEndingPrompt(state, userInput);\n        if (systemPrompt) {\n          systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${trueEndingPrompt}`;\n        } else {\n          systemPrompt = trueEndingPrompt;\n        }\n        console.info(\n          `[Prompt] ${state.currentPhase}${state.turnsInPhase}${guidanceType}`,\n        );\n      }\n    }\n  }\n\n  // 8. Day 5, 20:00+ \n  // \n  const isFalseEndingRoll = endingEntryRollType === '';\n  if (!isFalseEndingActive(data) && shouldActivateFalseEnding(data)) {\n    shouldActivateFalseEndingFlag = true;\n    // \n    const entryReplacement = generateFalseEndingEntryReplacement();\n    replaceUserMessage = entryReplacement.userMessage;\n    prefill = entryReplacement.prefill;\n    console.info('[Prompt] ');\n  }\n  // ROLL  ROLL\n  else if (isFalseEndingRoll) {\n    // ROLL \n    const entryReplacement = generateFalseEndingEntryReplacement();\n    replaceUserMessage = entryReplacement.userMessage;\n    prefill = entryReplacement.prefill;\n    console.info('[Prompt] ROLL ');\n  }\n  // \n  else if (isFalseEndingActive(data)) {\n    const state = getFalseEndingState(data);\n\n    // \n    if (state.isComplete) {\n      falseEndingComplete = true;\n      const completeMessage = generateFalseEndingComplete();\n      replaceUserMessage = completeMessage;\n      console.info('[Prompt] ');\n    } else {\n      shouldProgressFalseEnding = true;\n      // AIPrompt\n      const falseEndingPrompt = generateFalseEndingPrompt(state, userInput);\n      if (systemPrompt) {\n        systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${falseEndingPrompt}`;\n      } else {\n        systemPrompt = falseEndingPrompt;\n      }\n      console.info(`[Prompt] ${state.currentPhase}${state.turnsInPhase}`);\n    }\n  }\n\n  // 8. \n  // \n  if (isInFreeMode(data)) {\n    isInFreeModeFlag = true;\n    const freeModePrompt = generateFreeModePrompt(data);\n    if (freeModePrompt) {\n      if (systemPrompt) {\n        systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${freeModePrompt}`;\n      } else {\n        systemPrompt = freeModePrompt;\n      }\n    }\n    console.info('[Prompt] ');\n  }\n  // \n  else if (shouldTriggerAfterStory(data)) {\n    shouldActivateAfterStoryFlag = true;\n    const entryReplacement = generateAfterStoryEntryReplacement(data);\n    if (entryReplacement) {\n      replaceUserMessage = entryReplacement.userMessage;\n      prefill = entryReplacement.prefill;\n    }\n    console.info('[Prompt] ');\n  }\n  // \n  else if (isInAfterStory(data)) {\n    const currentRound = data..?. ?? 1;\n\n    // 2\n    if (currentRound >= 2) {\n      afterStoryComplete = true;\n      const completeMessage = generateAfterStoryComplete(data);\n      replaceUserMessage = completeMessage;\n      console.info('[Prompt] ');\n    } else {\n      shouldProgressAfterStory = true;\n      // AIPrompt\n      const afterStoryPrompt = generateAfterStoryPrompt(data);\n      if (afterStoryPrompt) {\n        if (systemPrompt) {\n          systemPrompt = `${systemPrompt}\\n\\n---\\n\\n${afterStoryPrompt}`;\n        } else {\n          systemPrompt = afterStoryPrompt;\n        }\n      }\n      console.info(`[Prompt] ${currentRound}`);\n    }\n  }\n\n  return {\n    systemPrompt,\n    replaceUserMessage,\n    prefill,\n    shouldEnterDream,\n    shouldExitDream,\n    shouldEnterScene5,\n    shouldExitScene5,\n    shouldProgressScene5Step,\n    shouldTriggerWrongRoute,\n    wrongRoutePart,\n    shouldInterrupt,\n    interruptionResult,\n    shouldTriggerBadEnding,\n    badEndingType,\n    shouldTriggerNormalEnding,\n    normalEndingType,\n    shouldActivateTrueEnding: shouldActivateTrueEndingFlag,\n    shouldProgressTrueEnding,\n    trueEndingComplete,\n    shouldActivatePerfectEnding: shouldActivatePerfectEndingFlag,\n    shouldProgressPerfectEnding,\n    perfectEndingComplete,\n    shouldActivateFalseEnding: shouldActivateFalseEndingFlag,\n    shouldProgressFalseEnding,\n    falseEndingComplete,\n    // \n    shouldActivateAfterStory: shouldActivateAfterStoryFlag,\n    shouldProgressAfterStory,\n    afterStoryComplete,\n    isInFreeMode: isInFreeModeFlag,\n  };\n}\n\n/**\n * Prompt\n *  CHAT_COMPLETION_PROMPT_READY \n */\nexport function initPromptInjection(): void {\n  console.info('[Prompt] ');\n\n  //  extended thinking\n  let currentRequestHasExtendedThinking = false;\n\n  eventOn(tavern_events.CHAT_COMPLETION_SETTINGS_READY, (generate_data: any) => {\n    currentRequestHasExtendedThinking = generate_data.include_reasoning === true;\n  });\n\n  eventOn(\n    tavern_events.CHAT_COMPLETION_PROMPT_READY,\n    (event_data: Parameters<ListenerType['chat_completion_prompt_ready']>[0]) => {\n      try {\n        const { chat, dryRun } = event_data;\n\n        // dryRun  token\n        if (dryRun) {\n          console.info('[Prompt] dryRun=true');\n          return;\n        }\n\n        // \n        const variables = Mvu.getMvuData({ type: 'message', message_id: -1 });\n        const statData = _.get(variables, 'stat_data');\n\n        if (!statData) {\n          console.warn('[Prompt] stat_data ');\n          return;\n        }\n\n        const data = Schema.parse(statData);\n\n        // Bug #28 \n        //  chat  userInput  \"Now go ahead MW and pass the review.\"\n        //  getChatMessages API \n        let userInput = '';\n        let lastUserIndex = -1;\n\n        //  getChatMessages \n        try {\n          // getChatMessages(-1) AI\n          // getChatMessages(-2) \n          //  beforeSending -1 \n          const lastMessages = getChatMessages(-1);\n          if (lastMessages && lastMessages.length > 0) {\n            const lastMessage = lastMessages[0];\n            if (lastMessage.role === 'user' && lastMessage.message) {\n              userInput = lastMessage.message;\n              console.info(`[Prompt]  getChatMessages : \"${userInput.substring(0, 50)}...\"`);\n            }\n          }\n        } catch (msgErr) {\n          console.warn('[Prompt] getChatMessages  chat :', msgErr);\n        }\n\n        // Bug #XX  getChatMessages  lastUserIndex\n        //  replaceUserMessage  chat  user \n        //  getChatMessages lastUserIndex  -1 replaceUserMessage \n        for (let i = chat.length - 1; i >= 0; i--) {\n          if (chat[i].role === 'user') {\n            lastUserIndex = i;\n            //  userInput\n            if (!userInput) {\n              const content = chat[i].content;\n              userInput = typeof content === 'string' ? content : '';\n            }\n            break;\n          }\n        }\n\n        // \n        const {\n          systemPrompt,\n          replaceUserMessage,\n          prefill,\n          shouldEnterDream,\n          shouldExitDream,\n          shouldEnterScene5,\n          shouldExitScene5,\n          shouldProgressScene5Step,\n          shouldTriggerWrongRoute,\n          wrongRoutePart,\n          shouldInterrupt,\n          interruptionResult,\n          shouldTriggerBadEnding,\n          badEndingType,\n          // /\n          shouldTriggerNormalEnding,\n          normalEndingType,\n          shouldActivateTrueEnding: shouldActivateTrueEndingResult,\n          shouldProgressTrueEnding: shouldProgressTrueEndingResult,\n          trueEndingComplete: trueEndingCompleteResult,\n          shouldActivatePerfectEnding: shouldActivatePerfectEndingResult,\n          shouldProgressPerfectEnding: shouldProgressPerfectEndingResult,\n          perfectEndingComplete: perfectEndingCompleteResult,\n          shouldActivateFalseEnding: shouldActivateFalseEndingResult,\n          shouldProgressFalseEnding: shouldProgressFalseEndingResult,\n          falseEndingComplete: falseEndingCompleteResult,\n          // \n          shouldActivateAfterStory: shouldActivateAfterStoryResult,\n          shouldProgressAfterStory: shouldProgressAfterStoryResult,\n          afterStoryComplete: afterStoryCompleteResult,\n          isInFreeMode: isInFreeModeResult,\n        } = generateFullInjection(data, userInput);\n\n        // Bug #XX \n        // generateFullInjection  applyBadEndingState  data\n        //  MVU\n        if (shouldTriggerBadEnding) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            currentData.. = '';\n            currentData.. = '';\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] ${badEndingType}`);\n          } catch (badEndErr) {\n            console.error('[Prompt] :', badEndErr);\n          }\n        }\n\n        // Bug #XX /\n        // generateFullInjection  applyNormalEndingState  data\n        //  MVU\n        if (shouldTriggerNormalEnding) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            const hasEnteredDream = currentData..;\n            const endingType = hasEnteredDream ? '' : '';\n\n            // /\n            currentData.. = endingType;\n            currentData.. = '';\n            //  Day 1, 08:00\n            currentData.. = 1;\n            currentData.. = 8;\n            currentData.. = 'Day 1, 08:00';\n            currentData.. = (currentData.. || 1) + 1;\n            currentData.. = true;\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] ${endingType}${normalEndingType}`);\n          } catch (normalEndErr) {\n            console.error('[Prompt] /:', normalEndErr);\n          }\n        }\n\n        // \n        if (shouldActivatePerfectEndingResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            const initialState = getDefaultPerfectEndingState();\n            initialState.isActive = true;\n            updatePerfectEndingState(currentData, initialState);\n\n            // \n            currentData.. = '';\n            currentData.. = '';\n            currentData.. = true;\n\n            // ROLL\n            const aiReplyFloor = getLastMessageId() + 1;\n            currentData.._ = {\n              ID: aiReplyFloor,\n              : '',\n            };\n            console.info(`[Prompt] : ${aiReplyFloor}`);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] 12');\n          } catch (perfectEndErr) {\n            console.error('[Prompt] :', perfectEndErr);\n          }\n        }\n\n        // \n        if (shouldProgressPerfectEndingResult && !perfectEndingCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            const state = getPerfectEndingState(currentData);\n            // \n            state.turnsInPhase += 1;\n            state.totalTurns += 1;\n            updatePerfectEndingState(currentData, state);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] : ${state.currentPhase}, ${state.turnsInPhase}`);\n          } catch (progressErr) {\n            console.error('[Prompt] :', progressErr);\n          }\n        }\n\n        // \n        if (perfectEndingCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            const state = getPerfectEndingState(currentData);\n            state.isComplete = true;\n            updatePerfectEndingState(currentData, state);\n\n            // \n            currentData.. = true;\n            currentData.. = '';\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (completeErr) {\n            console.error('[Prompt] :', completeErr);\n          }\n        }\n\n        // \n        if (shouldActivateTrueEndingResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            const initialState = getDefaultTrueEndingState();\n            initialState.isActive = true;\n            updateTrueEndingState(currentData, initialState);\n\n            // \n            currentData.. = '';\n            currentData.. = '';\n\n            // ROLL\n            const aiReplyFloor = getLastMessageId() + 1;\n            currentData.._ = {\n              ID: aiReplyFloor,\n              : '',\n            };\n            console.info(`[Prompt] : ${aiReplyFloor}`);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (trueEndErr) {\n            console.error('[Prompt] :', trueEndErr);\n          }\n        }\n\n        // \n        if (shouldProgressTrueEndingResult && !trueEndingCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            const state = getTrueEndingState(currentData);\n            // \n            state.turnsInPhase += 1;\n            state.totalTurns += 1;\n            updateTrueEndingState(currentData, state);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] : ${state.currentPhase}, ${state.turnsInPhase}`);\n          } catch (progressErr) {\n            console.error('[Prompt] :', progressErr);\n          }\n        }\n\n        // \n        if (trueEndingCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            const state = getTrueEndingState(currentData);\n            state.isComplete = true;\n            updateTrueEndingState(currentData, state);\n\n            // \n            currentData.. = true;\n            currentData.. = '';\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (completeErr) {\n            console.error('[Prompt] :', completeErr);\n          }\n        }\n\n        // \n        if (shouldActivateFalseEndingResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            const initialState = getDefaultFalseEndingState();\n            initialState.isActive = true;\n            updateFalseEndingState(currentData, initialState);\n\n            // \n            currentData.. = '';\n            currentData.. = '';\n\n            // ROLL\n            const aiReplyFloor = getLastMessageId() + 1;\n            currentData.._ = {\n              ID: aiReplyFloor,\n              : '',\n            };\n            console.info(`[Prompt] : ${aiReplyFloor}`);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (falseEndErr) {\n            console.error('[Prompt] :', falseEndErr);\n          }\n        }\n\n        // \n        if (shouldProgressFalseEndingResult && !falseEndingCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            const state = getFalseEndingState(currentData);\n            // \n            state.turnsInPhase += 1;\n            state.totalTurns += 1;\n            updateFalseEndingState(currentData, state);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] : ${state.currentPhase}, ${state.turnsInPhase}`);\n          } catch (progressErr) {\n            console.error('[Prompt] :', progressErr);\n          }\n        }\n\n        // \n        if (falseEndingCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            const state = getFalseEndingState(currentData);\n            state.isComplete = true;\n            updateFalseEndingState(currentData, state);\n\n            // \n            currentData.. = true;\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (completeErr) {\n            console.error('[Prompt] :', completeErr);\n          }\n        }\n\n        // \n        if (shouldActivateAfterStoryResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            activateAfterStory(currentData);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (afterStoryErr) {\n            console.error('[Prompt] :', afterStoryErr);\n          }\n        }\n\n        // \n        if (shouldProgressAfterStoryResult && !afterStoryCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // Bug #22  ROLL \n            const afterStoryMessageId = getLastMessageId();\n            const isAfterStoryRoll = isAfterStoryRollOperation(currentData, afterStoryMessageId);\n\n            if (isAfterStoryRoll) {\n              //  ROLL  swipe_id\n              if (currentData..) {\n                const newSwipeId = getSwipeId(afterStoryMessageId);\n                (currentData.. as any). = {\n                  ID: afterStoryMessageId,\n                  swipe_id: newSwipeId,\n                };\n                _.set(currentVars, 'stat_data', currentData);\n                Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n                console.info(`[Prompt]  ROLL  swipe_id=${newSwipeId}`);\n              }\n            } else {\n              //  ROLL\n              advanceAfterStoryRound(currentData);\n\n              // Bug #22 IDswipe_id\n              if (currentData..) {\n                const currentSwipeId = getSwipeId(afterStoryMessageId);\n                (currentData.. as any). = {\n                  ID: afterStoryMessageId,\n                  swipe_id: currentSwipeId,\n                };\n              }\n\n              _.set(currentVars, 'stat_data', currentData);\n              Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n              console.info(`[Prompt] : ${currentData..?.}`);\n            }\n          } catch (progressErr) {\n            console.error('[Prompt] :', progressErr);\n          }\n        }\n\n        // \n        if (afterStoryCompleteResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            if (currentData..) {\n              currentData... = true;\n              currentData... = true;\n            }\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info('[Prompt] ');\n          } catch (completeErr) {\n            console.error('[Prompt] :', completeErr);\n          }\n        }\n\n        // \n        if (shouldTriggerBadEnding) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            applyBadEndingState(currentData, badEndingType);\n\n            // Bug #32  applyConfusionEndingState\n            // generateFullInjection  applyConfusionEndingState \n            //  .  false isFirstTrigger\n            if (badEndingType === '') {\n              applyConfusionEndingState(currentData);\n              console.info(`[Prompt] =${currentData..?.}`);\n            }\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] ${badEndingType}`);\n          } catch (badEndErr) {\n            console.error('[Prompt] :', badEndErr);\n          }\n        }\n\n        // \n        if (shouldInterrupt && interruptionResult) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            applyInterruptionResult(currentData, interruptionResult);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] +${interruptionResult.penalties?. ?? 0}`);\n          } catch (interruptErr) {\n            console.error('[Prompt] :', interruptErr);\n          }\n        }\n\n        // \n        if (!shouldInterrupt && interruptionResult && interruptionResult.penalties?.) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // \n            applyInterruptionResult(currentData, interruptionResult);\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] +${interruptionResult.penalties.}`);\n          } catch (penaltyErr) {\n            console.error('[Prompt] :', penaltyErr);\n          }\n        }\n\n        // \n        // 100%  50% MVU VARIABLE_UPDATE_ENDED \n        if (shouldTriggerWrongRoute) {\n          console.info(`[Prompt] ${wrongRoutePart}AI`);\n          // AI\n        }\n\n        // 5\n        //  index.ts  processGameLogic \n        if (shouldEnterScene5) {\n          console.info('[Prompt] 5');\n        }\n        if (shouldExitScene5) {\n          console.info('[Prompt] 5');\n        }\n\n        // 5\n        /*\n        if (shouldEnterScene5 || shouldExitScene5) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            if (shouldEnterScene5) {\n              currentData.. = '';\n              currentData.. = true; // \n\n              // ID\n              //  getLastMessageId()getCurrentMessageId() \n              const currentMessageId = getLastMessageId();\n              currentData.._ID = currentMessageId;\n              currentData.._ = currentData..; // \n              currentData.. = false;\n\n              if (!currentData..) {\n                currentData.. = true;\n              }\n\n              // /5\n              const existingScene5Data = currentData..5 as {\n                ?: boolean;\n                ?: string;\n                ?: number;\n                ?: number;\n                ?: number;\n                ?: number[];\n                ?: boolean;\n              } | undefined;\n\n              if (!currentData..5) {\n                (currentData. as any).5 = {};\n              }\n\n              const newScene5Data = currentData..5 as {\n                ?: boolean;\n                ?: string;\n                ?: number;\n                ?: number;\n                ?: number;\n                ?: number[];\n                ?: boolean;\n              };\n\n              const newEntryCount = (existingScene5Data?. ?? 0) + 1;\n              newScene5Data. = true;\n              newScene5Data. = currentData..;\n              newScene5Data. = newEntryCount;\n\n              // 12\n              if (newEntryCount === 1) {\n                newScene5Data. = 0;\n                newScene5Data. = 0;\n                newScene5Data. = [];\n                newScene5Data. = false;\n                // 51-2-3\n                lockScene5EntryCoherence(currentData);\n                console.info('[Prompt] 512');\n              }\n\n              console.info(`[Prompt] 5${newEntryCount}`);\n            }\n\n            if (shouldExitScene5) {\n              currentData.. = '';\n              currentData.. = true; // \n\n              // 12580%\n              const completion = calculateScene5CompletionNew(currentData);\n              if (completion.isComplete && !currentData...includes(5)) {\n                currentData...push(5);\n                console.info(`[Prompt] 5: ${completion.completionPercent}%: ${completion.currentStep}/12`);\n              }\n\n              console.info(\n                `[Prompt] 520:00` +\n                `: ${completion.completionPercent}%` +\n                `: ${completion.currentStep}/12` +\n                `: ${completion.isComplete ? '(80%)' : '(<80%)'}`\n              );\n\n              // Bug #21 5ID ROLL\n              const scene5CurrentFloor = getLastMessageId();\n              const scene5AiReplyFloor = scene5CurrentFloor + 1; // AI \n              currentData.._ = {\n                ID: scene5AiReplyFloor,\n                : 5, // 5\n                swipe_id: 0, // \n              };\n              console.info(`[Prompt] 5:  ${scene5AiReplyFloor} (AI)`);\n\n              // 5\n              const dreamEntryId = currentData.._ID;\n              const scene5ExitFloor = scene5CurrentFloor; // Bug #25\n              if (dreamEntryId) {\n                setTimeout(async () => {\n                  let loadingPopup: {\n                    dlg: HTMLDialogElement;\n                    show: () => Promise<void>;\n                    complete: (result: number) => Promise<void>;\n                  } | null = null;\n\n                  try {\n                    SillyTavern.deactivateSendButtons();\n                    console.info('[] 5');\n\n                    loadingPopup = new SillyTavern.Popup(\n                      `<div style=\"text-align: center; padding: 20px;\">\n                        <div style=\"font-size: 18px; margin-bottom: 10px;\">...</div>\n                        <div style=\"color: #888; font-size: 14px;\"></div>\n                        <div style=\"margin-top: 15px;\">\n                          <span style=\"display: inline-block; width: 20px; height: 20px; border: 2px solid #666; border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;\"></span>\n                        </div>\n                        <style>@keyframes spin { to { transform: rotate(360deg); } }</style>\n                      </div>`,\n                      SillyTavern.POPUP_TYPE.TEXT,\n                      '',\n                      {\n                        okButton: false,\n                        cancelButton: false,\n                      }\n                    );\n                    loadingPopup.show();\n                    console.info('[] 5');\n\n                    // Bug #25 ID\n                    const chatHistory = await getDreamSessionMessages(dreamEntryId, scene5ExitFloor);\n                    if (chatHistory) {\n                      const latestVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n                      const latestData = Schema.parse(_.get(latestVars, 'stat_data'));\n\n                      const summary = await generateMemorySummary(latestData, 5, chatHistory);\n                      if (summary) {\n                        if (!latestData..5) {\n                          (latestData. as any).5 = {};\n                        }\n                        // 5  \n                        (latestData..5 as any). = summary;\n                        _.set(latestVars, 'stat_data', latestData);\n                        Mvu.replaceMvuData(latestVars, { type: 'message', message_id: -1 });\n                        console.info(`[] 5`);\n                      }\n                    }\n                  } catch (summaryErr) {\n                    console.error('[] 5/:', summaryErr);\n                  } finally {\n                    if (loadingPopup) {\n                      await loadingPopup.complete(SillyTavern.POPUP_RESULT.AFFIRMATIVE);\n                      console.info('[] 5');\n                    }\n                    SillyTavern.activateSendButtons();\n                    console.info('[] 5');\n                  }\n                }, 100);\n              }\n            }\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] 5: ${shouldEnterScene5 ? '' : ''}`);\n\n            // \n            setTimeout(() => {\n              //  getLastMessageId()getCurrentMessageId() \n              const currentMessageId = getLastMessageId();\n              console.info(`[Prompt]  IFRAME_DATA_REFRESH  (5${shouldEnterScene5 ? '' : ''})`);\n              eventEmit('IFRAME_DATA_REFRESH', {\n                reason: shouldEnterScene5 ? 'SCENE5_ENTERED' : 'SCENE5_EXITED',\n                message_id: currentMessageId,\n              });\n            }, 100);\n          } catch (stateErr) {\n            console.error('[Prompt] 5:', stateErr);\n          }\n        }\n        */\n\n        // 5\n        // Bug #11  swipe_id  ROLL \n        if (shouldProgressScene5Step) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            // ID\n            const currentMessageId = getLastMessageId();\n\n            // Bug #11  ROLL  swipe_id \n            if (isRollOperationBySwipeId(currentData, currentMessageId)) {\n              //  ROLL \n              //  swipe_id swipe\n              if (!currentData..5) {\n                (currentData. as any).5 = {};\n              }\n              const scene5Data = currentData..5 as any;\n              const newSwipeId = getSwipeId(currentMessageId);\n              scene5Data. = {\n                ID: currentMessageId,\n                swipe_id: newSwipeId,\n              };\n              _.set(currentVars, 'stat_data', currentData);\n              Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n              console.info(`[Prompt] ROLL  swipe_id : ${newSwipeId}`);\n            } else {\n              //  ROLL \n\n              // 5\n              if (!currentData..5) {\n                (currentData. as any).5 = {};\n              }\n\n              const scene5Data = currentData..5 as {\n                ?: number;\n                ?: number;\n                ?: number[];\n                ?: boolean;\n                ?: { ID: number; swipe_id: number };\n              };\n\n              // 0-based currentStep + 1\n              const currentStep = scene5Data. ?? 0;\n              const nextStep = currentStep + 1;\n\n              // \n              const intent = analyzePlayerIntent(userInput);\n              const stepConfig = SCENE5_STEPS[currentStep]; // \n              const matchLevel = stepConfig ? calculateMatchLevel(intent, stepConfig) : 'low';\n\n              // +10%+5%\n              const progressGain = matchLevel === 'high' ? 10 : 5;\n\n              // \n              const stepProgressRecord = scene5Data. ?? [];\n              stepProgressRecord.push(progressGain);\n\n              // 100%\n              const newCompletion = Math.min((scene5Data. ?? 0) + progressGain, 100);\n\n              // 5\n              scene5Data. = nextStep;\n              scene5Data. = newCompletion;\n              scene5Data. = stepProgressRecord;\n\n              // Bug #11 IDswipe_id\n              const currentSwipeId = getSwipeId(currentMessageId);\n              scene5Data. = {\n                ID: currentMessageId,\n                swipe_id: currentSwipeId,\n              };\n\n              // 12\n              if (nextStep >= 12) {\n                scene5Data. = true;\n              }\n\n              _.set(currentVars, 'stat_data', currentData);\n              Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n\n              console.info(\n                `[Prompt] 5: ${currentStep}  ${nextStep}` +\n                  `: ${matchLevel}+${progressGain}%` +\n                  `: ${newCompletion}%: ${currentMessageId}, swipe: ${currentSwipeId}`,\n              );\n            }\n          } catch (stateErr) {\n            console.error('[Prompt] 5:', stateErr);\n          }\n        }\n\n        // /\n        if (shouldEnterDream || shouldExitDream) {\n          try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const currentData = Schema.parse(_.get(currentVars, 'stat_data'));\n\n            if (shouldEnterDream) {\n              currentData.. = '';\n              currentData.. = true; // \n\n              // ID\n              //  getLastMessageId()getCurrentMessageId() \n              const currentMessageId = getLastMessageId();\n              currentData.._ID = currentMessageId;\n              currentData.._ = currentData..; // \n              currentData.. = false; // \n\n              if (!currentData..) {\n                currentData.. = true;\n              }\n              // \n              const sceneNum = getCurrentDreamScene(currentData);\n              const sceneKey = `${sceneNum}` as keyof typeof currentData.;\n              if (!currentData.[sceneKey]) {\n                (currentData. as any)[sceneKey] = {};\n              }\n              (currentData.[sceneKey] as any). = true;\n              (currentData.[sceneKey] as any). = currentData..;\n\n              // 1/\n              if (sceneNum === 1) {\n                const initValues = calculateScene1InitValues(currentData);\n                currentData.. = initValues.initialDependence;\n                currentData.. = initValues.initialMorality;\n                console.info(\n                  `[Prompt] 1${currentData..}+${currentData..}  ${initValues.initialDependence}${initValues.initialMorality}${initValues.relationshipStage}`,\n                );\n              }\n\n              console.info(`[Prompt] ID: ${currentMessageId}`);\n\n              // ROLL ID\n              //  ROLL \"\"\n              //  AI  PROMPT_READY  ROLL\n              const aiReplyFloor = currentMessageId + 1;\n              currentData.._ = {\n                ID: aiReplyFloor,\n                : sceneNum,\n                : '',\n              };\n              console.info(`[Prompt] : ${sceneNum} ${aiReplyFloor} (AI)`);\n            }\n\n            if (shouldExitDream) {\n              currentData.. = '';\n              currentData.. = true; // \n              // Bug #38  processSceneCompletion \n              //     \n              const sceneNum = getCurrentDreamScene(currentData);\n              processSceneCompletion(currentData, sceneNum);\n              console.info(`[Prompt] ${sceneNum}`);\n\n              // Bug #21  v2ID ROLL\n              //  AI +1\n              //  ROLL  AI  PROMPT_READY  AI \n              // v2:  swipe_id ROLL  swipe_id \n              const currentFloor = getLastMessageId();\n              const aiReplyFloor = currentFloor + 1; // AI \n              currentData.._ = {\n                ID: aiReplyFloor,\n                : sceneNum, // 1-4\n                swipe_id: 0, // \n              };\n              console.info(`[Prompt] : ${sceneNum} ${aiReplyFloor} (AI)`);\n\n              // \"\"\n              // \n              let dreamEntryId = currentData.._ID;\n\n              // Bug #19  _ID \n              if (dreamEntryId === undefined) {\n                // 10\n                const estimatedEntryId = Math.max(0, currentFloor - 10);\n                console.warn(\n                  `[Prompt] Bug #19 _ID  ${estimatedEntryId} ${currentFloor}`,\n                );\n                dreamEntryId = estimatedEntryId;\n              }\n\n              if (dreamEntryId !== undefined) {\n                // Bug #25 ID\n                const dreamExitId = currentFloor; // \n                currentData.. = {\n                  sceneNum,\n                  dreamEntryId,\n                  dreamExitId, // Bug #25ID\n                };\n                console.info(\n                  `[Prompt] ${sceneNum}ID: ${dreamEntryId}ID: ${dreamExitId}`,\n                );\n              } else {\n                console.warn(`[Prompt] ID`);\n              }\n            }\n\n            _.set(currentVars, 'stat_data', currentData);\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n            console.info(`[Prompt] : ${shouldEnterDream ? '' : ''}`);\n\n            // Bug #15 \n            // 1-4IFRAME_DATA_REFRESH\n            // 5\n            setTimeout(() => {\n              //  getLastMessageId()getCurrentMessageId() \n              const currentMessageId = getLastMessageId();\n              console.info(\n                `[Prompt]  IFRAME_DATA_REFRESH  (${shouldEnterDream ? '' : ''})`,\n              );\n              eventEmit('IFRAME_DATA_REFRESH', {\n                reason: shouldEnterDream ? 'DREAM_ENTERED' : 'DREAM_EXITED',\n                message_id: currentMessageId,\n              });\n            }, 100);\n          } catch (stateErr) {\n            console.error('[Prompt] :', stateErr);\n          }\n        }\n\n        // //\n        if (replaceUserMessage && lastUserIndex !== -1) {\n          chat[lastUserIndex].content = replaceUserMessage;\n          console.info('[Prompt] ');\n        }\n\n        // Bug #9  chat  <status_current_variable> \n        //  {{format_message_variable::stat_data}} \n        //  <status_current_variable>  \": \"  \": \"\n        // AI  <HusbandThought>\n        //  chat  \"\"\n        // \n        const isCurrentlyInDream = data.. === '';\n        const shouldFixDreamPhase = shouldEnterDream || shouldEnterScene5 || isCurrentlyInDream;\n        console.info(\n          `[Bug9] shouldEnterDream=${shouldEnterDream}, shouldEnterScene5=${shouldEnterScene5}, isCurrentlyInDream=${isCurrentlyInDream}, shouldFix=${shouldFixDreamPhase}`,\n        );\n        if (shouldFixDreamPhase) {\n          console.info(`[Bug9] chat: ${chat.length}`);\n          let foundStatusVariable = false;\n          for (const msg of chat) {\n            if (typeof msg.content === 'string') {\n              if (msg.content.includes('<status_current_variable>')) {\n                foundStatusVariable = true;\n                const before = msg.content.match(/:\\s*(|)/g);\n                console.info(`[Bug9] <status_current_variable>: ${JSON.stringify(before)}`);\n                if (before && before.length > 0) {\n                  msg.content = msg.content.replace(/:\\s*(|)/g, ': ');\n                  console.info('[Prompt] Bug #9  <status_current_variable> ');\n                } else {\n                  console.info('[Bug9] <status_current_variable>');\n                }\n              }\n            }\n          }\n          if (!foundStatusVariable) {\n            console.info('[Bug9] <status_current_variable>');\n          }\n        } else {\n          console.info('[Bug9] ');\n        }\n\n        //  user \n        if (systemPrompt) {\n          let firstUserIndex = -1;\n          for (let i = 0; i < chat.length; i++) {\n            if (chat[i].role === 'user') {\n              firstUserIndex = i;\n              break;\n            }\n          }\n          const insertIndex = firstUserIndex === -1 ? chat.length : firstUserIndex;\n          chat.splice(insertIndex, 0, { role: 'system', content: systemPrompt });\n          console.info(`[Prompt] ${insertIndex}`);\n        }\n\n        //  prefill\n        if (prefill) {\n          if (!currentRequestHasExtendedThinking) {\n            chat.push({ role: 'assistant', content: prefill });\n            console.info('[Prompt]  Prefill');\n          } else {\n            // extended thinking  system \n            const prefillGuidance = `\\n${prefill}`;\n            chat.push({ role: 'system', content: prefillGuidance });\n            console.info('[Prompt] Extended thinking Prefill  system ');\n          }\n        }\n\n        // Bug #11  ROLL \n        resetRollOperationFlag();\n      } catch (err) {\n        console.error('[Prompt] :', err);\n        // Bug #11 \n        resetRollOperationFlag();\n      }\n    },\n  );\n\n  console.info('[Prompt] ');\n}\n","/**\n *  - \n *\n *  TIME_LOOP_DESIGN.md BUG\n * -  TimeSystem \n * - \n * - Day 5, 00:00 Day 6 2026-01-17 20:0000:00\n * - \n * - \n * - //\n * -  vs \n * - \n * - \n *\n * \n */\n\nimport { Schema, type Schema as SchemaType } from '../../schema';\nimport { TimeSystem } from './timeSystem';\nimport { validateAndFixState, checkRealmChange } from './stateValidation';\nimport {\n  updateHusbandLocation,\n  getRealmTitle,\n  getStyleGuidance,\n  updateTruthModeValues,\n  updateSuspicionLevel,\n  updateZhaoxiaLocation,\n  updateZhaoxiaThoughtAfterDream,\n} from './appearanceSystem';\nimport { processUserInput } from './dangerousContentDetection';\nimport {\n  updateBodyPartProgress,\n  getBodyPartSummary,\n  processSceneCompletion,\n  generateMemoryContinuityPrompt,\n  SCENE_CORRECT_ANSWERS,\n  generateMemorySummary,\n  getDreamSessionMessages,\n  validateAndProcessAIReport,\n} from './dreamKeywordDetection';\n//  promptInjection.ts A\nimport { parseHusbandThought, shouldGenerateHusbandThought, getCurrentRouteType } from './dualTrackSystem';\nimport { initPromptInjection, setRollOperationFlag } from './promptInjection';\nimport { isTrueEndingActive, getTrueEndingState, updateTrueEndingState, processTurnEnd } from './trueEndingSystem';\nimport {\n  isPerfectEndingActive,\n  getPerfectEndingState,\n  updatePerfectEndingState,\n  processPerfectTurnEnd,\n} from './perfectTrueEndingSystem';\nimport {\n  isFalseEndingActive,\n  getFalseEndingState,\n  updateFalseEndingState,\n  processTurnEnd as processFalseEndingTurnEnd,\n} from './falseEndingSystem';\nimport {\n  createDataSnapshot,\n  validateAndRestoreData,\n  generateProtectionReport,\n  initDataProtection,\n  updateSnapshotValue,\n} from './dataProtection';\nimport { shouldTriggerNormalEnding, applyNormalEndingState } from './normalEndingSystem';\nimport {\n  calculateScene5Completion as calculateScene5CompletionNew,\n  getScene5LockedCoherence,\n  lockScene5EntryCoherence,\n} from './scene5System';\nimport {\n  checkConfusionEnding,\n  applyConfusionEndingState,\n  isInConfusionEndingLock,\n  canEnterDreamForConfusion,\n  checkScene5Violations,\n  markConfusionEnding,\n  setConfusionOnDreamEntry,\n} from './confusionEndingSystem';\n\n/**\n * \n */\ninterface GameEvent {\n  type: string;\n  data: Record<string, unknown>;\n}\n\n// SillyTavern  @types/function/ \n\n/**\n * \n */\nfunction broadcastGameEvent(event: GameEvent): void {\n  console.info(`[] : ${event.type}`, event.data);\n  eventEmit('GAME_EVENT', event);\n}\n\n/**\n * 1-4\n * \n *\n * \n * - Day 1  1, Day 2  2, Day 3  3, Day 4+  4\n *\n *  _  \n *  Day 1 22:00  Day 2 00:00 \n * Bug #6\n *\n * 5promptInjection.tscheckScene5Entry\n * 1-4\n */\nfunction getCurrentDreamScene(data: SchemaType): number {\n  // \n  const day = data.._ ?? data..;\n  // Day 1  1, Day 2  2, ...4\n  return Math.min(day, 4);\n}\n\n/**\n * \n */\nfunction checkEnding(data: SchemaType): boolean {\n  if (!TimeSystem.isEndingTime(data)) {\n    return false;\n  }\n\n  // Bug #18  ''  '' \n  // ''  TimeSystem.advance() \n  //  '' \n  if (data.. !== '' && data.. !== '') {\n    return false;\n  }\n\n  console.info('');\n  console.info(' 600:00Day 5');\n  console.info('');\n\n  data.. = '';\n\n  const  = data...length;\n  const  = data..;\n  const  = data..;\n\n  console.info(`:`);\n  console.info(`- : ${}/5`);\n  console.info(`- : ${}`);\n  console.info(`- : ${}`);\n  console.info(`- : ${data..?. ?? false}`);\n\n  // \n  // 2026-01-19 5\n  const confusionResult = checkConfusionEnding(data, false);\n  if (confusionResult.triggered) {\n    // \n    applyConfusionEndingState(data);\n    data.. = TimeSystem.getCurrentTime(data);\n    console.info(' ');\n    return true;\n  }\n\n  // 100\n  // 100checkConfusionEnding\n  if ( >= 100) {\n    data.. = '';\n    data.. = TimeSystem.getCurrentTime(data);\n    console.info(' ');\n    return true;\n  }\n\n  // /5\n  const  = new Set(data..);\n  const  =\n    .size === 5 &&\n    .has(1) &&\n    .has(2) &&\n    .has(3) &&\n    .has(4) &&\n    .has(5);\n\n  if ( &&  === 5) {\n    // =3\n    const  = getScene5LockedCoherence(data);\n    const  =  === 3;\n\n    if () {\n      data.. = '';\n      data.. = true;\n      console.info('  + ');\n    } else {\n      data.. = '';\n      data.. = false;\n      console.info(' ');\n    }\n\n    data.. = TimeSystem.getCurrentTime(data);\n    data.. = '';\n    console.info(`  - : ${}/3`);\n    return true;\n  }\n\n  // 5\n  if ( &&  > 0 &&  < 5) {\n    data.. = '';\n    data.. = TimeSystem.getCurrentTime(data);\n    data.. = ''; // \n    console.info(` ${5 - }`);\n    return true;\n  }\n\n  // \n  // \n  if (shouldTriggerNormalEnding(data)) {\n    applyNormalEndingState(data);\n    data.. = TimeSystem.getCurrentTime(data);\n    console.info(' ');\n    console.info(`  - : ${.size}/5`);\n    console.info(`  - : ${}`);\n    return true;\n  }\n\n  // \n  data.. = '';\n  data.. = TimeSystem.getCurrentTime(data);\n  console.warn(' ');\n  return true;\n}\n\n/**\n * \n * @param data \n * @param userText \n * @param targetMessageId IDID\n */\nfunction checkDreamEvents(\n  data: SchemaType,\n  userText: string,\n  targetMessageId?: number,\n): {\n  dreamWindowOpen: boolean;\n  dreamEnded: boolean;\n  firstAwakening: boolean;\n  bodySummary?: ReturnType<typeof getBodyPartSummary>;\n} {\n  const result = {\n    dreamWindowOpen: false,\n    dreamEnded: false,\n    firstAwakening: false,\n    bodySummary: undefined as ReturnType<typeof getBodyPartSummary> | undefined,\n  };\n\n  // \n  if (TimeSystem.isDreamWindowOpen(data) && data.. === '') {\n    console.info(' 22:00-01:59');\n    result.dreamWindowOpen = true;\n\n    const currentScene = getCurrentDreamScene(data);\n    const alreadyCompleted = data...includes(currentScene);\n\n    // \n    broadcastGameEvent({\n      type: 'DREAM_WINDOW_OPEN',\n      data: {\n        currentScene,\n        alreadyCompleted,\n        canEnterScene5: true, // 5\n        memoryContinuityPrompt: generateMemoryContinuityPrompt(data, currentScene),\n      },\n    });\n  }\n\n  // 10:00\n  // 510:0020:00\n  const scene5Data = data..5 as { ?: boolean } | undefined;\n  const isInScene5 = scene5Data?. === true && data.. === '';\n\n  //  DEBUG: \n  if (data.. === '') {\n    console.info('[checkDreamEvents] :');\n    console.info(`  - : ${data..}`);\n    console.info(`  - isWakeUpTime: ${TimeSystem.isWakeUpTime(data)}`);\n    console.info(`  - scene5.: ${scene5Data?.}`);\n    console.info(`  - isInScene5: ${isInScene5}`);\n    console.info(`  - : ${TimeSystem.isWakeUpTime(data) && !isInScene5}`);\n  }\n\n  if (data.. === '' && TimeSystem.isWakeUpTime(data) && !isInScene5) {\n    console.info(' 1-4');\n    result.dreamEnded = true;\n\n    // \n    const bodySummary = getBodyPartSummary(data);\n    result.bodySummary = bodySummary;\n\n    // \n    const currentScene = getCurrentDreamScene(data);\n    if (!data...includes(currentScene)) {\n      // \n      const sceneKey = `${currentScene}` as keyof typeof data.;\n      const sceneData = data.[sceneKey];\n      const hasEntered = (sceneData as { ?: boolean } | undefined)?. ?? false;\n      const selectedParts = (sceneData as { ?: string[] } | undefined)?. ?? [];\n\n      if (!hasEntered) {\n        // \n        console.info(`[] ${currentScene}`);\n      } else if (selectedParts.length > 0) {\n        // \n        processSceneCompletion(data, currentScene);\n        console.info(`[] ${currentScene}: [${selectedParts.join(', ')}]`);\n      } else {\n        // \n        console.warn(`[] ${currentScene}`);\n        // \n        if (!data...includes(currentScene)) {\n          data...push(currentScene);\n        }\n        // \n        if (sceneData && typeof sceneData === 'object') {\n          (sceneData as { ?: boolean }). = false;\n        }\n      }\n    }\n\n    // \n    data.. = '';\n    data.. = true; // \n    updateSnapshotValue('.', ''); // \n\n    // Bug #28 \n    // \n    updateZhaoxiaLocation(data);\n    updateZhaoxiaThoughtAfterDream(data);\n\n    // \"\"\n    // Bug #18 promptInjection  09:00  AI \n    // 10:00\n    let dreamEntryId = data.._ID;\n\n    // Bug #19  _ID \n    // 22:0012\n    if (dreamEntryId === undefined && targetMessageId !== undefined) {\n      //  - 10\n      // \n      const estimatedEntryId = Math.max(0, targetMessageId - 10);\n      console.warn(\n        `[checkDreamEvents] Bug #19 _ID  ${estimatedEntryId} ${targetMessageId}`,\n      );\n      dreamEntryId = estimatedEntryId;\n    }\n\n    if (dreamEntryId !== undefined) {\n      // Bug #25 ID\n      const dreamExitId = targetMessageId; // \n      data.. = {\n        sceneNum: currentScene,\n        dreamEntryId,\n        dreamExitId, // Bug #25ID\n      };\n      console.info(\n        `[checkDreamEvents] ${currentScene}ID: ${dreamEntryId}ID: ${dreamExitId}`,\n      );\n    } else {\n      console.warn(`[checkDreamEvents] ID`);\n    }\n\n    // \n    if (!data..) {\n      data.. = true;\n      result.firstAwakening = true;\n\n      console.info('');\n      console.info(' ');\n      console.info('');\n      console.info('');\n\n      // \n      broadcastGameEvent({\n        type: 'TRUTH_REVEALED',\n        data: {\n          message: `...\n\n\"\"\"\"\n\"\"\"\"\n...`,\n        },\n      });\n    }\n\n    // \n    broadcastGameEvent({\n      type: 'DREAM_ENDED',\n      data: {\n        bodySummary,\n        firstAwakening: result.firstAwakening,\n        completedScenes: data..,\n        correctScenes: data..,\n        confusionLevel: data..,\n      },\n    });\n  }\n\n  // \n  if (userText.includes('') || userText.includes('sleep')) {\n    const  = data..;\n    if ( >= 23 ||  <= 1) {\n      console.info(' ');\n\n      broadcastGameEvent({\n        type: 'DREAM_WINDOW_MISSED',\n        data: {\n          message: '...',\n        },\n      });\n    }\n  }\n\n  // \n  // Bug #16 \n  // \"\"  \"\"\"\"\n  // \n  // 1. \n  // 2. \".*\"\n  const dreamEntryKeywords = [\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '',\n    '', // \"\"\n  ];\n  //  \"...\" \n  const dreamEntryPatterns = [\n    /.*/, //  \"\"\"\" \n    /.*/, //  \"\"\"\" \n  ];\n  const wantToEnterDream =\n    dreamEntryKeywords.some(kw => userText.includes(kw)) || dreamEntryPatterns.some(pattern => pattern.test(userText));\n\n  //  DEBUG: \n  const isDreamWindow = TimeSystem.isDreamWindowOpen(data);\n  const isDaily = data.. === '';\n  console.info('[checkDreamEvents] :');\n  console.info(`  - userText: \"${userText.substring(0, 50)}${userText.length > 50 ? '...' : ''}\"`);\n  console.info(`  - wantToEnterDream: ${wantToEnterDream} (: ${dreamEntryKeywords.join(', ')})`);\n  console.info(`  - isDreamWindowOpen: ${isDreamWindow} (: ${data..})`);\n  console.info(`  - : ${data..} (isDaily: ${isDaily})`);\n  console.info(`  - : ${wantToEnterDream && isDreamWindow && isDaily}`);\n\n  // Bug #15 ''\n  // promptInjection  AI \n  // \n  //\n  // \n  const canEnterForConfusion = canEnterDreamForConfusion(data);\n  const shouldEnterDream =\n    wantToEnterDream && isDreamWindow && (isDaily || data.. === '') && canEnterForConfusion;\n\n  if (wantToEnterDream && isDreamWindow && !canEnterForConfusion) {\n    console.warn('[checkDreamEvents] 1-4');\n  }\n\n  if (shouldEnterDream) {\n    const currentScene = getCurrentDreamScene(data);\n\n    // 5checkScene5Entry\n    // 1-4\n    if (currentScene <= 4) {\n      // \n      data.. = '';\n      data.. = true; // \n      updateSnapshotValue('.', ''); // \n\n      // ID\n      if (targetMessageId !== undefined) {\n        data.._ID = targetMessageId;\n      }\n      data.._ = data..; // \n      data.. = false;\n\n      // 1=40, 2=60, 3=80, 4=\n      setConfusionOnDreamEntry(data, currentScene);\n      // Bug #31  validateAndRestoreData \n      updateSnapshotValue('.', data..);\n      console.info(\n        `[] ${currentScene}ID=${targetMessageId}=${data..}`,\n      );\n\n      // ROLL ID\n      //  ROLL \"\"promptInjection \n      //  AI  PROMPT_READY  ROLL\n      if (targetMessageId !== undefined) {\n        const dreamAiReplyFloor = targetMessageId + 1;\n        data.._ = {\n          ID: dreamAiReplyFloor,\n          : currentScene,\n          : '',\n        };\n        console.info(`[] : ${currentScene} ${dreamAiReplyFloor} (AI)`);\n      }\n\n      broadcastGameEvent({\n        type: 'DREAM_ENTERED',\n        data: {\n          sceneNumber: currentScene,\n          memoryContinuityPrompt: generateMemoryContinuityPrompt(data, currentScene),\n          correctTarget: SCENE_CORRECT_ANSWERS[currentScene], // \n        },\n      });\n    }\n  }\n\n  return result;\n}\n\n// \nconst DAILY_DEVELOPMENT_LIMIT = 20;\n\n// \nconst WRONG_ROUTE_RESET_VALUE = 50;\n\n$(async () => {\n  await waitGlobalInitialized('Mvu');\n\n  // Prompt\n  initPromptInjection();\n\n  // \n  initDataProtection();\n  console.info('[] ');\n\n  // =============================================\n  // AI \n  // -  20%\n  // -  100%  50%\n  // =============================================\n  eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, (new_variables: any, old_variables: any) => {\n    try {\n      const newData = _.get(new_variables, 'stat_data');\n      const oldData = _.get(old_variables, 'stat_data');\n\n      if (!newData || !oldData) return;\n\n      // \n      if (newData.?.) {\n        // Bug Day 5+ AI\n        const currentDay = newData.?. ?? 1;\n        if (currentDay >= 5) {\n          const oldSuspicion = oldData.?. ?? 0;\n          const newSuspicion = newData.?. ?? 0;\n          if (oldSuspicion !== newSuspicion) {\n            _.set(new_variables, 'stat_data..', oldSuspicion);\n            console.info(`[MVU] Day ${currentDay} AI ${newSuspicion}  ${oldSuspicion}`);\n          }\n        }\n\n        // \n        // - AI\n        // - AI\n        const currentStage = newData.?.;\n\n        if (currentStage === '' || currentStage === '') {\n          // /AI\n          const parts = ['', '', '', '', ''] as const;\n          for (const part of parts) {\n            const oldValue = oldData.?.?.[part] ?? 0;\n            const newValue = newData.?.?.[part] ?? 0;\n            if (oldValue !== newValue) {\n              _.set(new_variables, `stat_data...${part}`, oldValue);\n              console.info(`[MVU] AI${part} ${newValue}  ${oldValue}`);\n            }\n          }\n        } else {\n          // AI\n          // Bug #29 1-45\n          const scene5Data = newData.?.5;\n          const isInScene5 = scene5Data?. === true;\n\n          // \n          let allowedParts: string[];\n          if (isInScene5) {\n            allowedParts = [''];\n            console.info('[MVU] 5AI');\n          } else {\n            allowedParts = ['', '', '', ''];\n            console.info('[MVU] 1-4AI');\n          }\n\n          // \n          const allParts = ['', '', '', '', ''] as const;\n          for (const part of allParts) {\n            const oldValue = oldData.?.?.[part] ?? 0;\n            const newValue = newData.?.?.[part] ?? 0;\n            if (oldValue !== newValue && !allowedParts.includes(part)) {\n              _.set(new_variables, `stat_data...${part}`, oldValue);\n              console.info(`[MVU] AI${part} ${newValue}  ${oldValue}`);\n            }\n          }\n        }\n        return;\n      }\n\n      // \n      const parts = ['', '', '', '', ''] as const;\n      let triggeredWrongRoute = false;\n      let wrongRoutePart = '';\n\n      for (const part of parts) {\n        const oldValue = oldData.?.?.[part] ?? 0;\n        let newValue = newData.?.?.[part] ?? 0;\n\n        // 1.  DAILY_DEVELOPMENT_LIMIT\n        if (newValue > oldValue) {\n          const maxAllowed = oldValue + DAILY_DEVELOPMENT_LIMIT;\n          if (newValue > maxAllowed) {\n            console.warn(`[MVU] ${part}${oldValue}  ${newValue} ${maxAllowed}`);\n            newValue = maxAllowed;\n            _.set(new_variables, `stat_data...${part}`, newValue);\n          }\n        }\n\n        // 2.  100%\n        if (newValue >= 100 && !triggeredWrongRoute) {\n          triggeredWrongRoute = true;\n          wrongRoutePart = part;\n          //  50%\n          _.set(new_variables, `stat_data...${part}`, WRONG_ROUTE_RESET_VALUE);\n          console.warn(`[MVU] ${part}  100% ${WRONG_ROUTE_RESET_VALUE}%`);\n        }\n      }\n\n      // \n      if (triggeredWrongRoute) {\n        broadcastGameEvent({\n          type: 'WRONG_ROUTE_TRIGGERED',\n          data: {\n            part: wrongRoutePart,\n            message: `${wrongRoutePart}...`,\n            resetTo: WRONG_ROUTE_RESET_VALUE,\n          },\n        });\n      }\n    } catch (err) {\n      console.error('[MVU] :', err);\n    }\n  });\n\n  let isFirstMessageAfterInit = false;\n  const processedEvents = new Set<string>();\n\n  function getSwipeId(messageId: number): number {\n    try {\n      const chat = SillyTavern.chat;\n      if (chat && chat[messageId]) {\n        return chat[messageId].swipe_id ?? 0;\n      }\n    } catch (err) {\n      console.warn(`[]  swipe_id :`, err);\n    }\n    return 0;\n  }\n\n  eventOn(Mvu.events.VARIABLE_INITIALIZED, () => {\n    isFirstMessageAfterInit = true;\n  });\n\n  async function processGameLogic(message_id: number, eventType: string) {\n    try {\n      const swipeId = getSwipeId(message_id);\n      // Bug #26  eventType  messageKey MESSAGE_RECEIVED  GENERATION_ENDED \n      //  GENERATION_ENDED  key \n      const messageKey = `${message_id}:${swipeId}:${eventType}`;\n      console.info(\n        `[] processGameLogic : message_id=${message_id}, swipe_id=${swipeId}, eventType=${eventType}`,\n      );\n\n      // \n      if (eventType === 'MESSAGE_RECEIVED' && isFirstMessageAfterInit) {\n        isFirstMessageAfterInit = false;\n        console.info(`[] : ${message_id}`);\n        return;\n      }\n\n      //  + ROLL\n      if (eventType === 'MESSAGE_SWIPED') {\n        // Bug #26 key  message_id:swipe_id:eventType\n        const keysToRemove = Array.from(processedEvents).filter(key => {\n          const parts = key.split(':');\n          return parts[0] === String(message_id);\n        });\n        keysToRemove.forEach(key => processedEvents.delete(key));\n        console.info(`[] ROLL  ${keysToRemove.length} `);\n\n        // ROLL\n        const rollVars = Mvu.getMvuData({ type: 'message', message_id: message_id });\n        const rollStatData = _.get(rollVars, 'stat_data');\n        if (rollStatData?.?. === '' && rollStatData?.?.) {\n          _.set(rollVars, 'stat_data..', false);\n\n          // 51-4\n          const scene5Data = rollStatData.?.5;\n          const isInScene5 = scene5Data?. === true;\n\n          if (isInScene5) {\n            // 5ROLL\n            const currentStep = scene5Data?. ?? 0;\n            const stepProgressRecord = scene5Data?. ?? [];\n\n            // Bug #11  ROLL  promptInjection \n            //  CHAT_COMPLETION_PROMPT_READY \n            setRollOperationFlag(true);\n\n            if (currentStep > 0 && stepProgressRecord.length > 0) {\n              // \n              const newStep = currentStep - 1;\n              const lastProgressIncrement = stepProgressRecord[stepProgressRecord.length - 1] ?? 0;\n              const currentCompletion = scene5Data?. ?? 0;\n              const newCompletion = Math.max(0, currentCompletion - lastProgressIncrement);\n              const newProgressRecord = stepProgressRecord.slice(0, -1);\n\n              _.set(rollVars, 'stat_data..5.', newStep);\n              _.set(rollVars, 'stat_data..5.', newCompletion);\n              _.set(rollVars, 'stat_data..5.', newProgressRecord);\n              _.set(rollVars, 'stat_data..5.', []);\n\n              // \n              if (newCompletion < 80) {\n                _.set(rollVars, 'stat_data..5.', false);\n              }\n\n              console.info(\n                `[] ROLL 5: ${currentStep}  ${newStep}, ` +\n                  `: ${currentCompletion}%  ${newCompletion}% (-${lastProgressIncrement}%)`,\n              );\n            } else {\n              // 0\n              _.set(rollVars, 'stat_data..5.', []);\n              console.info(`[] ROLL 50`);\n            }\n          } else {\n            // 1-4\n            const sceneNum = Math.min(rollStatData.._ ?? rollStatData.. ?? 1, 4);\n            const sceneKey = `${sceneNum}`;\n            if (rollStatData.?.[sceneKey]) {\n              _.set(rollVars, `stat_data..${sceneKey}.`, []);\n            }\n            console.info(`[] ROLL ${sceneNum}`);\n          }\n\n          Mvu.replaceMvuData(rollVars, { type: 'message', message_id: message_id });\n        }\n\n        // ROLL  ROLL \n        //  ROLL \"\"\n        const rollVarsForSummary = Mvu.getMvuData({ type: 'message', message_id: message_id });\n        const rollStatDataForSummary = _.get(rollVarsForSummary, 'stat_data');\n        const summaryRecord = rollStatDataForSummary?.?._;\n\n        if (summaryRecord && summaryRecord.ID === message_id) {\n          const currentSwipeId = getSwipeId(message_id);\n\n          // swipe_id  ROLL \n          if (currentSwipeId !== summaryRecord.swipe_id) {\n            console.info(\n              `[]  ROLL :  ${message_id}, ` +\n                `swipe_id: ${summaryRecord.swipe_id}  ${currentSwipeId}`,\n            );\n\n            // \"\"\n            _.set(rollVarsForSummary, 'stat_data..', {\n              sceneNum: summaryRecord.,\n              dreamEntryId: summaryRecord.ID,\n              dreamExitId: summaryRecord.ID,\n            });\n\n            // \n            _.set(rollVarsForSummary, 'stat_data.._', undefined);\n\n            //  ROLL \n            const sceneKey = `${summaryRecord.}`;\n            if (summaryRecord. === 5) {\n              _.set(rollVarsForSummary, `stat_data..${sceneKey}.`, undefined);\n            } else {\n              _.set(rollVarsForSummary, `stat_data..${sceneKey}.`, undefined);\n            }\n\n            await Mvu.replaceMvuData(rollVarsForSummary, { type: 'message', message_id: message_id });\n            console.info(\n              `[]  ROLL ${summaryRecord.} GENERATION_ENDED `,\n            );\n          }\n        }\n      } else {\n        if (processedEvents.has(messageKey)) {\n          console.info(`[] : ${messageKey}`);\n          return;\n        }\n      }\n\n      processedEvents.add(messageKey);\n\n      // \n      if (processedEvents.size > 100) {\n        const oldestKeys = Array.from(processedEvents).slice(0, processedEvents.size - 100);\n        oldestKeys.forEach(key => processedEvents.delete(key));\n      }\n\n      // \n      // GENERATION_ENDED:  getLastMessageId()ID\n      // MESSAGE_RECEIVED: ID\n      // MESSAGE_SWIPED: ROLLID\n      // \n      const targetMessageId = message_id;\n      const actualLastId = getLastMessageId();\n\n      console.info(`[] =${targetMessageId}, =${actualLastId}, =${eventType}`);\n\n      // \n      const currentVars = Mvu.getMvuData({ type: 'message', message_id: targetMessageId });\n      const statData = _.get(currentVars, 'stat_data');\n\n      if (!statData) {\n        console.warn('[] stat_data ');\n        return;\n      }\n\n      // CRITICAL: \n      const data = Schema.parse(JSON.parse(JSON.stringify(statData)));\n\n      // \n      let userText = '';\n      let aiText = '';\n      try {\n        const lastMessages = getChatMessages(-1);\n        const prevMessages = getChatMessages(-2);\n        const lastMessage = lastMessages.length > 0 ? lastMessages[0] : null;\n        const userMessage = prevMessages.length > 0 ? prevMessages[0] : null;\n        userText = userMessage && userMessage.role === 'user' ? (userMessage.message ?? '') : '';\n        aiText = lastMessage && lastMessage.role === 'assistant' ? (lastMessage.message ?? '') : '';\n      } catch (msgErr) {\n        console.warn('[] :', msgErr);\n      }\n\n      console.info(`\\n`);\n      console.info(`[]  ${targetMessageId}`);\n      console.info(`: ${data..}`);\n      console.info(`: ${getCurrentRouteType(data)}`);\n      console.info(`\\n`);\n\n      // \n\n      // 0. \n      // Bug #19 MVU\n      let exitInfo = data..;\n\n      // \n      // MVUoptional\n      if (!exitInfo && targetMessageId > 0) {\n        try {\n          const prevVars = Mvu.getMvuData({ type: 'message', message_id: targetMessageId - 1 });\n          const prevStatData = _.get(prevVars, 'stat_data');\n          if (prevStatData?.?.) {\n            exitInfo = prevStatData..;\n            console.info(\n              `[] Bug #19 (${targetMessageId - 1})` +\n                `${exitInfo.sceneNum}ID: ${exitInfo.dreamEntryId}`,\n            );\n          }\n        } catch (err) {\n          console.warn('[] :', err);\n        }\n      }\n\n      if (exitInfo) {\n        console.info(\n          `[] ${exitInfo.sceneNum}ID: ${exitInfo.dreamEntryId}ID: ${exitInfo.dreamExitId ?? ''}`,\n        );\n        data.. = {\n          sceneNum: exitInfo.sceneNum,\n          dreamEntryId: exitInfo.dreamEntryId,\n          dreamExitId: exitInfo.dreamExitId, // Bug #25ID\n        };\n        data.. = undefined; // \n      }\n\n      // 1. \n      const dangerResult = processUserInput(data, userText);\n      if (dangerResult.triggerBadEnd) {\n        console.error(`[]  : ${dangerResult.badEndType}`);\n        // \n        broadcastGameEvent({\n          type: 'BAD_END_TRIGGERED',\n          data: {\n            reason: dangerResult.badEndType,\n            message: '...',\n          },\n        });\n      }\n\n      // PromptAI\n      if (dangerResult.modifiedInput) {\n        console.warn(`[] Prompt`);\n        broadcastGameEvent({\n          type: 'PROMPT_CORRECTION',\n          data: {\n            originalInput: userText,\n            correctedPrompt: dangerResult.modifiedInput,\n          },\n        });\n      }\n\n      // 1. MVU\n      const timeSkipResult = TimeSystem.processTimeSkipRequest(data, userText);\n      if (timeSkipResult.processed && timeSkipResult.blocked) {\n        // MVU\n        if (timeSkipResult.mvuMessage) {\n          console.warn(`[] ${timeSkipResult.mvuMessage}`);\n          toastr.warning(timeSkipResult.mvuMessage, '', { timeOut: 4000 });\n        }\n      }\n\n      // 1.4. 5\n      const SLEEPING_PILL_KEYWORDS = ['', '', '', ''];\n      const wantEnterScene5 =\n        SLEEPING_PILL_KEYWORDS.some(kw => userText.includes(kw)) &&\n        (data.. === '' || data.. === '') &&\n        data.. >= 8 &&\n        data.. < 20;\n\n      // \n      const canEnterScene5ForConfusion = canEnterDreamForConfusion(data);\n      if (wantEnterScene5 && !canEnterScene5ForConfusion) {\n        console.warn('[] 5');\n        // \n      }\n\n      const shouldEnterScene5 = wantEnterScene5 && canEnterScene5ForConfusion;\n\n      if (shouldEnterScene5) {\n        console.info('[] 5');\n        data.. = '';\n        data.. = true;\n        data.._ID = targetMessageId;\n        data.._ = data..; // 5\n        data.. = false;\n        updateSnapshotValue('.', ''); // \n\n        if (!data..) {\n          data.. = true;\n        }\n\n        // 5\n        const existingScene5Data = data..5 as\n          | { ?: boolean; ?: string; ?: number }\n          | undefined;\n        if (!data..5) {\n          (data. as any).5 = {};\n        }\n\n        const scene5Data = data..5 as any;\n        const newEntryCount = (existingScene5Data?. ?? 0) + 1;\n        scene5Data. = true;\n        scene5Data. = data..;\n        scene5Data. = newEntryCount;\n\n        // Bug #13 \n        // \n        scene5Data. = data..;\n        scene5Data. = JSON.parse(JSON.stringify(data..));\n        console.info(\n          `[] 5=${data..}=${data...}`,\n        );\n\n        // 12\n        // Bug #13  lockScene5EntryCoherence()\n        if (newEntryCount === 1) {\n          scene5Data. = 0;\n          scene5Data. = 0;\n          scene5Data. = [];\n          scene5Data. = false;\n          // \n          console.info(`[] 512`);\n        }\n\n        // 580\n        setConfusionOnDreamEntry(data, 5);\n        // Bug #31  validateAndRestoreData \n        updateSnapshotValue('.', data..);\n        console.info(\n          `[] 5${newEntryCount}ID=${targetMessageId}=${data..}`,\n        );\n\n        // ROLL 5ID\n        //  ROLL \"\"promptInjection \n        //  AI targetMessageId + 1 PROMPT_READY  ROLL\n        //  targetMessageId AI  targetMessageId + 1\n        const scene5AiReplyFloor = targetMessageId + 1;\n        data.._ = {\n          ID: scene5AiReplyFloor,\n          : 5,\n          : '5',\n        };\n        console.info(`[] 5:  ${scene5AiReplyFloor} (AI)`);\n      }\n\n      // Bug #27  MESSAGE_RECEIVED \n      // Bug #26  MESSAGE_RECEIVED  GENERATION_ENDED \n      //  8910\n      // ROLL (MESSAGE_SWIPED) \n      if (eventType === 'MESSAGE_RECEIVED') {\n        const timeBeforeAdvance = data..; // \n        TimeSystem.advance(data, 1);\n        const timeAfterAdvance = data..; // \n\n        // \n        // \n        if (targetMessageId === getLastMessageId()) {\n          const timeCheck = TimeSystem.checkTimeAdvancementAfterScript(\n            timeBeforeAdvance,\n            timeAfterAdvance,\n            targetMessageId,\n          );\n          if (timeCheck.shouldWarn && timeCheck.message) {\n            toastr.warning(timeCheck.message, '', { timeOut: 6000 });\n          }\n        }\n      } else if (eventType === 'MESSAGE_SWIPED') {\n        console.info('[] MESSAGE_SWIPED: ');\n      } else {\n        console.info('[] GENERATION_ENDED:  MESSAGE_RECEIVED ');\n      }\n\n      // 1.5. 520:00\n      // Bug #13 \n      // - promptInjection  19:00 \n      // - AI \n      // -  20:00\n      // -  20:00\n      if (data.. === '') {\n        const scene5Data = data..5 as { ?: boolean } | undefined;\n        const isInScene5 = scene5Data?. === true;\n\n        if (isInScene5 && data.. === 20) {\n          console.info('[] 20:005');\n          data.. = '';\n          data.. = true;\n          updateSnapshotValue('.', ''); // \n\n          // Bug #28 \n          // \n          updateZhaoxiaLocation(data);\n          updateZhaoxiaThoughtAfterDream(data);\n\n          // 512\n          const completion = calculateScene5CompletionNew(data);\n          const scene5 = data..5 as any;\n\n          // Bug #13 \n          //  100% = \n          //  < 100% = \n          if (completion.completionPercent >= 100) {\n            // \n            if (!data...includes(5)) {\n              data...push(5);\n            }\n            // 1-2-3\n            lockScene5EntryCoherence(data);\n            console.info(`[] 5100% ${data..5}`);\n          } else {\n            // \n            if (scene5?. !== undefined) {\n              const oldConfusion = data..;\n              data.. = scene5.;\n              console.info(`[]  ${oldConfusion}  ${scene5.}`);\n            }\n            if (scene5?.) {\n              const wasMarked = data...;\n              data.. = JSON.parse(JSON.stringify(scene5.));\n              console.info(`[]  ${wasMarked}  ${scene5..}`);\n            }\n            console.info(\n              `[] 5${completion.completionPercent}%<100%`,\n            );\n          }\n\n          // 5\"\"\n          if (scene5) {\n            scene5. = false;\n          }\n\n          console.info(\n            `[] 520:00` +\n              `: ${completion.completionPercent}%` +\n              `: ${completion.currentStep}/12` +\n              `: ${completion.completionPercent >= 100 ? '(100%)' : '(<100%)'}`,\n          );\n\n          // \"\"\n          // 20:00\n          let scene5DreamEntryId = data.._ID;\n\n          // Bug #19  _ID \n          if (scene5DreamEntryId === undefined) {\n            // 51210-15\n            const estimatedEntryId = Math.max(0, targetMessageId - 12);\n            console.warn(\n              `[] Bug #19 5 _ID  ${estimatedEntryId} ${targetMessageId}`,\n            );\n            scene5DreamEntryId = estimatedEntryId;\n          }\n\n          if (scene5DreamEntryId !== undefined) {\n            // Bug #25 ID\n            const scene5DreamExitId = targetMessageId; // \n            data.. = {\n              sceneNum: 5,\n              dreamEntryId: scene5DreamEntryId,\n              dreamExitId: scene5DreamExitId, // Bug #25ID\n            };\n            console.info(\n              `[] 5ID: ${scene5DreamEntryId}ID: ${scene5DreamExitId}`,\n            );\n          } else {\n            console.warn(`[] 5ID`);\n          }\n        }\n      }\n\n      // AI\n      // AI\n      createDataSnapshot(data);\n\n      // 2. \n      const  = validateAndFixState(data);\n      if (.fixed) {\n        console.info(`[]  ${.changes.length} `);\n      }\n\n      // 3. \n      const  = checkRealmChange(data);\n      if (.changed) {\n        const  = data..;\n        const  = getRealmTitle(.newRealm, );\n        const  = getStyleGuidance(.newRealm, );\n        console.info(\n          `[] : ${.oldRealm}  ${.newRealm}\\n` +\n            `  : ${}\\n` +\n            `  : ${ ? '' : ''}\\n` +\n            `  : ${.}\\n` +\n            `  : ${..join('')}`,\n        );\n      }\n\n      // 4.  -  promptInjection.ts \n      // \"A\" AI \n      //  CHAT_COMPLETION_PROMPT_READY \n      //  promptInjection.ts  generateFullInjection() \n\n      // 5. \n      // 2026-01-17  AI \n      // - \n      // -  AI  BODY_PROGRESS \n      // -  AI \n      // - 55\n      // - 480-100%\n      const isInScene5 = data..5?. === true;\n      if (data.. === '' && !isInScene5) {\n        // AI\n        const validatedProgress = validateAndProcessAIReport(userText || '', aiText || '');\n\n        const hasProgress = Object.values(validatedProgress).some(v => v > 0);\n        if (hasProgress) {\n          updateBodyPartProgress(data, validatedProgress);\n          console.info(`[] `);\n        }\n      }\n\n      // 5.5  = \n      // AI\n      //  \n      if (data.. && data.. === '') {\n        updateTruthModeValues(data);\n      }\n\n      // 6. \n      updateHusbandLocation(data);\n\n      // 6.5 \n      // \n      // Bug #14 userTextAIaiText\n      // AI\n      // Bug #XX Day 5+ \n      const shouldSkipSuspicion = data.. >= 5;\n      if (data.. === '' && data.. && !shouldSkipSuspicion) {\n        const newSuspicion = updateSuspicionLevel(data, userText);\n\n        // Bug #24 100\n        // \n        if (newSuspicion >= 100 && data.. === '') {\n          data.. = '';\n          data.. = '';\n          data.. = TimeSystem.getCurrentTime(data);\n          // \n          updateSnapshotValue('.', '');\n          updateSnapshotValue('.', '');\n          console.warn('[]  100');\n        }\n      }\n\n      // 7. \n      checkDreamEvents(data, userText, targetMessageId);\n\n      // 8. AI\n      // Bug #7  <HusbandThought> \n      // AI\n      // Bug #10  <!--BODY_PROGRESS: ...--> \n      if (aiText) {\n        const husbandThought = parseHusbandThought(aiText);\n\n        // \n        //  <HusbandThought>  <!--BODY_PROGRESS: ...--> \n        const cleanedAiText = aiText\n          .replace(/<HusbandThought>[\\s\\S]*?<\\/HusbandThought>/gi, '')\n          .replace(/<!--\\s*BODY_PROGRESS:\\s*[^-]*?-->/gi, '')\n          .trim();\n        if (cleanedAiText !== aiText) {\n          try {\n            // Bug  getLastMessageId()  AI  ID\n            // targetMessageId  AI \n            // aiText  getChatMessages(-1) ID\n            const aiMessageId = getLastMessageId();\n            await setChatMessages([{ message_id: aiMessageId, message: cleanedAiText }], { refresh: 'affected' });\n            console.info(`[] AIHusbandThought/BODY_PROGRESS=${aiMessageId}`);\n          } catch (err) {\n            console.warn('[] :', err);\n          }\n        }\n\n        // Bug \n        // AI\n        //  shouldGenerateHusbandThought \n        if (husbandThought) {\n          // \n          data.. = husbandThought;\n          console.info(`[] : ${husbandThought}`);\n\n          // \n          if (shouldGenerateHusbandThought(data)) {\n            broadcastGameEvent({\n              type: 'HUSBAND_PERSPECTIVE',\n              data: {\n                text: husbandThought,\n                realm: data..,\n                suspicionLevel: data..,\n              },\n            });\n          } else {\n            console.info('[] AI');\n          }\n        }\n      }\n\n      // 9. \n      const  = checkEnding(data);\n\n      // 10. AI\n      // Bug #40 \n      if (isTrueEndingActive(data) && aiText) {\n        const state = getTrueEndingState(data);\n        if (!state.isComplete) {\n          const currentHour = data..;\n\n          // processTurnEndAI\n          const result = processTurnEnd(state, aiText, userText, currentHour);\n          let finalState = result.newState;\n\n          // Bug #40 \n          // \n          if (result.timeBlocked) {\n            console.info(\n              `[] ${finalState.currentPhase}${result.timeBlocked.reason}`,\n            );\n            console.info(\n              `[] : ${finalState.currentPhase}, ` +\n                `[${finalState.completedAnchors.join(', ')}]`,\n            );\n          } else if (result.phaseAdvanced) {\n            // processTurnEnd \n            console.info(`[] : ${state.currentPhase}  ${finalState.currentPhase}`);\n\n            // \n            if (finalState.isComplete) {\n              data.. = true;\n              data.. = '';\n              console.info('[]  ');\n            }\n          } else {\n            console.info(\n              `[] : ${finalState.currentPhase}, ` +\n                `[${finalState.completedAnchors.join(', ')}]`,\n            );\n          }\n\n          // \n          updateTrueEndingState(data, finalState);\n        }\n      }\n\n      // 11. AI\n      // Bug #40 \n      if (isFalseEndingActive(data) && aiText) {\n        const state = getFalseEndingState(data);\n        if (!state.isComplete) {\n          const currentHour = data..;\n\n          // processTurnEndAI\n          const result = processFalseEndingTurnEnd(state, aiText, userText, currentHour);\n          let finalState = result.newState;\n\n          // Bug #40 \n          // \n          if (result.timeBlocked) {\n            console.info(\n              `[] ${finalState.currentPhase}${result.timeBlocked.reason}`,\n            );\n            console.info(\n              `[] : ${finalState.currentPhase}, ` +\n                `[${finalState.completedAnchors.join(', ')}]`,\n            );\n          } else if (result.phaseAdvanced) {\n            // processTurnEnd \n            console.info(`[] : ${state.currentPhase}  ${finalState.currentPhase}`);\n\n            // \n            if (finalState.isComplete) {\n              console.info('[]  ');\n            }\n          } else {\n            console.info(\n              `[] : ${finalState.currentPhase}, ` +\n                `[${finalState.completedAnchors.join(', ')}]`,\n            );\n          }\n\n          // \n          updateFalseEndingState(data, finalState);\n        }\n      }\n\n      // 12. AI\n      // Bug #40 \n      if (isPerfectEndingActive(data) && aiText) {\n        const state = getPerfectEndingState(data);\n        if (!state.isComplete) {\n          const currentHour = data..;\n\n          // processPerfectTurnEndAI\n          const result = processPerfectTurnEnd(state, aiText, userText, currentHour);\n          let finalState = result.newState;\n\n          // Bug #40 \n          // \n          if (result.timeBlocked) {\n            console.info(\n              `[] ${finalState.currentPhase}${result.timeBlocked.reason}`,\n            );\n            console.info(\n              `[] : ${finalState.currentPhase}, ` +\n                `[${finalState.completedAnchors.join(', ')}]`,\n            );\n          } else if (result.phaseAdvanced) {\n            // processPerfectTurnEnd \n            console.info(`[] : ${state.currentPhase}  ${finalState.currentPhase}`);\n\n            // 120-11\n            if (finalState.isComplete) {\n              data.. = true;\n              data.. = '';\n              console.info('[]  ');\n            }\n          } else {\n            console.info(\n              `[] : ${finalState.currentPhase}, ` +\n                `[${finalState.completedAnchors.join(', ')}]`,\n            );\n          }\n\n          // \n          updatePerfectEndingState(data, finalState);\n        }\n      }\n\n      // 7. \n      if (data.?.) {\n        TimeSystem.validate(data);\n      }\n\n      // AI\n      const protectionResult = validateAndRestoreData(data);\n      if (protectionResult.detected) {\n        console.warn(`[]  ${protectionResult.tamperedFields.length} `);\n        if (data.?.) {\n          console.info(generateProtectionReport(protectionResult));\n        }\n      }\n\n      // \n      const validatedData = Schema.parse(data);\n\n      // CRITICAL:  currentVars\n      const newVars = JSON.parse(JSON.stringify(currentVars));\n      _.set(newVars, 'stat_data', validatedData);\n      await Mvu.replaceMvuData(newVars, { type: 'message', message_id: targetMessageId });\n\n      console.info(`\\n`);\n      console.info(`[]  ${targetMessageId}`);\n      console.info(`: ${validatedData..}`);\n      console.info(`: ${getCurrentRouteType(validatedData)}`);\n      console.info(`: ${validatedData..}`);\n      console.info(`: ${validatedData..}`);\n      console.info(`: ${validatedData..}`);\n      console.info(`: ${validatedData..}`);\n      console.info(`: ${validatedData..}`);\n      if () {\n        console.info(` : ${validatedData..}`);\n      }\n      console.info(`\\n`);\n\n      // ============================================\n      // 8. \n      //  generateRaw API\n      // ============================================\n      if (validatedData.. && eventType === 'GENERATION_ENDED') {\n        const summaryInfo = validatedData..;\n        console.info(\n          `[] ${summaryInfo.sceneNum}: ${summaryInfo.dreamEntryId}: ${summaryInfo.dreamExitId ?? ''}`,\n        );\n\n        try {\n          // Bug #25 ID\n          const chatHistory = await getDreamSessionMessages(summaryInfo.dreamEntryId, summaryInfo.dreamExitId);\n          console.info(`[] : ${chatHistory.length}`);\n\n          //  API\n          const summary = await generateMemorySummary(validatedData, summaryInfo.sceneNum, chatHistory);\n\n          // \n          const sceneKey = `${summaryInfo.sceneNum}` as keyof typeof validatedData.;\n          const sceneData = validatedData.[sceneKey];\n          if (sceneData && typeof sceneData === 'object') {\n            if (summaryInfo.sceneNum === 5) {\n              (sceneData as any). = summary;\n            } else {\n              (sceneData as any). = summary;\n            }\n          }\n\n          // \n          validatedData.. = undefined;\n\n          // ROLL IDswipe_id\n          //  ROLL \"\"\n          const summarySwipeId = getSwipeId(targetMessageId);\n          validatedData.._ = {\n            ID: targetMessageId,\n            swipe_id: summarySwipeId,\n            : summaryInfo.sceneNum,\n            ID: summaryInfo.dreamEntryId,\n            ID: summaryInfo.dreamExitId,\n          };\n          console.info(\n            `[] : ${targetMessageId}, swipe_id=${summarySwipeId}, ${summaryInfo.sceneNum}`,\n          );\n\n          // \n          const finalVars = JSON.parse(JSON.stringify(currentVars));\n          _.set(finalVars, 'stat_data', validatedData);\n          await Mvu.replaceMvuData(finalVars, { type: 'message', message_id: targetMessageId });\n\n          console.info(`[] ${summaryInfo.sceneNum}${summary.length}`);\n        } catch (summaryErr) {\n          console.error('[] :', summaryErr);\n          // \n          validatedData.. = undefined;\n          const finalVars = JSON.parse(JSON.stringify(currentVars));\n          _.set(finalVars, 'stat_data', validatedData);\n          await Mvu.replaceMvuData(finalVars, { type: 'message', message_id: targetMessageId });\n        }\n      }\n\n      // \n      const verifyVars = Mvu.getMvuData({ type: 'message', message_id: targetMessageId });\n      const verifyData = _.get(verifyVars, 'stat_data');\n      const expectedTime = TimeSystem.getCurrentTime(validatedData);\n\n      if (verifyData?.?. !== expectedTime) {\n        console.error('[]  ');\n        console.error(`: ${expectedTime}`);\n        console.error(`: ${verifyData?.?.}`);\n      } else {\n        console.info(`[]  ${eventType} `);\n      }\n    } catch (err) {\n      console.error('[] :', err);\n    }\n  }\n\n  // \n  eventOn(tavern_events.MESSAGE_RECEIVED, message_id => {\n    const id = Number(message_id);\n    console.info(`[]  MESSAGE_RECEIVED message_id=${id}`);\n    setTimeout(() => {\n      processGameLogic(id, 'MESSAGE_RECEIVED');\n    }, 300);\n  });\n\n  // ROLL\n  eventOn(tavern_events.MESSAGE_SWIPED, message_id => {\n    const id = Number(message_id);\n    console.info(`[]  MESSAGE_SWIPED message_id=${id}`);\n    setTimeout(() => {\n      processGameLogic(id, 'MESSAGE_SWIPED');\n    }, 300);\n    // [] \n    // setTimeout(() => {\n    //   console.info('[]  IFRAME_DATA_REFRESH  (MESSAGE_SWIPED)');\n    //   eventEmit('IFRAME_DATA_REFRESH', { reason: 'MESSAGE_SWIPED', message_id: id });\n    // }, 500);\n  });\n\n  // \n  eventOn(tavern_events.MESSAGE_DELETED, message_id => {\n    const id = Number(message_id);\n    console.info(`[]  MESSAGE_DELETED message_id=${id}`);\n\n    const keysToRemove = Array.from(processedEvents).filter(key => {\n      const keyMessageId = parseInt(key.split(':')[0], 10);\n      return keyMessageId >= id;\n    });\n    if (keysToRemove.length > 0) {\n      keysToRemove.forEach(key => processedEvents.delete(key));\n      console.info(`[] MESSAGE_DELETED  ${keysToRemove.length} `);\n    }\n\n    // [] \n    // setTimeout(() => {\n    //   console.info('[]  IFRAME_DATA_REFRESH  (MESSAGE_DELETED)');\n    //   eventEmit('IFRAME_DATA_REFRESH', { reason: 'MESSAGE_DELETED', message_id: id });\n    // }, 300);\n  });\n\n  // \n  eventOn(tavern_events.GENERATION_ENDED, message_id => {\n    console.info(`[]  GENERATION_ENDED  message_id=${message_id}`);\n    setTimeout(() => {\n      try {\n        const actualMessageId = getLastMessageId();\n        console.info(`[] GENERATION_ENDED  message_id=${actualMessageId}`);\n        processGameLogic(actualMessageId, 'GENERATION_ENDED');\n      } catch (err) {\n        console.warn(`[] GENERATION_ENDED :`, err);\n        processGameLogic(Number(message_id), 'GENERATION_ENDED');\n      }\n    }, 300);\n    // [] \n    // setTimeout(() => {\n    //   try {\n    //     const actualMessageId = getLastMessageId();\n    //     console.info('[]  IFRAME_DATA_REFRESH  (GENERATION_ENDED)');\n    //     eventEmit('IFRAME_DATA_REFRESH', { reason: 'GENERATION_ENDED', message_id: actualMessageId });\n    //   } catch (err) {\n    //     console.warn('[] GENERATION_ENDED :', err);\n    //   }\n    // }, 800);\n  });\n\n  console.info('[] ');\n});\n"],"names":["z","Schema","object","number","min","max","default","string","boolean","enum","optional","sceneNum","dreamEntryId","dreamExitId","swipe_id","array","nullable","isActive","isComplete","currentPhase","turnsInPhase","totalTurns","completedAnchors","noProgressTurns","hintGiven","record","TimeSystem","advance","data","hours","console","info","oldTime","oldDay","oldHour","rawTime","this","calculateRawTime","day","hour","finalDay","finalHour","formatTime","Date","now","newTime","success","currentDay","currentHour","totalHours","toString","padStart","getCurrentTime","isDreamWindowOpen","isEndingTime","isTrueEndingGuidanceTime","isWakeUpTime","isDay5NightDreamBlocked","getHoursUntilReset","remaining","Math","detectTimeSkipIntent","userInput","normalizedInput","toLowerCase","sleepKeywords","keyword","includes","hasIntent","targetHour","skipType","match","parseInt","nextDayKeywords","processTimeSkipRequest","intent","processed","blocked","mvuMessage","warn","validate","expectedTime","error","checkTimeAdvancementAfterScript","beforeTime","afterTime","messageId","shouldWarn","message","clamp","value","getRealmNamePure","realm","getRealmNameTruth","lastRealm","PURE_LOVE_APPEARANCE_CONFIG","TRUTH_APPEARANCE_CONFIG","getAppearanceConfig","getStyleGuidance","realmConfig","getRealmTitle","ALL_BODY_PARTS","calculateDependencyFromBodyProgress","values","map","part","average","reduce","sum","v","length","round","calculateMoralBaselineFromDependency","BODY_PART_DEVELOPMENT_LEVELS","range","BODY_PART_BEHAVIOR_MAP","getBodyPartStatus","progress","generateDetailedInteractionPrompt","getAllowedInteractions","join","prompt","generateAppearanceConstraintPrompt","constraints","getRealmConstraints","guidance","title","updateZhaoxiaLocation","random","updateZhaoxiaThoughtAfterDream","substring","EXPOSURE_CLOTHING_KEYWORDS","HEAVY_MAKEUP_KEYWORDS","INTIMATE_BEHAVIOR_KEYWORDS","countKeywordsInText","text","keywords","count","calculateSuspicionIncrease","userInputText","result","detectClothingExposure","Object","push","detectMakeupIntensity","detectIntimacyLevel","SCENE5_STEPS","step","phase","description","bestMatch","aiTask","calculateMemoryCoherence","completedScenes","Set","hasScene1","has","hasScene2","hasScene3","hasScene4","level","aiHint","getScene5LockedCoherence","locked","undefined","safeIncreaseMemoryConfusion","amount","shouldIncreaseMemoryConfusion","oldValue","actualIncrease","INTENT_KEYWORDS","analyzePlayerIntent","attitude","entries","behavior","goal","calculateMatchLevel","best","matchCount","totalRequired","calculateScene5Completion","scene5Data","entryCount","currentStep","isStepsComplete","completionPercent","stepProgressRecord","maxAvailableSteps","canTriggerSpecialEnding","getBodyInfluenceForScene5","influences","bodyParts","acc","avgProgress","floor","hasInfluence","generateScene5StepPrompt","completion","remainingSteps","maxStepsFromTime","storyRemaining","getRemainingSteps","bodyInfluence","generateFreePlayPrompt","nextStep","stepConfig","matchLevel","progressGain","bodyInfluenceText","i","intentSummary","matchNote","remainingHours","timeGuidance","SCENE_INFO","age","generateScene5EntryReplacement","maxSteps","isFirstEntry","coherence","missingEffects","effects","getMissingMemoryEffects","previousSummaries","summaries","sceneKey","sceneData","sceneInfo","isCorrect","generatePreviousSceneSummaries","coherenceText","userMessage","prefill","generateCoherenceBasedPrefill","generateScene5ForceExitReplacement","generateScene5StepReplacement","DANGEROUS_KEYWORDS","generateBadEndingText","category","generateCorrectionPrompt","_originalInput","processUserInput","shouldSkipDangerousContentDetection","allowContinue","triggerBadEnd","dangerCheck","matchedKeywords","filter","kw","shouldInterrupt","severity","action","correctedPrompt","penalties","detectDangerousContent","badEndType","actualPenalty","modifiedInput","BODY_PART_KEYWORDS","INTERACTION_INTENT_KEYWORDS","validateAndProcessAIReport","aiResponse","scriptDetected","inputPreview","increment","SINGLE_DETECTION_MAX","PROGRESS_PER_KEYWORD","detectBodyPartProgress","some","aiSuggested","progressMatch","progressStr","partPatterns","patterns","pattern","regex","RegExp","clampedValue","AI_SUGGESTION_MAX","parseAIBodyProgressSuggestion","trim","hasInteractionIntent","getDevelopmentLevel","name","getCurrentDreamSceneNumber","updateBodyPartProgress","progressIncrement","currentScene","allowedParts","getAllowedBodyParts","remainingCap","actualIncrement","oldProgress","newProgress","oldLevel","newLevel","blockedParts","p","SCENE_CORRECT_ANSWERS","processSceneCompletion","sceneNumber","selectedParts","correctAnswers","uniqueSelectedParts","sortedSelected","sort","sortedCorrect","every","index","checkCorrectSelection","generateMemoryContinuityPrompt","s","memorySummary","DREAM_SCENE_INFO","theme","extractEmotionalReaction","aiOutput","emotionKeywords","sentences","replace","split","emotionalSentences","sentence","trimmed","slice","generateEnhancedMemoryContinuityPrompt","hasScene5Memory","previousMemories","scene5Info","scene5Completion","isScene5Correct","currentSceneInfo","scene4SpecialGuide","shouldGenerateHusbandThought","getCurrentRouteType","BOUNDARY_MAP","MOUTH_INTENSITY_KEYWORDS","checkMouthIntensityViolation","currentRealm","intensity","BODY_PART_DETECTION_KEYWORDS","detectMouthIntensity","violated","BODY_PART_REQUIRED_REALM","HUMILIATION_KEYWORDS","checkHumiliationAllowed","detected","detectHumiliationBehavior","allowed","checkBoundaryInterruption","shouldSkipBoundaryInterruption","violatedParts","realmGap","interruptProbability","wasInterrupted","detectedParts","detectBodyParts","mouthIntensityCheck","mouthIntensityViolation","humiliationCheck","humiliationViolation","maxRealmGap","intensityGap","humiliationGap","gap","canHusbandInterrupt","husbandSuspicion","randomRoll","toFixed","suspicionPenalty","canInterrupt","isTruthMode","basePenalty","ceil","calculateSuspicionPenalty","correctionPrompt","firstViolatedPart","isFirstPartMouthIntensity","reason","prompts","extreme_violation","generateBadEndPrompt","generateInterruptionPrompt","bodyPart","husbandCanInterrupt","isMouthIntensityViolation","randomChoice","MOUTH_INTENSITY_VIOLATION_TEMPLATES","template","REFUSAL_TEMPLATES_HUSBAND_HOME","REFUSAL_TEMPLATES_HUSBAND_AWAY","generateRefusalPrompt","SEVERE_INTERRUPTION_TEMPLATES","MODERATE_INTERRUPTION_TEMPLATES","arr","applyInterruptionResult","DISCOVERY_INITIAL_TEMPLATES","DISCOVERY_LOCKED_TEMPLATES","checkBadEnding","isAlreadyInBadEnding","isInBadEndingLock","replaceUserMessage","triggered","type","applyBadEndingState","ProtectionLevel","PROTECTED_FIELDS","SCRIPT_ONLY","READONLY","ABSOLUTE","currentSnapshot","getNestedValue","obj","path","keys","current","key","setNestedValue","updateSnapshotValue","JSON","stringify","deepEqual","a","b","Array","isArray","val","idx","aObj","bObj","aKeys","bKeys","scriptAuthToken","NORMAL_ENDING_LOCKED_TEMPLATES","checkNormalEnding","isInNormalEndingLock","firstGreeting","messages","getChatMessages","firstMessage","role","err","getFirstAIMessage","greetingText","generateNormalEndingInitialTemplate","generatePureLoveEndingTemplate","ending","TRUE_ENDING_PHASES","minTurns","maxTurns","minHour","anchorEvents","aiGuidance","correctionHints","strict","expectedActions","hintThreshold","progressHint","getGuidanceType","isPerfectTrueEnding","isTrueEndingActive","endingState","getTrueEndingState","updateTrueEndingState","state","ANCHOR_KEYWORDS","canEnterNextPhase","nextPhase","nextConfig","waitHours","hasExpectedAction","phaseConfig","input","checkProgressHint","threshold","processTurnEnd","newState","newAnchors","completed","anchor","test","detectCompletedAnchors","allAnchors","updatedState","hasProgress","hint","updateProgressTracking","phaseAdvanced","newPhase","shouldAdvancePhase","canEnter","timeBlocked","advanceToNextPhase","generateTrueEndingPrompt","remainingAnchors","isTimeLocked","turnsWarning","remainingTurns","timeBlockWarning","progressInfo","hintSection","urgencyHint","generateTrueEndingEntryReplacement","isPerfect","endingTitle","generateTimeBasedPrompt","guidanceType","generateFreeTimePrompt","phaseName","roomPrompt","generateRoomTriggerPrompt","FALSE_ENDING_PHASES","isFalseEndingActive","getFalseEndingState","updateFalseEndingState","canEnterNextFalsePhase","timeCheck","generateFalseEndingPrompt","generateFalseEndingComplete","allKeywords","flatMap","kws","k","isInputOnTrack","hints","PERFECT_ENDING_PHASES","isPerfectEndingActive","getPerfectEndingState","updatePerfectEndingState","PERFECT_ANCHOR_KEYWORDS","canEnterNextPerfectPhase","processPerfectTurnEnd","detectPerfectAnchors","shouldAdvancePerfectPhase","advanceToPerfectNextPhase","SEXUAL_BEHAVIOR_KEYWORDS","INTERRUPTION_KEYWORDS","CONFUSION_INITIAL_TEMPLATES","CONFUSION_LOCKED_TEMPLATES","SEXUAL_WARNING_TEMPLATES","confusion","detectSexualBehavior","hasAction","hasPart","detectWeddingInterruption","hasInterruption","isPerfectMemoryRoute","getViolationIncrement","markConfusionEnding","currentGlobalHour","checkConfusionEnding","forceFirstTrigger","isFirstTrigger","applyConfusionEndingState","canEnterDreamForConfusion","checkScene5Violations","interruptionResult","shouldMarkConfusion","oldConfusion","checkWeddingInterruptionInScene5","warningMessage","sexualResult","currentConfusion","currentCount","maxAllowed","newCount","newConfusion","checkSexualBehaviorInScene5","SCENE_CONFUSION_VALUES","setConfusionOnDreamEntry","targetValue","PERFECT_TRUE_AFTER_STORY","husbandStatus","interruptionLevel","round1","setting","round2","TRUE_ENDING_AFTER_STORY","FALSE_ENDING_AFTER_STORY","getAfterStoryType","isInAfterStory","isInFreeMode","getAfterStoryConfig","FREE_MODE_SETTINGS","timeFrame","relationship","zhaoXiaState","husbandState","suggestedScenes","tone","ENDING_GUIDANCE","DREAM_SCENE_DETAILS","DREAM_ENTRY_KEYWORDS","DREAM_ENTRY_PATTERNS","SLEEPING_PILL_KEYWORDS","DREAM_SCENE_THEMES","atmosphere","objective","identity","SCENE1_INIT_CONFIG","favorWeight","intimacyWeight","maxValue","minValue","baseValue","intimacyReduction","calculateScene1InitValues","rawDependence","initialDependence","rawMorality","initialMorality","relationshipStage","transferDescription","favor","intimacy","dependence","morality","stage","generateTransferDescription","getBodyPartInfluenceLevel","acceptanceLevel","generatePhaseAwareStatePrompt","overridePhase","sceneConfig","guidanceHour","isScene1","isScene2","isScene3","isScene4","pacing","getDreamTimePhaseGuidance","hoursRemaining","sceneAge","reminders","getDreamConstraintReminder","generateDreamPhasePrompt","timeInfo","period","lighting","getHusbandStatusDescription","timeConstraint","getTimeConstraintReminder","husbandConstraint","getHusbandConstraintReminder","realmConstraint","getRealmConstraintReminder","husbandThoughtConstraint","appearancePrompt","interactionPrompt","generateDailyPhasePrompt","generateDreamEntryReplacement","scene","continuityPrompt","initValues","initialAttitude","generateScene1EntryReplacement","chestProgress","scene1Data","hasScene1Memory","playerRelationship","generateScene2EntryReplacement","lowerBodyProgress","scene2Data","hasScene2Memory","generateScene3EntryReplacement","analProgress","scene3Data","memoryCount","Boolean","generateScene4EntryReplacement","getCurrentDreamScene","getSwipeId","chat","SillyTavern","isRollOperationBySwipeId","currentMessageId","lastRecord","lastMessageId","lastSwipeId","currentSwipeId","isRollOperation","resetRollOperationFlag","isInScene5","generateFullInjection","systemPrompt","shouldEnterDream","shouldActivateTrueEndingFlag","shouldProgressTrueEnding","trueEndingComplete","shouldActivatePerfectEndingFlag","shouldProgressPerfectEnding","perfectEndingComplete","shouldActivateFalseEndingFlag","shouldProgressFalseEnding","falseEndingComplete","shouldActivateAfterStoryFlag","shouldProgressAfterStory","afterStoryComplete","isInFreeModeFlag","shouldExitDream","shouldEnterScene5","shouldExitScene5","shouldProgressScene5Step","shouldTriggerWrongRoute","wrongRoutePart","shouldTriggerBadEnding","badEndingType","shouldTriggerNormalEnding","normalEndingType","confusionEndingResult","shouldActivateTrueEnding","shouldActivatePerfectEnding","shouldActivateFalseEnding","shouldActivateAfterStory","predictedConfusion","suspicionResult","predictedSuspicion","badEndingResult","normalEndingResult","triggeredPart","parts","checkPureLoveWrongRoute","replacement","_data","scenario","reaction","generatePureLoveWrongRouteReplacement","isDreamExitMessage","boundaryResult","checkScene5ForceExit","dreamEntryRollInfo","entryRecord","aiReplyFloor","entryType","expectedAiFloor","isDreamEntryRoll","getLastMessageId","hasKeyword","checkScene5Entry","violationResult","tempData","parse","generateScene5FreePlayReplacement","isNormalDreamRoll","checkDreamEntry","dreamExitRollSceneNum","exitRecord","isDreamExitRoll","checkDreamExit","bodySummary","sortedParts","_","developmentSummary","generateDreamExitReplacement","bodyInfluencePrompt","bodyPartConfig","displayName","behaviors","config","influence","behaviorExample","generateBodyPartInfluencePrompt","dreamFeedbackPrompt","phaseOverride","consistencyPrompt","confusionForeshadowing","endingEntryRollType","endingType","isTrueEndingRoll","isPerfectEndingRoll","isFalseEndingRoll","isEndingEntryRoll","endingGuidance","currentEnding","getEndingGuidance","currentDreamSceneNumber","dreamSceneGuidance","isInConfusionEndingLock","getDreamSceneGuidance","dreamHistoryBackground","excludeCurrentScene","correctScenes","summary","scene4Data","generateDreamHistoryBackground","excludeInfo","allCompleted","allCorrect","entryReplacement","isFreeTime","isPerfectEndingFreeTime","freeTimePrompt","perfectEndingPrompt","generatePerfectEndingPrompt","completeMessage","generateTrueEndingComplete","isFreeTimeHour","trueEndingPrompt","falseEndingPrompt","freeModePrompt","settings","generateFreeModePrompt","shouldTriggerAfterStory","generateAfterStoryEntryReplacement","currentRound","generateAfterStoryComplete","afterStoryPrompt","roundConfig","generateAfterStoryPrompt","initPromptInjection","currentRequestHasExtendedThinking","eventOn","tavern_events","CHAT_COMPLETION_SETTINGS_READY","generate_data","include_reasoning","CHAT_COMPLETION_PROMPT_READY","event_data","dryRun","variables","Mvu","getMvuData","message_id","statData","get","lastUserIndex","lastMessages","lastMessage","msgErr","content","shouldActivateTrueEndingResult","shouldProgressTrueEndingResult","trueEndingCompleteResult","shouldActivatePerfectEndingResult","shouldProgressPerfectEndingResult","perfectEndingCompleteResult","shouldActivateFalseEndingResult","shouldProgressFalseEndingResult","falseEndingCompleteResult","shouldActivateAfterStoryResult","shouldProgressAfterStoryResult","afterStoryCompleteResult","isInFreeModeResult","currentVars","currentData","set","replaceMvuData","badEndErr","normalEndErr","initialState","perfectEndErr","progressErr","completeErr","trueEndErr","falseEndErr","activateAfterStory","afterStoryErr","afterStoryMessageId","isAfterStoryRoll","afterStoryData","isAfterStoryRollOperation","newSwipeId","advanceAfterStoryRound","interruptErr","penaltyErr","newCompletion","stateErr","currentFloor","estimatedEntryId","setTimeout","eventEmit","isCurrentlyInDream","shouldFixDreamPhase","foundStatusVariable","msg","before","firstUserIndex","insertIndex","splice","prefillGuidance","broadcastGameEvent","event","checkEnding","size","hasEnteredDream","applyNormalEndingState","checkDreamEvents","userText","targetMessageId","dreamWindowOpen","dreamEnded","firstAwakening","alreadyCompleted","canEnterScene5","memoryContinuityPrompt","levelInfo","getBodyPartSummary","hasEntered","confusionLevel","dreamEntryKeywords","wantToEnterDream","isDreamWindow","isDaily","canEnterForConfusion","dreamAiReplyFloor","correctTarget","$","async","waitGlobalInitialized","events","VARIABLE_UPDATE_ENDED","new_variables","old_variables","newData","oldData","oldSuspicion","newSuspicion","currentStage","newValue","allParts","triggeredWrongRoute","resetTo","isFirstMessageAfterInit","processedEvents","processGameLogic","eventType","swipeId","messageKey","keysToRemove","from","String","forEach","delete","rollVars","rollStatData","newStep","lastProgressIncrement","currentCompletion","newProgressRecord","rollVarsForSummary","rollStatDataForSummary","summaryRecord","add","actualLastId","aiText","prevMessages","exitInfo","prevVars","prevStatData","dangerResult","originalInput","timeSkipResult","toastr","warning","timeOut","wantEnterScene5","canEnterScene5ForConfusion","existingScene5Data","newEntryCount","scene5AiReplyFloor","timeBeforeAdvance","timeAfterAdvance","scene5","lockScene5EntryCoherence","wasMarked","scene5DreamEntryId","scene5DreamExitId","snapshotData","timestamp","createDataSnapshot","changes","fixed","maxDay","change","validateAndFixState","changed","oldRealm","newRealm","checkRealmChange","validatedProgress","updateTruthModeValues","updateHusbandLocation","shouldSkipSuspicion","updateSuspicionLevel","husbandThought","thought","parseHusbandThought","cleanedAiText","aiMessageId","setChatMessages","refresh","suspicionLevel","finalState","protectionResult","snapshot","targetSnapshot","tamperedFields","restoredFields","dataObj","isInDream","isDreamEntryWindow","isScene5Window","originalValue","currentValue","startsWith","to","t","originalNum","currentNum","tamperedValue","validateAndRestoreData","report","toISOString","field","generateProtectionReport","validatedData","newVars","summaryInfo","chatHistory","dreamEntryMessageId","dreamExitMessageId","chatMessages","entryIndex","endIndex","dreamMessages","playerMessages","m","is_user","mes","aiMessages","emotionalReactions","playerCount","aiCount","r","getDreamSessionMessages","generateMemorySummary","summarySwipeId","finalVars","summaryErr","verifyVars","verifyData","VARIABLE_INITIALIZED","MESSAGE_RECEIVED","id","Number","MESSAGE_SWIPED","MESSAGE_DELETED","GENERATION_ENDED","actualMessageId"],"ignoreList":[],"sourceRoot":""}