{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/赵霞/schema.ts","src://tavern_helper_template/src/赵霞/脚本/变量结构/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = z;","import { z } from 'zod';\n\n/**\n * 赵霞游戏 - 数据结构定义\n *\n * 核心设计理念：\n * 1. 时间系统：零BUG设计，单一入口、原子更新\n * 2. 双重叙事：通过文本映射实现纯爱/真相模式切换\n * 3. 记忆重构：5个场景，正确重构才能达成真结局\n */\n\nexport const Schema = z.object({\n  // ============================================\n  // 世界状态（全局控制）\n  // ============================================\n  世界: z\n    .object({\n      // --- 时间系统（核心，零BUG设计） ---\n      // Bug #18 修复：结局阶段允许天数超过5（用于显示真实日期）\n      // 注意：stateValidation.ts 会在\"进行中\"状态下限制天数在1-5范围\n      当前天数: z.number().min(1).max(99).default(1), // 1-5天（结局阶段允许>5）\n      当前小时: z.number().min(0).max(23).default(8), // 0-23小时\n      时间: z.string().default('Day 1, 08:00'), // 显示用，格式：\"Day 1, 08:00\"\n      时间戳: z.number().default(0), // Date.now()，用于同步验证\n      状态栏需要刷新: z.boolean().default(true), // 关键标记，防止状态栏不同步\n\n      // --- 循环系统 ---\n      循环状态: z.enum(['进行中', '结局判定', '已破解']).default('进行中'),\n      当前循环轮数: z.number().default(1), // 玩家经历了多少次循环\n\n      // --- 双重叙事系统（文本映射控制） ---\n      已进入过梦境: z.boolean().default(false), // false=纯爱模式, true=真相模式\n\n      // --- 游戏状态 ---\n      游戏阶段: z.enum(['序章', '日常', '梦境', '结局']).default('序章'),\n\n      // --- 梦境选择状态（首次进入梦境楼层时的UI状态）---\n      // 注意：下划线前缀的字段是内部字段，AI请勿依据这些字段判断场景！\n      _梦境入口消息ID: z.number().optional(), // 触发梦境的消息楼层ID（内部字段）\n      _梦境入口天数: z.number().optional(), // 进入梦境时的天数（内部字段，用于锁定场景编号）\n      梦境选择已锁定: z.boolean().default(false), // 是否已完成部位选择\n\n      // --- 摘要生成标记 ---\n      待生成摘要: z\n        .object({\n          sceneNum: z.number().min(1).max(5), // 需要生成摘要的场景编号\n          dreamEntryId: z.number(), // 梦境进入时的楼层ID，用于获取聊天记录\n          dreamExitId: z.number().optional(), // Bug #25 修复：梦境退出时的楼层ID，用于限制收集范围\n        })\n        .optional(), // undefined 表示不需要生成摘要\n\n      // --- 梦境退出标记（用于延迟一轮生成摘要） ---\n      上一轮梦境已退出: z\n        .object({\n          sceneNum: z.number().min(1).max(5), // 退出的场景编号\n          dreamEntryId: z.number(), // 梦境进入时的楼层ID\n          dreamExitId: z.number().optional(), // Bug #25 修复：梦境退出时的楼层ID\n        })\n        .optional(), // undefined 表示上一轮没有退出\n\n      // --- ROLL 检测系统（Bug #21 修复：梦境退出 ROLL 支持） ---\n      // 记录上次梦境退出的楼层ID，用于在 CHAT_COMPLETION_PROMPT_READY 中检测 ROLL\n      _梦境退出记录: z\n        .object({\n          楼层ID: z.number().default(-1), // 上次退出时的 AI 回复楼层ID\n          场景编号: z.number().min(1).max(5).optional(), // 退出的场景编号（1-4 或 5）\n          swipe_id: z.number().default(-1), // 保留字段兼容性，不再使用\n        })\n        .optional(),\n\n      // --- ROLL 检测系统（梦境入口 ROLL 支持） ---\n      // 记录上次梦境入口的楼层ID，用于在 CHAT_COMPLETION_PROMPT_READY 中检测 ROLL\n      _梦境入口记录: z\n        .object({\n          楼层ID: z.number().default(-1), // 上次入口时的 AI 回复楼层ID\n          场景编号: z.number().min(1).max(5).optional(), // 进入的场景编号（1-4 或 5）\n          类型: z.enum(['普通梦境', '场景5']).optional(), // 入口类型\n        })\n        .optional(),\n\n      // --- ROLL 检测系统（摘要生成 ROLL 支持） ---\n      // 记录上次摘要生成的楼层ID和swipe_id，用于检测 ROLL 操作\n      // 当用户 ROLL 摘要生成的那条消息时，需要恢复\"待生成摘要\"标记\n      _摘要生成记录: z\n        .object({\n          楼层ID: z.number().default(-1), // 上次摘要生成时的消息楼层ID\n          swipe_id: z.number().default(0), // 上次摘要生成时的 swipe_id\n          场景编号: z.number().min(1).max(5).optional(), // 生成摘要的场景编号\n          入口楼层ID: z.number().optional(), // 梦境入口楼层ID（用于恢复标记）\n          退出楼层ID: z.number().optional(), // 梦境退出楼层ID（用于恢复标记）\n        })\n        .optional(),\n    })\n    .default({\n      当前天数: 1,\n      当前小时: 8,\n      时间: 'Day 1, 08:00',\n      时间戳: 0,\n      状态栏需要刷新: true,\n      循环状态: '进行中',\n      当前循环轮数: 1,\n      已进入过梦境: false,\n      游戏阶段: '序章',\n      梦境选择已锁定: false,\n    }),\n\n  // ============================================\n  // 赵霞状态（女主角数据）\n  // ============================================\n  赵霞状态: z\n    .object({\n      // --- 核心数值（真相模式） ---\n      依存度: z.number().min(0).max(100).default(0), // 对主角依存度\n      道德底线: z.number().min(0).max(100).default(80), // 越低越容易接受禁忌\n      对丈夫依存度: z.number().min(-50).max(100).default(60), // 对丈夫的情感\n\n      // --- 纯爱模式专属数值 ---\n      纯爱好感度: z.number().min(0).max(100).default(5), // AI控制，天数软上限保护\n      纯爱亲密度: z.number().min(0).max(100).default(0), // 范围内行为增加，决定关系阶段\n      // 关系阶段：陌生(0-19) → 破冰(20-39) → 信任(40-59) → 依恋(60-79) → 羁绊(80+，纯爱无法达到)\n\n      // --- 境界系统（真相模式：根据部位进度自动计算） ---\n      // 计算链条：部位进度平均值 = 依存度 → 依存度/20 = 境界\n      当前境界: z.number().min(1).max(5).default(1), // 1-5境界\n      // 境界1 初染: 依存度 0-19\n      // 境界2 迷途: 依存度 20-39\n      // 境界3 溺深: 依存度 40-59\n      // 境界4 归虚: 依存度 60-79\n      // 境界5 焚誓: 依存度 80+\n\n      // --- 部位开发进度（梦境和现实共用） ---\n      部位进度: z\n        .object({\n          嘴巴: z.number().min(0).max(100).default(0),\n          胸部: z.number().min(0).max(100).default(0),\n          下体: z.number().min(0).max(100).default(0),\n          后穴: z.number().min(0).max(100).default(0),\n          精神: z.number().min(0).max(100).default(0),\n        })\n        .default({\n          嘴巴: 0,\n          胸部: 0,\n          下体: 0,\n          后穴: 0,\n          精神: 0,\n        }),\n\n      // --- 位置和外观（AI更新） ---\n      当前位置: z.string().default('客厅'),\n      服装: z\n        .object({\n          上衣: z.string().default('米色真丝连衣裙上衣部分'),\n          下装: z.string().default('米色真丝连衣裙裙摆'),\n          内衣: z.string().default('白色蕾丝内衣'),\n          内裤: z.string().default('白色蕾丝内裤'),\n          袜子: z.string().default('肉色丝袜'),\n          鞋子: z.string().default('米色平底鞋'),\n        })\n        .default({\n          上衣: '米色真丝连衣裙上衣部分',\n          下装: '米色真丝连衣裙裙摆',\n          内衣: '白色蕾丝内衣',\n          内裤: '白色蕾丝内裤',\n          袜子: '肉色丝袜',\n          鞋子: '米色平底鞋',\n        }),\n      // --- 妆容和配件（AI更新） ---\n      妆容: z.string().default('淡妆'), // 纯爱：素颜/淡妆/日常妆/精致妆；真相：+浓妆/媚妆/色情妆\n      配件: z.string().default('婚戒'), // 纯爱：日常配件；真相：根据境界解锁情趣配件\n      改造: z.array(z.string()).default([]), // 真相模式专属：乳环、阴蒂环、淫纹、烙印等\n\n      心理活动: z.string().default('今天天气不错，该准备午餐了...'),\n    })\n    .default({\n      依存度: 0,\n      道德底线: 80,\n      对丈夫依存度: 60,\n      纯爱好感度: 5,\n      纯爱亲密度: 0,\n      当前境界: 1,\n      部位进度: {\n        嘴巴: 0,\n        胸部: 0,\n        下体: 0,\n        后穴: 0,\n        精神: 0,\n      },\n      当前位置: '客厅',\n      服装: {\n        上衣: '米色真丝连衣裙上衣部分',\n        下装: '米色真丝连衣裙裙摆',\n        内衣: '白色蕾丝内衣',\n        内裤: '白色蕾丝内裤',\n        袜子: '肉色丝袜',\n        鞋子: '米色平底鞋',\n      },\n      妆容: '淡妆',\n      配件: '婚戒',\n      改造: [],\n      心理活动: '今天天气不错，该准备午餐了...',\n    }),\n\n  // ============================================\n  // 记忆数据（梦境系统）\n  // ============================================\n  梦境数据: z\n    .object({\n      // --- 当前梦境状态 ---\n      当前记忆年龄: z.number().min(16).max(40).optional(), // 梦境中赵霞的记忆年龄（场景1为16岁）\n      梦境心理活动: z.string().optional(), // 梦境中赵霞的心理活动（第一人称）\n      此次梦境目标: z.string().optional(), // 玩家需要完成的梦境目标描述\n      记忆背景故事: z.string().optional(), // 当前记忆场景的背景故事描述\n\n      // --- 记忆场景完成情况 ---\n      已完成场景: z.array(z.number()).default([]), // [1, 2, 3, 4, 5]\n      正确重构场景: z.array(z.number()).default([]), // 记录哪些场景选择正确\n\n      // --- 场景详细数据 ---\n      场景1: z\n        .object({\n          已进入: z.boolean().default(false),\n          选择部位: z.array(z.string()).default([]), // 玩家选择的部位\n          是否正确: z.boolean().optional(),\n          进入时间: z.string().optional(), // \"Day 1, 23:00\"\n          对话轮数: z.number().default(0),\n          剧情摘要: z.string().optional(), // AI生成的完整记忆摘要，用于下一场景的记忆连续性\n        })\n        .optional(),\n\n      场景2: z\n        .object({\n          已进入: z.boolean().default(false),\n          选择部位: z.array(z.string()).default([]),\n          是否正确: z.boolean().optional(),\n          进入时间: z.string().optional(),\n          对话轮数: z.number().default(0),\n          剧情摘要: z.string().optional(), // AI生成的完整记忆摘要，用于下一场景的记忆连续性\n        })\n        .optional(),\n\n      场景3: z\n        .object({\n          已进入: z.boolean().default(false),\n          选择部位: z.array(z.string()).default([]),\n          是否正确: z.boolean().optional(),\n          进入时间: z.string().optional(),\n          对话轮数: z.number().default(0),\n          剧情摘要: z.string().optional(), // AI生成的完整记忆摘要，用于下一场景的记忆连续性\n        })\n        .optional(),\n\n      场景4: z\n        .object({\n          已进入: z.boolean().default(false),\n          选择部位: z.array(z.string()).default([]),\n          是否正确: z.boolean().optional(),\n          进入时间: z.string().optional(),\n          对话轮数: z.number().default(0),\n          剧情摘要: z.string().optional(), // AI生成的完整记忆摘要，用于下一场景的记忆连续性\n        })\n        .optional(),\n\n      场景5: z\n        .object({\n          已进入: z.boolean().default(false),\n          选择部位: z.array(z.string()).default([]),\n          是否正确: z.boolean().optional(),\n          进入时间: z.string().optional(),\n          对话轮数: z.number().default(0),\n          需要安眠药: z.boolean().default(true), // 场景5特殊：需要安眠药\n\n          // --- 场景5特有：12步线性剧情系统 ---\n          进入次数: z.number().default(0), // 记录进入场景5的次数\n          当前步骤: z.number().min(0).max(12).default(0), // 当前剧情步骤（0=未开始，1-12=对应步骤）\n          已完成步骤: z.boolean().default(false), // 是否已完成全部12步\n          上次剧情摘要: z.string().optional(), // AI生成的剧情摘要，用于下次进入时保持连续性\n          // --- 完成度系统（基于步骤） ---\n          // 完成度计算规则：\n          // - 每步根据玩家意图契合度加进度（高契合+10%，低契合+5%）\n          // - 12步全部高契合 = 120%，上限100%\n          // - 40%以上算完成，100%触发特殊结局行为\n          完成度: z.number().min(0).max(100).default(0), // 累计完成度（100%可触发特殊结局行为）\n          步骤进度记录: z.array(z.number()).default([]), // 每步获得的进度 [10, 5, 10, ...]\n\n          // --- ROLL 检测系统（Bug #11 修复） ---\n          // 记录上次步骤推进的楼层和 swipe_id，用于在 CHAT_COMPLETION_PROMPT_READY 中检测 ROLL\n          上次推进记录: z\n            .object({\n              楼层ID: z.number().default(-1), // 上次推进时的消息楼层ID\n              swipe_id: z.number().default(-1), // 上次推进时的 swipe_id\n            })\n            .optional(),\n\n          // --- Bug #13 修复：试探性进入机制 ---\n          // 场景5未完成（<100%）退出时，需要回滚混乱度和混乱结局标记\n          // 这样玩家可以\"试探性\"进入场景5，不会因为未完成就锁定坏结局\n          进入前混乱度: z.number().min(0).max(100).optional(), // 进入场景5前的混乱度\n          进入前混乱标记: z\n            .object({\n              已标记: z.boolean().default(false),\n              标记时间: z.number().nullable().default(null),\n              触发时间: z.number().nullable().default(null),\n              已触发: z.boolean().default(false),\n              触发原因: z.enum(['性行为', '打断仪式']).nullable().default(null),\n              性行为次数: z.number().default(0),\n            })\n            .optional(), // 进入场景5前的混乱结局标记\n        })\n        .optional(),\n\n      // --- 威胁数值（梦境路线专属） ---\n      // 混乱度在进入梦境场景时设置，不是从0开始累积：\n      // - 进入场景1: 设为40\n      // - 进入场景2: 设为60\n      // - 进入场景3: 设为80\n      // - 进入场景4: 不变\n      // - 进入场景5: 固定为80（无论之前路线）\n      // 场景5内越轨行为增加混乱度：完美路线+7，非完美路线+10，打断仪式直接=100\n      记忆混乱度: z.number().min(0).max(100).default(0), // 达到100触发精神崩溃结局\n\n      // --- 混乱结局系统（场景5专属坏结局） ---\n      // 当玩家在场景5中\"作死\"（性行为/打断婚礼）时触发\n      混乱结局: z\n        .object({\n          已标记: z.boolean().default(false), // 是否已标记触发\n          标记时间: z.number().nullable().default(null), // 标记时的小时数（世界.当前天数 * 24 + 世界.当前小时）\n          触发时间: z.number().nullable().default(null), // 应该触发的小时数（标记时间 + 1小时）\n          已触发: z.boolean().default(false), // 是否已经触发\n          触发原因: z.enum(['性行为', '打断仪式']).nullable().default(null), // 触发原因\n          性行为次数: z.number().default(0), // 场景5内检测到的性行为次数\n        })\n        .default({\n          已标记: false,\n          标记时间: null,\n          触发时间: null,\n          已触发: false,\n          触发原因: null,\n          性行为次数: 0,\n        }),\n\n      // --- 记忆连贯性系统 ---\n      // 进入场景5时自动计算，基于是否按顺序完成场景1-2-3\n      // 0: 未完成任何前置场景（直接进入场景5）\n      // 1: 完成场景1（有初恋记忆）\n      // 2: 完成场景1+2（有初恋+等待记忆）\n      // 3: 完成场景1+2+3（完美记忆路线）\n      // 注意：场景4时间线在场景5之后（27岁 vs 25岁），不计入连贯性\n      记忆连贯性: z.number().min(0).max(3).default(0),\n      // 进入场景5时的连贯性快照（锁定，不会因后续场景完成而改变）\n      场景5进入时连贯性: z.number().min(0).max(3).optional(),\n\n      // --- 每晚进度追踪（数值平衡：每晚上限20%） ---\n      当晚进度记录: z\n        .object({\n          天数: z.number().default(0), // 记录是哪一天的进度\n          嘴巴: z.number().default(0),\n          胸部: z.number().default(0),\n          下体: z.number().default(0),\n          后穴: z.number().default(0),\n          精神: z.number().default(0),\n        })\n        .default({ 天数: 0, 嘴巴: 0, 胸部: 0, 下体: 0, 后穴: 0, 精神: 0 }),\n    })\n    .default({\n      已完成场景: [],\n      正确重构场景: [],\n      记忆混乱度: 0,\n      混乱结局: {\n        已标记: false,\n        标记时间: null,\n        触发时间: null,\n        已触发: false,\n        触发原因: null,\n        性行为次数: 0,\n      },\n      记忆连贯性: 0,\n      当晚进度记录: { 天数: 0, 嘴巴: 0, 胸部: 0, 下体: 0, 后穴: 0, 精神: 0 },\n    }),\n\n  // ============================================\n  // 现实数据（日常互动）\n  // ============================================\n  现实数据: z\n    .object({\n      // --- 威胁数值（现实路线专属） ---\n      丈夫怀疑度: z.number().min(0).max(100).default(0), // 达到100触发坏结局\n\n      // --- 丈夫状态 ---\n      丈夫当前位置: z.enum(['客厅', '卧室', '书房', '厨房', '外出']).default('客厅'),\n\n      // --- 丈夫心理活动（真相模式状态栏显示，AI生成） ---\n      丈夫心理活动: z.string().optional(), // 基于怀疑度、服装、依存度和剧情生成，约50字\n    })\n    .default({\n      丈夫怀疑度: 0,\n      丈夫当前位置: '客厅',\n    }),\n\n  // ============================================\n  // 结局系统\n  // ============================================\n  结局数据: z\n    .object({\n      // 结局类型说明（2026-01-18 更新）：\n      // - 未触发：游戏进行中\n      // - 真好结局：完成全部5场景+正确重构（原\"堕落结局\"）\n      // - 完美真爱结局：真好结局 + 记忆连贯性=3（完美记忆路线）\n      // - 假好结局：完成全部5场景但有错误选择\n      // - 坏结局：怀疑度>=100（被丈夫发现）\n      // - 混乱结局：混乱度>=100（精神崩溃，由confusionEndingSystem处理）\n      // - 普通结局：时间耗尽但未完成（进入过梦境但未完成全部场景）\n      // - 纯爱结局：时间耗尽+未进入过梦境（无法突破时间循环，坏结局性质）\n      当前结局: z\n        .enum(['未触发', '真好结局', '完美真爱结局', '假好结局', '坏结局', '普通结局', '纯爱结局'])\n        .default('未触发'),\n      结局触发时间: z.string().optional(), // 记录结局触发时的时间\n      后日谈已解锁: z.boolean().default(false),\n      // 完美真爱结局专属标记\n      是完美记忆路线: z.boolean().default(false), // 记忆连贯性=3\n\n      // --- ROLL 检测系统（结局入口 ROLL 支持） ---\n      // 记录上次结局入口的楼层ID，用于在 CHAT_COMPLETION_PROMPT_READY 中检测 ROLL\n      _结局入口记录: z\n        .object({\n          楼层ID: z.number().default(-1), // 上次入口时的 AI 回复楼层ID\n          结局类型: z.enum(['真好结局', '完美真爱结局', '假好结局']).optional(),\n        })\n        .optional(),\n\n      // --- 后日谈系统（2026-01-17 新增） ---\n      // 后日谈是结局完成后的\"奖励模式\"，让玩家体验结局后的日常\n      后日谈: z\n        .object({\n          已触发: z.boolean().default(false), // 后日谈是否已开始\n          当前轮数: z.number().min(0).max(2).default(0), // 当前对话轮数（0-2）\n          已完成: z.boolean().default(false), // 后日谈是否已结束\n          自由模式: z.boolean().default(false), // 后日谈完成后解锁自由模式\n          // --- ROLL 检测系统（Bug #22 修复） ---\n          // 记录上次轮数推进的楼层ID和swipe_id，用于检测 ROLL 操作\n          上次推进记录: z\n            .object({\n              楼层ID: z.number().default(-1), // 上次推进时的消息楼层ID\n              swipe_id: z.number().default(0), // 上次推进时的 swipe_id\n            })\n            .optional(),\n        })\n        .default({\n          已触发: false,\n          当前轮数: 0,\n          已完成: false,\n          自由模式: false,\n        }),\n    })\n    .default({\n      当前结局: '未触发',\n      后日谈已解锁: false,\n      是完美记忆路线: false,\n      后日谈: {\n        已触发: false,\n        当前轮数: 0,\n        已完成: false,\n        自由模式: false,\n      },\n    }),\n\n  // ============================================\n  // 真好结局线性剧情状态\n  // ============================================\n  真好结局状态: z\n    .object({\n      // --- 激活状态 ---\n      isActive: z.boolean().default(false), // 是否已激活真好结局流程\n      isComplete: z.boolean().default(false), // 是否已完成\n\n      // --- 阶段进度 ---\n      currentPhase: z.number().min(0).max(9).default(0), // 当前阶段 (0-9)\n      turnsInPhase: z.number().default(0), // 当前阶段的对话轮数\n      totalTurns: z.number().default(0), // 总对话轮数\n\n      // --- 锚点事件追踪 ---\n      completedAnchors: z.array(z.string()).default([]), // 已完成的锚点事件\n\n      // --- 玩家引导机制（Bug #15 修复） ---\n      noProgressTurns: z.number().default(0), // 玩家连续未触发锚点的轮数\n      hintGiven: z.boolean().default(false), // 当前阶段是否已给出引导提示\n    })\n    .optional(),\n\n  // ============================================\n  // 完美真爱结局线性剧情状态（12步婚礼仪式）\n  // ============================================\n  完美真爱结局状态: z\n    .object({\n      // --- 激活状态 ---\n      isActive: z.boolean().default(false), // 是否已激活完美真爱结局流程\n      isComplete: z.boolean().default(false), // 是否已完成\n\n      // --- 阶段进度 ---\n      currentPhase: z.number().min(0).max(11).default(0), // 当前阶段 (0-11)\n      turnsInPhase: z.number().default(0), // 当前阶段的对话轮数\n      totalTurns: z.number().default(0), // 总对话轮数\n\n      // --- 锚点事件追踪 ---\n      completedAnchors: z.array(z.string()).default([]), // 已完成的锚点事件\n\n      // --- 玩家引导机制（Bug #15 修复） ---\n      noProgressTurns: z.number().default(0), // 玩家连续未触发锚点的轮数\n      hintGiven: z.boolean().default(false), // 当前阶段是否已给出引导提示\n    })\n    .optional(),\n\n  // ============================================\n  // 假好结局线性剧情状态\n  // ============================================\n  假好结局状态: z\n    .object({\n      // --- 激活状态 ---\n      isActive: z.boolean().default(false), // 是否已激活假好结局流程\n      isComplete: z.boolean().default(false), // 是否已完成\n\n      // --- 阶段进度 ---\n      currentPhase: z.number().min(0).max(7).default(0), // 当前阶段 (0-7)\n      turnsInPhase: z.number().default(0), // 当前阶段的对话轮数\n      totalTurns: z.number().default(0), // 总对话轮数\n\n      // --- 锚点事件追踪 ---\n      completedAnchors: z.array(z.string()).default([]), // 已完成的锚点事件\n\n      // --- 玩家引导机制（Bug #15 修复） ---\n      noProgressTurns: z.number().default(0), // 玩家连续未触发锚点的轮数\n      hintGiven: z.boolean().default(false), // 当前阶段是否已给出引导提示\n    })\n    .optional(),\n\n  // ============================================\n  // 调试数据（可选）\n  // ============================================\n  调试: z\n    .object({\n      时间更新历史: z.array(z.string()).default([]), // 记录最近10次时间更新\n      楼层时间记录: z.record(z.string(), z.string()).default({}), // {楼层ID: 时间}\n      启用调试日志: z.boolean().default(false),\n    })\n    .optional(),\n});\n\nexport type Schema = z.output<typeof Schema>;\n","import { registerMvuSchema } from 'https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/util/mvu_zod.js';\nimport { Schema } from '../../schema';\n\n$(() => {\n  registerMvuSchema(Schema);\n});\n"],"names":["z","Schema","object","number","min","max","default","string","boolean","enum","optional","sceneNum","dreamEntryId","dreamExitId","swipe_id","array","nullable","isActive","isComplete","currentPhase","turnsInPhase","totalTurns","completedAnchors","noProgressTurns","hintGiven","record","$"],"ignoreList":[],"sourceRoot":""}