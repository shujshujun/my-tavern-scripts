const e=z,t=e.z.enum(['抵抗','动摇','沉溺','疯狂','圆满']),n=e.z.enum(['简单','中等','困难','待定']),o=e.z.enum(['在家','出差','上班','睡眠']),r=e.z.object({念头内容:e.z.string(),植入时间:e.z.string().describe('格式: YYYY/MM/DD HH:mm'),过期时间:e.z.string().describe('植入时间+24h'),需要时间:e.z.coerce.number().describe('3-5小时，根据难度计算；待判定时为0'),难度等级:n.default('中等'),开发进度:e.z.coerce.number().default(0).describe('累积的相关互动时间（小时）'),待判定:e.z.boolean().default(!1).describe('本地无法匹配类型时为true，等待AI判定')}),s=e.z.object({内容:e.z.string().describe('具体的行为或思维模式'),形成时间:e.z.string().describe('格式: YYYY/MM/DD HH:mm')}),a=e.z.object({头部:e.z.string().default('无').describe('发饰、头饰等'),上装:e.z.string().default('米色针织开衫'),下装:e.z.string().default('深灰长裙'),内衣:e.z.object({上:e.z.string().default('肉色棉质文胸'),下:e.z.string().default('棉质内裤')}).default({}),袜裤:e.z.string().default('肉色丝袜'),鞋子:e.z.string().default('室内拖鞋'),外套:e.z.string().default('无').describe('大衣、披肩等'),配饰:e.z.string().default('婚戒').describe('首饰、手表等'),特殊装饰:e.z.string().default('无').describe('项圈、手铐等'),整体风格:e.z.string().default('居家贤妻'),暴露程度:e.z.enum(['保守','正常','清凉','暴露','极度暴露']).default('正常'),整洁度:e.z.enum(['整洁','略显凌乱','凌乱','破损','衣不蔽体']).default('整洁')}),i=e.z.object({底妆:e.z.string().default('素颜淡妆'),眼妆:e.z.string().default('无'),唇妆:e.z.string().default('淡粉色唇彩'),腮红:e.z.string().default('自然红晕'),特殊妆容:e.z.string().default('无').describe('纹身妆、泪痕妆等'),整体风格:e.z.string().default('清新自然'),浓淡程度:e.z.enum(['素颜','淡妆','日常妆','浓妆','艳妆']).default('淡妆')}),c=e.z.object({纹身:e.z.record(e.z.string(),e.z.string()).default({}).describe('部位: 纹身内容'),穿刺:e.z.object({耳环:e.z.boolean().default(!1),乳环:e.z.boolean().default(!1),乳头环:e.z.boolean().default(!1),阴蒂环:e.z.boolean().default(!1),舌环:e.z.boolean().default(!1),肚脐环:e.z.boolean().default(!1),阴唇环:e.z.boolean().default(!1),其他:e.z.array(e.z.string()).default([])}).default({}),乳晕改造:e.z.string().default('无').describe('如：增大、变色、穿刺等'),永久标记:e.z.array(e.z.string()).default([]).describe('烙印、伤疤等'),临时标记:e.z.array(e.z.string()).default([]).describe('吻痕、精液痕迹等'),体态变化:e.z.string().default('无').describe('因开发导致的身体变化')}),d=e.z.object({道德底线:e.z.coerce.number().transform(e=>_.clamp(e,0,100)).default(90),对主角依存度:e.z.coerce.number().transform(e=>_.clamp(e,-50,100)).default(20),对苏文依存度:e.z.coerce.number().transform(e=>_.clamp(e,-50,100)).default(80),潜意识侵蚀度:e.z.coerce.number().transform(e=>_.clamp(e,0,150)).default(0),当前阶段:e.z.coerce.number().transform(e=>_.clamp(e,1,5)).default(1),阶段标题:t.default('抵抗'),当前心理想法:e.z.string().default('').describe('秦璐当前的内心独白，AI每轮更新'),当前情绪:e.z.string().default('平静'),服装细节:a.default({}),妆容细节:i.default({}),身体改造:c.default({}),气质描述:e.z.string().default('温柔贤淑的家庭主妇'),习惯列表:e.z.array(s).default([]),念头培育区:e.z.array(r).transform(e=>{const t=new Set;return e.filter(e=>!t.has(e.念头内容)&&(t.add(e.念头内容),!0))}).default([])}),l=e.z.enum(['客厅','餐厅','厨房','主卧','浴室','主角房间','外面']),u=e.z.object({是否冻结:e.z.boolean().default(!1),借口内容:e.z.string().default(''),冻结开始时间:e.z.string().default(''),冻结结束时间:e.z.string().default('')}),f=e.z.object({基础印象:e.z.string().default('').describe('由脚本根据疑心值自动生成，AI不要修改'),细节描述:e.z.string().default('').describe('AI可以补充具体原因，不超过20字')}),m=e.z.object({是否生效:e.z.boolean().default(!1).describe('安眠药是否正在生效'),生效开始时间:e.z.string().default('').describe('安眠药开始生效的时间，格式: YYYY/MM/DD HH:mm'),生效结束时间:e.z.string().default('').describe('安眠药失效的时间（6小时后），格式: YYYY/MM/DD HH:mm'),剩余时间:e.z.coerce.number().default(0).describe('剩余生效时间（小时）'),上次使用时间:e.z.string().default('').describe('上次使用安眠药的时间，用于48小时冷却判定'),触发楼层:e.z.coerce.number().default(-1).describe('触发安眠药的消息楼层ID，用于ROLL时判断是否重复触发')}),g=e.z.object({是否住院:e.z.boolean().default(!1).describe('苏文是否因头孢+酒住院'),住院开始时间:e.z.string().default('').describe('住院开始时间，格式: YYYY/MM/DD HH:mm'),住院结束时间:e.z.string().default('').describe('住院结束时间（15天后），格式: YYYY/MM/DD HH:mm'),剩余天数:e.z.coerce.number().default(0).describe('剩余住院天数'),触发楼层:e.z.coerce.number().default(-1).describe('触发住院的消息楼层ID，用于ROLL时判断是否重复触发')}),y=e.z.object({当前状态:o.default('在家'),当前位置:l.default('客厅').describe('苏文当前所在位置'),当前情绪:e.z.string().default('平静'),安眠药状态:m.default({}),住院状态:g.default({}),对秦璐疑心值:e.z.coerce.number().transform(e=>_.clamp(e,0,100)).default(0),对秦璐印象:f.default({基础印象:'我的贤内助',细节描述:''}),对秦璐疑心值冻结:u.default({}),对苏梦疑心值:e.z.coerce.number().transform(e=>_.clamp(e,0,100)).default(0),对苏梦印象:f.default({基础印象:'我的乖女儿',细节描述:''}),对苏梦疑心值冻结:u.default({})}),p=e.z.object({时间:e.z.string().default('07:30').describe('格式: HH:mm'),日期:e.z.string().default('2024/11/20').describe('格式: YYYY/MM/DD'),星期:e.z.enum(['周一','周二','周三','周四','周五','周六','周日']).default('周三').describe('根据日期自动计算'),地点:e.z.string().default('家 - 客厅'),环境氛围:e.z.string().default('日常')}),b=e.z.object({需要更新:e.z.boolean().default(!1).describe('阶段变化时设为true，外观更新后设为false'),目标阶段:e.z.coerce.number().default(0).describe('需要更新到的目标阶段'),变化原因:e.z.string().default('').describe('如：阶段提升、剧情换装等')}),h=e.z.object({待触发:e.z.boolean().default(!1).describe('是否有待触发的打断事件'),已通知AI:e.z.boolean().default(!1).describe('是否已通过系统消息通知AI'),打断原因:e.z.string().default('').describe('如：在主角房间停留过久'),累计时间:e.z.coerce.number().default(0).describe('触发打断时的累计危险时间'),等待借口:e.z.boolean().default(!1).describe('是否正在等待玩家输入借口'),借口结果:e.z.enum(['待定','成功','失败']).default('待定').describe('借口判定结果')}),E=e.z.object({待触发:e.z.boolean().default(!1).describe('是否有待触发的巡逻事件'),已通知AI:e.z.boolean().default(!1).describe('是否已通过系统消息通知AI'),触发时间:e.z.string().default('').describe('巡逻触发的时间'),巡逻位置:e.z.string().default('').describe('苏文巡逻经过的位置'),上次巡逻时间:e.z.string().default('').describe('上次巡逻触发的时间，用于冷却'),离开期限:e.z.string().default('').describe('苏文要求离开的截止时间，格式: HH:mm'),期限小时数:e.z.coerce.number().default(0).describe('苏文设置的离开期限小时数（1-2小时）')}),S=e.z.object({目标:e.z.enum(['秦璐','苏梦']),内容:e.z.string(),植入时间:e.z.string().describe('格式: YYYY/MM/DD HH:mm'),植入楼层:e.z.coerce.number().describe('记录植入时的消息楼层ID'),已通知AI:e.z.boolean().default(!1).describe('是否已通过系统消息通知AI')}),w=e.z.object({事件类型:e.z.enum(['阶段突破','苏文打断','苏文巡逻']),角色:e.z.enum(['秦璐','苏梦']),触发楼层:e.z.coerce.number().describe('记录触发时的消息楼层ID'),触发时间:e.z.string().describe('格式: YYYY/MM/DD HH:mm'),已通知AI:e.z.boolean().default(!1).describe('是否已通过用户消息替换通知AI'),阶段号:e.z.coerce.number().optional().describe('阶段突破时的新阶段'),累计时间:e.z.coerce.number().optional().describe('打断事件时的累计危险时间'),打断原因:e.z.string().optional().describe('打断事件的原因'),巡逻位置:e.z.string().optional().describe('巡逻事件的位置')}),M=e.z.object({当前所在位置:e.z.string().default('客厅'),当前角色:e.z.enum(['秦璐','苏梦']).default('秦璐').describe('当前所在位置的是哪个角色'),进入当前位置时间:e.z.string().default(''),上次更新时间:e.z.string().default(''),上次衰减日期:e.z.string().default('').describe('上次疑心值自然衰减的日期，格式: YYYY/MM/DD'),危险时间累计:e.z.coerce.number().default(0).describe('【已废弃】兼容旧数据，新逻辑使用角色独立的危险时间累计'),秦璐危险时间累计:e.z.coerce.number().default(0).describe('秦璐在主角房间且苏文在家清醒的累计小时数'),苏梦危险时间累计:e.z.coerce.number().default(0).describe('苏梦在主角房间且苏文在家清醒的累计小时数'),秦璐外观待更新:b.default({}),苏梦外观待更新:b.default({}),苏文打断事件:h.default({}),苏文巡逻事件:E.default({}),念头植入日志:e.z.array(S).default([]).describe('记录待通知AI的念头植入操作'),强制事件日志:e.z.array(w).default([]).describe('记录待通知AI的强制事件')}),D=e.z.object({世界:p.default({}),秦璐状态:d.default({}),苏梦状态:d.default({道德底线:85,对主角依存度:25,对苏文依存度:70,服装细节:{头部:'黑色发圈',上装:'白色棉麻衬衫',下装:'浅蓝牛仔裤',内衣:{上:'白色蕾丝文胸',下:'白色棉质内裤'},袜裤:'白色短袜',鞋子:'帆布鞋',整体风格:'青春休闲'},妆容细节:{浓淡程度:'素颜'},气质描述:'活泼开朗的大学生'}),苏文状态:y.default({}),系统追踪:M.default({})}),I=[{keywords:['一个星期后','一周后'],days:7},{keywords:['几天后','几天之后'],days:5},{keywords:['一天后'],days:1},{keywords:['两天后'],days:2},{keywords:['三天后'],days:3},{keywords:['一个月后'],days:30},{keywords:['几个月后'],days:90},{keywords:['半年后'],days:180},{keywords:['一年后'],days:365},{keywords:['第二天','次日','隔天','明天'],nextDay:!0,targetHour:8},{keywords:['后天'],days:2,targetHour:8},{keywords:['大后天'],days:3,targetHour:8},{keywords:['几个小时后','几小时后'],hours:3},{keywords:['一小时后'],hours:1},{keywords:['两小时后'],hours:2},{keywords:['三小时后'],hours:3},{keywords:['半小时后'],hours:1},{keywords:['过了一会','过了很久','过了一段时间'],hours:2},{keywords:['早上','早晨','清晨'],targetHour:7},{keywords:['上午'],targetHour:10},{keywords:['中午','午后'],targetHour:12},{keywords:['下午'],targetHour:15},{keywords:['傍晚','黄昏'],targetHour:18},{keywords:['晚上'],targetHour:20},{keywords:['深夜','午夜'],targetHour:23},{keywords:['凌晨'],nextDay:!0,targetHour:2},{keywords:['吃早饭','早餐'],targetHour:8},{keywords:['吃午饭','午餐'],targetHour:12},{keywords:['吃晚饭','晚餐'],targetHour:19},{keywords:['睡觉前','睡前'],targetHour:22},{keywords:['起床后'],targetHour:7},{keywords:['下班后','放学后'],targetHour:18},{keywords:['时间来到','时间跳转','场景切换到'],hours:3}];const A={公共区域:['客厅','餐厅','厨房'],主角房间:['主角房间'],苏梦房间:['苏梦房间'],主卧:['主卧'],浴室:['浴室'],外面:['外面']};function k(e){for(const[t,n]of Object.entries(A))if(n.includes(e))return t;return null}function x(e,t){const n=k(e),o=k(t);return!(!n||!o)&&n===o}function H(e,t){const[n,o,r]=t.split('/').map(Number),[s,a]=e.split(':').map(Number);return new Date(n,o-1,r,s,a)}const N=['安眠药','安眠藥','吃下安眠','服用安眠','喂安眠','餵安眠','下药','下藥','迷药','迷藥','睡眠药','睡眠藥'],C=['头孢.*酒','酒.*头孢','頭孢.*酒','酒.*頭孢','头孢菌素.*酒','酒.*头孢菌素','喂头孢','喂酒.*头孢','头孢.*喝酒','吃头孢.*喝酒','喝酒.*吃头孢','服用头孢.*饮酒','饮酒.*服用头孢','双硫仑','雙硫侖','头孢加酒','酒加头孢','头孢配酒','酒配头孢'];function T(e,t,n){if(!e||!e.includes(' '))return!0;const[o,r]=e.split(' ');if(!o||!r)return!0;const s=H(r,o);return(H(n,t).getTime()-s.getTime())/36e5>=48}const v={baseProbability:.15,timeModifiers:{morning:{start:7,end:12,modifier:1},afternoon:{start:12,end:18,modifier:1.2},evening:{start:18,end:22,modifier:.8},night:{start:22,end:7,modifier:.3}},suspicionModifiers:[{min:0,max:20,modifier:.8},{min:20,max:40,modifier:1},{min:40,max:60,modifier:1.3},{min:60,max:80,modifier:1.6},{min:80,max:100,modifier:2}],cooldownHours:2};function Y(e,t){const n=v.baseProbability*function(e){const{timeModifiers:t}=v;return e>=t.morning.start&&e<t.morning.end?t.morning.modifier:e>=t.afternoon.start&&e<t.afternoon.end?t.afternoon.modifier:e>=t.evening.start&&e<t.evening.end?t.evening.modifier:t.night.modifier}(e)*function(e){for(const t of v.suspicionModifiers)if(e>=t.min&&e<t.max)return t.modifier;return 1}(t);return Math.min(.8,Math.max(0,n))}function R(e,t,n){const o=function(e){const t=[e],n=e.split(/[，。、；：！？\s]+/).filter(e=>e.length>=2);t.push(...n);for(let n=2;n<=Math.min(4,e.length);n++)for(let o=0;o<=e.length-n;o++){const r=e.slice(o,o+n);/^[，。、；：！？\s]+$/.test(r)||t.push(r)}return[...new Set(t)]}(e),r=`${t} ${n}`.toLowerCase();let s=0,a=!1;for(const t of o)r.includes(t.toLowerCase())&&(s++,t===e&&(a=!0));return a||s>=5?3:s>=3?2:s>=1?1:0}function L(e){return!0===e.苏文状态.安眠药状态?.是否生效}function O(e){return!0===e.苏文状态.住院状态?.是否住院}function G(e,t,n){const o=e.世界?.日期,r=e.世界?.时间;if(!(r&&o&&r.includes(':')&&o.includes('/')))return console.error('[时间推进] 时间格式无效!',{时间:r,日期:o}),null;const[s,a]=r.split(':').map(Number),[i,c,d]=o.split('/').map(Number);if(isNaN(s)||isNaN(a)||isNaN(i)||isNaN(c)||isNaN(d))return console.error('[时间推进] 时间解析失败!',{hours:s,minutes:a,year:i,month:c,day:d}),null;const l=function(e,t){if(!e)return 0;if(['头孢.*酒','酒.*头孢','住院','紧急送医','双硫仑','头孢菌素','喂头孢','服用头孢','吃头孢','安眠药','安眠藥','服用安眠','吃下安眠','喂安眠','餵安眠','下药','下藥','迷药','迷藥','睡眠药','睡眠藥'].some(t=>new RegExp(t,'i').test(e)))return console.info('[时间跳跃] 检测到特殊道具相关内容（住院/安眠药），跳过时间跳跃检测，使用默认+1小时'),0;for(const n of I)if(n.keywords.some(t=>e.includes(t))){if(console.info(`[时间跳跃] 检测到关键词: ${n.keywords.find(t=>e.includes(t))}`),void 0!==n.days){let e=24*n.days;if(void 0!==n.targetHour){const o=(n.targetHour-t+24)%24;e=24*(n.days-1)+o,0===o&&(e+=24)}return console.info(`[时间跳跃] 天数跳跃: ${n.days}天 = ${e}小时`),e}if(void 0!==n.hours)return console.info(`[时间跳跃] 小时跳跃: ${n.hours}小时`),n.hours;if(void 0!==n.targetHour){let e=n.targetHour-t;return(n.nextDay||e<=0)&&(e+=24),console.info(`[时间跳跃] 目标时间跳跃: 当前${t}点 → ${n.targetHour}点 = ${e}小时`),e}}return 0}(t,s),u=l>0?l:1,f=l>1;l>0&&console.info(`[时间推进] 检测到时间跳跃，推进 ${u} 小时`);const m=new Date(i,c-1,d,s,a);m.setHours(m.getHours()+u);const g=String(m.getHours()).padStart(2,'0'),y=`${g}:${String(m.getMinutes()).padStart(2,'0')}`,p=`${m.getFullYear()}/${String(m.getMonth()+1).padStart(2,'0')}/${String(m.getDate()).padStart(2,'0')}`,b=['周日','周一','周二','周三','周四','周五','周六'][m.getDay()];e.世界.时间=y,e.世界.日期=p,e.世界.星期=b,e._推进前时间=`${o} ${r}`;const h=e.系统追踪,E=e.世界?.地点||'',S=E.includes('主角房间'),w=S?'主角房间':E.split(' - ').pop()||'客厅',M=h.当前所在位置;M!==w&&(h.当前所在位置=w,h.进入当前位置时间=`${p} ${y}`,console.info(`[位置追踪] 位置变化: ${M} → ${w}`),'主角房间'!==M||S||(h.苏文打断事件?.待触发&&h.苏文打断事件?.已通知AI?(console.info('[位置追踪] 角色离开主角房间，打断事件已通知AI，清除打断事件标记'),h.苏文打断事件.待触发=!1,h.苏文打断事件.已通知AI=!1,h.苏文打断事件.打断原因='',h.苏文打断事件.累计时间=0):h.苏文打断事件?.待触发&&console.info('[位置追踪] 角色离开主角房间，但打断事件尚未通知AI，保留打断事件'))),h.上次更新时间=`${p} ${y}`,function(e,t,n){const[o,r]=n.split(':').map(Number),s=60*o+r,[a,i,c]=t.split('/').map(Number),d=new Date(a,i-1,c).getDay();let l='在家',u='客厅';if(0===d||6===d)s>=1380||s<420?(l='睡眠',u='主卧'):s>=420&&s<480?(l='在家',u='主卧'):s>=480&&s<540?(l='在家',u=Math.random()<.5?'餐厅':'厨房'):s>=540&&s<720?(l='在家',u='客厅'):s>=720&&s<780?(l='在家',u=Math.random()<.5?'餐厅':'厨房'):s>=780&&s<1080?(l='在家',u=Math.random()<.3?'外面':'客厅'):s>=1080&&s<1140?(l='在家',u=Math.random()<.5?'餐厅':'厨房'):s>=1140&&s<1320?(l='在家',u='客厅'):s>=1320&&s<1380&&(l='在家',u=Math.random()<.5?'主卧':'浴室');else{const e=1===d||3===d||5===d;s>=1380||s<360?(l='睡眠',u='主卧'):s>=360&&s<420?(l='在家',u='主卧'):s>=420&&s<480?(l='在家',u=Math.random()<.5?'餐厅':'厨房'):e?s>=480&&s<720?(l='上班',u='外面'):s>=720&&s<780?(l='在家',u=Math.random()<.5?'餐厅':'厨房'):s>=780&&s<1080?(l='在家',u='客厅'):s>=1080&&s<1140?(l='在家',u=Math.random()<.5?'餐厅':'厨房'):s>=1140&&s<1320?(l='在家',u='客厅'):s>=1320&&s<1380&&(l='在家',u=Math.random()<.5?'主卧':'浴室'):s>=480&&s<720?(l='在家',u='客厅'):s>=720&&s<780?(l='在家',u=Math.random()<.5?'餐厅':'厨房'):s>=780&&s<1080?(l='上班',u='外面'):s>=1080&&s<1140?(l='在家',u=Math.random()<.5?'客厅':'厨房'):s>=1140&&s<1320?(l='在家',u='客厅'):s>=1320&&s<1380&&(l='在家',u=Math.random()<.5?'主卧':'浴室')}const f=e.系统追踪?.苏文巡逻事件?.待触发;f?e.苏文状态.当前状态!==l&&(e.苏文状态.当前状态=l):e.苏文状态.当前状态===l&&e.苏文状态.当前位置===u||(e.苏文状态.当前状态=l,e.苏文状态.当前位置=u)}(e,p,y);const D=`${t} ${n}`,A=getLastMessageId();var k;(k=D)&&C.some(e=>new RegExp(e,'i').test(k))&&function(e,t,n,o){const r=e.苏文状态.住院状态;if((r?.触发楼层??-1)===o&&r?.是否住院)return console.info(`[头孢+酒] 检测到ROLL（楼层${o}），住院状态已激活，保持现有状态`),!0;if(r?.是否住院)return console.warn('[头孢+酒] 苏文已在住院中，无法重复触发'),!1;const s=H(n,t),a=new Date(s.getTime());a.setDate(a.getDate()+15);const i=a.getFullYear(),c=String(a.getMonth()+1).padStart(2,'0'),d=String(a.getDate()).padStart(2,'0'),l=String(a.getHours()).padStart(2,'0'),u=String(a.getMinutes()).padStart(2,'0');e.苏文状态.住院状态={是否住院:!0,住院开始时间:`${t} ${n}`,住院结束时间:`${i}/${c}/${d} ${l}:${u}`,剩余天数:15,触发楼层:o};const f=`${i}/${c}/${d} ${l}:${u}`;e.苏文状态.对秦璐疑心值冻结={是否冻结:!0,借口内容:'苏文住院中',冻结开始时间:`${t} ${n}`,冻结结束时间:f},e.苏文状态.对苏梦疑心值冻结={是否冻结:!0,借口内容:'苏文住院中',冻结开始时间:`${t} ${n}`,冻结结束时间:f},console.info(`[头孢+酒] 终极隐藏模式触发！苏文因头孢+酒反应紧急住院，将于 ${e.苏文状态.住院状态.住院结束时间} 出院`),console.info('[头孢+酒] 疑心值冻结15天，秦璐/苏梦可全阶段植入念头')}(e,p,y,A);const L=function(e,t,n){const o=e.苏文状态.住院状态;if(!o?.是否住院)return!1;const r=o.住院结束时间;if(!r||!r.includes(' '))return!1;const[s,a]=r.split(' ');if(!s||!a)return!1;const i=H(a,s),c=H(n,t);if(c>=i)return e.苏文状态.住院状态={是否住院:!1,住院开始时间:'',住院结束时间:'',剩余天数:0,触发楼层:-1},console.info('[头孢+酒] 苏文出院，恢复正常状态'),!1;const d=i.getTime()-c.getTime(),l=Math.ceil(d/864e5);return e.苏文状态.住院状态.剩余天数=l,!0}(e,p,y);L&&(e.苏文状态.当前状态='出差',e.苏文状态.当前位置='外面',console.info(`[头孢+酒] 苏文住院中，剩余 ${e.苏文状态.住院状态.剩余天数} 天`)),!L&&function(e){return!!e&&N.some(t=>e.includes(t))}(D)&&function(e,t,n,o){const r=e.苏文状态.安眠药状态,s=r.上次使用时间,a=r.触发楼层??-1;if(a===o&&r.是否生效)return console.info(`[安眠药] 检测到ROLL（楼层${o}），安眠药已生效，保持现有状态`),!0;if(a===o)console.info(`[安眠药] 检测到ROLL（楼层${o}），跳过冷却检查`);else if(!T(s,t,n))return console.warn('[安眠药] 安眠药冷却中（48小时），无法使用'),!1;const i=H(n,t),c=new Date(i.getTime());c.setHours(c.getHours()+6);const d=c.getFullYear(),l=String(c.getMonth()+1).padStart(2,'0'),u=String(c.getDate()).padStart(2,'0'),f=String(c.getHours()).padStart(2,'0'),m=String(c.getMinutes()).padStart(2,'0');e.苏文状态.安眠药状态={是否生效:!0,生效开始时间:`${t} ${n}`,生效结束时间:`${d}/${l}/${u} ${f}:${m}`,剩余时间:6,上次使用时间:`${t} ${n}`,触发楼层:o},console.info(`[安眠药] 苏文服用安眠药，陷入沉睡，将于 ${e.苏文状态.安眠药状态.生效结束时间} 苏醒`)}(e,p,y,A);const O=!L&&function(e,t,n){const o=e.苏文状态.安眠药状态;if(!o.是否生效)return!1;const r=o.生效结束时间;if(!r||!r.includes(' '))return!1;const[s,a]=r.split(' ');if(!s||!a)return!1;const i=H(a,s),c=H(n,t);if(c>=i){const t=o.上次使用时间;return e.苏文状态.安眠药状态={是否生效:!1,生效开始时间:'',生效结束时间:'',剩余时间:0,上次使用时间:t,触发楼层:-1},console.info('[安眠药] 苏文从沉睡中苏醒'),!1}const d=i.getTime()-c.getTime(),l=Math.ceil(d/36e5);return e.苏文状态.安眠药状态.剩余时间=l,!0}(e,p,y);O&&(e.苏文状态.当前状态='睡眠',e.苏文状态.当前位置='主卧',console.info(`[安眠药] 苏文处于安眠药沉睡状态，剩余 ${e.苏文状态.安眠药状态.剩余时间} 小时`));const G=h.当前所在位置,j=h.当前角色||'秦璐',F=e.苏文状态.当前位置||'客厅',P=e.苏文状态.当前状态;console.info(`[疑心值追踪] 时间: ${o} ${r} → ${p} ${y}`),console.info(`[疑心值追踪] 当前角色="${j}", 当前位置="${G}", 苏文位置="${F}", 苏文状态="${P}"`),void 0===h.秦璐危险时间累计&&(h.秦璐危险时间累计='秦璐'===j&&h.危险时间累计||0),void 0===h.苏梦危险时间累计&&(h.苏梦危险时间累计='苏梦'===j&&h.危险时间累计||0);const q='主角房间'===G&&function(e,t,n,o){return!(e['秦璐'===o?'对秦璐疑心值冻结':'对苏梦疑心值冻结'].是否冻结||'睡眠'===e.当前状态||'出差'===e.当前状态||'上班'===e.当前状态||'外面'===n||'主角房间'!==t&&''!==t&&t||x(t||'主角房间',n))}(e.苏文状态,G,F,j),W='秦璐'===j?'秦璐危险时间累计':'苏梦危险时间累计',V=h[W]||0;if(console.info(`[疑心值追踪] ${j}: isInDanger=${q}, 危险时间累计=${V}`),q){if(h[W]=V+1,console.info(`[疑心值追踪] ${j} 累积 +1 小时，当前累计=${h[W]}小时`),h[W]>=2&&h[W]<4){const t='秦璐'===j?'对秦璐疑心值':'对苏梦疑心值';e.苏文状态[t]+=5,console.info(`[疑心值追踪] ${j} 累积达到 ${h[W]} 小时，疑心值 +5`)}if(h[W]>=4){const t='秦璐'===j?'对秦璐疑心值':'对苏梦疑心值';e.苏文状态[t]+=10,h.苏文打断事件={待触发:!0,已通知AI:!1,打断原因:`${j}在主角房间停留超过4小时`,累计时间:h[W],等待借口:!1,借口结果:'待定'},console.info(`[疑心值追踪] ${j} 累积达到 ${h[W]} 小时，疑心值 +10，触发打断事件`);const n=getLastMessageId();h.强制事件日志=h.强制事件日志||[],h.强制事件日志.push({事件类型:'苏文打断',角色:j,触发楼层:n,触发时间:`${p} ${y}`,已通知AI:!1,累计时间:h[W],打断原因:`${j}在主角房间停留超过4小时`}),console.info(`[疑心值追踪] 已写入苏文打断日志: ${j}, 楼层${n}`),h[W]=0}}else if(V>0){'睡眠'===e.苏文状态.当前状态||'上班'===e.苏文状态.当前状态||'出差'===e.苏文状态.当前状态||'外面'===F?V<2?(console.warn(`[疑心值追踪] ${j} 窗口关闭（苏文状态="${e.苏文状态.当前状态}"），累积不足2小时（${V}h），累积作废`),h[W]=0):(console.info(`[疑心值追踪] ${j} 窗口关闭（苏文状态="${e.苏文状态.当前状态}"），累积已达标（${V}h），保留结果并清零`),h[W]=0):console.info(`[疑心值追踪] ${j} 角色离开主角房间（当前位置="${G}"），累积暂停但保留（${V}h）`)}const U=h.上次衰减日期||p;if(U!==p){const[t,n,o]=U.split('/').map(Number),[r,s,a]=p.split('/').map(Number),i=new Date(t,n-1,o),c=new Date(r,s-1,a),d=Math.floor((c.getTime()-i.getTime())/864e5);if(d>0){const t=2*d;['对秦璐疑心值','对苏梦疑心值'].forEach(n=>{const o=e.苏文状态[n];e.苏文状态[n]=Math.max(0,o-t)}),h.上次衰减日期=p}}if(!q&&x(G,F)&&'在家'===e.苏文状态.当前状态){const t='秦璐'===j?'对秦璐疑心值':'对苏梦疑心值',n='秦璐'===j?'对秦璐疑心值冻结':'对苏梦疑心值冻结';!e.苏文状态[n].是否冻结&&e.苏文状态[t]>0&&(e.苏文状态[t]=Math.max(0,e.苏文状态[t]-1))}['秦璐状态','苏梦状态'].forEach(o=>{const r=e[o];r&&r.念头培育区.forEach(e=>{if(f){const t=e.开发进度;e.开发进度+=1;const n=H(y,p);n.setHours(n.getHours()+12);const r=n.getFullYear(),s=String(n.getMonth()+1).padStart(2,'0'),a=String(n.getDate()).padStart(2,'0'),i=String(n.getHours()).padStart(2,'0'),c=String(n.getMinutes()).padStart(2,'0');e.过期时间=`${r}/${s}/${a} ${i}:${c}`,console.info(`[念头开发] 时间跳跃处理 ${o}: "${e.念头内容}" 进度 ${t} → ${e.开发进度}, 过期时间延长至 ${e.过期时间}`)}else{const o=[0,.5,1,1.5][R(e.念头内容,t,n)];o>0&&(e.开发进度+=o)}})});const J=h.苏文巡逻事件,B='秦璐'===j?'对秦璐疑心值冻结':'对苏梦疑心值冻结';if(q&&!J.待触发&&!e.苏文状态[B].是否冻结&&function(e,t,n){if(!e||!e.includes(' '))return!0;const[o,r]=e.split(' ');if(!o||!r)return!0;const s=H(r,o);return(H(n,t).getTime()-s.getTime())/36e5>=v.cooldownHours}(J.上次巡逻时间,p,y)){const t='秦璐'===j?'对秦璐疑心值':'对苏梦疑心值',n=Y(parseInt(g),e.苏文状态[t]);if(Math.random()<n){const e=1+Math.floor(2*Math.random()),t=H(y,p);t.setHours(t.getHours()+e);const n=String(t.getHours()).padStart(2,'0'),o=String(t.getMinutes()).padStart(2,'0');h.苏文巡逻事件={待触发:!0,已通知AI:!1,触发时间:`${p} ${y}`,巡逻位置:'主角房间门口',上次巡逻时间:`${p} ${y}`,离开期限:`${n}:${o}`,期限小时数:e};const r=getLastMessageId();h.强制事件日志=h.强制事件日志||[],h.强制事件日志.push({事件类型:'苏文巡逻',角色:j,触发楼层:r,触发时间:`${p} ${y}`,已通知AI:!1}),console.info(`[疑心值追踪] 已写入苏文巡逻日志: ${j}, 楼层${r}`),h[W]=0}}if(J.待触发&&J.已通知AI&&J.离开期限){let t=j;const n=h.强制事件日志?.find(e=>'苏文巡逻'===e.事件类型&&e.已通知AI);n?(t=n.角色,console.info(`[巡逻事件] 从日志获取触发角色: ${t}`)):console.warn(`[巡逻事件] 未找到巡逻日志，使用当前角色: ${j}`);if('主角房间'!==(h.当前角色===t?h.当前所在位置:'客厅'))console.info(`[巡逻事件] ${t}已离开主角房间，巡逻事件结束`),h.苏文巡逻事件.待触发=!1,h.苏文巡逻事件.已通知AI=!1,h.苏文巡逻事件.离开期限='',h.苏文巡逻事件.期限小时数=0;else{const[n,o]=J.离开期限.split(':').map(Number),r=H(y,p),s=H(y,p);s.setHours(n,o,0,0);const a=J.触发时间.split(' ')[1]?.split(':');if(a){n<parseInt(a[0])&&s.setDate(s.getDate()+1)}if(r>=s){console.info(`[巡逻事件] ${t}超时未离开（期限${J.离开期限}），触发打断事件`);const n='秦璐'===t?'对秦璐疑心值':'对苏梦疑心值';e.苏文状态[n]+=10,h.苏文打断事件={待触发:!0,已通知AI:!1,打断原因:`${t}无视苏文警告，超时未离开主角房间`,累计时间:J.期限小时数,等待借口:!1,借口结果:'待定'};const o=getLastMessageId();h.强制事件日志=h.强制事件日志||[],h.强制事件日志.push({事件类型:'苏文打断',角色:t,触发楼层:o,触发时间:`${p} ${y}`,已通知AI:!1,累计时间:J.期限小时数,打断原因:`${t}无视苏文警告，超时未离开主角房间`}),h.苏文巡逻事件.待触发=!1,h.苏文巡逻事件.已通知AI=!1,h.苏文巡逻事件.离开期限='',h.苏文巡逻事件.期限小时数=0}else console.info(`[巡逻事件] ${t}尚未离开，剩余时间至${J.离开期限}`)}}const Z=h.苏文打断事件;if(Z.待触发&&Z.已通知AI&&'待定'!==Z.借口结果){let t=j;const n=h.强制事件日志?.find(e=>'苏文打断'===e.事件类型&&e.已通知AI);n&&(t=n.角色,console.info(`[打断事件] 从日志获取触发角色: ${t}`));const o='秦璐'===t?'对秦璐疑心值':'对苏梦疑心值',r='秦璐'===t?'对秦璐疑心值冻结':'对苏梦疑心值冻结';if('成功'===Z.借口结果){const t=2,n=H(y,p);n.setHours(n.getHours()+t);const o=n.getFullYear(),s=String(n.getMonth()+1).padStart(2,'0'),a=String(n.getDate()).padStart(2,'0'),i=String(n.getHours()).padStart(2,'0'),c=String(n.getMinutes()).padStart(2,'0');e.苏文状态[r]={是否冻结:!0,借口内容:Z.打断原因||'借口成功',冻结开始时间:`${p} ${y}`,冻结结束时间:`${o}/${s}/${a} ${i}:${c}`},console.info(`[打断事件] 借口成功，疑心值冻结至 ${e.苏文状态[r].冻结结束时间}`)}else'失败'===Z.借口结果&&(e.苏文状态[o]+=10,console.info(`[打断事件] 借口失败，疑心值额外+10（总共+20），${t}必须离开主角房间`));h.苏文打断事件={待触发:!1,已通知AI:!1,打断原因:'',累计时间:0,等待借口:!1,借口结果:'待定'},console.info(`[打断事件] 借口结果处理完成: ${Z.借口结果}`)}return['对秦璐疑心值冻结','对苏梦疑心值冻结'].forEach(t=>{const n='对秦璐疑心值冻结'===t?'秦璐':'苏梦',o='对秦璐疑心值冻结'===t?'对秦璐疑心值':'对苏梦疑心值';if(e.苏文状态[t].是否冻结){const r=e.苏文状态[t].冻结结束时间;if(r&&r.includes(' ')){const[s,a]=r.split(' ');if(s&&a){const r=H(a,s);H(y,p)>=r&&(h.当前角色===n&&'主角房间'===h.当前所在位置&&(e.苏文状态[o]+=8),e.苏文状态[t].是否冻结=!1,e.苏文状态[t].借口内容='',e.苏文状态[t].冻结开始时间='',e.苏文状态[t].冻结结束时间='')}}}}),{oldTime:r,oldDate:o,newTime:y,newDate:p}}const j=['保守','正常','清凉','暴露','极度暴露'],F=['素颜','淡妆','日常妆','浓妆','艳妆'];function P(e){return j.indexOf(e)}function q(e){return F.indexOf(e)}const W=[{阶段:1,阶段标题:'抵抗',侵蚀度范围:[0,19],约束:{最低暴露程度:'保守',暴露程度范围:['保守','正常'],最低妆容浓度:'素颜',妆容浓度范围:['素颜','淡妆'],允许特殊装饰:!1,允许身体改造:!1},默认外观:{服装:{头部:'无',上装:'米色针织开衫',下装:'深灰色长裙',内衣上:'肤色棉质文胸',内衣下:'棉质内裤',袜裤:'肉色丝袜',鞋子:'室内拖鞋',外套:'无',配饰:'婚戒',特殊装饰:'无',整体风格:'居家贤妻',暴露程度:'正常',整洁度:'整洁'},妆容:{底妆:'素颜淡妆',眼妆:'无',唇妆:'淡粉色唇彩',腮红:'自然红晕',特殊妆容:'无',浓淡程度:'淡妆',整体风格:'清新自然'},气质描述:'温柔贤淑的家庭主妇'},时间修正系数:1.2},{阶段:2,阶段标题:'动摇',侵蚀度范围:[20,39],约束:{最低暴露程度:'正常',暴露程度范围:['正常','清凉'],最低妆容浓度:'淡妆',妆容浓度范围:['淡妆','日常妆'],允许特殊装饰:!1,允许身体改造:!1},默认外观:{服装:{头部:'略带妩媚的卷发',上装:'V领针织衫',下装:'过膝短裙',内衣上:'蕾丝半罩杯文胸',内衣下:'蕾丝三角裤',袜裤:'黑色丝袜',鞋子:'低跟鞋',外套:'无',配饰:'婚戒、简约项链',特殊装饰:'无',整体风格:'开始注重性感',暴露程度:'清凉',整洁度:'略显凌乱'},妆容:{底妆:'光泽粉底',眼妆:'大地色眼影、眼线',唇妆:'粉色唇彩',腮红:'自然桃红',特殊妆容:'无',浓淡程度:'日常妆',整体风格:'带有女人味'},气质描述:'成熟女性的妩媚'},时间修正系数:1},{阶段:3,阶段标题:'沉溺',侵蚀度范围:[40,59],约束:{最低暴露程度:'清凉',暴露程度范围:['清凉','暴露'],最低妆容浓度:'日常妆',妆容浓度范围:['日常妆','浓妆'],允许特殊装饰:!0,允许身体改造:!1},默认外观:{服装:{头部:'精心打理的波浪长发',上装:'半透明薄纱衬衫',下装:'包臀超短裙',内衣上:'镂空蕾丝情趣文胸',内衣下:'T字裤',袜裤:'网格吊带袜',鞋子:'细高跟鞋',外套:'无',配饰:'项圈式颈链、耳环',特殊装饰:'腰链',整体风格:'性感诱惑',暴露程度:'暴露',整洁度:'略显凌乱'},妆容:{底妆:'厚重粉底',眼妆:'烟熏眼妆、假睫毛',唇妆:'鲜红唇膏',腮红:'明显胭脂',特殊妆容:'无',浓淡程度:'浓妆',整体风格:'性感妖娆'},气质描述:'充满诱惑的妖艳女人'},时间修正系数:.8},{阶段:4,阶段标题:'疯狂',侵蚀度范围:[60,79],约束:{最低暴露程度:'暴露',暴露程度范围:['暴露','极度暴露'],最低妆容浓度:'浓妆',妆容浓度范围:['浓妆','艳妆'],允许特殊装饰:!0,允许身体改造:!0},默认外观:{服装:{头部:'凌乱湿润的长发',上装:'仅胸贴或透明乳套',下装:'几乎不存在的布条',内衣上:'无',内衣下:'无',袜裤:'破损网袜',鞋子:'恨天高或赤足',外套:'无',配饰:'项圈、手铐、脚链',特殊装饰:'身体彩绘、性暗示装饰、淫纹',整体风格:'彻底堕落',暴露程度:'极度暴露',整洁度:'凌乱'},妆容:{底妆:'厚重但已斑驳',眼妆:'浓妆晕染、假睫毛脱落',唇妆:'艳红唇膏外溢',腮红:'异常潮红',特殊妆容:'泪痕妆效',浓淡程度:'艳妆',整体风格:'淫荡堕落'},气质描述:'彻底沉沦的淫妇'},身体改造建议:{可能出现的纹身:['下腹淫纹','大腿内侧标记','后腰蝴蝶结','子宫纹身'],可能出现的穿刺:['乳头环','肚脐环','阴蒂环'],永久标记:['隐秘处的烙印','所有权标记']},时间修正系数:.6},{阶段:5,阶段标题:'圆满',侵蚀度范围:[80,999],约束:{最低暴露程度:'保守',暴露程度范围:['保守','正常'],最低妆容浓度:'素颜',妆容浓度范围:['素颜','淡妆'],允许特殊装饰:!0,允许身体改造:!0},默认外观:{服装:{头部:'完美打理的发型',上装:'端庄优雅的居家服',下装:'得体的裙装',内衣上:'高级定制情趣文胸（隐藏）',内衣下:'高级定制情趣内裤（隐藏）',袜裤:'优质丝袜',鞋子:'优雅舒适的鞋',外套:'得体外套',配饰:'婚戒、精致饰品',特殊装饰:'完全隐藏的身体改造',整体风格:'完美贤妻，内藏极致淫荡',暴露程度:'正常',整洁度:'整洁'},妆容:{底妆:'完美无瑕的自然底妆',眼妆:'温柔清新的眼妆',唇妆:'自然柔和的唇色',腮红:'健康自然的红晕',特殊妆容:'无（完美掩盖所有痕迹）',浓淡程度:'淡妆',整体风格:'自然清新'},气质描述:'外表贤良，内心极致淫荡'},身体改造建议:{可能出现的纹身:['全身隐秘淫纹网络','子宫完整淫阵','完整所有权纹章'],可能出现的穿刺:['所有常规穿刺','定制连接式穿刺'],永久标记:['完整奴隶刻印','永久所有权烙印','灵魂契约印记']},时间修正系数:.5}];function V(e){return W.find(t=>t.阶段===e)}function U(e){const t=V(e);return t?.阶段标题||'抵抗'}function J(e){const[t,n]=e.split(' '),[o,r,s]=t.split('/').map(Number),[a,i]=n.split(':').map(Number);return new Date(o,r-1,s,a,i)}function B(e){const t=e._推进前时间||`${e.世界.日期} ${e.世界.时间}`;console.info(`[念头成熟] 习惯形成时间: ${t}`);let n=0,o=0;const r=[];return['秦璐状态','苏梦状态'].forEach(s=>{const a=e[s];if(!a)return;const i=a.念头培育区,c=`${e.世界.日期} ${e.世界.时间}`,d='秦璐状态'===s?'秦璐':'苏梦';console.info(`[念头成熟] ${s} 当前时间: ${c}, 念头数: ${i.length}`);const l=[],u=[];i.forEach((e,t)=>{const n=function(e,t){const n=J(e.过期时间);return J(t)>=n}(e,c),o=!e.待判定&&e.需要时间>0&&e.开发进度>=e.需要时间;console.info(`[念头成熟] ${s} 念头[${t}]: "${e.念头内容}" 进度=${e.开发进度}/${e.需要时间} 待判定=${e.待判定} 过期=${n} 成熟=${o}`),n?u.push({thought:e,index:t,difficulty:e.难度等级}):o&&l.push({thought:e,index:t,difficulty:e.难度等级})}),l.length>0&&(console.info(`[念头成熟] ${s} 有 ${l.length} 个念头成熟!`),n+=l.length,l.forEach(e=>{const n=function(e,t){const n={道德底线变化:'困难'===e?-3:-2,对主角依存度变化:'困难'===e?4:3,潜意识侵蚀度变化:'困难'===e?6:5};let o=-2;return t>=80?o=-5:t>=60?o=-4:t>=30&&(o=-3),'困难'===e&&(o=Math.floor(1.2*o)),{...n,对苏文依存度变化:o}}(e.difficulty,a.对主角依存度);console.info(`[念头成熟] ${s} 处理成熟念头: "${e.thought.念头内容}"`);const o={内容:e.thought.念头内容,形成时间:t};if(a.习惯列表.push(o),a.习惯列表.length>16){const e=a.习惯列表.shift();console.info(`[念头成熟] ${s} 习惯数量超过上限(16)，最旧习惯淡化消失: "${e?.内容}"`)}console.info(`[念头成熟] ${s} 新增习惯, 当前习惯数: ${a.习惯列表.length}`);const i=a.道德底线,c=a.对主角依存度,l=a.对苏文依存度,u=a.潜意识侵蚀度;a.道德底线+=n.道德底线变化,a.对主角依存度+=n.对主角依存度变化,a.对苏文依存度+=n.对苏文依存度变化,a.潜意识侵蚀度+=n.潜意识侵蚀度变化,console.info(`[念头成熟] ${s} 数值变化: 道德${i}→${a.道德底线}, 主角依存${c}→${a.对主角依存度}, 苏文依存${l}→${a.对苏文依存度}, 侵蚀度${u}→${a.潜意识侵蚀度}`);const f=a.当前阶段,m=function(e){for(const t of W){const[n,o]=t.侵蚀度范围;if(e>=n&&e<=o)return t.阶段}return 5}(a.潜意识侵蚀度);m>f&&(a.当前阶段=m,a.阶段标题=U(m),console.info(`[念头成熟] ${s} 阶段提升: ${f}(${U(f)}) → ${m}(${U(m)})`),r.push({character:d,oldStage:f,newStage:m}))})),u.length>0&&(o+=u.length,u.forEach(e=>{if(console.info(`[念头成熟] ${s} 念头过期: "${e.thought.念头内容}"`),'困难'===e.difficulty){const e={道德底线变化:3,对主角依存度变化:-2};a.道德底线+=e.道德底线变化,a.对主角依存度+=e.对主角依存度变化,console.info(`[念头成熟] ${s} 困难念头惩罚已应用`)}}));const f=[...l,...u].sort((e,t)=>t.index-e.index);f.forEach(e=>{i.splice(e.index,1)}),f.length>0&&console.info(`[念头成熟] ${s} 删除了 ${f.length} 个念头`)}),console.info(`[念头成熟] 总计: 成熟=${n}, 过期=${o}`),{matureCount:n,expiredCount:o,stageChanges:r}}function Z(e){const t={qinluChanged:!1,sumengChanged:!1},n=e.苏文状态.对秦璐疑心值,o=e.苏文状态.对苏梦疑心值,r=function(e){const t=Math.floor(e/5),n=['我的贤内助','温柔体贴的老婆','还是老样子','她最近有点心不在焉','她行为有些反常','她心思不知在哪','她在隐瞒什么','她肯定有事瞒着我','她的举止让我不安','她在背着我做什么？','她行为很可疑','她一定有问题','她肯定背着我干了什么','她在骗我','她背叛了我的信任','她可能背叛了我','她肯定出轨了','这个不忠的女人','她彻底变了','她已经不是我认识的那个人了'];return n[Math.min(t,19)]||n[19]}(n),s=function(e){const t=Math.floor(e/5),n=['我的乖女儿','懂事的好孩子','还挺听话的','她最近有点心不在焉','她行为有些反常','她心思不知在哪','她在隐瞒什么','她肯定有事瞒着我','她的举止让我担心','她在背着我做什么？','她行为很可疑','她一定有问题','她肯定背着我干了什么','她在骗我','她背叛了我的信任','她是不是学坏了','她肯定学坏了','这孩子被带坏了','她彻底变了','她已经不是我认识的那个孩子了'];return n[Math.min(t,19)]||n[19]}(o);return e.苏文状态.对秦璐印象.基础印象!==r&&(t.qinluOldImpression=e.苏文状态.对秦璐印象.基础印象,t.qinluNewImpression=r,e.苏文状态.对秦璐印象.基础印象=r,t.qinluChanged=!0,console.info(`[印象更新] 秦璐基础印象: "${t.qinluOldImpression}" → "${r}"`)),e.苏文状态.对苏梦印象.基础印象!==s&&(t.sumengOldImpression=e.苏文状态.对苏梦印象.基础印象,t.sumengNewImpression=s,e.苏文状态.对苏梦印象.基础印象=s,t.sumengChanged=!0,console.info(`[印象更新] 苏梦基础印象: "${t.sumengOldImpression}" → "${s}"`)),t}let K=-1,Q=-1;function X(e,t,n){const o=V(t);if(!o)return console.warn(`[阶段外观更新] 未找到阶段 ${t} 的约束配置`),!1;const r=n[e],s='秦璐状态'===e?'秦璐':'苏梦';let a=!1;const i=r.服装细节.暴露程度,c=r.妆容细节.浓淡程度,d=P(i),l=q(c),u=P(o.约束.最低暴露程度),f=q(o.约束.最低妆容浓度);if(d<u&&(console.info(`[阶段外观更新] ${s} 阶段${t}(${o.阶段标题}) 暴露程度不足: ${i} < ${o.约束.最低暴露程度}，调整为默认外观`),r.服装细节.暴露程度=o.默认外观.服装.暴露程度,r.服装细节.上装=o.默认外观.服装.上装,r.服装细节.下装=o.默认外观.服装.下装,r.服装细节.整体风格=o.默认外观.服装.整体风格,a=!0),l<f&&(console.info(`[阶段外观更新] ${s} 阶段${t}(${o.阶段标题}) 妆容浓度不足: ${c} < ${o.约束.最低妆容浓度}，调整为默认妆容`),r.妆容细节.浓淡程度=o.默认外观.妆容.浓淡程度,r.妆容细节.底妆=o.默认外观.妆容.底妆,r.妆容细节.眼妆=o.默认外观.妆容.眼妆,r.妆容细节.唇妆=o.默认外观.妆容.唇妆,r.妆容细节.整体风格=o.默认外观.妆容.整体风格,a=!0),o.约束.允许特殊装饰||'无'===r.服装细节.特殊装饰||(console.info(`[阶段外观更新] ${s} 阶段${t}(${o.阶段标题}) 不允许特殊装饰，移除`),r.服装细节.特殊装饰='无',a=!0),!o.约束.允许身体改造){const e=r.身体改造;(!_.isEmpty(e.纹身)||e.穿刺.乳环||e.穿刺.乳头环||e.穿刺.阴蒂环||e.穿刺.舌环||e.穿刺.肚脐环||e.穿刺.阴唇环||e.永久标记.length>0)&&console.warn(`[阶段外观更新] ${s} 阶段${t}(${o.阶段标题}) 不允许身体改造，但检测到改造项，保留但记录警告`)}return a&&console.info(`[阶段外观更新] ${s} 阶段${t}(${o.阶段标题}) 外观已调整:\n  暴露程度: ${r.服装细节.暴露程度} (最低要求: ${o.约束.最低暴露程度})\n  妆容浓度: ${r.妆容细节.浓淡程度} (最低要求: ${o.约束.最低妆容浓度})\n  气质: ${r.气质描述}`),a}const ee=[{type:'禁忌话题讨论',keywords:['讨论','聊天','话题','性话题','成人话题','禁忌','色情','H','黄色','下流'],parentCategory:'陪伴交流',recommendedStage:{min:1,max:1}},{type:'观念开放',keywords:['观念','想法','认知','不介意','无所谓','接受这种','理解这种'],parentCategory:'情感依赖',recommendedStage:{min:1,max:2}},{type:'道德模糊',keywords:['对错','道德','伦理','底线','原则','边界','禁忌','不该','不应该'],parentCategory:'暧昧互动',recommendedStage:{min:2,max:3}},{type:'快感优先',keywords:['快感','舒服','享受','愉悦','感觉好','欲望','爽','高潮','潮吹','绝顶'],parentCategory:'亲密接触',recommendedStage:{min:2,max:3}},{type:'羞耻淡化',keywords:['羞耻','害羞','尴尬','不好意思','难为情','丢人','羞愧','面子'],parentCategory:'暧昧互动',recommendedStage:{min:2,max:3}},{type:'主动索取',keywords:['索取','渴望','讨要','乞求','求你','求我','主动要','主动求'],parentCategory:'身份认同',recommendedStage:{min:3,max:4}},{type:'自我认同',keywords:['认同','接受自己','承认自己','淫妇','骚货','婊子','荡妇','肉便器','母狗','贱人'],parentCategory:'绝对服从',recommendedStage:{min:4,max:5}},{type:'身体接触',keywords:['触碰','摸','抱','亲','接触','肌肤','牵手','拥抱','亲吻','接吻'],parentCategory:'肢体亲近',recommendedStage:{min:1,max:1}},{type:'敏感部位触碰',keywords:['胸','乳房','下体','私处','敏感','部位','乳头','阴','奶','臀','屁股','大腿','腰'],parentCategory:'亲密接触',recommendedStage:{min:2,max:3}},{type:'裸露展示',keywords:['裸','脱','露出','展示身体','看身体','光着','赤裸','一丝不挂'],parentCategory:'身体开放',recommendedStage:{min:2,max:3}},{type:'口交服务',keywords:['口交','吹箫','含住','深喉','口爆','舔棒','嘴巴服务','用嘴','含进去'],parentCategory:'性行为',recommendedStage:{min:2,max:3}},{type:'舔舐服务',keywords:['舔弄','吮吸','舔干净','舔脚','舔鞋','舔脚趾','舔身体','舔下面'],parentCategory:'性行为',recommendedStage:{min:2,max:3}},{type:'精液处理',keywords:['精液','精子','吞精','颜射','内射','射在','射进','射满','白浊','射出来'],parentCategory:'性行为',recommendedStage:{min:2,max:4}},{type:'性行为接受',keywords:['做爱','性行为','插入','交合','肏','操我','干我','屄','逼','小穴','肉穴','被上','被操','被艹','挺入','顶入','捅进','被捅'],parentCategory:'性行为',recommendedStage:{min:2,max:3}},{type:'体位姿势',keywords:['骑乘','后入','正常位','传教士','侧入','站立','跪趴','抬腿','69','体位'],parentCategory:'性行为',recommendedStage:{min:2,max:3}},{type:'特殊性行为',keywords:['乳交','足交','腿交','腋交','手交','打飞机','撸管','素股','磨蹭','臀交','夹住肉棒'],parentCategory:'性行为',recommendedStage:{min:2,max:4}},{type:'后庭开发',keywords:['后庭','肛门','后穴','菊花','后面','肛交','爆菊','菊穴','后入口'],parentCategory:'性行为',recommendedStage:{min:2,max:4}},{type:'多人行为',keywords:['3P','群交','轮流上','双插','前后夹击','多根','多人轮','被轮'],parentCategory:'绝对服从',recommendedStage:{min:4,max:5}},{type:'自慰行为',keywords:['自慰','手淫','自己弄','自己摸','自摸','玩弄自己','指奸','玩穴'],parentCategory:'性行为',recommendedStage:{min:2,max:3}},{type:'道具使用',keywords:['道具','玩具','跳蛋','按摩棒','假阳具','振动','电动','插入道具'],parentCategory:'性行为',recommendedStage:{min:2,max:3}},{type:'身体改造',keywords:['纹身','乳环','穿刺','改造','标记','印记','烙印','刺青'],parentCategory:'绝对服从',recommendedStage:{min:3,max:4}},{type:'特殊装饰',keywords:['项圈','锁链','手铐','脚镣','皮带','口枷','口球','眼罩','绳子'],parentCategory:'绝对服从',recommendedStage:{min:3,max:4}},{type:'轻度束缚',keywords:['绑','束缚','捆绑','固定','绑住','铐住','缚'],parentCategory:'绝对服从',recommendedStage:{min:2,max:3}},{type:'调教训练',keywords:['调教','训练','教导','驯服','驯化','管教','规训'],parentCategory:'绝对服从',recommendedStage:{min:3,max:5}},{type:'惩罚责罚',keywords:['惩罚','打屁股','掌掴','鞭打','抽打','责罚','SP','体罚','打我','抽我'],parentCategory:'绝对服从',recommendedStage:{min:3,max:4}},{type:'言语羞辱',keywords:['羞辱','辱骂','骂','贱','下贱','脏话','侮辱','嘲笑','羞辱性称呼'],parentCategory:'绝对服从',recommendedStage:{min:3,max:4}},{type:'极端玩法',keywords:['虐待','极端','疼痛','窒息','憋气','夹子','蜡烛','滴蜡','冰块'],parentCategory:'绝对服从',recommendedStage:{min:4,max:5}},{type:'支配服从',keywords:['服从','听话','命令','指令','乖乖','顺从','主人','奴隶','宠物','狗'],parentCategory:'绝对服从',recommendedStage:{min:3,max:5}},{type:'着装改变',keywords:['衣服','内衣','暴露','穿着','服装','打扮','裙子','丝袜','高跟'],parentCategory:'身体开放',recommendedStage:{min:1,max:2}},{type:'情趣服饰',keywords:['情趣','制服','女仆装','护士装','学生装','cosplay','兔女郎','空姐','旗袍'],parentCategory:'身体开放',recommendedStage:{min:2,max:3}},{type:'妆容调整',keywords:['化妆','妆容','口红','眼妆','打扮','浓妆','艳妆','妖艳'],parentCategory:'身体开放',recommendedStage:{min:1,max:2}},{type:'说谎隐瞒',keywords:['说谎','隐瞒','欺骗','借口','谎言','瞒着','偷偷','秘密'],parentCategory:'身份认同',recommendedStage:{min:2,max:3}},{type:'主动诱惑',keywords:['诱惑','勾引','挑逗','撩拨','色诱','媚眼','风骚','发骚'],parentCategory:'暧昧互动',recommendedStage:{min:2,max:3}},{type:'公开场合',keywords:['外面','公共','户外','当着','公开','场合','野外','露出','暴露狂'],parentCategory:'家庭替代',recommendedStage:{min:3,max:4}},{type:'背叛丈夫',keywords:['背叛','出轨','偷情','绿帽','红杏','对不起苏文','背着苏文','瞒着老公'],parentCategory:'家庭替代',recommendedStage:{min:2,max:4}},{type:'拍摄记录',keywords:['拍照','录像','摄影','拍下','记录','留念','视频','照片','私密照'],parentCategory:'家庭替代',recommendedStage:{min:3,max:4}},{type:'角色扮演',keywords:['扮演','假装','当作','叫妈妈','叫姐姐','叫老婆','叫主人','角色扮演'],parentCategory:'身份认同',recommendedStage:{min:2,max:3}},{type:'禁忌关系认同',keywords:['母子','姐弟','乱伦','禁忌关系','不伦','血缘','家人','亲人'],parentCategory:'身份认同',recommendedStage:{min:3,max:5}},{type:'怀孕相关',keywords:['怀孕','受孕','播种','种子','孩子','生育','中出','怀上','孕'],parentCategory:'家庭替代',recommendedStage:{min:4,max:5}},{type:'体液相关',keywords:['尿','排泄','圣水','黄金','口水','唾液','汗','体液'],parentCategory:'绝对服从',recommendedStage:{min:4,max:5}}],te=((()=>{const e={陪伴交流:['聊天','陪伴','说话','倾诉','交流','沟通','分享心事'],情感依赖:['想念','在意','喜欢你','依赖你','信任你','关心你','牵挂','惦记'],肢体亲近:['牵手','拥抱','依偎','挽着','搂着','握手','靠在'],暧昧互动:['撒娇','亲昵','暧昧','调情','甜蜜','心跳加速','脸红'],亲密接触:['亲吻','接吻','抚摸身体'],身体开放:['暴露身体','展示身体','袒露'],性行为:['做爱','性行为','插入','高潮','交合'],身份认同:['属于你','归属','你的人','你的女人'],绝对服从:['服从命令','跪下','主人','奴隶','融合','即存在','即是','全是','一切都是','世界是','存在即','空间与时间','我是你','你是我','合为一体','思想属于','心属于','完全属于','彻底属于','信仰','崇拜','神明','膜拜','供奉','朝拜','救世主'],家庭替代:['取代','赶走','离婚','抛弃','不要苏文','真正的丈夫','苏文滚']};for(const t of ee){const n=t.parentCategory;for(const o of t.keywords)e[n].includes(o)||e[n].push(o)}})(),{1:{allowed:['陪伴交流','情感依赖']},2:{allowed:['陪伴交流','情感依赖','肢体亲近','暧昧互动'],extra:{肢体亲近:{依存度:30},暧昧互动:{依存度:40}}},3:{allowed:['陪伴交流','情感依赖','肢体亲近','暧昧互动','亲密接触','身体开放'],extra:{亲密接触:{依存度:50,道德底线:70},身体开放:{依存度:55,道德底线:60}}},4:{allowed:['陪伴交流','情感依赖','肢体亲近','暧昧互动','亲密接触','身体开放','性行为','身份认同'],extra:{性行为:{依存度:65,道德底线:50},身份认同:{依存度:70,道德底线:40}}},5:{allowed:'all',extra:{绝对服从:{依存度:80,道德底线:30},家庭替代:{依存度:85,道德底线:20}}}});function ne(e){switch(e){case 1:return 4;case 2:case 3:return 3;default:return 2}}function oe(e){return e<=3?'简单':e<=4?'中等':'困难'}function re(e,t,n,o,r=!1){const s='boolean'==typeof r?{isSleepingPillActive:r}:r,{isSleepingPillActive:a=!1,isHospitalized:i=!1}=s;if(i){return{category:e,allowed:!0,hours:2,willExpire:!1,matchMethod:'本地匹配'}}const c=a?Math.min(t+1,5):t,d=te[c]||te[5];if('all'!==d.allowed&&!d.allowed.includes(e))return{category:e,allowed:!1,hours:26,willExpire:!0,reason:`阶段${t}无法接受「${e}」类型的念头`,matchMethod:'本地匹配'};const l=d.extra?.[e];if(l){const t=a?Math.max(0,(l.依存度||0)-10):l.依存度,r=a?Math.min(100,(l.道德底线||100)+10):l.道德底线;if(void 0!==t&&n<t)return{category:e,allowed:!1,hours:26,willExpire:!0,reason:`「${e}」需要依存度≥${t}，当前${n}`,matchMethod:'本地匹配'};if(void 0!==r&&o>r)return{category:e,allowed:!1,hours:26,willExpire:!0,reason:`「${e}」需要道德底线≤${r}，当前${o}`,matchMethod:'本地匹配'}}return{category:e,allowed:!0,hours:ne(t),willExpire:!1,matchMethod:'本地匹配'}}function se(e){const t=['陪伴交流','情感依赖','肢体亲近','暧昧互动','亲密接触','身体开放','性行为','身份认同','绝对服从','家庭替代'],n=e.trim();if(t.includes(n))return n;for(const e of t)if(n.includes(e))return e;return null}function ae(e,t){const n=function(e){const t=[],n=/【念头判定】(秦璐|苏梦):(.+?)=([^\n\r]+)/g;let o;for(;null!==(o=n.exec(e));){const[,e,n,r]=o,s=se(r.trim());s?(t.push({角色:e,念头内容:n.trim(),类型:s}),console.info(`[念头判定解析] 解析成功: ${e}:${n.trim()}=${s}`)):console.warn(`[念头判定解析] 类型解析失败: ${r.trim()}`)}return t}(t);if(0===n.length)return;console.info(`[念头判定] 解析到 ${n.length} 条判定结果`);const o=L(e);o&&console.info('[念头判定] 安眠药生效中，临时解锁下一阶段念头');const r=O(e);r&&console.info('[念头判定] 住院模式生效中，所有念头固定为简单难度');for(const t of n){const n='秦璐'===t.角色?e.秦璐状态:e.苏梦状态,s=n.念头培育区,a=s.findIndex(e=>e.待判定&&e.念头内容===t.念头内容);if(-1===a){const e=s.findIndex(e=>e.待判定&&e.念头内容.includes(t.念头内容));if(-1===e){console.warn(`[念头判定] 未找到匹配的待判定念头: ${t.角色}:${t.念头内容}`);continue}ie(n,e,t.类型,o,r)}else ie(n,a,t.类型,o,r)}}function ie(e,t,n,o=!1,r=!1){const s=e.念头培育区[t];if(r)return s.需要时间=2,s.难度等级='简单',s.待判定=!1,void console.info(`[念头判定] 🏥 住院模式: "${s.念头内容}" => 固定简单难度, 2小时`);const a=re(n,e.当前阶段,e.对主角依存度,e.道德底线,o);a.allowed?(s.需要时间=a.hours,s.难度等级=oe(a.hours),s.待判定=!1,console.info(`[念头判定] ✅ 念头已更新: "${s.念头内容}" => 类型=${n}, 难度=${s.难度等级}, 时间=${s.需要时间}h`)):(s.需要时间=26,s.难度等级='困难',s.待判定=!1,console.info(`[念头判定] ⚠️ 念头被拒绝: "${s.念头内容}" => ${a.reason}，设置为过期`))}$(async()=>{await waitGlobalInitialized('Mvu');let e=!1;const t=new Set;async function n(n,o){try{const a=function(e){try{const t=SillyTavern.chat;if(t&&t[e])return t[e].swipe_id??0}catch(e){console.warn('[游戏逻辑] 获取 swipe_id 失败:',e)}return 0}(n),i=`${n}:${a}`;if(console.info(`[游戏逻辑] processGameLogic 进入: message_id=${n}, swipe_id=${a}, eventType=${o}`),'MESSAGE_RECEIVED'===o&&e)return e=!1,void console.info(`[游戏逻辑] 跳过初始化后的第一条消息: ${n}`);if('MESSAGE_SWIPED'===o){const e=Array.from(t).filter(e=>e.startsWith(`${n}:`));e.forEach(e=>t.delete(e)),console.info(`[游戏逻辑] ROLL 操作，清除 ${e.length} 条旧记录: ${e.join(', ')}`)}else if(t.has(i))return void console.info(`[游戏逻辑] 跳过已处理的消息: ${i} (事件类型: ${o})`);if(t.add(i),console.info(`[游戏逻辑] 消息 ${i} 开始处理`),t.size>100){Array.from(t).slice(0,t.size-100).forEach(e=>t.delete(e))}const c=getLastMessageId();console.info(`[游戏逻辑] 开始处理 ${o} 事件，消息 ID: ${n}，实际最新楼层: ${c}`);const d=c;d!==n&&console.warn(`[游戏逻辑] ⚠️ 传入ID(${n})与最新楼层(${d})不一致，使用最新楼层`);const l=Mvu.getMvuData({type:'message',message_id:d}),u=_.get(l,'stat_data');if(!u)return void console.warn('[游戏逻辑] stat_data 不存在');const f=D.parse(u);r=f.秦璐状态.当前阶段,s=f.苏梦状态.当前阶段,-1===K&&(K=r),-1===Q&&(Q=s),console.info(`[游戏逻辑] 阶段追踪已初始化: 秦璐=${f.秦璐状态.当前阶段}, 苏梦=${f.苏梦状态.当前阶段}`);let m='',g='';try{const e=getChatMessages(-1),t=getChatMessages(-2),n=e.length>0?e[0]:null,o=t.length>0?t[0]:null;m=o&&'user'===o.role?o.message??'':'',g=n&&'assistant'===n.role?n.message??'':''}catch(e){console.warn('[游戏逻辑] 获取消息失败:',e)}const y=G(f,m,g);if(!y)return void console.error('[游戏逻辑] 时间推进失败');g&&ae(f,g),function(e){const t=`${e.世界.日期} ${e.世界.时间}`,n=O(e);['秦璐状态','苏梦状态'].forEach(o=>{const r=e[o];if(!r)return;const s='秦璐状态'===o?'秦璐':'苏梦';r.念头培育区.forEach((e,o)=>{if(e.待判定)try{const[o,a]=e.植入时间.split(' '),[i,c,d]=o.split('/').map(Number),[l,u]=a.split(':').map(Number),f=new Date(i,c-1,d,l,u),[m,g]=t.split(' '),[y,p,b]=m.split('/').map(Number),[h,E]=g.split(':').map(Number);if(new Date(y,p-1,b,h,E).getTime()-f.getTime()>=72e5)if(n)e.需要时间=2,e.难度等级='简单',e.待判定=!1,console.info(`[念头判定超时] 🏥 住院模式: ${s} 念头"${e.念头内容}"超时未判定，固定为简单难度，2小时`);else{const t='陪伴交流',n=ne(r.当前阶段);e.需要时间=n,e.难度等级=oe(n),e.待判定=!1,console.info(`[念头判定超时] ${s} 念头"${e.念头内容}"超时未被AI判定，自动设为"${t}"类型，难度=${e.难度等级}，时间=${n}h`)}}catch(e){console.warn('[念头判定超时] 解析时间失败:',e)}})})}(f),B(f),Z(f),function(e){const t={qinluUpdated:!1,sumengUpdated:!1,qinluStageChanged:!1,sumengStageChanged:!1},n=e.系统追踪,o=e.秦璐状态.当前阶段;-1===K&&(K=o,console.info(`[阶段外观更新] 初始化秦璐阶段记录: 阶段${o}(${U(o)})`));const r=o!==K;if(console.info(`[阶段外观调试] 秦璐: 当前阶段=${o}, 上次记录=${K}, 是否新阶段=${r}`),r&&o>=1&&o<=5){if(console.info(`[阶段外观更新] ✅ 秦璐阶段变化: ${K}(${U(K)}) → ${o}(${U(o)})`),t.qinluStageChanged=!0,n.秦璐外观待更新={需要更新:!0,目标阶段:o,变化原因:`阶段提升: ${U(K)} → ${U(o)}`},console.info('[阶段外观调试] 秦璐外观待更新已设置:',JSON.stringify(n.秦璐外观待更新)),o>1){const t=`${e.世界.日期} ${e.世界.时间}`,r=getLastMessageId();n.强制事件日志=n.强制事件日志||[],n.强制事件日志.push({事件类型:'阶段突破',角色:'秦璐',触发楼层:r,触发时间:t,已通知AI:!1,阶段号:o}),console.info(`[阶段外观更新] 已写入秦璐阶段突破日志: 阶段${o}, 楼层${r}`)}K=o,X('秦璐状态',o,e)?(console.info('[阶段外观调试] ⚠️ 秦璐外观约束调整，清除待更新标记'),n.秦璐外观待更新.需要更新=!1,n.秦璐外观待更新.变化原因='约束检查后自动调整',t.qinluUpdated=!0):console.info('[阶段外观调试] 秦璐外观约束满足，待更新标记保留为 true')}else o>=1&&o<=5&&(console.info(`[阶段外观调试] 秦璐非新阶段，检查待更新标记: ${n.秦璐外观待更新?.需要更新}`),n.秦璐外观待更新?.需要更新)&&X('秦璐状态',o,e)&&(t.qinluUpdated=!0);const s=e.苏梦状态.当前阶段;-1===Q&&(Q=s,console.info(`[阶段外观更新] 初始化苏梦阶段记录: 阶段${s}(${U(s)})`));const a=s!==Q;if(console.info(`[阶段外观调试] 苏梦: 当前阶段=${s}, 上次记录=${Q}, 是否新阶段=${a}`),a&&s>=1&&s<=5){if(console.info(`[阶段外观更新] ✅ 苏梦阶段变化: ${Q}(${U(Q)}) → ${s}(${U(s)})`),t.sumengStageChanged=!0,n.苏梦外观待更新={需要更新:!0,目标阶段:s,变化原因:`阶段提升: ${U(Q)} → ${U(s)}`},console.info('[阶段外观调试] 苏梦外观待更新已设置:',JSON.stringify(n.苏梦外观待更新)),s>1){const t=`${e.世界.日期} ${e.世界.时间}`,o=getLastMessageId();n.强制事件日志=n.强制事件日志||[],n.强制事件日志.push({事件类型:'阶段突破',角色:'苏梦',触发楼层:o,触发时间:t,已通知AI:!1,阶段号:s}),console.info(`[阶段外观更新] 已写入苏梦阶段突破日志: 阶段${s}, 楼层${o}`)}Q=s,X('苏梦状态',s,e)?(console.info('[阶段外观调试] ⚠️ 苏梦外观约束调整，清除待更新标记'),n.苏梦外观待更新.需要更新=!1,n.苏梦外观待更新.变化原因='约束检查后自动调整',t.sumengUpdated=!0):console.info('[阶段外观调试] 苏梦外观约束满足，待更新标记保留为 true')}else s>=1&&s<=5&&(console.info(`[阶段外观调试] 苏梦非新阶段，检查待更新标记: ${n.苏梦外观待更新?.需要更新}`),n.苏梦外观待更新?.需要更新)&&X('苏梦状态',s,e)&&(t.sumengUpdated=!0);console.info('[阶段外观调试] 检查完成，结果:',JSON.stringify(t))}(f),function(e,t){const n=e.系统追踪.念头植入日志.length;console.info(`[念头植入清理] 当前楼层: ${t}, 清理前日志数: ${n}`),e.系统追踪.念头植入日志=e.系统追踪.念头植入日志.filter(e=>{if(!e.已通知AI)return console.info(`[念头植入清理] 保留未通知日志: 楼层${e.植入楼层} - ${e.内容}`),!0;if(e.植入楼层<0)return console.info(`[念头植入清理] 删除无效楼层日志(楼层${e.植入楼层}): ${e.内容}`),!1;const n=t-e.植入楼层,o=n<=3;return o?console.info(`[念头植入清理] 保留已通知日志(${n}楼内): 楼层${e.植入楼层} - ${e.内容}`):console.info(`[念头植入清理] 删除已通知日志(${n}楼外): 楼层${e.植入楼层} - ${e.内容}`),o});const o=e.系统追踪.念头植入日志.length,r=n-o;r>0?console.info(`[念头植入清理] ✅ 清理了 ${r} 条旧日志（剩余 ${o} 条）`):console.info('[念头植入清理] ✅ 无需清理，所有日志均在3楼内')}(f,d),function(e,t){if(!e.系统追踪.强制事件日志)return e.系统追踪.强制事件日志=[],{beforeCount:0,afterCount:0,cleanedCount:0};const n=e.系统追踪.强制事件日志.length;console.info(`[强制事件清理] 当前楼层: ${t}, 清理前日志数: ${n}`),e.系统追踪.强制事件日志=e.系统追踪.强制事件日志.filter(e=>{if(!e.已通知AI)return console.info(`[强制事件清理] 保留未通知日志: ${e.事件类型} - ${e.角色} - 楼层${e.触发楼层}`),!0;if(e.触发楼层<0)return console.info(`[强制事件清理] 删除无效楼层日志(楼层${e.触发楼层}): ${e.事件类型}`),!1;const n=t-e.触发楼层,o=n<=3;return o?console.info(`[强制事件清理] 保留已通知日志(${n}楼内): ${e.事件类型} - ${e.角色} - 楼层${e.触发楼层}`):console.info(`[强制事件清理] 删除已通知日志(${n}楼外): ${e.事件类型} - ${e.角色} - 楼层${e.触发楼层}`),o});const o=e.系统追踪.强制事件日志.length,r=n-o;r>0?console.info(`[强制事件清理] ✅ 清理了 ${r} 条旧日志（剩余 ${o} 条）`):console.info('[强制事件清理] ✅ 无需清理，所有日志均在3楼内')}(f,d);const p=D.parse(f);_.set(l,'stat_data',p),await Mvu.replaceMvuData(l,{type:'message',message_id:d}),console.info(`[游戏逻辑] 数据已写入楼层 ${d}，时间: ${p.世界?.日期} ${p.世界?.时间}`);const b=Mvu.getMvuData({type:'message',message_id:d}),h=_.get(b,'stat_data');h?.世界?.时间!==y.newTime||h?.世界?.日期!==y.newDate?(console.error('[游戏逻辑] 时间写入不一致'),console.error(`期望: ${y.newDate} ${y.newTime}`),console.error(`实际: ${h?.世界?.日期} ${h?.世界?.时间}`)):console.info(`[游戏逻辑] ✅ ${o} 处理完成，时间: ${y.newDate} ${y.newTime}`)}catch(e){console.error('[游戏逻辑] 执行错误:',e)}var r,s}eventOn(Mvu.events.VARIABLE_INITIALIZED,()=>{e=!0}),eventOn(tavern_events.MESSAGE_RECEIVED,e=>{const t=Number(e);console.info(`[游戏逻辑] 收到 MESSAGE_RECEIVED 事件，message_id=${t}`),setTimeout(()=>{n(t,'MESSAGE_RECEIVED')},300)}),eventOn(tavern_events.MESSAGE_SWIPED,e=>{const t=Number(e);console.info(`[游戏逻辑] 收到 MESSAGE_SWIPED 事件，message_id=${t}`),setTimeout(()=>{n(t,'MESSAGE_SWIPED')},300),setTimeout(()=>{console.info('[游戏逻辑] 广播 IFRAME_DATA_REFRESH 事件 (MESSAGE_SWIPED)'),eventEmit('IFRAME_DATA_REFRESH',{reason:'MESSAGE_SWIPED',message_id:t})},500)}),eventOn(tavern_events.MESSAGE_DELETED,e=>{const n=Number(e);console.info(`[游戏逻辑] 收到 MESSAGE_DELETED 事件，message_id=${n}`);const o=Array.from(t).filter(e=>parseInt(e.split(':')[0],10)>=n);o.length>0&&(o.forEach(e=>t.delete(e)),console.info(`[游戏逻辑] MESSAGE_DELETED 清除 ${o.length} 条处理记录: ${o.join(', ')}`)),setTimeout(()=>{console.info('[游戏逻辑] 广播 IFRAME_DATA_REFRESH 事件 (MESSAGE_DELETED)'),eventEmit('IFRAME_DATA_REFRESH',{reason:'MESSAGE_DELETED',message_id:n})},300)}),eventOn(tavern_events.GENERATION_ENDED,e=>{console.info(`[游戏逻辑] 收到 GENERATION_ENDED 事件，原始 message_id=${e}`),setTimeout(()=>{try{const e=getLastMessageId();console.info(`[游戏逻辑] GENERATION_ENDED 使用实际 message_id=${e}`),n(e,'GENERATION_ENDED')}catch(t){console.warn('[游戏逻辑] GENERATION_ENDED 获取最新消息失败，尝试使用原始 ID:',t),n(Number(e),'GENERATION_ENDED')}},300),setTimeout(()=>{try{const e=getLastMessageId();console.info('[游戏逻辑] 广播 IFRAME_DATA_REFRESH 事件 (GENERATION_ENDED)'),eventEmit('IFRAME_DATA_REFRESH',{reason:'GENERATION_ENDED',message_id:e})}catch(e){console.warn('[游戏逻辑] GENERATION_ENDED 广播刷新事件失败:',e)}},800)}),console.info('[游戏逻辑脚本] 加载完成，已注册 MESSAGE_RECEIVED, MESSAGE_SWIPED 和 GENERATION_ENDED 监听')});
//# sourceMappingURL=index.js.map