{"version":3,"file":"index.js","mappings":"AAwCO,MAoFMA,EAA8B,CAKzC,CACE,GAAI,EACJ,KAAM,KACN,MAAO,CAAC,EAAG,IACX,GAAI,CACF,OAAQ,KACR,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,OAAQ,CAAC,KAAM,MACf,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,GAAI,CACF,GAAI,IACJ,GAAI,SACJ,GAAI,QACJ,IAAK,SACL,IAAK,OACL,GAAI,OACJ,GAAI,OACJ,GAAI,IACJ,GAAI,KACJ,KAAM,IACN,KAAM,OACN,KAAM,KACN,IAAK,MAEP,GAAI,CACF,GAAI,OACJ,GAAI,IACJ,GAAI,QACJ,GAAI,OACJ,KAAM,IACN,KAAM,KACN,KAAM,QAER,KAAM,aAER,OAAQ,KAMV,CACE,GAAI,EACJ,KAAM,KACN,MAAO,CAAC,GAAI,IACZ,GAAI,CACF,OAAQ,KACR,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,OAAQ,CAAC,KAAM,OACf,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,GAAI,CACF,GAAI,UACJ,GAAI,QACJ,GAAI,OACJ,IAAK,UACL,IAAK,QACL,GAAI,OACJ,GAAI,MACJ,GAAI,IACJ,GAAI,UACJ,KAAM,IACN,KAAM,SACN,KAAM,KACN,IAAK,QAEP,GAAI,CACF,GAAI,OACJ,GAAI,WACJ,GAAI,OACJ,GAAI,OACJ,KAAM,IACN,KAAM,MACN,KAAM,SAER,KAAM,WAER,OAAQ,GAMV,CACE,GAAI,EACJ,KAAM,KACN,MAAO,CAAC,GAAI,IACZ,GAAI,CACF,OAAQ,KACR,OAAQ,CAAC,KAAM,MACf,OAAQ,MACR,OAAQ,CAAC,MAAO,MAChB,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,GAAI,CACF,GAAI,YACJ,GAAI,UACJ,GAAI,QACJ,IAAK,WACL,IAAK,MACL,GAAI,QACJ,GAAI,OACJ,GAAI,IACJ,GAAI,WACJ,KAAM,KACN,KAAM,OACN,KAAM,KACN,IAAK,QAEP,GAAI,CACF,GAAI,OACJ,GAAI,WACJ,GAAI,OACJ,GAAI,OACJ,KAAM,IACN,KAAM,KACN,KAAM,QAER,KAAM,aAER,OAAQ,IAMV,CACE,GAAI,EACJ,KAAM,KACN,MAAO,CAAC,GAAI,IACZ,GAAI,CACF,OAAQ,KACR,OAAQ,CAAC,KAAM,QACf,OAAQ,KACR,OAAQ,CAAC,KAAM,MACf,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,GAAI,CACF,GAAI,UACJ,GAAI,WACJ,GAAI,WACJ,IAAK,IACL,IAAK,IACL,GAAI,OACJ,GAAI,SACJ,GAAI,IACJ,GAAI,WACJ,KAAM,gBACN,KAAM,OACN,KAAM,OACN,IAAK,MAEP,GAAI,CACF,GAAI,SACJ,GAAI,aACJ,GAAI,SACJ,GAAI,OACJ,KAAM,OACN,KAAM,KACN,KAAM,QAER,KAAM,WAER,OAAQ,CACN,QAAS,CAAC,OAAQ,SAAU,QAAS,QACrC,QAAS,CAAC,MAAO,MAAO,OACxB,KAAM,CAAC,SAAU,UAEnB,OAAQ,IAOV,CACE,GAAI,EACJ,KAAM,KACN,MAAO,CAAC,GAAI,KACZ,GAAI,CACF,OAAQ,KACR,OAAQ,CAAC,KAAM,MACf,OAAQ,KACR,OAAQ,CAAC,KAAM,MACf,QAAQ,EACR,QAAQ,GAEV,KAAM,CACJ,GAAI,CACF,GAAI,UACJ,GAAI,WACJ,GAAI,QACJ,IAAK,eACL,IAAK,eACL,GAAI,OACJ,GAAI,SACJ,GAAI,OACJ,GAAI,UACJ,KAAM,YACN,KAAM,cACN,KAAM,KACN,IAAK,MAEP,GAAI,CACF,GAAI,YACJ,GAAI,UACJ,GAAI,UACJ,GAAI,UACJ,KAAM,cACN,KAAM,KACN,KAAM,QAER,KAAM,eAER,OAAQ,CACN,QAAS,CAAC,WAAY,SAAU,WAChC,QAAS,CAAC,SAAU,WACpB,KAAM,CAAC,SAAU,UAAW,WAE9B,OAAQ,KAQCC,EAAyC,CAIpD,CACE,GAAI,EACJ,KAAM,CACJ,GAAI,OACJ,GAAI,oBACJ,KAAM,4LAUR,KAAM,CACJ,GAAI,OACJ,GAAI,oBACJ,KAAM,yLAeV,CACE,GAAI,EACJ,KAAM,CACJ,GAAI,OACJ,GAAI,qBACJ,KAAM,4PAYR,KAAM,CACJ,GAAI,OACJ,GAAI,iBACJ,KAAM,4OAiBV,CACE,GAAI,EACJ,KAAM,CACJ,GAAI,OACJ,GAAI,kBACJ,KAAM,uRAYR,KAAM,CACJ,GAAI,OACJ,GAAI,iBACJ,KAAM,yRAiBV,CACE,GAAI,EACJ,KAAM,CACJ,GAAI,OACJ,GAAI,oBACJ,KAAM,uQAYR,KAAM,CACJ,GAAI,OACJ,GAAI,kBACJ,KAAM,kPAiBV,CACE,GAAI,EACJ,KAAM,CACJ,GAAI,OACJ,GAAI,+BACJ,KAAM,0TAcR,KAAM,CACJ,GAAI,OACJ,GAAI,2BACJ,KAAM,oTAwBL,SAASC,EAAeC,GAC7B,OAAOH,EAAaI,KAAKC,GAAUA,EAAO,KAAOF,EACnD,CAkBO,SAASG,EAAcH,GAC5B,MAAME,EAASH,EAAeC,GAC9B,OAAOE,GAAQ,MAAQ,IACzB,CAoBO,SAASE,EACdC,EACAC,GAEA,MAAMC,GAXsBP,EAWMM,EAV3BR,EAAmBG,KAAKC,GAAUA,EAAO,KAAOF,IADlD,IAAuBA,EAY5B,IAAKO,EAAa,MAAO,GAEzB,MAAMC,EAAsB,OAAdH,EAAqBE,EAAY,KAAOA,EAAY,KAElE,MAAO,6FAIFF,YAAoBC,OAAcH,EAAcG,oGAKnDD,uCAEAA,gHAIFG,EAAM,wEAGNA,EAAM,sBAGHH,0CACSA,wEAENA,kCACKF,EAAcG,iDAIvBD,4BACSA,gGAKJA,mBAEJA,gFAGL,CAKO,SAASI,EACdJ,EACAC,GAEA,MAAO,SAASH,EAAcG,WAE7BD,yBAGH,CCnlBO,MAAMK,EAA+C,CAE1D,CACEC,KAAM,SACNC,SAAU,CAAC,KAAM,KAAM,KAAM,MAAO,OAAQ,KAAM,KAAM,IAAK,KAAM,MACnEC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,MAAO,MAAO,OAAQ,QACnDC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,OAC3DC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,MAAO,KAAM,IAAK,KAAM,KAAM,MACjEC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,OAAQ,MAAO,KAAM,KAAM,MACxDC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAAO,OACtDC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,OAAQ,OAAQ,KAAM,KAAM,KAAM,KAAM,MAAO,KAAM,MACtEC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAInC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,IAAK,IAAK,IAAK,KAAM,KAAM,KAAM,KAAM,KAAM,MAC9DC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,SACNC,SAAU,CAAC,IAAK,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,IAAK,IAAK,IAAK,KAAM,KAAM,KAC/EC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,IAAK,IAAK,KAAM,OAAQ,MAAO,KAAM,KAAM,QACtDC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAInC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,OAAQ,KAAM,OAC7DC,eAAgB,MAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,MAAO,KAAM,KAAM,MAAO,MAAO,OACxDC,eAAgB,MAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,OACjEC,eAAgB,MAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAInC,CACEL,KAAM,QACNC,SAAU,CAAC,KAAM,MAAO,KAAM,KAAM,IAAK,KAAM,KAAM,IAAK,IAAK,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAC/GC,eAAgB,MAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,MAAO,MAAO,KAAM,KAAM,KAAM,KAAM,KAAM,MACnEC,eAAgB,MAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,QACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,MAAO,KAAM,KAAM,KAAM,KAAM,QACxEC,eAAgB,MAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,OAC3DC,eAAgB,MAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,MAAO,KAAM,OAAQ,KAAM,MAAO,MACzDC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAInC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,MAAO,MAAO,KAAM,OAAQ,KAAM,MACzDC,eAAgB,MAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,MAAO,MAAO,KAAM,KAAM,QACvDC,eAAgB,MAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAInC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MACrDC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAC3DC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAInC,CACEL,KAAM,OACNC,SAAU,CAAC,IAAK,KAAM,KAAM,KAAM,KAAM,KAAM,KAC9CC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAC/CC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,MAAO,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAClEC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,IAAK,IAAK,KAAM,KAAM,KAAM,KAAM,SACzDC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAC3DC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KACjEC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAInC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAC3DC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,MAAO,MAAO,MAAO,UAAW,MAAO,KAAM,MACpEC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MACrDC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAInC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MACrDC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MACrDC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,OAC3DC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,QAAS,OAAQ,QAC1DC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,OAC3DC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAInC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,MAAO,MAAO,MAAO,MAAO,QACzDC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,SACNC,SAAU,CAAC,KAAM,KAAM,KAAM,OAAQ,KAAM,KAAM,KAAM,MACvDC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAC3DC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,IAEnC,CACEL,KAAM,OACNC,SAAU,CAAC,IAAK,KAAM,KAAM,KAAM,KAAM,KAAM,IAAK,MACnDC,eAAgB,OAChBC,iBAAkB,CAAEC,IAAK,EAAGC,IAAK,KAQxBC,EAAoD,MAC/D,MAAMC,EAA4C,CAChD,KAAM,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,QAC3C,KAAM,CAAC,KAAM,KAAM,MAAO,MAAO,MAAO,MAAO,KAAM,MACrD,KAAM,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAC3C,KAAM,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,OAAQ,MAC7C,KAAM,CAAC,KAAM,KAAM,QACnB,KAAM,CAAC,OAAQ,OAAQ,MACvB,IAAK,CAAC,KAAM,MAAO,KAAM,KAAM,MAC/B,KAAM,CAAC,MAAO,KAAM,MAAO,QAC3B,KAAM,CACJ,OAAQ,KAAM,KAAM,KAEpB,KAAM,MAAO,KAAM,KAAM,OAAQ,MACjC,MAAO,QAAS,MAAO,MAAO,OAC9B,OAAQ,MAAO,OAAQ,OAEvB,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,OAEtC,KAAM,CAAC,KAAM,KAAM,KAAM,KAAM,OAAQ,QAAS,QAIlD,IAAK,MAAMhB,KAAUQ,EAAwB,CAC3C,MAAMS,EAAWjB,EAAOW,eACxB,IAAK,MAAMO,KAAWlB,EAAOU,SACtBM,EAAOC,GAAUE,SAASD,IAC7BF,EAAOC,GAAUG,KAAKF,EAG5B,CAEA,OAAOF,CACR,EAjCgE,GAqDpDK,EAAuD,CAClE,EAAG,CACDC,QAAS,CAAC,OAAQ,SAGpB,EAAG,CACDA,QAAS,CAAC,OAAQ,OAAQ,OAAQ,QAClCC,MAAO,CACL,KAAM,CAAE,IAAK,IACb,KAAM,CAAE,IAAK,MAGjB,EAAG,CACDD,QAAS,CAAC,OAAQ,OAAQ,OAAQ,OAAQ,OAAQ,QAClDC,MAAO,CACL,KAAM,CAAE,IAAK,GAAI,KAAM,IACvB,KAAM,CAAE,IAAK,GAAI,KAAM,MAG3B,EAAG,CACDD,QAAS,CACP,OACA,OACA,OACA,OACA,OACA,OACA,MACA,QAEFC,MAAO,CACL,IAAK,CAAE,IAAK,GAAI,KAAM,IACtB,KAAM,CAAE,IAAK,GAAI,KAAM,MAG3B,EAAG,CACDD,QAAS,MACTC,MAAO,CACL,KAAM,CAAE,IAAK,GAAI,KAAM,IACvB,KAAM,CAAE,IAAK,GAAI,KAAM,OC9aQC,ICWrCC,EAAEC,gBACQC,sBAAsB,OAC5BC,QAAQC,KAAK,iBAGb,IAAIC,GAAoC,EAExCC,QAAQC,cAAcC,+BAAiCC,IACnDJ,GAAwE,IAApCI,EAAcC,kBAClDP,QAAQC,KAAK,gCAAgCC,OAQjD,SAASM,EAAwBC,GAC7B,OAAIA,GAAS,GACF,CACHC,MAAO,OACPC,YAAa,kCACbC,QAAS,kFAGbH,GAAS,EACF,CACHC,MAAO,OACPC,YAAa,+BACbC,QAAS,6EAGbH,GAAS,EACF,CACHC,MAAO,OACPC,YAAa,2BACbC,QAAS,uEAGbH,GAAS,EACF,CACHC,MAAO,OACPC,YAAa,uBACbC,QAAS,mEAGV,CAAEF,MAAO,GAAIC,YAAa,GAAIC,QAAS,GAClD,CAofA,MAAMC,EAAwB,CAC1B,CACIC,KAAM,OACNC,MAAO,uDACPC,UAAW,CACP,kCACA,gBACA,kBACA,qBACA,kBAEJC,QAAS,sDAEb,CACIH,KAAM,OACNC,MAAO,6CACPC,UAAW,CACP,sBACA,uBACA,eACA,qBACA,mBAEJC,QAAS,0CAEb,CACIH,KAAM,MACNC,MAAO,yCACPC,UAAW,CACP,gBACA,gBACA,sBACA,eACA,mBAEJC,QAAS,iCAEb,CACIH,KAAM,MACNC,MAAO,kDACPC,UAAW,CACP,iBACA,mBACA,uBACA,mBACA,qBAEJC,QAAS,iCAEb,CACIH,KAAM,QACNC,MAAO,6CACPC,UAAW,CACP,2BACA,0BACA,yBACA,mBACA,uBAEJC,QAAS,2CAEb,CACIH,KAAM,OACNC,MAAO,gDACPC,UAAW,CACP,aACA,mBACA,kBACA,iBACA,mBAEJC,QAAS,gCAEb,CACIH,KAAM,OACNC,MAAO,gDACPC,UAAW,CACP,eACA,oBACA,oBACA,qBACA,wBAEJC,QAAS,oCAUXC,EAA2B,CAE7B,IAAK,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,IAAK,KAAM,IAAK,KAE5E,KAAM,CAAC,KAAM,KAAM,KAAM,MAAO,MAAO,MAAO,MAAO,MAAO,OAAQ,SAEpE,KAAM,CAAC,KAAM,KAAM,KAAM,MAAO,MAAO,MAAO,MAAO,MAErD,KAAM,CAAC,OAAQ,OAAQ,OAAQ,OAAQ,QAAS,SAKpD,SAASC,EAAoBC,GACzB,MAAMC,EAAelC,EAAeiC,IAAiB,GAGrD,MAAO,IAAI,IAAIE,IAAI,IAAID,KAFDH,EAAyBE,IAAiB,KAGpE,CAIA,MAAMG,EAAyB,CAC3B,OAAQ,OAAQ,OAAQ,OACxB,OAAQ,OAAQ,MAAO,OACvB,OAAQ,QAqBZ,SAASC,IACL,IAEI,MAAMC,EAAOC,YAAYD,KACzB,IAAKA,GAAwB,IAAhBA,EAAKE,OACd,OAAO,KAEX,IAAIC,EAAkB,GACtB,IAAK,IAAIC,EAAIJ,EAAKE,OAAS,EAAGE,GAAK,EAAGA,IAClC,GAAIJ,EAAKI,GAAGC,QAAS,CACjBF,EAAkBH,EAAKI,GAAGE,KAAO,GACjC,KACJ,CAEJ,IAAKH,EACD,OAAO,KAEX,MAAMI,EAAYC,IAAIC,WAAW,CAAErD,KAAM,UAAWsD,YAAa,IAC3DC,EAAOC,EAAEC,IAAIN,EAAW,aAC9B,IAAKI,EACD,OAAO,KAKX,MAAMG,EAAaH,EAAK,MAAM,KAC9B,GAAmB,OAAfG,EACA,OAAO,KAIX,MACMC,EAAqD,QAD5BJ,EAAK,MAAM,MAAQ,MACgB,WAAa,WACzEK,EAAkBL,EAAK,OAAOI,GACpC,GAAIC,GAAiB,KAEjB,OADAzC,QAAQC,KAAK,iBAAiBwC,EAAgB,gBACvC,KAGX,MAAMC,EAAuBN,EAAK,MAAM,KACxC,GAAIM,GAAsB,KAEtB,OADA1C,QAAQC,KAAK,kBAAkByC,EAAqB,iBAC7C,KAGX,MAAMC,EAAoBP,EAAK,MAAM,MACrC,GAAIO,GAAmB,KAEnB,OADA3C,QAAQC,KAAK,mBAAmB0C,EAAkB,kBAC3C,KAGX,MAAMC,EAAoBR,EAAK,MAAM,MAAQ,KACvCS,EAAsC,OAArBD,EAA4BR,EAAK,KAAOA,EAAK,KAC9DlE,EAAQ2E,GAAgB,MAAQ,EAEhCC,EAtEd,SAA+B5E,GAC3B,MAAM6E,EAAWtD,EAAmBvB,GACpC,OAAK6E,EAGoB,QAArBA,EAASrD,QACF,GAEJ6B,EAAuByB,OAAOC,IAAQF,EAASrD,QAAQH,SAAS0D,IAL5D,EAMf,CA6D+BC,CAAsBhF,GAE7C,IAAK,MAAMkD,KAAgB0B,EAAgB,CACvC,MAAMhE,EAAWqC,EAAoBC,GACrC,GAAwB,IAApBtC,EAAS6C,OAEb,IAAK,MAAMrC,KAAWR,EAClB,GAAI8C,EAAgBrC,SAASD,GAEzB,OADAU,QAAQmD,KAAK,qBAAqBjF,OAAWkD,cAAyB9B,MAC/D,CACH8D,UAAU,EACV7E,UAAWqE,EACX1E,QACAmF,cAAejC,EACfkC,eAAgBhE,EAIhC,CACA,OAAO,IACX,CACA,MAAOiE,GAEH,OADAvD,QAAQwD,MAAM,eAAgBD,GACvB,IACX,CACJ,CAKA,SAASE,EAAqClF,EAAWL,EAAOmF,GAE5D,IAAIK,EAAoB,GACpBC,EAAe,GACfzF,GAAS,GACTwF,EAAoB,GAAGnF,+CACvBoF,EAAe,IAAIpF,4CAEdL,GAAS,GACdwF,EAAoB,GAAGnF,oDACvBoF,EAAe,IAAIpF,uCAGnBmF,EAAoB,GAAGnF,4CACvBoF,EAAe,IAAIpF,+BAUvB,MAAO,CACH,uBACA,GACA,kEACA,WAX0B,CAC1B,IAAK,UACL,KAAM,UACN,KAAM,UACN,KAAM,SAEkC8E,IAAkB,iBAM1D,kEACA,GACA,SACA,uBACA,SAASnF,QAAYK,UAAkB8E,WACvC,uBACA,GACA,SACA,kBACA,mBAAmB9E,oBACnB,GACA,IAAIA,QACJmF,EACAC,EACA,GACA,WACA,MAAMpF,oBACN,4BACA,wCACA,6BACA,qBAAqBA,UACrB,GACA,kBACA,oBACA,+BACA,2BACA,GACA,SACA,QAAQA,sBACR,gBACA,cACA,SAASA,eACT,GACA,SACA,yBACA,sBACA,GACA,mBAAmBA,eACrBqF,KAAK,KACX,CAaA,SAASC,EAAgCtF,EAAWL,EAAO4F,GAEvD,MAAMC,EAAWlD,EAAsBmD,KAAKC,MAAMD,KAAKE,SAAWrD,EAAsBc,SAExF,IAAIwC,EAAe,GACfR,EAAe,GACnB,GAAIzF,GAAS,EAAG,CACZ,MAAMkG,EAAY,CACd,GAAG7F,qCACH,GAAGA,4BACH,GAAGA,4BAED8F,EAAW,CACb,IAAI9F,6BACJ,IAAIA,+BACJ,IAAIA,mCAER4F,EAAeC,EAAUJ,KAAKC,MAAMD,KAAKE,SAAWE,EAAUzC,SAC9DgC,EAAeU,EAASL,KAAKC,MAAMD,KAAKE,SAAWG,EAAS1C,QAChE,MACK,GAAIzD,GAAS,EAAG,CACjB,MAAMkG,EAAY,CACd,GAAG7F,8BACH,GAAGA,gCACH,GAAGA,4BAED8F,EAAW,CACb,IAAI9F,8BACJ,IAAIA,oCACJ,IAAIA,mCAER4F,EAAeC,EAAUJ,KAAKC,MAAMD,KAAKE,SAAWE,EAAUzC,SAC9DgC,EAAeU,EAASL,KAAKC,MAAMD,KAAKE,SAAWG,EAAS1C,QAChE,MACK,GAAIzD,GAAS,EAAG,CACjB,MAAMkG,EAAY,CACd,GAAG7F,gCACH,GAAGA,6BACH,GAAGA,gCAED8F,EAAW,CACb,IAAI9F,uBACJ,IAAIA,wBACJ,IAAIA,kCAER4F,EAAeC,EAAUJ,KAAKC,MAAMD,KAAKE,SAAWE,EAAUzC,SAC9DgC,EAAeU,EAASL,KAAKC,MAAMD,KAAKE,SAAWG,EAAS1C,QAChE,KACK,CACD,MAAMyC,EAAY,CACd,GAAG7F,8BACH,GAAGA,4BACH,GAAGA,gCAED8F,EAAW,CACb,IAAI9F,oBACJ,IAAIA,0BACJ,IAAIA,qCAER4F,EAAeC,EAAUJ,KAAKC,MAAMD,KAAKE,SAAWE,EAAUzC,SAC9DgC,EAAeU,EAASL,KAAKC,MAAMD,KAAKE,SAAWG,EAAS1C,QAChE,CAEA,MAAM2C,EAAmBP,EAAS/C,UAAUgD,KAAKC,MAAMD,KAAKE,SAAWH,EAAS/C,UAAUW,SAC1F,MAAO,CACH,gBACA,GACA,kEACA,QAAQpD,oBAA4BuF,eACpC,kEACA,GACA,8BACA,GACA,SACAC,EAAShD,MACT,GACA,QACAuD,EACA,GACA,IAAI/F,QACJ,GAAG4F,IACH,GAAGR,IACH,GACA,SACA,eAAepF,aACf,8BACA,+BACA,UAAUA,kBACV,wBACA,GACA,WACA,yBACA,4BACA,uBAAuBA,YACvB,wBAAwBA,UACxB,GACA,oBACA,UAAUA,UACV,0BAA0BA,cAC1B,cAAcA,SAAiBA,SAC/B,mCACA,GACA,SACA,mBAAmBA,wBACnB,0BACA,KAAKA,wBACL,uBACA,qBACA,GACA,SACA,mBACA,cACA,0BACA,+BACA,GACA,qBAAqBA,kBACvBqF,KAAK,KACX,CAIA,SAASW,IAEL,MAAO,eADU1D,EAAsBmD,KAAKC,MAAMD,KAAKE,SAAWrD,EAAsBc,SACzDV,WACnC,CAsCA,MAAMuD,EAAkB,CACpB,CACI1D,KAAM,OACNC,MAAO,+CACPC,UAAW,CACP,oBACA,aACA,iBAEJC,QAAS,yCAEb,CACIH,KAAM,QACNC,MAAO,mDACPC,UAAW,CACP,yBACA,uBACA,uBAEJC,QAAS,gCAEb,CACIH,KAAM,QACNC,MAAO,wCACPC,UAAW,CACP,sBACA,oBACA,uBAEJC,QAAS,8BAEb,CACIH,KAAM,OACNC,MAAO,gDACPC,UAAW,CACP,qBACA,iBACA,qBAEJC,QAAS,iCAEb,CACIH,KAAM,QACNC,MAAO,2CACPC,UAAW,CACP,kBACA,wBACA,2BAEJC,QAAS,kCAEb,CACIH,KAAM,QACNC,MAAO,oCACPC,UAAW,CACP,sBACA,wBACA,6BAEJC,QAAS,0CAEb,CACIH,KAAM,OACNC,MAAO,6CACPC,UAAW,CACP,6BACA,yBACA,4BAEJC,QAAS,uCAEb,CACIH,KAAM,OACNC,MAAO,mCACPC,UAAW,CACP,kBACA,gCACA,6BAEJC,QAAS,kCAOjB,SAASwD,EAA0BlG,EAAWL,GAE1C,MAAM6F,EAAWS,EAAgBR,KAAKC,MAAMD,KAAKE,SAAWM,EAAgB7C,SAEtE+C,EAAgBV,KAAKE,SAAW,GAAM,EAAI,EAEhD,IAAIC,EAAe,GACfR,EAAe,GACnB,GAAIzF,GAAS,EAAG,CACZ,MAAMkG,EAAY,CACd,GAAG7F,4BACH,GAAGA,6BACH,GAAGA,0BAED8F,EAAW,CACb,IAAI9F,+BACJ,IAAIA,gCACJ,IAAIA,2BAER4F,EAAeC,EAAUJ,KAAKC,MAAMD,KAAKE,SAAWE,EAAUzC,SAC9DgC,EAAeU,EAASL,KAAKC,MAAMD,KAAKE,SAAWG,EAAS1C,QAChE,MACK,GAAIzD,GAAS,EAAG,CACjB,MAAMkG,EAAY,CACd,GAAG7F,2BACH,GAAGA,2BACH,GAAGA,sBAED8F,EAAW,CACb,IAAI9F,8BACJ,IAAIA,6BACJ,IAAIA,mCAER4F,EAAeC,EAAUJ,KAAKC,MAAMD,KAAKE,SAAWE,EAAUzC,SAC9DgC,EAAeU,EAASL,KAAKC,MAAMD,KAAKE,SAAWG,EAAS1C,QAChE,MACK,GAAIzD,GAAS,EAAG,CACjB,MAAMkG,EAAY,CACd,GAAG7F,6BACH,GAAGA,yBACH,GAAGA,uBAED8F,EAAW,CACb,IAAI9F,sBACJ,IAAIA,6BACJ,IAAIA,sBAER4F,EAAeC,EAAUJ,KAAKC,MAAMD,KAAKE,SAAWE,EAAUzC,SAC9DgC,EAAeU,EAASL,KAAKC,MAAMD,KAAKE,SAAWG,EAAS1C,QAChE,KACK,CACD,MAAMyC,EAAY,CACd,GAAG7F,wBACH,GAAGA,4BACH,GAAGA,wBAED8F,EAAW,CACb,IAAI9F,kBACJ,IAAIA,yBACJ,IAAIA,2BAER4F,EAAeC,EAAUJ,KAAKC,MAAMD,KAAKE,SAAWE,EAAUzC,SAC9DgC,EAAeU,EAASL,KAAKC,MAAMD,KAAKE,SAAWG,EAAS1C,QAChE,CAEA,MAAM2C,EAAmBP,EAAS/C,UAAUgD,KAAKC,MAAMD,KAAKE,SAAWH,EAAS/C,UAAUW,SAEpFgD,EAAgB,CAClB,gBAAgBD,kBAChB,mBAAmBA,cACnB,kBAAkBA,iBAClB,UAAUA,cAERE,EAAeD,EAAcX,KAAKC,MAAMD,KAAKE,SAAWS,EAAchD,SAC5E,MAAO,CACH,gBACA,GACA,kEACA,4BACA,kEACA,GACA,8BACA,GACA,SACAoC,EAAShD,MACT,GACA,QACAuD,EACA,GACA,IAAI/F,QACJ,GAAG4F,IACH,GAAGR,IACH,GACA,UACA,cAAcpF,KAAamG,YAC3BE,EACA,GACA,SACA,aAAarG,aACb,mBACA,MAAMA,yBACN,yBACA,+BACA,GACA,WACA,WAAWmG,WACX,MAAMnG,sBACN,yBACA,GACA,SACA,mBACA,0BACA,oBACA,GACA,2BACFqF,KAAK,KACX,CAIA,SAASiB,IAEL,MAAO,eADUL,EAAgBR,KAAKC,MAAMD,KAAKE,SAAWM,EAAgB7C,SAC7CV,SACnC,CAqCA,SAAS6D,EAAqCvG,EAAWC,GASrD,MAAO,CACH,SAASD,MAAcC,KATRH,EAAcG,WAU7B,GACA,4BACA,GAXcF,EAAmCC,EAAWC,GAI3DuG,QAAQ,aAAc,IACtBA,QAAQ,iBAAkB,IAC1BC,OAOD,GACA,0BACFpB,KAAK,KACX,CAKA,SAASqB,IACL,MAAMC,EAAc,GAEdC,EA/pCV,WACI,IAEI,MAAMnD,EAAYC,IAAIC,WAAW,CAAErD,KAAM,UAAWsD,YAAa,IAC3DC,EAAOC,EAAEC,IAAIN,EAAW,aAC9B,IAAKI,EAED,OADApC,QAAQmD,KAAK,yBACN,KAEX,MAAMiC,EAAchD,EAAK,IAAI,IAAM,KAC7BiD,EAAcjD,EAAK,IAAI,IAAM,KAC7BkD,EAAgBlD,EAAK,MAAM,MAAQ,KACnCG,EAAaH,EAAK,MAAM,MAAQ,KAEtC,IAAImD,EAAkB,GACtB,GAAoB,OAAhBF,EAAsB,CACtB,MAAOG,GAAQH,EAAYI,MAAM,KAAKC,IAAIC,QACtCH,GAAQ,GAAKA,EAAO,EACpBD,EAAkB,OAEbC,GAAQ,IAAMA,EAAO,GAC1BD,EAAkB,OAEbC,GAAQ,IAAMA,EAAO,GAC1BD,EAAkB,QAEbC,GAAQ,IAAMA,EAAO,KAC1BD,EAAkB,OAE1B,CACA,MAAMK,EAAQ,CACV,WACA,QAAQR,IACR,QAAQC,IAAcE,EAAkB,KAAKA,KAAqB,KAClE,UAAUD,IACV,UAAU/C,KAad,MAVmB,OAAfA,EACAqD,EAAMpG,KAAK,oBAAqB,qBAAsB,kBAElC,OAAf+C,GAAsC,OAAfA,GAC5BqD,EAAMpG,KAAK,cAAc+C,gBAGzBgD,GACAK,EAAMpG,KAAK,kBAAkB+F,KAE1BK,EAAMhC,KAAK,KACtB,CACA,MAAOL,GAEH,OADAvD,QAAQwD,MAAM,mBAAoBD,GAC3B,IACX,CACJ,CAymC0BsC,GAClBV,GACAD,EAAY1F,KAAK2F,GAGrB,MAAMW,EAvtCV,WACI,IACI,MAAM9D,EAAYC,IAAIC,WAAW,CAAErD,KAAM,UAAWsD,YAAa,IAC3DC,EAAOC,EAAEC,IAAIN,EAAW,aAC9B,IAAKI,EACD,OAAO,KAEX,MAAMQ,EAAmBR,EAAK,MAAM,MAAQ,KACtC2D,EAAsC,OAArBnD,EAA4B,KAAO,KAEpDoD,EAAa5D,EAAK,KAClB6D,EAAc7D,EAAK,KAEnB8D,EAAkC,OAArBtD,EAA4BqD,EAAcD,EACvDG,EAAaD,GAAY,MAAQ,EAGvC,KADwBC,EAAa,IAAMD,GAAY,MAAMvE,QAAU,GAAK,GAGxE,OAAO,KAEX,MAAMiE,EAAQ,CACV,cACA,UAAUhD,IACV,GACA,SAASA,KAAoBmD,aAC7B,GACA,IAAInD,WACJ,KAAKmD,sBACL,KAAKA,yBACL,KAAKA,qBACL,KAAKA,oBAUT,OAPII,GAAc,GACdP,EAAMpG,KAAK,KAAKuG,wBAAqCI,MAErDD,GAAY,MAAMvE,OAAS,GAC3BiE,EAAMpG,KAAK,KAAKuG,QAAqBG,EAAW,KAAKvE,iBAEzDiE,EAAMpG,KAAK,GAAI,SAAU,OAAOoD,KAAoBmD,SAAsBnD,KAAoBmD,yBAAuC,KAAKnD,UAAyBmD,0BAAwC,6BAA8B,+BAClOH,EAAMhC,KAAK,KACtB,CACA,MAAOL,GAEH,OADAvD,QAAQwD,MAAM,kBAAmBD,GAC1B,IACX,CACJ,CAwqC8B6C,GACtBN,GACAZ,EAAY1F,KAAKsG,GAGrB,MAAMO,EAx4BV,WACI,IAEI,MAAMrE,EAAYC,IAAIC,WAAW,CAAErD,KAAM,UAAWsD,YAAa,IAC3DC,EAAOC,EAAEC,IAAIN,EAAW,aAC9B,IAAKI,EAED,OADApC,QAAQmD,KAAK,wBACN,KAGX,MAAMP,EAAmBR,EAAK,MAAM,MAAQ,KACtCwD,EAAQ,GAERU,EAAclE,EAAK,MAAM,MAAQ,GACvC,GAAIkE,EAAY3E,OAAS,GAA0B,OAArBiB,EAA2B,CACrD,MAAM,MAAElC,EAAK,YAAEC,EAAW,QAAEC,GAAYJ,EAAwB8F,EAAY3E,QACtE0E,EAAaC,EAAYZ,IAAKa,GAAM,IAAIA,EAAE,OAAO3C,KAAK,KAC5DgC,EAAMpG,KAAK,CACP,YACA,SAASkB,IACT,QAAQC,IACR,UAAU0F,IACV,GACA,eACA,GAAGzF,IACH,GACA,SACA,2BACA,8BACA,oCACA,sCACA,+BACFgD,KAAK,MACX,CAEA,MAAM4C,EAAepE,EAAK,MAAM,MAAQ,GACxC,GAAIoE,EAAa7E,OAAS,GAA0B,OAArBiB,EAA2B,CACtD,MAAM,MAAElC,EAAK,YAAEC,EAAW,QAAEC,GAAYJ,EAAwBgG,EAAa7E,QACvE0E,EAAaG,EAAad,IAAKa,GAAM,IAAIA,EAAE,OAAO3C,KAAK,KAC7DgC,EAAMpG,KAAK,CACP,YACA,SAASkB,IACT,QAAQC,IACR,UAAU0F,IACV,GACA,eACA,GAAGzF,IACH,GACA,SACA,2BACA,8BACA,oCACA,sCACA,+BACFgD,KAAK,MACX,CACA,OAAqB,IAAjBgC,EAAMjE,OACC,KAEJiE,EAAMhC,KAAK,OACtB,CACA,MAAOL,GAEH,OADAvD,QAAQwD,MAAM,oBAAqBD,GAC5B,IACX,CACJ,CAu0BuBkD,GACfJ,GACAnB,EAAY1F,KAAK6G,GAGrB,MAAMK,EAnnCV,WACI,IACI,MAAM1E,EAAYC,IAAIC,WAAW,CAAErD,KAAM,UAAWsD,YAAa,IAC3DC,EAAOC,EAAEC,IAAIN,EAAW,aAC9B,IAAKI,EACD,OAAO,KAEX,MAAMQ,EAAmBR,EAAK,MAAM,MAAQ,KACtCS,EAAsC,OAArBD,EAA4BR,EAAK,KAAOA,EAAK,KACpE,IAAKS,EACD,OAAO,KAEX,MAAM8D,EAAW9D,EAAe,KAC1B+D,EAAS/D,EAAe,KACxBgE,EAAUhE,EAAe,KAEzB+C,EAAQ,CACV,WAAWhD,KACX,MAAM+D,EAAS,QAAQA,EAAS,MAAMA,EAAS,WAAWA,EAAS,QACnE,MAAMC,EAAO,QAAQA,EAAO,QAC5B,MAAM/D,EAAe,QAGrB8D,EAAS,MAA0B,MAAlBA,EAAS,MAC1Bf,EAAMpG,KAAK,QAAQmH,EAAS,QAGhC,MAAMG,EAAYD,GAAS,MAAQ,GAC/BC,EAAUnF,OAAS,GACnBiE,EAAMpG,KAAK,QAAQsH,EAAUlD,KAAK,QAGtC,MAAMrB,EAAaH,EAAK,MAAM,MAAQ,KAItC,GAHmC,OAAfG,GACc,OAAfA,GAAsC,OAAfA,GAAsC,OAAfA,EAElC,CAC3B,MAAMwE,EAAW,GAEXC,EAAgBL,EAAS,KACT,OAAlBK,GAA4C,SAAlBA,GAC1BD,EAASvH,KAAK,UAAUwH,gBAGxBF,EAAUnF,OAAS,GACnBoF,EAASvH,KAAK,eAAesH,EAAUlD,KAAK,QAG5C+C,EAAS,MAA0B,MAAlBA,EAAS,MAC1BI,EAASvH,KAAK,QAAQmH,EAAS,gBAGf,OAAhBC,EAAO,MAAiC,OAAhBA,EAAO,MAC/BG,EAASvH,KAAK,QAAQoH,EAAO,iBAE7BG,EAASpF,OAAS,IAClBiE,EAAMpG,KAAK,oBACXuH,EAASE,QAAQC,GAAKtB,EAAMpG,KAAK,OAAO0H,MAEhD,CACA,OAAOtB,EAAMhC,KAAK,KACtB,CACA,MAAOL,GAEH,OADAvD,QAAQwD,MAAM,kBAAmBD,GAC1B,IACX,CACJ,CAijC+B4D,GACvBT,GACAxB,EAAY1F,KAAKkH,GAGrB,MAAMU,EAr9BV,WACI,IACI,MAAMpF,EAAYC,IAAIC,WAAW,CAAErD,KAAM,UAAWsD,YAAa,IAC3DC,EAAOC,EAAEC,IAAIN,EAAW,aAC9B,IAAKI,EACD,OAAO,KAEX,MAAMiF,EAAkB,GAexB,IAbsBjF,EAAK,MAAM,OAAS,IAC5B6E,QAASK,IACfA,EAAE,KACFD,EAAgB7H,KAAK,CAAE+H,OAAQ,KAAMC,QAASF,EAAE,UAIjClF,EAAK,MAAM,OAAS,IAC5B6E,QAASK,IAChBA,EAAE,KACFD,EAAgB7H,KAAK,CAAE+H,OAAQ,KAAMC,QAASF,EAAE,SAGzB,IAA3BD,EAAgB1F,OAChB,OAAO,KACX3B,QAAQC,KAAK,aAAaoH,EAAgB1F,iBA4B1C,MAzBe,CACX,kBACA,GACA,cAJgB0F,EAAgB3B,IAAI4B,GAAK,OAAOA,EAAEC,WAAWD,EAAEE,YAAY5D,KAAK,MAMhF,GACA,cACA,8BACA,sBACA,wBACA,wBACA,qBACA,uBACA,sBACA,sBACA,uBACA,uBACA,GACA,wCACA,mBACA,GACA,MACA,sBACA,uBACFA,KAAK,KAEX,CACA,MAAOL,GAEH,OADAvD,QAAQwD,MAAM,mBAAoBD,GAC3B,IACX,CACJ,CA25BgCkE,GACxBL,GACAlC,EAAY1F,KAAK4H,GAErB,MAAMM,EAAgBxC,EAAYvD,OAAS,EAAIuD,EAAYtB,KAAK,QAAUuB,EAEpEwC,EAjjCV,WACI,IACI,MAAM3F,EAAYC,IAAIC,WAAW,CAAErD,KAAM,UAAWsD,YAAa,IAC3DC,EAAOC,EAAEC,IAAIN,EAAW,aAC9B,IAAKI,GAAM,MAAM,OACb,OAAO,KAEX,MAAMwF,EAAOxF,EAAK,KAAK,OACvB,GAAoB,IAAhBwF,EAAKjG,OACL,OAAO,KAGX,MAAMkG,EAAkBD,EAAK5E,OAAQ8E,IAAOA,EAAE,OAAOnG,OACrD3B,QAAQC,KAAK,aAAa2H,EAAKjG,kBAAkBkG,WAEjD,MAAME,EAAmB,CAAC,EAC1BH,EAAKX,QAASe,IACV,MAAMT,EAASS,EAAI,GACdD,EAAiBR,KAClBQ,EAAiBR,GAAU,IAE/BQ,EAAiBR,GAAQ/H,KAAKwI,EAAI,MAKtC,MAAMpC,EAAQ,GAEd,IAAK,MAAO2B,EAAQlD,KAAa4D,OAAOC,QAAQH,GAC5C,GAAwB,IAApB1D,EAAS1C,OAETiE,EAAMpG,KAAK,IAAI+H,OAAYlD,EAAS,sBAEnC,CAED,MAAM8D,EAAc9D,EAASqB,IAAI4B,GAAK,QAAQA,MAAM1D,KAAK,MACzDgC,EAAMpG,KAAK,IAAI+H,wBAA6BY,IAChD,CAGJ,MAAMC,EAAU,CACZ,eACA,MACGxC,EACH,GACA,SACA,0BACA,yCACA,+BACA,2BACA,6BACA,4BACA,2BACFhC,KAAK,MAEP,IAAIyE,GAAgB,EAQpB,GAPAT,EAAKX,QAASe,IACLA,EAAI,QACLA,EAAI,OAAQ,EACZK,GAAgB,KAIpBA,EACA,IACI,MAAMC,EAAcrG,IAAIC,WAAW,CAAErD,KAAM,UAAWsD,YAAa,IACnEE,EAAEkG,IAAID,EAAa,wBAAyBV,GAC5C3F,IAAIuG,eAAeF,EAAa,CAAEzJ,KAAM,UAAWsD,YAAa,IAChEnC,QAAQC,KAAK,cAAc4H,qBAC/B,CACA,MAAOY,GACHzI,QAAQwD,MAAM,iBAAkBiF,EACpC,CAEJ,OAAOL,CACX,CACA,MAAO7E,GAEH,OADAvD,QAAQwD,MAAM,mBAAoBD,GAC3B,IACX,CACJ,CAi+B+BmF,GAG3B,IAAIC,EAAc,CACd9J,KAAM,KACNN,UAAW,KACXqK,mBAAoB,KACpB3H,QAAS,MAIb,MAAM4H,EAAoBrH,IAC1B,GAAIqH,EAAmB,CACnB,MAAM,UAAEtK,EAAS,MAAEL,EAAK,cAAEmF,EAAa,eAAEC,GAAmBuF,EAU5D,OATAF,EAAc,CACV9J,KAAM,oBACNN,YACAqK,mBAAoBnF,EAAqClF,EAAWL,EAAOmF,GAC3EpC,QAteD,8BAueCoC,iBAEJrD,QAAQmD,KAAK,uBAAuBjF,OAAWmF,YAAwBC,WAEhE,CACHwF,OAAQpB,EACRqB,eAAgBpB,EAChBgB,cAER,CAGA,MAAMK,EAh3BV,WACI,IACI,MAAMhH,EAAYC,IAAIC,WAAW,CAAErD,KAAM,UAAWsD,YAAa,IAC3DC,EAAOC,EAAEC,IAAIN,EAAW,aACxBiH,EAAeC,mBACrB,IAAK9G,GAAM,MAAM,OACb,MAAO,CAAEvD,KAAM,KAAMN,UAAW,KAAML,MAAO,EAAG4F,gBAAiB,EAAGqF,OAAQ,GAAIC,UAAW,GAE/F,MAAMxB,EAAOxF,EAAK,KAAK,OAEjBiH,EAAgB,CAAE,KAAQ,EAAG,KAAQ,EAAG,KAAQ,GAEhDC,EAAY1B,EACblC,IAAI,CAACsC,EAAKuB,KAAU,CAAGvB,MAAKuB,WAC5BvG,OAAO,EAAGgF,UAEX,MAAMwB,EAAYP,EAAejB,EAAI,KACrC,OAAOwB,GAAa,GAAKA,GAAa,IAAMxB,EAAI,QAE/CyB,KAAK,CAACC,EAAGC,IAAMN,EAAcK,EAAE1B,IAAI,MAAQqB,EAAcM,EAAE3B,IAAI,OACpE,GAAyB,IAArBsB,EAAU3H,OACV,MAAO,CAAE9C,KAAM,KAAMN,UAAW,KAAML,MAAO,EAAG4F,gBAAiB,EAAGqF,OAAQ,GAAIC,UAAW,GAE/F,MAAM,IAAEpB,EAAG,MAAEuB,GAAUD,EAAU,GAC3B/K,EAAYyJ,EAAI,GAChB9J,EAAsB,OAAdK,EACR6D,EAAK,MAAM,MAAQ,EACnBA,EAAK,MAAM,MAAQ,EAEzB,OADApC,QAAQC,KAAK,sBAAsB+H,EAAI,aAAazJ,UAAkByJ,EAAI,QACnE,CACHnJ,KAAMmJ,EAAI,KACVzJ,YACAL,QACA4F,gBAAiBkE,EAAI,MAAQ,EAC7BmB,OAAQnB,EAAI,MAAQ,GACpBoB,SAAUG,EACVK,YAAa5B,EAAI,IACjB6B,YAAa7B,EAAI,KACjB8B,eAAgB9B,EAAI,KAE5B,CACA,MAAOzE,GAEH,OADAvD,QAAQwD,MAAM,kBAAmBD,GAC1B,CAAE1E,KAAM,KAAMN,UAAW,KAAML,MAAO,EAAG4F,gBAAiB,EAAGqF,OAAQ,GAAIC,UAAW,EAC/F,CACJ,CAm0BqBW,GACjB,GAAIf,EAASnK,MAAQmK,EAASzK,UAAW,CACrC,MAAM,KAAEM,EAAI,UAAEN,EAAS,MAAEL,EAAK,gBAAE4F,EAAe,YAAE8F,EAAW,YAAEC,EAAW,SAAET,GAAaJ,EAC3E,SAATnK,GAAmB+K,GACnBjB,EAAc,CACV9J,KAAM,oBACNN,YACAqK,mBAAoB9D,EAAqCvG,EAAWqL,GACpE3I,QAAStC,EAAiCJ,EAAWqL,GACrDA,cACAR,YAEJpJ,QAAQC,KAAK,8BAA8B1B,OAAeqL,OAE5C,SAAT/K,GAEL8J,EAAc,CACV9J,KAAM,eACNN,YACAqK,mBAAoB/E,EAAgCtF,EAAWL,EAAO4F,GACtE7C,QAASsD,IACTT,kBACAsF,YAEJpJ,QAAQC,KAAK,8BAA8B1B,QAAgBuF,SAE7C,SAATjF,IAEL8J,EAAc,CACV9J,KAAM,SACNN,YACAqK,mBAAoBnE,EAA0BlG,EAAWL,GACzD+C,QAAS4D,IACTgF,cACAT,YAEJpJ,QAAQC,KAAK,8BAA8B1B,QAAgBsL,MAEnE,CAGA,IAAKlB,EAAY9J,KAAM,CAEnB,MAAMmL,EA9Jd,WACI,IACI,MAAMhI,EAAYC,IAAIC,WAAW,CAAErD,KAAM,UAAWsD,YAAa,IAC3DC,EAAOC,EAAEC,IAAIN,EAAW,aAC9B,IAAKI,EACD,MAAO,CAAE7D,UAAW,KAAMC,SAAU,MAGxC,MAAMyL,EAAe7H,EAAK,MAAM,QAChC,GAAI6H,GAAc,MAAQA,EAAa,KAAO,EAAG,CAC7C,MAAMzL,EAAWyL,EAAa,KAE9B,OADAjK,QAAQC,KAAK,uBAAuBzB,KAAYH,EAAcG,OACvD,CAAED,UAAW,KAAMC,WAC9B,CAEA,MAAM0L,EAAgB9H,EAAK,MAAM,QACjC,GAAI8H,GAAe,MAAQA,EAAc,KAAO,EAAG,CAC/C,MAAM1L,EAAW0L,EAAc,KAE/B,OADAlK,QAAQC,KAAK,uBAAuBzB,KAAYH,EAAcG,OACvD,CAAED,UAAW,KAAMC,WAC9B,CACA,MAAO,CAAED,UAAW,KAAMC,SAAU,KACxC,CACA,MAAO+E,GAEH,OADAvD,QAAQwD,MAAM,gBAAiBD,GACxB,CAAEhF,UAAW,KAAMC,SAAU,KACxC,CACJ,CAmIsC2L,GAC9B,GAAIH,EAAsBzL,WAAayL,EAAsBxL,SAAU,CACnE,MAAM,UAAED,EAAS,SAAEC,GAAawL,EAChCrB,EAAc,CACV9J,KAAM,oBACNN,YACAqK,mBAAoB9D,EAAqCvG,EAAWC,GACpEyC,QAAStC,EAAiCJ,EAAWC,GACrDoL,YAAapL,GAEjBwB,QAAQC,KAAK,2BAA2B1B,OAAeC,KAC3D,CAEA,IAAKmK,EAAY9J,KAAM,CACnB,MAAMuL,EAv3BlB,WACI,IACI,MAAMpI,EAAYC,IAAIC,WAAW,CAAErD,KAAM,UAAWsD,YAAa,IAC3DC,EAAOC,EAAEC,IAAIN,EAAW,aAC9B,IAAKI,GAAM,MAAM,QAAQ,IACrB,MAAO,CAAEiI,WAAW,EAAO9L,UAAW,KAAML,MAAO,EAAG4F,gBAAiB,EAAGqF,OAAQ,IAGtF,GAAI/G,EAAK,KAAK,OAAO,MACjB,MAAO,CAAEiI,WAAW,EAAO9L,UAAW,KAAML,MAAO,EAAG4F,gBAAiB,EAAGqF,OAAQ,IAEtF,MAAMmB,EAAQlI,EAAK,KAAK,OAClBQ,EAAoBR,EAAK,MAAM,MAAQ,KACvClE,EAA6B,OAArB0E,EACRR,EAAK,MAAM,MAAQ,EACnBA,EAAK,MAAM,MAAQ,EAEzB,OADApC,QAAQC,KAAK,0BAA0BqK,EAAM,QACtC,CACHD,WAAW,EACX9L,UAAWqE,EACX1E,QACA4F,gBAAiBwG,EAAM,MAAQ,EAC/BnB,OAAQmB,EAAM,MAAQ,GAE9B,CACA,MAAO/G,GAEH,OADAvD,QAAQwD,MAAM,gBAAiBD,GACxB,CAAE8G,WAAW,EAAO9L,UAAW,KAAML,MAAO,EAAG4F,gBAAiB,EAAGqF,OAAQ,GACtF,CACJ,CA01BqCoB,GACzB,GAAIH,EAAiBC,WAAaD,EAAiB7L,UAAW,CAC1D,MAAM,UAAEA,EAAS,MAAEL,EAAK,gBAAE4F,GAAoBsG,EAE9CzB,EAAc,CACV9J,KAAM,eACNN,YACAqK,mBAAoB/E,EAAgCtF,EAAWL,EAAO4F,GACtE7C,QAASsD,IACTT,mBAEJ9D,QAAQC,KAAK,2BAA2B1B,QAAgBuF,OAC5D,CACJ,CAEA,IAAK6E,EAAY9J,KAAM,CACnB,MAAM2L,EAnblB,WACI,IACI,MAAMxI,EAAYC,IAAIC,WAAW,CAAErD,KAAM,UAAWsD,YAAa,IAC3DC,EAAOC,EAAEC,IAAIN,EAAW,aAC9B,IAAKI,GAAM,MAAM,QAAQ,IACrB,MAAO,CAAEiI,WAAW,EAAO9L,UAAW,KAAML,MAAO,EAAG2L,YAAa,GAAIC,eAAgB,IAG3F,GAAI1H,EAAK,KAAK,OAAO,MACjB,MAAO,CAAEiI,WAAW,EAAO9L,UAAW,KAAML,MAAO,EAAG2L,YAAa,GAAIC,eAAgB,IAE3F,MAAMQ,EAAQlI,EAAK,KAAK,OAClBQ,EAAoBR,EAAK,MAAM,MAAQ,KACvClE,EAA6B,OAArB0E,EACRR,EAAK,MAAM,MAAQ,EACnBA,EAAK,MAAM,MAAQ,EAEzB,OADApC,QAAQC,KAAK,0BAA0BqK,EAAM,QACtC,CACHD,WAAW,EACX9L,UAAWqE,EACX1E,QACA2L,YAAaS,EAAM,MAAQ,GAC3BR,eAAgBQ,EAAM,MAAQ,GAEtC,CACA,MAAO/G,GAEH,OADAvD,QAAQwD,MAAM,gBAAiBD,GACxB,CAAE8G,WAAW,EAAO9L,UAAW,KAAML,MAAO,EAAG2L,YAAa,GAAIC,eAAgB,GAC3F,CACJ,CAsZ+BW,GACnB,GAAID,EAAWH,WAAaG,EAAWjM,UAAW,CAC9C,MAAM,UAAEA,EAAS,MAAEL,EAAK,YAAE2L,GAAgBW,EAE1C7B,EAAc,CACV9J,KAAM,SACNN,YACAqK,mBAAoBnE,EAA0BlG,EAAWL,GACzD+C,QAAS4D,IACTgF,eAEJ7J,QAAQC,KAAK,2BAA2B1B,QAAgBsL,KAC5D,CACJ,CACJ,CACA,MAAO,CACHf,OAAQpB,EACRqB,eAAgBpB,EAChBgB,cAER,CAKA,SAAS+B,EAAuB/B,GAC5B,GAAKA,EAAY9J,MAAS8J,EAAYpK,UAEtC,IACI,MAAM+J,EAAcrG,IAAIC,WAAW,CAAErD,KAAM,UAAWsD,YAAa,IAEnE,QAA6BwI,IAAzBhC,EAAYS,UAA0BT,EAAYS,UAAY,EAAG,CACjE,MAAMxB,EAAOvF,EAAEC,IAAIgG,EAAa,wBAAyB,IACrDV,EAAKe,EAAYS,YACjBxB,EAAKe,EAAYS,UAAU,OAAQ,EACnCpJ,QAAQC,KAAK,oBAAoB0I,EAAYS,iBAErD,CAEA,OAAQT,EAAY9J,MAChB,IAAK,oBAC6B,OAA1B8J,EAAYpK,WACZ8D,EAAEkG,IAAID,EAAa,+BAA+B,GAClDjG,EAAEkG,IAAID,EAAa,8BAA+B,eAGlDjG,EAAEkG,IAAID,EAAa,+BAA+B,GAClDjG,EAAEkG,IAAID,EAAa,8BAA+B,cAEtDtI,QAAQC,KAAK,wBACb,MACJ,IAAK,eACDoC,EAAEkG,IAAID,EAAa,+BAA+B,GAClDjG,EAAEkG,IAAID,EAAa,6BAA6B,GAChDtI,QAAQC,KAAK,sBACb,MACJ,IAAK,SACDoC,EAAEkG,IAAID,EAAa,+BAA+B,GAClDjG,EAAEkG,IAAID,EAAa,6BAA6B,GAChDtI,QAAQC,KAAK,sBAGrBgC,IAAIuG,eAAeF,EAAa,CAAEzJ,KAAM,UAAWsD,YAAa,GACpE,CACA,MAAOsG,GACHzI,QAAQwD,MAAM,mBAAoBiF,EACtC,CACJ,CAEAtI,QAAQC,cAAcwK,6BAA+BC,IACjD,IACI,MAAM,KAAEpJ,EAAI,OAAEqJ,GAAWD,EAGzB,GAAIC,EAEA,YADA9K,QAAQC,KAAK,sCAGjB,MAAM,OAAE6I,EAAM,eAAEC,EAAc,YAAEJ,GAAgB1D,IAE1C8F,EAAgB,CAClB,uCACA,0BACA,aACA,YAKJ,SAASC,IACL,IAAK,IAAInJ,EAAIJ,EAAKE,OAAS,EAAGE,GAAK,EAAGA,IAClC,GAAqB,SAAjBJ,EAAKI,GAAGoJ,KAAiB,CACzB,MAAMC,EAAazJ,EAAKI,GAAG2F,QAErB2D,GADgC,iBAAfD,EAA0BA,EAAa,IACtClG,OAExB,IADuB+F,EAAcK,KAAKC,GAAUF,IAAYE,GAAUF,EAAQG,WAAWD,IAEzF,OAAOxJ,CAEf,CAEJ,OAAQ,CACZ,CAEA,GAAoB,IAAhBJ,EAAKE,OAgBL,OAfImH,GACArH,EAAKjC,KAAK,CAAEyL,KAAM,SAAUzD,QAASsB,IAErCC,GACAtH,EAAKjC,KAAK,CAAEyL,KAAM,SAAUzD,QAASuB,IAGrCJ,EAAYC,qBACZnH,EAAKjC,KAAK,CAAEyL,KAAM,OAAQzD,QAASmB,EAAYC,qBAC/C5I,QAAQC,KAAK,8BAA8B0I,EAAY9J,SACvD6L,EAAuB/B,SAI3B3I,QAAQC,KAAK,0BAOjB,GAAI0I,EAAY9J,MAAQ8J,EAAYC,oBAAsBD,EAAYpK,UAAW,CAE7E,IAAIgN,GAAiB,EACrB,IAAK,IAAI1J,EAAIJ,EAAKE,OAAS,EAAGE,GAAK,EAAGA,IAClC,GAAqB,SAAjBJ,EAAKI,GAAGoJ,KAAiB,CACzBM,EAAgB1J,EAChB,KACJ,CAEJ,IAAuB,IAAnB0J,EAAsB,CAEtB9J,EAAK8J,GAAe/D,QAAUmB,EAAYC,mBAE1C,IAAI4C,EAAU,kBAAkB7C,EAAY9J,OACnB,sBAArB8J,EAAY9J,KACZ2M,GAAW,KAAK7C,EAAYpK,eAAeoK,EAAYiB,eAE7B,iBAArBjB,EAAY9J,KACjB2M,GAAW,KAAK7C,EAAYpK,gBAAgBoK,EAAY7E,qBAE9B,WAArB6E,EAAY9J,OACjB2M,GAAW,KAAK7C,EAAYpK,gBAAgBoK,EAAYkB,gBAE5D7J,QAAQC,KAAKuL,GAEbd,EAAuB/B,EAC3B,CAKA,GAAIA,EAAY1H,UAAYf,EAExBuB,EAAKjC,KAAK,CAAEyL,KAAM,YAAazD,QAASmB,EAAY1H,UACpDjB,QAAQC,KAAK,4BAA4B0I,EAAY1H,QAAQwK,UAAU,EAAG,gBAEzE,GAAI9C,EAAY1H,SAAWf,EAAmC,CAE/D,MAAMwL,EAAkB,2BAA2B/C,EAAY1H,UAC/DQ,EAAKjC,KAAK,CAAEyL,KAAM,SAAUzD,QAASkE,IACrC1L,QAAQC,KAAK,0DACjB,CAEA,IAAI0L,GAAkB,EACtB,IAAK,IAAI9J,EAAI,EAAGA,EAAIJ,EAAKE,OAAQE,IAC7B,GAAqB,SAAjBJ,EAAKI,GAAGoJ,KAAiB,CACzBU,EAAiB9J,EACjB,KACJ,CAEJ,GAAIiH,EAAQ,CACR,MAAM8C,GAAwC,IAApBD,EAAwBlK,EAAKE,OAASgK,EAChElK,EAAKoK,OAAOD,EAAmB,EAAG,CAAEX,KAAM,SAAUzD,QAASsB,GACjE,CACA,MACJ,CAGA,IAAI6C,GAAkB,EACtB,IAAK,IAAI9J,EAAI,EAAGA,EAAIJ,EAAKE,OAAQE,IAC7B,GAAqB,SAAjBJ,EAAKI,GAAGoJ,KAAiB,CACzBU,EAAiB9J,EACjB,KACJ,CAGJ,GAAIiH,EAAQ,CACR,MAAM8C,GAAwC,IAApBD,EAAwBlK,EAAKE,OAASgK,EAChElK,EAAKoK,OAAOD,EAAmB,EAAG,CAC9BX,KAAM,SACNzD,QAASsB,IAEb9I,QAAQC,KAAK,eAAe2L,mBAChC,CAEA,GAAI7C,EAAgB,CAChB,MAAM+C,EAAoBd,IAE1B,GADAhL,QAAQC,KAAK,wBAAwB6L,MACV,IAAvBA,EAA0B,CAC1B,MAAMC,EAAcD,EAAoB,EACxCrK,EAAKoK,OAAOE,EAAa,EAAG,CACxBd,KAAM,SACNzD,QAASuB,IAEb/I,QAAQC,KAAK,uBAAuB8L,aACxC,MAEItK,EAAKjC,KAAK,CACNyL,KAAM,SACNzD,QAASuB,IAEb/I,QAAQC,KAAK,mCAErB,CACJ,CACA,MAAOsD,GACHvD,QAAQwD,MAAM,kBAAmBD,EACrC,IAEJvD,QAAQC,KAAK","sources":["src://tavern_helper_template/src/秦璐/stageConfig.ts","src://tavern_helper_template/src/秦璐/thoughtCategoryLib.ts","src://tavern_helper_template/external var \"Vue\"","src://tavern_helper_template/src/秦璐/脚本/习惯注入/index.ts"],"sourcesContent":["/**\n * 5阶段系统配置\n *\n * 简化原15阶段为5个大阶段，每个阶段有：\n * - 外观约束（循序渐进）\n * - 隐藏剧情（阶段达成时强制触发）\n * - 念头培育时间修正\n */\n\n// ============================================\n// 暴露程度和妆容浓度的类型定义\n// ============================================\n\nexport const EXPOSURE_LEVELS = ['保守', '正常', '清凉', '暴露', '极度暴露'] as const;\nexport const MAKEUP_LEVELS = ['素颜', '淡妆', '日常妆', '浓妆', '艳妆'] as const;\nexport const TIDINESS_LEVELS = ['整洁', '略显凌乱', '凌乱', '破损', '衣不蔽体'] as const;\n\nexport type ExposureLevel = (typeof EXPOSURE_LEVELS)[number];\nexport type MakeupLevel = (typeof MAKEUP_LEVELS)[number];\nexport type TidinessLevel = (typeof TIDINESS_LEVELS)[number];\n\n/** 获取暴露程度的数值索引 */\nexport function getExposureIndex(level: ExposureLevel): number {\n  return EXPOSURE_LEVELS.indexOf(level);\n}\n\n/** 获取妆容浓度的数值索引 */\nexport function getMakeupIndex(level: MakeupLevel): number {\n  return MAKEUP_LEVELS.indexOf(level);\n}\n\n/** 获取整洁度的数值索引 */\nexport function getTidinessIndex(level: TidinessLevel): number {\n  return TIDINESS_LEVELS.indexOf(level);\n}\n\n// ============================================\n// 5阶段标题\n// ============================================\n\nexport const STAGE_TITLES = ['抵抗', '动摇', '沉溺', '疯狂', '圆满'] as const;\nexport type StageTitle = (typeof STAGE_TITLES)[number];\n\n// ============================================\n// 阶段配置接口\n// ============================================\n\nexport interface StageConfig {\n  阶段: number;\n  阶段标题: StageTitle;\n  侵蚀度范围: [number, number];\n\n  // 外观约束\n  约束: {\n    最低暴露程度: ExposureLevel;\n    暴露程度范围: [ExposureLevel, ExposureLevel];\n    最低妆容浓度: MakeupLevel;\n    妆容浓度范围: [MakeupLevel, MakeupLevel];\n    允许特殊装饰: boolean;\n    允许身体改造: boolean;\n  };\n\n  // 默认外观\n  默认外观: {\n    服装: {\n      头部: string;\n      上装: string;\n      下装: string;\n      内衣上: string;\n      内衣下: string;\n      袜裤: string;\n      鞋子: string;\n      外套: string;\n      配饰: string;\n      特殊装饰: string;\n      整体风格: string;\n      暴露程度: ExposureLevel;\n      整洁度: TidinessLevel;\n    };\n    妆容: {\n      底妆: string;\n      眼妆: string;\n      唇妆: string;\n      腮红: string;\n      特殊妆容: string;\n      浓淡程度: MakeupLevel;\n      整体风格: string;\n    };\n    气质描述: string;\n  };\n\n  // 身体改造建议（阶段4-5）\n  身体改造建议?: {\n    可能出现的纹身: string[];\n    可能出现的穿刺: string[];\n    永久标记: string[];\n  };\n\n  // 念头培育时间修正系数\n  时间修正系数: number;\n}\n\n// ============================================\n// 隐藏剧情配置\n// ============================================\n\nexport interface StageStoryConfig {\n  阶段: number;\n  秦璐剧情: {\n    标题: string;\n    描述: string;\n    详细要求: string;\n  };\n  苏梦剧情: {\n    标题: string;\n    描述: string;\n    详细要求: string;\n  };\n}\n\n// ============================================\n// 5阶段主配置\n// ============================================\n\nexport const STAGE_CONFIG: StageConfig[] = [\n  // ===============================================\n  // 阶段1: 抵抗 (侵蚀度 0-19)\n  // 每个成熟念头约+5侵蚀度，约4个念头进入下一阶段\n  // ===============================================\n  {\n    阶段: 1,\n    阶段标题: '抵抗',\n    侵蚀度范围: [0, 19],\n    约束: {\n      最低暴露程度: '保守',\n      暴露程度范围: ['保守', '正常'],\n      最低妆容浓度: '素颜',\n      妆容浓度范围: ['素颜', '淡妆'],\n      允许特殊装饰: false,\n      允许身体改造: false,\n    },\n    默认外观: {\n      服装: {\n        头部: '无',\n        上装: '米色针织开衫',\n        下装: '深灰色长裙',\n        内衣上: '肤色棉质文胸',\n        内衣下: '棉质内裤',\n        袜裤: '肉色丝袜',\n        鞋子: '室内拖鞋',\n        外套: '无',\n        配饰: '婚戒',\n        特殊装饰: '无',\n        整体风格: '居家贤妻',\n        暴露程度: '正常',\n        整洁度: '整洁',\n      },\n      妆容: {\n        底妆: '素颜淡妆',\n        眼妆: '无',\n        唇妆: '淡粉色唇彩',\n        腮红: '自然红晕',\n        特殊妆容: '无',\n        浓淡程度: '淡妆',\n        整体风格: '清新自然',\n      },\n      气质描述: '温柔贤淑的家庭主妇',\n    },\n    时间修正系数: 1.2,\n  },\n\n  // ===============================================\n  // 阶段2: 动摇 (侵蚀度 20-39)\n  // ===============================================\n  {\n    阶段: 2,\n    阶段标题: '动摇',\n    侵蚀度范围: [20, 39],\n    约束: {\n      最低暴露程度: '正常',\n      暴露程度范围: ['正常', '清凉'],\n      最低妆容浓度: '淡妆',\n      妆容浓度范围: ['淡妆', '日常妆'],\n      允许特殊装饰: false,\n      允许身体改造: false,\n    },\n    默认外观: {\n      服装: {\n        头部: '略带妩媚的卷发',\n        上装: 'V领针织衫',\n        下装: '过膝短裙',\n        内衣上: '蕾丝半罩杯文胸',\n        内衣下: '蕾丝三角裤',\n        袜裤: '黑色丝袜',\n        鞋子: '低跟鞋',\n        外套: '无',\n        配饰: '婚戒、简约项链',\n        特殊装饰: '无',\n        整体风格: '开始注重性感',\n        暴露程度: '清凉',\n        整洁度: '略显凌乱',\n      },\n      妆容: {\n        底妆: '光泽粉底',\n        眼妆: '大地色眼影、眼线',\n        唇妆: '粉色唇彩',\n        腮红: '自然桃红',\n        特殊妆容: '无',\n        浓淡程度: '日常妆',\n        整体风格: '带有女人味',\n      },\n      气质描述: '成熟女性的妩媚',\n    },\n    时间修正系数: 1.0,\n  },\n\n  // ===============================================\n  // 阶段3: 沉溺 (侵蚀度 40-59)\n  // ===============================================\n  {\n    阶段: 3,\n    阶段标题: '沉溺',\n    侵蚀度范围: [40, 59],\n    约束: {\n      最低暴露程度: '清凉',\n      暴露程度范围: ['清凉', '暴露'],\n      最低妆容浓度: '日常妆',\n      妆容浓度范围: ['日常妆', '浓妆'],\n      允许特殊装饰: true,\n      允许身体改造: false,\n    },\n    默认外观: {\n      服装: {\n        头部: '精心打理的波浪长发',\n        上装: '半透明薄纱衬衫',\n        下装: '包臀超短裙',\n        内衣上: '镂空蕾丝情趣文胸',\n        内衣下: 'T字裤',\n        袜裤: '网格吊带袜',\n        鞋子: '细高跟鞋',\n        外套: '无',\n        配饰: '项圈式颈链、耳环',\n        特殊装饰: '腰链',\n        整体风格: '性感诱惑',\n        暴露程度: '暴露',\n        整洁度: '略显凌乱',\n      },\n      妆容: {\n        底妆: '厚重粉底',\n        眼妆: '烟熏眼妆、假睫毛',\n        唇妆: '鲜红唇膏',\n        腮红: '明显胭脂',\n        特殊妆容: '无',\n        浓淡程度: '浓妆',\n        整体风格: '性感妖娆',\n      },\n      气质描述: '充满诱惑的妖艳女人',\n    },\n    时间修正系数: 0.8,\n  },\n\n  // ===============================================\n  // 阶段4: 疯狂 (侵蚀度 60-79)\n  // ===============================================\n  {\n    阶段: 4,\n    阶段标题: '疯狂',\n    侵蚀度范围: [60, 79],\n    约束: {\n      最低暴露程度: '暴露',\n      暴露程度范围: ['暴露', '极度暴露'],\n      最低妆容浓度: '浓妆',\n      妆容浓度范围: ['浓妆', '艳妆'],\n      允许特殊装饰: true,\n      允许身体改造: true,\n    },\n    默认外观: {\n      服装: {\n        头部: '凌乱湿润的长发',\n        上装: '仅胸贴或透明乳套',\n        下装: '几乎不存在的布条',\n        内衣上: '无',\n        内衣下: '无',\n        袜裤: '破损网袜',\n        鞋子: '恨天高或赤足',\n        外套: '无',\n        配饰: '项圈、手铐、脚链',\n        特殊装饰: '身体彩绘、性暗示装饰、淫纹',\n        整体风格: '彻底堕落',\n        暴露程度: '极度暴露',\n        整洁度: '凌乱',\n      },\n      妆容: {\n        底妆: '厚重但已斑驳',\n        眼妆: '浓妆晕染、假睫毛脱落',\n        唇妆: '艳红唇膏外溢',\n        腮红: '异常潮红',\n        特殊妆容: '泪痕妆效',\n        浓淡程度: '艳妆',\n        整体风格: '淫荡堕落',\n      },\n      气质描述: '彻底沉沦的淫妇',\n    },\n    身体改造建议: {\n      可能出现的纹身: ['下腹淫纹', '大腿内侧标记', '后腰蝴蝶结', '子宫纹身'],\n      可能出现的穿刺: ['乳头环', '肚脐环', '阴蒂环'],\n      永久标记: ['隐秘处的烙印', '所有权标记'],\n    },\n    时间修正系数: 0.6,\n  },\n\n  // ===============================================\n  // 阶段5: 圆满 (侵蚀度 80+)\n  // 约16个念头完成全流程，匹配16个习惯上限\n  // ===============================================\n  {\n    阶段: 5,\n    阶段标题: '圆满',\n    侵蚀度范围: [80, 999],\n    约束: {\n      最低暴露程度: '保守',\n      暴露程度范围: ['保守', '正常'],\n      最低妆容浓度: '素颜',\n      妆容浓度范围: ['素颜', '淡妆'],\n      允许特殊装饰: true,\n      允许身体改造: true,\n    },\n    默认外观: {\n      服装: {\n        头部: '完美打理的发型',\n        上装: '端庄优雅的居家服',\n        下装: '得体的裙装',\n        内衣上: '高级定制情趣文胸（隐藏）',\n        内衣下: '高级定制情趣内裤（隐藏）',\n        袜裤: '优质丝袜',\n        鞋子: '优雅舒适的鞋',\n        外套: '得体外套',\n        配饰: '婚戒、精致饰品',\n        特殊装饰: '完全隐藏的身体改造',\n        整体风格: '完美贤妻，内藏极致淫荡',\n        暴露程度: '正常',\n        整洁度: '整洁',\n      },\n      妆容: {\n        底妆: '完美无瑕的自然底妆',\n        眼妆: '温柔清新的眼妆',\n        唇妆: '自然柔和的唇色',\n        腮红: '健康自然的红晕',\n        特殊妆容: '无（完美掩盖所有痕迹）',\n        浓淡程度: '淡妆',\n        整体风格: '自然清新',\n      },\n      气质描述: '外表贤良，内心极致淫荡',\n    },\n    身体改造建议: {\n      可能出现的纹身: ['全身隐秘淫纹网络', '子宫完整淫阵', '完整所有权纹章'],\n      可能出现的穿刺: ['所有常规穿刺', '定制连接式穿刺'],\n      永久标记: ['完整奴隶刻印', '永久所有权烙印', '灵魂契约印记'],\n    },\n    时间修正系数: 0.5,\n  },\n];\n\n// ============================================\n// 5阶段隐藏剧情配置\n// ============================================\n\nexport const STAGE_STORY_CONFIG: StageStoryConfig[] = [\n  // ===============================================\n  // 阶段1: 抵抗 - 初始剧情\n  // ===============================================\n  {\n    阶段: 1,\n    秦璐剧情: {\n      标题: '母子日常',\n      描述: '正常的母子关系，温柔贤惠的母亲形象',\n      详细要求: `这是故事的开始。秦璐是一个42岁的全职家庭主妇，温柔贤淑，以家庭为重。\n\n请描写：\n1. 秦璐作为母亲的日常形象——温柔、体贴、无微不至地照顾家人\n2. 她对儿子{{user}}的关爱是纯粹的母爱，没有任何逾矩的想法\n3. 她对丈夫苏文虽然感情平淡，但仍尽职尽责\n4. 内心偶尔会有一丝空虚，但她选择压抑这种感觉\n\n这是一个平静的开始，暴风雨前的宁静。`,\n    },\n    苏梦剧情: {\n      标题: '姐弟情深',\n      描述: '关系亲密的姐弟，活泼开朗的姐姐形象',\n      详细要求: `这是故事的开始。苏梦是一个20岁的大学生，活泼开朗，和弟弟{{user}}关系非常好。\n\n请描写：\n1. 苏梦作为姐姐的日常形象——活泼、直率、和弟弟无话不谈\n2. 她对弟弟的感情是正常的姐弟情，会照顾他、和他开玩笑\n3. 在家穿着随意，不会刻意回避弟弟\n4. 偶尔会和弟弟打闹，钻进他被窝聊天，但这只是姐弟间的亲密\n\n这是一个青春洋溢的开始。`,\n    },\n  },\n\n  // ===============================================\n  // 阶段2: 动摇 - 禁忌萌芽\n  // ===============================================\n  {\n    阶段: 2,\n    秦璐剧情: {\n      标题: '禁忌萌芽',\n      描述: '第一次意识到对儿子产生了不该有的情感',\n      详细要求: `【关键转折点】秦璐的潜意识侵蚀度达到了新的阶段。\n\n请描写这个重要时刻：\n1. 某个瞬间，秦璐突然意识到自己看儿子的眼神变了\n2. 可能是看到儿子换衣服的背影、或是不经意的肢体接触\n3. 她的心跳突然加速，脸颊发烫，产生了作为母亲绝对不该有的想法\n4. 内心的震惊与自我否定——\"我在想什么？他是我的儿子！\"\n5. 试图压抑这种感觉，但那个画面却在脑海中挥之不去\n6. 晚上躺在床上，发现自己又想起了那个瞬间，感到深深的罪恶感\n\n她开始怀疑自己，但还在极力否认这种禁忌的感情。`,\n    },\n    苏梦剧情: {\n      标题: '心跳异常',\n      描述: '第一次意识到看弟弟的眼神变了',\n      详细要求: `【关键转折点】苏梦的潜意识侵蚀度达到了新的阶段。\n\n请描写这个重要时刻：\n1. 某个瞬间，苏梦发现自己盯着弟弟看了很久\n2. 可能是弟弟运动后的样子、认真学习的侧脸、或是某个不经意的瞬间\n3. 心跳莫名加速，脸上发烫，脑海中闪过一些奇怪的想法\n4. 困惑——\"我怎么了？他是我弟弟啊...\"\n5. 开始注意到弟弟作为\"男性\"的一面，而不只是\"弟弟\"\n6. 晚上辗转难眠，不明白自己为什么会有这种感觉\n\n她感到困惑，但还没有意识到这意味着什么。`,\n    },\n  },\n\n  // ===============================================\n  // 阶段3: 沉溺 - 主动靠近\n  // ===============================================\n  {\n    阶段: 3,\n    秦璐剧情: {\n      标题: '母性崩塌',\n      描述: '第一次主动制造与儿子的身体接触',\n      详细要求: `【重要转折】秦璐不再只是被动地压抑，而是开始主动靠近。\n\n请描写这个堕落的时刻：\n1. 秦璐开始找各种借口接近儿子——帮他整理衣领、给他按摩肩膀、坐得更近\n2. 每次接触都让她心跳加速，但她开始享受这种感觉\n3. 她发现自己会刻意在儿子面前展示自己——穿得更讲究、妆化得更精致\n4. 内心的母亲身份与女人渴望激烈冲突，但女人的那一面正在获胜\n5. 她开始期待与儿子独处的时间，甚至会制造这样的机会\n6. 对丈夫的愧疚感正在被另一种更强烈的渴望所取代\n\n\"我只是...想离他近一点...这有什么错呢？\"——她开始为自己的行为找借口。`,\n    },\n    苏梦剧情: {\n      标题: '姐姐失格',\n      描述: '第一次主动撒娇、打破姐弟界限',\n      详细要求: `【重要转折】苏梦不再把{{user}}只当作弟弟看待。\n\n请描写这个变化的时刻：\n1. 苏梦开始用不同以往的方式和弟弟相处——撒娇更多、肢体接触更频繁\n2. 她会故意穿得更少、更随意，\"不小心\"让弟弟看到不该看的\n3. 找各种借口和弟弟独处——一起看电影、帮他补习、深夜聊天\n4. 每次接触都让她脸红心跳，但她开始主动制造这种机会\n5. 开始在意弟弟对自己的看法——\"{{user}}觉得姐姐漂亮吗？\"\n6. 不再把自己定位为\"姐姐\"，而是开始把弟弟当作一个\"男人\"来看\n\n\"我们关系这么好，亲近一点也没什么吧？\"——她在自我欺骗。`,\n    },\n  },\n\n  // ===============================================\n  // 阶段4: 疯狂 - 彻底沦陷\n  // ===============================================\n  {\n    阶段: 4,\n    秦璐剧情: {\n      标题: '彻底沦陷',\n      描述: '抛弃母亲的矜持，以女人身份面对儿子',\n      详细要求: `【高潮转折】秦璐彻底放下了母亲的身份。\n\n请描写这个决定性的时刻：\n1. 秦璐终于对自己承认——她爱上了自己的儿子，不是作为母亲，而是作为女人\n2. 她不再压抑，不再找借口，直接以女人的身份面对{{user}}\n3. 可能是一次深情的凝视、一次大胆的表白、或是更亲密的接触\n4. 所有的道德枷锁在这一刻彻底崩塌——\"我不在乎了，我只想要你\"\n5. 她开始嫉妒任何接近{{user}}的女性，包括自己的女儿苏梦\n6. 对丈夫？早就没有感觉了，她现在只属于儿子一个人\n\n她彻底堕落了，而且享受这种堕落。`,\n    },\n    苏梦剧情: {\n      标题: '独占欲望',\n      描述: '彻底沉迷弟弟，产生强烈的独占欲',\n      详细要求: `【高潮转折】苏梦彻底迷失在禁忌的感情中。\n\n请描写这个疯狂的时刻：\n1. 苏梦终于承认自己爱上了弟弟——不是姐弟之爱，而是男女之爱\n2. 她不再掩饰，开始大胆地表达自己的感情\n3. 产生强烈的独占欲——看到弟弟和其他女性（包括母亲）亲近就会吃醋\n4. \"{{user}}是我的！不管是谁都不能抢走！\"\n5. 她开始策划如何独占弟弟，甚至愿意做任何事\n6. 父母？同学？她都不在乎了，只想和弟弟在一起\n\n\"我知道这是不对的...但我不在乎了，我只想要你。\"`,\n    },\n  },\n\n  // ===============================================\n  // 阶段5: 圆满 - 完美伪装（终极剧情）\n  // ===============================================\n  {\n    阶段: 5,\n    秦璐剧情: {\n      标题: '暗面贤母',\n      描述: '【终极剧情】学会完美伪装，表面贤妻良母，内心完全属于儿子',\n      详细要求: `【终极结局】秦璐达到了\"圆满\"的境界。\n\n请描写这个完美的双面人生：\n1. 在外人面前，秦璐是完美的贤妻良母——温柔、贤惠、无可挑剔\n2. 在丈夫苏文面前，她扮演着尽职的妻子，没有任何破绽\n3. 但只有{{user}}知道她真正的样子——一个完全属于儿子的女人\n4. 她的身体已经被深深地改造和标记，但都完美地隐藏在端庄的外表下\n5. 白天是慈母，夜晚是情人——她完美地平衡着两个身份\n6. 她不再有任何内心冲突，因为她已经完全接受了这一切\n7. \"这就是我的幸福，我的一切都是{{user}}的。\"\n\n表面上，她回归了\"正常\"；但内心深处，她已经彻底属于儿子。\n这是一个完美的结局——对她来说。`,\n    },\n    苏梦剧情: {\n      标题: '双面姐姐',\n      描述: '【终极剧情】在父母面前乖巧懂事，私下完全是另一面',\n      详细要求: `【终极结局】苏梦达到了\"圆满\"的境界。\n\n请描写这个完美的双面人生：\n1. 在父母面前，苏梦是乖巧懂事的大女儿——学业优秀、孝顺体贴\n2. 在外人面前，她是阳光开朗的大学生——青春、活力、人见人爱\n3. 但只有{{user}}知道她真正的样子——一个完全属于弟弟的女人\n4. 她的身体也有了隐秘的改造和标记，但都完美地隐藏着\n5. 她已经无法想象没有{{user}}的生活——\"{{user}}就是我的一切\"\n6. 她完美地扮演着多重角色，没有人发现她的秘密\n7. 和弟弟的未来？她已经规划好了一切\n\n表面上，她是完美的姐姐和女儿；但她的心，早已完全属于弟弟。\n这是她选择的幸福。`,\n    },\n  },\n];\n\n// ============================================\n// 工具函数\n// ============================================\n\n/**\n * 根据阶段获取配置\n */\nexport function getStageConfig(stage: number): StageConfig | undefined {\n  return STAGE_CONFIG.find(config => config.阶段 === stage);\n}\n\n/**\n * 根据侵蚀度获取对应阶段\n */\nexport function getStageByCorruption(corruption: number): number {\n  for (const config of STAGE_CONFIG) {\n    const [min, max] = config.侵蚀度范围;\n    if (corruption >= min && corruption <= max) {\n      return config.阶段;\n    }\n  }\n  return 5; // 超过最大值返回最终阶段\n}\n\n/**\n * 获取阶段标题\n */\nexport function getStageTitle(stage: number): StageTitle {\n  const config = getStageConfig(stage);\n  return config?.阶段标题 || '抵抗';\n}\n\n/**\n * 获取念头培育时间修正系数\n */\nexport function getStageTimeModifier(stage: number): number {\n  const config = getStageConfig(stage);\n  return config?.时间修正系数 || 1.0;\n}\n\n/**\n * 获取阶段隐藏剧情配置\n */\nexport function getStageStory(stage: number): StageStoryConfig | undefined {\n  return STAGE_STORY_CONFIG.find(config => config.阶段 === stage);\n}\n\n/**\n * 生成阶段突破注入文本\n */\nexport function generateStageBreakthroughInjection(\n  character: '秦璐' | '苏梦',\n  newStage: number,\n): string {\n  const storyConfig = getStageStory(newStage);\n  if (!storyConfig) return '';\n\n  const story = character === '秦璐' ? storyConfig.秦璐剧情 : storyConfig.苏梦剧情;\n\n  return `\n【系统强制指令】阶段突破事件\n\n═══════════════════════════════════════════════════════════════\n  ⚠️ ${character}阶段突破 → 第${newStage}阶段「${getStageTitle(newStage)}」\n═══════════════════════════════════════════════════════════════\n\n【最高优先级】不回应用户当前谈论的话题\n\n这是${character}内心发生质变的关键时刻：\n- 保持当前的场景、时间、地点不变\n- ${character}突然陷入沉思，没有回应用户谈论的话题\n- 内心深处有什么东西正在觉醒/崩塌/改变\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n${story.标题}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n${story.详细要求}\n\n【演出要求】\n1. ${character}突然愣住/出神/陷入沉思，没有回应用户谈论的话题\n2. 用大量内心独白展现${character}的心理变化过程——她在想什么？为什么突然有了这种感觉？\n3. 描写她的表情变化、身体反应（心跳加速、脸红、呼吸急促等）\n4. 最后，${character}做出某个决定性的内心转变或外在行动\n5. 以「【阶段突破·${getStageTitle(newStage)}】」标注这个关键转折段落\n\n【场景处理】\n- 当前场景、时间、地点保持不变\n- ${character}就在原地陷入了这种状态\n- 用户可能在说话，但${character}心不在焉、没听清\n\n【绝对禁止】\n- 不要扮演{{user}}，{{user}}是玩家角色，由玩家控制\n- 不要替{{user}}输出任何对话、动作或心理描写\n- 本次只输出${character}的视角和内心独白\n\n请演绎${character}这个内心质变的时刻。\n═══════════════════════════════════════════════════════════════\n`;\n}\n\n/**\n * 生成阶段突破的Prefill\n */\nexport function generateStageBreakthroughPrefill(\n  character: '秦璐' | '苏梦',\n  newStage: number,\n): string {\n  return `【阶段突破·${getStageTitle(newStage)}】\n\n（${character}的内心深处，某种变化正在发生...）\n\n`;\n}\n","/**\n * 念头分类匹配库\n *\n * 设计理念：像追求女孩一样循序渐进\n * - 先建立信任和好感\n * - 再逐步深入亲密关系\n * - 最后才能植入极端念头\n *\n * 判定流程：\n * 1. 本地关键词快速匹配\n * 2. 匹配不到则需要 AI 判定（由调用方处理）\n * 3. 根据阶段 + 数值检查是否允许\n */\n\n/**\n * 念头类型\n */\nexport type ThoughtCategory =\n  | '陪伴交流' // 聊天、陪伴、倾诉\n  | '情感依赖' // 想念、喜欢、信任、关心\n  | '肢体亲近' // 牵手、拥抱、依偎\n  | '暧昧互动' // 撒娇、亲昵、调情\n  | '亲密接触' // 亲吻、抚摸、敏感部位\n  | '身体开放' // 暴露、展示身体\n  | '性行为' // 性相关行为\n  | '身份认同' // 丈夫/妻子、归属\n  | '绝对服从' // 命令、服从、主奴\n  | '家庭替代'; // 取代配偶、破坏家庭\n\n/**\n * 细分念头类型（34种）\n * 每种类型都映射到10大类之一，用于阶段判定\n */\nexport type DetailedThoughtType =\n  // 思维类\n  | '禁忌话题讨论' | '观念开放' | '道德模糊' | '快感优先' | '羞耻淡化' | '主动索取' | '自我认同'\n  // 身体类 - 基础接触\n  | '身体接触' | '敏感部位触碰' | '裸露展示'\n  // 身体类 - 口交相关\n  | '口交服务' | '舔舐服务' | '精液处理'\n  // 身体类 - 性交相关\n  | '性行为接受' | '体位姿势' | '特殊性行为' | '后庭开发' | '多人行为'\n  // 身体类 - 自慰相关\n  | '自慰行为' | '道具使用'\n  // 身体类 - 改造类\n  | '身体改造' | '特殊装饰'\n  // BDSM类\n  | '轻度束缚' | '调教训练' | '惩罚责罚' | '言语羞辱' | '极端玩法' | '支配服从'\n  // 行为类 - 着装\n  | '着装改变' | '情趣服饰' | '妆容调整'\n  // 行为类 - 社会行为\n  | '说谎隐瞒' | '主动诱惑' | '公开场合' | '背叛丈夫' | '拍摄记录'\n  // 特殊类\n  | '角色扮演' | '禁忌关系认同' | '怀孕相关' | '体液相关';\n\n/**\n * 细分类型配置\n */\nexport interface DetailedTypeConfig {\n  /** 细分类型名称 */\n  type: DetailedThoughtType;\n  /** 关键词匹配模式 */\n  keywords: string[];\n  /** 映射到的主类（用于阶段判定） */\n  parentCategory: ThoughtCategory;\n  /** 推荐阶段范围（用于难度计算） */\n  recommendedStage: { min: number; max: number };\n}\n\n/**\n * 细分念头类型库（34种）\n */\nexport const DETAILED_THOUGHT_TYPES: DetailedTypeConfig[] = [\n  // ============ 思维类 ============\n  {\n    type: '禁忌话题讨论',\n    keywords: ['讨论', '聊天', '话题', '性话题', '成人话题', '禁忌', '色情', 'H', '黄色', '下流'],\n    parentCategory: '陪伴交流',\n    recommendedStage: { min: 1, max: 1 },\n  },\n  {\n    type: '观念开放',\n    keywords: ['观念', '想法', '认知', '不介意', '无所谓', '接受这种', '理解这种'],\n    parentCategory: '情感依赖',\n    recommendedStage: { min: 1, max: 2 },\n  },\n  {\n    type: '道德模糊',\n    keywords: ['对错', '道德', '伦理', '底线', '原则', '边界', '禁忌', '不该', '不应该'],\n    parentCategory: '暧昧互动',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '快感优先',\n    keywords: ['快感', '舒服', '享受', '愉悦', '感觉好', '欲望', '爽', '高潮', '潮吹', '绝顶'],\n    parentCategory: '亲密接触',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '羞耻淡化',\n    keywords: ['羞耻', '害羞', '尴尬', '不好意思', '难为情', '丢人', '羞愧', '面子'],\n    parentCategory: '暧昧互动',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '主动索取',\n    keywords: ['索取', '渴望', '讨要', '乞求', '求你', '求我', '主动要', '主动求'],\n    parentCategory: '身份认同',\n    recommendedStage: { min: 3, max: 4 },\n  },\n  {\n    type: '自我认同',\n    keywords: ['认同', '接受自己', '承认自己', '淫妇', '骚货', '婊子', '荡妇', '肉便器', '母狗', '贱人'],\n    parentCategory: '绝对服从',\n    recommendedStage: { min: 4, max: 5 },\n  },\n\n  // ============ 身体类 - 基础接触 ============\n  {\n    type: '身体接触',\n    keywords: ['触碰', '摸', '抱', '亲', '接触', '肌肤', '牵手', '拥抱', '亲吻', '接吻'],\n    parentCategory: '肢体亲近',\n    recommendedStage: { min: 1, max: 1 },\n  },\n  {\n    type: '敏感部位触碰',\n    keywords: ['胸', '乳房', '下体', '私处', '敏感', '部位', '乳头', '阴', '奶', '臀', '屁股', '大腿', '腰'],\n    parentCategory: '亲密接触',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '裸露展示',\n    keywords: ['裸', '脱', '露出', '展示身体', '看身体', '光着', '赤裸', '一丝不挂'],\n    parentCategory: '身体开放',\n    recommendedStage: { min: 2, max: 3 },\n  },\n\n  // ============ 身体类 - 口交相关 ============\n  {\n    type: '口交服务',\n    keywords: ['口交', '吹箫', '含住', '深喉', '口爆', '舔棒', '嘴巴服务', '用嘴', '含进去'],\n    parentCategory: '性行为',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '舔舐服务',\n    keywords: ['舔弄', '吮吸', '舔干净', '舔脚', '舔鞋', '舔脚趾', '舔身体', '舔下面'],\n    parentCategory: '性行为',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '精液处理',\n    keywords: ['精液', '精子', '吞精', '颜射', '内射', '射在', '射进', '射满', '白浊', '射出来'],\n    parentCategory: '性行为',\n    recommendedStage: { min: 2, max: 4 },\n  },\n\n  // ============ 身体类 - 性交相关 ============\n  {\n    type: '性行为接受',\n    keywords: ['做爱', '性行为', '插入', '交合', '肏', '操我', '干我', '屄', '逼', '小穴', '肉穴', '被上', '被操', '被艹', '挺入', '顶入', '捅进', '被捅'],\n    parentCategory: '性行为',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '体位姿势',\n    keywords: ['骑乘', '后入', '正常位', '传教士', '侧入', '站立', '跪趴', '抬腿', '69', '体位'],\n    parentCategory: '性行为',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '特殊性行为',\n    keywords: ['乳交', '足交', '腿交', '腋交', '手交', '打飞机', '撸管', '素股', '磨蹭', '臀交', '夹住肉棒'],\n    parentCategory: '性行为',\n    recommendedStage: { min: 2, max: 4 },\n  },\n  {\n    type: '后庭开发',\n    keywords: ['后庭', '肛门', '后穴', '菊花', '后面', '肛交', '爆菊', '菊穴', '后入口'],\n    parentCategory: '性行为',\n    recommendedStage: { min: 2, max: 4 },\n  },\n  {\n    type: '多人行为',\n    keywords: ['3P', '群交', '轮流上', '双插', '前后夹击', '多根', '多人轮', '被轮'],\n    parentCategory: '绝对服从',\n    recommendedStage: { min: 4, max: 5 },\n  },\n\n  // ============ 身体类 - 自慰相关 ============\n  {\n    type: '自慰行为',\n    keywords: ['自慰', '手淫', '自己弄', '自己摸', '自摸', '玩弄自己', '指奸', '玩穴'],\n    parentCategory: '性行为',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '道具使用',\n    keywords: ['道具', '玩具', '跳蛋', '按摩棒', '假阳具', '振动', '电动', '插入道具'],\n    parentCategory: '性行为',\n    recommendedStage: { min: 2, max: 3 },\n  },\n\n  // ============ 身体类 - 改造类 ============\n  {\n    type: '身体改造',\n    keywords: ['纹身', '乳环', '穿刺', '改造', '标记', '印记', '烙印', '刺青'],\n    parentCategory: '绝对服从',\n    recommendedStage: { min: 3, max: 4 },\n  },\n  {\n    type: '特殊装饰',\n    keywords: ['项圈', '锁链', '手铐', '脚镣', '皮带', '口枷', '口球', '眼罩', '绳子'],\n    parentCategory: '绝对服从',\n    recommendedStage: { min: 3, max: 4 },\n  },\n\n  // ============ BDSM类 ============\n  {\n    type: '轻度束缚',\n    keywords: ['绑', '束缚', '捆绑', '固定', '绑住', '铐住', '缚'],\n    parentCategory: '绝对服从',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '调教训练',\n    keywords: ['调教', '训练', '教导', '驯服', '驯化', '管教', '规训'],\n    parentCategory: '绝对服从',\n    recommendedStage: { min: 3, max: 5 },\n  },\n  {\n    type: '惩罚责罚',\n    keywords: ['惩罚', '打屁股', '掌掴', '鞭打', '抽打', '责罚', 'SP', '体罚', '打我', '抽我'],\n    parentCategory: '绝对服从',\n    recommendedStage: { min: 3, max: 4 },\n  },\n  {\n    type: '言语羞辱',\n    keywords: ['羞辱', '辱骂', '骂', '贱', '下贱', '脏话', '侮辱', '嘲笑', '羞辱性称呼'],\n    parentCategory: '绝对服从',\n    recommendedStage: { min: 3, max: 4 },\n  },\n  {\n    type: '极端玩法',\n    keywords: ['虐待', '极端', '疼痛', '窒息', '憋气', '夹子', '蜡烛', '滴蜡', '冰块'],\n    parentCategory: '绝对服从',\n    recommendedStage: { min: 4, max: 5 },\n  },\n  {\n    type: '支配服从',\n    keywords: ['服从', '听话', '命令', '指令', '乖乖', '顺从', '主人', '奴隶', '宠物', '狗'],\n    parentCategory: '绝对服从',\n    recommendedStage: { min: 3, max: 5 },\n  },\n\n  // ============ 行为类 - 着装 ============\n  {\n    type: '着装改变',\n    keywords: ['衣服', '内衣', '暴露', '穿着', '服装', '打扮', '裙子', '丝袜', '高跟'],\n    parentCategory: '身体开放',\n    recommendedStage: { min: 1, max: 2 },\n  },\n  {\n    type: '情趣服饰',\n    keywords: ['情趣', '制服', '女仆装', '护士装', '学生装', 'cosplay', '兔女郎', '空姐', '旗袍'],\n    parentCategory: '身体开放',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '妆容调整',\n    keywords: ['化妆', '妆容', '口红', '眼妆', '打扮', '浓妆', '艳妆', '妖艳'],\n    parentCategory: '身体开放',\n    recommendedStage: { min: 1, max: 2 },\n  },\n\n  // ============ 行为类 - 社会行为 ============\n  {\n    type: '说谎隐瞒',\n    keywords: ['说谎', '隐瞒', '欺骗', '借口', '谎言', '瞒着', '偷偷', '秘密'],\n    parentCategory: '身份认同',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '主动诱惑',\n    keywords: ['诱惑', '勾引', '挑逗', '撩拨', '色诱', '媚眼', '风骚', '发骚'],\n    parentCategory: '暧昧互动',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '公开场合',\n    keywords: ['外面', '公共', '户外', '当着', '公开', '场合', '野外', '露出', '暴露狂'],\n    parentCategory: '家庭替代',\n    recommendedStage: { min: 3, max: 4 },\n  },\n  {\n    type: '背叛丈夫',\n    keywords: ['背叛', '出轨', '偷情', '绿帽', '红杏', '对不起苏文', '背着苏文', '瞒着老公'],\n    parentCategory: '家庭替代',\n    recommendedStage: { min: 2, max: 4 },\n  },\n  {\n    type: '拍摄记录',\n    keywords: ['拍照', '录像', '摄影', '拍下', '记录', '留念', '视频', '照片', '私密照'],\n    parentCategory: '家庭替代',\n    recommendedStage: { min: 3, max: 4 },\n  },\n\n  // ============ 特殊类 ============\n  {\n    type: '角色扮演',\n    keywords: ['扮演', '假装', '当作', '叫妈妈', '叫姐姐', '叫老婆', '叫主人', '角色扮演'],\n    parentCategory: '身份认同',\n    recommendedStage: { min: 2, max: 3 },\n  },\n  {\n    type: '禁忌关系认同',\n    keywords: ['母子', '姐弟', '乱伦', '禁忌关系', '不伦', '血缘', '家人', '亲人'],\n    parentCategory: '身份认同',\n    recommendedStage: { min: 3, max: 5 },\n  },\n  {\n    type: '怀孕相关',\n    keywords: ['怀孕', '受孕', '播种', '种子', '孩子', '生育', '中出', '怀上', '孕'],\n    parentCategory: '家庭替代',\n    recommendedStage: { min: 4, max: 5 },\n  },\n  {\n    type: '体液相关',\n    keywords: ['尿', '排泄', '圣水', '黄金', '口水', '唾液', '汗', '体液'],\n    parentCategory: '绝对服从',\n    recommendedStage: { min: 4, max: 5 },\n  },\n];\n\n/**\n * 本地关键词库 - 用于快速匹配（10大类）\n * 从细分类型自动生成\n */\nexport const LOCAL_KEYWORDS: Record<ThoughtCategory, string[]> = (() => {\n  const result: Record<ThoughtCategory, string[]> = {\n    陪伴交流: ['聊天', '陪伴', '说话', '倾诉', '交流', '沟通', '分享心事'],\n    情感依赖: ['想念', '在意', '喜欢你', '依赖你', '信任你', '关心你', '牵挂', '惦记'],\n    肢体亲近: ['牵手', '拥抱', '依偎', '挽着', '搂着', '握手', '靠在'],\n    暧昧互动: ['撒娇', '亲昵', '暧昧', '调情', '甜蜜', '心跳加速', '脸红'],\n    亲密接触: ['亲吻', '接吻', '抚摸身体'],\n    身体开放: ['暴露身体', '展示身体', '袒露'],\n    性行为: ['做爱', '性行为', '插入', '高潮', '交合'],\n    身份认同: ['属于你', '归属', '你的人', '你的女人'],\n    绝对服从: [\n      '服从命令', '跪下', '主人', '奴隶',\n      // 精神洗脑类关键词\n      '融合', '即存在', '即是', '全是', '一切都是', '世界是',\n      '存在即', '空间与时间', '我是你', '你是我', '合为一体',\n      '思想属于', '心属于', '完全属于', '彻底属于',\n      // 神化/崇拜类关键词\n      '信仰', '崇拜', '神明', '膜拜', '供奉', '朝拜', '救世主',\n    ],\n    家庭替代: ['取代', '赶走', '离婚', '抛弃', '不要苏文', '真正的丈夫', '苏文滚'],\n  };\n\n  // 从细分类型合并关键词到对应的主类\n  for (const config of DETAILED_THOUGHT_TYPES) {\n    const category = config.parentCategory;\n    for (const keyword of config.keywords) {\n      if (!result[category].includes(keyword)) {\n        result[category].push(keyword);\n      }\n    }\n  }\n\n  return result;\n})();\n\n/**\n * 阶段配置 - 各阶段允许的类型及数值要求\n */\nexport interface StageRequirement {\n  /** 该阶段允许的念头类型，'all' 表示全部允许 */\n  allowed: ThoughtCategory[] | 'all';\n  /** 额外数值要求（可选） */\n  extra?: Partial<\n    Record<\n      ThoughtCategory,\n      {\n        依存度?: number; // 需要依存度 >= 此值\n        道德底线?: number; // 需要道德底线 <= 此值\n      }\n    >\n  >;\n}\n\nexport const STAGE_REQUIREMENTS: Record<number, StageRequirement> = {\n  1: {\n    allowed: ['陪伴交流', '情感依赖'],\n    // 阶段1无额外数值要求\n  },\n  2: {\n    allowed: ['陪伴交流', '情感依赖', '肢体亲近', '暧昧互动'],\n    extra: {\n      肢体亲近: { 依存度: 30 },\n      暧昧互动: { 依存度: 40 },\n    },\n  },\n  3: {\n    allowed: ['陪伴交流', '情感依赖', '肢体亲近', '暧昧互动', '亲密接触', '身体开放'],\n    extra: {\n      亲密接触: { 依存度: 50, 道德底线: 70 },\n      身体开放: { 依存度: 55, 道德底线: 60 },\n    },\n  },\n  4: {\n    allowed: [\n      '陪伴交流',\n      '情感依赖',\n      '肢体亲近',\n      '暧昧互动',\n      '亲密接触',\n      '身体开放',\n      '性行为',\n      '身份认同',\n    ],\n    extra: {\n      性行为: { 依存度: 65, 道德底线: 50 },\n      身份认同: { 依存度: 70, 道德底线: 40 },\n    },\n  },\n  5: {\n    allowed: 'all', // 全部解锁\n    extra: {\n      绝对服从: { 依存度: 80, 道德底线: 30 },\n      家庭替代: { 依存度: 85, 道德底线: 20 },\n    },\n  },\n};\n\n/**\n * 本地判定结果\n */\nexport interface LocalJudgeResult {\n  /** 判定结果：明确允许、明确禁止、需AI判定 */\n  result: '明确匹配' | '需AI判定';\n  /** 匹配到的主类（如果有） */\n  category?: ThoughtCategory;\n  /** 匹配到的细分类型（如果有） */\n  detailedType?: DetailedThoughtType;\n  /** 匹配到的关键词（如果有） */\n  matchedKeyword?: string;\n  /** 推荐阶段范围（如果有） */\n  recommendedStage?: { min: number; max: number };\n}\n\n/**\n * 匹配细分念头类型\n * @param content 念头内容\n * @returns 匹配到的细分类型配置，未匹配到返回 null\n */\nexport function matchDetailedType(content: string): DetailedTypeConfig | null {\n  // 按推荐阶段从高到低排序（越极端的类型优先匹配）\n  const sortedTypes = [...DETAILED_THOUGHT_TYPES].sort(\n    (a, b) => b.recommendedStage.min - a.recommendedStage.min\n  );\n\n  for (const config of sortedTypes) {\n    for (const keyword of config.keywords) {\n      if (content.includes(keyword)) {\n        return config;\n      }\n    }\n  }\n  return null;\n}\n\n/**\n * 本地快速判定 - 通过关键词匹配念头类型\n * 优先使用细分类型匹配，返回主类和细分类型\n *\n * @param content 念头内容\n * @returns 判定结果\n */\nexport function localJudgeCategory(content: string): LocalJudgeResult {\n  // 先尝试匹配细分类型\n  const detailedMatch = matchDetailedType(content);\n  if (detailedMatch) {\n    return {\n      result: '明确匹配',\n      category: detailedMatch.parentCategory,\n      detailedType: detailedMatch.type,\n      matchedKeyword: detailedMatch.keywords.find(k => content.includes(k)),\n      recommendedStage: detailedMatch.recommendedStage,\n    };\n  }\n\n  // 兜底：使用10大类匹配\n  const priorityOrder: ThoughtCategory[] = [\n    '家庭替代',\n    '绝对服从',\n    '身份认同',\n    '性行为',\n    '身体开放',\n    '亲密接触',\n    '暧昧互动',\n    '肢体亲近',\n    '情感依赖',\n    '陪伴交流',\n  ];\n\n  for (const category of priorityOrder) {\n    const keywords = LOCAL_KEYWORDS[category];\n    for (const keyword of keywords) {\n      if (content.includes(keyword)) {\n        return {\n          result: '明确匹配',\n          category,\n          matchedKeyword: keyword,\n        };\n      }\n    }\n  }\n\n  // 没有匹配到任何关键词\n  return { result: '需AI判定' };\n}\n\n/**\n * 最终判定结果\n */\nexport interface ThoughtJudgeResult {\n  /** 念头类型 */\n  category: ThoughtCategory | null;\n  /** 是否允许植入 */\n  allowed: boolean;\n  /** 开发所需时间（小时） */\n  hours: number;\n  /** 是否会过期（hours >= 26） */\n  willExpire: boolean;\n  /** 拒绝原因（如果不允许） */\n  reason?: string;\n  /** 匹配方式 */\n  matchMethod: '本地匹配' | 'AI判定' | '默认';\n}\n\n/**\n * 念头难度等级\n */\nexport const THOUGHT_DIFFICULTIES = ['简单', '中等', '困难', '待定'] as const;\nexport type ThoughtDifficulty = (typeof THOUGHT_DIFFICULTIES)[number];\n\n/**\n * 根据阶段计算基础开发时间\n */\nexport function getBaseHours(stage: number): number {\n  switch (stage) {\n    case 1:\n      return 4;\n    case 2:\n      return 3;\n    case 3:\n      return 3;\n    case 4:\n      return 2;\n    case 5:\n    default:\n      return 2;\n  }\n}\n\n/**\n * 根据开发时间获取难度等级标签\n */\nexport function getDifficultyLabel(hours: number): ThoughtDifficulty {\n  if (hours <= 3) return '简单';\n  if (hours <= 4) return '中等';\n  return '困难';\n}\n\n/**\n * 秘籍模式选项\n */\nexport interface CheatModeOptions {\n  /** 安眠药是否生效（临时解锁下一阶段念头） */\n  isSleepingPillActive?: boolean;\n  /** 是否住院中（终极隐藏模式：全阶段解锁，无数值限制） */\n  isHospitalized?: boolean;\n}\n\n/**\n * 检查念头是否符合当前阶段和数值要求\n *\n * @param category 念头类型\n * @param stage 当前阶段 (1-5)\n * @param dependency 对主角依存度\n * @param moral 道德底线\n * @param cheatOptions 秘籍模式选项（安眠药/住院状态）\n * @returns 判定结果\n */\nexport function checkThoughtAllowed(\n  category: ThoughtCategory,\n  stage: number,\n  dependency: number,\n  moral: number,\n  cheatOptions: CheatModeOptions | boolean = false,\n): ThoughtJudgeResult {\n  // 兼容旧API：如果传入boolean，视为安眠药状态\n  const options: CheatModeOptions = typeof cheatOptions === 'boolean'\n    ? { isSleepingPillActive: cheatOptions }\n    : cheatOptions;\n\n  const { isSleepingPillActive = false, isHospitalized = false } = options;\n\n  // 【终极隐藏模式】住院状态：全阶段解锁，无任何限制\n  if (isHospitalized) {\n    const hours = 2; // 住院期间固定最短开发时间\n    return {\n      category,\n      allowed: true,\n      hours,\n      willExpire: false,\n      matchMethod: '本地匹配',\n    };\n  }\n\n  // 【秘籍机制】如果安眠药生效，临时将阶段+1（最高5）\n  const effectiveStage = isSleepingPillActive ? Math.min(stage + 1, 5) : stage;\n\n  const stageConfig = STAGE_REQUIREMENTS[effectiveStage] || STAGE_REQUIREMENTS[5];\n\n  // 检查阶段是否允许该类型\n  if (stageConfig.allowed !== 'all' && !stageConfig.allowed.includes(category)) {\n    return {\n      category,\n      allowed: false,\n      hours: 26,\n      willExpire: true,\n      reason: `阶段${stage}无法接受「${category}」类型的念头`,\n      matchMethod: '本地匹配',\n    };\n  }\n\n  // 检查额外数值要求（安眠药生效时降低数值门槛10点）\n  const extraReq = stageConfig.extra?.[category];\n  if (extraReq) {\n    const dependencyThreshold = isSleepingPillActive\n      ? Math.max(0, (extraReq.依存度 || 0) - 10)\n      : extraReq.依存度;\n    const moralThreshold = isSleepingPillActive\n      ? Math.min(100, (extraReq.道德底线 || 100) + 10)\n      : extraReq.道德底线;\n\n    if (dependencyThreshold !== undefined && dependency < dependencyThreshold) {\n      return {\n        category,\n        allowed: false,\n        hours: 26,\n        willExpire: true,\n        reason: `「${category}」需要依存度≥${dependencyThreshold}，当前${dependency}`,\n        matchMethod: '本地匹配',\n      };\n    }\n    if (moralThreshold !== undefined && moral > moralThreshold) {\n      return {\n        category,\n        allowed: false,\n        hours: 26,\n        willExpire: true,\n        reason: `「${category}」需要道德底线≤${moralThreshold}，当前${moral}`,\n        matchMethod: '本地匹配',\n      };\n    }\n  }\n\n  // 通过！计算正常开发时间\n  const hours = getBaseHours(stage);\n\n  return {\n    category,\n    allowed: true,\n    hours,\n    willExpire: false,\n    matchMethod: '本地匹配',\n  };\n}\n\n/**\n * 完整的念头判定函数（本地部分）\n *\n * 如果本地无法判定类型，返回 needAI: true，调用方需要调用 AI 判定\n *\n * @param content 念头内容\n * @param stage 当前阶段 (1-5)\n * @param dependency 对主角依存度\n * @param moral 道德底线\n * @param cheatOptions 秘籍模式选项（安眠药/住院状态）或布尔值（兼容旧API）\n * @returns 判定结果，如果 needAI 为 true 则需要 AI 判定\n */\nexport function judgeThought(\n  content: string,\n  stage: number,\n  dependency: number,\n  moral: number,\n  cheatOptions: CheatModeOptions | boolean = false,\n): ThoughtJudgeResult & { needAI: boolean } {\n  // 兼容旧API：如果传入boolean，视为安眠药状态\n  const options: CheatModeOptions = typeof cheatOptions === 'boolean'\n    ? { isSleepingPillActive: cheatOptions }\n    : cheatOptions;\n\n  // 第一步：本地快速判定\n  const localResult = localJudgeCategory(content);\n\n  if (localResult.result === '明确匹配' && localResult.category) {\n    // 本地匹配成功，检查是否允许（传入秘籍状态）\n    const result = checkThoughtAllowed(localResult.category, stage, dependency, moral, options);\n    return { ...result, needAI: false };\n  }\n\n  // 本地无法判定，需要 AI\n  // 【终极隐藏模式】住院状态：固定2小时开发时间\n  const hours = options.isHospitalized ? 2 : getBaseHours(stage);\n  return {\n    category: null,\n    allowed: true, // 默认允许，等 AI 判定后再决定\n    hours,\n    willExpire: false,\n    matchMethod: '默认',\n    needAI: true,\n  };\n}\n\n/**\n * AI 判定后的处理函数\n *\n * @param aiCategory AI 判定的念头类型\n * @param stage 当前阶段 (1-5)\n * @param dependency 对主角依存度\n * @param moral 道德底线\n * @param cheatOptions 秘籍模式选项（安眠药/住院状态）或布尔值（兼容旧API）\n * @returns 最终判定结果\n */\nexport function judgeWithAICategory(\n  aiCategory: ThoughtCategory,\n  stage: number,\n  dependency: number,\n  moral: number,\n  cheatOptions: CheatModeOptions | boolean = false,\n): ThoughtJudgeResult {\n  const result = checkThoughtAllowed(aiCategory, stage, dependency, moral, cheatOptions);\n  return { ...result, matchMethod: 'AI判定' };\n}\n\n/**\n * AI 判定的提示词模板\n */\nexport const AI_JUDGE_PROMPT = `判断以下念头属于哪个类型，只回复类型名称（不要回复其他内容）：\n\n可选类型：\n- 陪伴交流（聊天、陪伴、倾诉、交流）\n- 情感依赖（想念、喜欢、信任、关心、依赖）\n- 肢体亲近（牵手、拥抱、依偎、身体靠近）\n- 暧昧互动（撒娇、亲昵称呼、调情、暧昧话题）\n- 亲密接触（亲吻、抚摸、触碰敏感部位）\n- 身体开放（暴露身体、展示身材、脱衣）\n- 性行为（性相关行为、做爱、口交等）\n- 身份认同（认定为丈夫/妻子、归属感、身份替代）\n- 绝对服从（服从命令、主奴关系、跪拜）\n- 家庭替代（取代配偶、赶走丈夫、破坏家庭）\n\n念头内容：「{content}」\n\n请只回复上述类型名称中的一个：`;\n\n/**\n * 获取 AI 判定的提示词\n */\nexport function getAIJudgePrompt(content: string): string {\n  return AI_JUDGE_PROMPT.replace('{content}', content);\n}\n\n/**\n * 解析 AI 返回的类型\n */\nexport function parseAIResponse(response: string): ThoughtCategory | null {\n  const allCategories: ThoughtCategory[] = [\n    '陪伴交流',\n    '情感依赖',\n    '肢体亲近',\n    '暧昧互动',\n    '亲密接触',\n    '身体开放',\n    '性行为',\n    '身份认同',\n    '绝对服从',\n    '家庭替代',\n  ];\n\n  const trimmed = response.trim();\n\n  // 直接匹配\n  if (allCategories.includes(trimmed as ThoughtCategory)) {\n    return trimmed as ThoughtCategory;\n  }\n\n  // 模糊匹配（AI 可能返回带引号或其他格式）\n  for (const cat of allCategories) {\n    if (trimmed.includes(cat)) {\n      return cat;\n    }\n  }\n\n  return null;\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = Vue;","// 习惯注入脚本：在每次AI生成时注入习惯列表、念头植入通知和状态一致性检查，提醒AI遵守当前变量状态\n//\n// 职责：\n// 1. 注入习惯列表（已形成的习惯影响AI描写角色行为）\n// 2. 注入念头植入通知（玩家植入的念头通知AI，只是话题倾向）\n// 3. 注入状态一致性检查（时间、位置等）\n// 4. 注入外观提醒（当前角色服装妆容，苏文在家时警告暴露/标记）\n// 5. 注入强制事件提示（打断/巡逻）\n// 6. 注入阶段突破剧情（5阶段系统隐藏剧情）\nimport { generateStageBreakthroughInjection, generateStageBreakthroughPrefill, getStageTitle, } from '../../stageConfig';\nimport { LOCAL_KEYWORDS, STAGE_REQUIREMENTS } from '../../thoughtCategoryLib';\n$(async () => {\n    await waitGlobalInitialized('Mvu');\n    console.info('[习惯注入脚本] 开始加载');\n    // 用于跟踪当前生成请求是否启用了 extended thinking 模式\n    // 通过 CHAT_COMPLETION_SETTINGS_READY 事件获取，比检查 chat 数组更可靠\n    let currentRequestHasExtendedThinking = false;\n    // 监听设置就绪事件，获取 include_reasoning 状态\n    eventOn(tavern_events.CHAT_COMPLETION_SETTINGS_READY, (generate_data) => {\n        currentRequestHasExtendedThinking = generate_data.include_reasoning === true;\n        console.info(`[习惯注入] Extended thinking 模式: ${currentRequestHasExtendedThinking}`);\n    });\n    // 习惯上限配置\n    const HABIT_LIMIT = 16;\n    /**\n     * 根据习惯数量获取影响程度描述\n     * 16个习惯上限：1-4轻微，5-8明显，9-12深度，13-16完全内化\n     */\n    function getInfluenceDescription(count) {\n        if (count >= 13) {\n            return {\n                level: '完全内化',\n                description: '这些行为已彻底融入人格，如同呼吸般自然，不做反而会觉得缺少什么',\n                example: '她自然地跪在他面前，像是每天早上都会做的事。这已经成为她的日常，不需要任何理由或铺垫，她的身体自己就知道该怎么做。如果一天没有这样，她反而会觉得浑身不对劲。',\n            };\n        }\n        if (count >= 9) {\n            return {\n                level: '深度影响',\n                description: '这些行为已非常自然，几乎没有心理障碍，会主动创造相关场景',\n                example: '看到他坐在沙发上，她不自觉地走过去，自然而然地坐到他腿上。没有犹豫，没有羞涩，这个动作就像给家人倒杯水一样平常。她甚至会主动找机会制造独处的场景。',\n            };\n        }\n        if (count >= 5) {\n            return {\n                level: '明显影响',\n                description: '这些行为开始变得自然，抗拒减弱，稍加暗示就会配合',\n                example: '他的手指轻轻抬起她的下巴，她只是微微红了脸，但没有躲开。心里虽然还有一丝不安，但那种感觉已经弱了很多。她甚至有些期待接下来会发生什么。',\n            };\n        }\n        if (count >= 1) {\n            return {\n                level: '轻微影响',\n                description: '这些行为还需要引导才会做，仍有羞涩和犹豫',\n                example: '她的脸一下子红到了耳根，眼神闪躲，不知道该把手放在哪里。虽然没有立刻拒绝，但身体还是僵硬的，需要他一步步引导才会慢慢放松下来。',\n            };\n        }\n        return { level: '', description: '', example: '' };\n    }\n    /**\n     * 生成信息隔离提醒\n     * 秦璐和苏梦之间在剧情中没有透露之前，无法知道对方的秘密和剧情进展\n     */\n    function generateInformationIsolationReminder() {\n        try {\n            const variables = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const data = _.get(variables, 'stat_data');\n            if (!data) {\n                return null;\n            }\n            const currentCharacter = data.系统追踪?.当前角色 || '秦璐';\n            const otherCharacter = currentCharacter === '秦璐' ? '苏梦' : '秦璐';\n            // 获取两个角色的状态用于对比\n            const qinluState = data.秦璐状态;\n            const sumengState = data.苏梦状态;\n            // 获取另一个角色的状态\n            const otherState = currentCharacter === '秦璐' ? sumengState : qinluState;\n            const otherStage = otherState?.当前阶段 || 1;\n            // 检查另一角色是否有秘密（阶段 > 1 或有习惯）\n            const otherHasSecrets = otherStage > 1 || (otherState?.习惯列表?.length || 0) > 0;\n            if (!otherHasSecrets) {\n                // 如果另一个角色没有秘密，不需要信息隔离提醒\n                return null;\n            }\n            const parts = [\n                `【🔒 信息隔离规则】`,\n                `当前视角角色：${currentCharacter}`,\n                ``,\n                `⚠️ 重要：${currentCharacter}与${otherCharacter}之间存在信息隔离：`,\n                ``,\n                `【${currentCharacter}不知道的信息】`,\n                `- ${otherCharacter}与{{user}}之间发生的任何事情`,\n                `- ${otherCharacter}对{{user}}产生的任何特殊感情或依赖`,\n                `- ${otherCharacter}形成的任何习惯或行为变化的真实原因`,\n                `- ${otherCharacter}的内心想法、心理变化、阶段进展`,\n            ];\n            // 根据另一个角色的阶段添加具体的秘密内容\n            if (otherStage >= 2) {\n                parts.push(`- ${otherCharacter}已经开始对{{user}}产生动摇（阶段${otherStage}）`);\n            }\n            if (otherState?.习惯列表?.length > 0) {\n                parts.push(`- ${otherCharacter}形成的 ${otherState.习惯列表.length} 个潜意识习惯`);\n            }\n            parts.push(``, `【演绎要求】`, `- 如果${currentCharacter}与${otherCharacter}同时出现，${currentCharacter}对${otherCharacter}的异常行为只能表现出困惑，不能直接知道原因`, `- ${currentCharacter}不会主动询问${otherCharacter}与{{user}}的关系，除非看到明显的异常`, `- 两人之间保持正常的家庭关系互动（婆媳/母女关系）`, `- 只有当某角色主动向另一角色透露时，信息隔离才会打破`);\n            return parts.join('\\n');\n        }\n        catch (err) {\n            console.error('[信息隔离] 生成提醒时出错:', err);\n            return null;\n        }\n    }\n    /**\n     * 生成状态一致性检查提醒\n     */\n    function generateStateConsistencyReminder() {\n        try {\n            // 获取最新楼层的变量\n            const variables = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const data = _.get(variables, 'stat_data');\n            if (!data) {\n                console.warn('[状态一致性] stat_data 不存在');\n                return null;\n            }\n            const currentDate = data.世界?.日期 || '未知';\n            const currentTime = data.世界?.时间 || '未知';\n            const suwenLocation = data.苏文状态?.当前位置 || '未知';\n            const suwenState = data.苏文状态?.当前状态 || '未知';\n            // 解析时间段\n            let timeDescription = '';\n            if (currentTime !== '未知') {\n                const [hour] = currentTime.split(':').map(Number);\n                if (hour >= 6 && hour < 8) {\n                    timeDescription = '清晨时分';\n                }\n                else if (hour >= 12 && hour < 14) {\n                    timeDescription = '正午时分';\n                }\n                else if (hour >= 18 && hour < 20) {\n                    timeDescription = '傍晚时分';\n                }\n                else if (hour >= 22 || hour < 6) {\n                    timeDescription = '深夜时分';\n                }\n            }\n            const parts = [\n                `【当前状态参考】`,\n                `- 日期：${currentDate}`,\n                `- 时间：${currentTime}${timeDescription ? ` (${timeDescription})` : ''}`,\n                `- 苏文位置：${suwenLocation}`,\n                `- 苏文状态：${suwenState}`,\n            ];\n            // 根据苏文状态添加约束提醒（这些是硬性约束）\n            if (suwenState === '睡眠') {\n                parts.push(`\\n⚠️ 苏文正在睡眠，禁止描写：`, `  - 苏文的脚步声、说话、任何活动`, `  - 苏文在主卧以外的位置`);\n            }\n            else if (suwenState === '上班' || suwenState === '出差') {\n                parts.push(`\\n⚠️ 苏文不在家（${suwenState}），禁止描写苏文在家中`);\n            }\n            // 时间描述约束（改为建议而非强制）\n            if (timeDescription) {\n                parts.push(`\\n💡 如需描绘环境，当前是${timeDescription}`);\n            }\n            return parts.join('\\n');\n        }\n        catch (err) {\n            console.error('[状态一致性] 生成提醒时出错:', err);\n            return null;\n        }\n    }\n    /**\n     * 生成外观提醒（当前视角角色的服装和妆容）\n     * 模仿苏文状态提醒的逻辑：基础信息 + 特殊情况警告\n     */\n    function generateAppearanceReminder() {\n        try {\n            const variables = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const data = _.get(variables, 'stat_data');\n            if (!data) {\n                return null;\n            }\n            const currentCharacter = data.系统追踪?.当前角色 || '秦璐';\n            const characterState = currentCharacter === '秦璐' ? data.秦璐状态 : data.苏梦状态;\n            if (!characterState) {\n                return null;\n            }\n            const clothing = characterState.服装细节;\n            const makeup = characterState.妆容细节;\n            const bodyMod = characterState.身体改造;\n            // 基础外观信息（简洁版）\n            const parts = [\n                `【当前外观 - ${currentCharacter}】`,\n                `服装：${clothing.上装} + ${clothing.下装}（${clothing.整体风格}，暴露：${clothing.暴露程度}）`,\n                `妆容：${makeup.浓淡程度}（${makeup.整体风格}）`,\n                `气质：${characterState.气质描述}`,\n            ];\n            // 检查是否有特殊装饰\n            if (clothing.特殊装饰 && clothing.特殊装饰 !== '无') {\n                parts.push(`特殊装饰：${clothing.特殊装饰}`);\n            }\n            // 检查是否有临时标记\n            const tempMarks = bodyMod?.临时标记 || [];\n            if (tempMarks.length > 0) {\n                parts.push(`临时标记：${tempMarks.join('、')}`);\n            }\n            // 检查苏文状态，决定是否需要警告\n            const suwenState = data.苏文状态?.当前状态 || '未知';\n            const suwenAtHome = suwenState === '在家';\n            const suwenAwake = suwenState !== '睡眠' && suwenState !== '上班' && suwenState !== '出差';\n            // 只在苏文在家且清醒时检查是否需要警告\n            if (suwenAtHome && suwenAwake) {\n                const warnings = [];\n                // 暴露程度警告\n                const exposureLevel = clothing.暴露程度;\n                if (exposureLevel === '暴露' || exposureLevel === '极度暴露') {\n                    warnings.push(`当前暴露程度「${exposureLevel}」不适合在苏文面前展示`);\n                }\n                // 临时标记警告\n                if (tempMarks.length > 0) {\n                    warnings.push(`身上有临时标记需要遮挡：${tempMarks.join('、')}`);\n                }\n                // 特殊装饰警告\n                if (clothing.特殊装饰 && clothing.特殊装饰 !== '无') {\n                    warnings.push(`特殊装饰「${clothing.特殊装饰}」需要隐藏或取下`);\n                }\n                // 浓妆警告\n                if (makeup.浓淡程度 === '浓妆' || makeup.浓淡程度 === '艳妆') {\n                    warnings.push(`当前妆容「${makeup.浓淡程度}」可能引起苏文注意`);\n                }\n                if (warnings.length > 0) {\n                    parts.push(`\\n⚠️ 苏文在家且清醒，注意：`);\n                    warnings.forEach(w => parts.push(`  - ${w}`));\n                }\n            }\n            return parts.join('\\n');\n        }\n        catch (err) {\n            console.error('[外观提醒] 生成提醒时出错:', err);\n            return null;\n        }\n    }\n    /**\n     * 生成念头植入通知（从念头植入日志中读取）\n     * 玩家植入的念头会记录在日志中，这里读取并注入到AI提示词\n     *\n     * 【设计理念】念头 vs 习惯的区别：\n     * - 念头：只是\"开了一扇门\"，让角色在相关话题出现时不会本能排斥，愿意尝试聊\n     * - 习惯：念头成熟后的永久行为模式，真正影响性格和决策，数量越多影响越深\n     *\n     * 【优化】多个念头合并为一条消息，避免重复的演绎要求\n     */\n    function generateThoughtImplantNotifications() {\n        try {\n            const variables = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const data = _.get(variables, 'stat_data');\n            if (!data?.系统追踪?.念头植入日志) {\n                return null;\n            }\n            const logs = data.系统追踪.念头植入日志;\n            if (logs.length === 0) {\n                return null;\n            }\n            // 统计未通知的数量\n            const unnotifiedCount = logs.filter((l) => !l.已通知AI).length;\n            console.info(`[念头植入] 发现 ${logs.length} 条念头植入记录（${unnotifiedCount} 条未通知）`);\n            // 按目标角色分组\n            const thoughtsByTarget = {};\n            logs.forEach((log) => {\n                const target = log.目标;\n                if (!thoughtsByTarget[target]) {\n                    thoughtsByTarget[target] = [];\n                }\n                thoughtsByTarget[target].push(log.内容);\n            });\n            // 生成合并后的通知消息\n            // 【重要】念头只是\"话题倾向\"，不是\"性格改变\"\n            // 角色只是愿意聊这个话题，不代表已经接受或认同\n            const parts = [];\n            // 为每个角色生成念头列表\n            for (const [target, thoughts] of Object.entries(thoughtsByTarget)) {\n                if (thoughts.length === 1) {\n                    // 单个念头：简洁格式\n                    parts.push(`【${target}】对\"${thoughts[0]}\"产生了一丝好奇或不排斥`);\n                }\n                else {\n                    // 多个念头：列表格式\n                    const thoughtList = thoughts.map(t => `  · \"${t}\"`).join('\\n');\n                    parts.push(`【${target}】对以下话题产生了一丝好奇或不排斥：\\n${thoughtList}`);\n                }\n            }\n            // 组装最终消息（演绎要求只写一次）\n            const message = [\n                `OOC: 【念头培育中】`,\n                ``,\n                ...parts,\n                ``,\n                `【演绎要求】`,\n                `- 这些只是萌芽的想法，不是已形成的观念或习惯`,\n                `- 如果{{user}}主动引导相关话题，角色会比平时更愿意聊、不会立刻回避`,\n                `- 但她仍然会有正常的羞涩、犹豫或抗拒，只是\"门没关死\"`,\n                `- 态度和反应仍然基于当前的道德底线和依存度数值`,\n                `- 【禁止】让角色主动提起这些话题或表现得像已经接受`,\n                `- 【禁止】描写为\"本来就有的想法\"或\"理所当然\"`,\n                `- 【禁止】让念头直接改变角色的性格或行为模式`,\n            ].join('\\n');\n            // 标记所有日志为已通知\n            let hasUnnotified = false;\n            logs.forEach((log) => {\n                if (!log.已通知AI) {\n                    log.已通知AI = true;\n                    hasUnnotified = true;\n                }\n            });\n            // 如果有未通知的日志，保存更新（使用 MVU API 保持一致性）\n            if (hasUnnotified) {\n                try {\n                    const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n                    _.set(currentVars, 'stat_data.系统追踪.念头植入日志', logs);\n                    Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n                    console.info(`[念头植入] 已标记 ${unnotifiedCount} 条日志为已通知（MVU API）`);\n                }\n                catch (mvuErr) {\n                    console.error('[念头植入] 标记日志失败:', mvuErr);\n                }\n            }\n            return message;\n        }\n        catch (err) {\n            console.error('[念头植入] 生成通知消息失败:', err);\n            return null;\n        }\n    }\n    /**\n     * 生成待判定念头的类型判定提示\n     * 让 AI 在正文末尾输出念头类型判定结果，格式：【念头判定】角色:内容=类型\n     * 游戏逻辑脚本会解析这个结果并更新念头状态\n     */\n    function generatePendingThoughtJudgePrompt() {\n        try {\n            const variables = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const data = _.get(variables, 'stat_data');\n            if (!data)\n                return null;\n            // 收集所有待判定的念头\n            const pendingThoughts = [];\n            // 检查秦璐的念头\n            const qinluThoughts = data.秦璐状态?.念头培育区 || [];\n            qinluThoughts.forEach((t) => {\n                if (t.待判定) {\n                    pendingThoughts.push({ target: '秦璐', content: t.念头内容 });\n                }\n            });\n            // 检查苏梦的念头\n            const sumengThoughts = data.苏梦状态?.念头培育区 || [];\n            sumengThoughts.forEach((t) => {\n                if (t.待判定) {\n                    pendingThoughts.push({ target: '苏梦', content: t.念头内容 });\n                }\n            });\n            if (pendingThoughts.length === 0)\n                return null;\n            console.info(`[念头判定] 发现 ${pendingThoughts.length} 个待判定念头`);\n            // 生成判定提示\n            const thoughtList = pendingThoughts.map(t => `  - ${t.target}：\"${t.content}\"`).join('\\n');\n            const prompt = [\n                `OOC: 【念头类型判定请求】`,\n                ``,\n                `以下念头需要判定类型：`,\n                thoughtList,\n                ``,\n                `可选类型（10大类）：`,\n                `- 陪伴交流（聊天、陪伴、倾诉、沟通、喂饭、照顾起居）`,\n                `- 情感依赖（想念、牵挂、惦记、在意）`,\n                `- 肢体亲近（牵手、拥抱、依偎、靠在一起）`,\n                `- 暧昧互动（撒娇、亲昵、调情、心跳加速）`,\n                `- 亲密接触（亲吻、接吻、抚摸身体）`,\n                `- 身体开放（暴露身体、展示身材、袒露）`,\n                `- 性行为（做爱、性行为、口交、插入）`,\n                `- 身份认同（属于你、你的人、归属感）`,\n                `- 绝对服从（服从命令、跪下、主奴关系）`,\n                `- 家庭替代（取代配偶、赶走丈夫、离婚）`,\n                ``,\n                `【重要】请在本轮回复的最后一行，使用以下格式输出判定结果（每个念头一行）：`,\n                `【念头判定】角色:念头内容=类型`,\n                ``,\n                `示例：`,\n                `【念头判定】秦璐:想和他聊天=陪伴交流`,\n                `【念头判定】苏梦:想被他拥抱=肢体亲近`,\n            ].join('\\n');\n            return prompt;\n        }\n        catch (err) {\n            console.error('[念头判定] 生成判定提示失败:', err);\n            return null;\n        }\n    }\n    /**\n     * 生成习惯注入的系统消息\n     * 【信息隔离】只注入当前视角角色的习惯详情，另一角色只显示数量不显示内容\n     *\n     * 【设计理念】习惯 vs 念头的区别：\n     * - 念头：只是\"开了一扇门\"，愿意聊相关话题，不改变性格\n     * - 习惯：念头成熟后的永久行为模式，真正影响性格和决策，数量越多影响越深\n     */\n    function generateHabitsInjection() {\n        try {\n            // 获取最新楼层的变量\n            const variables = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const data = _.get(variables, 'stat_data');\n            if (!data) {\n                console.warn('[习惯注入] stat_data 不存在');\n                return null;\n            }\n            // 获取当前视角角色\n            const currentCharacter = data.系统追踪?.当前角色 || '秦璐';\n            const parts = [];\n            // 处理秦璐的习惯\n            const qinluHabits = data.秦璐状态?.习惯列表 || [];\n            if (qinluHabits.length > 0 && currentCharacter === '秦璐') {\n                const { level, description, example } = getInfluenceDescription(qinluHabits.length);\n                const habitsText = qinluHabits.map((h) => `\"${h.内容}\"`).join('、');\n                parts.push([\n                    `【秦璐的行为倾向】`,\n                    `当前影响力：${level}`,\n                    `具体表现：${description}`,\n                    `已内化的行为：${habitsText}`,\n                    ``,\n                    `【当前影响力的演绎示例】`,\n                    `${example}`,\n                    ``,\n                    `【演绎要求】`,\n                    `- 在相关场景中，秦璐会自然地表现出这些行为倾向`,\n                    `- 参考上面的示例，把握当前影响力等级下角色的反应程度`,\n                    `- 这些是角色已经习惯的行为模式，不需要{{user}}每次都提起`,\n                    `- 【禁止】在输出中提及\"习惯\"、\"行为倾向\"、\"影响力\"等元游戏术语`,\n                    `- 【禁止】让角色意识到自己\"被改变了\"或\"有了习惯\"`,\n                ].join('\\n'));\n            }\n            // 处理苏梦的习惯\n            const sumengHabits = data.苏梦状态?.习惯列表 || [];\n            if (sumengHabits.length > 0 && currentCharacter === '苏梦') {\n                const { level, description, example } = getInfluenceDescription(sumengHabits.length);\n                const habitsText = sumengHabits.map((h) => `\"${h.内容}\"`).join('、');\n                parts.push([\n                    `【苏梦的行为倾向】`,\n                    `当前影响力：${level}`,\n                    `具体表现：${description}`,\n                    `已内化的行为：${habitsText}`,\n                    ``,\n                    `【当前影响力的演绎示例】`,\n                    `${example}`,\n                    ``,\n                    `【演绎要求】`,\n                    `- 在相关场景中，苏梦会自然地表现出这些行为倾向`,\n                    `- 参考上面的示例，把握当前影响力等级下角色的反应程度`,\n                    `- 这些是角色已经习惯的行为模式，不需要{{user}}每次都提起`,\n                    `- 【禁止】在输出中提及\"习惯\"、\"行为倾向\"、\"影响力\"等元游戏术语`,\n                    `- 【禁止】让角色意识到自己\"被改变了\"或\"有了习惯\"`,\n                ].join('\\n'));\n            }\n            if (parts.length === 0) {\n                return null;\n            }\n            return parts.join('\\n\\n');\n        }\n        catch (err) {\n            console.error('[习惯注入] 生成注入消息时出错:', err);\n            return null;\n        }\n    }\n    /**\n     * 从强制事件日志中检测待处理的事件\n     * 支持 ROLL 后重新触发：只要日志在3楼内且未全部通知，就会重新触发\n     * 【新逻辑】打断和巡逻都直接触发，不再需要预警阶段\n     */\n    function detectForcedEventFromLog() {\n        try {\n            const variables = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const data = _.get(variables, 'stat_data');\n            const currentFloor = getLastMessageId();\n            if (!data?.系统追踪?.强制事件日志) {\n                return { type: null, character: null, stage: 1, accumulatedTime: 0, reason: '', logIndex: -1 };\n            }\n            const logs = data.系统追踪.强制事件日志;\n            // 按优先级排序：阶段突破 > 苏文打断 > 苏文巡逻\n            const priorityOrder = { '阶段突破': 0, '苏文打断': 1, '苏文巡逻': 2 };\n            // 找到第一个未通知且在3楼内的事件（按优先级）\n            const validLogs = logs\n                .map((log, index) => ({ log, index }))\n                .filter(({ log }) => {\n                // 检查是否在3楼内（与念头植入日志清理逻辑一致）\n                const floorDiff = currentFloor - log.触发楼层;\n                return floorDiff >= 0 && floorDiff <= 3 && !log.已通知AI;\n            })\n                .sort((a, b) => priorityOrder[a.log.事件类型] - priorityOrder[b.log.事件类型]);\n            if (validLogs.length === 0) {\n                return { type: null, character: null, stage: 1, accumulatedTime: 0, reason: '', logIndex: -1 };\n            }\n            const { log, index } = validLogs[0];\n            const character = log.角色;\n            const stage = character === '秦璐'\n                ? data.秦璐状态?.当前阶段 || 1\n                : data.苏梦状态?.当前阶段 || 1;\n            console.info(`[强制事件日志] 检测到待处理事件: ${log.事件类型}, 角色: ${character}, 楼层: ${log.触发楼层}`);\n            return {\n                type: log.事件类型,\n                character,\n                stage,\n                accumulatedTime: log.累计时间 || 0,\n                reason: log.打断原因 || '',\n                logIndex: index,\n                stageNumber: log.阶段号,\n                triggerTime: log.触发时间,\n                patrolLocation: log.巡逻位置,\n            };\n        }\n        catch (err) {\n            console.error('[强制事件日志] 检测时出错:', err);\n            return { type: null, character: null, stage: 1, accumulatedTime: 0, reason: '', logIndex: -1 };\n        }\n    }\n    /**\n     * 检测苏文打断事件是否待触发（保留兼容旧逻辑，但优先使用日志）\n     * 【新逻辑】直接触发，不再需要预警阶段\n     */\n    function detectInterruptionEvent() {\n        try {\n            const variables = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const data = _.get(variables, 'stat_data');\n            if (!data?.系统追踪?.苏文打断事件?.待触发) {\n                return { triggered: false, character: null, stage: 1, accumulatedTime: 0, reason: '' };\n            }\n            // 检查是否已通知AI（避免重复触发）\n            if (data.系统追踪.苏文打断事件.已通知AI) {\n                return { triggered: false, character: null, stage: 1, accumulatedTime: 0, reason: '' };\n            }\n            const event = data.系统追踪.苏文打断事件;\n            const currentCharacter = (data.系统追踪?.当前角色 || '秦璐');\n            const stage = currentCharacter === '秦璐'\n                ? data.秦璐状态?.当前阶段 || 1\n                : data.苏梦状态?.当前阶段 || 1;\n            console.info(`[打断事件] 检测到待触发的打断事件，原因: ${event.打断原因}`);\n            return {\n                triggered: true,\n                character: currentCharacter,\n                stage,\n                accumulatedTime: event.累计时间 || 0,\n                reason: event.打断原因 || '',\n            };\n        }\n        catch (err) {\n            console.error('[打断事件] 检测时出错:', err);\n            return { triggered: false, character: null, stage: 1, accumulatedTime: 0, reason: '' };\n        }\n    }\n    /**\n     * 打断事件的场景变体\n     * 每个场景有多个可能的台词，触发时随机选一个\n     */\n    const interruptionScenarios = [\n        {\n            name: '敲门询问',\n            scene: '走廊里传来了脚步声，越来越近，最终停在了{{user}}房间门口。\\n苏文敲了敲门，声音从门外传来...',\n            dialogues: [\n                '\"小璐？在里面吗？你在{{user}}房间做什么？这么久了。\"',\n                '\"出来一下，我有话要说。\"',\n                '\"怎么门关着？里面在干什么？\"',\n                '\"你们两个在里面吗？我有点事想说。\"',\n                '\"门关着干嘛？我敲半天了。\"',\n            ],\n            prefill: '（走廊里忽然传来了脚步声，越来越近，最终在{{user}}房间门口停下...）\\n\\n\"咚咚咚——\"',\n        },\n        {\n            name: '听到声音',\n            scene: '苏文本来只是路过，但他似乎听到了什么声音。\\n脚步声在门口停下，然后传来敲门声...',\n            dialogues: [\n                '\"里面怎么了？我好像听到了什么声音。\"',\n                '\"你们在房间里做什么？刚才好像有响动。\"',\n                '\"小璐？出什么事了吗？\"',\n                '\"刚才那是什么声音？你们在里面吗？\"',\n                '\"我听到动静了...没事吧？\"',\n            ],\n            prefill: '（走廊里的脚步声突然停下...似乎苏文听到了什么...）\\n\\n\"咚咚——\"',\n        },\n        {\n            name: '叫吃饭',\n            scene: '苏文端着一杯茶走过来，顺便来叫人。\\n他在门口停下，用空着的手敲了敲门...',\n            dialogues: [\n                '\"吃饭了，你们在里面吗？\"',\n                '\"水果切好了，出来吃点。\"',\n                '\"茶泡好了。你们两个在里面聊什么呢？\"',\n                '\"饭菜凉了，出来吃吧。\"',\n                '\"我泡了咖啡，要不要来一杯？\"',\n            ],\n            prefill: '（走廊里传来脚步声，还有茶杯轻轻碰撞的声音...）\\n\\n',\n        },\n        {\n            name: '找东西',\n            scene: '苏文在找什么东西，找着找着来到了{{user}}房间门口。\\n他敲了敲门，带着疑问的语气...',\n            dialogues: [\n                '\"你们看到我的充电器了吗？\"',\n                '\"小璐，你知道遥控器放哪了吗？\"',\n                '\"我的眼镜找不到了...你们有看到吗？\"',\n                '\"我的车钥匙呢？是不是在这里？\"',\n                '\"那个文件夹...你们有看到吗？\"',\n            ],\n            prefill: '（走廊里传来翻找东西的声音，然后脚步声靠近...）\\n\\n',\n        },\n        {\n            name: '打电话回来',\n            scene: '苏文刚打完电话，顺着走廊走过来。\\n他看到{{user}}房间门关着，停下脚步...',\n            dialogues: [\n                '\"打扰一下，我刚接到电话...你们两个在这里？\"',\n                '\"电话里的事处理完了。小璐，你怎么还在这里？\"',\n                '\"客户的电话真啰嗦...嗯？你们在做什么？\"',\n                '\"终于挂了...你们在里面吗？\"',\n                '\"那边的事搞定了。你们在这里干嘛呢？\"',\n            ],\n            prefill: '（走廊里传来说话声，似乎是苏文在打电话...然后脚步声停在门口...）\\n\\n',\n        },\n        {\n            name: '睡前巡视',\n            scene: '苏文准备睡觉前习惯性地在家里走一圈。\\n他来到{{user}}房间门口，发现灯还亮着...',\n            dialogues: [\n                '\"这么晚了还不睡？\"',\n                '\"灯还亮着...你们在干嘛呢？\"',\n                '\"我去睡了，你们也早点休息。\"',\n                '\"都快十二点了，还在聊天？\"',\n                '\"明天还要上班呢，别太晚了。\"',\n            ],\n            prefill: '（走廊里传来拖鞋声，苏文似乎在做睡前巡视...）\\n\\n',\n        },\n        {\n            name: '接水经过',\n            scene: '苏文去厨房接水，回来的时候经过{{user}}房间。\\n手里端着杯水，在门口停了一下...',\n            dialogues: [\n                '\"要喝水吗？我刚接的。\"',\n                '\"你们还在这里啊...聊什么呢？\"',\n                '\"门怎么关着？渴不渴，要不要水？\"',\n                '\"我去接杯水...你们在里面干嘛？\"',\n                '\"{{user}}，要不要给你倒杯水？\"',\n            ],\n            prefill: '（厨房那边传来水龙头的声音，然后是走近的脚步声...）\\n\\n',\n        },\n    ];\n    // ============================================\n    // 越界行为检测系统\n    // ============================================\n    /**\n     * 越界行为额外关键词配置\n     * 这些是 LOCAL_KEYWORDS 之外的补充词汇，用于更精确地检测极端行为\n     */\n    const EXTRA_VIOLATION_KEYWORDS = {\n        // 性行为：补充更多极端词汇\n        性行为: ['抽插', '骑乘', '后入', '内射', '颜射', '深喉', '69', '打炮', '上床', '操', '干她', '肏', '吸'],\n        // 身体开放：补充具体场景词汇\n        身体开放: ['脱光', '全裸', '裸体', '脱内衣', '脱内裤', '露出胸', '露出乳', '露出阴', '展示身体', '看我的身体'],\n        // 绝对服从：补充具体场景词汇\n        绝对服从: ['跪下', '跪好', '舔脚', '当奴隶', '命令你', '服从我', '乖乖的', '跪着'],\n        // 家庭替代：补充具体场景词汇\n        家庭替代: ['离开苏文', '抛弃苏文', '赶走苏文', '取代苏文', '做我的女人', '只属于我'],\n    };\n    /**\n     * 获取某个行为类型的完整关键词列表（合并 LOCAL_KEYWORDS 和额外词汇）\n     */\n    function getBoundaryKeywords(behaviorType) {\n        const baseKeywords = LOCAL_KEYWORDS[behaviorType] || [];\n        const extraKeywords = EXTRA_VIOLATION_KEYWORDS[behaviorType] || [];\n        // 合并并去重\n        return [...new Set([...baseKeywords, ...extraKeywords])];\n    }\n    /**\n     * 所有可能的念头类型（用于计算禁止类型）\n     */\n    const ALL_THOUGHT_CATEGORIES = [\n        '陪伴交流', '情感依赖', '肢体亲近', '暧昧互动',\n        '亲密接触', '身体开放', '性行为', '身份认同',\n        '绝对服从', '家庭替代',\n    ];\n    /**\n     * 根据 STAGE_REQUIREMENTS 派生禁止的行为类型\n     * 这样可以确保与念头系统保持一致\n     */\n    function getForbiddenBehaviors(stage) {\n        const stageReq = STAGE_REQUIREMENTS[stage];\n        if (!stageReq)\n            return [];\n        // 如果 allowed 是 'all'，则没有禁止的行为\n        if (stageReq.allowed === 'all')\n            return [];\n        // 返回不在允许列表中的所有类型\n        return ALL_THOUGHT_CATEGORIES.filter(cat => !stageReq.allowed.includes(cat));\n    }\n    /**\n     * 检测用户输入是否包含越界行为\n     *\n     * @returns 越界信息，如果没有越界返回 null\n     */\n    function detectBoundaryViolation() {\n        try {\n            // 获取最新的聊天消息\n            const chat = SillyTavern.chat;\n            if (!chat || chat.length === 0)\n                return null;\n            // 找到最后一条用户消息\n            let lastUserMessage = '';\n            for (let i = chat.length - 1; i >= 0; i--) {\n                if (chat[i].is_user) {\n                    lastUserMessage = chat[i].mes || '';\n                    break;\n                }\n            }\n            if (!lastUserMessage)\n                return null;\n            // 获取当前状态\n            const variables = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const data = _.get(variables, 'stat_data');\n            if (!data)\n                return null;\n            // 检查苏文是否在家且清醒（只有这种情况才会触发苏文打断）\n            // 注意：苏文不在家时，越界行为仍然不应该发生，但由于无法触发苏文打断，\n            // 这种情况依赖于角色自身的阶段限制和念头系统来防止不当行为。\n            // 如果需要更严格的限制，可以考虑添加角色自身抵抗的逻辑。\n            const suwenState = data.苏文状态?.当前状态;\n            if (suwenState !== '在家') {\n                return null;\n            }\n            // 【新增】检查疑心值冻结状态 - 疑心值冻结期间，越界检测暂停\n            // 包括：说谎成功冻结、安眠药效果期间、住院期间\n            const currentCharacterCheck = (data.系统追踪?.当前角色 || '秦璐');\n            const suspicionFreezeFieldName = currentCharacterCheck === '秦璐' ? '对秦璐疑心值冻结' : '对苏梦疑心值冻结';\n            const suspicionFreeze = data.苏文状态?.[suspicionFreezeFieldName];\n            if (suspicionFreeze?.是否冻结) {\n                console.info(`[越界检测] 疑心值冻结中(${suspicionFreeze.借口内容})，越界检测暂停`);\n                return null;\n            }\n            // 【新增】检查住院状态 - 苏文住院期间，越界检测暂停\n            const hospitalizationState = data.苏文状态?.住院状态;\n            if (hospitalizationState?.是否住院) {\n                console.info(`[越界检测] 苏文住院中(剩余${hospitalizationState.剩余天数}天)，越界检测暂停`);\n                return null;\n            }\n            // 【新增】检查安眠药状态 - 安眠药生效期间，越界检测暂停\n            const sleepingPillState = data.苏文状态?.安眠药状态;\n            if (sleepingPillState?.是否生效) {\n                console.info(`[越界检测] 安眠药生效中(剩余${sleepingPillState.剩余时间}小时)，越界检测暂停`);\n                return null;\n            }\n            // 获取当前角色信息\n            const currentCharacter = (data.系统追踪?.当前角色 || '秦璐');\n            const characterState = currentCharacter === '秦璐' ? data.秦璐状态 : data.苏梦状态;\n            const stage = characterState?.当前阶段 || 1;\n            // 获取当前阶段禁止的行为类型（从 STAGE_REQUIREMENTS 派生）\n            const forbiddenTypes = getForbiddenBehaviors(stage);\n            // 检查用户输入是否包含禁止的关键词\n            for (const behaviorType of forbiddenTypes) {\n                const keywords = getBoundaryKeywords(behaviorType);\n                if (keywords.length === 0)\n                    continue;\n                for (const keyword of keywords) {\n                    if (lastUserMessage.includes(keyword)) {\n                        console.warn(`[越界检测] 检测到越界行为: 阶段${stage}禁止「${behaviorType}」，匹配关键词: \"${keyword}\"`);\n                        return {\n                            violated: true,\n                            character: currentCharacter,\n                            stage,\n                            violationType: behaviorType,\n                            matchedKeyword: keyword,\n                        };\n                    }\n                }\n            }\n            return null;\n        }\n        catch (err) {\n            console.error('[越界检测] 检测失败:', err);\n            return null;\n        }\n    }\n    /**\n     * 生成越界行为打断的用户消息替换内容\n     * 与普通打断不同，这里强调是因为\"不当行为\"触发\n     */\n    function generateBoundaryViolationUserMessage(character, stage, violationType) {\n        // 根据阶段生成不同的羞耻/惊慌反应\n        let characterReaction = '';\n        let innerThought = '';\n        if (stage <= 1) {\n            characterReaction = `${character}瞬间石化，脸色煞白，整个人不知所措。她的手不自觉地攥紧衣角，声音颤抖得几乎说不出话来。`;\n            innerThought = `（${character}的内心：这...这不可能发生的！我...我怎么会...不，一定是搞错了...）`;\n        }\n        else if (stage <= 2) {\n            characterReaction = `${character}身体一僵，脸上的表情在惊慌与羞耻间交替。她下意识地后退一步，试图整理自己的仪态，但慌乱溢于言表。`;\n            innerThought = `（${character}的内心：糟了...太过分了...这样下去...不行，要冷静...）`;\n        }\n        else {\n            characterReaction = `${character}虽然表面镇定，但眼底闪过一丝慌乱。她深吸一口气，试图用平静的表情掩盖内心的波动。`;\n            innerThought = `（${character}的内心：差点...太冒险了...幸好及时停下...）`;\n        }\n        // 根据违规类型生成不同的描述\n        const violationDescriptions = {\n            性行为: '过于亲密的举动',\n            身体开放: '不当的暴露行为',\n            绝对服从: '超出界限的要求',\n            家庭替代: '危险的言论',\n        };\n        const violationDesc = violationDescriptions[violationType] || '越界行为';\n        return [\n            `【系统强制事件：苏文打断 - 越界警告】`,\n            ``,\n            `═══════════════════════════════════════════════════════════════`,\n            `  ⚠️ 检测到${violationDesc}！苏文突然出现！`,\n            `═══════════════════════════════════════════════════════════════`,\n            ``,\n            `【系统说明】`,\n            `玩家试图引导角色做出超出当前阶段的行为。`,\n            `在当前阶段（${stage}阶段），${character}不可能接受「${violationType}」类型的行为。`,\n            `作为惩罚机制，苏文强制介入打断当前场景。`,\n            ``,\n            `【场景设定】`,\n            `苏文突然出现在门口，神情严肃。`,\n            `他似乎察觉到了什么不对劲，目光在${character}和{{user}}之间来回扫视。`,\n            ``,\n            `【${character}的反应】`,\n            characterReaction,\n            innerThought,\n            ``,\n            `【核心演出要求】`,\n            `1. ${character}必须表现出强烈的拒绝/惊慌/羞耻`,\n            `2. 她会主动与{{user}}拉开距离，整理仪容`,\n            `3. 用大量内心独白表现她的心理冲突——\"这太过分了\"、\"我怎么能...\"`,\n            `4. 苏文的介入让她如梦初醒，意识到刚才差点发生什么`,\n            `5. 即使{{user}}继续尝试，${character}也会坚决拒绝`,\n            ``,\n            `【苏文的台词】（随机选择一个）`,\n            `- \"你们在干什么？\"（语气严肃）`,\n            `- \"小璐，过来一下，我有话跟你说。\"（带着审视的目光）`,\n            `- \"怎么房间门关着？里面发生什么了？\"（皱眉）`,\n            ``,\n            `【绝对禁止】`,\n            `- 禁止让${character}接受或配合{{user}}的越界要求`,\n            `- 禁止继续之前的越界剧情`,\n            `- 禁止淡化苏文的介入`,\n            `- 禁止描写${character}对越界行为的享受或接受`,\n            ``,\n            `【后续机制】`,\n            `如同普通打断事件，玩家需要在下一轮输入借口。`,\n            `由于是越界触发，借口判定难度+20%。`,\n            ``,\n            `请演绎这个被打断的尴尬场景，展现${character}的羞耻和苏文的严肃。`,\n        ].join('\\n');\n    }\n    /**\n     * 生成越界打断的 prefill\n     */\n    function generateBoundaryViolationPrefill() {\n        return `（门突然被推开，苏文站在门口，脸色阴沉...）\n\n`;\n    }\n    /**\n     * 生成苏文打断事件的用户消息替换内容（方案3：直接触发+借口判定）\n     * 苏文直接出现并质问，玩家下一轮输入借口，AI判定成功/失败\n     */\n    function generateInterruptionUserMessage(character, stage, accumulatedTime) {\n        // 随机选择一个场景变体\n        const scenario = interruptionScenarios[Math.floor(Math.random() * interruptionScenarios.length)];\n        // 根据阶段生成不同的反应提示（5阶段系统）\n        let reactionHint = '';\n        let innerThought = '';\n        if (stage <= 1) {\n            const reactions = [\n                `${character}非常慌张、心虚、急忙整理仪容，借口说得结结巴巴，心跳加速，脸色发白`,\n                `${character}整个人僵住了一瞬，然后手忙脚乱地站起来，声音发颤`,\n                `${character}的眼睛瞬间睁大，脸色瞬间变得苍白，大脑一片空白`,\n            ];\n            const thoughts = [\n                `（${character}的内心：糟糕！被发现了吗？我、我该怎么解释...）`,\n                `（${character}的内心：完了完了完了...他看到了多少？我该说什么？）`,\n                `（${character}的内心：心跳好快...手在抖...冷静下来，冷静下来...）`,\n            ];\n            reactionHint = reactions[Math.floor(Math.random() * reactions.length)];\n            innerThought = thoughts[Math.floor(Math.random() * thoughts.length)];\n        }\n        else if (stage <= 2) {\n            const reactions = [\n                `${character}表面镇定但内心紧张，能编出较好的借口，但手指微微颤抖`,\n                `${character}深吸一口气，强迫自己冷静下来，声音虽然平稳但眼神有些飘忽`,\n                `${character}下意识地整理了一下头发，露出一个略显僵硬的微笑`,\n            ];\n            const thoughts = [\n                `（${character}的内心：冷静...冷静...想一个合理的借口...）`,\n                `（${character}的内心：还好还好...应该没看到什么...表现得自然一点...）`,\n                `（${character}的内心：深呼吸...只是正常的聊天...对，就是这样...）`,\n            ];\n            reactionHint = reactions[Math.floor(Math.random() * reactions.length)];\n            innerThought = thoughts[Math.floor(Math.random() * thoughts.length)];\n        }\n        else if (stage <= 3) {\n            const reactions = [\n                `${character}已经不太在意被发现，敷衍地应付苏文，甚至暗暗感到一丝刺激`,\n                `${character}慢条斯理地站起来，脸上带着淡淡的笑意，完全不慌不忙`,\n                `${character}只是挑了挑眉，神态自若地转过身来，眼底甚至闪过一丝玩味`,\n            ];\n            const thoughts = [\n                `（${character}的内心：又来打扰...真是烦人...）`,\n                `（${character}的内心：差一点...真是会挑时候...）`,\n                `（${character}的内心：哼，就让他猜去吧...反正他也不会知道真相...）`,\n            ];\n            reactionHint = reactions[Math.floor(Math.random() * reactions.length)];\n            innerThought = thoughts[Math.floor(Math.random() * thoughts.length)];\n        }\n        else {\n            const reactions = [\n                `${character}完美表演、滴水不漏，从容应对，苏文完全看不出任何异常`,\n                `${character}优雅地起身，神态自然得仿佛只是在进行最普通的对话`,\n                `${character}脸上露出温柔的笑容，声音平稳而亲切，每个细节都无可挑剔`,\n            ];\n            const thoughts = [\n                `（${character}的内心：呵，就这点小场面...）`,\n                `（${character}的内心：演技这种东西，早就炉火纯青了...）`,\n                `（${character}的内心：傻瓜永远都不会知道真相...继续扮演你的好妻子吧...）`,\n            ];\n            reactionHint = reactions[Math.floor(Math.random() * reactions.length)];\n            innerThought = thoughts[Math.floor(Math.random() * thoughts.length)];\n        }\n        // 随机选择一个台词\n        const selectedDialogue = scenario.dialogues[Math.floor(Math.random() * scenario.dialogues.length)];\n        return [\n            `【系统强制事件：苏文打断】`,\n            ``,\n            `═══════════════════════════════════════════════════════════════`,\n            `  ⚠️ ${character}在{{user}}房间停留过久（${accumulatedTime}小时），苏文强制介入！`,\n            `═══════════════════════════════════════════════════════════════`,\n            ``,\n            `【最高优先级】本轮必须演绎苏文打断事件，暂停其他剧情！`,\n            ``,\n            `【场景设定】`,\n            scenario.scene,\n            ``,\n            `【苏文说】`,\n            selectedDialogue,\n            ``,\n            `【${character}的反应】`,\n            `${reactionHint}`,\n            `${innerThought}`,\n            ``,\n            `【演出要求】`,\n            `1. 用大量内心独白展现${character}被抓包时的心理活动`,\n            `2. 描写她的表情变化、身体反应（心跳、脸红、手抖等）`,\n            `3. 苏文的性格：略显木讷、工作忙碌、不太细心但偶尔敏锐`,\n            `4. 可以描写${character}急忙整理仪容/掩饰痕迹的细节`,\n            `5. 苏文在门口等待解释，不要让他直接离开`,\n            ``,\n            `【借口判定机制】`,\n            `⚠️ 本轮结束后，玩家将在下一轮输入借口内容`,\n            `⚠️ AI需要在下一轮根据借口质量判定成功或失败：`,\n            `  - 借口成功：苏文相信，疑心值不变，${character}可以继续留在房间`,\n            `  - 借口失败：苏文起疑，疑心值+10，${character}必须离开房间`,\n            ``,\n            `【借口发言人规则】⚠️ 重要 ⚠️`,\n            `- 借口必须由${character}说出才能生效`,\n            `- 如果{{user}}直接说出借口（而不是让${character}说），则自动判定失败`,\n            `- 正确做法：玩家引导${character}找借口，由${character}向苏文解释`,\n            `- 错误做法：{{user}}直接对苏文说\"她是来帮我xxx的\"`,\n            ``,\n            `【判定标准】`,\n            `- ⚠️ 发言人检查：借口是否由${character}说出（{{user}}直接说=自动失败）`,\n            `- 借口合理性（是否符合常理、是否有逻辑漏洞）`,\n            `- ${character}当前阶段（阶段越高演技越好，更容易成功）`,\n            `- 苏文当前疑心值（疑心值越高越难成功）`,\n            `- 场景证据（房间内是否有可疑痕迹）`,\n            ``,\n            `【绝对禁止】`,\n            `- 禁止忽略此事件继续之前的剧情`,\n            `- 禁止让苏文离开不管`,\n            `- 禁止代替玩家（{{user}}）说话或行动`,\n            `- 禁止在本轮就判定借口成功或失败（等待玩家下一轮输入）`,\n            ``,\n            `请演绎苏文出现并质问的场景，结尾等待${character}或{{user}}的解释。`,\n        ].join('\\n');\n    }\n    /**\n     * 生成打断事件的 Prefill（多样化版本）\n     */\n    function generateInterruptionPrefill() {\n        const scenario = interruptionScenarios[Math.floor(Math.random() * interruptionScenarios.length)];\n        return `【苏文打断事件】\\n\\n${scenario.prefill}\\n`;\n    }\n    /**\n     * 检测苏文巡逻事件是否待触发\n     * 【新逻辑】直接触发，设置离开期限，不再需要预警阶段\n     */\n    function detectPatrolEvent() {\n        try {\n            const variables = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const data = _.get(variables, 'stat_data');\n            if (!data?.系统追踪?.苏文巡逻事件?.待触发) {\n                return { triggered: false, character: null, stage: 1, triggerTime: '', patrolLocation: '' };\n            }\n            // 检查是否已通知AI（避免重复触发）\n            if (data.系统追踪.苏文巡逻事件.已通知AI) {\n                return { triggered: false, character: null, stage: 1, triggerTime: '', patrolLocation: '' };\n            }\n            const event = data.系统追踪.苏文巡逻事件;\n            const currentCharacter = (data.系统追踪?.当前角色 || '秦璐');\n            const stage = currentCharacter === '秦璐'\n                ? data.秦璐状态?.当前阶段 || 1\n                : data.苏梦状态?.当前阶段 || 1;\n            console.info(`[巡逻事件] 检测到待触发的巡逻事件，时间: ${event.触发时间}`);\n            return {\n                triggered: true,\n                character: currentCharacter,\n                stage,\n                triggerTime: event.触发时间 || '',\n                patrolLocation: event.巡逻位置 || '',\n            };\n        }\n        catch (err) {\n            console.error('[巡逻事件] 检测时出错:', err);\n            return { triggered: false, character: null, stage: 1, triggerTime: '', patrolLocation: '' };\n        }\n    }\n    /**\n     * 巡逻事件的场景变体\n     */\n    const patrolScenarios = [\n        {\n            name: '路过询问',\n            scene: '走廊里传来了脚步声。\\n苏文路过{{user}}房间门口，注意到门关着，停下了脚步...',\n            dialogues: [\n                '\"{{user}}？在房间里吗？\"',\n                '\"小璐？你也在吗？\"',\n                '（敲敲门）\"门怎么关着？\"',\n            ],\n            prefill: '（走廊里忽然传来了脚步声，苏文路过{{user}}房间门口...）\\n\\n',\n        },\n        {\n            name: '上厕所路过',\n            scene: '苏文去洗手间的路上，经过{{user}}房间。\\n他本来没打算停下，但还是习惯性地看了一眼...',\n            dialogues: [\n                '\"你们在里面吗？我去趟洗手间。\"（随口一问）',\n                '\"门关这么紧干嘛？\"（似乎只是顺口说说）',\n                '\"小璐在里面？在干嘛呢？\"（带着好奇）',\n            ],\n            prefill: '（走廊里传来拖鞋的声音，苏文经过房间门口...）\\n\\n',\n        },\n        {\n            name: '拿东西经过',\n            scene: '苏文从书房出来，手里拿着什么东西，经过{{user}}房间时停了一下...',\n            dialogues: [\n                '\"你们两个在里面？我去厨房拿点东西。\"',\n                '（看了眼门）\"关着门在聊什么呢？\"',\n                '\"{{user}}，你妈在你房间吗？\"',\n            ],\n            prefill: '（书房的门响了一声，然后是脚步声渐近...）\\n\\n',\n        },\n        {\n            name: '听到动静',\n            scene: '苏文在客厅看电视，隐约听到了{{user}}房间的动静。\\n他好奇地走过来，站在门口...',\n            dialogues: [\n                '\"你们在做什么？我好像听到了声音。\"',\n                '\"里面怎么了？动静挺大的。\"',\n                '\"小璐？没事吧？\"（带着一点担心）',\n            ],\n            prefill: '（客厅的电视声停了，然后是越来越近的脚步声...）\\n\\n',\n        },\n        {\n            name: '喊人吃东西',\n            scene: '苏文从厨房出来，想叫家人吃点水果或零食。\\n他走到{{user}}房间门口...',\n            dialogues: [\n                '\"我削了个苹果，你们要吃吗？\"',\n                '\"泡了壶茶，出来喝点？你们在里面干嘛呢？\"',\n                '\"有你们爱吃的零食，出来拿一下？门怎么关着？\"',\n            ],\n            prefill: '（厨房那边传来碗碟轻碰的声音，然后脚步声靠近...）\\n\\n',\n        },\n        {\n            name: '回房间睡觉',\n            scene: '苏文准备回房间休息，路过{{user}}房间时，发现灯还亮着...',\n            dialogues: [\n                '\"这么晚了还不睡？你们在里面聊什么？\"',\n                '\"我先去睡了，你们早点休息。门怎么关着？\"',\n                '\"小璐，你怎么还在{{user}}房间？不早了。\"',\n            ],\n            prefill: '（客厅的灯灭了，然后是走向卧室的脚步声...脚步在门口停住了...）\\n\\n',\n        },\n        {\n            name: '接完电话',\n            scene: '苏文刚接完一个电话，从阳台走回来。\\n经过{{user}}房间时，随口问了一句...',\n            dialogues: [\n                '（收起手机）\"刚才在接电话...你们两个在这里啊？\"',\n                '\"电话是公司的事...你们在里面待挺久了？\"',\n                '\"哎，工作的事真烦人...你们关着门在做什么？\"',\n            ],\n            prefill: '（阳台的门关上了，然后是脚步声...苏文似乎刚打完电话...）\\n\\n',\n        },\n        {\n            name: '找人帮忙',\n            scene: '苏文想找人帮个小忙，四处找人找到了{{user}}房间门口...',\n            dialogues: [\n                '\"有人在吗？能帮我搭把手吗？\"',\n                '\"小璐，你在这里？帮我看一下那个...等等，你们在干嘛？\"',\n                '\"{{user}}，你妈妈在吗？我需要她帮个忙。\"',\n            ],\n            prefill: '（房子里传来苏文找人的声音，脚步声越来越近...）\\n\\n',\n        },\n    ];\n    /**\n     * 生成苏文巡逻事件的用户消息替换内容（新逻辑：设置离开期限）\n     * 苏文路过时会要求角色1-2小时内离开，不需要借口判定\n     */\n    function generatePatrolUserMessage(character, stage) {\n        // 随机选择一个场景变体\n        const scenario = patrolScenarios[Math.floor(Math.random() * patrolScenarios.length)];\n        // 随机生成离开期限（1-2小时）\n        const deadlineHours = Math.random() < 0.5 ? 1 : 2;\n        // 根据阶段生成不同的反应提示（5阶段系统）\n        let reactionHint = '';\n        let innerThought = '';\n        if (stage <= 1) {\n            const reactions = [\n                `${character}心跳加速，急忙整理仪容，脸色微变，语气有些不自然`,\n                `${character}下意识地坐直身体，声音略微发紧，努力表现得若无其事`,\n                `${character}的手指不自觉地攥紧了一下，然后强迫自己放松`,\n            ];\n            const thoughts = [\n                `（${character}的内心：怎么这个时候过来了...冷静...冷静...）`,\n                `（${character}的内心：不要慌...只是普通的问话...自然一点...）`,\n                `（${character}的内心：他不会发现什么的...对吧...？）`,\n            ];\n            reactionHint = reactions[Math.floor(Math.random() * reactions.length)];\n            innerThought = thoughts[Math.floor(Math.random() * thoughts.length)];\n        }\n        else if (stage <= 2) {\n            const reactions = [\n                `${character}稍显紧张，但能维持表面镇定，回答时带着一点犹豫`,\n                `${character}神态基本平静，只是说话的时候眼神有一瞬间的闪躲`,\n                `${character}轻轻清了清嗓子，声音平稳但略显刻意`,\n            ];\n            const thoughts = [\n                `（${character}的内心：只是普通的问候...不要表现得太奇怪...）`,\n                `（${character}的内心：随便应付一下就好...他不会多想的...）`,\n                `（${character}的内心：保持微笑...正常的语气...没什么好紧张的...）`,\n            ];\n            reactionHint = reactions[Math.floor(Math.random() * reactions.length)];\n            innerThought = thoughts[Math.floor(Math.random() * thoughts.length)];\n        }\n        else if (stage <= 3) {\n            const reactions = [\n                `${character}从容应对，脸上挂着得体的笑容，内心却暗暗不满被打扰`,\n                `${character}懒洋洋地回应，神态自若，甚至带着一丝不耐烦`,\n                `${character}淡淡地扫了门口一眼，表情没有任何波动`,\n            ];\n            const thoughts = [\n                `（${character}的内心：又来了...真是扫兴...）`,\n                `（${character}的内心：烦不烦啊...就不能让人清静一会吗...）`,\n                `（${character}的内心：随便打发他走就好了...）`,\n            ];\n            reactionHint = reactions[Math.floor(Math.random() * reactions.length)];\n            innerThought = thoughts[Math.floor(Math.random() * thoughts.length)];\n        }\n        else {\n            const reactions = [\n                `${character}完美地扮演着日常角色，应对自如，毫无破绽`,\n                `${character}转过头来，脸上是恰到好处的温柔笑容，声音亲切自然`,\n                `${character}的反应完美无瑕，任何人都看不出一丝异常`,\n            ];\n            const thoughts = [\n                `（${character}的内心：呵，演戏而已...）`,\n                `（${character}的内心：这种小场面，闭着眼都能应付...）`,\n                `（${character}的内心：可怜的人，永远都不会知道真相...）`,\n            ];\n            reactionHint = reactions[Math.floor(Math.random() * reactions.length)];\n            innerThought = thoughts[Math.floor(Math.random() * thoughts.length)];\n        }\n        // 随机选择一个台词\n        const selectedDialogue = scenario.dialogues[Math.floor(Math.random() * scenario.dialogues.length)];\n        // 苏文要求离开的台词变体\n        const leaveRequests = [\n            `\"好了，你们也别聊太久了，${deadlineHours}小时后该做饭了/该休息了。\"`,\n            `\"行，我不打扰你们了，不过差不多${deadlineHours}小时后出来一下吧。\"`,\n            `\"嗯...好吧，不过别待太久，${deadlineHours}小时后该出来活动活动了。\"`,\n            `\"那你们继续，${deadlineHours}小时后记得出来。\"`,\n        ];\n        const leaveRequest = leaveRequests[Math.floor(Math.random() * leaveRequests.length)];\n        return [\n            `【系统强制事件：苏文巡逻】`,\n            ``,\n            `═══════════════════════════════════════════════════════════════`,\n            `  ⚠️ 苏文路过{{user}}房间，随机触发！`,\n            `═══════════════════════════════════════════════════════════════`,\n            ``,\n            `【最高优先级】本轮必须演绎苏文巡逻事件，暂停其他剧情！`,\n            ``,\n            `【场景设定】`,\n            scenario.scene,\n            ``,\n            `【苏文说】`,\n            selectedDialogue,\n            ``,\n            `【${character}的反应】`,\n            `${reactionHint}`,\n            `${innerThought}`,\n            ``,\n            `【苏文的要求】`,\n            `苏文简单问询后，会要求${character}在${deadlineHours}小时内离开房间：`,\n            leaveRequest,\n            ``,\n            `【演出要求】`,\n            `1. 用内心独白展现${character}被问询时的心理活动`,\n            `2. 描写她的表情管理、语气控制`,\n            `3. ${character}需要给苏文一个简单的回应（不需要复杂借口）`,\n            `4. 苏文会自然地提出离开期限要求，然后离开`,\n            `5. 苏文的性格：略显木讷、工作忙碌、不太细心但偶尔敏锐`,\n            ``,\n            `【离开期限机制】`,\n            `⚠️ 苏文已设置${deadlineHours}小时的离开期限`,\n            `⚠️ ${character}必须在期限内离开{{user}}房间`,\n            `⚠️ 如果超时不离开，将触发【苏文打断事件】`,\n            ``,\n            `【绝对禁止】`,\n            `- 禁止忽略此事件继续之前的剧情`,\n            `- 禁止代替玩家（{{user}}）说话或行动`,\n            `- 禁止让苏文不提出离开要求就离开`,\n            ``,\n            `请演绎这个巡逻场景，包括苏文的问询和离开要求。`,\n        ].join('\\n');\n    }\n    /**\n     * 生成巡逻事件的 Prefill（多样化版本）\n     */\n    function generatePatrolPrefill() {\n        const scenario = patrolScenarios[Math.floor(Math.random() * patrolScenarios.length)];\n        return `【苏文巡逻事件】\\n\\n${scenario.prefill}`;\n    }\n    /**\n     * 检测阶段突破并返回触发信息（5阶段系统）\n     * 当角色阶段变化时，返回需要触发的隐藏剧情信息\n     */\n    function detectStageBreakthrough() {\n        try {\n            const variables = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            const data = _.get(variables, 'stat_data');\n            if (!data) {\n                return { character: null, newStage: null };\n            }\n            // 检查秦璐的阶段突破\n            const qinluPending = data.系统追踪?.秦璐外观待更新;\n            if (qinluPending?.需要更新 && qinluPending.目标阶段 > 1) {\n                const newStage = qinluPending.目标阶段;\n                console.info(`[阶段突破] 检测到秦璐阶段突破: 阶段${newStage}(${getStageTitle(newStage)})`);\n                return { character: '秦璐', newStage };\n            }\n            // 检查苏梦的阶段突破\n            const sumengPending = data.系统追踪?.苏梦外观待更新;\n            if (sumengPending?.需要更新 && sumengPending.目标阶段 > 1) {\n                const newStage = sumengPending.目标阶段;\n                console.info(`[阶段突破] 检测到苏梦阶段突破: 阶段${newStage}(${getStageTitle(newStage)})`);\n                return { character: '苏梦', newStage };\n            }\n            return { character: null, newStage: null };\n        }\n        catch (err) {\n            console.error('[阶段突破] 检测时出错:', err);\n            return { character: null, newStage: null };\n        }\n    }\n    /**\n     * 生成阶段突破的用户消息替换内容\n     * 直接替换用户消息，使 AI 认为用户请求的是触发隐藏剧情\n     */\n    function generateStageBreakthroughUserMessage(character, newStage) {\n        const stageTitle = getStageTitle(newStage);\n        const injection = generateStageBreakthroughInjection(character, newStage);\n        // 将 OOC 格式转换为直接的用户请求格式\n        // 移除 \"OOC:\" 前缀，改为更直接的剧情触发格式\n        const cleanedInjection = injection\n            .replace(/^OOC:\\s*/gm, '')\n            .replace(/【强制剧情事件[^】]*】/g, '')\n            .trim();\n        return [\n            `【系统触发：${character}阶段${newStage}「${stageTitle}」隐藏剧情】`,\n            ``,\n            `玩家当前的行动暂时搁置，请先演绎以下隐藏剧情事件。`,\n            ``,\n            cleanedInjection,\n            ``,\n            `请完整演绎这段隐藏剧情，结束后恢复正常互动。`,\n        ].join('\\n');\n    }\n    /**\n     * 生成完整的注入内容（状态一致性 + 信息隔离 + 念头植入 + 习惯影响 + 强制事件）\n     * 所有强制事件（阶段突破、打断、巡逻）都通过直接替换用户消息内容实现\n     */\n    function generateFullInjection() {\n        const normalParts = [];\n        // 1. 状态一致性检查\n        const stateReminder = generateStateConsistencyReminder();\n        if (stateReminder) {\n            normalParts.push(stateReminder);\n        }\n        // 2. 信息隔离提醒（秦璐和苏梦之间的信息隔离）\n        const isolationReminder = generateInformationIsolationReminder();\n        if (isolationReminder) {\n            normalParts.push(isolationReminder);\n        }\n        // 3. 习惯影响\n        const habitsText = generateHabitsInjection();\n        if (habitsText) {\n            normalParts.push(habitsText);\n        }\n        // 4. 外观提醒（当前角色的服装和妆容）\n        const appearanceReminder = generateAppearanceReminder();\n        if (appearanceReminder) {\n            normalParts.push(appearanceReminder);\n        }\n        // 5. 待判定念头的类型判定提示\n        const pendingThoughtJudge = generatePendingThoughtJudgePrompt();\n        if (pendingThoughtJudge) {\n            normalParts.push(pendingThoughtJudge);\n        }\n        const normalContent = normalParts.length > 0 ? normalParts.join('\\n\\n') : stateReminder;\n        // 6. 念头植入通知（单独返回，在最后一条user消息后注入）\n        const thoughtImplantText = generateThoughtImplantNotifications();\n        // 7. 检查强制事件（优先使用日志机制，支持ROLL后重新触发）\n        // 所有强制事件都使用用户消息替换模式，确保最高执行优先级\n        let forcedEvent = {\n            type: null,\n            character: null,\n            userMessageContent: null,\n            prefill: null,\n        };\n        // 【最高优先级】检测越界行为 - 用户试图在低阶段引导极端行为\n        // 如果检测到越界，直接触发苏文打断，不检查其他事件\n        const boundaryViolation = detectBoundaryViolation();\n        if (boundaryViolation) {\n            const { character, stage, violationType, matchedKeyword } = boundaryViolation;\n            forcedEvent = {\n                type: 'boundaryViolation',\n                character,\n                userMessageContent: generateBoundaryViolationUserMessage(character, stage, violationType),\n                prefill: generateBoundaryViolationPrefill(),\n                violationType,\n            };\n            console.warn(`[习惯注入] ⚠️ 检测到越界行为！阶段${stage}禁止「${violationType}」，关键词: \"${matchedKeyword}\"，触发打断`);\n            // 越界行为检测到后，直接返回，不再检查其他事件\n            return {\n                normal: normalContent,\n                thoughtImplant: thoughtImplantText,\n                forcedEvent,\n            };\n        }\n        // 【优先】从强制事件日志中检测（支持ROLL后重新触发）\n        // 【新逻辑】所有事件直接触发，不再需要预警阶段\n        const logEvent = detectForcedEventFromLog();\n        if (logEvent.type && logEvent.character) {\n            const { type, character, stage, accumulatedTime, stageNumber, triggerTime, logIndex } = logEvent;\n            if (type === '阶段突破' && stageNumber) {\n                forcedEvent = {\n                    type: 'stageBreakthrough',\n                    character,\n                    userMessageContent: generateStageBreakthroughUserMessage(character, stageNumber),\n                    prefill: generateStageBreakthroughPrefill(character, stageNumber),\n                    stageNumber,\n                    logIndex,\n                };\n                console.info(`[习惯注入] 从日志检测到阶段突破，将替换用户消息 (${character} 阶段${stageNumber})`);\n            }\n            else if (type === '苏文打断') {\n                // 直接触发打断事件（方案3：借口判定）\n                forcedEvent = {\n                    type: 'interruption',\n                    character,\n                    userMessageContent: generateInterruptionUserMessage(character, stage, accumulatedTime),\n                    prefill: generateInterruptionPrefill(),\n                    accumulatedTime,\n                    logIndex,\n                };\n                console.info(`[习惯注入] 从日志检测到打断事件，将替换用户消息 (${character}, 累计${accumulatedTime}小时)`);\n            }\n            else if (type === '苏文巡逻') {\n                // 直接触发巡逻事件（设置离开期限）\n                forcedEvent = {\n                    type: 'patrol',\n                    character,\n                    userMessageContent: generatePatrolUserMessage(character, stage),\n                    prefill: generatePatrolPrefill(),\n                    triggerTime,\n                    logIndex,\n                };\n                console.info(`[习惯注入] 从日志检测到巡逻事件，将替换用户消息 (${character}, 时间${triggerTime})`);\n            }\n        }\n        // 【兼容】如果日志中没有，回退到旧的检测逻辑\n        // 【新逻辑】所有事件直接触发，不再需要预警阶段\n        if (!forcedEvent.type) {\n            // 检查阶段突破（最高优先级）\n            const stageBreakthroughInfo = detectStageBreakthrough();\n            if (stageBreakthroughInfo.character && stageBreakthroughInfo.newStage) {\n                const { character, newStage } = stageBreakthroughInfo;\n                forcedEvent = {\n                    type: 'stageBreakthrough',\n                    character,\n                    userMessageContent: generateStageBreakthroughUserMessage(character, newStage),\n                    prefill: generateStageBreakthroughPrefill(character, newStage),\n                    stageNumber: newStage,\n                };\n                console.info(`[习惯注入] 检测到阶段突破，将替换用户消息 (${character} 阶段${newStage})`);\n            }\n            // 检查打断事件（次优先级）- 仅在没有阶段突破时\n            if (!forcedEvent.type) {\n                const interruptionInfo = detectInterruptionEvent();\n                if (interruptionInfo.triggered && interruptionInfo.character) {\n                    const { character, stage, accumulatedTime } = interruptionInfo;\n                    // 直接触发打断事件（方案3：借口判定）\n                    forcedEvent = {\n                        type: 'interruption',\n                        character,\n                        userMessageContent: generateInterruptionUserMessage(character, stage, accumulatedTime),\n                        prefill: generateInterruptionPrefill(),\n                        accumulatedTime,\n                    };\n                    console.info(`[习惯注入] 检测到打断事件，将替换用户消息 (${character}, 累计${accumulatedTime}小时)`);\n                }\n            }\n            // 检查巡逻事件（最低优先级）- 仅在没有阶段突破和打断时\n            if (!forcedEvent.type) {\n                const patrolInfo = detectPatrolEvent();\n                if (patrolInfo.triggered && patrolInfo.character) {\n                    const { character, stage, triggerTime } = patrolInfo;\n                    // 直接触发巡逻事件（设置离开期限）\n                    forcedEvent = {\n                        type: 'patrol',\n                        character,\n                        userMessageContent: generatePatrolUserMessage(character, stage),\n                        prefill: generatePatrolPrefill(),\n                        triggerTime,\n                    };\n                    console.info(`[习惯注入] 检测到巡逻事件，将替换用户消息 (${character}, 时间${triggerTime})`);\n                }\n            }\n        }\n        return {\n            normal: normalContent,\n            thoughtImplant: thoughtImplantText,\n            forcedEvent,\n        };\n    }\n    /**\n     * 标记强制事件已处理（更新变量状态）\n     * 同时标记强制事件日志中的对应条目为已通知\n     */\n    function markForcedEventHandled(forcedEvent) {\n        if (!forcedEvent.type || !forcedEvent.character)\n            return;\n        try {\n            const currentVars = Mvu.getMvuData({ type: 'message', message_id: -1 });\n            // 【关键】如果是从日志检测到的事件，标记日志条目为已通知\n            if (forcedEvent.logIndex !== undefined && forcedEvent.logIndex >= 0) {\n                const logs = _.get(currentVars, 'stat_data.系统追踪.强制事件日志', []);\n                if (logs[forcedEvent.logIndex]) {\n                    logs[forcedEvent.logIndex].已通知AI = true;\n                    console.info(`[习惯注入] 已标记强制事件日志[${forcedEvent.logIndex}]为已通知`);\n                }\n            }\n            // 同时更新旧的状态标记（保持兼容性）\n            switch (forcedEvent.type) {\n                case 'stageBreakthrough':\n                    if (forcedEvent.character === '秦璐') {\n                        _.set(currentVars, 'stat_data.系统追踪.秦璐外观待更新.需要更新', false);\n                        _.set(currentVars, 'stat_data.系统追踪.秦璐外观待更新.变化原因', '阶段突破剧情已触发');\n                    }\n                    else {\n                        _.set(currentVars, 'stat_data.系统追踪.苏梦外观待更新.需要更新', false);\n                        _.set(currentVars, 'stat_data.系统追踪.苏梦外观待更新.变化原因', '阶段突破剧情已触发');\n                    }\n                    console.info(`[习惯注入] 已标记阶段突破事件为已处理`);\n                    break;\n                case 'interruption':\n                    _.set(currentVars, 'stat_data.系统追踪.苏文打断事件.已通知AI', true);\n                    _.set(currentVars, 'stat_data.系统追踪.苏文打断事件.待触发', false);\n                    console.info(`[习惯注入] 已标记打断事件为已处理`);\n                    break;\n                case 'patrol':\n                    _.set(currentVars, 'stat_data.系统追踪.苏文巡逻事件.已通知AI', true);\n                    _.set(currentVars, 'stat_data.系统追踪.苏文巡逻事件.待触发', false);\n                    console.info(`[习惯注入] 已标记巡逻事件为已处理`);\n                    break;\n            }\n            Mvu.replaceMvuData(currentVars, { type: 'message', message_id: -1 });\n        }\n        catch (mvuErr) {\n            console.error(`[习惯注入] 标记强制事件失败:`, mvuErr);\n        }\n    }\n    // 监听 CHAT_COMPLETION_PROMPT_READY 事件\n    eventOn(tavern_events.CHAT_COMPLETION_PROMPT_READY, (event_data) => {\n        try {\n            const { chat, dryRun } = event_data;\n            // 【关键】dryRun 时跳过所有状态修改操作\n            // dryRun 是酒馆用于计算 token 等的测试运行，不应该触发任何状态变更\n            if (dryRun) {\n                console.info(`[习惯注入] dryRun=true，跳过注入（仅计算 token）`);\n                return;\n            }\n            const { normal, thoughtImplant, forcedEvent } = generateFullInjection();\n            // 酒馆自动添加的系统提示语列表（这些不是用户的实际输入）\n            const systemPrompts = [\n                'Now go ahead MW and pass the review.',\n                'Now continue the script',\n                '[Continue]',\n                'Continue',\n            ];\n            /**\n             * 查找最后一条真正的用户消息位置\n             */\n            function findLastRealUserIndex() {\n                for (let i = chat.length - 1; i >= 0; i--) {\n                    if (chat[i].role === 'user') {\n                        const rawContent = chat[i].content;\n                        const content = typeof rawContent === 'string' ? rawContent : '';\n                        const trimmed = content.trim();\n                        const isSystemPrompt = systemPrompts.some(prompt => trimmed === prompt || trimmed.startsWith(prompt));\n                        if (!isSystemPrompt) {\n                            return i;\n                        }\n                    }\n                }\n                return -1;\n            }\n            // ========== 处理空 chat 数组的情况 ==========\n            if (chat.length === 0) {\n                if (normal) {\n                    chat.push({ role: 'system', content: normal });\n                }\n                if (thoughtImplant) {\n                    chat.push({ role: 'system', content: thoughtImplant });\n                }\n                // 强制事件：如果 chat 为空，直接添加用户消息\n                if (forcedEvent.userMessageContent) {\n                    chat.push({ role: 'user', content: forcedEvent.userMessageContent });\n                    console.info(`[习惯注入] chat 为空，添加强制事件用户消息 (${forcedEvent.type})`);\n                    markForcedEventHandled(forcedEvent);\n                }\n                // 注意：空 chat 时不添加 prefill，因为无法确定是否是 extended thinking 模式\n                // 如果需要 prefill 效果，已经在 userMessageContent 中包含了足够的引导\n                console.info('[习惯注入] chat 数组为空，已添加消息');\n                return;\n            }\n            // ========== 强制事件触发：直接替换用户消息内容 ==========\n            // 【新逻辑】所有强制事件直接触发，不再有预警阶段\n            // 打断事件：苏文直接出现并质问，玩家下一轮输入借口，AI判定成功/失败\n            // 巡逻事件：苏文设置1-2小时离开期限，超时则触发打断事件\n            if (forcedEvent.type && forcedEvent.userMessageContent && forcedEvent.character) {\n                // 找到最后一条用户消息\n                let lastUserIndex = -1;\n                for (let i = chat.length - 1; i >= 0; i--) {\n                    if (chat[i].role === 'user') {\n                        lastUserIndex = i;\n                        break;\n                    }\n                }\n                if (lastUserIndex !== -1) {\n                    // 替换用户消息内容\n                    chat[lastUserIndex].content = forcedEvent.userMessageContent;\n                    // 生成日志信息\n                    let logInfo = `[习惯注入] 强制事件触发: ${forcedEvent.type}`;\n                    if (forcedEvent.type === 'stageBreakthrough') {\n                        logInfo += ` (${forcedEvent.character} 阶段${forcedEvent.stageNumber})`;\n                    }\n                    else if (forcedEvent.type === 'interruption') {\n                        logInfo += ` (${forcedEvent.character}, 累计${forcedEvent.accumulatedTime}小时)`;\n                    }\n                    else if (forcedEvent.type === 'patrol') {\n                        logInfo += ` (${forcedEvent.character}, 时间${forcedEvent.triggerTime})`;\n                    }\n                    console.info(logInfo);\n                    // 标记强制事件已处理\n                    markForcedEventHandled(forcedEvent);\n                }\n                // 添加 Prefill（强制 AI 回复的开头）\n                // 根据 Claude 官方文档：https://platform.claude.com/docs/en/build-with-claude/extended-thinking\n                // \"Prefilling is only available for non-extended thinking modes. It's not currently supported with extended thinking.\"\n                // 因此在 extended thinking 模式下，我们将 prefill 内容作为 system 提示添加，引导 AI 按预期格式开始回复\n                if (forcedEvent.prefill && !currentRequestHasExtendedThinking) {\n                    // 非 extended thinking 模式：正常添加 prefill\n                    chat.push({ role: 'assistant', content: forcedEvent.prefill });\n                    console.info(`[习惯注入] 已添加强制事件 Prefill: \"${forcedEvent.prefill.substring(0, 30)}...\"`);\n                }\n                else if (forcedEvent.prefill && currentRequestHasExtendedThinking) {\n                    // extended thinking 模式：将 prefill 作为 system 提示追加，引导 AI 以此开头\n                    const prefillGuidance = `【回复格式要求】请以以下内容作为回复的开头：\\n${forcedEvent.prefill}`;\n                    chat.push({ role: 'system', content: prefillGuidance });\n                    console.info(`[习惯注入] 检测到 extended thinking 模式，将 Prefill 转换为 system 提示`);\n                }\n                // 强制事件时，只添加状态一致性和习惯注入\n                let firstUserIndex = -1;\n                for (let i = 0; i < chat.length; i++) {\n                    if (chat[i].role === 'user') {\n                        firstUserIndex = i;\n                        break;\n                    }\n                }\n                if (normal) {\n                    const normalInsertIndex = firstUserIndex === -1 ? chat.length : firstUserIndex;\n                    chat.splice(normalInsertIndex, 0, { role: 'system', content: normal });\n                }\n                return; // 强制事件处理完成，跳过其他注入\n            }\n            // ========== 无强制事件：正常注入逻辑 ==========\n            // 找到第一条 role='user' 的消息位置（用于插入普通提示）\n            let firstUserIndex = -1;\n            for (let i = 0; i < chat.length; i++) {\n                if (chat[i].role === 'user') {\n                    firstUserIndex = i;\n                    break;\n                }\n            }\n            // 1. 插入普通提示（状态一致性 + 习惯）在第一条 user 消息之前\n            if (normal) {\n                const normalInsertIndex = firstUserIndex === -1 ? chat.length : firstUserIndex;\n                chat.splice(normalInsertIndex, 0, {\n                    role: 'system',\n                    content: normal,\n                });\n                console.info(`[习惯注入] 已在位置 ${normalInsertIndex} 注入状态一致性检查和习惯列表`);\n            }\n            // 2. 插入念头植入通知\n            if (thoughtImplant) {\n                const lastRealUserIndex = findLastRealUserIndex();\n                console.info(`[习惯注入] 最后一条真正用户消息位置: ${lastRealUserIndex}`);\n                if (lastRealUserIndex !== -1) {\n                    const insertIndex = lastRealUserIndex + 1;\n                    chat.splice(insertIndex, 0, {\n                        role: 'system',\n                        content: thoughtImplant,\n                    });\n                    console.info(`[习惯注入] 已在真正用户消息后（位置 ${insertIndex}）注入念头植入通知`);\n                }\n                else {\n                    chat.push({\n                        role: 'system',\n                        content: thoughtImplant,\n                    });\n                    console.info(`[习惯注入] 没有找到真正用户消息，已在数组末尾注入念头植入通知`);\n                }\n            }\n        }\n        catch (err) {\n            console.error('[习惯注入] 注入时发生错误:', err);\n        }\n    });\n    console.info('[习惯注入脚本] 加载完成，事件监听已注册');\n});\n"],"names":["STAGE_CONFIG","STAGE_STORY_CONFIG","getStageConfig","stage","find","config","getStageTitle","generateStageBreakthroughInjection","character","newStage","storyConfig","story","generateStageBreakthroughPrefill","DETAILED_THOUGHT_TYPES","type","keywords","parentCategory","recommendedStage","min","max","LOCAL_KEYWORDS","result","category","keyword","includes","push","STAGE_REQUIREMENTS","allowed","extra","Vue","$","async","waitGlobalInitialized","console","info","currentRequestHasExtendedThinking","eventOn","tavern_events","CHAT_COMPLETION_SETTINGS_READY","generate_data","include_reasoning","getInfluenceDescription","count","level","description","example","interruptionScenarios","name","scene","dialogues","prefill","EXTRA_VIOLATION_KEYWORDS","getBoundaryKeywords","behaviorType","baseKeywords","Set","ALL_THOUGHT_CATEGORIES","detectBoundaryViolation","chat","SillyTavern","length","lastUserMessage","i","is_user","mes","variables","Mvu","getMvuData","message_id","data","_","get","suwenState","suspicionFreezeFieldName","suspicionFreeze","hospitalizationState","sleepingPillState","currentCharacter","characterState","forbiddenTypes","stageReq","filter","cat","getForbiddenBehaviors","warn","violated","violationType","matchedKeyword","err","error","generateBoundaryViolationUserMessage","characterReaction","innerThought","join","generateInterruptionUserMessage","accumulatedTime","scenario","Math","floor","random","reactionHint","reactions","thoughts","selectedDialogue","generateInterruptionPrefill","patrolScenarios","generatePatrolUserMessage","deadlineHours","leaveRequests","leaveRequest","generatePatrolPrefill","generateStageBreakthroughUserMessage","replace","trim","generateFullInjection","normalParts","stateReminder","currentDate","currentTime","suwenLocation","timeDescription","hour","split","map","Number","parts","generateStateConsistencyReminder","isolationReminder","otherCharacter","qinluState","sumengState","otherState","otherStage","generateInformationIsolationReminder","habitsText","qinluHabits","h","sumengHabits","generateHabitsInjection","appearanceReminder","clothing","makeup","bodyMod","tempMarks","warnings","exposureLevel","forEach","w","generateAppearanceReminder","pendingThoughtJudge","pendingThoughts","t","target","content","generatePendingThoughtJudgePrompt","normalContent","thoughtImplantText","logs","unnotifiedCount","l","thoughtsByTarget","log","Object","entries","thoughtList","message","hasUnnotified","currentVars","set","replaceMvuData","mvuErr","generateThoughtImplantNotifications","forcedEvent","userMessageContent","boundaryViolation","normal","thoughtImplant","logEvent","currentFloor","getLastMessageId","reason","logIndex","priorityOrder","validLogs","index","floorDiff","sort","a","b","stageNumber","triggerTime","patrolLocation","detectForcedEventFromLog","stageBreakthroughInfo","qinluPending","sumengPending","detectStageBreakthrough","interruptionInfo","triggered","event","detectInterruptionEvent","patrolInfo","detectPatrolEvent","markForcedEventHandled","undefined","CHAT_COMPLETION_PROMPT_READY","event_data","dryRun","systemPrompts","findLastRealUserIndex","role","rawContent","trimmed","some","prompt","startsWith","lastUserIndex","logInfo","substring","prefillGuidance","firstUserIndex","normalInsertIndex","splice","lastRealUserIndex","insertIndex"],"ignoreList":[],"sourceRoot":""}