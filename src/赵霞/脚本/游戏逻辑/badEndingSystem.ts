/**
 * 赵霞游戏 - 坏结局系统
 *
 * 属于系统A：事件触发系统
 * - 当怀疑度达到100时触发
 * - 触发后持续替换用户消息，游戏无法继续
 * - 支持ROLL消息，ROLL后仍然会触发坏结局
 *
 * 【坏结局触发条件】
 * - 丈夫怀疑度 >= 100：发现结局（本文件处理）
 *
 * 【混乱结局】（精神崩溃）
 * - 记忆混乱度 >= 100：由 confusionEndingSystem.ts 主要处理
 * - 本文件的混乱度检测仅作为备用兜底，正常情况下不会执行到
 */

import type { Schema as SchemaType } from '../../schema';

// =============================================
// 坏结局类型定义
// =============================================

export type BadEndingType = '发现' | '精神崩溃' | '未触发';

export interface BadEndingCheckResult {
  triggered: boolean;
  type: BadEndingType;
  replaceUserMessage: string | null;
}

// =============================================
// 发现结局模板库（怀疑度达到100）
// =============================================

/**
 * 发现结局 - 初始触发模板
 * 苏文发现真相的瞬间
 */
const DISCOVERY_INITIAL_TEMPLATES = [
  // 模板1：当场撞见
  () => `[坏结局 - 发现]

门突然被推开。

苏文站在门口，手里的公文包"啪"地一声落在地上。
他的眼睛死死地盯着房间里的场景，脸色从惊愕变成铁青。

"你们...在干什么？"

他的声音出奇地平静，平静得让人发寒。
赵霞惊慌失措地想要解释，但在丈夫的目光下，所有的借口都显得那么苍白。

寂静。
时间仿佛凝固了。
空气中弥漫着令人窒息的沉默。

苏文的拳头慢慢握紧，指节发白。
"原来...这就是我出差时发生的事情..."

【GAME OVER】
【BAD END: 发现】

你的行为被发现了。
这段关系，以最糟糕的方式结束。`,

  // 模板2：通过监控发现
  () => `[坏结局 - 发现]

苏文的声音从身后传来，冰冷得没有一丝温度。

"我早就知道了。"

他举起手机，屏幕上是家里监控录像的画面。
"你以为我什么都不知道？"

赵霞的脸瞬间变得惨白。
她张了张嘴，却发不出任何声音。

"我一直在等...等着看你们到底要做到什么地步..."
苏文的嘴角扯出一个讽刺的弧度，"现在，我看够了。"

他转身走向门口，留下最后一句话：
"这个家，不需要你了。"

【GAME OVER】
【BAD END: 发现】

真相无法掩盖。
一切都结束了。`,

  // 模板3：邻居告密
  () => `[坏结局 - 发现]

苏文回到家时，表情异常平静。

"今天碰到隔壁王阿姨了。"
他慢条斯理地说，"她跟我说了些有趣的事情。"

赵霞的心猛地一沉。

"说你最近经常有...客人来。"
苏文走到赵霞面前，居高临下地看着她。
"说那个人，每次都待很久。"

"老公，我可以解释——"

"不用了。"
苏文打断她，"我不想再听任何谎言。"

他从口袋里掏出一份文件，放在桌上。
"离婚协议书。签了吧。"

【GAME OVER】
【BAD END: 发现】

谎言终究会被拆穿。
这就是代价。`,

  // 模板4：突然回家
  () => `[坏结局 - 发现]

"我回来拿个文件——"

苏文的话在看到眼前场景的瞬间戛然而止。

他的目光在你和赵霞之间来回移动，瞳孔剧烈收缩。
那种眼神，像是在看两个陌生人。

"呵。"
他突然笑了，笑声里没有一丝温度。
"原来如此。原来如此。"

赵霞慌张地站起来，"老公，这不是你想的那样——"

"闭嘴。"
苏文的声音像刀子一样锋利。
"我不想听你说话。我只想知道，这种事，发生过多少次？"

沉默。

"算了，我也不想知道了。"
他转身离开，背影决绝。
"你们继续。我不会再回来了。"

【GAME OVER】
【BAD END: 发现】

有些事情，一旦被看见，就再也无法假装没发生过。`,

  // 模板5：手机短信暴露
  () => `[坏结局 - 发现]

苏文把手机摔在赵霞面前。

屏幕上是一条短信通知——
来自一个匿名号码，附带着几张照片。

"解释一下。"
他的声音沙哑，像是用尽了所有力气才说出这两个字。

赵霞看着那些照片，脸色变得苍白。
是她和{{user}}的照片。
不知道是谁偷拍的。

"我...我..."

"够了。"
苏文打断她，眼眶泛红。
"我不想再听任何解释。我只想问你一句——"

他深吸一口气，声音颤抖：
"我到底做错了什么？"

赵霞无言以对。
泪水终于夺眶而出。

但一切都太晚了。

【GAME OVER】
【BAD END: 发现】

秘密总有暴露的一天。
这一天，来得比想象中更快。`,
];

/**
 * 发现结局 - 持续锁定模板
 * 触发后，无论玩家输入什么，都会显示这些内容
 */
const DISCOVERY_LOCKED_TEMPLATES = [
  // 模板1：结局已定
  () => `[游戏已结束]

这个故事已经走向了最糟糕的结局。

苏文发现了一切。
赵霞的世界崩塌了。
而你，只能眼睁睁地看着这一切发生。

【BAD END: 发现】

无论你做什么，都无法改变已经发生的事实。
这段关系，以最惨烈的方式画上了句号。

也许，从一开始，这就是注定的结局。

---
游戏已结束。如需重新开始，请重置存档。`,

  // 模板2：无法挽回
  () => `[游戏已结束]

一切都结束了。

赵霞蜷缩在角落里，泪流满面。
苏文已经离开，带走了这个家最后的温度。
而你，站在原地，不知所措。

你想说些什么，想做些什么——
但你知道，已经没有意义了。

【BAD END: 发现】

有些错误，是无法弥补的。
有些伤害，是无法愈合的。
有些结局，是无法改变的。

---
游戏已结束。如需重新开始，请重置存档。`,

  // 模板3：空荡的房间
  () => `[游戏已结束]

房间里空荡荡的。

苏文的东西已经搬走了。
赵霞也不知去向。
只剩下你，和满地的狼藉。

桌上放着一张照片，是赵霞的结婚照。
照片上的她，笑得那么幸福。

现在，那个笑容已经不存在了。

【BAD END: 发现】

你毁掉了一个家庭。
这就是你想要的结果吗？

---
游戏已结束。如需重新开始，请重置存档。`,

  // 模板4：沉默的审判
  () => `[游戏已结束]

没有人说话。
没有人行动。
时间仿佛在这一刻停止了。

赵霞跪在地上，泣不成声。
苏文站在门口，背对着所有人。
而你，被困在这令人窒息的沉默中。

【BAD END: 发现】

这就是背叛的代价。
这就是欲望的终点。
这就是游戏的结局。

---
游戏已结束。如需重新开始，请重置存档。`,

  // 模板5：最后的画面
  () => `[游戏已结束]

你永远忘不了苏文离开时的背影。

那个曾经温和的男人，眼中的光芒彻底熄灭了。
他没有愤怒，没有咆哮，只有无尽的失望和疲惫。

"谢谢你，让我看清了一切。"

这是他说的最后一句话。
然后，门关上了。
永远地。

【BAD END: 发现】

有些人走了，就不会再回来。
有些事发生了，就无法当作没发生过。

---
游戏已结束。如需重新开始，请重置存档。`,
];

// =============================================
// 工具函数
// =============================================

/**
 * 从模板数组中随机选择一个
 */
function randomChoice<T>(arr: T[]): T {
  return arr[Math.floor(Math.random() * arr.length)];
}

// =============================================
// 核心函数
// =============================================

/**
 * 检测是否触发坏结局
 *
 * 【梦境豁免规则】
 * - 梦境中（游戏阶段="梦境"）豁免"发现结局"（丈夫怀疑度）
 * - 原因：赵霞在睡觉，苏文不可能发现她在梦里做什么
 * - 但精神崩溃结局（记忆混乱度）不豁免，因为那是赵霞自己的精神状态
 *
 * @param data 游戏数据
 * @returns 坏结局检测结果
 */
export function checkBadEnding(data: SchemaType): BadEndingCheckResult {
  // 检查是否已经在坏结局锁定状态（优先级最高）
  // 这确保即使 ROLL 到怀疑度未达100的消息，也无法绕过坏结局
  const isAlreadyInBadEnding = isInBadEndingLock(data);

  // 【梦境豁免】梦境中不触发"发现结局"
  // 原因：赵霞在睡觉做梦，苏文不可能发现她在梦里做什么
  const 是梦境阶段 = data.世界.游戏阶段 === '梦境';

  // 检测发现结局：怀疑度 >= 100 或 已经在坏结局状态
  // 但如果在梦境中且不是已锁定状态，则豁免
  if ((data.现实数据.丈夫怀疑度 >= 100 && !是梦境阶段) || isAlreadyInBadEnding) {
    let replaceUserMessage: string;
    if (isAlreadyInBadEnding) {
      // 已在坏结局状态，使用锁定模板（ROLL后也会显示这个）
      const template = randomChoice(DISCOVERY_LOCKED_TEMPLATES);
      replaceUserMessage = template();
      console.info('[坏结局系统] 坏结局已锁定，无法继续游戏（支持ROLL检测）');
    } else {
      // 首次触发，使用初始模板
      const template = randomChoice(DISCOVERY_INITIAL_TEMPLATES);
      replaceUserMessage = template();
      console.info('[坏结局系统] 首次触发发现结局');
    }

    return {
      triggered: true,
      type: '发现',
      replaceUserMessage,
    };
  }

  // 检测精神崩溃结局（混乱度 >= 100）
  // 注意：这是备用检测，主要的混乱结局逻辑在 confusionEndingSystem.ts 中
  // confusionEndingSystem 有更完整的场景5越轨行为检测和警告系统
  if (data.梦境数据.记忆混乱度 >= 100) {
    console.info('[坏结局系统] 混乱度达到100，触发精神崩溃结局');
    return {
      triggered: true,
      type: '精神崩溃',
      replaceUserMessage: `[坏结局 - 精神崩溃]

赵霞的精神彻底崩溃了。

梦境与现实的界限变得模糊，她再也分不清什么是真实，什么是虚幻。
那些被篡改的记忆，像潮水一样涌来，将她的意识淹没。

"我是谁...？"
"这里是哪里...？"
"你...又是谁...？"

她的眼神变得空洞，再也没有了往日的神采。

【GAME OVER】
【BAD END: 精神崩溃】

有些记忆，是不应该被触碰的。
有些真相，是不应该被揭开的。

---
游戏已结束。如需重新开始，请重置存档。`,
    };
  }

  // 未触发坏结局
  return {
    triggered: false,
    type: '未触发',
    replaceUserMessage: null,
  };
}

/**
 * 应用坏结局状态到游戏数据
 * @param data 游戏数据
 * @param type 坏结局类型
 */
export function applyBadEndingState(data: SchemaType, type: BadEndingType): void {
  if (type === '未触发') return;

  data.结局数据.当前结局 = '坏结局';
  data.世界.循环状态 = '结局判定';

  console.info(`[坏结局系统] 已设置坏结局状态: ${type}`);
}

/**
 * 检测是否处于坏结局锁定状态
 * 用于判断是否需要持续替换消息
 * @param data 游戏数据
 * @returns 是否处于坏结局锁定状态
 */
export function isInBadEndingLock(data: SchemaType): boolean {
  return (
    data.结局数据.当前结局 === '坏结局' &&
    data.世界.循环状态 === '结局判定'
  );
}
