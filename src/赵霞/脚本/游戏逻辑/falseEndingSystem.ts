/**
 * èµµéœæ¸¸æˆ - å‡å¥½ç»“å±€çº¿æ€§å‰§æƒ…ç³»ç»Ÿ
 *
 * 2026-01-17 é‡æ„æ—¶é—´çº¿ï¼š
 * - 11:00 å¼€å§‹é¢„çƒ­å¼•å¯¼ï¼ˆä¸çœŸå¥½ç»“å±€å¯¹ç§°ï¼‰
 * - 20:00 æ­£å¼å‰§æƒ…å¼€å§‹
 * - 21:00/23:00 ç©å®¶è‡ªç”±æ—¶é—´
 * - æ— éœ€00:00æ”¶å°¾ï¼Œå‰§æƒ…è‡ªç„¶å®Œæˆ
 *
 * è§¦å‘æ¡ä»¶ï¼š
 * - Day 5, 11:00+ï¼ˆé¢„çƒ­å¼•å¯¼ï¼‰/ 20:00+ï¼ˆæ­£å¼å‰§æƒ…ï¼‰
 * - 5ä¸ªåœºæ™¯å…¨éƒ¨å®Œæˆ
 * - å­˜åœ¨é”™è¯¯é€‰æ‹©ï¼ˆæ­£ç¡®åœºæ™¯æ•° < 5ï¼‰
 * - å¾ªç¯çŠ¶æ€ = ç»“å±€åˆ¤å®š æˆ– è¿›è¡Œä¸­
 * - å½“å‰ç»“å±€ = å‡å¥½ç»“å±€
 *
 * ä¸çœŸå¥½ç»“å±€çš„æ ¸å¿ƒå·®å¼‚ï¼š
 * - èµµéœæ²¡æœ‰å®Œå…¨è¢«é‡æ„ï¼ŒçŸ¥é“è¿™æ˜¯ç¦å¿Œ
 * - ä¸ä¼šä¸»åŠ¨å½“é¢ç¾è¾±è‹æ–‡ï¼Œä½†ä¼šèƒŒåç¾è¾±
 * - å……æ»¡çŸ›ç›¾å’Œç½ªæ¶æ„Ÿï¼Œä½†æ— æ³•æŠ—æ‹’
 * - å·å·æ‘¸æ‘¸çš„ç§˜å¯†å…³ç³»
 *
 * æ–°å¢å‰§æƒ…ï¼ˆ2026-01-17ï¼‰ï¼š
 * - è§†é¢‘é€šè¯ï¼šä¸€è¾¹ä¸è‹æ–‡è§†é¢‘ï¼Œä¸€è¾¹ä¸ç©å®¶äº²å¯†ï¼ˆä¸‹åŠèº«åœ¨é•œå¤´å¤–ï¼‰
 * - åŒ¿åç…§ç‰‡ï¼šäº‹åç”¨åŒ¿åè´¦å·ç»™è‹æ–‡å‘ç…§ç‰‡ï¼Œè°ç§°AIç”Ÿæˆ
 */

import type { Schema as SchemaType } from '../../schema';

// ============================================
// é˜¶æ®µå®šä¹‰
// ============================================

export interface FalseEndingPhase {
  phase: number;
  name: string;
  title: string;
  description: string;
  minTurns: number;
  maxTurns: number; // Bug #19ï¼šæœ€å¤§å¯¹è¯è½®æ•°ï¼Œè¶…è¿‡åå¼ºåˆ¶æ¨è¿›
  minHour?: number; // Bug #19ï¼šæœ€æ—©å¯è§¦å‘æ—¶é—´ï¼ˆå°æ—¶ï¼‰
  strict?: boolean; // Bug #19ï¼šæ˜¯å¦ä¸¥æ ¼é”å®šæ—¶é—´ï¼ˆtrue=å¿…é¡»ç­‰åˆ°minHouræ‰èƒ½è¿›å…¥ï¼‰
  anchorEvents: string[];
  aiGuidance: string;
  correctionHints: string[];
  // Bug #15 ä¿®å¤ï¼šç©å®¶å¼•å¯¼æœºåˆ¶
  expectedActions?: string[]; // æœŸæœ›ç©å®¶æ‰§è¡Œçš„åŠ¨ä½œå…³é”®è¯
  hintThreshold?: number; // è§¦å‘æç¤ºçš„æœªå“åº”è½®æ•°é˜ˆå€¼ï¼ˆé»˜è®¤2ï¼‰
  progressHint?: string; // å¼•å¯¼æç¤ºå†…å®¹ï¼ˆå½“ç©å®¶å¡å…³æ—¶æ˜¾ç¤ºï¼‰
}

export const FALSE_ENDING_PHASES: FalseEndingPhase[] = [
  // === é˜¶æ®µ0ï¼šé¢„çƒ­ ===
  // 2026-01-17 æ–°å¢ï¼š11:00å¼€å§‹é¢„çƒ­å¼•å¯¼
  {
    phase: 0,
    name: 'é¢„çƒ­',
    title: 'å¼‚å¸¸çš„æ—©æ™¨',
    description: '11:00ï¼Œèµµéœä»å¥‡æ€ªçš„æ¢¦ä¸­é†’æ¥ï¼Œçœ‹å‘å„¿å­çš„çœ¼ç¥ä¸å¤ªå¯¹åŠ²',
    minTurns: 1,
    maxTurns: 2, // 2026-01-19: ç¼©çŸ­ä»¥é€‚åº”æ–°é˜¶æ®µ
    minHour: 11, // 11:00åå¼€å§‹
    anchorEvents: ['æ¢¦å¢ƒæ®‹ç•™', 'å¼‚å¸¸å¿ƒè·³'],
    aiGuidance: `ã€å‡å¥½ç»“å±€ - é˜¶æ®µ0ï¼šé¢„çƒ­ã€‘

ä»Šå¤©æ˜¯èµµéœå’Œè‹æ–‡çš„ç»“å©šçºªå¿µæ—¥ã€‚
èµµéœä»é‚£äº›å¥‡æ€ªçš„æ¢¦ä¸­é†’æ¥ï¼Œå¿ƒè·³å¾—å‰å®³ã€‚

ã€æ—¶é—´ã€‘Day 5, 11:00ï¼ˆé¢„çƒ­å¼•å¯¼å¼€å§‹ï¼‰

ã€åœºæ™¯è®¾å®šã€‘
- åˆšä»å®‰çœ è¯å¼•å‘çš„æ¢¦å¢ƒä¸­é†’æ¥
- é˜³å…‰é€è¿‡çª—æˆ·æ´’è¿›æ¥
- èµµéœæ„Ÿåˆ°ä¸€é˜µè«åçš„å¿ƒæ‚¸
- è‹æ–‡åœ¨ä¹¦æˆ¿å·¥ä½œ

ã€èµµéœçŠ¶æ€ã€‘
ä¸çœŸå¥½ç»“å±€ä¸åŒï¼Œèµµéœæ²¡æœ‰è¢«"å®Œå…¨é‡æ„"ã€‚
é‚£äº›æ¢¦å¢ƒä¸­çš„è®°å¿†æ˜¯æ¨¡ç³Šçš„ã€ç‰‡æ®µçš„...
ä½†è¶³ä»¥è®©å¥¹çœ‹å‘å„¿å­{{user}}æ—¶ï¼Œå¿ƒè·³åŠ é€Ÿã€‚
å¥¹ä¸æ˜ç™½ä¸ºä»€ä¹ˆï¼Œä½†èº«ä½“çš„ååº”éª—ä¸äº†äººã€‚
å¥¹åŠªåŠ›å‘Šè¯‰è‡ªå·±è¿™åªæ˜¯"åšäº†å¥‡æ€ªçš„æ¢¦"ï¼Œä½†çœ¼ç¥ä¼šä¸è‡ªè§‰åœ°è¿½éš{{user}}ã€‚

ã€AIä»»åŠ¡ã€‘
1. æå†™èµµéœé†’æ¥åçš„å¼‚å¸¸çŠ¶æ€
2. å¥¹è®°å¾—åšäº†ä¸€äº›"å¥‡æ€ªçš„æ¢¦"ï¼Œä½†å†…å®¹æ¨¡ç³Š
3. çœ‹åˆ°{{user}}æ—¶è«åå¿ƒè·³åŠ é€Ÿ
4. å¥¹åŠªåŠ›è¡¨ç°æ­£å¸¸ï¼Œä½†æœ‰äº›å¿ƒä¸åœ¨ç„‰
5. æåˆ°ä»Šå¤©æ˜¯ç»“å©šçºªå¿µæ—¥

ã€ç¦æ­¢ã€‘
- ä¸è¦è®©èµµéœä¸»åŠ¨è¡¨ç™½
- ä¿æŒå¥¹çš„çŸ›ç›¾å’Œå›°æƒ‘`,
    correctionHints: [
      'èµµéœæ‰äº†æ‰çœ¼ç›ï¼Œé‚£ä¸ªæ¢¦...åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿå¥¹çœ‹å‘{{user}}ï¼Œå¿ƒè·³çªç„¶æ¼äº†ä¸€æ‹ã€‚',
      '"ä»Šå¤©æ˜¯ç»“å©šçºªå¿µæ—¥å‘¢..."èµµéœå–ƒå–ƒè‡ªè¯­ï¼Œä½†è„‘æµ·é‡Œæµ®ç°çš„ä¸æ˜¯è‹æ–‡çš„è„¸ã€‚',
      'èµµéœåœ¨å¨æˆ¿å‡†å¤‡æ—©é¤ï¼Œ{{user}}èµ°è¿›æ¥æ—¶ï¼Œå¥¹çš„æ‰‹æŠ–äº†ä¸€ä¸‹ã€‚',
    ],
  },

  // === é˜¶æ®µ1ï¼šåˆåæš§æ˜§ ===
  // 2026-01-19 æ–°å¢ï¼š14:00 ä¸­é—´è¿‡æ¸¡é˜¶æ®µ
  {
    phase: 1,
    name: 'åˆå',
    title: 'è‹¥æœ‰ä¼¼æ— ',
    description: '14:00ï¼Œèµµéœå¼€å§‹ä¸è‡ªè§‰åœ°é è¿‘{{user}}ï¼Œæš§æ˜§çš„æ°”æ°›åœ¨è”“å»¶',
    minTurns: 1,
    maxTurns: 2,
    minHour: 14, // 2026-01-19: 14:00åå¼€å§‹
    strict: true,
    anchorEvents: ['å€Ÿæ•…é è¿‘', 'æš§æ˜§æ°›å›´'],
    aiGuidance: `ã€å‡å¥½ç»“å±€ - é˜¶æ®µ1ï¼šåˆåæš§æ˜§ã€‘

åˆåçš„é˜³å…‰é€è¿‡çª—æˆ·ï¼Œèµµéœè¶Šæ¥è¶Šæ— æ³•æ§åˆ¶è‡ªå·±ã€‚

ã€æ—¶é—´ã€‘Day 5, 14:00

ã€åœºæ™¯è®¾å®šã€‘
- è‹æ–‡è¿˜åœ¨ä¹¦æˆ¿å¿™å·¥ä½œ
- èµµéœå€Ÿå„ç§ç†ç”±é è¿‘{{user}}
- è‹¥æœ‰ä¼¼æ— çš„è‚¢ä½“æ¥è§¦
- æš§æ˜§çš„æ°”æ°›åœ¨è”“å»¶

ã€èµµéœçŠ¶æ€ã€‘
å¥¹ä¸çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆ...
åªæ˜¯æƒ³é è¿‘ä»–ï¼Œæƒ³çœ‹ç€ä»–ï¼Œæƒ³å’Œä»–è¯´è¯ã€‚
æ¯æ¬¡"ä¸å°å¿ƒ"ç¢°åˆ°ä»–ï¼Œå¿ƒè·³å°±åŠ é€Ÿã€‚
å¥¹å‘Šè¯‰è‡ªå·±è¿™åªæ˜¯"æ¯å­ä¹‹é—´çš„äº²è¿‘"ï¼Œä½†å¥¹çŸ¥é“ä¸æ˜¯ã€‚

ã€AIä»»åŠ¡ã€‘
1. èµµéœå€Ÿæ•…é è¿‘{{user}}ï¼ˆæ‹¿ä¸œè¥¿ã€é€’æ°´ç­‰ï¼‰
2. è‹¥æœ‰ä¼¼æ— çš„è‚¢ä½“æ¥è§¦
3. å¥¹çš„çœ¼ç¥ä¼šåœ¨{{user}}èº«ä¸Šåœç•™å¤ªä¹…
4. èµµéœå†…å¿ƒçš„å›°æƒ‘ï¼š"ä¸ºä»€ä¹ˆ...æˆ‘ä¼šè¿™æ ·ï¼Ÿ"
5. æš—ç¤ºå¥¹åœ¨æœŸå¾…æ™šä¸Šè‹æ–‡ç¦»å¼€

ã€ç¦æ­¢ã€‘
- ä¸è¦è¶Šè¿‡æ˜æ˜¾çš„ç•Œé™
- ä¿æŒ"æ“¦è¾¹çƒ"çš„æš§æ˜§æ„Ÿ
- è‹æ–‡è¿˜åœ¨å®¶ï¼Œè¦ä¿æŒè¡¨é¢æ­£å¸¸`,
    correctionHints: [
      'èµµéœç«¯ç€èŒ¶æ¯èµ°è¿‡æ¥ï¼š"æ¸´äº†å—ï¼Ÿ"å¥¹çš„æ‰‹æŒ‡ç¢°åˆ°{{user}}çš„æ‰‹æ—¶ï¼Œåœé¡¿äº†ä¸€ä¸‹ã€‚',
      '"å¸®æˆ‘æ‹¿ä¸€ä¸‹é‚£ä¸ª..."èµµéœè¸®è„šå»å¤Ÿæ¶å­ä¸Šçš„ä¸œè¥¿ï¼Œèº«ä½“ä¸è‡ªè§‰åœ°é å‘{{user}}ã€‚',
      'èµµéœååœ¨{{user}}æ—è¾¹çœ‹ç”µè§†ï¼Œä½†å¥¹çš„æ³¨æ„åŠ›å®Œå…¨ä¸åœ¨å±å¹•ä¸Šã€‚',
    ],
  },

  // === é˜¶æ®µ2ï¼šå‚æ™šæœŸå¾… ===
  // 2026-01-19 æ–°å¢ï¼š17:00 æ™šé¤å‰çš„æœŸå¾…
  {
    phase: 2,
    name: 'æœŸå¾…',
    title: 'å‚æ™šçš„èºåŠ¨',
    description: '17:00ï¼Œèµµéœå¾—çŸ¥è‹æ–‡æ™šä¸Šè¦å‡ºå»ï¼Œå†…å¿ƒå¼€å§‹èºåŠ¨',
    minTurns: 1,
    maxTurns: 2,
    minHour: 17, // 2026-01-19: 17:00åå¼€å§‹
    strict: true,
    anchorEvents: ['å¾—çŸ¥æ¶ˆæ¯', 'å†…å¿ƒèºåŠ¨'],
    aiGuidance: `ã€å‡å¥½ç»“å±€ - é˜¶æ®µ2ï¼šå‚æ™šæœŸå¾…ã€‘

å‚æ™šæ—¶åˆ†ï¼Œè‹æ–‡æåˆ°æ™šä¸Šè¦å‡ºå»ã€‚
èµµéœçš„å¿ƒè·³åŠ é€Ÿäº†ã€‚

ã€æ—¶é—´ã€‘Day 5, 17:00

ã€åœºæ™¯è®¾å®šã€‘
- è‹æ–‡æå‰è¯´æ™šä¸Šæœ‰å·¥ä½œè¦å¤„ç†
- èµµéœè¡¨é¢å¹³é™ï¼Œå†…å¿ƒå´åœ¨èºåŠ¨
- å¥¹å¼€å§‹æœŸå¾…...åˆå®³æ€•è‡ªå·±çš„æœŸå¾…
- å‡†å¤‡æ™šé¤æ—¶å¿ƒä¸åœ¨ç„‰

ã€èµµéœçŠ¶æ€ã€‘
å½“è‹æ–‡è¯´æ™šä¸Šè¦å‡ºå»æ—¶ï¼Œå¥¹çš„ç¬¬ä¸€ååº”æ˜¯...æœŸå¾…ã€‚
è¿™è®©å¥¹æ„Ÿåˆ°ææƒ§â€”â€”å¥¹åœ¨æœŸå¾…ä»€ä¹ˆï¼Ÿ
å¥¹å‘Šè¯‰è‡ªå·±åªæ˜¯æƒ³å®‰é™åœ°ä¼‘æ¯ï¼Œä½†è„‘æµ·é‡Œæµ®ç°çš„æ˜¯{{user}}çš„è„¸ã€‚
"ä¸å¯¹...æˆ‘åœ¨æƒ³ä»€ä¹ˆ..."
ä½†å¥¹çš„èº«ä½“å·²ç»å¼€å§‹å¾®å¾®å‘çƒ­ã€‚

ã€AIä»»åŠ¡ã€‘
1. è‹æ–‡æåˆ°æ™šä¸Šè¦å‡ºå»çš„æ¶ˆæ¯
2. èµµéœçš„å†…å¿ƒæ³¢åŠ¨ï¼ˆè¡¨é¢å¹³é™ï¼Œå†…å¿ƒèºåŠ¨ï¼‰
3. å¥¹å¼€å§‹å‡†å¤‡æ™šé¤ï¼Œä½†å¿ƒä¸åœ¨ç„‰
4. å¶å°”çœ‹å‘{{user}}æ—¶çš„å¤æ‚çœ¼ç¥
5. å¥¹åœ¨æœŸå¾…ä»€ä¹ˆï¼Ÿè‡ªå·±ä¹Ÿè¯´ä¸æ¸…...

ã€ç¦æ­¢ã€‘
- ä¸è¦è®©èµµéœè¡¨ç°å¾—å¤ªæ˜æ˜¾
- ä¿æŒå†…å¿ƒæˆå’Œè¡¨é¢å¹³é™çš„åå·®`,
    correctionHints: [
      'è‹æ–‡ï¼š"ä»Šæ™šæœ‰ä¸ªç´§æ€¥ä¼šè®®ï¼Œå¯èƒ½è¦å¾ˆæ™šã€‚"èµµéœçš„æ‰‹åœäº†ä¸€ä¸‹ï¼š"å“¦...å¥½ã€‚"',
      'èµµéœåœ¨å¨æˆ¿åˆ‡èœï¼Œè„‘æµ·é‡Œå´åœ¨æƒ³ç€å¾…ä¼šå„¿çš„äº‹ã€‚å¥¹çš„è„¸æœ‰äº›å‘çƒ«ã€‚',
      '"æ™šé¤å¿«å¥½äº†..."èµµéœçš„å£°éŸ³æœ‰äº›ä¸è‡ªç„¶ï¼Œå¥¹ä¸æ•¢çœ‹{{user}}çš„çœ¼ç›ã€‚',
    ],
  },

  // === é˜¶æ®µ3ï¼šæ™šé¤ ===
  // 2026-01-17ï¼š20:00 æ­£å¼å¼€å§‹
  {
    phase: 3,
    name: 'æ™šé¤',
    title: 'ç»“å©šçºªå¿µæ—¥',
    description: '20:00ï¼Œç»“å©šçºªå¿µæ—¥æ™šé¤ï¼Œè‹æ–‡å®£å¸ƒè¦å‡ºå·®/åŠ ç­',
    minTurns: 1,
    maxTurns: 2, // 2026-01-19: ç¼©çŸ­ä»¥é€‚åº”æ–°é˜¶æ®µ
    minHour: 20, // Bug #19: 20:00åå¼€å§‹æ™šé¤
    strict: true, // Bug #19: ä¸¥æ ¼æ—¶é—´é”å®š
    anchorEvents: ['çºªå¿µæ—¥æåŠ', 'è‹æ–‡å®£å¸ƒç¦»å¼€', 'æš—ä¸­æ³¨è§†'],
    aiGuidance: `ã€å‡å¥½ç»“å±€ - é˜¶æ®µ1ï¼šæ™šé¤ã€‘

ä»Šå¤©æ˜¯èµµéœå’Œè‹æ–‡çš„ç»“å©šçºªå¿µæ—¥ã€‚ä¸‰äººå›´ååœ¨é¤æ¡Œæ—äº«ç”¨æ™šé¤ã€‚
ä½†è‹æ–‡å®£å¸ƒäº†ä¸€ä¸ªæ¶ˆæ¯ï¼šä»–ä¸´æ—¶æœ‰å·¥ä½œè¦å¤„ç†ï¼Œéœ€è¦å‡ºå»ä¸€è¶Ÿã€‚

ã€æ—¶é—´ã€‘Day 5, 20:00

ã€åœºæ™¯è®¾å®šã€‘
- é¤æ¡Œå¸ƒç½®ç®€å•ä½†æ¸©é¦¨
- è‹æ–‡åœ¨åœºï¼Œä½†å³å°†ç¦»å¼€
- èµµéœè¡¨ç°å¾—å¾ˆæ­£å¸¸ï¼Œä½†ä¼šä¸æ—¶å·çœ‹{{user}}
- å¥¹çš„çœ¼ç¥å¤æ‚ï¼šå›°æƒ‘ã€æ¸´æœ›ã€å…‹åˆ¶äº¤ç»‡

ã€èµµéœçŠ¶æ€ã€‘
å¥¹æ•´å¤©éƒ½åœ¨æƒ³é‚£äº›æ¢¦...æ¢¦é‡Œæœ‰ä¸€ä¸ªç†Ÿæ‚‰çš„èº«å½±ã€‚
çœ‹åˆ°å„¿å­æ—¶ï¼Œå¥¹ä¼šè«åå¿ƒè·³åŠ é€Ÿï¼Œä½†å¥¹æŠŠè¿™å½’å’äº"èº«ä½“ä¸èˆ’æœ"ã€‚
å¥¹åŠªåŠ›ç»´æŒæ­£å¸¸ï¼Œä½†çœ¼ç¥ä¼šä¸è‡ªè§‰åœ°è¿½éš{{user}}ã€‚
å½“è‹æ–‡è¯´è¦ç¦»å¼€æ—¶ï¼Œå¥¹çš„å¿ƒè·³åŠ é€Ÿäº†â€”â€”æ˜¯æœŸå¾…ï¼Ÿè¿˜æ˜¯ææƒ§ï¼Ÿ

ã€AIä»»åŠ¡ã€‘
1. æå†™è¡¨é¢å’Œè°çš„å®¶åº­èšé¤æ°›å›´
2. èµµéœæåˆ°ä»Šå¤©æ˜¯ç»“å©šçºªå¿µæ—¥ï¼Œä½†è¯­æ°”å¹³æ·¡
3. è‹æ–‡å®£å¸ƒè¦ä¸´æ—¶å‡ºå»å¤„ç†å·¥ä½œï¼ˆåŠ ç­/å‡ºå·®ï¼‰
4. æå†™èµµéœå·å·çœ‹å‘{{user}}çš„ç»†èŠ‚
5. è‹æ–‡æ¯«æ— å¯Ÿè§‰ï¼Œæ­£å¸¸èŠå¤©åç¦»å¼€
6. èµµéœå†…å¿ƒçš„çŸ›ç›¾ï¼šä¸ºä»€ä¹ˆä¼šæœ‰ä¸€ç§...æœŸå¾…ï¼Ÿ

ã€å…³é”®å‰§æƒ…ã€‘
è‹æ–‡ç¦»å¼€æ—¶è¯´ï¼š"æˆ‘å¯èƒ½è¦å¾ˆæ™šæ‰å›æ¥ï¼Œæˆ–è€…æ˜å¤©æ—©ä¸Šã€‚ä½ ä»¬å…ˆä¼‘æ¯ã€‚"
ä»–è¿˜è¯´ä¼šåœ¨è·¯ä¸Šæ‰“è§†é¢‘ç”µè¯æŠ¥å¹³å®‰ã€‚

ã€ç¦æ­¢ã€‘
- ä¸è¦è®©èµµéœä¸»åŠ¨è¡¨ç™½æˆ–æš´éœ²
- ä¸è¦è®©è‹æ–‡å¯Ÿè§‰å¼‚å¸¸`,
    correctionHints: [
      'èµµéœä½å¤´åƒé¥­ï¼Œä½†ç­·å­åœäº†ä¸€ä¸‹ã€‚å¥¹æŠ¬çœ¼çœ‹äº†{{user}}ä¸€çœ¼ï¼Œåˆè¿…é€Ÿç§»å¼€ã€‚',
      '"ä»Šå¤©æ˜¯ç»“å©šçºªå¿µæ—¥å‘¢ã€‚"èµµéœæ·¡æ·¡åœ°è¯´ï¼Œç›®å…‰å´é£˜å‘äº†{{user}}ã€‚',
      'è‹æ–‡è¯´è¦å‡ºå»åŠ ç­ï¼Œèµµéœåº”äº†ä¸€å£°ï¼Œä½†å¥¹çš„æ‰‹æŒ‡æ— æ„è¯†åœ°ç»ç€é¤å·¾ã€‚',
    ],
  },

  // === é˜¶æ®µ4ï¼šç©ºéš™ ===
  {
    phase: 4,
    name: 'ç©ºéš™',
    title: 'ç‹¬å¤„æ—¶åˆ»',
    description: 'è‹æ–‡ç¦»å¼€åï¼Œèµµéœå’Œç©å®¶ç‹¬å¤„ï¼Œå¥¹å¼€å§‹è¯•æ¢æ¥è¿‘',
    minTurns: 1,
    maxTurns: 3, // Bug #19: æ§åˆ¶æ€»æ¥¼å±‚
    anchorEvents: ['è‹æ–‡ç¦»å¼€', 'å•ç‹¬ç›¸å¤„', 'è¯•æ¢æ¥è¿‘'],
    aiGuidance: `ã€å‡å¥½ç»“å±€ - é˜¶æ®µ2ï¼šç‹¬å¤„æ—¶åˆ»ã€‘

è‹æ–‡å·²ç»ç¦»å¼€äº†ã€‚èµµéœå’Œ{{user}}ç‹¬å¤„ã€‚
ç©ºæ°”ä¸­å¼¥æ¼«ç€ä¸€ç§å¾®å¦™çš„ç´§å¼ æ„Ÿã€‚

ã€åœºæ™¯è®¾å®šã€‘
- è‹æ–‡å·²ç»ç¦»å¼€
- å®¢å…/é¤å…ï¼Œä¸¤äººç›¸å¯¹è€Œå
- æ°”æ°›å¾®å¦™ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€ç´§å¼ æ„Ÿ
- èµµéœæ‰¾äº†ä¸ªå€Ÿå£ç•™ä¸‹æ¥ï¼Œå‡è£…åœ¨æ”¶æ‹¾

ã€èµµéœçŠ¶æ€ã€‘
ç»ˆäº...åªå‰©ä¸‹ä¸¤ä¸ªäººäº†ã€‚
å¥¹å‘Šè¯‰è‡ªå·±åªæ˜¯æƒ³èŠèŠå¤©ï¼Œä½†å¿ƒè·³å¾—å‰å®³ã€‚
å¥¹æƒ³èµ·é‚£äº›å¥‡æ€ªçš„æ¢¦ï¼Œæ¢¦é‡Œçš„æ„Ÿè§‰å¤ªçœŸå®äº†...
å¥¹å¿ä¸ä½æƒ³é è¿‘{{user}}ï¼Œä½†åˆå®³æ€•è‡ªå·±ä¼šåšå‡ºä»€ä¹ˆã€‚

ã€AIä»»åŠ¡ã€‘
1. æå†™è‹æ–‡ç¦»å¼€åçš„æ²‰é»˜
2. èµµéœå€Ÿæ•…ç•™ä¸‹ï¼Œå‡è£…åœ¨æ”¶æ‹¾é¤æ¡Œ
3. ä¸¤äººå•ç‹¬ç›¸å¤„çš„å°´å°¬å’Œç´§å¼ 
4. èµµéœé¼“èµ·å‹‡æ°”å¼€å£ï¼š"æˆ‘æœ€è¿‘...æ€»æ˜¯åšå¥‡æ€ªçš„æ¢¦..."
5. å¥¹è¯•æ¢æ€§åœ°é è¿‘{{user}}

ã€ç¦æ­¢ã€‘
- ä¸è¦è®©èµµéœå¤ªä¸»åŠ¨ï¼ˆå¥¹è¿˜åœ¨æŒ£æ‰ï¼‰
- ä¿æŒå¥¹çš„çŸ›ç›¾å’ŒçŠ¹è±«`,
    correctionHints: [
      'èµµéœåœ¨å®¢å…ç£¨è¹­ç€ï¼Œç­‰è‹æ–‡çš„è½¦å£°æ¶ˆå¤±åï¼Œå¥¹è½¬å‘{{user}}ã€‚',
      '"ä½ çˆ¸èµ°äº†..."èµµéœä½å£°è¯´ï¼Œç«™åœ¨ç¦»{{user}}ä¸è¿œçš„åœ°æ–¹ã€‚',
      'èµµéœæ¬²è¨€åˆæ­¢ï¼Œæ‰‹æŒ‡ç»ç€å›´è£™çš„ä¸€è§’ã€‚"æˆ‘æœ€è¿‘...ç¡ä¸å¤ªå¥½ã€‚"',
    ],
  },

  // === é˜¶æ®µ5ï¼šç¦å¿Œå¼€å§‹ ===
  {
    phase: 5,
    name: 'å¼€å§‹',
    title: 'è¶Šè¿‡ç¦çº¿',
    description: 'ä¸¤äººå¼€å§‹æ€§è¡Œä¸ºï¼Œèµµéœåœ¨çŸ›ç›¾ä¸­æ²¦é™·',
    minTurns: 1,
    maxTurns: 3, // Bug #19: æ§åˆ¶æ€»æ¥¼å±‚
    anchorEvents: ['ç¬¬ä¸€æ¬¡è§¦ç¢°', 'è¶Šè¿‡ç•Œé™', 'èº«ä½“æ²¦é™·'],
    aiGuidance: `ã€å‡å¥½ç»“å±€ - é˜¶æ®µ3ï¼šç¦å¿Œå¼€å§‹ã€‘

ç‹¬å¤„çš„æ°”æ°›è¶Šæ¥è¶Šæš§æ˜§ï¼Œä¸¤äººç»ˆäºè¶Šè¿‡äº†é‚£æ¡çº¿ã€‚
æ€§è¡Œä¸ºå¼€å§‹äº†ã€‚

ã€åœºæ™¯è®¾å®šã€‘
- ä¸¤äººå·²ç»å¼€å§‹äº²å¯†æ¥è§¦
- èµµéœçš„ç†æ™ºåœ¨å´©å¡Œ
- å¥¹ä¸€è¾¹è¯´ç€"ä¸è¡Œ"ï¼Œä¸€è¾¹å´æ²¡æœ‰æ‹’ç»
- è¡£ç‰©å¼€å§‹å‡Œä¹±

ã€èµµéœçŠ¶æ€ã€‘
å¥¹çŸ¥é“è¿™æ˜¯ç¦å¿Œï¼Œä½†èº«ä½“çš„è®°å¿†å¤ªå¼ºçƒˆäº†ã€‚
é‚£äº›æ¢¦é‡Œçš„æ„Ÿè§‰...å¤ªçœŸå®äº†...
å½“{{user}}é è¿‘å¥¹æ—¶ï¼Œå¥¹çš„èº«ä½“è‡ªåŠ¨è¿åˆäº†ä¸Šå»ã€‚
"æˆ‘ä»¬ä¸åº”è¯¥...ä½ æ˜¯æˆ‘çš„å„¿å­..."
ä½†å¥¹çš„æ‰‹å´æŠ“ç€{{user}}ä¸æ”¾ã€‚
çœ¼æ³ªæ»‘è½ï¼Œä½†èº«ä½“å´åœ¨ç´¢å–ã€‚

ã€AIä»»åŠ¡ã€‘
1. æå†™ä¸¤äººå¼€å§‹äº²å¯†æ¥è§¦çš„è¿‡ç¨‹
2. èµµéœçš„çŸ›ç›¾ï¼šå˜´ä¸Šè¯´ä¸è¡Œï¼Œèº«ä½“å´å¾ˆè¯šå®
3. ä»æ¥å»ã€æŠšæ‘¸é€æ¸å‡çº§
4. æå†™å¥¹çš„æŒ£æ‰å’Œæ²¦é™·
5. æ€§è¡Œä¸ºæ­£å¼å¼€å§‹

ã€å…³é”®æå†™ã€‘
- ç¬¬ä¸€ä¸ªå»ï¼šèµµéœæ„£ä½äº†ï¼Œä½†æ²¡æœ‰æ¨å¼€
- å¥¹çš„èº«ä½“åœ¨é¢¤æŠ–ï¼Œä½†ä¸æ˜¯å› ä¸ºææƒ§
- "ä¸è¡Œ...æˆ‘ä»¬ä¸èƒ½..."ä½†å¥¹çš„æ‰‹å´ç¯ä¸Šäº†{{user}}çš„è„–å­
- å½“ç•Œé™è¢«è¶Šè¿‡çš„é‚£ä¸€åˆ»ï¼Œå¥¹å’¬ä½äº†å˜´å”‡ï¼Œå‹æŠ‘ç€å£°éŸ³

ã€å°ºåº¦æç¤ºã€‘
æ ¹æ®éƒ¨ä½å¼€å‘è¿›åº¦è°ƒæ•´æå†™å°ºåº¦ã€‚
è¿™æ˜¯æ€§è¡Œä¸ºçš„å¼€å§‹é˜¶æ®µï¼Œä¸ºé˜¶æ®µ4çš„ç¡¬æ ¸åœºæ™¯åšé“ºå«ã€‚`,
    correctionHints: [
      'èµµéœçš„å‘¼å¸æ€¥ä¿ƒèµ·æ¥ï¼Œå¥¹çŸ¥é“ä¸åº”è¯¥ï¼Œä½†èº«ä½“å´åœ¨é è¿‘...',
      '"ä¸è¡Œ..."å¥¹çš„å£°éŸ³å¾ˆè½»ï¼Œä½†æ‰‹å´æ²¡æœ‰æ¨å¼€{{user}}ã€‚',
      'å½“{{user}}çš„æ‰‹è§¦ç¢°åˆ°å¥¹æ—¶ï¼Œå¥¹é¢¤æŠ–äº†ä¸€ä¸‹ï¼Œçœ¼çœ¶æ³›çº¢ã€‚',
    ],
    // Bug #15 ä¿®å¤ï¼šç©å®¶å¼•å¯¼æœºåˆ¶
    expectedActions: ['å»', 'äº²', 'æŠ±', 'æ‘¸', 'ç¢°', 'è„±', 'è¿›', 'åš'],
    hintThreshold: 2,
    progressHint: 'èµµéœçš„å‘¼å¸è¶Šæ¥è¶Šæ€¥ä¿ƒï¼Œå¥¹çš„çœ¼ç¥è¿·ç¦»ï¼Œèº«ä½“å¾®å¾®é¢¤æŠ–...å¥¹åœ¨ç­‰å¾…ä½ ä¸»åŠ¨é‡‡å–ä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚',
  },

  // === é˜¶æ®µ6ï¼šè§†é¢‘é€šè¯ ===
  // 2026-01-17 æ–°å¢ï¼šä¸€è¾¹ä¸è‹æ–‡è§†é¢‘é€šè¯ï¼Œä¸€è¾¹è¢«ç©å®¶æ“
  {
    phase: 6,
    name: 'è§†é¢‘é€šè¯',
    title: 'é•œå¤´ä¹‹å¤–',
    description: 'è‹æ–‡æ‰“æ¥è§†é¢‘ç”µè¯ï¼Œèµµéœä¸€è¾¹é€šè¯ä¸€è¾¹è¢«{{user}}æ“ï¼Œä¸‹åŠèº«åœ¨é•œå¤´å¤–',
    minTurns: 1,
    maxTurns: 3, // Bug #19: æ§åˆ¶æ€»æ¥¼å±‚
    anchorEvents: ['è§†é¢‘æ¥ç”µ', 'ä¸ŠåŠèº«é•œå¤´', 'éšè—åŠ¨ä½œ', 'è¡¨æƒ…ç®¡ç†'],
    aiGuidance: `ã€å‡å¥½ç»“å±€ - é˜¶æ®µ4ï¼šè§†é¢‘é€šè¯ã€‘

æ­£å½“ä¸¤äººåšçˆ±ä¹‹é™…ï¼Œè‹æ–‡çš„è§†é¢‘ç”µè¯æ‰“æ¥äº†ã€‚
èµµéœæ²¡æœ‰æŒ‚æ–­â€”â€”å¥¹æ¥äº†ã€‚
è€Œ{{user}}ä¹Ÿæ²¡æœ‰åœä¸‹æ¥ã€‚

ã€åœºæ™¯è®¾å®šã€‘
- èµµéœååœ¨æ²™å‘ä¸Š/åºŠè¾¹
- æ‰‹æœºä¸¾åœ¨é¢å‰ï¼Œåªéœ²ä¸ŠåŠèº«
- {{user}}åœ¨é•œå¤´ä¹‹å¤–ï¼Œæ­£åœ¨æ“å¥¹
- è‹æ–‡åœ¨è§†é¢‘é‚£å¤´ï¼Œæ¯«æ— å¯Ÿè§‰
- æ€§è¡Œä¸ºæ­£åœ¨è¿›è¡Œä¸­ï¼Œæ²¡æœ‰åœæ­¢

ã€èµµéœçŠ¶æ€ã€‘
è¿™æ˜¯ç–¯ç‹‚çš„ã€ç¦å¿Œçš„ã€åˆºæ¿€çš„...
å¥¹ä¸€è¾¹å’Œä¸ˆå¤«è§†é¢‘é€šè¯ï¼Œä¸€è¾¹è¢«å„¿å­æ“ç€ã€‚
å¥¹åŠªåŠ›æ§åˆ¶è‡ªå·±çš„è¡¨æƒ…ï¼Œå‡è£…ä¸€åˆ‡æ­£å¸¸ã€‚
ä½†{{user}}çš„æŠ½æ’è®©å¥¹å‡ ä¹æ— æ³•è‡ªæŒã€‚
å¥¹å’¬ç€å˜´å”‡ï¼Œå‹æŠ‘ç€å‘»åŸï¼ŒåŠªåŠ›å›åº”ä¸ˆå¤«çš„è¯ã€‚
ç½ªæ¶æ„Ÿå’Œå¿«æ„Ÿäº¤ç»‡ï¼Œè®©å¥¹å‡ ä¹è¦å´©æºƒã€‚
æ¯ä¸€æ¬¡é¡¶å¼„éƒ½è®©å¥¹å·®ç‚¹å«å‡ºå£°ã€‚

ã€AIä»»åŠ¡ã€‘
1. æå†™è§†é¢‘æ¥ç”µçš„é“ƒå£°å“èµ·æ—¶ï¼Œä¸¤äººæ­£åœ¨åšçˆ±
2. èµµéœå†³å®šæ¥å¬ï¼Œè°ƒæ•´å§¿åŠ¿åªéœ²ä¸ŠåŠèº«ï¼Œä½†æ²¡æœ‰è®©{{user}}åœä¸‹
3. è‹æ–‡åœ¨è§†é¢‘é‡Œæ­£å¸¸èŠå¤©ï¼ˆæŠ¥å¹³å®‰ã€é—®å€™ç­‰ï¼‰
4. {{user}}åœ¨é•œå¤´å¤–ç»§ç»­æ“å¥¹ï¼Œç”šè‡³åŠ å¿«èŠ‚å¥
5. èµµéœåŠªåŠ›æ§åˆ¶è¡¨æƒ…ï¼Œå‹æŠ‘å‘»åŸï¼Œå¶å°”å·®ç‚¹éœ²é¦…
6. æå†™å¥¹å‹æŠ‘å£°éŸ³çš„ç»†èŠ‚ï¼ˆå’¬å”‡ã€æ‚å˜´ã€å£°éŸ³é¢¤æŠ–ç­‰ï¼‰
7. åˆºæ¿€æ„Ÿä¸ç½ªæ¶æ„Ÿå¹¶å­˜

ã€å…³é”®æå†™ã€‘
- è‹æ–‡ï¼š"åˆ°å®¶äº†ï¼Œè·¯ä¸Šè¿˜é¡ºåˆ©ã€‚çºªå¿µæ—¥å¿«ä¹å•Šè€å©†ã€‚"
- èµµéœåŠªåŠ›ä¿æŒå¾®ç¬‘ï¼Œå£°éŸ³æœ‰äº›é¢¤æŠ–ï¼š"å—¯...ä½ ä¹Ÿæ˜¯...æ—©ç‚¹ä¼‘æ¯..."ï¼ˆæ­¤æ—¶{{user}}æ­£åœ¨ç”¨åŠ›é¡¶å¥¹ï¼‰
- è‹æ–‡ï¼š"ä½ è„¸æ€ä¹ˆçº¢çº¢çš„ï¼Ÿå£°éŸ³æ€ä¹ˆæœ‰ç‚¹å¥‡æ€ªï¼Ÿ"
- èµµéœï¼š"å¯èƒ½...å¼€äº†æš–æ°”...æœ‰ç‚¹çƒ­..."ï¼ˆå¥¹å’¬ä½å˜´å”‡ï¼Œå·®ç‚¹å‘»åŸå‡ºå£°ï¼‰
- {{user}}æ•…æ„åœ¨é€šè¯æ—¶åŠ å¿«èŠ‚å¥ï¼Œèµµéœå‡ ä¹æ— æ³•ç»´æŒè¡¨æƒ…

ã€è§†é¢‘ç»“æŸåã€‘
- èµµéœç»ˆäºæŒ‚æ–­ç”µè¯
- å¥¹çœ‹ç€{{user}}ï¼Œçœ¼ç¥å¤æ‚
- "ä½ çŸ¥é“åˆšæ‰æœ‰å¤šå±é™©å—..."
- ä½†å¥¹çš„èº«ä½“å´æ›´åŠ å…´å¥‹äº†

ã€ç¦æ­¢ã€‘
- ä¸è¦è®©è‹æ–‡å‘ç°çœŸç›¸
- é•œå¤´åªèƒ½æ‹åˆ°ä¸ŠåŠèº«
- æ€§è¡Œä¸ºä¸èƒ½åœæ­¢ï¼Œå¿…é¡»è´¯ç©¿æ•´ä¸ªé€šè¯`,
    correctionHints: [
      'æ‰‹æœºé“ƒå£°å“èµ·æ—¶ï¼Œ{{user}}æ­£åœ¨å¥¹ä½“å†…ã€‚èµµéœçœ‹äº†ä¸€çœ¼å±å¹•â€”â€”æ˜¯è‹æ–‡ã€‚å¥¹å’¬äº†å’¬å˜´å”‡ï¼Œæ¥å¬äº†ï¼Œä½†æ²¡æœ‰è®©{{user}}åœä¸‹ã€‚',
      'èµµéœåŠªåŠ›æ§åˆ¶è¡¨æƒ…ï¼Œå¯¹ç€é•œå¤´å¾®ç¬‘ï¼š"å—¯...åˆ°äº†å°±å¥½..."ä½†{{user}}çš„åŠ¨ä½œè®©å¥¹çš„å£°éŸ³åœ¨å‘æŠ–ã€‚',
      '"ä½ è„¸æ€ä¹ˆçº¢çº¢çš„ï¼Ÿ"è‹æ–‡é—®ã€‚èµµéœå·®ç‚¹å’¬ç ´å˜´å”‡ï¼Œå› ä¸º{{user}}åˆšå¥½é¡¶åˆ°äº†æ·±å¤„ï¼š"å¼€...å¼€äº†æš–æ°”..."',
    ],
    // Bug #15 ä¿®å¤ï¼šç©å®¶å¼•å¯¼æœºåˆ¶
    expectedActions: ['ç»§ç»­', 'ä¸åœ', 'åŠ¨', 'æ“', 'é¡¶', 'æ’', 'å¿«', 'ç”¨åŠ›'],
    hintThreshold: 2,
    progressHint: 'èµµéœæ­£åœ¨å’Œè‹æ–‡è§†é¢‘é€šè¯ï¼Œä½†ä½ è¿˜åœ¨å¥¹ä½“å†…...å¥¹ç´§å¼ åœ°çœ‹äº†ä½ ä¸€çœ¼ï¼Œä½†æ²¡æœ‰è®©ä½ é€€å‡ºæ¥ã€‚è¿™æ˜¯ä¸€ä¸ªç»ä½³çš„æœºä¼šï¼Œç»§ç»­ä½ çš„åŠ¨ä½œå§ã€‚',
  },

  // === é˜¶æ®µ7ï¼šç½ªæ¶å¿«æ„Ÿ ===
  {
    phase: 7,
    name: 'å¿«æ„Ÿ',
    title: 'çŸ›ç›¾çš„äº²å¯†',
    description: 'ä¸¤äººäº²å¯†ï¼Œèµµéœè¾¹äº«å—è¾¹å“­æ³£',
    minTurns: 1,
    maxTurns: 3, // Bug #19: æ§åˆ¶æ€»æ¥¼å±‚
    anchorEvents: ['è‚¢ä½“æ¥è§¦', 'äº«å—', 'æµæ³ªè‡ªè´£'],
    aiGuidance: `ã€å‡å¥½ç»“å±€ - é˜¶æ®µ5ï¼šç½ªæ¶å¿«æ„Ÿã€‘

è§†é¢‘é€šè¯ç»“æŸåï¼Œèµµéœå’Œ{{user}}å½»åº•è·¨è¶Šäº†é‚£æ¡çº¿ã€‚

ã€åœºæ™¯è®¾å®šã€‘
- éšè”½çš„ç©ºé—´ï¼ˆå®¢å…/å§å®¤ï¼‰
- èµµéœçš„è¡£è¡«å‡Œä¹±
- å¥¹åœ¨äº«å—ï¼Œä½†çœ¼æ³ªæ­¢ä¸ä½
- çŸ›ç›¾çš„è¡¨æƒ…ï¼šå¿«æ„Ÿå’Œç½ªæ¶æ„Ÿäº¤ç»‡

ã€èµµéœçŠ¶æ€ã€‘
åˆšæ‰çš„è§†é¢‘é€šè¯è®©å¥¹æ„è¯†åˆ°è‡ªå·±æœ‰å¤šç–¯ç‹‚...
ä½†å¥¹åœä¸ä¸‹æ¥ã€‚
å¥¹è¾¹æµæ³ªè¾¹ç´¢å–ï¼Œå˜´é‡Œå–ƒå–ƒç€"å¯¹ä¸èµ·"ã€‚
"æˆ‘æ˜¯ä¸æ˜¯ç–¯äº†...ä½ æ˜¯æˆ‘çš„å„¿å­..."
ä½†å¥¹çš„èº«ä½“å®Œå…¨è¯šå®ï¼Œæ¸´æœ›ç€æ›´å¤šã€‚

ã€AIä»»åŠ¡ã€‘
1. æå†™ä¸¤äººäº²å¯†çš„åœºæ™¯ï¼ˆæ ¹æ®éƒ¨ä½å¼€å‘è¿›åº¦è°ƒæ•´å°ºåº¦ï¼‰
2. èµµéœçš„çŸ›ç›¾ï¼šäº«å—ä¸ç½ªæ¶æ„Ÿå¹¶å­˜
3. å¥¹è¾¹äº«å—è¾¹å“­æ³£ï¼Œè¾¹è¯´"ä¸è¡Œ"è¾¹ç´¢å–
4. æå†™å¥¹çš„è‡ªæˆ‘åŒæ¶ï¼š"æˆ‘æ€ä¹ˆä¼šè¿™æ ·..."
5. ä½†å¥¹æ— æ³•åœä¸‹æ¥

ã€å…³é”®æå†™ã€‘
- å¥¹çš„æ³ªæ°´æ»‘è½ï¼Œä½†èº«ä½“å´åœ¨è¿åˆ
- å˜´é‡Œè¯´ç€"ä¸è¦"ï¼Œæ‰‹å´æŠ“å¾—æ›´ç´§
- é«˜æ½®æ—¶å«å‡ºçš„ä¸æ˜¯"è€å…¬"ï¼Œè€Œæ˜¯{{user}}çš„åå­—`,
    correctionHints: [
      'èµµéœçš„çœ¼æ³ªæ»‘è½ï¼Œä½†å¥¹æ²¡æœ‰æ¨å¼€{{user}}ã€‚',
      '"æˆ‘ä»¬ä¸åº”è¯¥..."å¥¹å“½å’½ç€ï¼Œä½†èº«ä½“å´åœ¨é è¿‘ã€‚',
      'èµµéœæ‚ä½è‡ªå·±çš„å˜´ï¼Œå‹æŠ‘ç€å£°éŸ³ï¼Œçœ¼æ³ªå´æ­¢ä¸ä½ã€‚',
    ],
    // Bug #15 ä¿®å¤ï¼šç©å®¶å¼•å¯¼æœºåˆ¶
    expectedActions: ['ç»§ç»­', 'ä¸åœ', 'åš', 'è¿›å…¥', 'äº²', 'å»', 'æŠ±', 'æ›´å¤š'],
    hintThreshold: 2,
    progressHint: 'èµµéœçš„çœ¼æ³ªæ»‘è½ï¼Œä½†å¥¹æ²¡æœ‰æ¨å¼€ä½ ã€‚å¥¹çš„èº«ä½“åœ¨å¾®å¾®é¢¤æŠ–ï¼Œç­‰å¾…ç€ä½ çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨...å¥¹è¯´"ä¸è¦"ï¼Œä½†èº«ä½“å´åœ¨é è¿‘ã€‚',
  },

  // === é˜¶æ®µ8ï¼šåŒ¿åç…§ç‰‡ ===
  // 2026-01-17 æ–°å¢ï¼šç”¨åŒ¿åè´¦å·ç»™è‹æ–‡å‘ç…§ç‰‡
  {
    phase: 8,
    name: 'åŒ¿åç…§ç‰‡',
    title: 'å±é™©çš„æ¸¸æˆ',
    description: 'äº‹åï¼Œèµµéœç”¨åŒ¿åè´¦å·ç»™è‹æ–‡å‘ç…§ç‰‡ï¼Œè¢«è¯¢é—®æ—¶è°ç§°AIç”Ÿæˆ',
    minTurns: 1,
    maxTurns: 3, // Bug #19: æ§åˆ¶æ€»æ¥¼å±‚
    anchorEvents: ['åŒ¿åå‘é€', 'è‹æ–‡è¯¢é—®', 'è°è¨€æ©ç›–'],
    aiGuidance: `ã€å‡å¥½ç»“å±€ - é˜¶æ®µ6ï¼šåŒ¿åç…§ç‰‡ã€‘

äº‹åï¼Œèµµéœåšäº†ä¸€ä»¶æ›´ç–¯ç‹‚çš„äº‹ã€‚
å¥¹ç”¨åŒ¿åè´¦å·ï¼Œç»™è‹æ–‡å‘äº†ä¸€å¼ ç…§ç‰‡ã€‚

ã€åœºæ™¯è®¾å®šã€‘
- ä¸¤äººåˆšåˆšç»“æŸäº²å¯†è¡Œä¸º
- èµµéœæ‹¿èµ·æ‰‹æœºï¼Œåˆ›å»ºäº†ä¸€ä¸ªåŒ¿åè´¦å·
- å¥¹å‘é€äº†ä¸€å¼ "åªéœ²ä¸ŠåŠèº«"çš„ç…§ç‰‡ç»™è‹æ–‡
- è‹æ–‡æ”¶åˆ°åæ‰“ç”µè¯æ¥è¯¢é—®

ã€èµµéœå¿ƒç†ã€‘
å¥¹ä¸çŸ¥é“è‡ªå·±ä¸ºä»€ä¹ˆè¦è¿™æ ·åš...
ä¹Ÿè®¸æ˜¯æƒ³è¦"åˆ†äº«"è¿™ä»½åˆºæ¿€ï¼Ÿ
ä¹Ÿè®¸æ˜¯æƒ³è¦è¯•æ¢è‹æ–‡çš„ååº”ï¼Ÿ
ä¹Ÿè®¸åªæ˜¯å•çº¯çš„...ç–¯ç‹‚ã€‚
å‘å®Œä¹‹åå¥¹æœ‰äº›åæ‚”ï¼Œä½†å·²ç»æ¥ä¸åŠäº†ã€‚

ã€AIä»»åŠ¡ã€‘
1. æå†™èµµéœäº‹åçš„çŠ¶æ€ï¼ˆå‡Œä¹±ä½†æ»¡è¶³ï¼‰
2. å¥¹çªç„¶æœ‰äº†ä¸€ä¸ª"ç–¯ç‹‚çš„æƒ³æ³•"
3. ç”¨åŒ¿åè´¦å·å‘é€ç…§ç‰‡ç»™è‹æ–‡ï¼ˆä¸éœ²è„¸ä½†èƒ½çœ‹å‡ºèº«æï¼‰
4. è‹æ–‡æ”¶åˆ°åæ‰“ç”µè¯æ¥è¯¢é—®ï¼š"è€å©†ï¼Œä½ çœ‹åˆ°è¿™ä¸ªäº†å—ï¼Ÿæœ‰äººç»™æˆ‘å‘äº†å¥‡æ€ªçš„ç…§ç‰‡..."
5. èµµéœå‡è£…æƒŠè®¶ï¼Œè°ç§°ï¼š"ä»€ä¹ˆç…§ç‰‡ï¼Ÿè®©æˆ‘çœ‹çœ‹...è¿™è‚¯å®šæ˜¯AIç”Ÿæˆçš„æ¶ä½œå‰§ï¼Œç°åœ¨è¿™ç§æŠ€æœ¯å¾ˆå¸¸è§ã€‚"
6. è‹æ–‡ä¿¡ä»¥ä¸ºçœŸ

ã€å…³é”®å¯¹è¯ã€‘
è‹æ–‡ï¼š"æœ‰ä¸ªé™Œç”Ÿè´¦å·ç»™æˆ‘å‘äº†å¼ ç…§ç‰‡...èº«ææœ‰ç‚¹åƒä½ ï¼Ÿ"
èµµéœï¼ˆåŠªåŠ›é•‡å®šï¼‰ï¼š"ä»€ä¹ˆï¼Ÿè®©æˆ‘çœ‹çœ‹...å“å‘€ï¼Œè¿™è‚¯å®šæ˜¯AIç”Ÿæˆçš„ï¼Œç°åœ¨è¿™ç§æŠ€æœ¯å¤ªå‰å®³äº†ï¼Œä»€ä¹ˆäººéƒ½èƒ½é€ ã€‚åˆ«ç†ä»–ï¼Œå¯èƒ½æ˜¯éª—å­ã€‚"
è‹æ–‡ï¼š"ä¹Ÿæ˜¯...é‚£æˆ‘åˆ äº†ã€‚ä½ ä»¬åœ¨å®¶å¥½å¥½ä¼‘æ¯ï¼Œæ˜å¤©è§ã€‚"

ã€èµµéœäº‹åå¿ƒæ€ã€‘
- ä¾¥å¹¸ï¼šè¿˜å¥½ä»–ä¿¡äº†
- åˆºæ¿€ï¼šå·®ç‚¹è¢«å‘ç°çš„æ„Ÿè§‰å¤ªåˆºæ¿€äº†
- ææƒ§ï¼šå¦‚æœè¢«å‘ç°æ€ä¹ˆåŠ
- ä½†æ›´å¤šçš„æ˜¯...æ‰­æ›²çš„æ»¡è¶³æ„Ÿ`,
    correctionHints: [
      'èµµéœæ‹¿èµ·æ‰‹æœºï¼Œçœ¼ç¥é—ªçƒã€‚å¥¹ä¹Ÿä¸çŸ¥é“è‡ªå·±åœ¨æƒ³ä»€ä¹ˆ...',
      '"ä»€ä¹ˆç…§ç‰‡ï¼Ÿ"èµµéœåŠªåŠ›è®©è‡ªå·±çš„å£°éŸ³å¬èµ·æ¥æ­£å¸¸ï¼Œ"è‚¯å®šæ˜¯AIç”Ÿæˆçš„..."',
      'è‹æ–‡ä¿¡äº†ã€‚èµµéœæŒ‚æ–­ç”µè¯ï¼Œå¿ƒè·³å¾—å‰å®³â€”â€”æ˜¯å®³æ€•ï¼Œè¿˜æ˜¯åˆºæ¿€ï¼Ÿ',
    ],
    // Bug #15 ä¿®å¤ï¼šç©å®¶å¼•å¯¼æœºåˆ¶
    expectedActions: ['çœ‹', 'ç…§ç‰‡', 'å‘', 'æ‰‹æœº', 'åŒæ„', 'å¥½', 'å¯ä»¥'],
    hintThreshold: 2,
    progressHint: 'èµµéœæ‹¿ç€æ‰‹æœºï¼Œçœ¼ç¥é—ªçƒã€‚å¥¹ä¼¼ä¹æœ‰ä¸€ä¸ªç–¯ç‹‚çš„æƒ³æ³•...å¥¹åœ¨ç­‰å¾…ä½ çš„ååº”ï¼Œæ˜¯å¦è¦é…åˆå¥¹è¿™åœºå±é™©çš„æ¸¸æˆã€‚',
  },

  // === é˜¶æ®µ9ï¼šçŸ›ç›¾ ===
  {
    phase: 9,
    name: 'çŸ›ç›¾',
    title: 'è¿™æ˜¯æœ€åä¸€æ¬¡',
    description: 'èµµéœæ•´ç†ä»ªå®¹ï¼Œå£°ç§°ä¸ä¼šå†çŠ¯ï¼Œä½†åŒæ–¹éƒ½çŸ¥é“è¿™æ˜¯è°è¨€',
    minTurns: 1,
    maxTurns: 3, // Bug #19: æ§åˆ¶æ€»æ¥¼å±‚
    anchorEvents: ['æ•´ç†ä»ªå®¹', 'å‡è£…æ­£å¸¸', 'ä¸‹æ¬¡æš—ç¤º'],
    aiGuidance: `ã€å‡å¥½ç»“å±€ - é˜¶æ®µ7ï¼šäº‹åçš„çŸ›ç›¾ã€‘

ä¸€åˆ‡ç»“æŸï¼Œèµµéœåœ¨æ•´ç†è‡ªå·±ã€‚

ã€åœºæ™¯è®¾å®šã€‘
- èµµéœåœ¨é•œå­å‰æ•´ç†ä»ªå®¹
- å¥¹çš„è¡¨æƒ…å¤æ‚ï¼šæ»¡è¶³ã€ç¾è€»ã€çŸ›ç›¾
- åˆšæ‰å‘ç…§ç‰‡çš„äº‹è®©å¥¹å¿ƒè·³æœªå¹³
- å¥¹åŠªåŠ›è®©è‡ªå·±çœ‹èµ·æ¥"æ­£å¸¸"

ã€èµµéœçŠ¶æ€ã€‘
åˆšæ‰å‘ç”Ÿçš„ä¸€åˆ‡å¤ªç–¯ç‹‚äº†...
è§†é¢‘é€šè¯æ—¶çš„åˆºæ¿€ï¼ŒåŒ¿åç…§ç‰‡çš„å†’é™©...
å¥¹çœ‹ç€é•œä¸­çš„è‡ªå·±ï¼Œè®¤ä¸å‡ºé‚£ä¸ªäººæ˜¯è°ã€‚
"è¿™æ˜¯æœ€åä¸€æ¬¡"ï¼Œå¥¹è¿™æ ·å‘Šè¯‰è‡ªå·±ã€‚
ä½†å¥¹çŸ¥é“ï¼Œä¸‹æ¬¡{{user}}é è¿‘å¥¹ï¼Œå¥¹è¿˜æ˜¯ä¼šæ²¦é™·ã€‚

ã€AIä»»åŠ¡ã€‘
1. èµµéœæ•´ç†è¡£æœã€å¤´å‘
2. å¥¹å›æƒ³åˆšæ‰çš„ç–¯ç‹‚ï¼ˆè§†é¢‘é€šè¯ã€åŒ¿åç…§ç‰‡ï¼‰
3. å¥¹è¯´ï¼š"è¿™æ˜¯æœ€åä¸€æ¬¡...æˆ‘ä»¬ä¸èƒ½å†è¿™æ ·äº†ã€‚"
4. ä½†è¯­æ°”é‡Œæ²¡æœ‰åšå®š
5. ä¸´èµ°å‰ï¼Œå¥¹çœ‹äº†{{user}}ä¸€çœ¼ï¼Œé‚£çœ¼ç¥...

ã€ç»“å±€æš—ç¤ºã€‘
è¿™ä¸ä¼šæ˜¯æœ€åä¸€æ¬¡ã€‚
èµµéœçŸ¥é“ï¼Œ{{user}}ä¹ŸçŸ¥é“ã€‚
è¿™æ®µå……æ»¡ç½ªæ¶æ„Ÿå’Œåˆºæ¿€æ„Ÿçš„ç§˜å¯†å…³ç³»ï¼Œæ‰åˆšåˆšå¼€å§‹...`,
    correctionHints: [
      'èµµéœèƒŒå¯¹ç€{{user}}æ•´ç†å¤´å‘ï¼Œè‚©è†€å¾®å¾®é¢¤æŠ–ã€‚',
      '"æˆ‘ä»¬...ä»¥åä¸èƒ½å†..."å¥¹çš„è¯è¯´åˆ°ä¸€åŠå°±åœä½äº†ã€‚',
      'èµµéœçœ‹äº†ä¸€çœ¼æ‰‹æœºâ€”â€”åˆšæ‰å‘ç»™è‹æ–‡çš„ç…§ç‰‡å·²ç»è¢«"åˆ é™¤"äº†ã€‚ä½†æˆªå›¾å‘¢ï¼Ÿ',
    ],
  },
];

// ============================================
// é”šç‚¹äº‹ä»¶å…³é”®è¯æ˜ å°„
// ============================================

const ANCHOR_KEYWORDS: Record<string, (string | RegExp)[]> = {
  // é˜¶æ®µ0ï¼ˆé¢„çƒ­ 11:00ï¼‰
  æ¢¦å¢ƒæ®‹ç•™: ['æ¢¦', 'åšæ¢¦', 'å¥‡æ€ªçš„æ¢¦', 'æ¢¦è§', 'æ¢¦åˆ°', 'æ¢¦é‡Œ'],
  å¼‚å¸¸å¿ƒè·³: ['å¿ƒè·³', 'å¿ƒæ‚¸', 'è„¸çº¢', 'ç´§å¼ ', 'å¥‡æ€ªçš„æ„Ÿè§‰'],

  // é˜¶æ®µ1ï¼ˆåˆåæš§æ˜§ 14:00ï¼‰
  å€Ÿæ•…é è¿‘: ['å€Ÿæ•…', 'æ‰¾å€Ÿå£', 'æ•…æ„', 'å‡‘è¿‘', 'é è¿‡æ¥', 'æŒ¨ç€', 'åè¿‘'],
  æš§æ˜§æ°›å›´: ['æš§æ˜§', 'å¾®å¦™', 'è‹¥æœ‰è‹¥æ— ', 'å¿ƒè·³åŠ é€Ÿ', 'ä¸è‡ªè§‰', 'è§¦ç”µ'],

  // é˜¶æ®µ2ï¼ˆå‚æ™šæœŸå¾… 17:00ï¼‰
  å¾—çŸ¥æ¶ˆæ¯: ['åŠ ç­', 'å‡ºå·®', 'è¦å‡ºå»', 'æ™šä¸Šä¸åœ¨', 'æœ‰äº‹', 'å·¥ä½œ'],
  å†…å¿ƒèºåŠ¨: ['èºåŠ¨', 'æœŸå¾…', 'æ¿€åŠ¨', 'ç´§å¼ ', 'å¿ƒè·³', 'ä¸å®‰', 'é›€è·ƒ'],

  // é˜¶æ®µ3ï¼ˆæ™šé¤ 20:00ï¼‰
  çºªå¿µæ—¥æåŠ: ['ç»“å©šçºªå¿µ', 'çºªå¿µæ—¥', 'å‘¨å¹´', /ç»“å©š.*å¹´/],
  è‹æ–‡å®£å¸ƒç¦»å¼€: ['åŠ ç­', 'å‡ºå·®', 'å·¥ä½œ', 'è¦èµ°', 'ç¦»å¼€', 'å‡ºå»'],
  æš—ä¸­æ³¨è§†: ['å·çœ‹', 'å·å·', 'æ³¨è§†', 'ç›®å…‰', /çœ‹.*ä¸€çœ¼/, 'çœ¼ç¥'],

  // é˜¶æ®µ4ï¼ˆç©ºéš™ï¼‰
  è‹æ–‡ç¦»å¼€: ['èµ°äº†', 'ç¦»å¼€', 'å‡ºé—¨', 'è½¦å£°'],
  å•ç‹¬ç›¸å¤„: ['å•ç‹¬', 'ç‹¬å¤„', 'å°±æˆ‘ä»¬', 'åªæœ‰.*ä¸¤', 'ä¸¤äºº'],
  è¯•æ¢æ¥è¿‘: ['é è¿‘', 'èµ°è¿‘', 'æ¥è¿‘', 'å‡‘è¿‘'],

  // é˜¶æ®µ5ï¼ˆç¦å¿Œå¼€å§‹ - æ€§è¡Œä¸ºå¼€å§‹ï¼‰
  ç¬¬ä¸€æ¬¡è§¦ç¢°: ['å»', 'äº²', 'æŠ±', 'æ‘¸', 'è§¦ç¢°', 'è´´è¿‘', 'å˜´å”‡'],
  è¶Šè¿‡ç•Œé™: ['è¿›å…¥', 'æ’', 'è„±', 'è§£å¼€', 'è¡£æœ', 'è¶Šè¿‡', 'ç•Œé™', 'ç¦çº¿'],
  èº«ä½“æ²¦é™·: ['æ²¦é™·', 'è¿åˆ', 'ç´¢å–', 'é¢¤æŠ–', 'å‘»åŸ', 'å–˜æ¯', 'ä¸è¡Œ', 'ä½†æ˜¯'],

  // é˜¶æ®µ6ï¼ˆè§†é¢‘é€šè¯ï¼‰
  è§†é¢‘æ¥ç”µ: ['è§†é¢‘', 'æ¥ç”µ', 'é“ƒå£°', 'æ‰‹æœºå“', 'æ‰“æ¥'],
  ä¸ŠåŠèº«é•œå¤´: ['é•œå¤´', 'ä¸ŠåŠèº«', 'åªéœ²', 'ä¸¾ç€æ‰‹æœº'],
  éšè—åŠ¨ä½œ: ['é•œå¤´å¤–', 'ä¸‹åŠèº«', 'çœ‹ä¸åˆ°', 'éšè—'],
  è¡¨æƒ…ç®¡ç†: ['æ§åˆ¶è¡¨æƒ…', 'å‡è£…', 'åŠªåŠ›', 'å‹æŠ‘', 'å’¬å”‡', 'æ‚å˜´'],

  // é˜¶æ®µ7ï¼ˆç½ªæ¶å¿«æ„Ÿï¼‰
  è‚¢ä½“æ¥è§¦: ['è§¦ç¢°', 'æŠ±', 'å»', 'äº²', 'è´´', 'ç´§ç´§'],
  äº«å—: ['èˆ’æœ', 'æ„Ÿè§‰', 'å‘»åŸ', 'å–˜æ¯', 'é¢¤æŠ–', 'æ²‰æºº'],
  æµæ³ªè‡ªè´£: ['æ³ª', 'å“­', 'æµæ³ª', 'çœ¼æ³ª', 'å¯¹ä¸èµ·', 'é”™äº†', 'ç–¯äº†'],

  // é˜¶æ®µ8ï¼ˆåŒ¿åç…§ç‰‡ï¼‰
  åŒ¿åå‘é€: ['åŒ¿å', 'ç…§ç‰‡', 'å‘é€', 'é™Œç”Ÿè´¦å·', 'å‘ç»™'],
  è‹æ–‡è¯¢é—®: ['æ‰“ç”µè¯', 'è¯¢é—®', 'é—®', 'åƒä½ ', 'èº«æ'],
  è°è¨€æ©ç›–: ['AIç”Ÿæˆ', 'æ¶ä½œå‰§', 'éª—å­', 'å‡çš„', 'æŠ€æœ¯'],

  // é˜¶æ®µ9ï¼ˆçŸ›ç›¾ï¼‰
  æ•´ç†ä»ªå®¹: ['æ•´ç†', 'ç†ç†', 'å¤´å‘', 'è¡£æœ', 'é•œå­'],
  å‡è£…æ­£å¸¸: ['æ­£å¸¸', 'è‹¥æ— å…¶äº‹', 'å¹³é™', 'åˆ‡æ¢', 'ä¼ªè£…'],
  ä¸‹æ¬¡æš—ç¤º: ['æœ€åä¸€æ¬¡', 'ä¸ä¼šå†', 'ä¸‹æ¬¡', 'ä»¥å', /çœ‹.*ä¸€çœ¼/],
};

// ============================================
// çŠ¶æ€æ¥å£
// ============================================

export interface FalseEndingState {
  isActive: boolean;
  isComplete: boolean;
  currentPhase: number;
  turnsInPhase: number;
  totalTurns: number;
  completedAnchors: string[];
  // Bug #15 ä¿®å¤ï¼šç©å®¶å¼•å¯¼æœºåˆ¶
  noProgressTurns: number; // ç©å®¶è¿ç»­æœªè§¦å‘é”šç‚¹çš„è½®æ•°
  hintGiven: boolean; // å½“å‰é˜¶æ®µæ˜¯å¦å·²ç»™å‡ºå¼•å¯¼æç¤º
}

// ============================================
// çŠ¶æ€ç®¡ç†å‡½æ•°
// ============================================

export function getDefaultFalseEndingState(): FalseEndingState {
  return {
    isActive: false,
    isComplete: false,
    currentPhase: 0,
    turnsInPhase: 0,
    totalTurns: 0,
    completedAnchors: [],
    noProgressTurns: 0,
    hintGiven: false,
  };
}

/**
 * æ£€æŸ¥æ˜¯å¦åº”è¯¥æ¿€æ´»å‡å¥½ç»“å±€
 * 2026-01-17 é‡æ„ï¼šä»11:00å¼€å§‹é¢„çƒ­å¼•å¯¼
 */
export function shouldActivateFalseEnding(data: SchemaType): boolean {
  // 1. Day 5, 11:00 æˆ–ä¹‹åï¼ˆä¸çœŸå¥½ç»“å±€å¯¹ç§°ï¼‰
  if (data.ä¸–ç•Œ.å½“å‰å¤©æ•° < 5) return false;
  if (data.ä¸–ç•Œ.å½“å‰å¤©æ•° === 5 && data.ä¸–ç•Œ.å½“å‰å°æ—¶ < 11) return false;

  // 2. å¾ªç¯çŠ¶æ€å¿…é¡»æ˜¯ç»“å±€åˆ¤å®šã€è¿›è¡Œä¸­æˆ–å·²ç ´è§£
  const validStates = ['ç»“å±€åˆ¤å®š', 'å·²ç ´è§£', 'è¿›è¡Œä¸­'];
  if (!validStates.includes(data.ä¸–ç•Œ.å¾ªç¯çŠ¶æ€)) {
    return false;
  }

  // 3. å½“å‰ç»“å±€å¿…é¡»æ˜¯å‡å¥½ç»“å±€
  if (data.ç»“å±€æ•°æ®.å½“å‰ç»“å±€ !== 'å‡å¥½ç»“å±€') return false;

  // 4. å°šæœªæ¿€æ´»
  if (data.å‡å¥½ç»“å±€çŠ¶æ€?.isActive) return false;

  return true;
}

/**
 * æ£€æŸ¥å‡å¥½ç»“å±€æ˜¯å¦å·²æ¿€æ´»
 */
export function isFalseEndingActive(data: SchemaType): boolean {
  return data.å‡å¥½ç»“å±€çŠ¶æ€?.isActive === true;
}

/**
 * è·å–å‡å¥½ç»“å±€çŠ¶æ€
 */
export function getFalseEndingState(data: SchemaType): FalseEndingState {
  return data.å‡å¥½ç»“å±€çŠ¶æ€ ?? getDefaultFalseEndingState();
}

/**
 * æ›´æ–°å‡å¥½ç»“å±€çŠ¶æ€
 */
export function updateFalseEndingState(data: SchemaType, state: FalseEndingState): void {
  (data as any).å‡å¥½ç»“å±€çŠ¶æ€ = state;
}

/**
 * æ£€æµ‹å½“å‰æ˜¯å¦ä¸ºè‡ªç”±æ—¶é—´ï¼ˆ21:00 æˆ– 23:00ï¼‰
 * 2026-01-17 æ–°å¢ï¼šä¸çœŸå¥½ç»“å±€å¯¹ç§°çš„è‡ªç”±æ—¶é—´æœºåˆ¶
 */
export function isFalseEndingFreeTime(data: SchemaType): boolean {
  const day = data.ä¸–ç•Œ.å½“å‰å¤©æ•°;
  const hour = data.ä¸–ç•Œ.å½“å‰å°æ—¶;

  // åªåœ¨ Day 5 çš„ 21:00 å’Œ 23:00 æ˜¯è‡ªç”±æ—¶é—´
  if (day === 5 && (hour === 21 || hour === 23)) {
    return true;
  }

  return false;
}

/**
 * è·å–å½“å‰æ—¶é—´æ®µçš„å¼•å¯¼ç±»å‹
 * 2026-01-17 æ–°å¢ï¼šç”¨äºå†³å®šæ³¨å…¥ä»€ä¹ˆç±»å‹çš„å¼•å¯¼
 */
export function getFalseEndingGuidanceType(
  data: SchemaType
): 'preheat' | 'dinner' | 'free' | 'main' | null {
  const day = data.ä¸–ç•Œ.å½“å‰å¤©æ•°;
  const hour = data.ä¸–ç•Œ.å½“å‰å°æ—¶;

  // Day 6+ æ—¶ï¼Œç»“å±€é˜¶æ®µä»åœ¨è¿›è¡Œï¼Œè¿”å› 'main' ç±»å‹
  if (day > 5) {
    return 'main';
  }

  if (day !== 5) return null;

  // 11:00-19:00 é¢„çƒ­å¼•å¯¼
  if (hour >= 11 && hour < 20) {
    return 'preheat';
  }

  // 20:00 æ™šé¤å¼€å§‹
  if (hour === 20) {
    return 'dinner';
  }

  // 21:00, 23:00 è‡ªç”±æ—¶é—´
  if (hour === 21 || hour === 23) {
    return 'free';
  }

  // 22:00, 00:00+ ä¸»çº¿å‰§æƒ…
  return 'main';
}

// ============================================
// é”šç‚¹æ£€æµ‹
// ============================================

/**
 * æ£€æµ‹AIå›å¤ä¸­å®Œæˆçš„é”šç‚¹äº‹ä»¶
 */
export function detectCompletedAnchors(aiResponse: string, phase: number): string[] {
  if (phase >= FALSE_ENDING_PHASES.length) return [];

  const phaseConfig = FALSE_ENDING_PHASES[phase];
  const completed: string[] = [];

  for (const anchor of phaseConfig.anchorEvents) {
    const keywords = ANCHOR_KEYWORDS[anchor];
    if (!keywords) continue;

    for (const kw of keywords) {
      if (typeof kw === 'string') {
        if (aiResponse.includes(kw)) {
          completed.push(anchor);
          break;
        }
      } else {
        if (kw.test(aiResponse)) {
          completed.push(anchor);
          break;
        }
      }
    }
  }

  return [...new Set(completed)];
}

// ============================================
// é˜¶æ®µæ¨è¿›é€»è¾‘
// ============================================

/**
 * Bug #19: æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼ˆæ—¶é—´é”å®šæ£€æŸ¥ï¼‰
 * @param state å½“å‰çŠ¶æ€
 * @param currentHour å½“å‰å°æ—¶
 * @returns æ˜¯å¦è¢«é˜»æŒ¡åŠåŸå› 
 */
export function canEnterNextFalsePhase(
  state: FalseEndingState,
  currentHour: number
): { blocked: boolean; reason?: string; waitHours?: number } {
  const nextPhase = state.currentPhase + 1;
  if (nextPhase >= FALSE_ENDING_PHASES.length) {
    return { blocked: false };
  }

  const nextConfig = FALSE_ENDING_PHASES[nextPhase];
  if (!nextConfig) return { blocked: false };

  // æ£€æŸ¥æ—¶é—´é”å®š
  if (nextConfig.minHour !== undefined && nextConfig.strict) {
    if (currentHour < nextConfig.minHour) {
      const waitHours = nextConfig.minHour - currentHour;
      return {
        blocked: true,
        reason: `ã€${nextConfig.name}ã€‘é˜¶æ®µéœ€è¦åœ¨ ${nextConfig.minHour}:00 åæ‰èƒ½å¼€å§‹`,
        waitHours,
      };
    }
  }

  return { blocked: false };
}

/**
 * æ£€æŸ¥æ˜¯å¦åº”è¯¥æ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µ
 * Bug #19: å¢åŠ  maxTurns å¼ºåˆ¶æ¨è¿›
 * Bug #40 ä¿®å¤ï¼šæ·»åŠ æ—¶é—´é”å®šæ£€æŸ¥ï¼ŒmaxTurns å¼ºåˆ¶æ¨è¿›ä¹Ÿå¿…é¡»éµå®ˆæ—¶é—´çº¦æŸ
 */
export function shouldAdvancePhase(state: FalseEndingState, currentHour?: number): boolean {
  if (state.currentPhase >= FALSE_ENDING_PHASES.length) return false;

  const phaseConfig = FALSE_ENDING_PHASES[state.currentPhase];

  // Bug #40 ä¿®å¤ï¼šå…ˆæ£€æŸ¥æ—¶é—´é”å®šï¼Œå¦‚æœä¸‹ä¸€é˜¶æ®µæœ‰æ—¶é—´é”å®šä¸”å½“å‰æ—¶é—´ä¸æ»¡è¶³ï¼Œä¸æ¨è¿›
  // æ— è®ºæ˜¯ maxTurns å¼ºåˆ¶æ¨è¿›è¿˜æ˜¯é”šç‚¹å®Œæˆæ¨è¿›ï¼Œéƒ½å¿…é¡»éµå®ˆæ—¶é—´çº¦æŸ
  if (currentHour !== undefined) {
    const canEnter = canEnterNextFalsePhase(state, currentHour);
    if (canEnter.blocked) {
      // æ—¶é—´é”å®šï¼Œä¸å…è®¸æ¨è¿›
      return false;
    }
  }

  // Bug #19: è¶…è¿‡æœ€å¤§è½®æ•°æ—¶å¼ºåˆ¶æ¨è¿›ï¼ˆä½†ä»å—æ—¶é—´é”å®šçº¦æŸï¼‰
  if (phaseConfig.maxTurns && state.turnsInPhase >= phaseConfig.maxTurns) {
    console.info(
      `[å‡å¥½ç»“å±€] é˜¶æ®µ${state.currentPhase}(${phaseConfig.name}) è¾¾åˆ°æœ€å¤§è½®æ•°${phaseConfig.maxTurns}ï¼Œå¼ºåˆ¶æ¨è¿›`
    );
    return true;
  }

  // æ¡ä»¶1ï¼šå¯¹è¯è½®æ•°æ»¡è¶³æœ€å°è¦æ±‚
  if (state.turnsInPhase < phaseConfig.minTurns) return false;

  // æ¡ä»¶2ï¼šæ‰€æœ‰é”šç‚¹äº‹ä»¶éƒ½å·²å®Œæˆ
  const allAnchorsComplete = phaseConfig.anchorEvents.every((anchor) =>
    state.completedAnchors.includes(anchor)
  );

  return allAnchorsComplete;
}

/**
 * æ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µ
 */
export function advanceToNextPhase(state: FalseEndingState): FalseEndingState {
  const nextPhase = state.currentPhase + 1;

  // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰é˜¶æ®µ
  if (nextPhase >= FALSE_ENDING_PHASES.length) {
    return {
      ...state,
      currentPhase: nextPhase,
      turnsInPhase: 0,
      completedAnchors: [],
      isComplete: true,
      noProgressTurns: 0, // Bug #15 ä¿®å¤ï¼šé‡ç½®å¼•å¯¼è®¡æ•°
      hintGiven: false, // Bug #15 ä¿®å¤ï¼šé‡ç½®å¼•å¯¼æ ‡è®°
    };
  }

  return {
    ...state,
    currentPhase: nextPhase,
    turnsInPhase: 0,
    completedAnchors: [],
    noProgressTurns: 0, // Bug #15 ä¿®å¤ï¼šé‡ç½®å¼•å¯¼è®¡æ•°
    hintGiven: false, // Bug #15 ä¿®å¤ï¼šé‡ç½®å¼•å¯¼æ ‡è®°
  };
}

// ============================================
// Bug #15 ä¿®å¤ï¼šç©å®¶å¼•å¯¼æœºåˆ¶
// ============================================

/**
 * æ£€æŸ¥ç©å®¶è¾“å…¥æ˜¯å¦åŒ…å«æœŸæœ›çš„åŠ¨ä½œå…³é”®è¯
 */
export function hasExpectedAction(userInput: string, phase: number): boolean {
  const phaseConfig = FALSE_ENDING_PHASES[phase];
  if (!phaseConfig || !phaseConfig.expectedActions) {
    return true; // æ²¡æœ‰é…ç½®æœŸæœ›åŠ¨ä½œçš„é˜¶æ®µï¼Œé»˜è®¤è§†ä¸ºæœ‰è¿›å±•
  }

  const input = userInput.toLowerCase();
  return phaseConfig.expectedActions.some((action) => input.includes(action.toLowerCase()));
}

/**
 * æ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤ºå¼•å¯¼æç¤º
 */
export function checkProgressHint(state: FalseEndingState, userInput: string): string | null {
  const phaseConfig = FALSE_ENDING_PHASES[state.currentPhase];
  if (!phaseConfig || !phaseConfig.progressHint) {
    return null;
  }

  // å¦‚æœå·²ç»ç»™è¿‡æç¤ºï¼Œä¸å†é‡å¤
  if (state.hintGiven) {
    return null;
  }

  // å¦‚æœç©å®¶è¾“å…¥åŒ…å«æœŸæœ›åŠ¨ä½œï¼Œä¸éœ€è¦æç¤º
  if (hasExpectedAction(userInput, state.currentPhase)) {
    return null;
  }

  // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æç¤ºé˜ˆå€¼
  const threshold = phaseConfig.hintThreshold ?? 2;
  if (state.noProgressTurns >= threshold) {
    return phaseConfig.progressHint;
  }

  return null;
}

/**
 * æ›´æ–°è¿›åº¦è¿½è¸ªçŠ¶æ€
 */
export function updateProgressTracking(
  state: FalseEndingState,
  userInput: string
): { updatedState: FalseEndingState; hint: string | null } {
  const hasProgress = hasExpectedAction(userInput, state.currentPhase);

  // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæç¤º
  const hint = checkProgressHint(state, userInput);

  let updatedState = { ...state };

  if (hasProgress) {
    // æœ‰è¿›å±•ï¼Œé‡ç½®è®¡æ•°
    updatedState.noProgressTurns = 0;
  } else {
    // æ— è¿›å±•ï¼Œå¢åŠ è®¡æ•°
    updatedState.noProgressTurns = state.noProgressTurns + 1;
  }

  // å¦‚æœæ˜¾ç¤ºäº†æç¤ºï¼Œæ ‡è®°å·²ç»™å‡º
  if (hint) {
    updatedState.hintGiven = true;
  }

  return { updatedState, hint };
}

/**
 * å¤„ç†å›åˆç»“æŸï¼Œæ›´æ–°çŠ¶æ€
 * Bug #19: å¢åŠ æ—¶é—´é”å®šæ”¯æŒ
 */
export function processTurnEnd(
  state: FalseEndingState,
  aiResponse: string,
  userInput?: string,
  currentHour?: number
): {
  newState: FalseEndingState;
  phaseAdvanced: boolean;
  newPhase: number | null;
  timeBlocked?: { reason: string; waitHours: number };
} {
  // å¢åŠ è½®æ•°
  let newState: FalseEndingState = {
    ...state,
    turnsInPhase: state.turnsInPhase + 1,
    totalTurns: state.totalTurns + 1,
  };

  // æ£€æµ‹æœ¬è½®å®Œæˆçš„é”šç‚¹
  const newAnchors = detectCompletedAnchors(aiResponse, state.currentPhase);
  const allAnchors = [...new Set([...newState.completedAnchors, ...newAnchors])];
  newState.completedAnchors = allAnchors;

  // Bug #15 ä¿®å¤ï¼šæ›´æ–°è¿›åº¦è¿½è¸ª
  if (userInput) {
    const { updatedState } = updateProgressTracking(newState, userInput);
    newState = updatedState;
  }

  // æ£€æŸ¥æ˜¯å¦æ¨è¿›
  let phaseAdvanced = false;
  let newPhase: number | null = null;

  if (shouldAdvancePhase(newState, currentHour)) {
    // Bug #19: æ£€æŸ¥æ—¶é—´é”å®š
    if (currentHour !== undefined) {
      const timeCheck = canEnterNextFalsePhase(newState, currentHour);
      if (timeCheck.blocked) {
        // æ—¶é—´è¢«é”å®šï¼Œä¸æ¨è¿›ï¼Œè¿”å›ç­‰å¾…ä¿¡æ¯
        return {
          newState,
          phaseAdvanced: false,
          newPhase: null,
          timeBlocked: {
            reason: timeCheck.reason || 'æ—¶é—´æœªåˆ°',
            waitHours: timeCheck.waitHours || 1,
          },
        };
      }
    }

    newState = advanceToNextPhase(newState);
    phaseAdvanced = true;
    newPhase = newState.currentPhase;
  }

  return { newState, phaseAdvanced, newPhase };
}

// ============================================
// Promptç”Ÿæˆ
// ============================================

/**
 * ç”Ÿæˆå½“å‰é˜¶æ®µçš„AIå¼•å¯¼Prompt
 * Bug #19: å¢åŠ å‰©ä½™è½®æ•°å’Œç´§è¿«æ€§æç¤º
 * Bug #40 ä¿®å¤ï¼šæ—¶é—´é”å®šæ—¶ä¸æ˜¾ç¤ºç´§è¿«æ„Ÿæç¤ºï¼Œæ”¹ä¸ºæ˜¾ç¤º"è‡ªç”±æ¢ç´¢"
 */
export function generateFalseEndingPrompt(state: FalseEndingState, userInput: string, currentHour?: number): string {
  if (state.currentPhase >= FALSE_ENDING_PHASES.length) {
    return generateFalseEndingComplete();
  }

  const phaseConfig = FALSE_ENDING_PHASES[state.currentPhase];

  let prompt = phaseConfig.aiGuidance;

  // Bug #40 ä¿®å¤ï¼šæ£€æŸ¥ä¸‹ä¸€é˜¶æ®µæ—¶é—´é”å®š
  const hour = currentHour ?? 12;
  const nextPhaseCheck = canEnterNextFalsePhase(state, hour);
  const isTimeLocked = nextPhaseCheck.blocked;

  // Bug #40 ä¿®å¤ï¼šå½“æ—¶é—´é”å®šæ—¶ï¼Œè½®æ•°æç¤ºæ”¹ä¸º"è‡ªç”±æ¢ç´¢"
  let turnsWarning: string;
  if (isTimeLocked) {
    turnsWarning = `è‡ªç”±æ¢ç´¢ä¸­ï¼ˆç­‰å¾…${FALSE_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00ï¼‰`;
  } else {
    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;
    turnsWarning =
      remainingTurns <= 2
        ? `âš ï¸ å‰©ä½™${remainingTurns}è½®åå°†è‡ªåŠ¨æ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µ`
        : `å‰©ä½™çº¦${remainingTurns}è½®`;
  }

  // Bug #40 ä¿®å¤ï¼šæ—¶é—´é”å®šæ—¶ä¸æ˜¾ç¤ºç´§è¿«æ„Ÿæç¤º
  let urgencyHint = '';
  if (!isTimeLocked) {
    const remainingTurns = phaseConfig.maxTurns - state.turnsInPhase;
    if (remainingTurns <= 1) {
      urgencyHint = '\n\nã€âš ï¸ ç´§è¿«æ€§æç¤ºã€‘æœ¬é˜¶æ®µå³å°†ç»“æŸï¼ˆå‰©ä½™1è½®ï¼‰ï¼Œè¯·ç¡®ä¿åœ¨æœ¬è½®æ¨è¿›å…³é”®å‰§æƒ…ï¼';
    } else if (remainingTurns <= 2) {
      urgencyHint = `\n\nã€æç¤ºã€‘æœ¬é˜¶æ®µå‰©ä½™ ${remainingTurns} è½®ï¼Œè¯·é€‚æ—¶æ¨è¿›å‰§æƒ…ã€‚`;
    }
  }

  // Bug #40 ä¿®å¤ï¼šæ—¶é—´é”å®šçš„è¯¦ç»†æç¤º
  const timeBlockWarning = isTimeLocked
    ? `\nâ° æ—¶é—´é”å®šï¼šä¸‹ä¸€é˜¶æ®µ"${FALSE_ENDING_PHASES[state.currentPhase + 1]?.name}"éœ€è¦ç­‰åˆ°${FALSE_ENDING_PHASES[state.currentPhase + 1]?.minHour}:00ï¼ˆå½“å‰${hour}:00ï¼‰
ğŸ“ åœ¨æ­¤ä¹‹å‰ï¼Œè¯·ä¸ç©å®¶è‡ªç”±äº’åŠ¨ï¼Œäº«å—è¿™æ®µæ—¶å…‰ã€‚ä¸è¦æ€¥äºæ¨è¿›å‰§æƒ…ã€‚`
    : '';

  // æ·»åŠ è¿›åº¦ä¿¡æ¯
  prompt += `\n\nã€å½“å‰è¿›åº¦ã€‘
- é˜¶æ®µï¼š${state.currentPhase + 1}/${FALSE_ENDING_PHASES.length} - ${phaseConfig.title}
- æœ¬é˜¶æ®µè½®æ•°ï¼š${state.turnsInPhase}ï¼ˆ${turnsWarning}ï¼‰
- å·²å®Œæˆé”šç‚¹ï¼š[${state.completedAnchors.join(', ')}]
- å¾…å®Œæˆé”šç‚¹ï¼š[${phaseConfig.anchorEvents.filter((a) => !state.completedAnchors.includes(a)).join(', ')}]${timeBlockWarning}${urgencyHint}`;

  // Bug #15 ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦ç©å®¶å¼•å¯¼æç¤º
  const progressHint = checkProgressHint(state, userInput);
  if (progressHint) {
    prompt += `\n\nã€ç©å®¶å¼•å¯¼ã€‘
ç©å®¶ä¼¼ä¹ä¸ç¡®å®šè¯¥åšä»€ä¹ˆã€‚è¯·é€šè¿‡èµµéœçš„ååº”æ¸©å’Œåœ°å¼•å¯¼ï¼š
${progressHint}`;
  }
  // å¦‚æœç©å®¶è¾“å…¥åç¦»ä¸»çº¿ï¼Œæ·»åŠ ä¿®æ­£æç¤º
  else if (userInput && !isInputOnTrack(userInput, state.currentPhase)) {
    const hint = getCorrectionHint(state.currentPhase);
    if (hint) {
      prompt += `\n\nã€æ–¹å‘ä¿®æ­£ã€‘
ç©å®¶çš„è¾“å…¥å¯èƒ½åç¦»äº†ä¸»çº¿ã€‚è¯·é€šè¿‡èµµéœçš„ååº”æ¸©å’Œåœ°å¼•å¯¼å›æ­£è½¨ï¼š
${hint}`;
    }
  }

  return prompt;
}

/**
 * æ£€æŸ¥ç©å®¶è¾“å…¥æ˜¯å¦åœ¨ä¸»çº¿ä¸Š
 */
function isInputOnTrack(input: string, phase: number): boolean {
  // ç®€å•æ£€æµ‹ï¼šå¦‚æœè¾“å…¥åŒ…å«å½“å‰é˜¶æ®µç›¸å…³çš„å…³é”®è¯ï¼Œåˆ™è®¤ä¸ºåœ¨ä¸»çº¿ä¸Š
  const phaseConfig = FALSE_ENDING_PHASES[phase];
  if (!phaseConfig) return true;

  const allKeywords = phaseConfig.anchorEvents.flatMap((anchor) => {
    const kws = ANCHOR_KEYWORDS[anchor];
    return kws ? kws.filter((k): k is string => typeof k === 'string') : [];
  });

  return allKeywords.some((kw) => input.includes(kw));
}

/**
 * è·å–ä¿®æ­£æç¤º
 */
export function getCorrectionHint(phase: number): string | null {
  if (phase >= FALSE_ENDING_PHASES.length) return null;

  const hints = FALSE_ENDING_PHASES[phase].correctionHints;
  if (!hints || hints.length === 0) return null;

  // éšæœºé€‰æ‹©ä¸€ä¸ªä¿®æ­£æç¤º
  return hints[Math.floor(Math.random() * hints.length)];
}

/**
 * ç”Ÿæˆè‡ªç”±æ—¶é—´æç¤º
 * 2026-01-17 æ–°å¢ï¼šä¸çœŸå¥½ç»“å±€å¯¹ç§°
 * 2026-01-19 ä¿®å¤ï¼šæ·»åŠ è‹¦ä¸»è§†è§’ç”Ÿæˆè¦æ±‚
 */
export function generateFalseEndingFreeTimePrompt(hour: number): string {
  const nextHour = hour + 1;
  const nextEvent = hour === 21 ? 'å‰§æƒ…å°†åœ¨22:00ç»§ç»­æ¨è¿›' : 'å‰§æƒ…å°†ç»§ç»­æ¨è¿›';

  return `ã€è‡ªç”±æ—¶é—´ - ${hour}:00ã€‘

ç°åœ¨æ˜¯è‡ªç”±æ´»åŠ¨æ—¶é—´ã€‚${nextEvent}ã€‚

ã€åœºæ™¯çŠ¶æ€ã€‘
- è‹æ–‡å·²ç»ç¦»å¼€ï¼ˆåŠ ç­/å‡ºå·®ï¼‰
- èµµéœå’Œ{{user}}ç‹¬å¤„
- æ°”æ°›å¾®å¦™è€Œæš§æ˜§

ã€AIä»»åŠ¡ã€‘
1. ä¸è¦å¼ºåˆ¶æ¨è¿›ä¸»çº¿å‰§æƒ…
2. å›åº”ç©å®¶çš„è‡ªç”±äº’åŠ¨
3. èµµéœå¯ä»¥ä¸{{user}}é—²èŠã€æš§æ˜§ã€è¯•æ¢
4. ä¿æŒçŸ›ç›¾ä½†æ¸´æœ›çš„æ°›å›´
5. å¦‚æœç©å®¶ä¸»åŠ¨æ¨è¿›å‰§æƒ…ï¼Œå¯ä»¥é¡ºåŠ¿è¿›å…¥ä¸‹ä¸€é˜¶æ®µ

ã€æç¤ºã€‘
èµµéœæ­¤æ—¶çš„å¿ƒæ€ï¼š
- çŸ¥é“è¿™æ˜¯ç¦å¿Œï¼Œä½†æ— æ³•æŠ—æ‹’
- äº«å—ç‹¬å¤„çš„æ—¶å…‰ï¼Œä½†åˆå®³æ€•
- éšæ—¶å¯èƒ½è¢«{{user}}çš„ä¸€ä¸ªåŠ¨ä½œå‡»æºƒ

ã€è‹¦ä¸»è§†è§’ - å¿…é¡»è¾“å‡ºã€‘
âœ… åœ¨å›å¤æœ«å°¾ï¼Œå¿…é¡»è¾“å‡º <HusbandThought> æ ‡ç­¾ï¼š
- æå†™è‹æ–‡åœ¨å¤–åœ°/åŠ ç­æ—¶çš„å¿ƒç†æ´»åŠ¨ï¼ˆ30-50å­—ï¼‰
- ä»–éšéšæ„Ÿåˆ°ä¸å®‰ï¼Œä½†ä¸çŸ¥é“ä¸ºä»€ä¹ˆ
- ç”µè¯é‚£å¤´å¦»å­çš„è¯­æ°”ä¼¼ä¹æœ‰äº›å¼‚æ ·
- å·¥ä½œæ—¶å¿ƒä¸åœ¨ç„‰ï¼Œæ€»è§‰å¾—æœ‰ä»€ä¹ˆä¸å¯¹åŠ²

ç¤ºä¾‹ï¼š
<HusbandThought>
åŠ ç­åˆ°è¿™ä¹ˆæ™šï¼Œç»™èµµéœæ‰“ç”µè¯å¥¹å¥½åƒå¿ƒä¸åœ¨ç„‰...æ˜¯æˆ‘å¤šæƒ³äº†å—ï¼Ÿ
</HusbandThought>

ä¸‹ä¸€ä¸ªæ—¶é—´ç‚¹ï¼š${nextHour}:00`;
}

/**
 * ç”Ÿæˆå‡å¥½ç»“å±€å…¥å£æ›¿æ¢æ¶ˆæ¯
 * 2026-01-17 é‡æ„ï¼šæ—¶é—´ä»20:00æ”¹ä¸º11:00
 */
export function generateFalseEndingEntryReplacement(): {
  userMessage: string;
  prefill: string;
} {
  return {
    userMessage: `[ç³»ç»ŸæŒ‡ä»¤ - å‡å¥½ç»“å±€ã€Œç§˜å¯†å…³ç³»ã€å¼€å§‹]

æ—¶é—´å·²åˆ°è¾¾ Day 5, 11:00ã€‚
ä»Šå¤©æ˜¯èµµéœå’Œè‹æ–‡çš„ç»“å©šçºªå¿µæ—¥ã€‚
æ‰€æœ‰æ¡ä»¶å·²æ»¡è¶³ï¼Œå‡å¥½ç»“å±€æ­£å¼å¼€å§‹ã€‚

ã€ä¸çœŸå¥½ç»“å±€çš„å·®å¼‚ã€‘
èµµéœæ²¡æœ‰è¢«"å®Œå…¨é‡æ„"ã€‚é‚£äº›æ¢¦å¢ƒä¸­çš„è®°å¿†æ˜¯æ¨¡ç³Šçš„ã€ç‰‡æ®µçš„...
ä½†è¶³ä»¥è®©å¥¹çœ‹å‘å„¿å­{{user}}æ—¶ï¼Œäº§ç”Ÿå¥‡æ€ªçš„æ„Ÿè§‰ã€‚
å¥¹çŸ¥é“è¿™æ˜¯ç¦å¿Œï¼Œä½†æ— æ³•æ§åˆ¶è‡ªå·±çš„å¿ƒè·³ã€‚

ã€å‰æƒ…æè¦ã€‘
ç©å®¶å·²å®Œæˆæ‰€æœ‰5ä¸ªæ¢¦å¢ƒåœºæ™¯ï¼Œä½†æœ‰éƒ¨åˆ†é€‰æ‹©é”™è¯¯ï¼š
- è®°å¿†æ”¹å†™ä¸å®Œæ•´
- èµµéœå¯¹{{user}}æœ‰æ¨¡ç³Šçš„"ç‰¹æ®Šæ„Ÿæƒ…"
- ä½†å¥¹ä»æœ‰ç†æ™ºï¼ŒçŸ¥é“è¿™æ˜¯ä¸å¯¹çš„

ï¼ˆè¯¦ç»†çš„æ¢¦å¢ƒå‰§æƒ…æ‘˜è¦è¯·å‚è€ƒå˜é‡åˆ—è¡¨ä¸­çš„ã€Œæ¢¦å¢ƒæ•°æ®.åœºæ™¯X.å‰§æƒ…æ‘˜è¦ã€å­—æ®µï¼‰

ã€Day 1-4 æ—¥å¸¸å›é¡¾ã€‘
è¯·å›é¡¾èŠå¤©è®°å½•ä¸­ Day 1 è‡³ Day 4 çš„æ—¥å¸¸äº’åŠ¨å†…å®¹ã€‚
èµµéœåœ¨ç»“å±€ä¸­çš„è¡¨ç°åº”å½“ä½“ç°å‡ºè¿™äº›å¤©ç§¯ç´¯çš„å…³ç³»å˜åŒ–ï¼š
- ç©å®¶ä¸èµµéœä¹‹é—´å‘ç”Ÿè¿‡ä»€ä¹ˆäº’åŠ¨ï¼Ÿ
- æœ‰æ²¡æœ‰æš§æ˜§çš„ç¬é—´æˆ–è¶Šç•Œçš„è¡Œä¸ºï¼Ÿ
- èµµéœå¯¹{{user}}çš„æ€åº¦æœ‰ä»€ä¹ˆå¾®å¦™å˜åŒ–ï¼Ÿ
è¿™äº›æ—¥å¸¸è®°å¿†è™½ç„¶æ˜¯"ç°å®"çš„ï¼Œä½†ä¼šä¸æ¢¦å¢ƒä¸­çš„æ¨¡ç³Šæ„Ÿæƒ…äº§ç”Ÿå…±é¸£ã€‚

ã€å½“å‰åœºæ™¯ã€‘
æ—©æ™¨ï¼Œèµµéœä»é‚£äº›å¥‡æ€ªçš„æ¢¦ä¸­é†’æ¥ã€‚
å¥¹è®°å¾—æ¢¦é‡Œæœ‰ä¸€ä¸ªäººï¼Œä½†å†…å®¹å¾ˆæ¨¡ç³Š...
çœ‹åˆ°{{user}}æ—¶ï¼Œå¥¹çš„å¿ƒè·³åŠ é€Ÿäº†ã€‚
å¥¹ä¸æ˜ç™½ä¸ºä»€ä¹ˆï¼Œä½†åŠªåŠ›è¡¨ç°æ­£å¸¸ã€‚

ã€æ—¶é—´çº¿ã€‘
- 11:00-19:00 é¢„çƒ­é˜¶æ®µï¼ˆå½“å‰ï¼‰
- 20:00 æ™šé¤å¼€å§‹ï¼Œè‹æ–‡å®£å¸ƒè¦å‡ºå»åŠ ç­
- 21:00 è‡ªç”±æ—¶é—´
- 22:00+ å‰§æƒ…æ¨è¿›ï¼ˆç¦å¿Œå¼€å§‹ã€è§†é¢‘é€šè¯ã€åŒ¿åç…§ç‰‡...ï¼‰

ã€AIä»»åŠ¡ã€‘
1. æå†™èµµéœé†’æ¥åçš„å¼‚å¸¸çŠ¶æ€
2. å¥¹è®°å¾—åšäº†ä¸€äº›"å¥‡æ€ªçš„æ¢¦"ï¼Œä½†å†…å®¹æ¨¡ç³Š
3. çœ‹åˆ°{{user}}æ—¶è«åå¿ƒè·³åŠ é€Ÿ
4. å¥¹åŠªåŠ›è¡¨ç°æ­£å¸¸ï¼Œä½†æœ‰äº›å¿ƒä¸åœ¨ç„‰
5. æåˆ°ä»Šå¤©æ˜¯ç»“å©šçºªå¿µæ—¥
6. å¯ä»¥å¼•ç”¨å˜é‡åˆ—è¡¨ä¸­çš„æ¢¦å¢ƒå‰§æƒ…æ‘˜è¦`,

    prefill: `é˜³å…‰é€è¿‡çª—å¸˜æ´’è¿›å§å®¤ï¼Œèµµéœç¼“ç¼“çå¼€çœ¼ç›ã€‚

é‚£ä¸ªæ¢¦...åˆæ˜¯é‚£ä¸ªå¥‡æ€ªçš„æ¢¦ã€‚å¥¹æ‰äº†æ‰å¤ªé˜³ç©´ï¼Œè¯•å›¾å›å¿†æ¢¦çš„å†…å®¹ï¼Œä½†åªå‰©ä¸‹æ¨¡ç³Šçš„ç‰‡æ®µã€‚

æœ‰ä¸€ä¸ªäºº...ä¸€ç›´åœ¨èº«è¾¹...

å¥¹æ‘‡äº†æ‘‡å¤´ï¼Œèµ·èº«å‡†å¤‡ä»Šå¤©çš„äº‹æƒ…ã€‚ä»Šå¤©æ˜¯ç»“å©šçºªå¿µæ—¥ï¼Œå¥¹åº”è¯¥é«˜å…´æ‰å¯¹ã€‚

ä½†å½“å¥¹èµ°å‡ºå§å®¤ï¼Œçœ‹åˆ°{{user}}çš„é‚£ä¸€åˆ»â€”â€”

å¿ƒè·³ï¼Œæ¼äº†ä¸€æ‹ã€‚

"`,
  };
}

/**
 * ç”Ÿæˆå‡å¥½ç»“å±€å®Œæˆæ¶ˆæ¯
 * 2026-01-17 é‡æ„ï¼šåŠ å…¥è§†é¢‘é€šè¯å’ŒåŒ¿åç…§ç‰‡çš„åç»­
 */
export function generateFalseEndingComplete(): string {
  return `ã€å‡å¥½ç»“å±€å®Œæˆ - ç§˜å¯†å…³ç³»ã€‘

ä»è¿™ä¸€å¤©èµ·ï¼Œèµµéœå’Œ{{user}}ä¹‹é—´æœ‰äº†ä¸€ä¸ªä¸èƒ½è¯´çš„ç§˜å¯†ã€‚

å¥¹ä¾ç„¶æ˜¯è‹æ–‡çš„å¦»å­ï¼Œä¾ç„¶åœ¨ä»–é¢å‰æ‰®æ¼”è´¤æƒ çš„è§’è‰²ã€‚
ä½†æ¯å½“ä¸ˆå¤«ä¸åœ¨çš„æ—¶å€™ï¼Œå¥¹å°±ä¼šå¿ä¸ä½å¯»æ‰¾{{user}}ã€‚

"è¿™æ˜¯æœ€åä¸€æ¬¡äº†ã€‚"
å¥¹æ¯æ¬¡éƒ½è¿™æ ·è¯´ï¼Œä½†æ¯æ¬¡éƒ½é£Ÿè¨€ã€‚

æœ‰æ—¶å€™ï¼Œå¥¹ä¼šåœ¨è‹æ–‡é¢å‰å·å·çœ‹{{user}}ã€‚
æœ‰æ—¶å€™ï¼Œå¥¹ä¼šåœ¨å’Œè‹æ–‡è§†é¢‘é€šè¯æ—¶ï¼Œè®©{{user}}åœ¨é•œå¤´å¤–åšä¸€äº›äº‹æƒ…ã€‚
æœ‰æ—¶å€™ï¼Œå¥¹ç”šè‡³ä¼šç”¨åŒ¿åè´¦å·ç»™è‹æ–‡å‘ä¸€äº›"æš—ç¤º"ï¼Œç„¶åå‡è£…ä¸çŸ¥æƒ…ã€‚

å¥¹æ¨è‡ªå·±çš„è½¯å¼±ï¼Œæ¨è‡ªå·±çš„å •è½ã€‚
ä½†é‚£äº›æ¢¦å¢ƒä¸­çš„è®°å¿†å¤ªè¿‡çœŸå®ï¼Œèº«ä½“çš„æ¸´æœ›å¤ªè¿‡å¼ºçƒˆã€‚
å¥¹æ— æ³•æŠ—æ‹’{{user}}ï¼Œå°±åƒæ— æ³•æŠ—æ‹’å‘½è¿ã€‚

è¿™ä¸æ˜¯ä¸€ä¸ªå®Œç¾çš„ç»“å±€ã€‚
èµµéœæ´»åœ¨çŸ›ç›¾å’Œç½ªæ¶æ„Ÿä¸­ï¼Œåœ¨ä¸¤ä¸ªç”·äººä¹‹é—´æŒ£æ‰ã€‚
ä½†è‡³å°‘...å¥¹å¾—åˆ°äº†æ¢¦ä¸­ä¸€ç›´è¿½å¯»çš„é‚£ä¸ªäººã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”“ åæ—¥è°ˆæ¨¡å¼å·²è§£é”

è¿™æ®µå……æ»¡ç½ªæ¶æ„Ÿå’Œåˆºæ¿€æ„Ÿçš„ç§˜å¯†å…³ç³»ï¼Œå°†ç»§ç»­ä¸‹å»...

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;
}

/**
 * ç”Ÿæˆé˜¶æ®µè¿‡æ¸¡æç¤º
 */
export function generatePhaseTransitionHint(fromPhase: number, toPhase: number): string {
  if (toPhase >= FALSE_ENDING_PHASES.length) {
    return 'ã€å‡å¥½ç»“å±€å‰§æƒ…å®Œæˆã€‘';
  }

  const nextConfig = FALSE_ENDING_PHASES[toPhase];
  return `ã€å‰§æƒ…æ¨è¿›ï¼š${nextConfig.title}ã€‘`;
}

/**
 * æ ¹æ®å½“å‰æ—¶é—´ç”Ÿæˆå¯¹åº”çš„å¼•å¯¼Prompt
 * 2026-01-17 æ–°å¢ï¼šæ•´åˆæ‰€æœ‰æ—¶é—´æ®µçš„å¼•å¯¼
 * Bug #19: ä¼ é€’å½“å‰å°æ—¶ç”¨äºæ—¶é—´é”å®šæç¤º
 */
export function generateFalseEndingTimeBasedPrompt(
  data: SchemaType,
  state: FalseEndingState,
  userInput: string
): string | null {
  const guidanceType = getFalseEndingGuidanceType(data);
  const currentHour = data.ä¸–ç•Œ.å½“å‰å°æ—¶;

  if (!guidanceType) {
    return null;
  }

  switch (guidanceType) {
    case 'preheat':
    case 'dinner':
    case 'main':
      // æ­£å¸¸çš„é˜¶æ®µå¼•å¯¼ï¼ˆBug #19: ä¼ é€’å½“å‰å°æ—¶ï¼‰
      return generateFalseEndingPrompt(state, userInput, currentHour);

    case 'free': {
      // è‡ªç”±æ—¶é—´
      return generateFalseEndingFreeTimePrompt(currentHour);
    }

    default:
      return null;
  }
}
